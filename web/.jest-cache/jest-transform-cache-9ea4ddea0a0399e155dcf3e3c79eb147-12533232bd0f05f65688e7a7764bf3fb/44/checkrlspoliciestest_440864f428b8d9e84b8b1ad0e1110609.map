{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/integration/check-rls-policies.test.ts"],"sourcesContent":["import { describe, it, expect } from '@jest/globals';\n\n/**\n * Check RLS Policies Test\n * \n * Tests to understand why we can't see data despite service role key\n * \n * Created: January 27, 2025\n * Status: âœ… PRODUCTION READY\n */\n\ndescribe('Check RLS Policies', () => {\n  it('should check if RLS is blocking our queries', async () => {\n    const { createClient } = await import('@supabase/supabase-js');\n    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_SECRET_KEY;\n    \n    if (!supabaseUrl || !supabaseKey) {\n      throw new Error('Supabase credentials not found');\n    }\n    \n    const supabase = createClient(supabaseUrl, supabaseKey);\n    \n    console.log('ðŸ” Checking RLS policies...');\n    \n    // Try to get a count of polls without RLS\n    const { data: countData, error: countError } = await supabase\n      .from('polls')\n      .select('id', { count: 'exact', head: true });\n    \n    console.log('Count query result:', { countData, countError });\n    \n    // Try to get all polls with explicit RLS bypass\n    const { data: allPolls, error: allPollsError } = await supabase\n      .from('polls')\n      .select('*')\n      .limit(5);\n    \n    console.log('All polls query result:', { allPolls, allPollsError });\n    \n    // Try to get specific columns that we know exist\n    const { data: specificColumns, error: specificError } = await supabase\n      .from('polls')\n      .select('id, title, description')\n      .limit(5);\n    \n    console.log('Specific columns query result:', { specificColumns, specificError });\n    \n    // Try to insert a test poll to see if that works\n    const testPoll = {\n      title: 'RLS Test Poll',\n      description: 'Testing RLS policies',\n      question: 'Does RLS work?',\n      options: ['Yes', 'No'],\n      voting_method: 'single_choice',\n      status: 'active',\n      created_by: 'test-user',\n      privacy_level: 'public'\n    };\n    \n    const { data: insertResult, error: insertError } = await supabase\n      .from('polls')\n      .insert(testPoll)\n      .select();\n    \n    console.log('Insert test result:', { insertResult, insertError });\n    \n    // If insert worked, try to query it back\n    if (!insertError && insertResult) {\n      const { data: queryBack, error: queryBackError } = await supabase\n        .from('polls')\n        .select('*')\n        .eq('title', 'RLS Test Poll');\n      \n      console.log('Query back result:', { queryBack, queryBackError });\n      \n      // Clean up\n      if (queryBack && queryBack.length > 0) {\n        const { error: deleteError } = await supabase\n          .from('polls')\n          .delete()\n          .eq('id', queryBack[0].id);\n        \n        console.log('Cleanup result:', { deleteError });\n      }\n    }\n    \n    // The test should pass if we can at least connect\n    expect(countError).toBeNull();\n    expect(allPollsError).toBeNull();\n    expect(specificError).toBeNull();\n  });\n});\n"],"names":["describe","it","createClient","supabaseUrl","process","env","SUPABASE_URL","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","SUPABASE_SERVICE_ROLE_KEY","SUPABASE_SECRET_KEY","Error","supabase","console","log","data","countData","error","countError","from","select","count","head","allPolls","allPollsError","limit","specificColumns","specificError","testPoll","title","description","question","options","voting_method","status","created_by","privacy_level","insertResult","insertError","insert","queryBack","queryBackError","eq","length","deleteError","delete","id","expect","toBeNull"],"mappings":";;;;yBAAqC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAErC;;;;;;;CAOC,GAEDA,IAAAA,iBAAQ,EAAC,sBAAsB;IAC7BC,IAAAA,WAAE,EAAC,+CAA+C;QAChD,MAAM,EAAEC,YAAY,EAAE,GAAG,MAAM,mEAAA,QAAO;QACtC,MAAMC,cAAcC,QAAQC,GAAG,CAACC,YAAY,IAAIF,QAAQC,GAAG,CAACE,wBAAwB;QACpF,MAAMC,cAAcJ,QAAQC,GAAG,CAACI,yBAAyB,IAAIL,QAAQC,GAAG,CAACK,mBAAmB;QAE5F,IAAI,CAACP,eAAe,CAACK,aAAa;YAChC,MAAM,IAAIG,MAAM;QAClB;QAEA,MAAMC,WAAWV,aAAaC,aAAaK;QAE3CK,QAAQC,GAAG,CAAC;QAEZ,0CAA0C;QAC1C,MAAM,EAAEC,MAAMC,SAAS,EAAEC,OAAOC,UAAU,EAAE,GAAG,MAAMN,SAClDO,IAAI,CAAC,SACLC,MAAM,CAAC,MAAM;YAAEC,OAAO;YAASC,MAAM;QAAK;QAE7CT,QAAQC,GAAG,CAAC,uBAAuB;YAAEE;YAAWE;QAAW;QAE3D,gDAAgD;QAChD,MAAM,EAAEH,MAAMQ,QAAQ,EAAEN,OAAOO,aAAa,EAAE,GAAG,MAAMZ,SACpDO,IAAI,CAAC,SACLC,MAAM,CAAC,KACPK,KAAK,CAAC;QAETZ,QAAQC,GAAG,CAAC,2BAA2B;YAAES;YAAUC;QAAc;QAEjE,iDAAiD;QACjD,MAAM,EAAET,MAAMW,eAAe,EAAET,OAAOU,aAAa,EAAE,GAAG,MAAMf,SAC3DO,IAAI,CAAC,SACLC,MAAM,CAAC,0BACPK,KAAK,CAAC;QAETZ,QAAQC,GAAG,CAAC,kCAAkC;YAAEY;YAAiBC;QAAc;QAE/E,iDAAiD;QACjD,MAAMC,WAAW;YACfC,OAAO;YACPC,aAAa;YACbC,UAAU;YACVC,SAAS;gBAAC;gBAAO;aAAK;YACtBC,eAAe;YACfC,QAAQ;YACRC,YAAY;YACZC,eAAe;QACjB;QAEA,MAAM,EAAErB,MAAMsB,YAAY,EAAEpB,OAAOqB,WAAW,EAAE,GAAG,MAAM1B,SACtDO,IAAI,CAAC,SACLoB,MAAM,CAACX,UACPR,MAAM;QAETP,QAAQC,GAAG,CAAC,uBAAuB;YAAEuB;YAAcC;QAAY;QAE/D,yCAAyC;QACzC,IAAI,CAACA,eAAeD,cAAc;YAChC,MAAM,EAAEtB,MAAMyB,SAAS,EAAEvB,OAAOwB,cAAc,EAAE,GAAG,MAAM7B,SACtDO,IAAI,CAAC,SACLC,MAAM,CAAC,KACPsB,EAAE,CAAC,SAAS;YAEf7B,QAAQC,GAAG,CAAC,sBAAsB;gBAAE0B;gBAAWC;YAAe;YAE9D,WAAW;YACX,IAAID,aAAaA,UAAUG,MAAM,GAAG,GAAG;gBACrC,MAAM,EAAE1B,OAAO2B,WAAW,EAAE,GAAG,MAAMhC,SAClCO,IAAI,CAAC,SACL0B,MAAM,GACNH,EAAE,CAAC,MAAMF,SAAS,CAAC,EAAE,CAACM,EAAE;gBAE3BjC,QAAQC,GAAG,CAAC,mBAAmB;oBAAE8B;gBAAY;YAC/C;QACF;QAEA,kDAAkD;QAClDG,IAAAA,eAAM,EAAC7B,YAAY8B,QAAQ;QAC3BD,IAAAA,eAAM,EAACvB,eAAewB,QAAQ;QAC9BD,IAAAA,eAAM,EAACpB,eAAeqB,QAAQ;IAChC;AACF"}