{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/integration/test-direct-postgres.test.ts"],"sourcesContent":["import { describe, it, expect } from '@jest/globals';\n\n/**\n * Test Direct PostgreSQL Connection\n * \n * Tests direct PostgreSQL connection bypassing Supabase client\n * \n * Created: January 27, 2025\n * Status: ‚úÖ PRODUCTION READY\n */\n\ndescribe('Test Direct PostgreSQL Connection', () => {\n  it('should test direct PostgreSQL connection', async () => {\n    const { Client } = await import('pg');\n    \n    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_SECRET_KEY;\n    \n    if (!supabaseUrl || !serviceKey) {\n      throw new Error('Supabase credentials not found');\n    }\n    \n    console.log('üîç Testing direct PostgreSQL connection...');\n    console.log('Supabase URL:', supabaseUrl);\n    console.log('Service Key (first 10 chars):', serviceKey.substring(0, 10));\n    \n    // Extract database connection details from Supabase URL\n    const url = new URL(supabaseUrl);\n    const host = url.hostname;\n    const port = url.port || '5432';\n    const database = url.pathname.substring(1) || 'postgres';\n    \n    console.log('Extracted connection details:', { host, port, database });\n    \n    const client = new Client({\n      host: host,\n      port: parseInt(port),\n      database: database,\n      user: 'postgres',\n      password: serviceKey,\n      ssl: { rejectUnauthorized: false }\n    });\n    \n    try {\n      await client.connect();\n      console.log('‚úÖ Direct PostgreSQL connection successful');\n      \n      // Test 1: Simple query\n      console.log('üîç Test 1: Simple query');\n      const result1 = await client.query('SELECT 1 as test');\n      console.log('Simple query result:', result1.rows);\n      \n      // Test 2: Get current user\n      console.log('üîç Test 2: Current user');\n      const result2 = await client.query('SELECT current_user');\n      console.log('Current user result:', result2.rows);\n      \n      // Test 3: Get current role\n      console.log('üîç Test 3: Current role');\n      const result3 = await client.query('SELECT current_role');\n      console.log('Current role result:', result3.rows);\n      \n      // Test 4: Get database name\n      console.log('üîç Test 4: Database name');\n      const result4 = await client.query('SELECT current_database()');\n      console.log('Database name result:', result4.rows);\n      \n      // Test 5: Get version\n      console.log('üîç Test 5: Version');\n      const result5 = await client.query('SELECT version()');\n      console.log('Version result:', result5.rows);\n      \n      // Test 6: Check if polls table exists\n      console.log('üîç Test 6: Check polls table');\n      const result6 = await client.query(`\n        SELECT table_name \n        FROM information_schema.tables \n        WHERE table_schema = 'public' AND table_name = 'polls'\n      `);\n      console.log('Polls table result:', result6.rows);\n      \n      // Test 7: Get polls count\n      console.log('üîç Test 7: Polls count');\n      const result7 = await client.query('SELECT COUNT(*) FROM polls');\n      console.log('Polls count result:', result7.rows);\n      \n      // Test 8: Get sample polls\n      console.log('üîç Test 8: Sample polls');\n      const result8 = await client.query('SELECT id, title FROM polls LIMIT 5');\n      console.log('Sample polls result:', result8.rows);\n      \n      // Test 9: Check RLS status\n      console.log('üîç Test 9: RLS status');\n      const result9 = await client.query(`\n        SELECT relname, relrowsecurity \n        FROM pg_class \n        WHERE relname = 'polls'\n      `);\n      console.log('RLS status result:', result9.rows);\n      \n      // Test 10: Check RLS policies\n      console.log('üîç Test 10: RLS policies');\n      const result10 = await client.query(`\n        SELECT policyname, cmd, roles, qual, with_check\n        FROM pg_policies \n        WHERE tablename = 'polls'\n      `);\n      console.log('RLS policies result:', result10.rows);\n      \n      expect(result1.rows.length).toBeGreaterThan(0);\n      expect(result2.rows.length).toBeGreaterThan(0);\n      expect(result3.rows.length).toBeGreaterThan(0);\n      expect(result4.rows.length).toBeGreaterThan(0);\n      expect(result5.rows.length).toBeGreaterThan(0);\n      expect(result6.rows.length).toBeGreaterThan(0);\n      expect(result7.rows.length).toBeGreaterThan(0);\n      expect(result8.rows.length).toBeGreaterThan(0);\n      expect(result9.rows.length).toBeGreaterThan(0);\n      expect(result10.rows.length).toBeGreaterThan(0);\n      \n    } catch (error) {\n      console.error('‚ùå Direct PostgreSQL connection failed:', error);\n      throw error;\n    } finally {\n      await client.end();\n    }\n  });\n});\n"],"names":["describe","it","Client","supabaseUrl","process","env","SUPABASE_URL","NEXT_PUBLIC_SUPABASE_URL","serviceKey","SUPABASE_SERVICE_ROLE_KEY","SUPABASE_SECRET_KEY","Error","console","log","substring","url","URL","host","hostname","port","database","pathname","client","parseInt","user","password","ssl","rejectUnauthorized","connect","result1","query","rows","result2","result3","result4","result5","result6","result7","result8","result9","result10","expect","length","toBeGreaterThan","error","end"],"mappings":"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"}