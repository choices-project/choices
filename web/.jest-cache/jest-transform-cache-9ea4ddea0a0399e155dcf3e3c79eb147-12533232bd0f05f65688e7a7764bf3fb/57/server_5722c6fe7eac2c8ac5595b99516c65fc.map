{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/utils/supabase/server.ts"],"sourcesContent":["import 'server-only';                  // build-time guard\nimport type { SupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\nimport type { Database } from '../../types/database'\nimport { createServerClient, type CookieOptions } from '@supabase/ssr'\n\n// Re-export the Database type for use in other modules\nexport type { Database }\n\n// Environment validation\nconst validateEnvironment = () => {\n  const requiredVars = {\n    NEXT_PUBLIC_SUPABASE_URL: process.env['NEXT_PUBLIC_SUPABASE_URL'],\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env['NEXT_PUBLIC_SUPABASE_ANON_KEY'],\n    SUPABASE_SECRET_KEY: process.env['SUPABASE_SECRET_KEY']\n  }\n\n  const missing = Object.entries(requiredVars)\n    .filter(([_, value]) => !value)\n    .map(([key]) => key)\n\n  if (missing.length > 0) {\n    throw new Error(`Missing required environment variables: ${missing.join(', ')}`)\n  }\n\n  return requiredVars\n}\n\n// Initialize environment variables\n  const env = validateEnvironment()\n  \n// Create Supabase server client\nexport async function getSupabaseServerClient() {\n  const cookieStore = await cookies();\n  \n  return createServerClient<Database>(\n    env.NEXT_PUBLIC_SUPABASE_URL!,\n    env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        get(name: string) {\n          return cookieStore.get(name)?.value;\n        },\n        set(name: string, value: string, options: CookieOptions) {\n          try {\n            cookieStore.set({ name, value, ...options });\n          } catch (error) {\n            // The `cookies().set()` method can only be called in a Server Component or Route Handler\n            // That are making a `request`\n            // console.warn('Could not set cookie from server component:', error);\n          }\n        },\n        remove(name: string, options: CookieOptions) {\n          try {\n            cookieStore.set({ name, value: '', ...options });\n          } catch (error) {\n            // The `cookies().set()` method can only be called in a Server Component or Route Handler\n            // That are making a `request`\n            // console.warn('Could not remove cookie from server component:', error);\n          }\n        },\n      },\n    }\n  );\n}\n\n// Create Supabase admin client (for server-side operations requiring elevated privileges)\nexport async function getSupabaseAdminClient(): Promise<SupabaseClient<Database>> {\n  const { createClient } = await import('@supabase/supabase-js');\n  \n  return createClient(\n    env.NEXT_PUBLIC_SUPABASE_URL!,\n    env.SUPABASE_SECRET_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  );\n}\n\n// Helper function to get user from server-side context\nexport async function getServerUser() {\n  const supabase = await getSupabaseServerClient();\n  \n  try {\n    const { data: { user }, error } = await supabase.auth.getUser();\n    \n    if (error) {\n      // Log error for debugging but don't expose to client\n      if (process.env.NODE_ENV === 'development') {\n        console.error('Error getting user:', error);\n      }\n      return null;\n    }\n    \n    return user;\n  } catch (error) {\n    // Log error for debugging but don't expose to client\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error in getServerUser:', error);\n    }\n    return null;\n  }\n}\n\n// Helper function to get user profile from server-side context\nexport async function getServerUserProfile(): Promise<Database['public']['Tables']['user_profiles']['Row'] | null> {\n  const user = await getServerUser();\n  \n  if (!user) {\n    return null;\n  }\n  \n  const supabase = await getSupabaseServerClient();\n  \n  try {\n    const { data: profile, error } = await supabase\n      .from('user_profiles')\n      .select('*')\n      .eq('user_id', user.id as any)\n      .single();\n    \n    if (error) {\n      // Log error for debugging but don't expose to client\n      if (process.env.NODE_ENV === 'development') {\n        console.error('Error getting user profile:', error);\n      }\n      return null;\n    }\n    \n    return profile as Database['public']['Tables']['user_profiles']['Row'];\n  } catch (error) {\n    // Log error for debugging but don't expose to client\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error in getServerUserProfile:', error);\n    }\n    return null;\n  }\n}\n\n// Helper function to check if user is admin\nexport async function isServerAdmin() {\n  const profile = await getServerUserProfile();\n  return profile ? profile.is_admin === true : false;\n}\n\n// Helper function to require admin access\nexport async function requireServerAdmin() {\n  const isAdmin = await isServerAdmin();\n  \n  if (!isAdmin) {\n    throw new Error('Admin access required');\n  }\n  \n  return true;\n}\n\n// Helper function to require user authentication\nexport async function requireServerAuth() {\n  const user = await getServerUser();\n  \n  if (!user) {\n    throw new Error('Authentication required');\n  }\n  \n  return user;\n}\n\n// Helper function to get user with profile\nexport async function getServerUserWithProfile() {\n  const user = await getServerUser();\n  \n  if (!user) {\n    return null;\n  }\n  \n  const profile = await getServerUserProfile();\n  \n  return {\n    user,\n    profile\n  };\n}\n\n// Helper function to create a new Supabase client for specific operations\nexport async function createServerSupabaseClient(): Promise<SupabaseClient<Database>> {\n  return await getSupabaseServerClient();\n}\n\n// Helper function to create an admin client for specific operations\nexport async function createServerAdminClient(): Promise<SupabaseClient<Database>> {\n  return await getSupabaseAdminClient();\n}\n\n// Export types for use in other modules\nexport type ServerUser = Awaited<ReturnType<typeof getServerUser>>;\nexport type ServerUserProfile = Awaited<ReturnType<typeof getServerUserProfile>>;\nexport type ServerUserWithProfile = Awaited<ReturnType<typeof getServerUserWithProfile>>;"],"names":["createServerAdminClient","createServerSupabaseClient","getServerUser","getServerUserProfile","getServerUserWithProfile","getSupabaseAdminClient","getSupabaseServerClient","isServerAdmin","requireServerAdmin","requireServerAuth","validateEnvironment","requiredVars","NEXT_PUBLIC_SUPABASE_URL","process","env","NEXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_SECRET_KEY","missing","Object","entries","filter","_","value","map","key","length","Error","join","cookieStore","cookies","createServerClient","get","name","set","options","error","remove","createClient","auth","autoRefreshToken","persistSession","supabase","data","user","getUser","NODE_ENV","console","profile","from","select","eq","id","single","is_admin","isAdmin"],"mappings":"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"}