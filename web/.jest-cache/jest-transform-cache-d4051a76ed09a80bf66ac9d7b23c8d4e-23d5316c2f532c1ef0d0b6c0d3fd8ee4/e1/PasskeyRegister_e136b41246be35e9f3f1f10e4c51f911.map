{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/features/auth/components/PasskeyRegister.tsx"],"sourcesContent":["'use client';\n\nimport { \n  Fingerprint, \n  Loader2, \n  CheckCircle, \n  AlertCircle, \n  Eye, \n  EyeOff,\n  Shield,\n  Smartphone,\n  Laptop\n} from 'lucide-react';\nimport React, { useState } from 'react';\n\nimport { Alert, AlertDescription } from '@/components/ui/alert';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { withOptional } from '@/lib/utils/objects';\n\ninterface PasskeyRegisterProps {\n  onSuccess?: (credential: unknown) => void;\n  onError?: (error: string) => void;\n  className?: string;\n}\n\nexport function PasskeyRegister({\n  onSuccess,\n  onError,\n  className\n}: PasskeyRegisterProps) {\n  const [isRegistering, setIsRegistering] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [success, setSuccess] = useState(false);\n  const [showAdvanced, setShowAdvanced] = useState(false);\n  const [username, setUsername] = useState('');\n  const [displayName, setDisplayName] = useState('');\n\n  const isWebAuthnSupported = () => {\n    return typeof window !== 'undefined' && \n           window.PublicKeyCredential && \n           typeof window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable === 'function';\n  };\n\n  const checkPlatformAuthenticator = async () => {\n    if (!isWebAuthnSupported()) return false;\n    \n    try {\n      return await window.PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable();\n    } catch (err) {\n      if (process.env.NODE_ENV === 'development') {\n        console.error('Error checking platform authenticator:', err);\n      }\n      return false;\n    }\n  };\n\n  const handleRegister = async () => {\n    if (!isWebAuthnSupported()) {\n      setError('WebAuthn is not supported in this browser');\n      onError?.('WebAuthn is not supported in this browser');\n      return;\n    }\n\n    setIsRegistering(true);\n    setError(null);\n    setSuccess(false);\n\n    try {\n      // Check if platform authenticator is available\n      const hasPlatformAuth = await checkPlatformAuthenticator();\n      \n      // Start WebAuthn registration\n      const response = await fetch('/api/v1/auth/webauthn/register/options', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          username: username || undefined,\n          displayName: displayName || undefined,\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.error || 'Failed to start registration');\n      }\n\n      const credentialOptions = await response.json();\n\n      // Create credential\n      const credential = await navigator.credentials.create({\n        publicKey: withOptional(credentialOptions, {\n          authenticatorSelection: withOptional(credentialOptions.authenticatorSelection, {\n            userVerification: 'required',\n            authenticatorAttachment: hasPlatformAuth ? 'platform' : 'cross-platform'\n          })\n        })\n      }) as PublicKeyCredential;\n\n      if (!credential) {\n        throw new Error('Failed to create credential');\n      }\n\n      // Complete registration\n      const completeResponse = await fetch('/api/v1/auth/webauthn/register/verify', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          id: credential.id,\n          rawId: Array.from(new Uint8Array(credential.rawId)),\n          response: {\n            attestationObject: Array.from(new Uint8Array((credential.response as AuthenticatorAttestationResponse).attestationObject)),\n            clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON))\n          },\n          type: credential.type\n        }),\n      });\n\n      if (!completeResponse.ok) {\n        const errorData = await completeResponse.json();\n        throw new Error(errorData.error || 'Failed to complete registration');\n      }\n\n      const result = await completeResponse.json();\n      setSuccess(true);\n      onSuccess?.(result);\n\n    } catch (err) {\n      const errorMessage = err instanceof Error ? err.message : 'Registration failed';\n      setError(errorMessage);\n      onError?.(errorMessage);\n    } finally {\n      setIsRegistering(false);\n    }\n  };\n\n  const getAuthenticatorIcon = () => {\n    if (typeof window === 'undefined') return <Shield className=\"h-6 w-6\" />;\n    \n    // Check if we're on a mobile device\n    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);\n    \n    return isMobile ? <Smartphone className=\"h-6 w-6\" /> : <Laptop className=\"h-6 w-6\" />;\n  };\n\n  if (!isWebAuthnSupported()) {\n    return (\n      <Card className={className}>\n        <CardHeader>\n          <CardTitle className=\"flex items-center space-x-2\">\n            <AlertCircle className=\"h-5 w-5 text-red-500\" />\n            <span>WebAuthn Not Supported</span>\n          </CardTitle>\n          <CardDescription>\n            Your browser does not support WebAuthn. Please use a modern browser or try a different authentication method.\n          </CardDescription>\n        </CardHeader>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className={className}>\n      <CardHeader>\n        <CardTitle className=\"flex items-center space-x-2\">\n          <Fingerprint className=\"h-5 w-5 text-blue-600\" />\n          <span>Register Passkey</span>\n        </CardTitle>\n        <CardDescription>\n          Create a secure passkey using your device&apos;s biometric authentication or security key\n        </CardDescription>\n      </CardHeader>\n\n      <CardContent className=\"space-y-4\">\n        {success ? (\n          <div className=\"text-center space-y-4\">\n            <CheckCircle className=\"h-12 w-12 text-green-500 mx-auto\" />\n            <div>\n              <h3 className=\"text-lg font-semibold text-green-700\">Registration Successful!</h3>\n              <p className=\"text-gray-600\">\n                Your passkey has been created and you can now use it to sign in.\n              </p>\n            </div>\n          </div>\n        ) : (\n          <>\n            {/* Advanced Options */}\n            <div className=\"space-y-4\">\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => setShowAdvanced(!showAdvanced)}\n                className=\"flex items-center space-x-2\"\n              >\n                {showAdvanced ? <EyeOff className=\"h-4 w-4\" /> : <Eye className=\"h-4 w-4\" />}\n                <span>{showAdvanced ? 'Hide' : 'Show'} Advanced Options</span>\n              </Button>\n\n              {showAdvanced && (\n                <div className=\"space-y-4 p-4 bg-gray-50 rounded-lg\">\n                  <div>\n                    <Label htmlFor=\"username\">Username (Optional)</Label>\n                    <Input\n                      id=\"username\"\n                      value={username}\n                      onChange={(e) => setUsername(e.target.value)}\n                      placeholder=\"Enter a username\"\n                      className=\"mt-1\"\n                    />\n                    <p className=\"text-xs text-gray-500 mt-1\">\n                      Leave empty for usernameless authentication\n                    </p>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"displayName\">Display Name (Optional)</Label>\n                    <Input\n                      id=\"displayName\"\n                      value={displayName}\n                      onChange={(e) => setDisplayName(e.target.value)}\n                      placeholder=\"Enter a display name\"\n                      className=\"mt-1\"\n                    />\n                    <p className=\"text-xs text-gray-500 mt-1\">\n                      This will be shown when you sign in\n                    </p>\n                  </div>\n                </div>\n              )}\n            </div>\n\n            {/* Device Information */}\n            <div className=\"flex items-center space-x-3 p-3 bg-blue-50 rounded-lg\">\n              {getAuthenticatorIcon()}\n              <div className=\"flex-1\">\n                <p className=\"text-sm font-medium text-blue-900\">Device Authentication</p>\n                <p className=\"text-xs text-blue-700\">\n                  Your device will prompt you to use biometric authentication or enter your device passcode\n                </p>\n              </div>\n            </div>\n\n            {/* Error Display */}\n            {error && (\n              <Alert variant=\"destructive\">\n                <AlertCircle className=\"h-4 w-4\" />\n                <AlertDescription>{error}</AlertDescription>\n              </Alert>\n            )}\n\n            {/* Register Button */}\n            <Button\n              data-testid=\"webauthn-register\"\n              onClick={handleRegister}\n              disabled={isRegistering}\n              className=\"w-full\"\n              size=\"lg\"\n            >\n              {isRegistering ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Creating Passkey...\n                </>\n              ) : (\n                <>\n                  <Fingerprint className=\"h-4 w-4 mr-2\" />\n                  Create Passkey\n                </>\n              )}\n            </Button>\n\n            {/* Security Information */}\n            <div className=\"text-xs text-gray-500 space-y-1\">\n              <p>• Your passkey is stored securely on your device</p>\n              <p>• No passwords are transmitted or stored</p>\n              <p>• Works with Touch ID, Face ID, Windows Hello, and security keys</p>\n            </div>\n          </>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nexport default PasskeyRegister;\n"],"names":["PasskeyRegister","onSuccess","onError","className","isRegistering","setIsRegistering","useState","error","setError","success","setSuccess","showAdvanced","setShowAdvanced","username","setUsername","displayName","setDisplayName","isWebAuthnSupported","window","PublicKeyCredential","isUserVerifyingPlatformAuthenticatorAvailable","checkPlatformAuthenticator","err","process","env","NODE_ENV","console","handleRegister","hasPlatformAuth","response","fetch","method","headers","body","JSON","stringify","undefined","ok","errorData","json","Error","credentialOptions","credential","navigator","credentials","create","publicKey","withOptional","authenticatorSelection","userVerification","authenticatorAttachment","completeResponse","id","rawId","Array","from","Uint8Array","attestationObject","clientDataJSON","type","result","errorMessage","message","getAuthenticatorIcon","Shield","isMobile","test","userAgent","Smartphone","Laptop","Card","CardHeader","CardTitle","AlertCircle","span","CardDescription","Fingerprint","CardContent","div","CheckCircle","h3","p","Button","variant","size","onClick","EyeOff","Eye","Label","htmlFor","Input","value","onChange","e","target","placeholder","Alert","AlertDescription","data-testid","disabled","Loader2"],"mappings":"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"}