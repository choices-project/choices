{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/app/api/polls/route.ts"],"sourcesContent":["import type { NextRequest} from 'next/server';\nimport { NextResponse } from 'next/server';\n\nimport { getUser } from '@/lib/core/auth/middleware';\nimport { devLog } from '@/lib/utils/logger';\nimport { getSupabaseServerClient } from '@/utils/supabase/server';\n\nexport const dynamic = 'force-dynamic';\n\n// Type definitions for poll data\ninterface PollOption {\n  id: string;\n  text: string;\n  votes?: number;\n}\n\ninterface _PollData {\n  id: string;\n  title: string;\n  total_votes: number;\n  options: PollOption[];\n  status: string;\n}\n\n// GET /api/polls - Get active polls with aggregated results only\nexport async function GET(request: NextRequest) {\n  try {\n    console.log('ðŸ” API Route: Calling getSupabaseServerClient...');\n    const supabaseClient = await getSupabaseServerClient();\n    console.log('ðŸ” API Route: Supabase client result:', !!supabaseClient);\n    \n    if (!supabaseClient) {\n      console.log('ðŸ” API Route: Supabase client is null/undefined');\n      return NextResponse.json(\n        { error: 'Supabase client not available' },\n        { status: 500 }\n      );\n    }\n\n    const { searchParams } = new URL(request.url);\n    const limit = parseInt(searchParams.get('limit') || '20');\n    const _status = searchParams.get('status') || 'active';\n\n    // Fetch active polls from polls table\n    let polls;\n\n    try {\n      devLog('Fetching active polls from polls table...');\n      const { data: directPolls, error: directError } = await supabaseClient\n        .from('polls')\n        .select('id, title, total_votes, options, status')\n        .eq('status', 'active')\n        .limit(limit);\n\n      if (directError) {\n        throw directError;\n      }\n\n      devLog('Found polls:', directPolls.length || 0);\n\n      // Manually aggregate results (temporary solution)\n      polls = (directPolls ?? []).map(poll => ({\n        id: poll.id,\n        title: poll.title,\n        total_votes: poll.total_votes || 0,\n        aggregated_results: Array.isArray(poll.options) ? \n          poll.options.reduce((acc: Record<string, number>, option: PollOption, index: number) => {\n            acc[`option_${index + 1}`] = option.votes || 0;\n            return acc;\n          }, {}) : {},\n        status: poll.status\n      }));\n    } catch (fallbackError) {\n      devLog('Error fetching polls:', fallbackError);\n      return NextResponse.json(\n        { error: 'Failed to fetch polls' },\n        { status: 500 }\n      );\n    }\n\n    // Additional security: ensure no sensitive data is returned\n    const sanitizedPolls = polls.map(poll => ({\n      poll_id: poll.id,\n      title: poll.title,\n      total_votes: poll.total_votes,\n      // Only include safe fields\n      status: 'active', // Always show as active for public view\n      created_at: new Date().toISOString(), // Generic timestamp\n    })) || [];\n\n    return NextResponse.json({\n      success: true,\n      polls: sanitizedPolls,\n      count: sanitizedPolls.length,\n      message: 'Aggregated poll results only - no individual vote data'\n    });\n\n  } catch (error) {\n    devLog('Error in polls API:', error);\n    return NextResponse.json(\n      { \n        error: 'Internal server error',\n        details: error instanceof Error ? error.message : String(error),\n        stack: error instanceof Error ? error.stack : undefined\n      },\n      { status: 500 }\n    );\n  }\n}\n\n// POST /api/polls - Create new poll (authenticated users only)\nexport async function POST(request: NextRequest) {\n  try {\n    // Always require authentication - no E2E bypasses\n    const supabase = await getSupabaseServerClient();\n    \n    if (!supabase) {\n      return NextResponse.json(\n        { error: 'Supabase client not available' },\n        { status: 500 }\n      );\n    }\n\n    // Always require authentication\n    let user;\n    try {\n      user = await getUser();\n    } catch (error) {\n      devLog('Authentication error during poll creation:', error);\n      return NextResponse.json(\n        { error: 'Authentication required to create polls' },\n        { status: 401 }\n      );\n    }\n    \n    // Check if user is authenticated\n    if (!user) {\n      return NextResponse.json(\n        { error: 'Authentication required to create polls' },\n        { status: 401 }\n      );\n    }\n    \n    // Verify user is active\n    if (user) {\n      const { data: userProfile } = await supabase\n        .from('user_profiles')\n        .select('is_active')\n        .eq('user_id', user.id)\n        .single();\n\n      if (!userProfile || !('is_active' in userProfile) || !userProfile.is_active) {\n        return NextResponse.json(\n          { error: 'Active account required to create polls' },\n          { status: 403 }\n        );\n      }\n    }\n\n    const body = await request.json();\n    const { \n      title, \n      options, \n      votingMethod = 'single',\n      description,\n      category = 'general',\n      privacyLevel = 'public',\n      allowMultipleVotes = false,\n      showResults = true,\n      allowComments = true,\n      endTime,\n      hashtags = [],\n      primaryHashtag\n    } = body;\n\n    // Validate required fields\n    if (!title || !options || !Array.isArray(options) || options.length < 2) {\n      return NextResponse.json(\n        { error: 'Title and at least 2 options are required' },\n        { status: 400 }\n      );\n    }\n\n    // Sanitize and validate options\n    const sanitizedOptions = options\n      .filter(option => typeof option === 'string' && option.trim().length > 0)\n      .map(option => option.trim())\n      .slice(0, 10); // Limit to 10 options max\n\n    if (sanitizedOptions.length < 2) {\n      return NextResponse.json(\n        { error: 'At least 2 valid options are required' },\n        { status: 400 }\n      );\n    }\n\n    // Create poll with user as creator\n    const { data: poll, error: pollError } = await supabase\n      .from('polls')\n      .insert({\n        title: title.trim(),\n        description: description?.trim() || null,\n        options: sanitizedOptions,\n        voting_method: votingMethod,\n        privacy_level: privacyLevel,\n        category,\n        status: 'active',\n        created_by: user?.id || '',\n        total_votes: 0,\n        participation: 0,\n        end_time: endTime || null,\n        hashtags: hashtags || [],\n        primary_hashtag: primaryHashtag || null,\n        poll_settings: {\n          allowMultipleVotes,\n          showResults,\n          allowComments\n        }\n      })\n      .select()\n      .single();\n\n    if (pollError) {\n      devLog('Error creating poll:', pollError);\n      return NextResponse.json(\n        { error: 'Failed to create poll', details: pollError },\n        { status: 500 }\n      );\n    }\n\n    // Return sanitized poll data (no sensitive information)\n    const sanitizedPoll = poll && !('error' in poll) ? {\n      id: poll.id,\n      title: poll.title,\n      description: poll.description,\n      options: poll.options,\n      voting_method: poll.voting_method,\n      privacy_level: poll.privacy_level,\n      category: poll.category,\n      status: poll.status,\n      total_votes: poll.total_votes,\n      participation: poll.participation,\n      end_time: poll.end_time,\n      hashtags: poll.hashtags || [],\n      primary_hashtag: poll.primary_hashtag,\n      poll_settings: poll.poll_settings,\n      created_at: poll.created_at\n    } : null;\n\n    return NextResponse.json(sanitizedPoll);\n\n  } catch (error) {\n    devLog('Error in polls API:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["GET","POST","dynamic","request","console","log","supabaseClient","getSupabaseServerClient","NextResponse","json","error","status","searchParams","URL","url","limit","parseInt","get","_status","polls","devLog","data","directPolls","directError","from","select","eq","length","map","poll","id","title","total_votes","aggregated_results","Array","isArray","options","reduce","acc","option","index","votes","fallbackError","sanitizedPolls","poll_id","created_at","Date","toISOString","success","count","message","details","Error","String","stack","undefined","supabase","user","getUser","userProfile","single","is_active","body","votingMethod","description","category","privacyLevel","allowMultipleVotes","showResults","allowComments","endTime","hashtags","primaryHashtag","sanitizedOptions","filter","trim","slice","pollError","insert","voting_method","privacy_level","created_by","participation","end_time","primary_hashtag","poll_settings","sanitizedPoll"],"mappings":"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"}