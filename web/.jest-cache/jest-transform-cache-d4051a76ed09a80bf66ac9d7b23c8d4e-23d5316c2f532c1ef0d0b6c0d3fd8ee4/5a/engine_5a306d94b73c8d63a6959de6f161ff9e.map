{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/engine.ts"],"sourcesContent":["/**\n * Core Voting Engine\n * \n * This module provides the main voting engine that orchestrates different voting strategies\n * and handles vote processing, validation, and results calculation.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\n\nimport { ApprovalStrategy } from './strategies/approval';\nimport { QuadraticStrategy } from './strategies/quadratic';\nimport { RangeStrategy } from './strategies/range';\nimport { RankedStrategy } from './strategies/ranked';\nimport { SingleChoiceStrategy } from './strategies/single-choice';\nimport type { \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  VotingStrategy,\n  PollData,\n  VoteData,\n  ResultsData,\n  VotingMethod\n} from './types';\n\nexport interface VoteEngineConfig {\n  maxVotesPerPoll: number;\n  allowMultipleVotes: boolean;\n  requireAuthentication: boolean;\n  minTrustTier: string;\n  rateLimitPerUser: number;\n  rateLimitWindowMs: number;\n}\n\nexport class VoteEngine {\n  private strategies: Map<VotingMethod, VotingStrategy>;\n  private config: VoteEngineConfig;\n  private rateLimitTracker: Map<string, { count: number; resetTime: number }>;\n\n  constructor(config: Partial<VoteEngineConfig> = {}) {\n    this.config = Object.assign({\n      maxVotesPerPoll: 10000,\n      allowMultipleVotes: false,\n      requireAuthentication: true,\n      minTrustTier: 'T0',\n      rateLimitPerUser: 10,\n      rateLimitWindowMs: 60000, // 1 minute\n    }, config);\n\n    // Initialize rate limiting tracker\n    this.rateLimitTracker = new Map();\n\n    // Initialize voting strategies\n    this.strategies = new Map([\n      ['single', new SingleChoiceStrategy()],\n      ['single-choice', new SingleChoiceStrategy()],\n      ['approval', new ApprovalStrategy()],\n      ['ranked', new RankedStrategy()],\n      ['ranked-choice', new RankedStrategy()],\n      ['quadratic', new QuadraticStrategy()],\n      ['range', new RangeStrategy()]\n    ]);\n\n    devLog('VoteEngine initialized with strategies:', Array.from(this.strategies.keys()));\n  }\n\n  /**\n   * Get the appropriate voting strategy for a poll\n   */\n  private getStrategy(method: VotingMethod): VotingStrategy {\n    const strategy = this.strategies.get(method);\n    if (!strategy) {\n      throw new Error(`Unsupported voting method: ${method}`);\n    }\n    return strategy;\n  }\n\n  /**\n   * Validate a vote request\n   */\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    const startTime = Date.now();\n    \n    try {\n      // Basic validation\n      if (!request.pollId || !request.voteData) {\n        return {\n          valid: false,\n          errors: ['Missing required vote data'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check if poll exists and is active\n      if (!poll || poll.status !== 'active') {\n        return {\n          valid: false,\n          errors: ['Poll is not active'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check poll end time\n      if (poll.endTime && new Date(poll.endTime) < new Date()) {\n        return {\n          valid: false,\n          errors: ['Poll has ended'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check authentication requirements\n      if (this.config.requireAuthentication && !request.userId) {\n        return {\n          valid: false,\n          errors: ['Authentication required to vote'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Check rate limiting\n      if (request.userId) {\n        const rateLimitKey = `${request.userId}:${request.pollId}`;\n        const now = Date.now();\n        const rateLimitData = this.rateLimitTracker.get(rateLimitKey);\n        \n        if (rateLimitData) {\n          if (now < rateLimitData.resetTime) {\n            if (rateLimitData.count >= this.config.rateLimitPerUser) {\n              return {\n                valid: false,\n                errors: ['Rate limit exceeded. Please try again later.'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          } else {\n            // Reset the counter if the window has expired\n            rateLimitData.count = 0;\n            rateLimitData.resetTime = now + this.config.rateLimitWindowMs;\n          }\n        } else {\n          // Initialize rate limit tracking\n          this.rateLimitTracker.set(rateLimitKey, {\n            count: 0,\n            resetTime: now + this.config.rateLimitWindowMs\n          });\n        }\n      }\n\n      // Get the appropriate strategy and validate the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const strategyValidation = await strategy.validateVote(request, poll);\n\n      if (!strategyValidation.valid) {\n        return Object.assign({}, strategyValidation, {\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        });\n      }\n\n      devLog('Vote validation completed', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        valid: true,\n        errors: [],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Vote validation error:', error);\n      return {\n        valid: false,\n        errors: [error instanceof Error ? error.message : 'Validation failed'],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n    }\n  }\n\n  /**\n   * Process a vote\n   */\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    const startTime = Date.now();\n    \n    try {\n      // Validate the vote first\n      const validation = await this.validateVote(request, poll);\n      if (!validation.valid) {\n        return {\n          success: false,\n          error: validation.errors?.[0] || 'Vote validation failed',\n          pollId: request.pollId,\n          responseTime: Date.now() - startTime\n        };\n      }\n\n      // Get the appropriate strategy and process the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const result = await strategy.processVote(request, poll);\n\n      // Increment rate limit counter\n      if (request.userId) {\n        const rateLimitKey = `${request.userId}:${request.pollId}`;\n        const rateLimitData = this.rateLimitTracker.get(rateLimitKey);\n        if (rateLimitData) {\n          rateLimitData.count++;\n        }\n      }\n\n      devLog('Vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        voteId: result.voteId,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        success: true,\n        voteId: result.voteId || `vote-${Date.now()}`,\n        pollId: request.pollId,\n        responseTime: Date.now() - startTime\n      };\n\n    } catch (error) {\n      devLog('Vote processing error:', error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : 'Vote processing failed',\n        pollId: request.pollId,\n        responseTime: Date.now() - startTime\n      };\n    }\n  }\n\n  /**\n   * Calculate results for a poll\n   */\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    const startTime = Date.now();\n    \n    try {\n      const strategy = this.getStrategy(poll.votingMethod);\n      const results = await strategy.calculateResults(poll, votes);\n\n      devLog('Results calculated successfully', {\n        pollId: poll.id,\n        method: poll.votingMethod,\n        totalVotes: votes.length,\n        duration: Date.now() - startTime\n      });\n\n      return results;\n\n    } catch (error) {\n      devLog('Results calculation error:', error);\n      \n      // Return a basic results structure for unsupported methods\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: votes.length,\n        participationRate: votes.length / 100, // Mock participation rate\n        results: {\n          winner: votes.length > 0 ? poll.options[0]?.id : undefined,\n          winnerVotes: votes.length,\n          winnerPercentage: 100,\n          optionVotes: poll.options.reduce((acc, option) => {\n            acc[option.id] = votes.length;\n            return acc;\n          }, {} as Record<string, number>),\n          optionPercentages: poll.options.reduce((acc, option) => {\n            acc[option.id] = 100;\n            return acc;\n          }, {} as Record<string, number>),\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      };\n    }\n  }\n\n  /**\n   * Get voting method configuration\n   */\n  getVotingMethodConfig(method: VotingMethod): Record<string, unknown> {\n    const strategy = this.getStrategy(method);\n    return strategy.getConfiguration();\n  }\n\n  /**\n   * Update engine configuration\n   */\n  updateConfig(newConfig: Partial<VoteEngineConfig>): void {\n    this.config = Object.assign({}, this.config, newConfig);\n    devLog('VoteEngine configuration updated:', this.config);\n  }\n\n  /**\n   * Get current configuration\n   */\n  getConfig(): VoteEngineConfig {\n    return { ...this.config };\n  }\n}\n\n// Export a default instance\nexport const voteEngine = new VoteEngine();\n"],"names":["VoteEngine","voteEngine","constructor","config","Object","assign","maxVotesPerPoll","allowMultipleVotes","requireAuthentication","minTrustTier","rateLimitPerUser","rateLimitWindowMs","rateLimitTracker","Map","strategies","SingleChoiceStrategy","ApprovalStrategy","RankedStrategy","QuadraticStrategy","RangeStrategy","devLog","Array","from","keys","getStrategy","method","strategy","get","Error","validateVote","request","poll","startTime","Date","now","pollId","voteData","valid","errors","requiresAuthentication","requiresTokens","status","endTime","userId","rateLimitKey","rateLimitData","resetTime","count","set","votingMethod","strategyValidation","duration","error","message","processVote","validation","success","responseTime","result","voteId","calculateResults","votes","results","id","totalVotes","length","participationRate","winner","options","undefined","winnerVotes","winnerPercentage","optionVotes","reduce","acc","option","optionPercentages","abstentions","abstentionPercentage","calculatedAt","toISOString","metadata","calculationTime","getVotingMethodConfig","getConfiguration","updateConfig","newConfig","getConfig"],"mappings":"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"}