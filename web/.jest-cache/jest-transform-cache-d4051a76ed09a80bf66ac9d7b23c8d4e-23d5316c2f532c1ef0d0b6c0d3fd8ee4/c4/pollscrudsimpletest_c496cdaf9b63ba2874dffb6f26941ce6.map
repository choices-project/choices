{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/core/polls-crud-simple.test.ts"],"sourcesContent":["/**\n * Polls CRUD API Tests - SIMPLE VERSION\n * \n * This is a simplified test that focuses on the core functionality\n * without complex mocking. We'll start here and evolve the tests.\n */\n\nimport { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\nimport { NextRequest } from 'next/server';\nimport { GET, POST } from '@/app/api/polls/route';\n\n// Simple mock that just returns what we need\nconst mockSupabaseClient = {\n  from: jest.fn(() => ({\n    select: jest.fn(() => ({\n      eq: jest.fn(() => ({\n        limit: jest.fn().mockResolvedValue({\n          data: [\n            {\n              id: 'poll-1',\n              title: 'Test Poll 1',\n              total_votes: 10,\n              options: [\n                { id: 'opt-1', text: 'Option 1', votes: 6 },\n                { id: 'opt-2', text: 'Option 2', votes: 4 }\n              ],\n              status: 'active'\n            }\n          ],\n          error: null,\n        }),\n      })),\n    })),\n    insert: jest.fn(() => ({\n      select: jest.fn().mockResolvedValue({\n        data: [{ \n          id: 'poll-123', \n          title: 'New Test Poll',\n          total_votes: 0,\n          options: [\n            { id: 'opt-new-1', text: 'New Option 1', votes: 0 },\n            { id: 'opt-new-2', text: 'New Option 2', votes: 0 }\n          ],\n          status: 'active'\n        }],\n        error: null,\n      }),\n    })),\n  })),\n};\n\n// Mock the Supabase server client\njest.mock('@/utils/supabase/server', () => ({\n  getSupabaseServerClient: jest.fn(() => Promise.resolve(mockSupabaseClient)),\n}));\n\n// Mock authentication middleware\njest.mock('@/lib/core/auth/middleware', () => ({\n  getUser: jest.fn(() => Promise.resolve({\n    id: 'user-123',\n    email: 'test@example.com',\n    role: 'user'\n  })),\n}));\n\n// Mock logger\njest.mock('@/lib/utils/logger', () => ({\n  devLog: jest.fn(),\n}));\n\ndescribe('Polls CRUD API - SIMPLE', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  afterEach(() => {\n    jest.restoreAllMocks();\n  });\n\n  describe('GET /api/polls - List Polls', () => {\n    it('should return list of polls', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      // For now, just check that we get a response\n      // We'll evolve this to check the exact structure later\n      expect(response.status).toBe(200);\n      expect(responseData).toHaveProperty('success');\n      expect(responseData).toHaveProperty('polls');\n    });\n\n    it('should handle errors gracefully', async () => {\n      // Mock an error\n      mockSupabaseClient.from().select().eq().limit.mockResolvedValueOnce({\n        data: null,\n        error: { message: 'Database error' },\n      });\n\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(500);\n      expect(responseData.error).toBe('Failed to fetch polls');\n    });\n  });\n\n  describe('POST /api/polls - Create Poll', () => {\n    beforeEach(() => {\n      // Mock user profile check\n      mockSupabaseClient.from().select().eq().single.mockResolvedValue({\n        data: { is_active: true },\n        error: null,\n      });\n    });\n\n    it('should create a new poll with valid data', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'New Test Poll',\n          options: [\n            { text: 'New Option 1' },\n            { text: 'New Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      // For now, just check that we get a response\n      // We'll evolve this to check the exact structure later\n      expect(response.status).toBe(201);\n      expect(responseData).toHaveProperty('poll');\n    });\n\n    it('should reject poll creation without authentication', async () => {\n      // Mock no authentication\n      const { getUser } = require('@/lib/core/auth/middleware');\n      getUser.mockResolvedValueOnce(null);\n\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'Unauthorized Poll',\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(401);\n      expect(responseData.error).toBe('Authentication required to create polls');\n    });\n  });\n});\n"],"names":["jest","mock","getSupabaseServerClient","fn","Promise","resolve","mockSupabaseClient","getUser","id","email","role","devLog","from","select","eq","limit","mockResolvedValue","data","title","total_votes","options","text","votes","status","error","insert","describe","beforeEach","clearAllMocks","afterEach","restoreAllMocks","it","request","NextRequest","response","GET","responseData","json","expect","toBe","toHaveProperty","mockResolvedValueOnce","message","single","is_active","method","headers","body","JSON","stringify","POST","require"],"mappings":"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"}