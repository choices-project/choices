{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/core/auth/middleware.ts"],"sourcesContent":["/**\n * Core Authentication Middleware\n * \n * Enhanced authentication middleware with security features:\n * - Origin validation\n * - Rate limiting integration\n * - Turnstile verification\n * - Comprehensive error handling\n */\n\nimport type { SupabaseClient, User } from '@supabase/supabase-js';\nimport { type NextRequest, NextResponse } from 'next/server';\n\nimport { rateLimiters } from '@/lib/core/security/rate-limit';\nimport { requireTrustedOrigin } from '@/lib/http/origin';\nimport { requireTurnstileVerification } from '@/lib/security/turnstile';\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\nimport { getSupabaseServerClient } from '@/utils/supabase/server';\n\nexport type TrustTier = 'T1' | 'T2' | 'T3';\n\nexport interface AuthUser {\n  id: string;\n  email: string;\n  trust_tier: TrustTier;\n  username?: string | null;\n}\n\nexport interface AuthContext {\n  user: AuthUser;\n  supabase: SupabaseClient;\n}\n\nexport interface UserProfile {\n  trust_tier: TrustTier;\n  username?: string;\n}\n\nexport interface AuthMiddlewareOptions {\n  requireAuth?: boolean;\n  requireTrustTier?: TrustTier;\n  requireAdmin?: boolean;\n  allowPublic?: boolean;\n  requireOrigin?: boolean;\n  requireTurnstile?: boolean;\n  turnstileAction?: string;\n  rateLimit?: 'auth' | 'registration' | 'deviceFlow' | 'biometric';\n}\n\n/**\n * Enhanced authentication middleware factory\n */\nexport function createAuthMiddleware(options: AuthMiddlewareOptions = {}) {\n  const {\n    requireAuth = true,\n    requireTrustTier,\n    requireAdmin = false,\n    allowPublic = false,\n    requireOrigin = true,\n    requireTurnstile = false,\n    turnstileAction,\n    rateLimit = 'auth'\n  } = options;\n\n  return async (request: NextRequest, context?: AuthContext): Promise<NextResponse | null> => {\n    try {\n      // Origin validation\n      if (requireOrigin) {\n        try {\n          requireTrustedOrigin(request);\n        } catch (error) {\n          devLog('Origin validation failed:', error);\n          return NextResponse.json(\n            { message: 'Invalid origin' },\n            { status: 403 }\n          );\n        }\n      }\n\n      // Use context if provided for enhanced authentication\n      if (context?.user && !allowPublic) {\n        devLog('Using provided authentication context', {\n          userId: context.user.id,\n          trustTier: context.user.trust_tier\n        });\n      }\n\n      // Rate limiting\n      if (rateLimit) {\n        const rateLimitResult = await rateLimiters[rateLimit].check(request);\n        \n        if (!rateLimitResult.allowed) {\n          return NextResponse.json(\n            { \n              message: 'Too many requests. Please try again later.',\n              retryAfter: rateLimitResult.retryAfter\n            },\n            { status: 429 }\n          );\n        }\n      }\n\n      // Turnstile verification\n      if (requireTurnstile) {\n        try {\n          await requireTurnstileVerification(request, turnstileAction);\n        } catch (error) {\n          devLog('Turnstile verification failed:', error);\n          return NextResponse.json(\n            { message: 'Security verification failed' },\n            { status: 403 }\n          );\n        }\n      }\n\n      // Create Supabase client at runtime\n      const supabase = await getSupabaseServerClient();\n\n      if (!supabase) {\n        return NextResponse.json(\n          { message: 'Authentication service not available' },\n          { status: 500 }\n        );\n      }\n\n      // Get current user session\n      const { data: { user }, error: authError } = await supabase.auth.getUser();\n\n      // Handle unauthenticated requests\n      if (authError || !user) {\n        if (requireAuth) {\n          return NextResponse.json(\n            { message: 'Authentication required' },\n            { status: 401 }\n          );\n        }\n        \n        if (allowPublic) {\n          // Allow public access but return null user\n          return null;\n        }\n        \n        return NextResponse.json(\n          { message: 'Authentication required' },\n          { status: 401 }\n        );\n      }\n\n      // Get user profile\n      const { data: profile, error: profileError } = await supabase\n        .from('user_profiles')\n        .select('trust_tier, username')\n        .eq('user_id', String(user.id))\n        .single();\n\n      if (profileError) {\n        devLog('Profile lookup error', profileError, { userId: user.id });\n        return NextResponse.json(\n          { message: 'User profile not found' },\n          { status: 404 }\n        );\n      }\n\n      const authUser: AuthUser = withOptional({\n        id: user.id,\n        email: user.email || '',\n        trust_tier: profile && !('error' in profile) ? (profile as UserProfile).trust_tier || 'T1' : 'T1'\n      }, {\n        username: profile && !('error' in profile) ? (profile as UserProfile).username : null\n      });\n\n      // Check admin requirement - rely on RLS policies for security\n      if (requireAdmin) {\n        const { data: adminCheck, error: adminError } = await supabase\n          .rpc('is_admin', { user_id: user.id });\n\n        if (adminError || !adminCheck) {\n          return NextResponse.json(\n            { message: 'Admin access required - insufficient privileges' },\n            { status: 403 }\n          );\n        }\n      }\n\n      // Check trust tier requirement\n      if (requireTrustTier) {\n        const tierHierarchy: Record<TrustTier, number> = {\n          'T1': 1,\n          'T2': 2,\n          'T3': 3\n        };\n\n        const userTier = tierHierarchy[authUser.trust_tier] || 0;\n        const requiredTier = tierHierarchy[requireTrustTier];\n\n        if (userTier < requiredTier) {\n          return NextResponse.json(\n            { message: `Trust tier ${requireTrustTier} required` },\n            { status: 403 }\n          );\n        }\n      }\n\n      // Return null to continue processing (authentication successful)\n      return null;\n\n    } catch (error) {\n      devLog('Auth middleware error', error instanceof Error ? error : new Error(String(error)));\n\n      return NextResponse.json(\n        { message: 'Authentication error' },\n        { status: 500 }\n      );\n    }\n  };\n}\n\n/**\n * Higher-order function to wrap API handlers with authentication\n */\nexport function withAuth(\n  handler: (request: NextRequest, context: AuthContext) => Promise<NextResponse>,\n  options: AuthMiddlewareOptions = {}\n) {\n  return async (request: NextRequest): Promise<NextResponse> => {\n    const authMiddleware = createAuthMiddleware(options);\n    const authResult = await authMiddleware(request);\n\n    if (authResult) {\n      return authResult;\n    }\n\n    // Get user context for the handler at runtime\n    const supabase = await getSupabaseServerClient();\n    \n    if (!supabase) {\n      return NextResponse.json(\n        { message: 'Authentication service not available' },\n        { status: 500 }\n      );\n    }\n    \n    const { data: { user } } = await supabase.auth.getUser();\n    \n    // Use RLS function to check admin status\n    const { data: isAdmin } = await supabase\n      .rpc('is_admin', { user_id: user!.id });\n\n    const { data: profile } = await supabase\n      .from('user_profiles')\n      .select('username')\n      .eq('user_id', String(user!.id))\n      .single();\n\n    const context: AuthContext = {\n      user: withOptional({\n        id: user!.id,\n        email: user!.email || '',\n        trust_tier: isAdmin ? 'T3' : 'T1'\n      }, {\n        username: profile && !('error' in profile) ? (profile as UserProfile).username : null\n      }),\n      supabase\n    };\n\n    // Log successful authentication\n    devLog('Auth middleware: Processing request for user:', {\n      userId: context.user.id,\n      trustTier: context.user.trust_tier,\n      method: request.method,\n      path: request.nextUrl.pathname\n    });\n    \n    return handler(request, context);\n  };\n}\n\n/**\n * Rate limiting middleware factory\n */\nexport function createRateLimitMiddleware(options: {\n  maxRequests: number;\n  windowMs: number;\n  keyGenerator?: (request: NextRequest) => string;\n}) {\n  const { maxRequests, windowMs, keyGenerator } = options;\n\n  return async (request: NextRequest): Promise<NextResponse | null> => {\n    const key = keyGenerator ? keyGenerator(request) : 'default';\n    \n    // Use the enhanced rate limiter with custom parameters\n    const rateLimitResult = await rateLimiters.auth.check(request);\n    \n    // Log rate limit configuration for debugging\n    devLog('Rate limit check', {\n      key: `${key.substring(0, 8)  }...`,\n      maxRequests,\n      windowMs,\n      allowed: rateLimitResult.allowed\n    });\n    \n    if (!rateLimitResult.allowed) {\n      return NextResponse.json(\n        { \n          message: 'Too many requests. Please try again later.',\n          retryAfter: rateLimitResult.retryAfter,\n          limit: maxRequests,\n          window: windowMs\n        },\n        { status: 429 }\n      );\n    }\n\n    return null;\n  };\n}\n\n/**\n * Security headers middleware\n */\nexport function createSecurityHeadersMiddleware() {\n  return (response: NextResponse): NextResponse => {\n    // Add security headers\n    response.headers.set('X-Content-Type-Options', 'nosniff');\n    response.headers.set('X-Frame-Options', 'DENY');\n    response.headers.set('X-XSS-Protection', '1; mode=block');\n    response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');\n    response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');\n    response.headers.set('Vary', 'Cookie, Authorization');\n\n    return response;\n  };\n}\n\n/**\n * Combined middleware for API routes\n */\nexport function createApiMiddleware(options: AuthMiddlewareOptions = {}) {\n  return async (request: NextRequest): Promise<NextResponse | null> => {\n    // Apply authentication middleware\n    const authMiddleware = createAuthMiddleware(options);\n    const authResult = await authMiddleware(request);\n\n    if (authResult) {\n      return authResult;\n    }\n\n    // Apply security headers\n    const response = new NextResponse();\n    return createSecurityHeadersMiddleware()(response);\n  };\n}\n\n/**\n * Combine multiple middleware functions into a single middleware\n */\nexport function combineMiddleware(...middlewares: Array<(request: NextRequest) => Promise<NextResponse | null>>) {\n  return async (request: NextRequest): Promise<NextResponse | null> => {\n    for (const middleware of middlewares) {\n      const result = await middleware(request);\n      if (result) {\n        return result;\n      }\n    }\n    return null;\n  };\n}\n\n/**\n * Simple getUser function for backward compatibility\n * Uses canonical Supabase client\n */\nexport async function getUser(): Promise<User | null> {\n  try {\n    const supabase = await getSupabaseServerClient();\n    const { data: { user }, error } = await supabase.auth.getUser();\n    \n    if (error) {\n      devLog('getUser error:', error);\n      return null;\n    }\n    \n    return user;\n  } catch (error) {\n    devLog('getUser error:', error);\n    return null;\n  }\n}\n\n/**\n * requireUser function for backward compatibility\n * Uses canonical Supabase client\n */\nexport async function requireUser(_req: Request): Promise<User> {\n  const user = await getUser();\n  \n  if (!user) {\n    throw new Error('Authentication required');\n  }\n  \n  return user;\n}"],"names":["combineMiddleware","createApiMiddleware","createAuthMiddleware","createRateLimitMiddleware","createSecurityHeadersMiddleware","getUser","requireUser","withAuth","options","requireAuth","requireTrustTier","requireAdmin","allowPublic","requireOrigin","requireTurnstile","turnstileAction","rateLimit","request","context","requireTrustedOrigin","error","devLog","NextResponse","json","message","status","user","userId","id","trustTier","trust_tier","rateLimitResult","rateLimiters","check","allowed","retryAfter","requireTurnstileVerification","supabase","getSupabaseServerClient","data","authError","auth","profile","profileError","from","select","eq","String","single","authUser","withOptional","email","username","adminCheck","adminError","rpc","user_id","tierHierarchy","userTier","requiredTier","Error","handler","authMiddleware","authResult","isAdmin","method","path","nextUrl","pathname","maxRequests","windowMs","keyGenerator","key","substring","limit","window","response","headers","set","middlewares","middleware","result","_req"],"mappings":"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"}