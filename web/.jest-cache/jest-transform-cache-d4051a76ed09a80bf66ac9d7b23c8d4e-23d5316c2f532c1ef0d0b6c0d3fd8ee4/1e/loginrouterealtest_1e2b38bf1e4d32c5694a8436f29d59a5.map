{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/auth/login-route-real.test.ts"],"sourcesContent":["/**\n * @jest-environment node\n */\n\nimport { NextRequest } from 'next/server';\nimport { POST } from '@/app/api/auth/login/route';\n\n// Mock Next.js cookies to allow Supabase client to work in tests\njest.mock('next/headers', () => ({\n  cookies: jest.fn(() => ({\n    get: jest.fn(),\n    set: jest.fn(),\n    delete: jest.fn(),\n  })),\n}));\n\ndescribe('Auth Login Route - Real Database Testing', () => {\n  // No mocking - use real database, real rate limiting, real everything\n\n  it('should handle invalid credentials gracefully', async () => {\n    const request = new NextRequest('http://localhost:3000/api/auth/login', {\n      method: 'POST',\n      body: JSON.stringify({\n        email: 'nonexistent@example.com',\n        password: 'wrongpassword',\n      }),\n      headers: {\n        'Content-Type': 'application/json',\n        'x-forwarded-for': '127.0.0.1',\n        'user-agent': 'test-agent',\n      },\n    });\n\n    const response = await POST(request);\n    const data = await response.json();\n\n    // Should return 401 for invalid credentials\n    expect(response.status).toBe(401);\n    expect(data.message).toBe('Invalid email or password');\n  });\n\n  it('should validate required fields', async () => {\n    const request = new NextRequest('http://localhost:3000/api/auth/login', {\n      method: 'POST',\n      body: JSON.stringify({\n        email: 'test@example.com',\n        // Missing password\n      }),\n      headers: {\n        'Content-Type': 'application/json',\n        'x-forwarded-for': '127.0.0.1',\n        'user-agent': 'test-agent',\n      },\n    });\n\n    const response = await POST(request);\n    const data = await response.json();\n\n    // Should return 400 for missing password\n    expect(response.status).toBe(400);\n    expect(data.message).toBe('Email and password are required');\n  });\n\n  it('should handle malformed JSON', async () => {\n    const request = new NextRequest('http://localhost:3000/api/auth/login', {\n      method: 'POST',\n      body: 'invalid json',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-forwarded-for': '127.0.0.1',\n        'user-agent': 'test-agent',\n      },\n    });\n\n    const response = await POST(request);\n    \n    // Should return 500 for malformed JSON\n    expect(response.status).toBe(500);\n  });\n\n  it('should test rate limiting with multiple requests', async () => {\n    // Test rate limiting by making multiple requests\n    const requests = Array.from({ length: 5 }, () => \n      new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'wrongpassword',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n          'x-forwarded-for': '127.0.0.1',\n          'user-agent': 'test-agent',\n        },\n      })\n    );\n\n    const responses = await Promise.all(requests.map(request => POST(request)));\n    \n    // Should get 401s for invalid credentials, then 429 for rate limiting\n    const statusCodes = responses.map(r => r.status);\n    expect(statusCodes).toContain(401); // Invalid credentials\n    expect(statusCodes).toContain(429); // Rate limited\n  });\n});\n"],"names":["jest","mock","cookies","fn","get","set","delete","describe","it","request","NextRequest","method","body","JSON","stringify","email","password","headers","response","POST","data","json","expect","status","toBe","message","requests","Array","from","length","responses","Promise","all","map","statusCodes","r","toContain"],"mappings":"AAAA;;CAEC;AAKD,iEAAiE;AACjEA,KAAKC,IAAI,CAAC,gBAAgB,IAAO,CAAA;QAC/BC,SAASF,KAAKG,EAAE,CAAC,IAAO,CAAA;gBACtBC,KAAKJ,KAAKG,EAAE;gBACZE,KAAKL,KAAKG,EAAE;gBACZG,QAAQN,KAAKG,EAAE;YACjB,CAAA;IACF,CAAA;;;;wBAV4B;uBACP;AAWrBI,SAAS,4CAA4C;IACnD,sEAAsE;IAEtEC,GAAG,gDAAgD;QACjD,MAAMC,UAAU,IAAIC,mBAAW,CAAC,wCAAwC;YACtEC,QAAQ;YACRC,MAAMC,KAAKC,SAAS,CAAC;gBACnBC,OAAO;gBACPC,UAAU;YACZ;YACAC,SAAS;gBACP,gBAAgB;gBAChB,mBAAmB;gBACnB,cAAc;YAChB;QACF;QAEA,MAAMC,WAAW,MAAMC,IAAAA,WAAI,EAACV;QAC5B,MAAMW,OAAO,MAAMF,SAASG,IAAI;QAEhC,4CAA4C;QAC5CC,OAAOJ,SAASK,MAAM,EAAEC,IAAI,CAAC;QAC7BF,OAAOF,KAAKK,OAAO,EAAED,IAAI,CAAC;IAC5B;IAEAhB,GAAG,mCAAmC;QACpC,MAAMC,UAAU,IAAIC,mBAAW,CAAC,wCAAwC;YACtEC,QAAQ;YACRC,MAAMC,KAAKC,SAAS,CAAC;gBACnBC,OAAO;YAET;YACAE,SAAS;gBACP,gBAAgB;gBAChB,mBAAmB;gBACnB,cAAc;YAChB;QACF;QAEA,MAAMC,WAAW,MAAMC,IAAAA,WAAI,EAACV;QAC5B,MAAMW,OAAO,MAAMF,SAASG,IAAI;QAEhC,yCAAyC;QACzCC,OAAOJ,SAASK,MAAM,EAAEC,IAAI,CAAC;QAC7BF,OAAOF,KAAKK,OAAO,EAAED,IAAI,CAAC;IAC5B;IAEAhB,GAAG,gCAAgC;QACjC,MAAMC,UAAU,IAAIC,mBAAW,CAAC,wCAAwC;YACtEC,QAAQ;YACRC,MAAM;YACNK,SAAS;gBACP,gBAAgB;gBAChB,mBAAmB;gBACnB,cAAc;YAChB;QACF;QAEA,MAAMC,WAAW,MAAMC,IAAAA,WAAI,EAACV;QAE5B,uCAAuC;QACvCa,OAAOJ,SAASK,MAAM,EAAEC,IAAI,CAAC;IAC/B;IAEAhB,GAAG,oDAAoD;QACrD,iDAAiD;QACjD,MAAMkB,WAAWC,MAAMC,IAAI,CAAC;YAAEC,QAAQ;QAAE,GAAG,IACzC,IAAInB,mBAAW,CAAC,wCAAwC;gBACtDC,QAAQ;gBACRC,MAAMC,KAAKC,SAAS,CAAC;oBACnBC,OAAO;oBACPC,UAAU;gBACZ;gBACAC,SAAS;oBACP,gBAAgB;oBAChB,mBAAmB;oBACnB,cAAc;gBAChB;YACF;QAGF,MAAMa,YAAY,MAAMC,QAAQC,GAAG,CAACN,SAASO,GAAG,CAACxB,CAAAA,UAAWU,IAAAA,WAAI,EAACV;QAEjE,sEAAsE;QACtE,MAAMyB,cAAcJ,UAAUG,GAAG,CAACE,CAAAA,IAAKA,EAAEZ,MAAM;QAC/CD,OAAOY,aAAaE,SAAS,CAAC,MAAM,sBAAsB;QAC1Dd,OAAOY,aAAaE,SAAS,CAAC,MAAM,eAAe;IACrD;AACF"}