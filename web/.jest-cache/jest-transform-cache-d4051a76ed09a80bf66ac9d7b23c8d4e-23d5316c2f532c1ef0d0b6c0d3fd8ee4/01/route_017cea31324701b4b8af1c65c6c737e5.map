{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/app/api/polls/route.ts"],"sourcesContent":["import type { NextRequest} from 'next/server';\nimport { NextResponse } from 'next/server';\n\nimport { getUser } from '@/lib/core/auth/middleware';\nimport { devLog } from '@/lib/utils/logger';\nimport { getSupabaseServerClient } from '@/utils/supabase/server';\n\nexport const dynamic = 'force-dynamic';\n\n// Type definitions for poll data\ninterface PollOption {\n  id: string;\n  text: string;\n  votes?: number;\n}\n\ninterface _PollData {\n  id: string;\n  title: string;\n  total_votes: number;\n  options: PollOption[];\n  status: string;\n}\n\n// GET /api/polls - Get active polls with aggregated results only\nexport async function GET(request: NextRequest) {\n  try {\n    const supabaseClient = await getSupabaseServerClient();\n\n    const { searchParams } = new URL(request.url);\n    const limit = parseInt(searchParams.get('limit') || '20');\n    const _status = searchParams.get('status') || 'active';\n\n    // Fetch active polls from polls table\n    let polls;\n\n    try {\n      devLog('Fetching active polls from polls table...');\n      const { data: directPolls, error: directError } = await supabaseClient\n        .from('polls')\n        .select('id, title, total_votes, options, status')\n        .eq('status', 'active')\n        .limit(limit);\n\n      if (directError) {\n        throw directError;\n      }\n\n      devLog('Found polls:', directPolls.length || 0);\n\n      // Manually aggregate results (temporary solution)\n      polls = (directPolls ?? []).map(poll => ({\n        id: poll.id,\n        title: poll.title,\n        total_votes: poll.total_votes || 0,\n        aggregated_results: Array.isArray(poll.options) ? \n          poll.options.reduce((acc: Record<string, number>, option: PollOption, index: number) => {\n            acc[`option_${index + 1}`] = option.votes || 0;\n            return acc;\n          }, {}) : {},\n        status: poll.status\n      }));\n    } catch (fallbackError) {\n      devLog('Error fetching polls:', fallbackError);\n      return NextResponse.json(\n        { error: 'Failed to fetch polls' },\n        { status: 500 }\n      );\n    }\n\n    // Additional security: ensure no sensitive data is returned\n    const sanitizedPolls = polls.map(poll => ({\n      poll_id: poll.id,\n      title: poll.title,\n      total_votes: poll.total_votes,\n      // Only include safe fields\n      status: 'active', // Always show as active for public view\n      created_at: new Date().toISOString(), // Generic timestamp\n    })) || [];\n\n    return NextResponse.json({\n      success: true,\n      polls: sanitizedPolls,\n      count: sanitizedPolls.length,\n      message: 'Aggregated poll results only - no individual vote data'\n    });\n\n  } catch (error) {\n    devLog('Error in polls API:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST /api/polls - Create new poll (authenticated users only)\nexport async function POST(request: NextRequest) {\n  try {\n    // Always require authentication - no E2E bypasses\n    const supabase = await getSupabaseServerClient();\n    \n    if (!supabase) {\n      return NextResponse.json(\n        { error: 'Supabase client not available' },\n        { status: 500 }\n      );\n    }\n\n    // Always require authentication\n    let user;\n    try {\n      user = await getUser();\n    } catch (error) {\n      devLog('Authentication error during poll creation:', error);\n      return NextResponse.json(\n        { error: 'Authentication required to create polls' },\n        { status: 401 }\n      );\n    }\n    \n    // Check if user is authenticated\n    if (!user) {\n      return NextResponse.json(\n        { error: 'Authentication required to create polls' },\n        { status: 401 }\n      );\n    }\n    \n    // Verify user is active\n    if (user) {\n      const { data: userProfile } = await supabase\n        .from('user_profiles')\n        .select('is_active')\n        .eq('user_id', user.id)\n        .single();\n\n      if (!userProfile || !('is_active' in userProfile) || !userProfile.is_active) {\n        return NextResponse.json(\n          { error: 'Active account required to create polls' },\n          { status: 403 }\n        );\n      }\n    }\n\n    const body = await request.json();\n    const { \n      title, \n      options, \n      votingMethod = 'single',\n      description,\n      category = 'general',\n      privacyLevel = 'public',\n      allowMultipleVotes = false,\n      showResults = true,\n      allowComments = true,\n      endTime,\n      hashtags = [],\n      primaryHashtag\n    } = body;\n\n    // Validate required fields\n    if (!title || !options || !Array.isArray(options) || options.length < 2) {\n      return NextResponse.json(\n        { error: 'Title and at least 2 options are required' },\n        { status: 400 }\n      );\n    }\n\n    // Sanitize and validate options\n    const sanitizedOptions = options\n      .filter(option => typeof option === 'string' && option.trim().length > 0)\n      .map(option => option.trim())\n      .slice(0, 10); // Limit to 10 options max\n\n    if (sanitizedOptions.length < 2) {\n      return NextResponse.json(\n        { error: 'At least 2 valid options are required' },\n        { status: 400 }\n      );\n    }\n\n    // Create poll with user as creator\n    const { data: poll, error: pollError } = await supabase\n      .from('polls')\n      .insert({\n        title: title.trim(),\n        description: description?.trim() || null,\n        options: sanitizedOptions,\n        voting_method: votingMethod,\n        privacy_level: privacyLevel,\n        category,\n        status: 'active',\n        created_by: user?.id || '',\n        total_votes: 0,\n        participation: 0,\n        end_time: endTime || null,\n        hashtags: hashtags || [],\n        primary_hashtag: primaryHashtag || null,\n        poll_settings: {\n          allowMultipleVotes,\n          showResults,\n          allowComments\n        }\n      })\n      .select()\n      .single();\n\n    if (pollError) {\n      devLog('Error creating poll:', pollError);\n      return NextResponse.json(\n        { error: 'Failed to create poll', details: pollError },\n        { status: 500 }\n      );\n    }\n\n    // Return sanitized poll data (no sensitive information)\n    const sanitizedPoll = poll && !('error' in poll) ? {\n      id: poll.id,\n      title: poll.title,\n      description: poll.description,\n      options: poll.options,\n      voting_method: poll.voting_method,\n      privacy_level: poll.privacy_level,\n      category: poll.category,\n      status: poll.status,\n      total_votes: poll.total_votes,\n      participation: poll.participation,\n      end_time: poll.end_time,\n      hashtags: poll.hashtags || [],\n      primary_hashtag: poll.primary_hashtag,\n      poll_settings: poll.poll_settings,\n      created_at: poll.created_at\n    } : null;\n\n    return NextResponse.json(sanitizedPoll);\n\n  } catch (error) {\n    devLog('Error in polls API:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["GET","POST","dynamic","request","supabaseClient","getSupabaseServerClient","searchParams","URL","url","limit","parseInt","get","_status","polls","devLog","data","directPolls","error","directError","from","select","eq","length","map","poll","id","title","total_votes","aggregated_results","Array","isArray","options","reduce","acc","option","index","votes","status","fallbackError","NextResponse","json","sanitizedPolls","poll_id","created_at","Date","toISOString","success","count","message","supabase","user","getUser","userProfile","single","is_active","body","votingMethod","description","category","privacyLevel","allowMultipleVotes","showResults","allowComments","endTime","hashtags","primaryHashtag","sanitizedOptions","filter","trim","slice","pollError","insert","voting_method","privacy_level","created_by","participation","end_time","primary_hashtag","poll_settings","details","sanitizedPoll"],"mappings":"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"}