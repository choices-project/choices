{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/lib/civics/privacy-utils.spec.ts"],"sourcesContent":["import { describe, test, expect, beforeEach, afterAll, jest } from '@jest/globals';\nimport crypto from 'crypto';\n\n// Mock the env-guard to prevent it from running at module load time\njest.mock('@/features/civics/lib/civics/env-guard', () => ({\n  assertPepperConfig: jest.fn()\n}));\n\n// The privacy-utils module is mocked globally in jest.setup.after.js\n// We need to unmock it for this specific test to test the real functions\njest.unmock('@/features/civics/lib/civics/privacy-utils');\n\ndescribe('pepper rotation verify', () => {\n  const OLD_ENV = process.env;\n  beforeEach(() => { \n    jest.resetModules(); \n    // Set up default environment for tests\n    process.env.PRIVACY_PEPPER_DEV = 'dev-pepper-consistent-for-testing-12345678901234567890';\n    process.env.PRIVACY_PEPPER_CURRENT = `hex:${  'ab'.repeat(32)}`;\n    Object.defineProperty(process.env, 'NODE_ENV', { value: 'test', writable: true });\n  });\n  afterAll(() => { process.env = OLD_ENV; });\n\n  test('CURRENT issues; CURRENT/PREVIOUS verify', async () => {\n    // Set NODE_ENV to production to test CURRENT/PREVIOUS pepper functionality\n    Object.defineProperty(process.env, 'NODE_ENV', { value: 'production', writable: true });\n    // Clear any existing dev pepper\n    delete process.env.PRIVACY_PEPPER_DEV;\n    process.env.PRIVACY_PEPPER_CURRENT = `hex:${  'ab'.repeat(32)}`;\n    process.env.PRIVACY_PEPPER_PREVIOUS = `hex:${  'cd'.repeat(32)}`;\n    \n    // Ensure the environment is properly set\n    expect(process.env.PRIVACY_PEPPER_DEV).toBeUndefined();\n    expect(process.env.PRIVACY_PEPPER_CURRENT).toBeDefined();\n    expect(process.env.PRIVACY_PEPPER_PREVIOUS).toBeDefined();\n\n    const { hmac256, verifyHmacDigest } = await import('@/features/civics/lib/civics/privacy-utils');\n    const msg = '123 any st, springfield il';\n    const { hex } = hmac256(msg, 'addr');\n    expect(verifyHmacDigest(msg, 'addr', hex)).toBe(true);\n\n    // Verify a digest produced with PREVIOUS still validates\n    const prev = crypto.createHmac('sha256', Buffer.concat([Buffer.from('cd'.repeat(32), 'hex'), Buffer.from(':addr')]))\n      .update(msg).digest('hex');\n    expect(verifyHmacDigest(msg, 'addr', prev)).toBe(true);\n  });\n\n  test('dev environment uses PRIVACY_PEPPER_DEV', async () => {\n    Object.defineProperty(process.env, 'NODE_ENV', { value: 'development', writable: true });\n    process.env.PRIVACY_PEPPER_DEV = 'dev-pepper-consistent-for-testing-12345678901234567890';\n    \n    const { hmac256, verifyHmacDigest } = await import('@/features/civics/lib/civics/privacy-utils');\n    const msg = '123 any st, springfield il';\n    const { hex, used } = hmac256(msg, 'addr');\n    \n    expect(used).toBe('DEV');\n    expect(verifyHmacDigest(msg, 'addr', hex)).toBe(true);\n  });\n\n  test('production environment requires PRIVACY_PEPPER_CURRENT', async () => {\n    Object.defineProperty(process.env, 'NODE_ENV', { value: 'production', writable: true });\n    delete process.env.PRIVACY_PEPPER_CURRENT;\n    delete process.env.PRIVACY_PEPPER_PREVIOUS;\n    delete process.env.PRIVACY_PEPPER_DEV;\n    \n    // Ensure environment is completely clean\n    expect(process.env.PRIVACY_PEPPER_DEV).toBeUndefined();\n    expect(process.env.PRIVACY_PEPPER_CURRENT).toBeUndefined();\n    expect(process.env.PRIVACY_PEPPER_PREVIOUS).toBeUndefined();\n    \n    await expect(async () => {\n      // This will throw when a function is called due to lazy loading\n      jest.resetModules();\n      const utils = await import('@/features/civics/lib/civics/privacy-utils');\n      utils.hmac256('test', 'addr');\n    }).rejects.toThrow('PRIVACY_PEPPER_CURRENT must be base64:/hex: prefixed');\n  });\n\n  test('production forbids PRIVACY_PEPPER_DEV', async () => {\n    // Set up production environment\n    const originalNodeEnv = process.env.NODE_ENV;\n    const originalDevPepper = process.env.PRIVACY_PEPPER_DEV;\n    const originalCurrentPepper = process.env.PRIVACY_PEPPER_CURRENT;\n    \n    try {\n      // Mock the environment variables properly for testing\n      const _originalEnv = process.env.NODE_ENV;\n      Object.defineProperty(process.env, 'NODE_ENV', {\n        value: 'production',\n        writable: true,\n        configurable: true\n      });\n      process.env.PRIVACY_PEPPER_DEV = 'dev-pepper';\n      process.env.PRIVACY_PEPPER_CURRENT = `hex:${  'ab'.repeat(32)}`;\n      \n      await expect(async () => {\n        jest.resetModules();\n        // Unmock env-guard to test the real function\n        jest.unmock('@/features/civics/lib/civics/env-guard');\n        const utils = await import('@/features/civics/lib/civics/privacy-utils');\n        utils.hmac256('test', 'addr');\n      }).rejects.toThrow('PRIVACY_PEPPER_DEV must NOT be set in preview/prod');\n    } finally {\n      // Restore original environment\n      Object.defineProperty(process.env, 'NODE_ENV', {\n        value: originalNodeEnv,\n        writable: true,\n        configurable: true\n      });\n      if (originalDevPepper !== undefined) {\n        process.env.PRIVACY_PEPPER_DEV = originalDevPepper;\n      } else {\n        delete process.env.PRIVACY_PEPPER_DEV;\n      }\n      if (originalCurrentPepper !== undefined) {\n        process.env.PRIVACY_PEPPER_CURRENT = originalCurrentPepper;\n      } else {\n        delete process.env.PRIVACY_PEPPER_CURRENT;\n      }\n    }\n  });\n\n  test('domain separation works correctly', async () => {\n    process.env.PRIVACY_PEPPER_CURRENT = `hex:${  'ab'.repeat(32)}`;\n    \n    const utils = await import('@/features/civics/lib/civics/privacy-utils');\n    const msg = 'test message';\n    \n    const addrHash = utils.hmac256(msg, 'addr');\n    const placeHash = utils.hmac256(msg, 'place');\n    const ipHash = utils.hmac256(msg, 'ip');\n    \n    // Different scopes should produce different hashes\n    expect(addrHash.hex).not.toBe(placeHash.hex);\n    expect(placeHash.hex).not.toBe(ipHash.hex);\n    expect(ipHash.hex).not.toBe(addrHash.hex);\n    \n    // But each should verify correctly\n    expect(utils.verifyHmacDigest(msg, 'addr', addrHash.hex)).toBe(true);\n    expect(utils.verifyHmacDigest(msg, 'place', placeHash.hex)).toBe(true);\n    expect(utils.verifyHmacDigest(msg, 'ip', ipHash.hex)).toBe(true);\n  });\n\n  test('address normalization works correctly', async () => {\n    const utils = await import('@/features/civics/lib/civics/privacy-utils');\n    \n    const testCases = [\n      { input: '123 Main St.', expected: '123 main st' },\n      { input: '456 OAK   AVENUE', expected: '456 oak ave' },\n      { input: '789 Pine Road', expected: '789 pine rd' },\n      { input: '  101  BOULEVARD  ', expected: '101 blvd' }\n    ];\n    \n    testCases.forEach(({ input, expected }) => {\n      expect(utils.normalizeAddress(input)).toBe(expected);\n    });\n  });\n\n  test('geohash with jitter is deterministic per request', async () => {\n    const utils = await import('@/features/civics/lib/civics/privacy-utils');\n    \n    const lat = 40.7128;\n    const lng = -74.0060;\n    const precision = 5;\n    const requestId = 'test-request-123';\n    \n    // Same request ID should produce same jittered geohash\n    const hash1 = utils.geohashWithJitter(lat, lng, precision, requestId);\n    const hash2 = utils.geohashWithJitter(lat, lng, precision, requestId);\n    expect(hash1).toBe(hash2);\n    \n    // Different request ID should produce different jittered geohash\n    const hash3 = utils.geohashWithJitter(lat, lng, precision, 'different-request');\n    expect(hash1).not.toBe(hash3);\n  });\n\n  test('k-anonymity check works correctly', async () => {\n    const utils = await import('@/features/civics/lib/civics/privacy-utils');\n    \n    expect(utils.bucketIsKAnonymous(24, 25)).toBe(false);\n    expect(utils.bucketIsKAnonymous(25, 25)).toBe(true);\n    expect(utils.bucketIsKAnonymous(100, 25)).toBe(true);\n    \n    // Test default k=25\n    expect(utils.bucketIsKAnonymous(24)).toBe(false);\n    expect(utils.bucketIsKAnonymous(25)).toBe(true);\n  });\n});"],"names":["jest","mock","assertPepperConfig","fn","unmock","describe","OLD_ENV","process","env","beforeEach","resetModules","PRIVACY_PEPPER_DEV","PRIVACY_PEPPER_CURRENT","repeat","Object","defineProperty","value","writable","afterAll","test","PRIVACY_PEPPER_PREVIOUS","expect","toBeUndefined","toBeDefined","hmac256","verifyHmacDigest","msg","hex","toBe","prev","crypto","createHmac","Buffer","concat","from","update","digest","used","utils","rejects","toThrow","originalNodeEnv","NODE_ENV","originalDevPepper","originalCurrentPepper","_originalEnv","configurable","undefined","addrHash","placeHash","ipHash","not","testCases","input","expected","forEach","normalizeAddress","lat","lng","precision","requestId","hash1","geohashWithJitter","hash2","hash3","bucketIsKAnonymous"],"mappings":";;;;yBAAmE;+DAChD;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEnB,oEAAoE;AACpEA,aAAI,CAACC,IAAI,CAAC,0CAA0C,IAAO,CAAA;QACzDC,oBAAoBF,aAAI,CAACG,EAAE;IAC7B,CAAA;AAEA,qEAAqE;AACrE,yEAAyE;AACzEH,aAAI,CAACI,MAAM,CAAC;AAEZC,IAAAA,iBAAQ,EAAC,0BAA0B;IACjC,MAAMC,UAAUC,QAAQC,GAAG;IAC3BC,IAAAA,mBAAU,EAAC;QACTT,aAAI,CAACU,YAAY;QACjB,uCAAuC;QACvCH,QAAQC,GAAG,CAACG,kBAAkB,GAAG;QACjCJ,QAAQC,GAAG,CAACI,sBAAsB,GAAG,CAAC,IAAI,EAAI,KAAKC,MAAM,CAAC,IAAI,CAAC;QAC/DC,OAAOC,cAAc,CAACR,QAAQC,GAAG,EAAE,YAAY;YAAEQ,OAAO;YAAQC,UAAU;QAAK;IACjF;IACAC,IAAAA,iBAAQ,EAAC;QAAQX,QAAQC,GAAG,GAAGF;IAAS;IAExCa,IAAAA,aAAI,EAAC,2CAA2C;QAC9C,2EAA2E;QAC3EL,OAAOC,cAAc,CAACR,QAAQC,GAAG,EAAE,YAAY;YAAEQ,OAAO;YAAcC,UAAU;QAAK;QACrF,gCAAgC;QAChC,OAAOV,QAAQC,GAAG,CAACG,kBAAkB;QACrCJ,QAAQC,GAAG,CAACI,sBAAsB,GAAG,CAAC,IAAI,EAAI,KAAKC,MAAM,CAAC,IAAI,CAAC;QAC/DN,QAAQC,GAAG,CAACY,uBAAuB,GAAG,CAAC,IAAI,EAAI,KAAKP,MAAM,CAAC,IAAI,CAAC;QAEhE,yCAAyC;QACzCQ,IAAAA,eAAM,EAACd,QAAQC,GAAG,CAACG,kBAAkB,EAAEW,aAAa;QACpDD,IAAAA,eAAM,EAACd,QAAQC,GAAG,CAACI,sBAAsB,EAAEW,WAAW;QACtDF,IAAAA,eAAM,EAACd,QAAQC,GAAG,CAACY,uBAAuB,EAAEG,WAAW;QAEvD,MAAM,EAAEC,OAAO,EAAEC,gBAAgB,EAAE,GAAG,MAAM,mEAAA,QAAO;QACnD,MAAMC,MAAM;QACZ,MAAM,EAAEC,GAAG,EAAE,GAAGH,QAAQE,KAAK;QAC7BL,IAAAA,eAAM,EAACI,iBAAiBC,KAAK,QAAQC,MAAMC,IAAI,CAAC;QAEhD,yDAAyD;QACzD,MAAMC,OAAOC,eAAM,CAACC,UAAU,CAAC,UAAUC,OAAOC,MAAM,CAAC;YAACD,OAAOE,IAAI,CAAC,KAAKrB,MAAM,CAAC,KAAK;YAAQmB,OAAOE,IAAI,CAAC;SAAS,GAC/GC,MAAM,CAACT,KAAKU,MAAM,CAAC;QACtBf,IAAAA,eAAM,EAACI,iBAAiBC,KAAK,QAAQG,OAAOD,IAAI,CAAC;IACnD;IAEAT,IAAAA,aAAI,EAAC,2CAA2C;QAC9CL,OAAOC,cAAc,CAACR,QAAQC,GAAG,EAAE,YAAY;YAAEQ,OAAO;YAAeC,UAAU;QAAK;QACtFV,QAAQC,GAAG,CAACG,kBAAkB,GAAG;QAEjC,MAAM,EAAEa,OAAO,EAAEC,gBAAgB,EAAE,GAAG,MAAM,mEAAA,QAAO;QACnD,MAAMC,MAAM;QACZ,MAAM,EAAEC,GAAG,EAAEU,IAAI,EAAE,GAAGb,QAAQE,KAAK;QAEnCL,IAAAA,eAAM,EAACgB,MAAMT,IAAI,CAAC;QAClBP,IAAAA,eAAM,EAACI,iBAAiBC,KAAK,QAAQC,MAAMC,IAAI,CAAC;IAClD;IAEAT,IAAAA,aAAI,EAAC,0DAA0D;QAC7DL,OAAOC,cAAc,CAACR,QAAQC,GAAG,EAAE,YAAY;YAAEQ,OAAO;YAAcC,UAAU;QAAK;QACrF,OAAOV,QAAQC,GAAG,CAACI,sBAAsB;QACzC,OAAOL,QAAQC,GAAG,CAACY,uBAAuB;QAC1C,OAAOb,QAAQC,GAAG,CAACG,kBAAkB;QAErC,yCAAyC;QACzCU,IAAAA,eAAM,EAACd,QAAQC,GAAG,CAACG,kBAAkB,EAAEW,aAAa;QACpDD,IAAAA,eAAM,EAACd,QAAQC,GAAG,CAACI,sBAAsB,EAAEU,aAAa;QACxDD,IAAAA,eAAM,EAACd,QAAQC,GAAG,CAACY,uBAAuB,EAAEE,aAAa;QAEzD,MAAMD,IAAAA,eAAM,EAAC;YACX,gEAAgE;YAChErB,aAAI,CAACU,YAAY;YACjB,MAAM4B,QAAQ,MAAM,mEAAA,QAAO;YAC3BA,MAAMd,OAAO,CAAC,QAAQ;QACxB,GAAGe,OAAO,CAACC,OAAO,CAAC;IACrB;IAEArB,IAAAA,aAAI,EAAC,yCAAyC;QAC5C,gCAAgC;QAChC,MAAMsB,kBAAkBlC,QAAQC,GAAG,CAACkC,QAAQ;QAC5C,MAAMC,oBAAoBpC,QAAQC,GAAG,CAACG,kBAAkB;QACxD,MAAMiC,wBAAwBrC,QAAQC,GAAG,CAACI,sBAAsB;QAEhE,IAAI;YACF,sDAAsD;YACtD,MAAMiC,eAAetC,QAAQC,GAAG,CAACkC,QAAQ;YACzC5B,OAAOC,cAAc,CAACR,QAAQC,GAAG,EAAE,YAAY;gBAC7CQ,OAAO;gBACPC,UAAU;gBACV6B,cAAc;YAChB;YACAvC,QAAQC,GAAG,CAACG,kBAAkB,GAAG;YACjCJ,QAAQC,GAAG,CAACI,sBAAsB,GAAG,CAAC,IAAI,EAAI,KAAKC,MAAM,CAAC,IAAI,CAAC;YAE/D,MAAMQ,IAAAA,eAAM,EAAC;gBACXrB,aAAI,CAACU,YAAY;gBACjB,6CAA6C;gBAC7CV,aAAI,CAACI,MAAM,CAAC;gBACZ,MAAMkC,QAAQ,MAAM,mEAAA,QAAO;gBAC3BA,MAAMd,OAAO,CAAC,QAAQ;YACxB,GAAGe,OAAO,CAACC,OAAO,CAAC;QACrB,SAAU;YACR,+BAA+B;YAC/B1B,OAAOC,cAAc,CAACR,QAAQC,GAAG,EAAE,YAAY;gBAC7CQ,OAAOyB;gBACPxB,UAAU;gBACV6B,cAAc;YAChB;YACA,IAAIH,sBAAsBI,WAAW;gBACnCxC,QAAQC,GAAG,CAACG,kBAAkB,GAAGgC;YACnC,OAAO;gBACL,OAAOpC,QAAQC,GAAG,CAACG,kBAAkB;YACvC;YACA,IAAIiC,0BAA0BG,WAAW;gBACvCxC,QAAQC,GAAG,CAACI,sBAAsB,GAAGgC;YACvC,OAAO;gBACL,OAAOrC,QAAQC,GAAG,CAACI,sBAAsB;YAC3C;QACF;IACF;IAEAO,IAAAA,aAAI,EAAC,qCAAqC;QACxCZ,QAAQC,GAAG,CAACI,sBAAsB,GAAG,CAAC,IAAI,EAAI,KAAKC,MAAM,CAAC,IAAI,CAAC;QAE/D,MAAMyB,QAAQ,MAAM,mEAAA,QAAO;QAC3B,MAAMZ,MAAM;QAEZ,MAAMsB,WAAWV,MAAMd,OAAO,CAACE,KAAK;QACpC,MAAMuB,YAAYX,MAAMd,OAAO,CAACE,KAAK;QACrC,MAAMwB,SAASZ,MAAMd,OAAO,CAACE,KAAK;QAElC,mDAAmD;QACnDL,IAAAA,eAAM,EAAC2B,SAASrB,GAAG,EAAEwB,GAAG,CAACvB,IAAI,CAACqB,UAAUtB,GAAG;QAC3CN,IAAAA,eAAM,EAAC4B,UAAUtB,GAAG,EAAEwB,GAAG,CAACvB,IAAI,CAACsB,OAAOvB,GAAG;QACzCN,IAAAA,eAAM,EAAC6B,OAAOvB,GAAG,EAAEwB,GAAG,CAACvB,IAAI,CAACoB,SAASrB,GAAG;QAExC,mCAAmC;QACnCN,IAAAA,eAAM,EAACiB,MAAMb,gBAAgB,CAACC,KAAK,QAAQsB,SAASrB,GAAG,GAAGC,IAAI,CAAC;QAC/DP,IAAAA,eAAM,EAACiB,MAAMb,gBAAgB,CAACC,KAAK,SAASuB,UAAUtB,GAAG,GAAGC,IAAI,CAAC;QACjEP,IAAAA,eAAM,EAACiB,MAAMb,gBAAgB,CAACC,KAAK,MAAMwB,OAAOvB,GAAG,GAAGC,IAAI,CAAC;IAC7D;IAEAT,IAAAA,aAAI,EAAC,yCAAyC;QAC5C,MAAMmB,QAAQ,MAAM,mEAAA,QAAO;QAE3B,MAAMc,YAAY;YAChB;gBAAEC,OAAO;gBAAgBC,UAAU;YAAc;YACjD;gBAAED,OAAO;gBAAoBC,UAAU;YAAc;YACrD;gBAAED,OAAO;gBAAiBC,UAAU;YAAc;YAClD;gBAAED,OAAO;gBAAsBC,UAAU;YAAW;SACrD;QAEDF,UAAUG,OAAO,CAAC,CAAC,EAAEF,KAAK,EAAEC,QAAQ,EAAE;YACpCjC,IAAAA,eAAM,EAACiB,MAAMkB,gBAAgB,CAACH,QAAQzB,IAAI,CAAC0B;QAC7C;IACF;IAEAnC,IAAAA,aAAI,EAAC,oDAAoD;QACvD,MAAMmB,QAAQ,MAAM,mEAAA,QAAO;QAE3B,MAAMmB,MAAM;QACZ,MAAMC,MAAM,CAAC;QACb,MAAMC,YAAY;QAClB,MAAMC,YAAY;QAElB,uDAAuD;QACvD,MAAMC,QAAQvB,MAAMwB,iBAAiB,CAACL,KAAKC,KAAKC,WAAWC;QAC3D,MAAMG,QAAQzB,MAAMwB,iBAAiB,CAACL,KAAKC,KAAKC,WAAWC;QAC3DvC,IAAAA,eAAM,EAACwC,OAAOjC,IAAI,CAACmC;QAEnB,iEAAiE;QACjE,MAAMC,QAAQ1B,MAAMwB,iBAAiB,CAACL,KAAKC,KAAKC,WAAW;QAC3DtC,IAAAA,eAAM,EAACwC,OAAOV,GAAG,CAACvB,IAAI,CAACoC;IACzB;IAEA7C,IAAAA,aAAI,EAAC,qCAAqC;QACxC,MAAMmB,QAAQ,MAAM,mEAAA,QAAO;QAE3BjB,IAAAA,eAAM,EAACiB,MAAM2B,kBAAkB,CAAC,IAAI,KAAKrC,IAAI,CAAC;QAC9CP,IAAAA,eAAM,EAACiB,MAAM2B,kBAAkB,CAAC,IAAI,KAAKrC,IAAI,CAAC;QAC9CP,IAAAA,eAAM,EAACiB,MAAM2B,kBAAkB,CAAC,KAAK,KAAKrC,IAAI,CAAC;QAE/C,oBAAoB;QACpBP,IAAAA,eAAM,EAACiB,MAAM2B,kBAAkB,CAAC,KAAKrC,IAAI,CAAC;QAC1CP,IAAAA,eAAM,EAACiB,MAAM2B,kBAAkB,CAAC,KAAKrC,IAAI,CAAC;IAC5C;AACF"}