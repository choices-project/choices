{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/features/civics/lib/civics/privacy-utils.ts"],"sourcesContent":["/**\n * Privacy utilities for civics address lookup system\n * Feature Flag: CIVICS_ADDRESS_LOOKUP (disabled by default)\n */\n\nimport crypto from 'crypto';\n\nimport { cookies } from 'next/headers';\n\nimport { isFeatureEnabled } from '@/lib/core/feature-flags';\n\nimport { assertPepperConfig } from './env-guard';\n\ntype Scope = 'addr' | 'place' | 'ip';\ninterface EncodedPepper { raw: Buffer; source: 'DEV' | 'CURRENT' | 'PREVIOUS' }\n\nfunction decodePepper(v: string): Buffer {\n  const s = v.trim();\n  if (s.startsWith('base64:')) return Buffer.from(s.slice(7), 'base64');\n  if (s.startsWith('hex:')) return Buffer.from(s.slice(4), 'hex');\n  return Buffer.from(s, 'utf8');\n}\n\nfunction loadPeppers(): EncodedPepper[] {\n  const env = process.env.NODE_ENV;\n  const isDev = env === 'development' || env === 'test';\n\n  if (isDev) {\n    const dv = process.env.PRIVACY_PEPPER_DEV;\n    if (!dv) throw new Error('PRIVACY_PEPPER_DEV required in development/test');\n    return [{ raw: decodePepper(dv), source: 'DEV' }];\n  }\n  if (!process.env.PRIVACY_PEPPER_CURRENT) throw new Error('PRIVACY_PEPPER_CURRENT required');\n  const peppers: EncodedPepper[] = [\n    { raw: decodePepper(process.env.PRIVACY_PEPPER_CURRENT), source: 'CURRENT' },\n  ];\n  if (process.env.PRIVACY_PEPPER_PREVIOUS) {\n    peppers.push({ raw: decodePepper(process.env.PRIVACY_PEPPER_PREVIOUS), source: 'PREVIOUS' });\n  }\n  peppers.forEach(p => {\n    if (p.source !== 'DEV' && p.raw.length < 32) {\n      throw new Error(`${p.source} pepper must be ≥32 bytes`);\n    }\n  });\n  return peppers;\n}\n\n// Lazy-load peppers to avoid crashes during test imports\nlet PEPPERS: EncodedPepper[] | null = null;\n\nfunction getPeppers(): EncodedPepper[] {\n  if (PEPPERS === null) {\n    assertPepperConfig();\n    PEPPERS = loadPeppers();\n  }\n  return PEPPERS;\n}\n\nfunction hmacRaw(data: string, scope: Scope, pepper: Buffer): Buffer {\n  const h = crypto.createHmac('sha256', Buffer.concat([pepper, Buffer.from(`:${scope}`)]));\n  h.update(data);\n  return h.digest();\n}\n\nexport function hmac256(data: string, scope: Scope): { hex: string; used: EncodedPepper['source'] } {\n  // Issue with CURRENT (or DEV)\n  const peppers = getPeppers();\n  const first = peppers[0];\n  if (!first) throw new Error('No peppers configured');\n  const digest = hmacRaw(data, scope, first.raw).toString('hex');\n  return { hex: digest, used: first.source };\n}\n\nexport function verifyHmacDigest(plain: string, scope: Scope, presentedHex: string): boolean {\n  const presented = Buffer.from(presentedHex, 'hex');\n  const peppers = getPeppers();\n  for (const p of peppers) {\n    const cand = hmacRaw(plain, scope, p.raw);\n    if (presented.length === cand.length && crypto.timingSafeEqual(presented, cand)) {\n      return true;\n    }\n  }\n  return false;\n}\n\nexport const normalizeAddress = (a: string) =>\n  a.trim().toLowerCase()\n    .replace(/\\./g, '')\n    .replace(/\\s+/g, ' ')\n    .replace(/\\b(street|st|road|rd|avenue|ave|boulevard|blvd)\\b/g, m =>\n      ({ street: 'st', st: 'st', road: 'rd', rd: 'rd', avenue: 'ave', ave: 'ave', boulevard: 'blvd', blvd: 'blvd' } as any)[m]\n    );\n\nexport const generateAddressHMAC = (address: string) => hmac256(normalizeAddress(address), 'addr').hex;\nexport const generatePlaceIdHMAC = (placeId: string) => hmac256(placeId, 'place').hex;\nexport const generateIPHMAC = (ip: string) => hmac256(ip, 'ip').hex;\n\n// --- Geoprivacy helpers ---\nfunction simpleGeohash(lat: number, lng: number, precision: 5 | 6 | 7): string {\n  // Production-ready geohash implementation\n  // Uses proper geohash algorithm for privacy-preserving location hashing\n  const latRange = [-90, 90];\n  const lngRange = [-180, 180];\n  \n  let latMin: number = latRange[0] ?? -90;\n  let latMax: number = latRange[1] ?? 90;\n  let lngMin: number = lngRange[0] ?? -180;\n  let lngMax: number = lngRange[1] ?? 180;\n  \n  let bits = 0;\n  let bit = 0;\n  let ch = 0;\n  let even = true;\n  \n  const base32 = '0123456789bcdefghjkmnpqrstuvwxyz';\n  let result = '';\n  \n  while (bits < precision * 5) {\n    if (even) {\n      const lngMid = (lngMin + lngMax) / 2;\n      if (lng >= lngMid) {\n        ch |= (1 << (4 - bit));\n        lngMin = lngMid;\n      } else {\n        lngMax = lngMid;\n      }\n    } else {\n      const latMid = (latMin + latMax) / 2;\n      if (lat >= latMid) {\n        ch |= (1 << (4 - bit));\n        latMin = latMid;\n      } else {\n        latMax = latMid;\n      }\n    }\n    \n    even = !even;\n    if (bit < 4) {\n      bit++;\n    } else {\n      result += base32[ch];\n      bits++;\n      bit = 0;\n      ch = 0;\n    }\n  }\n  \n  return result;\n}\n\nexport function geohashWithJitter(\n  lat: number, \n  lng: number, \n  precision: 5 | 6 | 7,\n  requestId: string\n): string {\n  const seed = crypto.createHash('sha256').update(requestId).digest();\n  const j = ((seed[0] || 0) - 128) / 12800; // ≈ ±1% deterministic jitter per request\n  return simpleGeohash(lat + j, lng + j, precision);\n}\n\nexport const bucketIsKAnonymous = (bucketCount: number, k = 25) => bucketCount >= k;\n\n// --- Cookie helpers for jurisdiction scoping ---\nconst COOKIE_NAME = 'cx_jurisdictions';\n\nexport async function setJurisdictionCookie(payload: { state?: string; district?: string; county?: string }) {\n  // Minimal sealed cookie using a signed value. Replace with iron-session/jose if you prefer AEAD.\n  const secret = process.env.SESSION_SECRET ?? 'dev-session-secret-not-for-prod';\n  const body = JSON.stringify(Object.assign({}, payload, { v: 1, iat: Date.now() }));\n  const sig = crypto.createHmac('sha256', secret).update(body).digest('hex');\n  const value = Buffer.from(JSON.stringify({ body, sig })).toString('base64url');\n\n  cookies().set({\n    name: COOKIE_NAME,\n    value,\n    httpOnly: true,\n    sameSite: 'lax',\n    secure: true,\n    path: '/',\n    maxAge: 60 * 60 * 24 * 7\n  });\n}\n\nexport function readJurisdictionCookie(): { state?: string; district?: string; county?: string } | null {\n  const secret = process.env.SESSION_SECRET ?? 'dev-session-secret-not-for-prod';\n  const raw = cookies().get(COOKIE_NAME)?.value;\n  if (!raw) return null;\n  try {\n    const { body, sig } = JSON.parse(Buffer.from(raw, 'base64url').toString());\n    const check = crypto.createHmac('sha256', secret).update(body).digest('hex');\n    if (!crypto.timingSafeEqual(Buffer.from(sig), Buffer.from(check))) return null;\n    const parsed = JSON.parse(body);\n    return { state: parsed.state, district: parsed.district, county: parsed.county };\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Validate address input for DoS protection\n */\nexport function validateAddressInput(address: string): { valid: boolean; error?: string } {\n  if (!isFeatureEnabled('CIVICS_ADDRESS_LOOKUP')) {\n    return { valid: false, error: 'Feature disabled' };\n  }\n  \n  if (!address || typeof address !== 'string') {\n    return { valid: false, error: 'Address is required' };\n  }\n  \n  if (address.length > 500) {\n    return { valid: false, error: 'Address too long' };\n  }\n  \n  if (address.length < 5) {\n    return { valid: false, error: 'Address too short' };\n  }\n  \n  // Basic character validation (allow letters, numbers, spaces, common punctuation)\n  if (!/^[a-zA-Z0-9\\s\\.,\\-#]+$/.test(address)) {\n    return { valid: false, error: 'Invalid characters in address' };\n  }\n  \n  return { valid: true };\n}\n\n/**\n * Check if civics feature is enabled\n */\nexport function isCivicsEnabled(): boolean {\n  return isFeatureEnabled('CIVICS_ADDRESS_LOOKUP');\n}\n\n/**\n * Privacy-safe request ID generator\n */\nexport function generateRequestId(): string {\n  if (!isFeatureEnabled('CIVICS_ADDRESS_LOOKUP')) {\n    throw new Error('Civics address lookup feature is disabled');\n  }\n  \n  return crypto.randomUUID();\n}\n"],"names":["bucketIsKAnonymous","generateAddressHMAC","generateIPHMAC","generatePlaceIdHMAC","generateRequestId","geohashWithJitter","hmac256","isCivicsEnabled","normalizeAddress","readJurisdictionCookie","setJurisdictionCookie","validateAddressInput","verifyHmacDigest","decodePepper","v","s","trim","startsWith","Buffer","from","slice","loadPeppers","env","process","NODE_ENV","isDev","dv","PRIVACY_PEPPER_DEV","Error","raw","source","PRIVACY_PEPPER_CURRENT","peppers","PRIVACY_PEPPER_PREVIOUS","push","forEach","p","length","PEPPERS","getPeppers","assertPepperConfig","hmacRaw","data","scope","pepper","h","crypto","createHmac","concat","update","digest","first","toString","hex","used","plain","presentedHex","presented","cand","timingSafeEqual","a","toLowerCase","replace","m","street","st","road","rd","avenue","ave","boulevard","blvd","address","placeId","ip","simpleGeohash","lat","lng","precision","latRange","lngRange","latMin","latMax","lngMin","lngMax","bits","bit","ch","even","base32","result","lngMid","latMid","requestId","seed","createHash","j","bucketCount","k","COOKIE_NAME","payload","secret","SESSION_SECRET","body","JSON","stringify","Object","assign","iat","Date","now","sig","value","cookies","set","name","httpOnly","sameSite","secure","path","maxAge","get","parse","check","parsed","state","district","county","isFeatureEnabled","valid","error","test","randomUUID"],"mappings":"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"}