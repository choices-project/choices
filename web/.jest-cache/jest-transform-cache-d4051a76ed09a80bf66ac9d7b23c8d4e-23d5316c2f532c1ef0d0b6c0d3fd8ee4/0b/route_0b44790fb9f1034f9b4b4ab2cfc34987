e1c95b18663a954c5e0b27ee42a03275
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "POST", {
    enumerable: true,
    get: function() {
        return POST;
    }
});
const _server = require("next/server");
const _ratelimit = require("../../../../lib/core/security/rate-limit");
const _logger = require("../../../../lib/utils/logger");
const _server1 = require("../../../../utils/supabase/server");
const _shared = require("../_shared");
async function POST(request) {
    try {
        // Always validate CSRF protection for state-changing operation
        if (!(0, _shared.validateCsrfProtection)(request)) {
            return (0, _shared.createCsrfErrorResponse)();
        }
        // Rate limiting: 10 login attempts per 15 minutes per IP
        const rateLimitResult = await _ratelimit.rateLimiters.auth.check(request);
        if (!rateLimitResult.allowed) {
            return _server.NextResponse.json({
                message: "Too many login attempts. Please try again later."
            }, {
                status: 429
            });
        }
        // Validate request
        const body = await request.json();
        const { email, password } = body;
        // Validate required fields
        if (!email || !password) {
            return _server.NextResponse.json({
                message: "Email and password are required"
            }, {
                status: 400
            });
        }
        // Use Supabase Auth for authentication
        const supabaseClient = await (0, _server1.getSupabaseServerClient)();
        // E2E tests should use real Supabase authentication - no mock responses
        // Sign in with Supabase Auth
        const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
            email: email.toLowerCase().trim(),
            password
        });
        if (authError || !authData.user) {
            _logger.logger.warn("Login failed", {
                email,
                error: authError?.message
            });
            return _server.NextResponse.json({
                message: "Invalid email or password"
            }, {
                status: 401
            });
        }
        // Get user profile for additional data
        const { data: profile, error: profileError } = await supabaseClient.from("user_profiles").select("username, trust_tier, display_name, avatar_url, bio, is_active").eq("user_id", authData.user.id).single();
        if (profileError || !profile) {
            _logger.logger.warn("User profile not found after login", {
                userId: authData.user.id
            });
            return _server.NextResponse.json({
                message: "User profile not found"
            }, {
                status: 404
            });
        }
        // Check if user is active
        if (!profile.is_active) {
            _logger.logger.warn("Inactive user attempted login", {
                userId: authData.user.id
            });
            return _server.NextResponse.json({
                message: "Account is deactivated"
            }, {
                status: 403
            });
        }
        _logger.logger.info("User logged in successfully", {
            userId: authData.user.id,
            email: authData.user.email,
            username: profile.username
        });
        return _server.NextResponse.json({
            success: true,
            user: {
                id: authData.user.id,
                email: authData.user.email,
                username: profile.username,
                trust_tier: profile.trust_tier,
                display_name: profile.display_name,
                avatar_url: profile.avatar_url,
                bio: profile.bio,
                is_active: profile.is_active
            },
            session: authData.session,
            token: authData.session?.access_token
        });
    } catch (error) {
        _logger.logger.error("Login error", error instanceof Error ? error : new Error(String(error)));
        return _server.NextResponse.json({
            message: "Internal server error"
        }, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9hcHAvYXBpL2F1dGgvbG9naW4vcm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOZXh0UmVxdWVzdH0gZnJvbSAnbmV4dC9zZXJ2ZXInO1xuaW1wb3J0IHsgTmV4dFJlc3BvbnNlIH0gZnJvbSAnbmV4dC9zZXJ2ZXInXG5cbmltcG9ydCB7IHJhdGVMaW1pdGVycyB9IGZyb20gJ0AvbGliL2NvcmUvc2VjdXJpdHkvcmF0ZS1saW1pdCdcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ0AvbGliL3V0aWxzL2xvZ2dlcidcbmltcG9ydCB7IGdldFN1cGFiYXNlU2VydmVyQ2xpZW50IH0gZnJvbSAnQC91dGlscy9zdXBhYmFzZS9zZXJ2ZXInXG5cbmltcG9ydCB7IFxuICB2YWxpZGF0ZUNzcmZQcm90ZWN0aW9uLCBcbiAgY3JlYXRlQ3NyZkVycm9yUmVzcG9uc2UgXG59IGZyb20gJy4uL19zaGFyZWQnXG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIFBPU1QocmVxdWVzdDogTmV4dFJlcXVlc3QpIHtcbiAgdHJ5IHtcbiAgICAvLyBBbHdheXMgdmFsaWRhdGUgQ1NSRiBwcm90ZWN0aW9uIGZvciBzdGF0ZS1jaGFuZ2luZyBvcGVyYXRpb25cbiAgICBpZiAoIXZhbGlkYXRlQ3NyZlByb3RlY3Rpb24ocmVxdWVzdCkpIHtcbiAgICAgIHJldHVybiBjcmVhdGVDc3JmRXJyb3JSZXNwb25zZSgpXG4gICAgfVxuXG4gICAgLy8gUmF0ZSBsaW1pdGluZzogMTAgbG9naW4gYXR0ZW1wdHMgcGVyIDE1IG1pbnV0ZXMgcGVyIElQXG4gICAgY29uc3QgcmF0ZUxpbWl0UmVzdWx0ID0gYXdhaXQgcmF0ZUxpbWl0ZXJzLmF1dGguY2hlY2socmVxdWVzdClcbiAgICBcbiAgICBpZiAoIXJhdGVMaW1pdFJlc3VsdC5hbGxvd2VkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgbWVzc2FnZTogJ1RvbyBtYW55IGxvZ2luIGF0dGVtcHRzLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQyOSB9XG4gICAgICApXG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgcmVxdWVzdFxuICAgIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0Lmpzb24oKVxuICAgIGNvbnN0IHsgZW1haWwsIHBhc3N3b3JkIH0gPSBib2R5XG5cbiAgICAvLyBWYWxpZGF0ZSByZXF1aXJlZCBmaWVsZHNcbiAgICBpZiAoIWVtYWlsIHx8ICFwYXNzd29yZCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG1lc3NhZ2U6ICdFbWFpbCBhbmQgcGFzc3dvcmQgYXJlIHJlcXVpcmVkJyB9LFxuICAgICAgICB7IHN0YXR1czogNDAwIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICAvLyBVc2UgU3VwYWJhc2UgQXV0aCBmb3IgYXV0aGVudGljYXRpb25cbiAgICBjb25zdCBzdXBhYmFzZUNsaWVudCA9IGF3YWl0IGdldFN1cGFiYXNlU2VydmVyQ2xpZW50KClcblxuICAgIC8vIEUyRSB0ZXN0cyBzaG91bGQgdXNlIHJlYWwgU3VwYWJhc2UgYXV0aGVudGljYXRpb24gLSBubyBtb2NrIHJlc3BvbnNlc1xuXG4gICAgLy8gU2lnbiBpbiB3aXRoIFN1cGFiYXNlIEF1dGhcbiAgICBjb25zdCB7IGRhdGE6IGF1dGhEYXRhLCBlcnJvcjogYXV0aEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZUNsaWVudC5hdXRoLnNpZ25JbldpdGhQYXNzd29yZCh7XG4gICAgICBlbWFpbDogZW1haWwudG9Mb3dlckNhc2UoKS50cmltKCksXG4gICAgICBwYXNzd29yZFxuICAgIH0pXG5cbiAgICBpZiAoYXV0aEVycm9yIHx8ICFhdXRoRGF0YS51c2VyKSB7XG4gICAgICBsb2dnZXIud2FybignTG9naW4gZmFpbGVkJywgeyBlbWFpbCwgZXJyb3I6IGF1dGhFcnJvcj8ubWVzc2FnZSB9KVxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG1lc3NhZ2U6ICdJbnZhbGlkIGVtYWlsIG9yIHBhc3N3b3JkJyB9LFxuICAgICAgICB7IHN0YXR1czogNDAxIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICAvLyBHZXQgdXNlciBwcm9maWxlIGZvciBhZGRpdGlvbmFsIGRhdGFcbiAgICBjb25zdCB7IGRhdGE6IHByb2ZpbGUsIGVycm9yOiBwcm9maWxlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlQ2xpZW50XG4gICAgICAuZnJvbSgndXNlcl9wcm9maWxlcycpXG4gICAgICAuc2VsZWN0KCd1c2VybmFtZSwgdHJ1c3RfdGllciwgZGlzcGxheV9uYW1lLCBhdmF0YXJfdXJsLCBiaW8sIGlzX2FjdGl2ZScpXG4gICAgICAuZXEoJ3VzZXJfaWQnLCBhdXRoRGF0YS51c2VyLmlkKVxuICAgICAgLnNpbmdsZSgpXG5cbiAgICBpZiAocHJvZmlsZUVycm9yIHx8ICFwcm9maWxlKSB7XG4gICAgICBsb2dnZXIud2FybignVXNlciBwcm9maWxlIG5vdCBmb3VuZCBhZnRlciBsb2dpbicsIHsgdXNlcklkOiBhdXRoRGF0YS51c2VyLmlkIH0pXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgbWVzc2FnZTogJ1VzZXIgcHJvZmlsZSBub3QgZm91bmQnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDQgfVxuICAgICAgKVxuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYWN0aXZlXG4gICAgaWYgKCFwcm9maWxlLmlzX2FjdGl2ZSkge1xuICAgICAgbG9nZ2VyLndhcm4oJ0luYWN0aXZlIHVzZXIgYXR0ZW1wdGVkIGxvZ2luJywgeyB1c2VySWQ6IGF1dGhEYXRhLnVzZXIuaWQgfSlcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBtZXNzYWdlOiAnQWNjb3VudCBpcyBkZWFjdGl2YXRlZCcgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMyB9XG4gICAgICApXG4gICAgfVxuXG4gICAgbG9nZ2VyLmluZm8oJ1VzZXIgbG9nZ2VkIGluIHN1Y2Nlc3NmdWxseScsIHsgXG4gICAgICB1c2VySWQ6IGF1dGhEYXRhLnVzZXIuaWQsIFxuICAgICAgZW1haWw6IGF1dGhEYXRhLnVzZXIuZW1haWwsXG4gICAgICB1c2VybmFtZTogcHJvZmlsZS51c2VybmFtZSBcbiAgICB9KVxuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICB1c2VyOiB7XG4gICAgICAgIGlkOiBhdXRoRGF0YS51c2VyLmlkLFxuICAgICAgICBlbWFpbDogYXV0aERhdGEudXNlci5lbWFpbCxcbiAgICAgICAgdXNlcm5hbWU6IHByb2ZpbGUudXNlcm5hbWUsXG4gICAgICAgIHRydXN0X3RpZXI6IHByb2ZpbGUudHJ1c3RfdGllcixcbiAgICAgICAgZGlzcGxheV9uYW1lOiBwcm9maWxlLmRpc3BsYXlfbmFtZSxcbiAgICAgICAgYXZhdGFyX3VybDogcHJvZmlsZS5hdmF0YXJfdXJsLFxuICAgICAgICBiaW86IHByb2ZpbGUuYmlvLFxuICAgICAgICBpc19hY3RpdmU6IHByb2ZpbGUuaXNfYWN0aXZlXG4gICAgICB9LFxuICAgICAgc2Vzc2lvbjogYXV0aERhdGEuc2Vzc2lvbixcbiAgICAgIHRva2VuOiBhdXRoRGF0YS5zZXNzaW9uPy5hY2Nlc3NfdG9rZW5cbiAgICB9KVxuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgbG9nZ2VyLmVycm9yKCdMb2dpbiBlcnJvcicsIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKSlcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICB7IG1lc3NhZ2U6ICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InIH0sXG4gICAgICB7IHN0YXR1czogNTAwIH1cbiAgICApXG4gIH1cbn0iXSwibmFtZXMiOlsiUE9TVCIsInJlcXVlc3QiLCJ2YWxpZGF0ZUNzcmZQcm90ZWN0aW9uIiwiY3JlYXRlQ3NyZkVycm9yUmVzcG9uc2UiLCJyYXRlTGltaXRSZXN1bHQiLCJyYXRlTGltaXRlcnMiLCJhdXRoIiwiY2hlY2siLCJhbGxvd2VkIiwiTmV4dFJlc3BvbnNlIiwianNvbiIsIm1lc3NhZ2UiLCJzdGF0dXMiLCJib2R5IiwiZW1haWwiLCJwYXNzd29yZCIsInN1cGFiYXNlQ2xpZW50IiwiZ2V0U3VwYWJhc2VTZXJ2ZXJDbGllbnQiLCJkYXRhIiwiYXV0aERhdGEiLCJlcnJvciIsImF1dGhFcnJvciIsInNpZ25JbldpdGhQYXNzd29yZCIsInRvTG93ZXJDYXNlIiwidHJpbSIsInVzZXIiLCJsb2dnZXIiLCJ3YXJuIiwicHJvZmlsZSIsInByb2ZpbGVFcnJvciIsImZyb20iLCJzZWxlY3QiLCJlcSIsImlkIiwic2luZ2xlIiwidXNlcklkIiwiaXNfYWN0aXZlIiwiaW5mbyIsInVzZXJuYW1lIiwic3VjY2VzcyIsInRydXN0X3RpZXIiLCJkaXNwbGF5X25hbWUiLCJhdmF0YXJfdXJsIiwiYmlvIiwic2Vzc2lvbiIsInRva2VuIiwiYWNjZXNzX3Rva2VuIiwiRXJyb3IiLCJTdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7K0JBYXNCQTs7O2VBQUFBOzs7d0JBWk87MkJBRUE7d0JBQ047eUJBQ2lCO3dCQUtqQztBQUdBLGVBQWVBLEtBQUtDLE9BQW9CO0lBQzdDLElBQUk7UUFDRiwrREFBK0Q7UUFDL0QsSUFBSSxDQUFDQyxJQUFBQSw4QkFBc0IsRUFBQ0QsVUFBVTtZQUNwQyxPQUFPRSxJQUFBQSwrQkFBdUI7UUFDaEM7UUFFQSx5REFBeUQ7UUFDekQsTUFBTUMsa0JBQWtCLE1BQU1DLHVCQUFZLENBQUNDLElBQUksQ0FBQ0MsS0FBSyxDQUFDTjtRQUV0RCxJQUFJLENBQUNHLGdCQUFnQkksT0FBTyxFQUFFO1lBQzVCLE9BQU9DLG9CQUFZLENBQUNDLElBQUksQ0FDdEI7Z0JB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