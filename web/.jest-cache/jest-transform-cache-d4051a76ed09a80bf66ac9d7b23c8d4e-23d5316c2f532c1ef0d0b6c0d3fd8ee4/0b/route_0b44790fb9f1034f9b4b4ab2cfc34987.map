{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/app/api/auth/login/route.ts"],"sourcesContent":["import type { NextRequest} from 'next/server';\nimport { NextResponse } from 'next/server'\n\nimport { rateLimiters } from '@/lib/core/security/rate-limit'\nimport { logger } from '@/lib/utils/logger'\nimport { getSupabaseServerClient } from '@/utils/supabase/server'\n\nimport { \n  validateCsrfProtection, \n  createCsrfErrorResponse \n} from '../_shared'\n\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Always validate CSRF protection for state-changing operation\n    if (!validateCsrfProtection(request)) {\n      return createCsrfErrorResponse()\n    }\n\n    // Rate limiting: 10 login attempts per 15 minutes per IP\n    const rateLimitResult = await rateLimiters.auth.check(request)\n    \n    if (!rateLimitResult.allowed) {\n      return NextResponse.json(\n        { message: 'Too many login attempts. Please try again later.' },\n        { status: 429 }\n      )\n    }\n\n    // Validate request\n    const body = await request.json()\n    const { email, password } = body\n\n    // Validate required fields\n    if (!email || !password) {\n      return NextResponse.json(\n        { message: 'Email and password are required' },\n        { status: 400 }\n      )\n    }\n\n    // Use Supabase Auth for authentication\n    const supabaseClient = await getSupabaseServerClient()\n\n    // E2E tests should use real Supabase authentication - no mock responses\n\n    // Sign in with Supabase Auth\n    const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({\n      email: email.toLowerCase().trim(),\n      password\n    })\n\n    if (authError || !authData.user) {\n      logger.warn('Login failed', { email, error: authError?.message })\n      return NextResponse.json(\n        { message: 'Invalid email or password' },\n        { status: 401 }\n      )\n    }\n\n    // Get user profile for additional data\n    const { data: profile, error: profileError } = await supabaseClient\n      .from('user_profiles')\n      .select('username, trust_tier, display_name, avatar_url, bio, is_active')\n      .eq('user_id', authData.user.id)\n      .single()\n\n    if (profileError || !profile) {\n      logger.warn('User profile not found after login', { userId: authData.user.id })\n      return NextResponse.json(\n        { message: 'User profile not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check if user is active\n    if (!profile.is_active) {\n      logger.warn('Inactive user attempted login', { userId: authData.user.id })\n      return NextResponse.json(\n        { message: 'Account is deactivated' },\n        { status: 403 }\n      )\n    }\n\n    logger.info('User logged in successfully', { \n      userId: authData.user.id, \n      email: authData.user.email,\n      username: profile.username \n    })\n\n    return NextResponse.json({\n      success: true,\n      user: {\n        id: authData.user.id,\n        email: authData.user.email,\n        username: profile.username,\n        trust_tier: profile.trust_tier,\n        display_name: profile.display_name,\n        avatar_url: profile.avatar_url,\n        bio: profile.bio,\n        is_active: profile.is_active\n      },\n      session: authData.session,\n      token: authData.session?.access_token\n    })\n\n  } catch (error) {\n    logger.error('Login error', error instanceof Error ? error : new Error(String(error)))\n    return NextResponse.json(\n      { message: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}"],"names":["POST","request","validateCsrfProtection","createCsrfErrorResponse","rateLimitResult","rateLimiters","auth","check","allowed","NextResponse","json","message","status","body","email","password","supabaseClient","getSupabaseServerClient","data","authData","error","authError","signInWithPassword","toLowerCase","trim","user","logger","warn","profile","profileError","from","select","eq","id","single","userId","is_active","info","username","success","trust_tier","display_name","avatar_url","bio","session","token","access_token","Error","String"],"mappings":"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"}