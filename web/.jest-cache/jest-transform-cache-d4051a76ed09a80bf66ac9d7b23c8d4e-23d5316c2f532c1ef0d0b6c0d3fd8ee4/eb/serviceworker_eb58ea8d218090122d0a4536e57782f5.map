{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/pwa/service-worker.ts"],"sourcesContent":["/**\n * PWA Service Worker Registration and Management\n * \n * Handles service worker registration, updates, and communication\n * with the main application thread.\n */\n\nimport { logger } from '@/lib/utils/logger';\n\nexport interface ServiceWorkerStatus {\n  [key: string]: unknown;\n  isSupported: boolean;\n  isRegistered: boolean;\n  isActive: boolean;\n  isInstalling: boolean;\n  isWaiting: boolean;\n  registration?: ServiceWorkerRegistration;\n  error?: string;\n}\n\nexport interface ServiceWorkerMessage {\n  type: string;\n  data?: any;\n}\n\nclass ServiceWorkerManager {\n  private registration: ServiceWorkerRegistration | null = null;\n  private updateAvailable = false;\n  private listeners: Array<(status: ServiceWorkerStatus) => void> = [];\n\n  /**\n   * Check if service workers are supported\n   */\n  isSupported(): boolean {\n    return 'serviceWorker' in navigator;\n  }\n\n  /**\n   * Register the service worker\n   */\n  async register(): Promise<ServiceWorkerStatus> {\n    if (!this.isSupported()) {\n      const status: ServiceWorkerStatus = {\n        isSupported: false,\n        isRegistered: false,\n        isActive: false,\n        isInstalling: false,\n        isWaiting: false,\n        error: 'Service workers are not supported in this browser'\n      };\n      this.notifyListeners(status);\n      return status;\n    }\n\n    try {\n      logger.info('PWA: Registering service worker...');\n      \n      this.registration = await navigator.serviceWorker.register('/sw.js', {\n        scope: '/'\n      });\n\n      logger.info('PWA: Service worker registered successfully');\n\n      // Set up event listeners\n      this.setupEventListeners();\n\n      const status = await this.getStatus();\n      this.notifyListeners(status);\n      return status;\n\n    } catch (error) {\n      logger.error('PWA: Service worker registration failed:', error instanceof Error ? error : undefined, { error: error instanceof Error ? error.message : String(error) });\n      \n      const status: ServiceWorkerStatus = {\n        isSupported: true,\n        isRegistered: false,\n        isActive: false,\n        isInstalling: false,\n        isWaiting: false,\n        error: error instanceof Error ? error.message : 'Unknown error'\n      };\n      this.notifyListeners(status);\n      return status;\n    }\n  }\n\n  /**\n   * Unregister the service worker\n   */\n  async unregister(): Promise<boolean> {\n    if (!this.registration) {\n      return false;\n    }\n\n    try {\n      const result = await this.registration.unregister();\n      this.registration = null;\n      logger.info('PWA: Service worker unregistered');\n      return result;\n    } catch (error) {\n      logger.error('PWA: Failed to unregister service worker:', error instanceof Error ? error : undefined, { error: error instanceof Error ? error.message : String(error) });\n      return false;\n    }\n  }\n\n  /**\n   * Get current service worker status\n   */\n  async getStatus(): Promise<ServiceWorkerStatus> {\n    if (!this.isSupported()) {\n      return {\n        isSupported: false,\n        isRegistered: false,\n        isActive: false,\n        isInstalling: false,\n        isWaiting: false\n      };\n    }\n\n    if (!this.registration) {\n      return {\n        isSupported: true,\n        isRegistered: false,\n        isActive: false,\n        isInstalling: false,\n        isWaiting: false\n      };\n    }\n\n    const status: ServiceWorkerStatus = {\n      isSupported: true,\n      isRegistered: true,\n      isActive: !!this.registration.active,\n      isInstalling: !!this.registration.installing,\n      isWaiting: !!this.registration.waiting,\n      registration: this.registration\n    };\n\n    return status;\n  }\n\n  /**\n   * Check for service worker updates\n   */\n  async checkForUpdates(): Promise<boolean> {\n    if (!this.registration) {\n      return false;\n    }\n\n    try {\n      await this.registration.update();\n      return this.updateAvailable;\n    } catch (error) {\n      logger.error('PWA: Failed to check for updates:', error instanceof Error ? error : undefined, { error: error instanceof Error ? error.message : String(error) });\n      return false;\n    }\n  }\n\n  /**\n   * Skip waiting and activate new service worker\n   */\n  async skipWaiting(): Promise<void> {\n    if (!this.registration?.waiting) {\n      return;\n    }\n\n    // Send message to waiting service worker\n    this.registration.waiting.postMessage({ type: 'SKIP_WAITING' });\n    \n    // Reload the page to activate the new service worker\n    window.location.reload();\n  }\n\n  /**\n   * Send message to service worker\n   */\n  async sendMessage(message: ServiceWorkerMessage): Promise<any> {\n    if (!this.registration?.active) {\n      throw new Error('No active service worker');\n    }\n\n    return new Promise((resolve, reject) => {\n      const messageChannel = new MessageChannel();\n      \n      messageChannel.port1.onmessage = (event) => {\n        resolve(event.data);\n      };\n\n      this.registration!.active!.postMessage(message, [messageChannel.port2]);\n      \n      // Timeout after 5 seconds\n      setTimeout(() => {\n        reject(new Error('Message timeout'));\n      }, 5000);\n    });\n  }\n\n  /**\n   * Get service worker version\n   */\n  async getVersion(): Promise<string | null> {\n    try {\n      const response = await this.sendMessage({ type: 'GET_VERSION' });\n      return response.version || null;\n    } catch (error) {\n      logger.error('PWA: Failed to get service worker version:', error instanceof Error ? error : undefined, { error: error instanceof Error ? error.message : String(error) });\n      return null;\n    }\n  }\n\n  /**\n   * Subscribe to service worker status changes\n   */\n  subscribe(listener: (status: ServiceWorkerStatus) => void): () => void {\n    this.listeners.push(listener);\n    \n    // Return unsubscribe function\n    return () => {\n      const index = this.listeners.indexOf(listener);\n      if (index > -1) {\n        this.listeners.splice(index, 1);\n      }\n    };\n  }\n\n  /**\n   * Set up service worker event listeners\n   */\n  private setupEventListeners(): void {\n    if (!this.registration) {\n      return;\n    }\n\n    // Handle service worker updates\n    this.registration.addEventListener('updatefound', () => {\n      logger.info('PWA: Service worker update found');\n      \n      const newWorker = this.registration!.installing;\n      if (!newWorker) {\n        return;\n      }\n\n      newWorker.addEventListener('statechange', () => {\n        if (newWorker.state === 'installed') {\n          if (navigator.serviceWorker.controller) {\n            // New service worker is waiting\n            this.updateAvailable = true;\n            logger.info('PWA: New service worker is waiting');\n            this.notifyUpdateAvailable();\n          } else {\n            // Service worker is active\n            logger.info('PWA: Service worker is now active');\n            this.updateAvailable = false;\n          }\n        }\n      });\n    });\n\n    // Handle controller change\n    navigator.serviceWorker.addEventListener('controllerchange', async () => {\n      logger.info('PWA: Service worker controller changed');\n      this.updateAvailable = false;\n      this.notifyListeners(await this.getStatus());\n    });\n  }\n\n  /**\n   * Notify listeners of status changes\n   */\n  private notifyListeners(status: ServiceWorkerStatus): void {\n    this.listeners.forEach(listener => {\n      try {\n        listener(status);\n      } catch (error) {\n        logger.error('PWA: Error in status listener:', error instanceof Error ? error : undefined, { error: error instanceof Error ? error.message : String(error) });\n      }\n    });\n  }\n\n  /**\n   * Notify that an update is available\n   */\n  private notifyUpdateAvailable(): void {\n    // Dispatch custom event for update available\n    window.dispatchEvent(new CustomEvent('sw-update-available', {\n      detail: { registration: this.registration }\n    }));\n  }\n}\n\n// Create singleton instance\nexport const serviceWorkerManager = new ServiceWorkerManager();\n\n/**\n * Initialize service worker\n */\nexport async function initializeServiceWorker(): Promise<ServiceWorkerStatus> {\n  return await serviceWorkerManager.register();\n}\n\n/**\n * Check if service worker is supported\n */\nexport function isServiceWorkerSupported(): boolean {\n  return serviceWorkerManager.isSupported();\n}\n\n/**\n * Get service worker status\n */\nexport async function getServiceWorkerStatus(): Promise<ServiceWorkerStatus> {\n  return await serviceWorkerManager.getStatus();\n}\n\n/**\n * Check for service worker updates\n */\nexport async function checkServiceWorkerUpdates(): Promise<boolean> {\n  return await serviceWorkerManager.checkForUpdates();\n}\n\n/**\n * Skip waiting and activate new service worker\n */\nexport async function skipServiceWorkerWaiting(): Promise<void> {\n  return await serviceWorkerManager.skipWaiting();\n}\n\n/**\n * Subscribe to service worker status changes\n */\nexport function subscribeToServiceWorkerStatus(\n  listener: (status: ServiceWorkerStatus) => void\n): () => void {\n  return serviceWorkerManager.subscribe(listener);\n}\n"],"names":["checkServiceWorkerUpdates","getServiceWorkerStatus","initializeServiceWorker","isServiceWorkerSupported","serviceWorkerManager","skipServiceWorkerWaiting","subscribeToServiceWorkerStatus","ServiceWorkerManager","isSupported","navigator","register","status","isRegistered","isActive","isInstalling","isWaiting","error","notifyListeners","logger","info","registration","serviceWorker","scope","setupEventListeners","getStatus","Error","undefined","message","String","unregister","result","active","installing","waiting","checkForUpdates","update","updateAvailable","skipWaiting","postMessage","type","window","location","reload","sendMessage","Promise","resolve","reject","messageChannel","MessageChannel","port1","onmessage","event","data","port2","setTimeout","getVersion","response","version","subscribe","listener","listeners","push","index","indexOf","splice","addEventListener","newWorker","state","controller","notifyUpdateAvailable","forEach","dispatchEvent","CustomEvent","detail"],"mappings":"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"}