c43b5e8898216bb170c9cac247f9132e
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    createCsrfErrorResponse: function() {
        return createCsrfErrorResponse;
    },
    getOrSetCsrfCookie: function() {
        return getOrSetCsrfCookie;
    },
    requiresCsrfProtection: function() {
        return requiresCsrfProtection;
    },
    validateCsrfProtection: function() {
        return validateCsrfProtection;
    },
    verifyCsrfToken: function() {
        return verifyCsrfToken;
    }
});
const _crypto = require("crypto");
const _headers = require("next/headers");
const _cookies = require("./cookies");
/**
 * CSRF Protection Module
 * 
 * Implements double-submit token pattern:
 * 1. Server sets CSRF token in cookie
 * 2. Client sends same token in X-CSRF-Token header
 * 3. Server verifies tokens match
 * 
 * This protects against Cross-Site Request Forgery attacks
 * by ensuring requests originate from the same origin.
 */ /**
 * Generates a cryptographically secure random token
 * 
 * @param length - Number of bytes to generate (default: 32)
 * @returns Hex-encoded random string
 */ function generateCsrfToken(length = 32) {
    return (0, _crypto.randomBytes)(length).toString("hex");
}
function getOrSetCsrfCookie() {
    const cookieStore = (0, _headers.cookies)();
    const existingToken = cookieStore.get(_cookies.CSRF_COOKIE)?.value;
    if (existingToken) {
        return existingToken;
    }
    // Generate new token if none exists
    const newToken = generateCsrfToken();
    // Set cookie with appropriate configuration
    const isProduction = process.env.NODE_ENV === "production";
    cookieStore.set(_cookies.CSRF_COOKIE, newToken, {
        httpOnly: false,
        secure: isProduction,
        sameSite: "lax",
        path: "/",
        maxAge: 60 * 60 * 24 * 7
    });
    return newToken;
}
function verifyCsrfToken(headerToken) {
    if (!headerToken) {
        return false;
    }
    const cookieStore = (0, _headers.cookies)();
    const cookieToken = cookieStore.get(_cookies.CSRF_COOKIE)?.value;
    if (!cookieToken) {
        return false;
    }
    // Use constant-time comparison to prevent timing attacks
    return headerToken === cookieToken;
}
function requiresCsrfProtection(method) {
    const safeMethods = [
        "GET",
        "HEAD",
        "OPTIONS"
    ];
    return !safeMethods.includes(method.toUpperCase());
}
function validateCsrfProtection(request) {
    const method = request.method;
    // Skip CSRF check for safe methods
    if (!requiresCsrfProtection(method)) {
        return true;
    }
    // Skip CSRF check for E2E tests and development
    const isE2E = request.headers.get("x-e2e-bypass") === "1" || process.env.NODE_ENV === "test" || process.env.E2E === "1";
    if (isE2E) {
        return true;
    }
    // Get CSRF token from header
    const headerToken = request.headers.get("x-csrf-token");
    // Verify token
    return verifyCsrfToken(headerToken || undefined);
}
function createCsrfErrorResponse() {
    return new Response(JSON.stringify({
        error: "CSRF token validation failed",
        message: "Request blocked for security reasons"
    }), {
        status: 403,
        headers: {
            "Content-Type": "application/json"
        }
    });
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9hcHAvYXBpL2F1dGgvX3NoYXJlZC9jc3JmLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJhbmRvbUJ5dGVzIH0gZnJvbSBcImNyeXB0b1wiO1xuXG5pbXBvcnQgeyBjb29raWVzIH0gZnJvbSBcIm5leHQvaGVhZGVyc1wiO1xuXG5pbXBvcnQgeyBDU1JGX0NPT0tJRSB9IGZyb20gXCIuL2Nvb2tpZXNcIjtcblxuLyoqXG4gKiBDU1JGIFByb3RlY3Rpb24gTW9kdWxlXG4gKiBcbiAqIEltcGxlbWVudHMgZG91YmxlLXN1Ym1pdCB0b2tlbiBwYXR0ZXJuOlxuICogMS4gU2VydmVyIHNldHMgQ1NSRiB0b2tlbiBpbiBjb29raWVcbiAqIDIuIENsaWVudCBzZW5kcyBzYW1lIHRva2VuIGluIFgtQ1NSRi1Ub2tlbiBoZWFkZXJcbiAqIDMuIFNlcnZlciB2ZXJpZmllcyB0b2tlbnMgbWF0Y2hcbiAqIFxuICogVGhpcyBwcm90ZWN0cyBhZ2FpbnN0IENyb3NzLVNpdGUgUmVxdWVzdCBGb3JnZXJ5IGF0dGFja3NcbiAqIGJ5IGVuc3VyaW5nIHJlcXVlc3RzIG9yaWdpbmF0ZSBmcm9tIHRoZSBzYW1lIG9yaWdpbi5cbiAqL1xuXG4vKipcbiAqIEdlbmVyYXRlcyBhIGNyeXB0b2dyYXBoaWNhbGx5IHNlY3VyZSByYW5kb20gdG9rZW5cbiAqIFxuICogQHBhcmFtIGxlbmd0aCAtIE51bWJlciBvZiBieXRlcyB0byBnZW5lcmF0ZSAoZGVmYXVsdDogMzIpXG4gKiBAcmV0dXJucyBIZXgtZW5jb2RlZCByYW5kb20gc3RyaW5nXG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlQ3NyZlRva2VuKGxlbmd0aDogbnVtYmVyID0gMzIpOiBzdHJpbmcge1xuICByZXR1cm4gcmFuZG9tQnl0ZXMobGVuZ3RoKS50b1N0cmluZyhcImhleFwiKTtcbn1cblxuLyoqXG4gKiBHZXRzIGV4aXN0aW5nIENTUkYgdG9rZW4gZnJvbSBjb29raWUgb3IgY3JlYXRlcyBhIG5ldyBvbmVcbiAqIFxuICogQHJldHVybnMgQ1NSRiB0b2tlbiBzdHJpbmdcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldE9yU2V0Q3NyZkNvb2tpZSgpOiBzdHJpbmcge1xuICBjb25zdCBjb29raWVTdG9yZSA9IGNvb2tpZXMoKTtcbiAgY29uc3QgZXhpc3RpbmdUb2tlbiA9IGNvb2tpZVN0b3JlLmdldChDU1JGX0NPT0tJRSk/LnZhbHVlO1xuICBcbiAgaWYgKGV4aXN0aW5nVG9rZW4pIHtcbiAgICByZXR1cm4gZXhpc3RpbmdUb2tlbjtcbiAgfVxuICBcbiAgLy8gR2VuZXJhdGUgbmV3IHRva2VuIGlmIG5vbmUgZXhpc3RzXG4gIGNvbnN0IG5ld1Rva2VuID0gZ2VuZXJhdGVDc3JmVG9rZW4oKTtcbiAgXG4gIC8vIFNldCBjb29raWUgd2l0aCBhcHByb3ByaWF0ZSBjb25maWd1cmF0aW9uXG4gIGNvbnN0IGlzUHJvZHVjdGlvbiA9IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSBcInByb2R1Y3Rpb25cIjtcbiAgY29va2llU3RvcmUuc2V0KENTUkZfQ09PS0lFLCBuZXdUb2tlbiwge1xuICAgIGh0dHBPbmx5OiBmYWxzZSwgLy8gQ2xpZW50IG5lZWRzIHRvIHJlYWQgdGhpc1xuICAgIHNlY3VyZTogaXNQcm9kdWN0aW9uLFxuICAgIHNhbWVTaXRlOiBcImxheFwiLFxuICAgIHBhdGg6IFwiL1wiLFxuICAgIG1heEFnZTogNjAgKiA2MCAqIDI0ICogNywgLy8gNyBkYXlzXG4gIH0pO1xuICBcbiAgcmV0dXJuIG5ld1Rva2VuO1xufVxuXG4vKipcbiAqIFZlcmlmaWVzIENTUkYgdG9rZW4gZnJvbSByZXF1ZXN0IGhlYWRlciBhZ2FpbnN0IGNvb2tpZVxuICogXG4gKiBAcGFyYW0gaGVhZGVyVG9rZW4gLSBUb2tlbiBmcm9tIFgtQ1NSRi1Ub2tlbiBoZWFkZXJcbiAqIEByZXR1cm5zIHRydWUgaWYgdG9rZW5zIG1hdGNoLCBmYWxzZSBvdGhlcndpc2VcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHZlcmlmeUNzcmZUb2tlbihoZWFkZXJUb2tlbj86IHN0cmluZyk6IGJvb2xlYW4ge1xuICBpZiAoIWhlYWRlclRva2VuKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIFxuICBjb25zdCBjb29raWVTdG9yZSA9IGNvb2tpZXMoKTtcbiAgY29uc3QgY29va2llVG9rZW4gPSBjb29raWVTdG9yZS5nZXQoQ1NSRl9DT09LSUUpPy52YWx1ZTtcbiAgXG4gIGlmICghY29va2llVG9rZW4pIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgXG4gIC8vIFVzZSBjb25zdGFudC10aW1lIGNvbXBhcmlzb24gdG8gcHJldmVudCB0aW1pbmcgYXR0YWNrc1xuICByZXR1cm4gaGVhZGVyVG9rZW4gPT09IGNvb2tpZVRva2VuO1xufVxuXG4vKipcbiAqIENoZWNrcyBpZiBDU1JGIHByb3RlY3Rpb24gaXMgcmVxdWlyZWQgZm9yIHRoZSBnaXZlbiBIVFRQIG1ldGhvZFxuICogXG4gKiBAcGFyYW0gbWV0aG9kIC0gSFRUUCBtZXRob2QgZnJvbSByZXF1ZXN0XG4gKiBAcmV0dXJucyB0cnVlIGlmIENTUkYgcHJvdGVjdGlvbiBpcyByZXF1aXJlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVxdWlyZXNDc3JmUHJvdGVjdGlvbihtZXRob2Q6IHN0cmluZyk6IGJvb2xlYW4ge1xuICBjb25zdCBzYWZlTWV0aG9kcyA9IFtcIkdFVFwiLCBcIkhFQURcIiwgXCJPUFRJT05TXCJdO1xuICByZXR1cm4gIXNhZmVNZXRob2RzLmluY2x1ZGVzKG1ldGhvZC50b1VwcGVyQ2FzZSgpKTtcbn1cblxuLyoqXG4gKiBWYWxpZGF0ZXMgQ1NSRiBwcm90ZWN0aW9uIGZvciBhIHJlcXVlc3RcbiAqIFxuICogQHBhcmFtIHJlcXVlc3QgLSBSZXF1ZXN0IG9iamVjdCBjb250YWluaW5nIG1ldGhvZCBhbmQgaGVhZGVyc1xuICogQHJldHVybnMgdHJ1ZSBpZiBDU1JGIHZhbGlkYXRpb24gcGFzc2VzIG9yIGlzIG5vdCByZXF1aXJlZFxuICovXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVDc3JmUHJvdGVjdGlvbihyZXF1ZXN0OiBSZXF1ZXN0KTogYm9vbGVhbiB7XG4gIGNvbnN0IG1ldGhvZCA9IHJlcXVlc3QubWV0aG9kO1xuICBcbiAgLy8gU2tpcCBDU1JGIGNoZWNrIGZvciBzYWZlIG1ldGhvZHNcbiAgaWYgKCFyZXF1aXJlc0NzcmZQcm90ZWN0aW9uKG1ldGhvZCkpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBcbiAgLy8gU2tpcCBDU1JGIGNoZWNrIGZvciBFMkUgdGVzdHMgYW5kIGRldmVsb3BtZW50XG4gIGNvbnN0IGlzRTJFID0gcmVxdWVzdC5oZWFkZXJzLmdldCgneC1lMmUtYnlwYXNzJykgPT09ICcxJyB8fCBcbiAgICAgICAgICAgICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Rlc3QnIHx8IFxuICAgICAgICAgICAgICAgIHByb2Nlc3MuZW52LkUyRSA9PT0gJzEnO1xuICBcbiAgaWYgKGlzRTJFKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgXG4gIC8vIEdldCBDU1JGIHRva2VuIGZyb20gaGVhZGVyXG4gIGNvbnN0IGhlYWRlclRva2VuID0gcmVxdWVzdC5oZWFkZXJzLmdldChcIngtY3NyZi10b2tlblwiKTtcbiAgXG4gIC8vIFZlcmlmeSB0b2tlblxuICByZXR1cm4gdmVyaWZ5Q3NyZlRva2VuKGhlYWRlclRva2VuIHx8IHVuZGVmaW5lZCk7XG59XG5cbi8qKlxuICogQ3JlYXRlcyBhIENTUkYgdmFsaWRhdGlvbiBlcnJvciByZXNwb25zZVxuICogXG4gKiBAcmV0dXJucyBOZXh0UmVzcG9uc2Ugd2l0aCA0MDMgRm9yYmlkZGVuIHN0YXR1c1xuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQ3NyZkVycm9yUmVzcG9uc2UoKTogUmVzcG9uc2Uge1xuICByZXR1cm4gbmV3IFJlc3BvbnNlKFxuICAgIEpTT04uc3RyaW5naWZ5KHsgXG4gICAgICBlcnJvcjogXCJDU1JGIHRva2VuIHZhbGlkYXRpb24gZmFpbGVkXCIsXG4gICAgICBtZXNzYWdlOiBcIlJlcXVlc3QgYmxvY2tlZCBmb3Igc2VjdXJpdHkgcmVhc29uc1wiXG4gICAgfSksXG4gICAge1xuICAgICAgc3RhdHVzOiA0MDMsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgfSxcbiAgICB9XG4gICk7XG59XG4iXSwibmFtZXMiOlsiY3JlYXRlQ3NyZkVycm9yUmVzcG9uc2UiLCJnZXRPclNldENzcmZDb29raWUiLCJyZXF1aXJlc0NzcmZQcm90ZWN0aW9uIiwidmFsaWRhdGVDc3JmUHJvdGVjdGlvbiIsInZlcmlmeUNzcmZUb2tlbiIsImdlbmVyYXRlQ3NyZlRva2VuIiwibGVuZ3RoIiwicmFuZG9tQnl0ZXMiLCJ0b1N0cmluZyIsImNvb2tpZVN0b3JlIiwiY29va2llcyIsImV4aXN0aW5nVG9rZW4iLCJnZXQiLCJDU1JGX0NPT0tJRSIsInZhbHVlIiwibmV3VG9rZW4iLCJpc1Byb2R1Y3Rpb24iLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJzZXQiLCJodHRwT25seSIsInNlY3VyZSIsInNhbWVTaXRlIiwicGF0aCIsIm1heEFnZSIsImhlYWRlclRva2VuIiwiY29va2llVG9rZW4iLCJtZXRob2QiLCJzYWZlTWV0aG9kcyIsImluY2x1ZGVzIiwidG9VcHBlckNhc2UiLCJyZXF1ZXN0IiwiaXNFMkUiLCJoZWFkZXJzIiwiRTJFIiwidW5kZWZpbmVkIiwiUmVzcG9uc2UiLCJKU09OIiwic3RyaW5naWZ5IiwiZXJyb3IiLCJtZXNzYWdlIiwic3RhdHVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztJQTZIZ0JBLHVCQUF1QjtlQUF2QkE7O0lBNUZBQyxrQkFBa0I7ZUFBbEJBOztJQW9EQUMsc0JBQXNCO2VBQXRCQTs7SUFXQUMsc0JBQXNCO2VBQXRCQTs7SUFqQ0FDLGVBQWU7ZUFBZkE7Ozt3QkEvRFk7eUJBRUo7eUJBRUk7QUFFNUI7Ozs7Ozs7Ozs7Q0FVQyxHQUVEOzs7OztDQUtDLEdBQ0QsU0FBU0Msa0JBQWtCQyxTQUFpQixFQUFFO0lBQzVDLE9BQU9DLElBQUFBLG1CQUFXLEVBQUNELFFBQVFFLFFBQVEsQ0FBQztBQUN0QztBQU9PLFNBQVNQO0lBQ2QsTUFBTVEsY0FBY0MsSUFBQUEsZ0JBQU87SUFDM0IsTUFBTUMsZ0JBQWdCRixZQUFZRyxHQUFHLENBQUNDLG9CQUFXLEdBQUdDO0lBRXBELElBQUlILGVBQWU7UUFDakIsT0FBT0E7SUFDVDtJQUVBLG9DQUFvQztJQUNwQyxNQUFNSSxXQUFXVjtJQUVqQiw0Q0FBNEM7SUFDNUMsTUFBTVcsZUFBZUMsUUFBUUMsR0FBRyxDQUFDQyxRQUFRLEtBQUs7SUFDOUNWLFlBQVlXLEdBQUcsQ0FBQ1Asb0JBQVcsRUFBRUUsVUFBVTtRQUNyQ00sVUFBVTtRQUNWQyxRQUFRTjtRQUNSTyxVQUFVO1FBQ1ZDLE1BQU07UUFDTkMsUUFBUSxLQUFLLEtBQUssS0FBSztJQUN6QjtJQUVBLE9BQU9WO0FBQ1Q7QUFRTyxTQUFTWCxnQkFBZ0JzQixXQUFvQjtJQUNsRCxJQUFJLENBQUNBLGFBQWE7UUFDaEIsT0FBTztJQUNUO0lBRUEsTUFBTWpCLGNBQWNDLElBQUFBLGdCQUFPO0lBQzNCLE1BQU1pQixjQUFjbEIsWUFBWUcsR0FBRyxDQUFDQyxvQkFBVyxHQUFHQztJQUVsRCxJQUFJLENBQUNhLGFBQWE7UUFDaEIsT0FBTztJQUNUO0lBRUEseURBQXlEO0lBQ3pELE9BQU9ELGdCQUFnQkM7QUFDekI7QUFRTyxTQUFTekIsdUJBQXVCMEIsTUFBYztJQUNuRCxNQUFNQyxjQUFjO1FBQUM7UUFBTztRQUFRO0tBQVU7SUFDOUMsT0FBTyxDQUFDQSxZQUFZQyxRQUFRLENBQUNGLE9BQU9HLFdBQVc7QUFDakQ7QUFRTyxTQUFTNUIsdUJBQXVCNkIsT0FBZ0I7SUFDckQsTUFBTUosU0FBU0ksUUFBUUosTUFBTTtJQUU3QixtQ0FBbUM7SUFDbkMsSUFBSSxDQUFDMUIsdUJBQXVCMEIsU0FBUztRQUNuQyxPQUFPO0lBQ1Q7SUFFQSxnREFBZ0Q7SUFDaEQsTUFBTUssUUFBUUQsUUFBUUUsT0FBTyxDQUFDdEIsR0FBRyxDQUFDLG9CQUFvQixPQUN4Q0ssUUFBUUMsR0FBRyxDQUFDQyxRQUFRLEtBQUssVUFDekJGLFFBQVFDLEdBQUcsQ0FBQ2lCLEdBQUcsS0FBSztJQUVsQyxJQUFJRixPQUFPO1FBQ1QsT0FBTztJQUNUO0lBRUEsNkJBQTZCO0lBQzdCLE1BQU1QLGNBQWNNLFFBQVFFLE9BQU8sQ0FBQ3RCLEdBQUcsQ0FBQztJQUV4QyxlQUFlO0lBQ2YsT0FBT1IsZ0JBQWdCc0IsZUFBZVU7QUFDeEM7QUFPTyxTQUFTcEM7SUFDZCxPQUFPLElBQUlxQyxTQUNUQyxLQUFLQyxTQUFTLENBQUM7UUFDYkMsT0FBTztRQUNQQyxTQUFTO0lBQ1gsSUFDQTtRQUNFQyxRQUFRO1FBQ1JSLFNBQVM7WUFDUCxnQkFBZ0I7UUFDbEI7SUFDRjtBQUVKIn0=