{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/core/polls-crud-real-database.test.ts"],"sourcesContent":["/**\n * Polls CRUD API Tests - REAL DATABASE\n * \n * This test uses REAL database connections and test users instead of mocks.\n * This provides much more realistic and valuable testing.\n */\n\nimport { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\nimport { NextRequest } from 'next/server';\nimport { GET, POST } from '@/app/api/polls/route';\nimport { createClient } from '@supabase/supabase-js';\n\n// Test configuration\nconst TEST_CONFIG = {\n  SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,\n  SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n  TEST_USER_EMAIL: 'test@example.com',\n  TEST_USER_PASSWORD: 'TestPassword123!',\n  TEST_ADMIN_EMAIL: 'admin@example.com',\n  TEST_ADMIN_PASSWORD: 'AdminPassword123!',\n};\n\n// Real Supabase client for testing\nconst supabase = createClient(TEST_CONFIG.SUPABASE_URL!, TEST_CONFIG.SUPABASE_ANON_KEY!);\n\n// Test user session\nlet testUserSession: any = null;\nlet testAdminSession: any = null;\n\ndescribe('Polls CRUD API - REAL DATABASE', () => {\n  beforeEach(async () => {\n    // Authenticate test user\n    const { data: userData, error: userError } = await supabase.auth.signInWithPassword({\n      email: TEST_CONFIG.TEST_USER_EMAIL,\n      password: TEST_CONFIG.TEST_USER_PASSWORD,\n    });\n    \n    if (userError) {\n      console.error('Failed to authenticate test user:', userError);\n      throw userError;\n    }\n    \n    testUserSession = userData.session;\n    \n    // Authenticate test admin\n    const { data: adminData, error: adminError } = await supabase.auth.signInWithPassword({\n      email: TEST_CONFIG.TEST_ADMIN_EMAIL,\n      password: TEST_CONFIG.TEST_ADMIN_PASSWORD,\n    });\n    \n    if (adminError) {\n      console.error('Failed to authenticate test admin:', adminError);\n      throw adminError;\n    }\n    \n    testAdminSession = adminData.session;\n  });\n\n  afterEach(async () => {\n    // Clean up test data\n    if (testUserSession) {\n      await supabase.auth.signOut();\n    }\n    if (testAdminSession) {\n      await supabase.auth.signOut();\n    }\n  });\n\n  describe('GET /api/polls - List Polls', () => {\n    it('should return list of polls from real database', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      console.log('Real database response:', responseData);\n\n      expect(response.status).toBe(200);\n      expect(responseData).toHaveProperty('success');\n      expect(responseData).toHaveProperty('polls');\n      expect(Array.isArray(responseData.polls)).toBe(true);\n    });\n\n    it('should handle pagination with real database', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls?limit=5');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(responseData.polls.length).toBeLessThanOrEqual(5);\n    });\n\n    it('should return empty list when no polls exist', async () => {\n      // This test would need to ensure no polls exist in the database\n      // For now, we'll just test the structure\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(Array.isArray(responseData.polls)).toBe(true);\n    });\n  });\n\n  describe('POST /api/polls - Create Poll', () => {\n    it('should create a new poll with real authentication', async () => {\n      // Create a request with real authentication\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${testUserSession.access_token}`,\n        },\n        body: JSON.stringify({\n          title: 'Real Database Test Poll',\n          options: [\n            { text: 'Real Option 1' },\n            { text: 'Real Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      console.log('Real database poll creation response:', responseData);\n\n      expect(response.status).toBe(201);\n      expect(responseData).toHaveProperty('poll');\n      expect(responseData.poll.title).toBe('Real Database Test Poll');\n    });\n\n    it('should reject poll creation without authentication', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          // No authorization header\n        },\n        body: JSON.stringify({\n          title: 'Unauthorized Poll',\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(401);\n      expect(responseData.error).toBe('Authentication required to create polls');\n    });\n\n    it('should reject poll creation with missing title', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${testUserSession.access_token}`,\n        },\n        body: JSON.stringify({\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(400);\n      expect(responseData.error).toBe('Title and at least 2 options are required');\n    });\n\n    it('should reject poll creation with insufficient options', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${testUserSession.access_token}`,\n        },\n        body: JSON.stringify({\n          title: 'Insufficient Options Poll',\n          options: [\n            { text: 'Only One Option' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(400);\n      expect(responseData.error).toBe('Title and at least 2 options are required');\n    });\n  });\n\n  describe('Real Database Integration', () => {\n    it('should persist poll data in real database', async () => {\n      // Create a poll\n      const createRequest = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${testUserSession.access_token}`,\n        },\n        body: JSON.stringify({\n          title: 'Database Persistence Test Poll',\n          options: [\n            { text: 'Persist Option 1' },\n            { text: 'Persist Option 2' }\n          ]\n        }),\n      });\n\n      const createResponse = await POST(createRequest);\n      const createData = await createResponse.json();\n\n      expect(createResponse.status).toBe(201);\n      expect(createData.poll.title).toBe('Database Persistence Test Poll');\n\n      // Verify the poll exists in the database\n      const { data: polls, error } = await supabase\n        .from('polls')\n        .select('*')\n        .eq('title', 'Database Persistence Test Poll');\n\n      expect(error).toBeNull();\n      expect(polls).toHaveLength(1);\n      expect(polls[0].title).toBe('Database Persistence Test Poll');\n    });\n\n    it('should handle real database errors gracefully', async () => {\n      // This test would need to simulate a database error\n      // For now, we'll test the error handling structure\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      // Should handle database errors gracefully\n      expect(response.status).toBe(200);\n      expect(responseData).toHaveProperty('success');\n    });\n  });\n});\n"],"names":["TEST_CONFIG","SUPABASE_URL","process","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_ANON_KEY","NEXT_PUBLIC_SUPABASE_ANON_KEY","TEST_USER_EMAIL","TEST_USER_PASSWORD","TEST_ADMIN_EMAIL","TEST_ADMIN_PASSWORD","supabase","createClient","testUserSession","testAdminSession","describe","beforeEach","data","userData","error","userError","auth","signInWithPassword","email","password","console","session","adminData","adminError","afterEach","signOut","it","request","NextRequest","response","GET","responseData","json","log","expect","status","toBe","toHaveProperty","Array","isArray","polls","success","length","toBeLessThanOrEqual","method","headers","access_token","body","JSON","stringify","title","options","text","POST","poll","createRequest","createResponse","createData","from","select","eq","toBeNull","toHaveLength"],"mappings":"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"}