b6ea4cba697f2a0452dc8717f98b3465
/**
 * @jest-environment node
 */ "use strict";
// Mock Next.js cookies to allow Supabase client to work in tests
jest.mock("next/headers", ()=>({
        cookies: jest.fn(()=>({
                get: jest.fn(()=>undefined),
                set: jest.fn(),
                delete: jest.fn()
            }))
    }));
// Mock Supabase client to avoid network calls in tests
jest.mock("@/utils/supabase/server", ()=>({
        getSupabaseServerClient: jest.fn().mockResolvedValue({
            auth: {
                signInWithPassword: jest.fn().mockResolvedValue({
                    data: null,
                    error: {
                        message: "Invalid login credentials"
                    }
                })
            },
            from: jest.fn(()=>({
                    select: jest.fn(()=>({
                            eq: jest.fn(()=>({
                                    single: jest.fn().mockResolvedValue({
                                        data: null,
                                        error: {
                                            message: "User not found"
                                        }
                                    })
                                }))
                        }))
                }))
        })
    }));
Object.defineProperty(exports, "__esModule", {
    value: true
});
const _server = require("next/server");
const _route = require("../../../../../app/api/auth/login/route");
describe("Auth Login Route - Real Database Testing", ()=>{
    // No mocking - use real database, real rate limiting, real everything
    it("should handle invalid credentials gracefully", async ()=>{
        const request = new _server.NextRequest("http://localhost:3000/api/auth/login", {
            method: "POST",
            body: JSON.stringify({
                email: "nonexistent@example.com",
                password: "wrongpassword"
            }),
            headers: {
                "Content-Type": "application/json",
                "x-forwarded-for": "127.0.0.1",
                "user-agent": "test-agent"
            }
        });
        const response = await (0, _route.POST)(request);
        const data = await response.json();
        // Should return 401 for invalid credentials
        expect(response.status).toBe(401);
        expect(data.message).toBe("Invalid email or password");
    });
    it("should validate required fields", async ()=>{
        const request = new _server.NextRequest("http://localhost:3000/api/auth/login", {
            method: "POST",
            body: JSON.stringify({
                email: "test@example.com"
            }),
            headers: {
                "Content-Type": "application/json",
                "x-forwarded-for": "127.0.0.1",
                "user-agent": "test-agent"
            }
        });
        const response = await (0, _route.POST)(request);
        const data = await response.json();
        // Should return 400 for missing password
        expect(response.status).toBe(400);
        expect(data.message).toBe("Email and password are required");
    });
    it("should handle malformed JSON", async ()=>{
        const request = new _server.NextRequest("http://localhost:3000/api/auth/login", {
            method: "POST",
            body: "invalid json",
            headers: {
                "Content-Type": "application/json",
                "x-forwarded-for": "127.0.0.1",
                "user-agent": "test-agent"
            }
        });
        const response = await (0, _route.POST)(request);
        // Should return 500 for malformed JSON
        expect(response.status).toBe(500);
    });
    it("should test rate limiting with multiple requests", async ()=>{
        // Test rate limiting by making multiple requests
        const requests = Array.from({
            length: 5
        }, ()=>new _server.NextRequest("http://localhost:3000/api/auth/login", {
                method: "POST",
                body: JSON.stringify({
                    email: "test@example.com",
                    password: "wrongpassword"
                }),
                headers: {
                    "Content-Type": "application/json",
                    "x-forwarded-for": "127.0.0.1",
                    "user-agent": "test-agent"
                }
            }));
        const responses = await Promise.all(requests.map((request)=>(0, _route.POST)(request)));
        // Should get 401s for invalid credentials, then 429 for rate limiting
        const statusCodes = responses.map((r)=>r.status);
        expect(statusCodes).toContain(401); // Invalid credentials
        expect(statusCodes).toContain(429); // Rate limited
    });
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi90ZXN0cy9qZXN0L3VuaXQvYXBpL2F1dGgvbG9naW4tcm91dGUtcmVhbC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQGplc3QtZW52aXJvbm1lbnQgbm9kZVxuICovXG5cbmltcG9ydCB7IE5leHRSZXF1ZXN0IH0gZnJvbSAnbmV4dC9zZXJ2ZXInO1xuaW1wb3J0IHsgUE9TVCB9IGZyb20gJ0AvYXBwL2FwaS9hdXRoL2xvZ2luL3JvdXRlJztcblxuLy8gTW9jayBOZXh0LmpzIGNvb2tpZXMgdG8gYWxsb3cgU3VwYWJhc2UgY2xpZW50IHRvIHdvcmsgaW4gdGVzdHNcbmplc3QubW9jaygnbmV4dC9oZWFkZXJzJywgKCkgPT4gKHtcbiAgY29va2llczogamVzdC5mbigoKSA9PiAoe1xuICAgIGdldDogamVzdC5mbigoKSA9PiB1bmRlZmluZWQpLFxuICAgIHNldDogamVzdC5mbigpLFxuICAgIGRlbGV0ZTogamVzdC5mbigpLFxuICB9KSksXG59KSk7XG5cbi8vIE1vY2sgU3VwYWJhc2UgY2xpZW50IHRvIGF2b2lkIG5ldHdvcmsgY2FsbHMgaW4gdGVzdHNcbmplc3QubW9jaygnQC91dGlscy9zdXBhYmFzZS9zZXJ2ZXInLCAoKSA9PiAoe1xuICBnZXRTdXBhYmFzZVNlcnZlckNsaWVudDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICBhdXRoOiB7XG4gICAgICBzaWduSW5XaXRoUGFzc3dvcmQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7XG4gICAgICAgIGRhdGE6IG51bGwsXG4gICAgICAgIGVycm9yOiB7IG1lc3NhZ2U6ICdJbnZhbGlkIGxvZ2luIGNyZWRlbnRpYWxzJyB9XG4gICAgICB9KVxuICAgIH0sXG4gICAgZnJvbTogamVzdC5mbigoKSA9PiAoe1xuICAgICAgc2VsZWN0OiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgIGVxOiBqZXN0LmZuKCgpID0+ICh7XG4gICAgICAgICAgc2luZ2xlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgICAgZGF0YTogbnVsbCxcbiAgICAgICAgICAgIGVycm9yOiB7IG1lc3NhZ2U6ICdVc2VyIG5vdCBmb3VuZCcgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH0pKVxuICAgICAgfSkpXG4gICAgfSkpXG4gIH0pXG59KSk7XG5cbmRlc2NyaWJlKCdBdXRoIExvZ2luIFJvdXRlIC0gUmVhbCBEYXRhYmFzZSBUZXN0aW5nJywgKCkgPT4ge1xuICAvLyBObyBtb2NraW5nIC0gdXNlIHJlYWwgZGF0YWJhc2UsIHJlYWwgcmF0ZSBsaW1pdGluZywgcmVhbCBldmVyeXRoaW5nXG5cbiAgaXQoJ3Nob3VsZCBoYW5kbGUgaW52YWxpZCBjcmVkZW50aWFscyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgTmV4dFJlcXVlc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvYXV0aC9sb2dpbicsIHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICBlbWFpbDogJ25vbmV4aXN0ZW50QGV4YW1wbGUuY29tJyxcbiAgICAgICAgcGFzc3dvcmQ6ICd3cm9uZ3Bhc3N3b3JkJyxcbiAgICAgIH0pLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgICAgICAneC1mb3J3YXJkZWQtZm9yJzogJzEyNy4wLjAuMScsXG4gICAgICAgICd1c2VyLWFnZW50JzogJ3Rlc3QtYWdlbnQnLFxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgUE9TVChyZXF1ZXN0KTtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXG4gICAgLy8gU2hvdWxkIHJldHVybiA0MDEgZm9yIGludmFsaWQgY3JlZGVudGlhbHNcbiAgICBleHBlY3QocmVzcG9uc2Uuc3RhdHVzKS50b0JlKDQwMSk7XG4gICAgZXhwZWN0KGRhdGEubWVzc2FnZSkudG9CZSgnSW52YWxpZCBlbWFpbCBvciBwYXNzd29yZCcpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHZhbGlkYXRlIHJlcXVpcmVkIGZpZWxkcycsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCByZXF1ZXN0ID0gbmV3IE5leHRSZXF1ZXN0KCdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2F1dGgvbG9naW4nLCB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgLy8gTWlzc2luZyBwYXNzd29yZFxuICAgICAgfSksXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICd4LWZvcndhcmRlZC1mb3InOiAnMTI3LjAuMC4xJyxcbiAgICAgICAgJ3VzZXItYWdlbnQnOiAndGVzdC1hZ2VudCcsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBQT1NUKHJlcXVlc3QpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG5cbiAgICAvLyBTaG91bGQgcmV0dXJuIDQwMCBmb3IgbWlzc2luZyBwYXNzd29yZFxuICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNDAwKTtcbiAgICBleHBlY3QoZGF0YS5tZXNzYWdlKS50b0JlKCdFbWFpbCBhbmQgcGFzc3dvcmQgYXJlIHJlcXVpcmVkJyk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgaGFuZGxlIG1hbGZvcm1lZCBKU09OJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBuZXcgTmV4dFJlcXVlc3QoJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMC9hcGkvYXV0aC9sb2dpbicsIHtcbiAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgYm9keTogJ2ludmFsaWQganNvbicsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICd4LWZvcndhcmRlZC1mb3InOiAnMTI3LjAuMC4xJyxcbiAgICAgICAgJ3VzZXItYWdlbnQnOiAndGVzdC1hZ2VudCcsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBQT1NUKHJlcXVlc3QpO1xuICAgIFxuICAgIC8vIFNob3VsZCByZXR1cm4gNTAwIGZvciBtYWxmb3JtZWQgSlNPTlxuICAgIGV4cGVjdChyZXNwb25zZS5zdGF0dXMpLnRvQmUoNTAwKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCB0ZXN0IHJhdGUgbGltaXRpbmcgd2l0aCBtdWx0aXBsZSByZXF1ZXN0cycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBUZXN0IHJhdGUgbGltaXRpbmcgYnkgbWFraW5nIG11bHRpcGxlIHJlcXVlc3RzXG4gICAgY29uc3QgcmVxdWVzdHMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiA1IH0sICgpID0+IFxuICAgICAgbmV3IE5leHRSZXF1ZXN0KCdodHRwOi8vbG9jYWxob3N0OjMwMDAvYXBpL2F1dGgvbG9naW4nLCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgICBwYXNzd29yZDogJ3dyb25ncGFzc3dvcmQnLFxuICAgICAgICB9KSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgJ3gtZm9yd2FyZGVkLWZvcic6ICcxMjcuMC4wLjEnLFxuICAgICAgICAgICd1c2VyLWFnZW50JzogJ3Rlc3QtYWdlbnQnLFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3QgcmVzcG9uc2VzID0gYXdhaXQgUHJvbWlzZS5hbGwocmVxdWVzdHMubWFwKHJlcXVlc3QgPT4gUE9TVChyZXF1ZXN0KSkpO1xuICAgIFxuICAgIC8vIFNob3VsZCBnZXQgNDAxcyBmb3IgaW52YWxpZCBjcmVkZW50aWFscywgdGhlbiA0MjkgZm9yIHJhdGUgbGltaXRpbmdcbiAgICBjb25zdCBzdGF0dXNDb2RlcyA9IHJlc3BvbnNlcy5tYXAociA9PiByLnN0YXR1cyk7XG4gICAgZXhwZWN0KHN0YXR1c0NvZGVzKS50b0NvbnRhaW4oNDAxKTsgLy8gSW52YWxpZCBjcmVkZW50aWFsc1xuICAgIGV4cGVjdChzdGF0dXNDb2RlcykudG9Db250YWluKDQyOSk7IC8vIFJhdGUgbGltaXRlZFxuICB9KTtcbn0pO1xuIl0sIm5hbWVzIjpbImplc3QiLCJtb2NrIiwiY29va2llcyIsImZuIiwiZ2V0IiwidW5kZWZpbmVkIiwic2V0IiwiZGVsZXRlIiwiZ2V0U3VwYWJhc2VTZXJ2ZXJDbGllbnQiLCJtb2NrUmVzb2x2ZWRWYWx1ZSIsImF1dGgiLCJzaWduSW5XaXRoUGFzc3dvcmQiLCJkYXRhIiwiZXJyb3IiLCJtZXNzYWdlIiwiZnJvbSIsInNlbGVjdCIsImVxIiwic2luZ2xlIiwiZGVzY3JpYmUiLCJpdCIsInJlcXVlc3QiLCJOZXh0UmVxdWVzdCIsIm1ldGhvZCIsImJvZHkiLCJKU09OIiwic3RyaW5naWZ5IiwiZW1haWwiLCJwYXNzd29yZCIsImhlYWRlcnMiLCJyZXNwb25zZSIsIlBPU1QiLCJqc29uIiwiZXhwZWN0Iiwic3RhdHVzIiwidG9CZSIsInJlcXVlc3RzIiwiQXJyYXkiLCJsZW5ndGgiLCJyZXNwb25zZXMiLCJQcm9taXNlIiwiYWxsIiwibWFwIiwic3RhdHVzQ29kZXMiLCJyIiwidG9Db250YWluIl0sIm1hcHBpbmdzIjoiQUFBQTs7Q0FF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