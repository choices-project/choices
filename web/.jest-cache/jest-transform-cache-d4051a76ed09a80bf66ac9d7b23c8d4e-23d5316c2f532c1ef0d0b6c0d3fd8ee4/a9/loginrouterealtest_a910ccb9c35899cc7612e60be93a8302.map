{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/auth/login-route-real.test.ts"],"sourcesContent":["/**\n * @jest-environment node\n */\n\nimport { NextRequest } from 'next/server';\nimport { POST } from '@/app/api/auth/login/route';\n\n// Mock Next.js cookies to allow Supabase client to work in tests\njest.mock('next/headers', () => ({\n  cookies: jest.fn(() => ({\n    get: jest.fn(() => undefined),\n    set: jest.fn(),\n    delete: jest.fn(),\n  })),\n}));\n\n// Mock Supabase client to avoid network calls in tests\njest.mock('@/utils/supabase/server', () => ({\n  getSupabaseServerClient: jest.fn().mockResolvedValue({\n    auth: {\n      signInWithPassword: jest.fn().mockResolvedValue({\n        data: null,\n        error: { message: 'Invalid login credentials' }\n      })\n    },\n    from: jest.fn(() => ({\n      select: jest.fn(() => ({\n        eq: jest.fn(() => ({\n          single: jest.fn().mockResolvedValue({\n            data: null,\n            error: { message: 'User not found' }\n          })\n        }))\n      }))\n    }))\n  })\n}));\n\ndescribe('Auth Login Route - Real Database Testing', () => {\n  // No mocking - use real database, real rate limiting, real everything\n\n  it('should handle invalid credentials gracefully', async () => {\n    const request = new NextRequest('http://localhost:3000/api/auth/login', {\n      method: 'POST',\n      body: JSON.stringify({\n        email: 'nonexistent@example.com',\n        password: 'wrongpassword',\n      }),\n      headers: {\n        'Content-Type': 'application/json',\n        'x-forwarded-for': '127.0.0.1',\n        'user-agent': 'test-agent',\n      },\n    });\n\n    const response = await POST(request);\n    const data = await response.json();\n\n    // Should return 401 for invalid credentials\n    expect(response.status).toBe(401);\n    expect(data.message).toBe('Invalid email or password');\n  });\n\n  it('should validate required fields', async () => {\n    const request = new NextRequest('http://localhost:3000/api/auth/login', {\n      method: 'POST',\n      body: JSON.stringify({\n        email: 'test@example.com',\n        // Missing password\n      }),\n      headers: {\n        'Content-Type': 'application/json',\n        'x-forwarded-for': '127.0.0.1',\n        'user-agent': 'test-agent',\n      },\n    });\n\n    const response = await POST(request);\n    const data = await response.json();\n\n    // Should return 400 for missing password\n    expect(response.status).toBe(400);\n    expect(data.message).toBe('Email and password are required');\n  });\n\n  it('should handle malformed JSON', async () => {\n    const request = new NextRequest('http://localhost:3000/api/auth/login', {\n      method: 'POST',\n      body: 'invalid json',\n      headers: {\n        'Content-Type': 'application/json',\n        'x-forwarded-for': '127.0.0.1',\n        'user-agent': 'test-agent',\n      },\n    });\n\n    const response = await POST(request);\n    \n    // Should return 500 for malformed JSON\n    expect(response.status).toBe(500);\n  });\n\n  it('should test rate limiting with multiple requests', async () => {\n    // Test rate limiting by making multiple requests\n    const requests = Array.from({ length: 5 }, () => \n      new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'wrongpassword',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n          'x-forwarded-for': '127.0.0.1',\n          'user-agent': 'test-agent',\n        },\n      })\n    );\n\n    const responses = await Promise.all(requests.map(request => POST(request)));\n    \n    // Should get 401s for invalid credentials, then 429 for rate limiting\n    const statusCodes = responses.map(r => r.status);\n    expect(statusCodes).toContain(401); // Invalid credentials\n    expect(statusCodes).toContain(429); // Rate limited\n  });\n});\n"],"names":["jest","mock","cookies","fn","get","undefined","set","delete","getSupabaseServerClient","mockResolvedValue","auth","signInWithPassword","data","error","message","from","select","eq","single","describe","it","request","NextRequest","method","body","JSON","stringify","email","password","headers","response","POST","json","expect","status","toBe","requests","Array","length","responses","Promise","all","map","statusCodes","r","toContain"],"mappings":"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"}