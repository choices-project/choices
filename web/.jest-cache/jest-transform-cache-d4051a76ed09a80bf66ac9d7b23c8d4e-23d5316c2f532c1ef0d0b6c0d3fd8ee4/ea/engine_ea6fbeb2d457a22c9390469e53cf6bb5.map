{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/engine.ts"],"sourcesContent":["/**\n * Core Voting Engine\n * \n * This module provides the main voting engine that orchestrates different voting strategies\n * and handles vote processing, validation, and results calculation.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\n\nimport { ApprovalStrategy } from './strategies/approval';\nimport { QuadraticStrategy } from './strategies/quadratic';\nimport { RangeStrategy } from './strategies/range';\nimport { RankedStrategy } from './strategies/ranked';\nimport { SingleChoiceStrategy } from './strategies/single-choice';\nimport type { \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  VotingStrategy,\n  PollData,\n  VoteData,\n  ResultsData,\n  VotingMethod\n} from './types';\n\nexport interface VoteEngineConfig {\n  maxVotesPerPoll: number;\n  allowMultipleVotes: boolean;\n  requireAuthentication: boolean;\n  minTrustTier: string;\n  rateLimitPerUser: number;\n  rateLimitWindowMs: number;\n}\n\nexport class VoteEngine {\n  private strategies: Map<VotingMethod, VotingStrategy>;\n  private config: VoteEngineConfig;\n  private rateLimitTracker: Map<string, { count: number; resetTime: number }>;\n\n  constructor(config: Partial<VoteEngineConfig> = {}) {\n    this.config = Object.assign({\n      maxVotesPerPoll: 10000,\n      allowMultipleVotes: false,\n      requireAuthentication: true,\n      minTrustTier: 'T0',\n      rateLimitPerUser: 10,\n      rateLimitWindowMs: 60000, // 1 minute\n    }, config);\n\n    // Initialize rate limiting tracker\n    this.rateLimitTracker = new Map();\n\n    // Initialize voting strategies\n    this.strategies = new Map([\n      ['single', new SingleChoiceStrategy()],\n      ['single-choice', new SingleChoiceStrategy()],\n      ['approval', new ApprovalStrategy()],\n      ['ranked', new RankedStrategy()],\n      ['ranked-choice', new RankedStrategy()],\n      ['quadratic', new QuadraticStrategy()],\n      ['range', new RangeStrategy()]\n    ]);\n\n    devLog('VoteEngine initialized with strategies:', Array.from(this.strategies.keys()));\n  }\n\n  /**\n   * Get the appropriate voting strategy for a poll\n   */\n  private getStrategy(method: VotingMethod): VotingStrategy {\n    const strategy = this.strategies.get(method);\n    if (!strategy) {\n      throw new Error(`Unsupported voting method: ${method}`);\n    }\n    return strategy;\n  }\n\n  /**\n   * Get voting strategy (public method for testing)\n   */\n  getVotingStrategy(method: VotingMethod): VotingStrategy {\n    return this.getStrategy(method);\n  }\n\n  /**\n   * Save vote to database (for testing)\n   */\n  async saveVote(voteData: VoteData, pollId: string): Promise<string> {\n    // Mock implementation for testing\n    const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    devLog('Vote saved to database', { voteId, pollId });\n    return voteId;\n  }\n\n  /**\n   * Validate a vote request\n   */\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    const startTime = Date.now();\n    \n    try {\n      // Basic validation\n      if (!request.pollId || !request.voteData) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Missing required vote data',\n          errors: ['Missing required vote data'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check poll ID mismatch\n      if (request.pollId !== poll.id) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Poll ID mismatch',\n          errors: ['Poll ID mismatch'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check if poll exists and is active\n      if (!poll || poll.status !== 'active') {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Poll not found or not active',\n          errors: ['Poll is not active'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check poll end time\n      if (poll.endTime && new Date(poll.endTime) < new Date()) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Poll has ended',\n          errors: ['Poll has ended'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check authentication requirements\n      if (this.config.requireAuthentication && !request.userId && !poll.settings?.anonymousVoting) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Authentication required to vote',\n          errors: ['Authentication required to vote'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Validate vote options\n      const optionValidation = this.validateVoteOptions(request.voteData, poll);\n      if (!optionValidation.valid) {\n        return optionValidation;\n      }\n\n      // Check rate limiting\n      if (request.userId) {\n        const rateLimitKey = `${request.userId}:${request.pollId}`;\n        const now = Date.now();\n        const rateLimitData = this.rateLimitTracker.get(rateLimitKey);\n        \n        if (rateLimitData) {\n          if (now < rateLimitData.resetTime) {\n            // Still within the rate limit window\n            if (rateLimitData.count >= this.config.rateLimitPerUser) {\n              return {\n                valid: false,\n                errors: ['Rate limit exceeded. Please try again later.'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          } else {\n            // Window has expired, reset the counter\n            rateLimitData.count = 0;\n            rateLimitData.resetTime = now + this.config.rateLimitWindowMs;\n          }\n        } else {\n          // Initialize rate limit tracking\n          this.rateLimitTracker.set(rateLimitKey, {\n            count: 0,\n            resetTime: now + this.config.rateLimitWindowMs\n          });\n        }\n        \n        // Increment the counter immediately after checking\n        const currentData = this.rateLimitTracker.get(rateLimitKey);\n        if (currentData) {\n          currentData.count++;\n        }\n      }\n\n      // Get the appropriate strategy and validate the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const strategyValidation = await strategy.validateVote(request, poll);\n\n      if (!strategyValidation.valid) {\n        return Object.assign({}, strategyValidation, {\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        });\n      }\n\n      devLog('Vote validation completed', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        valid: true,\n        isValid: true,\n        errors: [],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Vote validation error:', error);\n      return {\n        valid: false,\n        isValid: false,\n        error: error instanceof Error ? error.message : 'Validation failed',\n        errors: [error instanceof Error ? error.message : 'Validation failed'],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n    }\n  }\n\n  /**\n   * Process a vote\n   */\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    const startTime = Date.now();\n    \n    try {\n      // Validate the vote first\n      const validation = await this.validateVote(request, poll);\n      if (!validation.valid) {\n        return {\n            success: false,\n            message: validation.error || validation.errors?.[0] || 'Vote validation failed',\n            error: validation.error || validation.errors?.[0] || 'Vote validation failed',\n            pollId: request.pollId,\n            responseTime: Date.now() - startTime\n        };\n      }\n\n\n      // Get the appropriate strategy and process the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const result = await strategy.processVote(request, poll);\n\n      // Generate audit receipt\n      const auditReceipt = this.generateAuditReceipt(request, poll);\n\n      devLog('Vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        voteId: result.voteId,\n        auditReceipt,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        ...result,\n        auditReceipt,\n        responseTime: Date.now() - startTime\n      };\n\n    } catch (error) {\n      devLog('Vote processing error:', error);\n      return {\n          success: false,\n          message: error instanceof Error ? error.message : 'Vote processing failed',\n          error: error instanceof Error ? error.message : 'Vote processing failed',\n          pollId: request.pollId,\n          responseTime: Date.now() - startTime\n      };\n    }\n  }\n\n  /**\n   * Calculate results for a poll\n   */\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    const startTime = Date.now();\n    \n    try {\n      // Handle empty vote sets\n      if (votes.length === 0) {\n        return {\n          pollId: poll.id,\n          votingMethod: poll.votingMethod,\n          totalVotes: 0,\n          participationRate: 0,\n          results: {\n            winner: undefined,\n            winnerVotes: 0,\n            winnerPercentage: 0,\n            optionVotes: poll.options.reduce((acc, option) => {\n              acc[option.id] = 0;\n              return acc;\n            }, {} as Record<string, number>),\n            optionPercentages: poll.options.reduce((acc, option) => {\n              acc[option.id] = 0;\n              return acc;\n            }, {} as Record<string, number>),\n            abstentions: 0,\n            abstentionPercentage: 0\n          },\n          calculatedAt: new Date().toISOString(),\n          metadata: {\n            calculationTime: Date.now() - startTime,\n            isEmpty: true\n          }\n        };\n      }\n\n      const strategy = this.getStrategy(poll.votingMethod);\n      const results = await strategy.calculateResults(poll, votes);\n\n      devLog('Results calculated successfully', {\n        pollId: poll.id,\n        method: poll.votingMethod,\n        totalVotes: votes.length,\n        duration: Date.now() - startTime\n      });\n\n      return results;\n\n    } catch (error) {\n      devLog('Results calculation error:', error);\n      \n      // Return a basic results structure for unsupported methods\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: votes.length,\n        participationRate: votes.length / 100, // Mock participation rate\n        results: {\n          winner: votes.length > 0 ? poll.options[0]?.id : undefined,\n          winnerVotes: votes.length,\n          winnerPercentage: 100,\n          optionVotes: poll.options.reduce((acc, option) => {\n            acc[option.id] = votes.length;\n            return acc;\n          }, {} as Record<string, number>),\n          optionPercentages: poll.options.reduce((acc, option) => {\n            acc[option.id] = 100;\n            return acc;\n          }, {} as Record<string, number>),\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      };\n    }\n  }\n\n  /**\n   * Validate vote options against poll options\n   */\n  private validateVoteOptions(voteData: VoteRequest['voteData'], poll: PollData): VoteValidation {\n    try {\n      // Check if vote data is valid\n      if (!voteData) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Vote data is required',\n          errors: ['Vote data is required'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Validate based on voting method\n      switch (poll.votingMethod) {\n        case 'single':\n        case 'single-choice':\n          if (typeof voteData.choice !== 'number') {\n            return {\n              valid: false,\n              isValid: false,\n              error: 'Choice is required for single-choice voting',\n              errors: ['Choice is required for single-choice voting'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          if (voteData.choice < 0 || voteData.choice >= poll.options.length) {\n            return {\n              valid: false,\n              isValid: false,\n              error: `Choice must be between 0 and ${poll.options.length - 1}`,\n              errors: ['Invalid option selected'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        case 'approval':\n          if (!Array.isArray(voteData.approvals)) {\n            return {\n              valid: false,\n              errors: ['Approval votes must be an array'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          for (const approval of voteData.approvals) {\n            if (typeof approval !== 'number' || approval < 0 || approval >= poll.options.length) {\n              return {\n                valid: false,\n                errors: ['Invalid option selected'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          }\n          break;\n        \n        case 'ranked':\n        case 'ranked-choice':\n          if (!Array.isArray(voteData.rankings)) {\n            return {\n              valid: false,\n              errors: ['Rankings must be an array'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          for (const ranking of voteData.rankings) {\n            if (typeof ranking !== 'number' || ranking < 0 || ranking >= poll.options.length) {\n              return {\n                valid: false,\n                errors: ['Invalid option selected'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          }\n          break;\n        \n        case 'quadratic':\n          if (!voteData.allocations || typeof voteData.allocations !== 'object') {\n            return {\n              valid: false,\n              errors: ['Quadratic voting requires allocations'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        case 'range':\n          if (!voteData.ratings || typeof voteData.ratings !== 'object') {\n            return {\n              valid: false,\n              errors: ['Range voting requires ratings'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        default:\n          return {\n            valid: false,\n            errors: ['Unsupported voting method'],\n            requiresAuthentication: this.config.requireAuthentication,\n            requiresTokens: false\n          };\n      }\n\n      return {\n        valid: true,\n        isValid: true,\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      return {\n        valid: false,\n        isValid: false,\n        error: 'Vote validation error',\n        errors: ['Vote validation error'],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n    }\n  }\n\n  /**\n   * Generate audit receipt for a vote\n   */\n  private generateAuditReceipt(request: VoteRequest, poll: PollData): string {\n    const timestamp = new Date().toISOString();\n    const voteHash = this.generateVoteHash(request, poll);\n    return `audit_${poll.id}_${request.userId || 'anonymous'}_${timestamp}_${voteHash}`;\n  }\n\n  /**\n   * Generate a hash for vote verification\n   */\n  private generateVoteHash(request: VoteRequest, poll: PollData): string {\n    const voteData = JSON.stringify(request.voteData);\n    const pollData = JSON.stringify({ id: poll.id, method: poll.votingMethod });\n    const combined = `${voteData}_${pollData}_${Date.now()}`;\n    \n    // Simple hash function for testing\n    let hash = 0;\n    for (let i = 0; i < combined.length; i++) {\n      const char = combined.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash; // Convert to 32-bit integer\n    }\n    return Math.abs(hash).toString(36);\n  }\n\n  /**\n   * Get total votes for a poll\n   */\n  totalVotes(pollId: string): number {\n    // This would typically query the database\n    // For testing, return a mock value\n    return 0;\n  }\n\n  /**\n   * Get voting method configuration\n   */\n  getVotingMethodConfig(method: VotingMethod): Record<string, unknown> {\n    const configs = {\n      'single': {\n        name: 'Single Choice Voting',\n        allowsMultipleSelections: false,\n        minOptions: 2,\n        resultType: 'highest_votes'\n      },\n      'single-choice': {\n        name: 'Single Choice Voting',\n        allowsMultipleSelections: false,\n        minOptions: 2,\n        resultType: 'highest_votes'\n      },\n      'approval': {\n        name: 'Approval Voting',\n        allowsMultipleSelections: true,\n        minOptions: 2,\n        resultType: 'highest_votes'\n      },\n      'ranked': {\n        name: 'Ranked Choice Voting',\n        allowsMultipleSelections: false,\n        minOptions: 2,\n        resultType: 'instant_runoff'\n      },\n      'ranked-choice': {\n        name: 'Ranked Choice Voting',\n        allowsMultipleSelections: false,\n        minOptions: 2,\n        resultType: 'instant_runoff'\n      },\n      'quadratic': {\n        name: 'Quadratic Voting',\n        allowsMultipleSelections: true,\n        minOptions: 2,\n        resultType: 'highest_score'\n      },\n      'range': {\n        name: 'Range Voting',\n        allowsMultipleSelections: true,\n        minOptions: 2,\n        resultType: 'highest_average'\n      }\n    };\n\n    return configs[method] || {};\n  }\n\n  /**\n   * Update engine configuration\n   */\n  updateConfig(newConfig: Partial<VoteEngineConfig>): void {\n    this.config = Object.assign({}, this.config, newConfig);\n    devLog('VoteEngine configuration updated:', this.config);\n  }\n\n  /**\n   * Get current configuration\n   */\n  getConfig(): VoteEngineConfig {\n    return { ...this.config };\n  }\n}\n\n// Export a default instance\nexport const voteEngine = new VoteEngine();"],"names":["VoteEngine","voteEngine","constructor","config","Object","assign","maxVotesPerPoll","allowMultipleVotes","requireAuthentication","minTrustTier","rateLimitPerUser","rateLimitWindowMs","rateLimitTracker","Map","strategies","SingleChoiceStrategy","ApprovalStrategy","RankedStrategy","QuadraticStrategy","RangeStrategy","devLog","Array","from","keys","getStrategy","method","strategy","get","Error","getVotingStrategy","saveVote","voteData","pollId","voteId","Date","now","Math","random","toString","substr","validateVote","request","poll","startTime","valid","isValid","error","errors","requiresAuthentication","requiresTokens","id","status","endTime","userId","settings","anonymousVoting","optionValidation","validateVoteOptions","rateLimitKey","rateLimitData","resetTime","count","set","currentData","votingMethod","strategyValidation","duration","message","processVote","validation","success","responseTime","result","auditReceipt","generateAuditReceipt","calculateResults","votes","length","totalVotes","participationRate","results","winner","undefined","winnerVotes","winnerPercentage","optionVotes","options","reduce","acc","option","optionPercentages","abstentions","abstentionPercentage","calculatedAt","toISOString","metadata","calculationTime","isEmpty","choice","isArray","approvals","approval","rankings","ranking","allocations","ratings","timestamp","voteHash","generateVoteHash","JSON","stringify","pollData","combined","hash","i","char","charCodeAt","abs","getVotingMethodConfig","configs","name","allowsMultipleSelections","minOptions","resultType","updateConfig","newConfig","getConfig"],"mappings":"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"}