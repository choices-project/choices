{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/core/auth/idempotency.ts"],"sourcesContent":["/**\n * Idempotency Management System\n * Prevents double-submission attacks and ensures data consistency\n * \n * Features:\n * - UUID-based idempotency keys\n * - Redis-based storage for distributed systems\n * - Automatic cleanup of expired keys\n * - Proper error handling and logging\n */\n\nimport type { SupabaseClient } from '@supabase/supabase-js'\n\nimport { logger } from '@/lib/utils/logger'\nimport { withOptional } from '@/lib/utils/objects'\nimport { getSupabaseServerClient } from '@/utils/supabase/server'\n\nexport interface IdempotencyResult<T> {\n  success: boolean\n  data?: T\n  error?: string\n  isDuplicate: boolean\n}\n\nexport interface IdempotencyOptions {\n  ttl?: number // Time to live in seconds\n  namespace?: string // Namespace for key isolation\n}\n\nconst DEFAULT_OPTIONS: Required<IdempotencyOptions> = {\n  ttl: 60 * 60 * 24, // 24 hours\n  namespace: 'default'\n}\n\n// Initialize Supabase client for idempotency storage\nlet supabase: SupabaseClient | null = null\n\nconst getSupabase = async () => {\n  if (!supabase) {\n    supabase = await getSupabaseServerClient()\n  }\n  return supabase\n}\n\n/**\n * Generate a unique idempotency key\n */\nexport function generateIdempotencyKey(): string {\n  return `idem_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`\n}\n\n/**\n * Create idempotency key with namespace\n */\nexport function createIdempotencyKey(key: string, namespace: string = DEFAULT_OPTIONS.namespace): string {\n  return `${namespace}:${key}`\n}\n\n/**\n * Check if idempotency key exists and is valid\n */\nexport async function checkIdempotencyKey<T = unknown>(\n  key: string, \n  options: IdempotencyOptions = {}\n): Promise<{ exists: boolean; data?: T; error?: string }> {\n  const opts = Object.assign({}, DEFAULT_OPTIONS, options)\n  const fullKey = createIdempotencyKey(key, opts.namespace)\n\n  try {\n    const supabaseClient = await getSupabase()\n    if (!supabaseClient) {\n      return { exists: false, error: 'Failed to initialize Supabase client' }\n    }\n    \n    const { data, error } = await supabaseClient\n      .from('idempotency_keys')\n      .select('*')\n      .eq('key', fullKey)\n      .gt('expires_at', new Date().toISOString())\n      .single()\n\n    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned\n      logger.error('Idempotency key check failed', error, { key: fullKey })\n      return { exists: false, error: 'Database error' }\n    }\n\n    return {\n      exists: !!data,\n      data: data?.result_data\n    }\n  } catch (error) {\n    logger.error('Idempotency key check exception', error instanceof Error ? error : new Error('Unknown error'), { key: fullKey })\n    return { exists: false, error: 'System error' }\n  }\n}\n\n/**\n * Store idempotency key with result data\n */\nexport async function storeIdempotencyKey<T = unknown>(\n  key: string,\n  resultData: T,\n  options: IdempotencyOptions = {}\n): Promise<{ success: boolean; error?: string }> {\n  const opts = Object.assign({}, DEFAULT_OPTIONS, options)\n  const fullKey = createIdempotencyKey(key, opts.namespace)\n  const expiresAt = new Date(Date.now() + opts.ttl * 1000).toISOString()\n\n  try {\n    const supabaseClient = await getSupabase()\n    if (!supabaseClient) {\n      return { success: false, error: 'Failed to initialize Supabase client' }\n    }\n    \n    const { error } = await supabaseClient\n      .from('idempotency_keys')\n      .insert({\n        key: fullKey,\n        result_data: resultData,\n        expires_at: expiresAt,\n        created_at: new Date().toISOString()\n      })\n\n    if (error) {\n      logger.error('Failed to store idempotency key', error, { key: fullKey })\n      return { success: false, error: 'Storage failed' }\n    }\n\n    logger.info('Idempotency key stored', { key: fullKey, expiresAt })\n    return { success: true }\n  } catch (error) {\n    logger.error('Idempotency key storage exception', error instanceof Error ? error : new Error('Unknown error'), { key: fullKey })\n    return { success: false, error: 'System error' }\n  }\n}\n\n/**\n * Execute function with idempotency protection\n */\nexport async function withIdempotency<T>(\n  key: string,\n  operation: () => Promise<T>,\n  options: IdempotencyOptions = {}\n): Promise<IdempotencyResult<T>> {\n  const opts = Object.assign({}, DEFAULT_OPTIONS, options)\n\n  // Check if key already exists\n  const checkResult = await checkIdempotencyKey<T>(key, opts)\n  \n  if (checkResult.error) {\n    return {\n      success: false,\n      error: checkResult.error,\n      isDuplicate: false\n    }\n  }\n\n  if (checkResult.exists) {\n    logger.info('Idempotency key found, returning cached result', { key })\n    return withOptional({\n      success: true,\n      isDuplicate: true\n    }, {\n      data: checkResult.data\n    })\n  }\n\n  // Execute operation\n  try {\n    const result = await operation()\n    \n    // Store result for future requests\n    const storeResult = await storeIdempotencyKey(key, result, opts)\n    \n    if (!storeResult.success) {\n      logger.warn('Failed to store idempotency result, but operation succeeded', { \n        key, \n        error: storeResult.error \n      })\n    }\n\n    return {\n      success: true,\n      data: result,\n      isDuplicate: false\n    }\n  } catch (error) {\n    logger.error('Operation failed during idempotency execution', error instanceof Error ? error : new Error('Unknown error'), { key })\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Operation failed',\n      isDuplicate: false\n    }\n  }\n}\n\n/**\n * Clean up expired idempotency keys\n */\nexport async function cleanupExpiredIdempotencyKeys(): Promise<{ deleted: number; error?: string }> {\n  try {\n    const client = await getSupabase()\n    if (!client) {\n      return { deleted: 0, error: 'Failed to initialize Supabase client' }\n    }\n    \n    const { count, error } = await client\n      .from('idempotency_keys')\n      .delete()\n      .lt('expires_at', new Date().toISOString())\n      .select('*')\n\n    if (error) {\n      logger.error('Failed to cleanup expired idempotency keys', error)\n      return { deleted: 0, error: 'Cleanup failed' }\n    }\n\n    logger.info('Cleaned up expired idempotency keys', { deleted: count || 0 })\n    return { deleted: count || 0 }\n  } catch (error) {\n    logger.error('Idempotency cleanup exception', error instanceof Error ? error : new Error('Unknown error'))\n    return { deleted: 0, error: 'System error' }\n  }\n}\n\n/**\n * Validate idempotency key format\n */\nexport function validateIdempotencyKey(key: string): boolean {\n  // Basic validation - should be a valid UUID or our custom format\n  const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i\n  const customRegex = /^idem_\\d+_[a-z0-9]+$/i\n  \n  return uuidRegex.test(key) || customRegex.test(key)\n}\n\n/**\n * Get idempotency key statistics\n */\nexport async function getIdempotencyStats(): Promise<{\n  total: number\n  expired: number\n  active: number\n  error?: string\n}> {\n  try {\n    const client = await getSupabase()\n    if (!client) {\n      return { total: 0, expired: 0, active: 0, error: 'Failed to initialize Supabase client' }\n    }\n    \n    const now = new Date().toISOString()\n    \n    const { count: total, error: totalError } = await client\n      .from('idempotency_keys')\n      .select('*', { count: 'exact', head: true })\n\n    if (totalError) {\n      logger.error('Failed to get total idempotency keys', totalError)\n      return { total: 0, expired: 0, active: 0, error: 'Query failed' }\n    }\n\n    const { count: expired, error: expiredError } = await client\n      .from('idempotency_keys')\n      .select('*', { count: 'exact', head: true })\n      .lt('expires_at', now)\n\n    if (expiredError) {\n      logger.error('Failed to get expired idempotency keys', expiredError)\n      return { total: 0, expired: 0, active: 0, error: 'Query failed' }\n    }\n\n    const active = (total || 0) - (expired || 0)\n\n    return {\n      total: total || 0,\n      expired: expired || 0,\n      active: Math.max(0, active)\n    }\n  } catch (error) {\n    logger.error('Idempotency stats exception', error instanceof Error ? error : new Error('Unknown error'))\n    return { total: 0, expired: 0, active: 0, error: 'System error' }\n  }\n}\n"],"names":["checkIdempotencyKey","cleanupExpiredIdempotencyKeys","createIdempotencyKey","generateIdempotencyKey","getIdempotencyStats","storeIdempotencyKey","validateIdempotencyKey","withIdempotency","DEFAULT_OPTIONS","ttl","namespace","supabase","getSupabase","getSupabaseServerClient","Date","now","Math","random","toString","substring","key","options","opts","Object","assign","fullKey","supabaseClient","exists","error","data","from","select","eq","gt","toISOString","single","code","logger","result_data","Error","resultData","expiresAt","success","insert","expires_at","created_at","info","operation","checkResult","isDuplicate","withOptional","result","storeResult","warn","message","client","deleted","count","delete","lt","uuidRegex","customRegex","test","total","expired","active","totalError","head","expiredError","max"],"mappings":"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"}