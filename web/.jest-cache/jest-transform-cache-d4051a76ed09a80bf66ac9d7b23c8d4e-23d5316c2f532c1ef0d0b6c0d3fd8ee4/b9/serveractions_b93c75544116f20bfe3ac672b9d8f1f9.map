{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/core/auth/server-actions.ts"],"sourcesContent":["/**\n * Server Actions Enhancement Module\n * Comprehensive security and reliability enhancements for Server Actions\n * \n * Features:\n * - Idempotency key generation and validation\n * - Session management integration\n * - Proper error handling and validation\n * - Security logging and monitoring\n * - Rate limiting integration\n * \n * Created: 2025-08-27\n * Status: Critical security enhancement\n */\n\nimport { redirect } from 'next/navigation'\nimport { z } from 'zod'\n\nimport { \n  withIdempotency, \n  generateIdempotencyKey,\n  type IdempotencyOptions \n} from '@/lib/core/auth/idempotency'\nimport { getSecurityConfig } from '@/lib/core/security/config'\nimport { logger } from '@/lib/utils/logger'\n\n// Common validation schemas\nexport const BaseActionSchema = z.object({\n  idempotencyKey: z.string().uuid('Invalid idempotency key').optional()\n})\n\nexport const UsernameSchema = z.string()\n  .min(1, 'Username is required')\n  .max(20, 'Username must be 20 characters or less')\n  .regex(/^[a-zA-Z0-9_-]+$/, 'Username can only contain letters, numbers, underscores, and hyphens')\n\nexport const EmailSchema = z.string()\n  .email('Invalid email address')\n  .optional()\n\n// Server Action wrapper with security features\nexport interface ServerActionOptions {\n  requireAuth?: boolean\n  requireAdmin?: boolean\n  idempotency?: IdempotencyOptions\n  sessionRotation?: boolean\n  validation?: z.ZodSchema\n  rateLimit?: {\n    endpoint: string\n    maxRequests: number\n  }\n}\n\nexport interface ServerActionContext {\n  userId?: string\n  userRole?: string\n  sessionToken?: string\n  ipAddress?: string\n  userAgent?: string\n}\n\n/**\n * Enhanced Server Action wrapper with security features\n */\nexport function createSecureServerAction<TInput, TOutput>(\n  action: (input: TInput, context: ServerActionContext) => Promise<TOutput>,\n  options: ServerActionOptions = {}\n) {\n  return async (input: TInput): Promise<TOutput> => {\n    const idempotencyKey = generateIdempotencyKey()\n    const securityConfig = getSecurityConfig()\n    \n    const result = await withIdempotency(idempotencyKey, async () => {\n      try {\n        // Validate input if schema provided\n        if (options.validation) {\n          const validatedInput = options.validation.parse(Object.assign({}, input, {\n            idempotencyKey\n          }))\n          input = validatedInput as TInput\n        }\n\n        // Create context for the action\n        const context: ServerActionContext = {\n          ipAddress: 'unknown', // Will be set by middleware\n          userAgent: 'unknown', // Will be set by middleware\n        }\n\n        // Execute the action\n        const result = await action(input, context)\n\n        // Use Supabase native session management\n        // Supabase handles session cookies automatically\n        // No need for custom JWT session tokens\n\n        // Log successful action\n        logger.info('Server action completed successfully', {\n          action: action.name,\n          userId: context.userId,\n          ipAddress: securityConfig.privacy.anonymizeIPs ? 'anonymized' : context.ipAddress,\n          timestamp: new Date().toISOString()\n        })\n\n        return result\n      } catch (error) {\n        // Log error with context\n        logger.error('Server action failed', error instanceof Error ? error : new Error('Unknown error'), {\n          action: action.name,\n          input: JSON.stringify(input),\n          timestamp: new Date().toISOString()\n        })\n\n        // Re-throw for proper error handling\n        throw error\n      }\n    }, options.idempotency || { namespace: 'server-action' })\n    \n    if (result.success && result.data) {\n      return result.data\n    }\n    \n    throw new Error('Server action failed')\n  }\n}\n\n/**\n * Authentication helper for server actions\n */\nexport async function getAuthenticatedUser(context: ServerActionContext): Promise<{\n  userId: string\n  userRole: string\n  sessionToken: string\n}> {\n  // This would integrate with your session verification\n  // For now, we'll throw an error if no user context\n  if (!context.userId || !context.sessionToken) {\n    throw new Error('Authentication required')\n  }\n\n  return {\n    userId: context.userId,\n    userRole: context.userRole || 'user',\n    sessionToken: context.sessionToken\n  }\n}\n\n/**\n * Admin authorization helper\n */\nexport async function requireAdmin(context: ServerActionContext): Promise<{\n  userId: string\n  userRole: string\n  sessionToken: string\n}> {\n  const user = await getAuthenticatedUser(context)\n  \n  if (user.userRole !== 'admin') {\n    logger.warn('Unauthorized admin access attempt', {\n      userId: user.userId,\n      userRole: user.userRole,\n      timestamp: new Date().toISOString()\n    })\n    throw new Error('Admin access required')\n  }\n\n  return user\n}\n\n/**\n * Secure redirect helper with session management\n */\nexport function secureRedirect(url: string) {\n  // Use Supabase native session management\n  // Supabase handles session cookies automatically\n  redirect(url)\n}\n\n/**\n * Logout helper with session cleanup\n */\nexport function secureLogout() {\n  // Use Supabase native session management\n  // Supabase handles session cookies automatically\n  redirect('/')\n}\n\n/**\n * Form data validation helper\n */\nexport function validateFormData<T>(\n  formData: FormData, \n  schema: z.ZodSchema<T>\n): T {\n  const rawData = Object.fromEntries(formData.entries())\n  \n  try {\n    return schema.parse(rawData)\n  } catch (error) {\n    if (error instanceof z.ZodError) {\n      const zodError = error\n      const fieldErrors: Record<string, string> = {}\n      \n      zodError.issues.forEach((issue) => {\n        const field = issue.path.join('.')\n        fieldErrors[field] = issue.message\n      })\n      \n      throw new Error(`Validation failed: ${JSON.stringify(fieldErrors)}`)\n    }\n    throw error\n  }\n}\n\n/**\n * Rate limiting helper for server actions\n */\nexport function checkRateLimit(\n  endpoint: string, \n  userId?: string, \n  ipAddress?: string\n): boolean {\n  const securityConfig = getSecurityConfig()\n  const _key = userId || ipAddress || 'anonymous'\n  \n  // Check against security config for rate limiting\n  const _maxRequests = securityConfig.rateLimit.sensitiveEndpoints[endpoint] || \n                     securityConfig.rateLimit.maxRequests\n  \n  logger.debug(`Rate limit check for ${endpoint} with key: ${_key}`)\n  return true\n}\n\n/**\n * Security audit logging for sensitive operations\n */\nexport function logSecurityEvent(\n  event: string,\n  details: Record<string, unknown>,\n  context: ServerActionContext\n) {\n  const securityConfig = getSecurityConfig()\n  \n  logger.info(`Security Event: ${event}`, Object.assign({}, details, {\n    userId: context.userId,\n    userRole: context.userRole,\n    ipAddress: securityConfig.privacy.anonymizeIPs ? 'anonymized' : context.ipAddress,\n    userAgent: securityConfig.privacy.logSensitiveData ? context.userAgent : 'anonymized',\n    timestamp: new Date().toISOString()\n  }))\n}\n\n/**\n * Input sanitization helper\n */\nexport function sanitizeInput(input: string): string {\n  // Remove potentially dangerous characters and patterns\n  return input\n    .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n    .replace(/javascript:/gi, '')\n    .replace(/on\\w+\\s*=/gi, '')\n    .trim()\n}\n\n/**\n * Error response helper\n */\nexport function createErrorResponse(\n  message: string, \n  statusCode: number = 400,\n  details?: Record<string, unknown>\n) {\n  return {\n    error: true,\n    message,\n    statusCode,\n    details,\n    timestamp: new Date().toISOString()\n  }\n}\n\n/**\n * Success response helper\n */\nexport function createSuccessResponse<T>(\n  data: T, \n  message?: string\n) {\n  return {\n    success: true,\n    data,\n    message,\n    timestamp: new Date().toISOString()\n  }\n}\n"],"names":["BaseActionSchema","EmailSchema","UsernameSchema","checkRateLimit","createErrorResponse","createSecureServerAction","createSuccessResponse","getAuthenticatedUser","logSecurityEvent","requireAdmin","sanitizeInput","secureLogout","secureRedirect","validateFormData","z","object","idempotencyKey","string","uuid","optional","min","max","regex","email","action","options","input","generateIdempotencyKey","securityConfig","getSecurityConfig","result","withIdempotency","validation","validatedInput","parse","Object","assign","context","ipAddress","userAgent","logger","info","name","userId","privacy","anonymizeIPs","timestamp","Date","toISOString","error","Error","JSON","stringify","idempotency","namespace","success","data","sessionToken","userRole","user","warn","url","redirect","formData","schema","rawData","fromEntries","entries","ZodError","zodError","fieldErrors","issues","forEach","issue","field","path","join","message","endpoint","_key","_maxRequests","rateLimit","sensitiveEndpoints","maxRequests","debug","event","details","logSensitiveData","replace","trim","statusCode"],"mappings":"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"}