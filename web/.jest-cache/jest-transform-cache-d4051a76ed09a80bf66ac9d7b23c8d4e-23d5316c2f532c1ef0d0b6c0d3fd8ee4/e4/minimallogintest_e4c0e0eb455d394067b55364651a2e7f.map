{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/auth/minimal-login.test.ts"],"sourcesContent":["/**\n * Minimal Login Route Test\n */\n\nimport { NextRequest } from 'next/server';\nimport { POST } from '@/app/api/auth/login/route';\n\n// Mock Next.js headers\njest.mock('next/headers', () => ({\n  cookies: jest.fn(() => ({\n    get: jest.fn(),\n    set: jest.fn(),\n    delete: jest.fn(),\n  })),\n}));\n\n// Mock all dependencies with minimal setup\njest.mock('@/utils/supabase/server', () => ({\n  getSupabaseServerClient: jest.fn(),\n}));\n\njest.mock('@/lib/utils/logger', () => ({\n  logger: {\n    info: jest.fn(),\n    error: jest.fn(),\n    warn: jest.fn(),\n  },\n}));\n\njest.mock('@/lib/core/security/rate-limit', () => ({\n  rateLimiters: {\n    auth: {\n      check: jest.fn().mockResolvedValue({ \n        allowed: true, \n        success: true,\n        remaining: 10,\n        resetTime: new Date(),\n        retryAfter: null\n      })\n    }\n  }\n}));\n\njest.mock('@/app/api/auth/_shared', () => ({\n  validateCsrfProtection: jest.fn().mockReturnValue(true),\n  createCsrfErrorResponse: jest.fn().mockReturnValue(\n    new Response(JSON.stringify({ error: 'CSRF token validation failed' }), { status: 403 })\n  )\n}));\n\ndescribe('Minimal Login Route', () => {\n  beforeEach(() => {\n    // Set required environment variables\n    process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY = 'test-anon-key';\n    process.env.SUPABASE_SECRET_KEY = 'test-secret-key';\n  });\n\n  it('should return a response', async () => {\n    const { getSupabaseServerClient } = require('@/utils/supabase/server');\n    \n    // Mock Supabase client to return a simple response\n    getSupabaseServerClient.mockResolvedValue({\n      auth: {\n        signInWithPassword: jest.fn().mockResolvedValue({\n          data: {\n            user: { id: 'user-123', email: 'test@example.com' },\n            session: { access_token: 'token' }\n          },\n          error: null,\n        }),\n      },\n      from: jest.fn(() => ({\n        select: jest.fn(() => ({\n          eq: jest.fn(() => ({\n            single: jest.fn().mockResolvedValue({\n              data: { id: 'user-123', is_active: true, username: 'testuser' },\n              error: null,\n            }),\n          })),\n        })),\n      })),\n    });\n\n    const request = new NextRequest('http://localhost:3000/api/auth/login', {\n      method: 'POST',\n      body: JSON.stringify({\n        email: 'test@example.com',\n        password: 'password123',\n      }),\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n\n    try {\n      const response = await POST(request);\n      console.log('Response:', response);\n      expect(response).toBeDefined();\n      expect(response).toBeInstanceOf(Response);\n      expect(response.status).toBe(200);\n    } catch (error) {\n      console.error('Error in POST:', error);\n      throw error;\n    }\n  });\n});\n"],"names":["jest","mock","cookies","fn","get","set","delete","getSupabaseServerClient","logger","info","error","warn","rateLimiters","auth","check","mockResolvedValue","allowed","success","remaining","resetTime","Date","retryAfter","validateCsrfProtection","mockReturnValue","createCsrfErrorResponse","Response","JSON","stringify","status","describe","beforeEach","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_SECRET_KEY","it","require","signInWithPassword","data","user","id","email","session","access_token","from","select","eq","single","is_active","username","request","NextRequest","method","body","password","headers","response","POST","console","log","expect","toBeDefined","toBeInstanceOf","toBe"],"mappings":"AAAA;;CAEC;AAKD,uBAAuB;AACvBA,KAAKC,IAAI,CAAC,gBAAgB,IAAO,CAAA;QAC/BC,SAASF,KAAKG,EAAE,CAAC,IAAO,CAAA;gBACtBC,KAAKJ,KAAKG,EAAE;gBACZE,KAAKL,KAAKG,EAAE;gBACZG,QAAQN,KAAKG,EAAE;YACjB,CAAA;IACF,CAAA;AAEA,2CAA2C;AAC3CH,KAAKC,IAAI,CAAC,2BAA2B,IAAO,CAAA;QAC1CM,yBAAyBP,KAAKG,EAAE;IAClC,CAAA;AAEAH,KAAKC,IAAI,CAAC,sBAAsB,IAAO,CAAA;QACrCO,QAAQ;YACNC,MAAMT,KAAKG,EAAE;YACbO,OAAOV,KAAKG,EAAE;YACdQ,MAAMX,KAAKG,EAAE;QACf;IACF,CAAA;AAEAH,KAAKC,IAAI,CAAC,kCAAkC,IAAO,CAAA;QACjDW,cAAc;YACZC,MAAM;gBACJC,OAAOd,KAAKG,EAAE,GAAGY,iBAAiB,CAAC;oBACjCC,SAAS;oBACTC,SAAS;oBACTC,WAAW;oBACXC,WAAW,IAAIC;oBACfC,YAAY;gBACd;YACF;QACF;IACF,CAAA;AAEArB,KAAKC,IAAI,CAAC,0BAA0B,IAAO,CAAA;QACzCqB,wBAAwBtB,KAAKG,EAAE,GAAGoB,eAAe,CAAC;QAClDC,yBAAyBxB,KAAKG,EAAE,GAAGoB,eAAe,CAChD,IAAIE,SAASC,KAAKC,SAAS,CAAC;YAAEjB,OAAO;QAA+B,IAAI;YAAEkB,QAAQ;QAAI;IAE1F,CAAA;;;;wBA5C4B;uBACP;AA6CrBC,SAAS,uBAAuB;IAC9BC,WAAW;QACT,qCAAqC;QACrCC,QAAQC,GAAG,CAACC,wBAAwB,GAAG;QACvCF,QAAQC,GAAG,CAACE,6BAA6B,GAAG;QAC5CH,QAAQC,GAAG,CAACG,mBAAmB,GAAG;IACpC;IAEAC,GAAG,4BAA4B;QAC7B,MAAM,EAAE7B,uBAAuB,EAAE,GAAG8B,QAAQ;QAE5C,mDAAmD;QACnD9B,wBAAwBQ,iBAAiB,CAAC;YACxCF,MAAM;gBACJyB,oBAAoBtC,KAAKG,EAAE,GAAGY,iBAAiB,CAAC;oBAC9CwB,MAAM;wBACJC,MAAM;4BAAEC,IAAI;4BAAYC,OAAO;wBAAmB;wBAClDC,SAAS;4BAAEC,cAAc;wBAAQ;oBACnC;oBACAlC,OAAO;gBACT;YACF;YACAmC,MAAM7C,KAAKG,EAAE,CAAC,IAAO,CAAA;oBACnB2C,QAAQ9C,KAAKG,EAAE,CAAC,IAAO,CAAA;4BACrB4C,IAAI/C,KAAKG,EAAE,CAAC,IAAO,CAAA;oCACjB6C,QAAQhD,KAAKG,EAAE,GAAGY,iBAAiB,CAAC;wCAClCwB,MAAM;4CAAEE,IAAI;4CAAYQ,WAAW;4CAAMC,UAAU;wCAAW;wCAC9DxC,OAAO;oCACT;gCACF,CAAA;wBACF,CAAA;gBACF,CAAA;QACF;QAEA,MAAMyC,UAAU,IAAIC,mBAAW,CAAC,wCAAwC;YACtEC,QAAQ;YACRC,MAAM5B,KAAKC,SAAS,CAAC;gBACnBe,OAAO;gBACPa,UAAU;YACZ;YACAC,SAAS;gBACP,gBAAgB;YAClB;QACF;QAEA,IAAI;YACF,MAAMC,WAAW,MAAMC,IAAAA,WAAI,EAACP;YAC5BQ,QAAQC,GAAG,CAAC,aAAaH;YACzBI,OAAOJ,UAAUK,WAAW;YAC5BD,OAAOJ,UAAUM,cAAc,CAACtC;YAChCoC,OAAOJ,SAAS7B,MAAM,EAAEoC,IAAI,CAAC;QAC/B,EAAE,OAAOtD,OAAO;YACdiD,QAAQjD,KAAK,CAAC,kBAAkBA;YAChC,MAAMA;QACR;IACF;AACF"}