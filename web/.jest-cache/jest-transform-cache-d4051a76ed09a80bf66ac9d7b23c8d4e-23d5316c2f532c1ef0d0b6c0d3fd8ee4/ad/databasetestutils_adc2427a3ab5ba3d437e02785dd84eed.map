{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/helpers/database-test-utils.ts"],"sourcesContent":["/**\n * Database Test Utilities\n * \n * Comprehensive utilities for testing database operations with proper\n * setup, teardown, and realistic test scenarios.\n */\n\n/**\n * Setup test database with proper configuration\n */\nexport const setupTestDatabase = async () => {\n  // Mock Supabase client for testing\n  const mockSupabaseClient = {\n    auth: {\n      signInWithPassword: jest.fn(),\n      signUp: jest.fn(),\n      signOut: jest.fn(),\n      getUser: jest.fn(),\n      getSession: jest.fn()\n    },\n    from: jest.fn().mockReturnValue({\n      select: jest.fn().mockReturnValue({\n        eq: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: null,\n            error: null\n          }),\n          limit: jest.fn().mockResolvedValue({\n            data: [],\n            error: null\n          })\n        }),\n        limit: jest.fn().mockResolvedValue({\n          data: [],\n          error: null\n        })\n      }),\n      insert: jest.fn().mockResolvedValue({\n        data: [{ id: 'test-id' }],\n        error: null\n      }),\n      update: jest.fn().mockReturnValue({\n        eq: jest.fn().mockResolvedValue({\n          data: [{ id: 'test-id' }],\n          error: null\n        })\n      }),\n      delete: jest.fn().mockReturnValue({\n        eq: jest.fn().mockResolvedValue({\n          data: [],\n          error: null\n        })\n      })\n    })\n  };\n\n  // Mock environment variables\n  process.env.NEXT_PUBLIC_SUPABASE_URL = 'https://test.supabase.co';\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY = 'test-anon-key';\n  process.env.SUPABASE_SERVICE_ROLE_KEY = 'test-service-role-key';\n\n  return mockSupabaseClient;\n};\n\n/**\n * Create test user with proper credentials\n */\nexport const createTestUser = async () => {\n  const testUser = {\n    id: 'test-user-id',\n    email: 'test@example.com',\n    password: 'test-password',\n    profile: {\n      id: 'test-profile-id',\n      user_id: 'test-user-id',\n      username: 'testuser',\n      display_name: 'Test User',\n      created_at: new Date().toISOString(),\n      updated_at: new Date().toISOString()\n    }\n  };\n\n  return testUser;\n};\n\n/**\n * Create test poll data\n */\nexport const createTestPoll = () => ({\n  id: 'test-poll-id',\n  title: 'Test Poll',\n  description: 'This is a test poll',\n  options: [\n    { id: 'option-1', text: 'Option 1' },\n    { id: 'option-2', text: 'Option 2' }\n  ],\n  voting_method: 'single-choice',\n  status: 'active',\n  created_at: new Date().toISOString(),\n  updated_at: new Date().toISOString(),\n  created_by: 'test-user-id'\n});\n\n/**\n * Create test vote data\n */\nexport const createTestVote = () => ({\n  id: 'test-vote-id',\n  poll_id: 'test-poll-id',\n  user_id: 'test-user-id',\n  choice: 'option-1',\n  created_at: new Date().toISOString()\n});\n\n/**\n * Mock authentication for tests\n */\nexport const mockAuthentication = async (supabaseClient: any, testUser: any) => {\n  // Mock successful authentication\n  supabaseClient.auth.signInWithPassword.mockResolvedValue({\n    data: {\n      user: testUser,\n      session: {\n        access_token: 'test-access-token',\n        refresh_token: 'test-refresh-token',\n        user: testUser\n      }\n    },\n    error: null\n  });\n\n  // Mock get user\n  supabaseClient.auth.getUser.mockResolvedValue({\n    data: { user: testUser },\n    error: null\n  });\n\n  // Mock get session\n  supabaseClient.auth.getSession.mockResolvedValue({\n    data: {\n      session: {\n        access_token: 'test-access-token',\n        refresh_token: 'test-refresh-token',\n        user: testUser\n      }\n    },\n    error: null\n  });\n\n  return testUser;\n};\n\n/**\n * Mock database operations for polls\n */\nexport const mockPollOperations = (supabaseClient: any) => {\n  const pollsTable = supabaseClient.from('polls');\n  \n  // Mock poll creation\n  pollsTable.insert.mockResolvedValue({\n    data: [{ id: 'test-poll-id' }],\n    error: null\n  });\n\n  // Mock poll retrieval\n  pollsTable.select.mockReturnValue({\n    eq: jest.fn().mockReturnValue({\n      single: jest.fn().mockResolvedValue({\n        data: {\n          id: 'test-poll-id',\n          title: 'Test Poll',\n          status: 'active'\n        },\n        error: null\n      }),\n      limit: jest.fn().mockResolvedValue({\n        data: [\n          {\n            id: 'test-poll-id',\n            title: 'Test Poll',\n            status: 'active'\n          }\n        ],\n        error: null\n      })\n    })\n  });\n\n  return pollsTable;\n};\n\n/**\n * Mock database operations for votes\n */\nexport const mockVoteOperations = (supabaseClient: any) => {\n  const votesTable = supabaseClient.from('votes');\n  \n  // Mock vote creation\n  votesTable.insert.mockResolvedValue({\n    data: [{ id: 'test-vote-id' }],\n    error: null\n  });\n\n  // Mock vote retrieval\n  votesTable.select.mockReturnValue({\n    eq: jest.fn().mockReturnValue({\n      limit: jest.fn().mockResolvedValue({\n        data: [\n          {\n            id: 'test-vote-id',\n            poll_id: 'test-poll-id',\n            user_id: 'test-user-id',\n            choice: 'option-1'\n          }\n        ],\n        error: null\n      })\n    })\n  });\n\n  return votesTable;\n};\n\n/**\n * Mock database errors for testing error handling\n */\nexport const mockDatabaseError = (supabaseClient: any, errorType: 'connection' | 'auth' | 'permission' | 'validation') => {\n  const errorMessages = {\n    connection: 'Database connection failed',\n    auth: 'Authentication failed',\n    permission: 'Insufficient permissions',\n    validation: 'Validation failed'\n  };\n\n  const error = new Error(errorMessages[errorType]);\n  \n  // Mock error for all operations\n  supabaseClient.from.mockReturnValue({\n    select: jest.fn().mockReturnValue({\n      eq: jest.fn().mockReturnValue({\n        single: jest.fn().mockResolvedValue({\n          data: null,\n          error\n        }),\n        limit: jest.fn().mockResolvedValue({\n          data: null,\n          error\n        })\n      })\n    }),\n    insert: jest.fn().mockResolvedValue({\n      data: null,\n      error\n    }),\n    update: jest.fn().mockReturnValue({\n      eq: jest.fn().mockResolvedValue({\n        data: null,\n        error\n      })\n    }),\n    delete: jest.fn().mockReturnValue({\n      eq: jest.fn().mockResolvedValue({\n        data: null,\n        error\n      })\n    })\n  });\n\n  return error;\n};\n\n/**\n * Clean up test database after tests\n */\nexport const cleanupTestDatabase = async () => {\n  // Clear all mocks\n  jest.clearAllMocks();\n  \n  // Reset environment variables\n  delete process.env.NEXT_PUBLIC_SUPABASE_URL;\n  delete process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n  delete process.env.SUPABASE_SERVICE_ROLE_KEY;\n};\n\n/**\n * Test database connection\n */\nexport const testDatabaseConnection = async (supabaseClient: any) => {\n  try {\n    // Test basic connection\n    const result = await supabaseClient.from('polls').select('id').limit(1);\n    return result.error === null;\n  } catch (error) {\n    return false;\n  }\n};\n\n/**\n * Test authentication flow\n */\nexport const testAuthenticationFlow = async (supabaseClient: any, testUser: any) => {\n  try {\n    // Test sign in\n    const signInResult = await supabaseClient.auth.signInWithPassword({\n      email: testUser.email,\n      password: testUser.password\n    });\n    \n    if (signInResult.error) {\n      return false;\n    }\n    \n    // Test get user\n    const userResult = await supabaseClient.auth.getUser();\n    \n    if (userResult.error) {\n      return false;\n    }\n    \n    return true;\n  } catch (error) {\n    return false;\n  }\n};\n"],"names":["cleanupTestDatabase","createTestPoll","createTestUser","createTestVote","mockAuthentication","mockDatabaseError","mockPollOperations","mockVoteOperations","setupTestDatabase","testAuthenticationFlow","testDatabaseConnection","mockSupabaseClient","auth","signInWithPassword","jest","fn","signUp","signOut","getUser","getSession","from","mockReturnValue","select","eq","single","mockResolvedValue","data","error","limit","insert","id","update","delete","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_SERVICE_ROLE_KEY","testUser","email","password","profile","user_id","username","display_name","created_at","Date","toISOString","updated_at","title","description","options","text","voting_method","status","created_by","poll_id","choice","supabaseClient","user","session","access_token","refresh_token","pollsTable","votesTable","errorType","errorMessages","connection","permission","validation","Error","clearAllMocks","result","signInResult","userResult"],"mappings":"AAAA;;;;;CAKC,GAED;;CAEC;;;;;;;;;;;IAyQYA,mBAAmB;eAAnBA;;IA1LAC,cAAc;eAAdA;;IArBAC,cAAc;eAAdA;;IAuCAC,cAAc;eAAdA;;IAWAC,kBAAkB;eAAlBA;;IA6GAC,iBAAiB;eAAjBA;;IAvEAC,kBAAkB;eAAlBA;;IAuCAC,kBAAkB;eAAlBA;;IAxLAC,iBAAiB;eAAjBA;;IAkSAC,sBAAsB;eAAtBA;;IAbAC,sBAAsB;eAAtBA;;;AArRN,MAAMF,oBAAoB;IAC/B,mCAAmC;IACnC,MAAMG,qBAAqB;QACzBC,MAAM;YACJC,oBAAoBC,KAAKC,EAAE;YAC3BC,QAAQF,KAAKC,EAAE;YACfE,SAASH,KAAKC,EAAE;YAChBG,SAASJ,KAAKC,EAAE;YAChBI,YAAYL,KAAKC,EAAE;QACrB;QACAK,MAAMN,KAAKC,EAAE,GAAGM,eAAe,CAAC;YAC9BC,QAAQR,KAAKC,EAAE,GAAGM,eAAe,CAAC;gBAChCE,IAAIT,KAAKC,EAAE,GAAGM,eAAe,CAAC;oBAC5BG,QAAQV,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;wBAClCC,MAAM;wBACNC,OAAO;oBACT;oBACAC,OAAOd,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;wBACjCC,MAAM,EAAE;wBACRC,OAAO;oBACT;gBACF;gBACAC,OAAOd,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;oBACjCC,MAAM,EAAE;oBACRC,OAAO;gBACT;YACF;YACAE,QAAQf,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;gBAClCC,MAAM;oBAAC;wBAAEI,IAAI;oBAAU;iBAAE;gBACzBH,OAAO;YACT;YACAI,QAAQjB,KAAKC,EAAE,GAAGM,eAAe,CAAC;gBAChCE,IAAIT,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;oBAC9BC,MAAM;wBAAC;4BAAEI,IAAI;wBAAU;qBAAE;oBACzBH,OAAO;gBACT;YACF;YACAK,QAAQlB,KAAKC,EAAE,GAAGM,eAAe,CAAC;gBAChCE,IAAIT,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;oBAC9BC,MAAM,EAAE;oBACRC,OAAO;gBACT;YACF;QACF;IACF;IAEA,6BAA6B;IAC7BM,QAAQC,GAAG,CAACC,wBAAwB,GAAG;IACvCF,QAAQC,GAAG,CAACE,6BAA6B,GAAG;IAC5CH,QAAQC,GAAG,CAACG,yBAAyB,GAAG;IAExC,OAAO1B;AACT;AAKO,MAAMT,iBAAiB;IAC5B,MAAMoC,WAAW;QACfR,IAAI;QACJS,OAAO;QACPC,UAAU;QACVC,SAAS;YACPX,IAAI;YACJY,SAAS;YACTC,UAAU;YACVC,cAAc;YACdC,YAAY,IAAIC,OAAOC,WAAW;YAClCC,YAAY,IAAIF,OAAOC,WAAW;QACpC;IACF;IAEA,OAAOT;AACT;AAKO,MAAMrC,iBAAiB,IAAO,CAAA;QACnC6B,IAAI;QACJmB,OAAO;QACPC,aAAa;QACbC,SAAS;YACP;gBAAErB,IAAI;gBAAYsB,MAAM;YAAW;YACnC;gBAAEtB,IAAI;gBAAYsB,MAAM;YAAW;SACpC;QACDC,eAAe;QACfC,QAAQ;QACRT,YAAY,IAAIC,OAAOC,WAAW;QAClCC,YAAY,IAAIF,OAAOC,WAAW;QAClCQ,YAAY;IACd,CAAA;AAKO,MAAMpD,iBAAiB,IAAO,CAAA;QACnC2B,IAAI;QACJ0B,SAAS;QACTd,SAAS;QACTe,QAAQ;QACRZ,YAAY,IAAIC,OAAOC,WAAW;IACpC,CAAA;AAKO,MAAM3C,qBAAqB,OAAOsD,gBAAqBpB;IAC5D,iCAAiC;IACjCoB,eAAe9C,IAAI,CAACC,kBAAkB,CAACY,iBAAiB,CAAC;QACvDC,MAAM;YACJiC,MAAMrB;YACNsB,SAAS;gBACPC,cAAc;gBACdC,eAAe;gBACfH,MAAMrB;YACR;QACF;QACAX,OAAO;IACT;IAEA,gBAAgB;IAChB+B,eAAe9C,IAAI,CAACM,OAAO,CAACO,iBAAiB,CAAC;QAC5CC,MAAM;YAAEiC,MAAMrB;QAAS;QACvBX,OAAO;IACT;IAEA,mBAAmB;IACnB+B,eAAe9C,IAAI,CAACO,UAAU,CAACM,iBAAiB,CAAC;QAC/CC,MAAM;YACJkC,SAAS;gBACPC,cAAc;gBACdC,eAAe;gBACfH,MAAMrB;YACR;QACF;QACAX,OAAO;IACT;IAEA,OAAOW;AACT;AAKO,MAAMhC,qBAAqB,CAACoD;IACjC,MAAMK,aAAaL,eAAetC,IAAI,CAAC;IAEvC,qBAAqB;IACrB2C,WAAWlC,MAAM,CAACJ,iBAAiB,CAAC;QAClCC,MAAM;YAAC;gBAAEI,IAAI;YAAe;SAAE;QAC9BH,OAAO;IACT;IAEA,sBAAsB;IACtBoC,WAAWzC,MAAM,CAACD,eAAe,CAAC;QAChCE,IAAIT,KAAKC,EAAE,GAAGM,eAAe,CAAC;YAC5BG,QAAQV,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;gBAClCC,MAAM;oBACJI,IAAI;oBACJmB,OAAO;oBACPK,QAAQ;gBACV;gBACA3B,OAAO;YACT;YACAC,OAAOd,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;gBACjCC,MAAM;oBACJ;wBACEI,IAAI;wBACJmB,OAAO;wBACPK,QAAQ;oBACV;iBACD;gBACD3B,OAAO;YACT;QACF;IACF;IAEA,OAAOoC;AACT;AAKO,MAAMxD,qBAAqB,CAACmD;IACjC,MAAMM,aAAaN,eAAetC,IAAI,CAAC;IAEvC,qBAAqB;IACrB4C,WAAWnC,MAAM,CAACJ,iBAAiB,CAAC;QAClCC,MAAM;YAAC;gBAAEI,IAAI;YAAe;SAAE;QAC9BH,OAAO;IACT;IAEA,sBAAsB;IACtBqC,WAAW1C,MAAM,CAACD,eAAe,CAAC;QAChCE,IAAIT,KAAKC,EAAE,GAAGM,eAAe,CAAC;YAC5BO,OAAOd,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;gBACjCC,MAAM;oBACJ;wBACEI,IAAI;wBACJ0B,SAAS;wBACTd,SAAS;wBACTe,QAAQ;oBACV;iBACD;gBACD9B,OAAO;YACT;QACF;IACF;IAEA,OAAOqC;AACT;AAKO,MAAM3D,oBAAoB,CAACqD,gBAAqBO;IACrD,MAAMC,gBAAgB;QACpBC,YAAY;QACZvD,MAAM;QACNwD,YAAY;QACZC,YAAY;IACd;IAEA,MAAM1C,QAAQ,IAAI2C,MAAMJ,aAAa,CAACD,UAAU;IAEhD,gCAAgC;IAChCP,eAAetC,IAAI,CAACC,eAAe,CAAC;QAClCC,QAAQR,KAAKC,EAAE,GAAGM,eAAe,CAAC;YAChCE,IAAIT,KAAKC,EAAE,GAAGM,eAAe,CAAC;gBAC5BG,QAAQV,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;oBAClCC,MAAM;oBACNC;gBACF;gBACAC,OAAOd,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;oBACjCC,MAAM;oBACNC;gBACF;YACF;QACF;QACAE,QAAQf,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;YAClCC,MAAM;YACNC;QACF;QACAI,QAAQjB,KAAKC,EAAE,GAAGM,eAAe,CAAC;YAChCE,IAAIT,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;gBAC9BC,MAAM;gBACNC;YACF;QACF;QACAK,QAAQlB,KAAKC,EAAE,GAAGM,eAAe,CAAC;YAChCE,IAAIT,KAAKC,EAAE,GAAGU,iBAAiB,CAAC;gBAC9BC,MAAM;gBACNC;YACF;QACF;IACF;IAEA,OAAOA;AACT;AAKO,MAAM3B,sBAAsB;IACjC,kBAAkB;IAClBc,KAAKyD,aAAa;IAElB,8BAA8B;IAC9B,OAAOtC,QAAQC,GAAG,CAACC,wBAAwB;IAC3C,OAAOF,QAAQC,GAAG,CAACE,6BAA6B;IAChD,OAAOH,QAAQC,GAAG,CAACG,yBAAyB;AAC9C;AAKO,MAAM3B,yBAAyB,OAAOgD;IAC3C,IAAI;QACF,wBAAwB;QACxB,MAAMc,SAAS,MAAMd,eAAetC,IAAI,CAAC,SAASE,MAAM,CAAC,MAAMM,KAAK,CAAC;QACrE,OAAO4C,OAAO7C,KAAK,KAAK;IAC1B,EAAE,OAAOA,OAAO;QACd,OAAO;IACT;AACF;AAKO,MAAMlB,yBAAyB,OAAOiD,gBAAqBpB;IAChE,IAAI;QACF,eAAe;QACf,MAAMmC,eAAe,MAAMf,eAAe9C,IAAI,CAACC,kBAAkB,CAAC;YAChE0B,OAAOD,SAASC,KAAK;YACrBC,UAAUF,SAASE,QAAQ;QAC7B;QAEA,IAAIiC,aAAa9C,KAAK,EAAE;YACtB,OAAO;QACT;QAEA,gBAAgB;QAChB,MAAM+C,aAAa,MAAMhB,eAAe9C,IAAI,CAACM,OAAO;QAEpD,IAAIwD,WAAW/C,KAAK,EAAE;YACpB,OAAO;QACT;QAEA,OAAO;IACT,EAAE,OAAOA,OAAO;QACd,OAAO;IACT;AACF"}