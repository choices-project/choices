{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/helpers/database-test-utils.ts"],"sourcesContent":["/**\n * Database Test Utilities\n * \n * Provides real database operations for integration testing.\n * Follows integration testing best practices:\n * - Uses real database connections\n * - Implements proper test isolation\n * - Provides cleanup utilities\n * - Supports both local and CI environments\n */\n\nimport { createClient, SupabaseClient } from '@supabase/supabase-js';\nimport { jest } from '@jest/globals';\n\n// Test database configuration\nconst TEST_DB_URL = process.env.TEST_SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst TEST_DB_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n// Test data tracking for cleanup\nlet testDataIds: {\n  polls: string[];\n  votes: string[];\n  users: string[];\n} = {\n  polls: [],\n  votes: [],\n  users: []\n};\n\n// Create real Supabase client for testing\nexport const createTestSupabaseClient = (): SupabaseClient | null => {\n  if (!TEST_DB_URL || !TEST_DB_KEY) {\n    console.warn('Test database credentials not found. Integration tests will be skipped.');\n    return null;\n  }\n  \n  return createClient(TEST_DB_URL, TEST_DB_KEY);\n};\n\n// Setup test database with real connection\nexport const setupTestDatabase = async (): Promise<SupabaseClient | null> => {\n  const client = createTestSupabaseClient();\n  \n  if (!client) {\n    console.warn('No test database available. Using mock client for CI/CD.');\n    return createMockSupabaseClient();\n  }\n  \n  // Reset test data tracking\n  testDataIds = { polls: [], votes: [], users: [] };\n  \n  console.log('Integration: Real test database connected');\n  return client;\n};\n\n// Create test user with real database\nexport const createTestUser = async (supabase: SupabaseClient | null) => {\n  if (!supabase) {\n    return {\n      id: 'test-user-id',\n      email: 'test@example.com',\n      name: 'Test User'\n    };\n  }\n  \n  try {\n    // Use an existing user ID from the database\n    const testUser = {\n      id: '6f12e40c-fd46-4ace-9470-2016dc0e2e8b', // Existing user ID from database\n      email: 'test@example.com',\n      name: 'Test User'\n    };\n    \n    // Track for cleanup\n    testDataIds.users.push(testUser.id);\n    \n    return testUser;\n  } catch (error) {\n    console.warn('Failed to create test user:', error);\n    return {\n      id: '6f12e40c-fd46-4ace-9470-2016dc0e2e8b', // Existing user ID from database\n      email: 'test@example.com',\n      name: 'Test User'\n    };\n  }\n};\n\n// Track test data for cleanup\nexport const trackTestData = (type: 'polls' | 'votes' | 'users', id: string) => {\n  testDataIds[type].push(id);\n};\n\n// Cleanup test database - removes all test data\nexport const cleanupTestDatabase = async (supabase: SupabaseClient | null) => {\n  if (!supabase) {\n    console.log('Integration: Mock database cleanup completed');\n    return;\n  }\n  \n  try {\n    // Clean up in reverse order to respect foreign key constraints\n    if (testDataIds.votes.length > 0) {\n      await supabase.from('votes').delete().in('id', testDataIds.votes);\n      console.log(`Integration: Cleaned up ${testDataIds.votes.length} test votes`);\n    }\n    \n    if (testDataIds.polls.length > 0) {\n      await supabase.from('polls').delete().in('id', testDataIds.polls);\n      console.log(`Integration: Cleaned up ${testDataIds.polls.length} test polls`);\n    }\n    \n    // Note: Users are managed by Supabase Auth, not a custom users table\n    if (testDataIds.users.length > 0) {\n      console.log(`Integration: Note - ${testDataIds.users.length} test users tracked (managed by Supabase Auth)`);\n    }\n    \n    // Reset tracking\n    testDataIds = { polls: [], votes: [], users: [] };\n    \n    console.log('Integration: Test database cleanup completed');\n  } catch (error) {\n    console.error('Integration: Failed to cleanup test database:', error);\n  }\n};\n\n// Mock client fallback for CI/CD environments\nconst createMockSupabaseClient = () => {\n  return {\n    from: jest.fn().mockReturnValue({\n      insert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: {\n              id: 'test-poll-id',\n              title: 'Test Poll',\n              description: 'A test poll',\n              votingMethod: 'single',\n              options: [\n                { id: 'option-1', text: 'Option 1' },\n                { id: 'option-2', text: 'Option 2' }\n              ],\n              status: 'active',\n              createdAt: new Date().toISOString(),\n              closeAt: new Date(Date.now() + 86400000).toISOString(),\n              createdBy: 'test-user-id'\n            },\n            error: null\n          })\n        })\n      }),\n      select: jest.fn().mockReturnValue({\n        eq: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: {\n              id: 'test-poll-id',\n              title: 'Test Poll',\n              description: 'A test poll',\n              votingMethod: 'single',\n              options: [\n                { id: 'option-1', text: 'Option 1' },\n                { id: 'option-2', text: 'Option 2' }\n              ],\n              status: 'active',\n              createdAt: new Date().toISOString(),\n              closeAt: new Date(Date.now() + 86400000).toISOString(),\n              createdBy: 'test-user-id'\n            },\n            error: null\n          })\n        })\n      })\n    }),\n    auth: {\n      signInWithPassword: jest.fn().mockResolvedValue({\n        data: { user: { id: 'test-user-id', email: 'test@example.com' } },\n        error: null\n      })\n    }\n  };\n};\n"],"names":["cleanupTestDatabase","createTestSupabaseClient","createTestUser","setupTestDatabase","trackTestData","TEST_DB_URL","process","env","TEST_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_URL","TEST_DB_KEY","SUPABASE_SERVICE_ROLE_KEY","NEXT_PUBLIC_SUPABASE_ANON_KEY","testDataIds","polls","votes","users","console","warn","createClient","client","createMockSupabaseClient","log","supabase","id","email","name","testUser","push","error","type","length","from","delete","in","jest","fn","mockReturnValue","insert","select","single","mockResolvedValue","data","title","description","votingMethod","options","text","status","createdAt","Date","toISOString","closeAt","now","createdBy","eq","auth","signInWithPassword","user"],"mappings":"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"}