5ad8dda689d62102a1063f55a73c373a
/**
 * Quadratic Voting Strategy
 * 
 * Implements quadratic voting where voters allocate tokens across options.
 * The cost of votes increases quadratically with the number of votes allocated to an option.
 * 
 * Created: September 15, 2025
 * Updated: September 15, 2025
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "QuadraticStrategy", {
    enumerable: true,
    get: function() {
        return QuadraticStrategy;
    }
});
const _logger = require("../../utils/logger");
class QuadraticStrategy {
    getVotingMethod() {
        return "quadratic";
    }
    async validateVote(request, poll) {
        try {
            const voteData = request.voteData;
            // Validate allocations object exists
            if (!voteData.allocations || typeof voteData.allocations !== "object") {
                return {
                    valid: false,
                    isValid: false,
                    error: "Quadratic voting requires allocations",
                    errors: [
                        "Quadratic voting requires allocations"
                    ],
                    requiresAuthentication: false,
                    requiresTokens: false
                };
            }
            // Validate allocations are numbers
            const allocations = voteData.allocations;
            let totalTokens = 0;
            for (const [optionId, tokens] of Object.entries(allocations)){
                if (typeof tokens !== "number" || tokens < 0) {
                    return {
                        valid: false,
                        isValid: false,
                        error: "Allocations must be non-negative numbers",
                        errors: [
                            "Allocations must be non-negative numbers"
                        ],
                        requiresAuthentication: false,
                        requiresTokens: false
                    };
                }
                // Check if option exists
                const optionExists = poll.options.some((option)=>option.id === optionId);
                if (!optionExists) {
                    return {
                        valid: false,
                        isValid: false,
                        error: "Invalid option selected",
                        errors: [
                            "Invalid option selected"
                        ],
                        requiresAuthentication: false,
                        requiresTokens: false
                    };
                }
                totalTokens += tokens;
            }
            // Check token budget
            const maxTokens = poll.settings?.maxTokens || 100;
            if (totalTokens > maxTokens) {
                return {
                    valid: false,
                    isValid: false,
                    error: `Exceeds maximum token budget of ${maxTokens}`,
                    errors: [
                        `Exceeds maximum token budget of ${maxTokens}`
                    ],
                    requiresAuthentication: false,
                    requiresTokens: false
                };
            }
            (0, _logger.devLog)("Quadratic vote validated successfully", {
                pollId: request.pollId,
                allocations: voteData.allocations,
                totalTokens,
                userId: request.userId
            });
            return {
                valid: true,
                isValid: true,
                requiresAuthentication: false,
                requiresTokens: false
            };
        } catch (error) {
            (0, _logger.devLog)("Quadratic vote validation error:", error);
            return {
                valid: false,
                isValid: false,
                error: "Quadratic vote validation failed",
                errors: [
                    "Quadratic vote validation failed"
                ],
                requiresAuthentication: false,
                requiresTokens: false
            };
        }
    }
    async processVote(request, poll) {
        try {
            const voteData = request.voteData;
            // Create vote data for storage
            const voteRecord = {
                id: `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                pollId: request.pollId,
                userId: request.userId,
                voteData: {
                    allocations: voteData.allocations
                },
                timestamp: new Date().toISOString(),
                ipAddress: request.ipAddress,
                userAgent: request.userAgent
            };
            (0, _logger.devLog)("Quadratic vote processed successfully", {
                pollId: request.pollId,
                userId: request.userId,
                allocations: voteData.allocations,
                voteId: voteRecord.id
            });
            return {
                success: true,
                voteId: voteRecord.id,
                message: "Vote recorded successfully",
                pollId: request.pollId
            };
        } catch (error) {
            (0, _logger.devLog)("Quadratic vote processing error:", error);
            return {
                success: false,
                error: "Failed to process quadratic vote",
                message: "Failed to process quadratic vote",
                pollId: request.pollId
            };
        }
    }
    async calculateResults(poll, votes) {
        try {
            const startTime = Date.now();
            // Initialize tracking objects
            const totalScores = {};
            const optionVotes = {};
            const optionPercentages = {};
            // Initialize all options with zero scores
            poll.options.forEach((option)=>{
                totalScores[option.id] = 0;
                optionVotes[option.id] = 0;
                optionPercentages[option.id] = 0;
            });
            // Process each vote
            votes.forEach((vote)=>{
                if (vote.voteData.allocations) {
                    Object.entries(vote.voteData.allocations).forEach(([optionId, tokens])=>{
                        if (typeof tokens === "number" && tokens > 0) {
                            totalScores[optionId] += tokens;
                            optionVotes[optionId]++;
                        }
                    });
                }
            });
            const totalVotes = votes.length;
            // Calculate percentages
            if (totalVotes > 0) {
                Object.keys(optionVotes).forEach((optionId)=>{
                    const votes = optionVotes[optionId];
                    optionPercentages[optionId] = votes / totalVotes * 100;
                });
            }
            // Find winner (highest total score)
            let winner;
            let winnerVotes = 0;
            let winnerPercentage = 0;
            if (totalVotes > 0) {
                Object.entries(totalScores).forEach(([optionId, score])=>{
                    if (score > winnerVotes) {
                        winner = optionId;
                        winnerVotes = score;
                        winnerPercentage = optionPercentages[optionId] || 0;
                    }
                });
            }
            const results = {
                winner,
                winnerVotes,
                winnerPercentage,
                optionVotes,
                optionPercentages,
                abstentions: 0,
                abstentionPercentage: 0
            };
            (0, _logger.devLog)("Quadratic results calculated", {
                pollId: poll.id,
                totalVotes,
                winner,
                winnerVotes,
                winnerPercentage,
                calculationTime: Date.now() - startTime
            });
            return {
                pollId: poll.id,
                votingMethod: poll.votingMethod,
                totalVotes,
                participationRate: totalVotes / 100,
                results,
                calculatedAt: new Date().toISOString(),
                metadata: {
                    calculationTime: Date.now() - startTime,
                    method: "quadratic"
                }
            };
        } catch (error) {
            (0, _logger.devLog)("Quadratic results calculation error:", error);
            // Return empty results on error
            return {
                pollId: poll.id,
                votingMethod: poll.votingMethod,
                totalVotes: 0,
                participationRate: 0,
                results: {
                    winner: undefined,
                    winnerVotes: 0,
                    winnerPercentage: 0,
                    optionVotes: {},
                    optionPercentages: {},
                    abstentions: 0,
                    abstentionPercentage: 0
                },
                calculatedAt: new Date().toISOString(),
                metadata: {
                    calculationTime: 0,
                    error: error instanceof Error ? error.message : "Unknown error"
                }
            };
        }
    }
    getConfiguration() {
        return {
            method: "quadratic",
            description: "Voters allocate tokens across options with quadratic cost",
            allowsMultipleSelections: true,
            requiresRanking: false,
            maxSelections: "token budget",
            costFunction: "quadratic"
        };
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9saWIvdm90ZS9zdHJhdGVnaWVzL3F1YWRyYXRpYy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFF1YWRyYXRpYyBWb3RpbmcgU3RyYXRlZ3lcbiAqIFxuICogSW1wbGVtZW50cyBxdWFkcmF0aWMgdm90aW5nIHdoZXJlIHZvdGVycyBhbGxvY2F0ZSB0b2tlbnMgYWNyb3NzIG9wdGlvbnMuXG4gKiBUaGUgY29zdCBvZiB2b3RlcyBpbmNyZWFzZXMgcXVhZHJhdGljYWxseSB3aXRoIHRoZSBudW1iZXIgb2Ygdm90ZXMgYWxsb2NhdGVkIHRvIGFuIG9wdGlvbi5cbiAqIFxuICogQ3JlYXRlZDogU2VwdGVtYmVyIDE1LCAyMDI1XG4gKiBVcGRhdGVkOiBTZXB0ZW1iZXIgMTUsIDIwMjVcbiAqL1xuXG5pbXBvcnQgeyBkZXZMb2cgfSBmcm9tICdAL2xpYi91dGlscy9sb2dnZXInO1xuaW1wb3J0IHsgd2l0aE9wdGlvbmFsIH0gZnJvbSAnQC9saWIvdXRpbHMvb2JqZWN0cyc7XG5cbmltcG9ydCB0eXBlIHsgXG4gIFZvdGluZ1N0cmF0ZWd5LCBcbiAgVm90ZVJlcXVlc3QsIFxuICBWb3RlUmVzcG9uc2UsIFxuICBWb3RlVmFsaWRhdGlvbiwgXG4gIFBvbGxEYXRhLCBcbiAgVm90ZURhdGEsIFxuICBSZXN1bHRzRGF0YSxcbiAgVm90aW5nTWV0aG9kLFxuICBQb2xsUmVzdWx0c1xufSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBjbGFzcyBRdWFkcmF0aWNTdHJhdGVneSBpbXBsZW1lbnRzIFZvdGluZ1N0cmF0ZWd5IHtcbiAgXG4gIGdldFZvdGluZ01ldGhvZCgpOiBWb3RpbmdNZXRob2Qge1xuICAgIHJldHVybiAncXVhZHJhdGljJztcbiAgfVxuXG4gIGFzeW5jIHZhbGlkYXRlVm90ZShyZXF1ZXN0OiBWb3RlUmVxdWVzdCwgcG9sbDogUG9sbERhdGEpOiBQcm9taXNlPFZvdGVWYWxpZGF0aW9uPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHZvdGVEYXRhID0gcmVxdWVzdC52b3RlRGF0YTtcblxuICAgICAgLy8gVmFsaWRhdGUgYWxsb2NhdGlvbnMgb2JqZWN0IGV4aXN0c1xuICAgICAgaWYgKCF2b3RlRGF0YS5hbGxvY2F0aW9ucyB8fCB0eXBlb2Ygdm90ZURhdGEuYWxsb2NhdGlvbnMgIT09ICdvYmplY3QnKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiAnUXVhZHJhdGljIHZvdGluZyByZXF1aXJlcyBhbGxvY2F0aW9ucycsXG4gICAgICAgICAgZXJyb3JzOiBbJ1F1YWRyYXRpYyB2b3RpbmcgcmVxdWlyZXMgYWxsb2NhdGlvbnMnXSxcbiAgICAgICAgICByZXF1aXJlc0F1dGhlbnRpY2F0aW9uOiBmYWxzZSxcbiAgICAgICAgICByZXF1aXJlc1Rva2VuczogZmFsc2VcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgYWxsb2NhdGlvbnMgYXJlIG51bWJlcnNcbiAgICAgIGNvbnN0IGFsbG9jYXRpb25zID0gdm90ZURhdGEuYWxsb2NhdGlvbnM7XG4gICAgICBsZXQgdG90YWxUb2tlbnMgPSAwO1xuICAgICAgXG4gICAgICBmb3IgKGNvbnN0IFtvcHRpb25JZCwgdG9rZW5zXSBvZiBPYmplY3QuZW50cmllcyhhbGxvY2F0aW9ucykpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbnMgIT09ICdudW1iZXInIHx8IHRva2VucyA8IDApIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdmFsaWQ6IGZhbHNlLFxuICAgICAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgICAgICBlcnJvcjogJ0FsbG9jYXRpb25zIG11c3QgYmUgbm9uLW5lZ2F0aXZlIG51bWJlcnMnLFxuICAgICAgICAgICAgZXJyb3JzOiBbJ0FsbG9jYXRpb25zIG11c3QgYmUgbm9uLW5lZ2F0aXZlIG51bWJlcnMnXSxcbiAgICAgICAgICAgIHJlcXVpcmVzQXV0aGVudGljYXRpb246IGZhbHNlLFxuICAgICAgICAgICAgcmVxdWlyZXNUb2tlbnM6IGZhbHNlXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gQ2hlY2sgaWYgb3B0aW9uIGV4aXN0c1xuICAgICAgICBjb25zdCBvcHRpb25FeGlzdHMgPSBwb2xsLm9wdGlvbnMuc29tZShvcHRpb24gPT4gb3B0aW9uLmlkID09PSBvcHRpb25JZCk7XG4gICAgICAgIGlmICghb3B0aW9uRXhpc3RzKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICAgICAgZXJyb3I6ICdJbnZhbGlkIG9wdGlvbiBzZWxlY3RlZCcsXG4gICAgICAgICAgICBlcnJvcnM6IFsnSW52YWxpZCBvcHRpb24gc2VsZWN0ZWQnXSxcbiAgICAgICAgICAgIHJlcXVpcmVzQXV0aGVudGljYXRpb246IGZhbHNlLFxuICAgICAgICAgICAgcmVxdWlyZXNUb2tlbnM6IGZhbHNlXG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdG90YWxUb2tlbnMgKz0gdG9rZW5zO1xuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayB0b2tlbiBidWRnZXRcbiAgICAgIGNvbnN0IG1heFRva2VucyA9IHBvbGwuc2V0dGluZ3M/Lm1heFRva2VucyB8fCAxMDA7XG4gICAgICBpZiAodG90YWxUb2tlbnMgPiBtYXhUb2tlbnMpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IGBFeGNlZWRzIG1heGltdW0gdG9rZW4gYnVkZ2V0IG9mICR7bWF4VG9rZW5zfWAsXG4gICAgICAgICAgZXJyb3JzOiBbYEV4Y2VlZHMgbWF4aW11bSB0b2tlbiBidWRnZXQgb2YgJHttYXhUb2tlbnN9YF0sXG4gICAgICAgICAgcmVxdWlyZXNBdXRoZW50aWNhdGlvbjogZmFsc2UsXG4gICAgICAgICAgcmVxdWlyZXNUb2tlbnM6IGZhbHNlXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGRldkxvZygnUXVhZHJhdGljIHZvdGUgdmFsaWRhdGVkIHN1Y2Nlc3NmdWxseScsIHtcbiAgICAgICAgcG9sbElkOiByZXF1ZXN0LnBvbGxJZCxcbiAgICAgICAgYWxsb2NhdGlvbnM6IHZvdGVEYXRhLmFsbG9jYXRpb25zLFxuICAgICAgICB0b3RhbFRva2VucyxcbiAgICAgICAgdXNlcklkOiByZXF1ZXN0LnVzZXJJZFxuICAgICAgfSk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiB0cnVlLFxuICAgICAgICBpc1ZhbGlkOiB0cnVlLFxuICAgICAgICByZXF1aXJlc0F1dGhlbnRpY2F0aW9uOiBmYWxzZSxcbiAgICAgICAgcmVxdWlyZXNUb2tlbnM6IGZhbHNlXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGRldkxvZygnUXVhZHJhdGljIHZvdGUgdmFsaWRhdGlvbiBlcnJvcjonLCBlcnJvcik7XG4gICAgICByZXR1cm4ge1xuICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ1F1YWRyYXRpYyB2b3RlIHZhbGlkYXRpb24gZmFpbGVkJyxcbiAgICAgICAgZXJyb3JzOiBbJ1F1YWRyYXRpYyB2b3RlIHZhbGlkYXRpb24gZmFpbGVkJ10sXG4gICAgICAgIHJlcXVpcmVzQXV0aGVudGljYXRpb246IGZhbHNlLFxuICAgICAgICByZXF1aXJlc1Rva2VuczogZmFsc2VcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcHJvY2Vzc1ZvdGUocmVxdWVzdDogVm90ZVJlcXVlc3QsIHBvbGw6IFBvbGxEYXRhKTogUHJvbWlzZTxWb3RlUmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgdm90ZURhdGEgPSByZXF1ZXN0LnZvdGVEYXRhO1xuICAgICAgXG4gICAgICAvLyBDcmVhdGUgdm90ZSBkYXRhIGZvciBzdG9yYWdlXG4gICAgICBjb25zdCB2b3RlUmVjb3JkOiBWb3RlRGF0YSA9IHtcbiAgICAgICAgaWQ6IGB2b3RlXyR7RGF0ZS5ub3coKX1fJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YCxcbiAgICAgICAgcG9sbElkOiByZXF1ZXN0LnBvbGxJZCxcbiAgICAgICAgdXNlcklkOiByZXF1ZXN0LnVzZXJJZCxcbiAgICAgICAgdm90ZURhdGE6IHtcbiAgICAgICAgICBhbGxvY2F0aW9uczogdm90ZURhdGEuYWxsb2NhdGlvbnNcbiAgICAgICAgfSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIGlwQWRkcmVzczogcmVxdWVzdC5pcEFkZHJlc3MsXG4gICAgICAgIHVzZXJBZ2VudDogcmVxdWVzdC51c2VyQWdlbnRcbiAgICAgIH07XG5cbiAgICAgIGRldkxvZygnUXVhZHJhdGljIHZvdGUgcHJvY2Vzc2VkIHN1Y2Nlc3NmdWxseScsIHtcbiAgICAgICAgcG9sbElkOiByZXF1ZXN0LnBvbGxJZCxcbiAgICAgICAgdXNlcklkOiByZXF1ZXN0LnVzZXJJZCxcbiAgICAgICAgYWxsb2NhdGlvbnM6IHZvdGVEYXRhLmFsbG9jYXRpb25zLFxuICAgICAgICB2b3RlSWQ6IHZvdGVSZWNvcmQuaWRcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICB2b3RlSWQ6IHZvdGVSZWNvcmQuaWQsXG4gICAgICAgIG1lc3NhZ2U6ICdWb3RlIHJlY29yZGVkIHN1Y2Nlc3NmdWxseScsXG4gICAgICAgIHBvbGxJZDogcmVxdWVzdC5wb2xsSWRcbiAgICAgIH07XG5cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZGV2TG9nKCdRdWFkcmF0aWMgdm90ZSBwcm9jZXNzaW5nIGVycm9yOicsIGVycm9yKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlcnJvcjogJ0ZhaWxlZCB0byBwcm9jZXNzIHF1YWRyYXRpYyB2b3RlJyxcbiAgICAgICAgbWVzc2FnZTogJ0ZhaWxlZCB0byBwcm9jZXNzIHF1YWRyYXRpYyB2b3RlJyxcbiAgICAgICAgcG9sbElkOiByZXF1ZXN0LnBvbGxJZFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjYWxjdWxhdGVSZXN1bHRzKHBvbGw6IFBvbGxEYXRhLCB2b3RlczogVm90ZURhdGFbXSk6IFByb21pc2U8UmVzdWx0c0RhdGE+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgIFxuICAgICAgLy8gSW5pdGlhbGl6ZSB0cmFja2luZyBvYmplY3RzXG4gICAgICBjb25zdCB0b3RhbFNjb3JlczogUmVjb3JkPHN0cmluZywgbnVtYmVyPiA9IHt9O1xuICAgICAgY29uc3Qgb3B0aW9uVm90ZXM6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7fTtcbiAgICAgIGNvbnN0IG9wdGlvblBlcmNlbnRhZ2VzOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge307XG5cbiAgICAgIC8vIEluaXRpYWxpemUgYWxsIG9wdGlvbnMgd2l0aCB6ZXJvIHNjb3Jlc1xuICAgICAgcG9sbC5vcHRpb25zLmZvckVhY2gob3B0aW9uID0+IHtcbiAgICAgICAgdG90YWxTY29yZXNbb3B0aW9uLmlkXSA9IDA7XG4gICAgICAgIG9wdGlvblZvdGVzW29wdGlvbi5pZF0gPSAwO1xuICAgICAgICBvcHRpb25QZXJjZW50YWdlc1tvcHRpb24uaWRdID0gMDtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBQcm9jZXNzIGVhY2ggdm90ZVxuICAgICAgdm90ZXMuZm9yRWFjaCh2b3RlID0+IHtcbiAgICAgICAgaWYgKHZvdGUudm90ZURhdGEuYWxsb2NhdGlvbnMpIHtcbiAgICAgICAgICBPYmplY3QuZW50cmllcyh2b3RlLnZvdGVEYXRhLmFsbG9jYXRpb25zKS5mb3JFYWNoKChbb3B0aW9uSWQsIHRva2Vuc10pID0+IHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdG9rZW5zID09PSAnbnVtYmVyJyAmJiB0b2tlbnMgPiAwKSB7XG4gICAgICAgICAgICAgIHRvdGFsU2NvcmVzW29wdGlvbklkXSArPSB0b2tlbnM7XG4gICAgICAgICAgICAgIG9wdGlvblZvdGVzW29wdGlvbklkXSsrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgY29uc3QgdG90YWxWb3RlcyA9IHZvdGVzLmxlbmd0aDtcblxuICAgICAgLy8gQ2FsY3VsYXRlIHBlcmNlbnRhZ2VzXG4gICAgICBpZiAodG90YWxWb3RlcyA+IDApIHtcbiAgICAgICAgT2JqZWN0LmtleXMob3B0aW9uVm90ZXMpLmZvckVhY2gob3B0aW9uSWQgPT4ge1xuICAgICAgICAgIGNvbnN0IHZvdGVzID0gb3B0aW9uVm90ZXNbb3B0aW9uSWRdO1xuICAgICAgICAgIG9wdGlvblBlcmNlbnRhZ2VzW29wdGlvbklkXSA9ICh2b3RlcyAvIHRvdGFsVm90ZXMpICogMTAwO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gRmluZCB3aW5uZXIgKGhpZ2hlc3QgdG90YWwgc2NvcmUpXG4gICAgICBsZXQgd2lubmVyOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgICBsZXQgd2lubmVyVm90ZXMgPSAwO1xuICAgICAgbGV0IHdpbm5lclBlcmNlbnRhZ2UgPSAwO1xuXG4gICAgICBpZiAodG90YWxWb3RlcyA+IDApIHtcbiAgICAgICAgT2JqZWN0LmVudHJpZXModG90YWxTY29yZXMpLmZvckVhY2goKFtvcHRpb25JZCwgc2NvcmVdKSA9PiB7XG4gICAgICAgICAgaWYgKHNjb3JlID4gd2lubmVyVm90ZXMpIHtcbiAgICAgICAgICAgIHdpbm5lciA9IG9wdGlvbklkO1xuICAgICAgICAgICAgd2lubmVyVm90ZXMgPSBzY29yZTtcbiAgICAgICAgICAgIHdpbm5lclBlcmNlbnRhZ2UgPSBvcHRpb25QZXJjZW50YWdlc1tvcHRpb25JZF0gfHwgMDtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXN1bHRzOiBQb2xsUmVzdWx0cyA9IHtcbiAgICAgICAgd2lubmVyLFxuICAgICAgICB3aW5uZXJWb3RlcyxcbiAgICAgICAgd2lubmVyUGVyY2VudGFnZSxcbiAgICAgICAgb3B0aW9uVm90ZXMsXG4gICAgICAgIG9wdGlvblBlcmNlbnRhZ2VzLFxuICAgICAgICBhYnN0ZW50aW9uczogMCxcbiAgICAgICAgYWJzdGVudGlvblBlcmNlbnRhZ2U6IDBcbiAgICAgIH07XG5cbiAgICAgIGRldkxvZygnUXVhZHJhdGljIHJlc3VsdHMgY2FsY3VsYXRlZCcsIHtcbiAgICAgICAgcG9sbElkOiBwb2xsLmlkLFxuICAgICAgICB0b3RhbFZvdGVzLFxuICAgICAgICB3aW5uZXIsXG4gICAgICAgIHdpbm5lclZvdGVzLFxuICAgICAgICB3aW5uZXJQZXJjZW50YWdlLFxuICAgICAgICBjYWxjdWxhdGlvblRpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBwb2xsSWQ6IHBvbGwuaWQsXG4gICAgICAgIHZvdGluZ01ldGhvZDogcG9sbC52b3RpbmdNZXRob2QsXG4gICAgICAgIHRvdGFsVm90ZXMsXG4gICAgICAgIHBhcnRpY2lwYXRpb25SYXRlOiB0b3RhbFZvdGVzIC8gMTAwLCAvLyBNb2NrIHBhcnRpY2lwYXRpb24gcmF0ZVxuICAgICAgICByZXN1bHRzLFxuICAgICAgICBjYWxjdWxhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICBjYWxjdWxhdGlvblRpbWU6IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgICAgbWV0aG9kOiAncXVhZHJhdGljJ1xuICAgICAgICB9XG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGRldkxvZygnUXVhZHJhdGljIHJlc3VsdHMgY2FsY3VsYXRpb24gZXJyb3I6JywgZXJyb3IpO1xuICAgICAgXG4gICAgICAvLyBSZXR1cm4gZW1wdHkgcmVzdWx0cyBvbiBlcnJvclxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcG9sbElkOiBwb2xsLmlkLFxuICAgICAgICB2b3RpbmdNZXRob2Q6IHBvbGwudm90aW5nTWV0aG9kLFxuICAgICAgICB0b3RhbFZvdGVzOiAwLFxuICAgICAgICBwYXJ0aWNpcGF0aW9uUmF0ZTogMCxcbiAgICAgICAgcmVzdWx0czoge1xuICAgICAgICAgIHdpbm5lcjogdW5kZWZpbmVkLFxuICAgICAgICAgIHdpbm5lclZvdGVzOiAwLFxuICAgICAgICAgIHdpbm5lclBlcmNlbnRhZ2U6IDAsXG4gICAgICAgICAgb3B0aW9uVm90ZXM6IHt9LFxuICAgICAgICAgIG9wdGlvblBlcmNlbnRhZ2VzOiB7fSxcbiAgICAgICAgICBhYnN0ZW50aW9uczogMCxcbiAgICAgICAgICBhYnN0ZW50aW9uUGVyY2VudGFnZTogMFxuICAgICAgICB9LFxuICAgICAgICBjYWxjdWxhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICBjYWxjdWxhdGlvblRpbWU6IDAsXG4gICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InXG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgZ2V0Q29uZmlndXJhdGlvbigpOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG1ldGhvZDogJ3F1YWRyYXRpYycsXG4gICAgICBkZXNjcmlwdGlvbjogJ1ZvdGVycyBhbGxvY2F0ZSB0b2tlbnMgYWNyb3NzIG9wdGlvbnMgd2l0aCBxdWFkcmF0aWMgY29zdCcsXG4gICAgICBhbGxvd3NNdWx0aXBsZVNlbGVjdGlvbnM6IHRydWUsXG4gICAgICByZXF1aXJlc1Jhbmtpbmc6IGZhbHNlLFxuICAgICAgbWF4U2VsZWN0aW9uczogJ3Rva2VuIGJ1ZGdldCcsXG4gICAgICBjb3N0RnVuY3Rpb246ICdxdWFkcmF0aWMnXG4gICAgfTtcbiAgfVxufSJdLCJuYW1lcyI6WyJRdWFkcmF0aWNTdHJhdGVneSIsImdldFZvdGluZ01ldGhvZCIsInZhbGlkYXRlVm90ZSIsInJlcXVlc3QiLCJwb2xsIiwidm90ZURhdGEiLCJhbGxvY2F0aW9ucyIsInZhbGlkIiwiaXNWYWxpZCIsImVycm9yIiwiZXJyb3JzIiwicmVxdWlyZXNBdXRoZW50aWNhdGlvbiIsInJlcXVpcmVzVG9rZW5zIiwidG90YWxUb2tlbnMiLCJvcHRpb25JZCIsInRva2VucyIsIk9iamVjdCIsImVudHJpZXMiLCJvcHRpb25FeGlzdHMiLCJvcHRpb25zIiwic29tZSIsIm9wdGlvbiIsImlkIiwibWF4VG9rZW5zIiwic2V0dGluZ3MiLCJkZXZMb2ciLCJwb2xsSWQiLCJ1c2VySWQiLCJwcm9jZXNzVm90ZSIsInZvdGVSZWNvcmQiLCJEYXRlIiwibm93IiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwic3Vic3RyIiwidGltZXN0YW1wIiwidG9JU09TdHJpbmciLCJpcEFkZHJlc3MiLCJ1c2VyQWdlbnQiLCJ2b3RlSWQiLCJzdWNjZXNzIiwibWVzc2FnZSIsImNhbGN1bGF0ZVJlc3VsdHMiLCJ2b3RlcyIsInN0YXJ0VGltZSIsInRvdGFsU2NvcmVzIiwib3B0aW9uVm90ZXMiLCJvcHRpb25QZXJjZW50YWdlcyIsImZvckVhY2giLCJ2b3RlIiwidG90YWxWb3RlcyIsImxlbmd0aCIsImtleXMiLCJ3aW5uZXIiLCJ3aW5uZXJWb3RlcyIsIndpbm5lclBlcmNlbnRhZ2UiLCJzY29yZSIsInJlc3VsdHMiLCJhYnN0ZW50aW9ucyIsImFic3RlbnRpb25QZXJjZW50YWdlIiwiY2FsY3VsYXRpb25UaW1lIiwidm90aW5nTWV0aG9kIiwicGFydGljaXBhdGlvblJhdGUiLCJjYWxjdWxhdGVkQXQiLCJtZXRhZGF0YSIsIm1ldGhvZCIsInVuZGVmaW5lZCIsIkVycm9yIiwiZ2V0Q29uZmlndXJhdGlvbiIsImRlc2NyaXB0aW9uIiwiYWxsb3dzTXVsdGlwbGVTZWxlY3Rpb25zIiwicmVxdWlyZXNSYW5raW5nIiwibWF4U2VsZWN0aW9ucyIsImNvc3RGdW5jdGlvbiJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7O0NBUUM7Ozs7K0JBaUJZQTs7O2VBQUFBOzs7d0JBZlU7QUFlaEIsTUFBTUE7SUFFWEMsa0JBQWdDO1FBQzlCLE9BQU87SUFDVDtJQUVBLE1BQU1DLGFBQWFDLE9BQW9CLEVBQUVDLElBQWMsRUFBMkI7UUFDaEYsSUFBSTtZQUNGLE1BQU1DLFdBQVdGLFFBQVFFLFFBQVE7WUFFakMscUNBQXFDO1lBQ3JDLElBQUksQ0FBQ0EsU0FBU0MsV0FBVyxJQUFJLE9BQU9ELFNBQVNDLFdBQVcsS0FBSyxVQUFVO2dCQUNyRSxPQUFPO29CQUNMQyxPQUFPO29CQUNQQyxTQUFTO29CQUNUQyxPQUFPO29CQUNQQyxRQUFRO3dCQUFDO3FCQUF3QztvQkFDakRDLHdCQUF3QjtvQkFDeEJDLGdCQUFnQjtnQkFDbEI7WUFDRjtZQUVBLG1DQUFtQztZQUNuQyxNQUFNTixjQUFjRCxTQUFTQyxXQUFXO1lBQ3hDLElBQUlPLGNBQWM7WUFFbEIsS0FBSyxNQUFNLENBQUNDLFVBQVVDLE9BQU8sSUFBSUMsT0FBT0MsT0FBTyxDQUFDWCxhQUFjO2dCQUM1RCxJQUFJLE9BQU9TLFdBQVcsWUFBWUEsU0FBUyxHQUFHO29CQUM1QyxPQUFPO3dCQUNMUixPQUFPO3dCQUNQQyxTQUFTO3dCQUNUQyxPQUFPO3dCQUNQ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