{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/polls-mock-supabase.test.ts"],"sourcesContent":["/**\n * Polls API Tests - Mock Supabase Client\n * \n * This test mocks the Supabase client to work in the test environment\n * while still testing the actual API endpoint logic.\n */\n\nimport { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\nimport { NextRequest } from 'next/server';\nimport { GET, POST } from '@/app/api/polls/route';\n\n// Mock the Supabase server client\nconst mockSupabaseClient = {\n  from: jest.fn(() => ({\n    select: jest.fn(() => ({\n      eq: jest.fn(() => ({\n        limit: jest.fn().mockResolvedValue({\n          data: [\n            {\n              id: 'poll-1',\n              title: 'Test Poll 1',\n              total_votes: 10,\n              options: [\n                { id: 'opt-1', text: 'Option 1', votes: 6 },\n                { id: 'opt-2', text: 'Option 2', votes: 4 }\n              ],\n              status: 'active'\n            },\n            {\n              id: 'poll-2',\n              title: 'Test Poll 2',\n              total_votes: 15,\n              options: [\n                { id: 'opt-3', text: 'Option A', votes: 8 },\n                { id: 'opt-4', text: 'Option B', votes: 7 }\n              ],\n              status: 'active'\n            }\n          ],\n          error: null,\n        }),\n      })),\n    })),\n    insert: jest.fn(() => ({\n      select: jest.fn().mockResolvedValue({\n        data: [{ \n          id: 'poll-123', \n          title: 'New Test Poll',\n          total_votes: 0,\n          options: [\n            { id: 'opt-new-1', text: 'New Option 1', votes: 0 },\n            { id: 'opt-new-2', text: 'New Option 2', votes: 0 }\n          ],\n          status: 'active'\n        }],\n        error: null,\n      }),\n    })),\n  })),\n};\n\n// Mock the Supabase server client\njest.mock('@/utils/supabase/server', () => ({\n  getSupabaseServerClient: jest.fn(),\n}));\n\n// Mock authentication middleware\njest.mock('@/lib/core/auth/middleware', () => ({\n  getUser: jest.fn(() => Promise.resolve({\n    id: 'user-123',\n    email: 'test@example.com',\n    role: 'user'\n  })),\n}));\n\n// Mock logger\njest.mock('@/lib/utils/logger', () => ({\n  devLog: jest.fn(),\n}));\n\ndescribe('Polls API - Mock Supabase Client', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Set up the mock to return our mock client\n    const { getSupabaseServerClient } = require('@/utils/supabase/server');\n    getSupabaseServerClient.mockResolvedValue(mockSupabaseClient);\n  });\n\n  afterEach(() => {\n    jest.restoreAllMocks();\n  });\n\n  describe('GET /api/polls - List Polls', () => {\n    it('should return list of polls with mock data', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      console.log('Mock response status:', response.status);\n      console.log('Mock response data:', responseData);\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(responseData.polls.length).toBe(2);\n      expect(responseData.count).toBe(2);\n      expect(responseData.message).toBe('Aggregated poll results only - no individual vote data');\n    });\n\n    it('should handle pagination with mock data', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls?limit=1');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(responseData.polls.length).toBeLessThanOrEqual(1);\n    });\n\n    it('should return proper response structure', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData).toHaveProperty('success');\n      expect(responseData).toHaveProperty('polls');\n      expect(responseData).toHaveProperty('count');\n      expect(responseData).toHaveProperty('message');\n      expect(typeof responseData.success).toBe('boolean');\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(typeof responseData.count).toBe('number');\n      expect(typeof responseData.message).toBe('string');\n    });\n  });\n\n  describe('POST /api/polls - Create Poll', () => {\n    it('should create a new poll with mock authentication', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'Mock Test Poll',\n          options: [\n            { text: 'Mock Option 1' },\n            { text: 'Mock Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      console.log('Mock poll creation response:', responseData);\n\n      expect(response.status).toBe(201);\n      expect(responseData).toHaveProperty('poll');\n      expect(responseData.poll.title).toBe('New Test Poll');\n    });\n\n    it('should reject poll creation without authentication', async () => {\n      // Mock no authentication\n      const { getUser } = require('@/lib/core/auth/middleware');\n      getUser.mockResolvedValueOnce(null);\n\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'Unauthorized Poll',\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(401);\n      expect(responseData.error).toBe('Authentication required to create polls');\n    });\n  });\n});\n"],"names":["jest","mock","getSupabaseServerClient","fn","getUser","Promise","resolve","id","email","role","devLog","mockSupabaseClient","from","select","eq","limit","mockResolvedValue","data","title","total_votes","options","text","votes","status","error","insert","describe","beforeEach","clearAllMocks","require","afterEach","restoreAllMocks","it","request","NextRequest","response","GET","responseData","json","console","log","expect","toBe","success","Array","isArray","polls","length","count","message","toBeLessThanOrEqual","toHaveProperty","method","headers","body","JSON","stringify","POST","poll","mockResolvedValueOnce"],"mappings":"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"}