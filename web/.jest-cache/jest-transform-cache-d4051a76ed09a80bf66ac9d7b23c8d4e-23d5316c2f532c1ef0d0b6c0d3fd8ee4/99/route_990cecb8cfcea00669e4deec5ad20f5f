925b46ee5d68701638899f8d7540a859
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "POST", {
    enumerable: true,
    get: function() {
        return POST;
    }
});
const _server = require("next/server");
const _ratelimit = require("../../../../lib/core/security/rate-limit");
const _logger = require("../../../../lib/utils/logger");
const _server1 = require("../../../../utils/supabase/server");
async function POST(request) {
    try {
        // CSRF protection is handled by Next.js middleware in production
        // For now, we'll skip CSRF validation in test environment
        // Rate limiting: 10 login attempts per 15 minutes per IP
        const rateLimitResult = await _ratelimit.rateLimiters.auth.check(request);
        if (!rateLimitResult.allowed) {
            return _server.NextResponse.json({
                message: "Too many login attempts. Please try again later."
            }, {
                status: 429
            });
        }
        // Validate request
        const body = await request.json();
        const { email, password } = body;
        // Validate required fields
        if (!email || !password) {
            return _server.NextResponse.json({
                message: "Email and password are required"
            }, {
                status: 400
            });
        }
        // Use Supabase Auth for authentication
        const supabaseClient = await (0, _server1.getSupabaseServerClient)();
        // E2E tests should use real Supabase authentication - no mock responses
        // Sign in with Supabase Auth
        const { data: authData, error: authError } = await supabaseClient.auth.signInWithPassword({
            email: email.toLowerCase().trim(),
            password
        });
        if (authError || !authData.user) {
            _logger.logger.warn("Login failed", {
                email,
                error: authError?.message
            });
            return _server.NextResponse.json({
                message: "Invalid email or password"
            }, {
                status: 401
            });
        }
        // Get user profile for additional data
        const { data: profile, error: profileError } = await supabaseClient.from("user_profiles").select("username, trust_tier, display_name, avatar_url, bio, is_active").eq("user_id", authData.user.id).single();
        if (profileError || !profile) {
            _logger.logger.warn("User profile not found after login", {
                userId: authData.user.id
            });
            return _server.NextResponse.json({
                message: "User profile not found"
            }, {
                status: 404
            });
        }
        // Check if user is active
        if (!profile.is_active) {
            _logger.logger.warn("Inactive user attempted login", {
                userId: authData.user.id
            });
            return _server.NextResponse.json({
                message: "Account is deactivated"
            }, {
                status: 403
            });
        }
        _logger.logger.info("User logged in successfully", {
            userId: authData.user.id,
            email: authData.user.email,
            username: profile.username
        });
        return _server.NextResponse.json({
            success: true,
            user: {
                id: authData.user.id,
                email: authData.user.email,
                username: profile.username,
                trust_tier: profile.trust_tier,
                display_name: profile.display_name,
                avatar_url: profile.avatar_url,
                bio: profile.bio,
                is_active: profile.is_active
            },
            session: authData.session,
            token: authData.session?.access_token
        });
    } catch (error) {
        _logger.logger.error("Login error", error instanceof Error ? error : new Error(String(error)));
        return _server.NextResponse.json({
            message: "Internal server error"
        }, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9hcHAvYXBpL2F1dGgvbG9naW4vcm91dGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBOZXh0UmVxdWVzdH0gZnJvbSAnbmV4dC9zZXJ2ZXInO1xuaW1wb3J0IHsgTmV4dFJlc3BvbnNlIH0gZnJvbSAnbmV4dC9zZXJ2ZXInXG5cbmltcG9ydCB7IHJhdGVMaW1pdGVycyB9IGZyb20gJ0AvbGliL2NvcmUvc2VjdXJpdHkvcmF0ZS1saW1pdCdcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJ0AvbGliL3V0aWxzL2xvZ2dlcidcbmltcG9ydCB7IGdldFN1cGFiYXNlU2VydmVyQ2xpZW50IH0gZnJvbSAnQC91dGlscy9zdXBhYmFzZS9zZXJ2ZXInXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBQT1NUKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSB7XG4gIHRyeSB7XG4gICAgLy8gQ1NSRiBwcm90ZWN0aW9uIGlzIGhhbmRsZWQgYnkgTmV4dC5qcyBtaWRkbGV3YXJlIGluIHByb2R1Y3Rpb25cbiAgICAvLyBGb3Igbm93LCB3ZSdsbCBza2lwIENTUkYgdmFsaWRhdGlvbiBpbiB0ZXN0IGVudmlyb25tZW50XG5cbiAgICAvLyBSYXRlIGxpbWl0aW5nOiAxMCBsb2dpbiBhdHRlbXB0cyBwZXIgMTUgbWludXRlcyBwZXIgSVBcbiAgICBjb25zdCByYXRlTGltaXRSZXN1bHQgPSBhd2FpdCByYXRlTGltaXRlcnMuYXV0aC5jaGVjayhyZXF1ZXN0KVxuICAgIFxuICAgIGlmICghcmF0ZUxpbWl0UmVzdWx0LmFsbG93ZWQpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBtZXNzYWdlOiAnVG9vIG1hbnkgbG9naW4gYXR0ZW1wdHMuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyB9LFxuICAgICAgICB7IHN0YXR1czogNDI5IH1cbiAgICAgIClcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSByZXF1ZXN0XG4gICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcXVlc3QuanNvbigpXG4gICAgY29uc3QgeyBlbWFpbCwgcGFzc3dvcmQgfSA9IGJvZHlcblxuICAgIC8vIFZhbGlkYXRlIHJlcXVpcmVkIGZpZWxkc1xuICAgIGlmICghZW1haWwgfHwgIXBhc3N3b3JkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgbWVzc2FnZTogJ0VtYWlsIGFuZCBwYXNzd29yZCBhcmUgcmVxdWlyZWQnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDAgfVxuICAgICAgKVxuICAgIH1cblxuICAgIC8vIFVzZSBTdXBhYmFzZSBBdXRoIGZvciBhdXRoZW50aWNhdGlvblxuICAgIGNvbnN0IHN1cGFiYXNlQ2xpZW50ID0gYXdhaXQgZ2V0U3VwYWJhc2VTZXJ2ZXJDbGllbnQoKVxuXG4gICAgLy8gRTJFIHRlc3RzIHNob3VsZCB1c2UgcmVhbCBTdXBhYmFzZSBhdXRoZW50aWNhdGlvbiAtIG5vIG1vY2sgcmVzcG9uc2VzXG5cbiAgICAvLyBTaWduIGluIHdpdGggU3VwYWJhc2UgQXV0aFxuICAgIGNvbnN0IHsgZGF0YTogYXV0aERhdGEsIGVycm9yOiBhdXRoRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlQ2xpZW50LmF1dGguc2lnbkluV2l0aFBhc3N3b3JkKHtcbiAgICAgIGVtYWlsOiBlbWFpbC50b0xvd2VyQ2FzZSgpLnRyaW0oKSxcbiAgICAgIHBhc3N3b3JkXG4gICAgfSlcblxuICAgIGlmIChhdXRoRXJyb3IgfHwgIWF1dGhEYXRhLnVzZXIpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdMb2dpbiBmYWlsZWQnLCB7IGVtYWlsLCBlcnJvcjogYXV0aEVycm9yPy5tZXNzYWdlIH0pXG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgbWVzc2FnZTogJ0ludmFsaWQgZW1haWwgb3IgcGFzc3dvcmQnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgKVxuICAgIH1cblxuICAgIC8vIEdldCB1c2VyIHByb2ZpbGUgZm9yIGFkZGl0aW9uYWwgZGF0YVxuICAgIGNvbnN0IHsgZGF0YTogcHJvZmlsZSwgZXJyb3I6IHByb2ZpbGVFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VDbGllbnRcbiAgICAgIC5mcm9tKCd1c2VyX3Byb2ZpbGVzJylcbiAgICAgIC5zZWxlY3QoJ3VzZXJuYW1lLCB0cnVzdF90aWVyLCBkaXNwbGF5X25hbWUsIGF2YXRhcl91cmwsIGJpbywgaXNfYWN0aXZlJylcbiAgICAgIC5lcSgndXNlcl9pZCcsIGF1dGhEYXRhLnVzZXIuaWQpXG4gICAgICAuc2luZ2xlKClcblxuICAgIGlmIChwcm9maWxlRXJyb3IgfHwgIXByb2ZpbGUpIHtcbiAgICAgIGxvZ2dlci53YXJuKCdVc2VyIHByb2ZpbGUgbm90IGZvdW5kIGFmdGVyIGxvZ2luJywgeyB1c2VySWQ6IGF1dGhEYXRhLnVzZXIuaWQgfSlcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBtZXNzYWdlOiAnVXNlciBwcm9maWxlIG5vdCBmb3VuZCcgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwNCB9XG4gICAgICApXG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBpcyBhY3RpdmVcbiAgICBpZiAoIXByb2ZpbGUuaXNfYWN0aXZlKSB7XG4gICAgICBsb2dnZXIud2FybignSW5hY3RpdmUgdXNlciBhdHRlbXB0ZWQgbG9naW4nLCB7IHVzZXJJZDogYXV0aERhdGEudXNlci5pZCB9KVxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG1lc3NhZ2U6ICdBY2NvdW50IGlzIGRlYWN0aXZhdGVkJyB9LFxuICAgICAgICB7IHN0YXR1czogNDAzIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbygnVXNlciBsb2dnZWQgaW4gc3VjY2Vzc2Z1bGx5JywgeyBcbiAgICAgIHVzZXJJZDogYXV0aERhdGEudXNlci5pZCwgXG4gICAgICBlbWFpbDogYXV0aERhdGEudXNlci5lbWFpbCxcbiAgICAgIHVzZXJuYW1lOiBwcm9maWxlLnVzZXJuYW1lIFxuICAgIH0pXG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oe1xuICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgIHVzZXI6IHtcbiAgICAgICAgaWQ6IGF1dGhEYXRhLnVzZXIuaWQsXG4gICAgICAgIGVtYWlsOiBhdXRoRGF0YS51c2VyLmVtYWlsLFxuICAgICAgICB1c2VybmFtZTogcHJvZmlsZS51c2VybmFtZSxcbiAgICAgICAgdHJ1c3RfdGllcjogcHJvZmlsZS50cnVzdF90aWVyLFxuICAgICAgICBkaXNwbGF5X25hbWU6IHByb2ZpbGUuZGlzcGxheV9uYW1lLFxuICAgICAgICBhdmF0YXJfdXJsOiBwcm9maWxlLmF2YXRhcl91cmwsXG4gICAgICAgIGJpbzogcHJvZmlsZS5iaW8sXG4gICAgICAgIGlzX2FjdGl2ZTogcHJvZmlsZS5pc19hY3RpdmVcbiAgICAgIH0sXG4gICAgICBzZXNzaW9uOiBhdXRoRGF0YS5zZXNzaW9uLFxuICAgICAgdG9rZW46IGF1dGhEYXRhLnNlc3Npb24/LmFjY2Vzc190b2tlblxuICAgIH0pXG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ0xvZ2luIGVycm9yJywgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IEVycm9yKFN0cmluZyhlcnJvcikpKVxuICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgIHsgbWVzc2FnZTogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSxcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgIClcbiAgfVxufSJdLCJuYW1lcyI6WyJQT1NUIiwicmVxdWVzdCIsInJhdGVMaW1pdFJlc3VsdCIsInJhdGVMaW1pdGVycyIsImF1dGgiLCJjaGVjayIsImFsbG93ZWQiLCJOZXh0UmVzcG9uc2UiLCJqc29uIiwibWVzc2FnZSIsInN0YXR1cyIsImJvZHkiLCJlbWFpbCIsInBhc3N3b3JkIiwic3VwYWJhc2VDbGllbnQiLCJnZXRTdXBhYmFzZVNlcnZlckNsaWVudCIsImRhdGEiLCJhdXRoRGF0YSIsImVycm9yIiwiYXV0aEVycm9yIiwic2lnbkluV2l0aFBhc3N3b3JkIiwidG9Mb3dlckNhc2UiLCJ0cmltIiwidXNlciIsImxvZ2dlciIsIndhcm4iLCJwcm9maWxlIiwicHJvZmlsZUVycm9yIiwiZnJvbSIsInNlbGVjdCIsImVxIiwiaWQiLCJzaW5nbGUiLCJ1c2VySWQiLCJpc19hY3RpdmUiLCJpbmZvIiwidXNlcm5hbWUiLCJzdWNjZXNzIiwidHJ1c3RfdGllciIsImRpc3BsYXlfbmFtZSIsImF2YXRhcl91cmwiLCJiaW8iLCJzZXNzaW9uIiwidG9rZW4iLCJhY2Nlc3NfdG9rZW4iLCJFcnJvciIsIlN0cmluZyJdLCJtYXBwaW5ncyI6Ijs7OzsrQkFPc0JBOzs7ZUFBQUE7Ozt3QkFOTzsyQkFFQTt3QkFDTjt5QkFDaUI7QUFFakMsZUFBZUEsS0FBS0MsT0FBb0I7SUFDN0MsSUFBSTtRQUNGLGlFQUFpRTtRQUNqRSwwREFBMEQ7UUFFMUQseURBQXlEO1FBQ3pELE1BQU1DLGtCQUFrQixNQUFNQyx1QkFBWSxDQUFDQyxJQUFJLENBQUNDLEtBQUssQ0FBQ0o7UUFFdEQsSUFBSSxDQUFDQyxnQkFBZ0JJLE9BQU8sRUFBRTtZQUM1QixPQUFPQyxvQkFBWSxDQUFDQyxJQUFJLENBQ3RCO2dCQUFFQyxTQUFTO1lBQW1ELEdBQzlEO2dCQUFFQyxRQUFRO1lBQUk7UUFFbEI7UUFFQSxtQkFBbUI7UUFDbkIsTUFBTUMsT0FBTyxNQUFNVixRQUFRTyxJQUFJO1FBQy9CLE1BQU0sRUFBRUksS0FBSyxFQUFFQyxRQUFRLEVBQUUsR0FBR0Y7UUFFNUIsMkJBQTJCO1FBQzNCLElBQUksQ0FBQ0MsU0FBUyxDQUFDQyxVQUFVO1lBQ3ZCLE9BQU9OLG9CQUFZLENBQUNDLElBQUksQ0FDdEI7Z0JBQUVDLFNBQVM7WUFBa0Ms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