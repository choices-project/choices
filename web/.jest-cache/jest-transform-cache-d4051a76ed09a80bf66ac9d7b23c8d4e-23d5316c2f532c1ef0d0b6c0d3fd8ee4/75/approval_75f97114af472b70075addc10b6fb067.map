{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/strategies/approval.ts"],"sourcesContent":["/**\n * Approval Voting Strategy\n * \n * Implements approval voting where voters can approve (vote for) multiple options.\n * Results show approval scores for each option, with the highest scoring option winning.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\n\nimport type { \n  VotingStrategy, \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  PollData, \n  VoteData, \n  ResultsData,\n  VotingMethod,\n  PollResults\n} from '../types';\n\nexport class ApprovalStrategy implements VotingStrategy {\n  \n  getVotingMethod(): VotingMethod {\n    return 'approval';\n  }\n\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    try {\n      const { voteData } = request;\n      \n      // Check if approvals array is provided\n      if (!voteData.approvals || !Array.isArray(voteData.approvals)) {\n        return {\n          valid: false,\n          errors: ['Approvals array is required for approval voting'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Validate approvals array is not empty\n      if (voteData.approvals.length === 0) {\n        return {\n          valid: false,\n          errors: ['At least one option must be approved'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Validate all approvals are valid integers\n      for (const approval of voteData.approvals) {\n        if (typeof approval !== 'number' || !Number.isInteger(approval)) {\n          return {\n            valid: false,\n            errors: ['All approvals must be valid integers'],\n            requiresAuthentication: true,\n            requiresTokens: false\n          };\n        }\n\n        if (approval < 0 || approval >= poll.options.length) {\n          return {\n            valid: false,\n            errors: ['Invalid option selected'],\n            requiresAuthentication: true,\n            requiresTokens: false\n          };\n        }\n      }\n\n      // Check for duplicate approvals\n      const uniqueApprovals = new Set(voteData.approvals);\n      if (uniqueApprovals.size !== voteData.approvals.length) {\n        return {\n          valid: false,\n          errors: ['Duplicate approvals are not allowed'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Check maximum approvals limit\n      const maxApprovals = poll.settings?.maxChoices || poll.options.length;\n      if (voteData.approvals.length > maxApprovals) {\n        return {\n          valid: false,\n          errors: [`Maximum ${maxApprovals} approvals allowed`],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      devLog('Approval vote validated successfully', {\n        pollId: request.pollId,\n        approvals: voteData.approvals,\n        userId: request.userId\n      });\n\n      return {\n        valid: true,\n        requiresAuthentication: true,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Approval vote validation error:', error);\n      return {\n        valid: false,\n        errors: [error instanceof Error ? error.message : 'Validation failed'],\n        requiresAuthentication: true,\n        requiresTokens: false\n      };\n    }\n  }\n\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    try {\n      const { voteData, userId, pollId, privacyLevel } = request;\n      \n      // Generate vote ID\n      const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      \n      // Create audit receipt\n      const auditReceipt = `receipt_${voteId}_${Date.now()}`;\n\n      // In a real implementation, this would:\n      // 1. Store the vote in the database\n      // 2. Update poll vote counts\n      // 3. Trigger any necessary notifications\n      // 4. Log the vote for audit purposes\n\n      devLog('Approval vote processed successfully', {\n        pollId,\n        voteId,\n        approvals: voteData.approvals,\n        userId,\n        auditReceipt\n      });\n\n      return withOptional({\n        success: true,\n        message: 'Vote submitted successfully',\n        pollId,\n        voteId,\n        auditReceipt,\n        responseTime: 0, // Will be set by the engine\n        metadata: {\n          votingMethod: 'approval',\n          approvals: voteData.approvals,\n          approvedOptions: voteData.approvals?.map(index => poll.options[index]?.text) || []\n        }\n      }, {\n        privacyLevel\n      });\n\n    } catch (error) {\n      devLog('Approval vote processing error:', error);\n      return withOptional({\n        success: false,\n        message: error instanceof Error ? error.message : 'Vote processing failed',\n        pollId: request.pollId,\n        responseTime: 0,\n        metadata: {\n          votingMethod: 'approval',\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      }, {\n        voteId: undefined,\n        auditReceipt: undefined,\n        privacyLevel: request.privacyLevel\n      });\n    }\n  }\n\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    try {\n      const startTime = Date.now();\n      \n      // Count approval votes for each option\n      const approvalScores: Record<string, number> = {};\n      const approvalPercentages: Record<string, number> = {};\n      const optionVotes: Record<string, number> = {};\n      const optionPercentages: Record<string, number> = {};\n      \n      // Initialize scores\n      poll.options.forEach((_, index) => {\n        approvalScores[index.toString()] = 0;\n        approvalPercentages[index.toString()] = 0;\n        optionVotes[index.toString()] = 0;\n        optionPercentages[index.toString()] = 0;\n      });\n\n      // Count approvals\n      let totalVotes = 0;\n      votes.forEach(vote => {\n        if (vote.approvals && Array.isArray(vote.approvals)) {\n          totalVotes++;\n          vote.approvals.forEach(approval => {\n            if (approval !== undefined && approval >= 0 && approval < poll.options.length) {\n              const key = approval.toString();\n              approvalScores[key] = (approvalScores[key] ?? 0) + 1;\n              optionVotes[key] = (optionVotes[key] ?? 0) + 1;\n            }\n          });\n        }\n      });\n\n      // Calculate percentages\n      if (totalVotes > 0) {\n        Object.keys(approvalScores).forEach(optionIndex => {\n          const approvalScore = approvalScores[optionIndex];\n          const optionVote = optionVotes[optionIndex];\n          if (approvalScore !== undefined) {\n            approvalPercentages[optionIndex] = (approvalScore / totalVotes) * 100;\n          }\n          if (optionVote !== undefined) {\n            optionPercentages[optionIndex] = (optionVote / totalVotes) * 100;\n          }\n        });\n      }\n\n      // Find winner (highest approval score)\n      let winner: string | undefined;\n      let winnerVotes = 0;\n      let winnerPercentage = 0;\n\n      if (totalVotes > 0) {\n        Object.entries(approvalScores).forEach(([optionIndex, score]) => {\n          if (score > winnerVotes) {\n            winner = optionIndex;\n            winnerVotes = score;\n            const percentage = approvalPercentages[optionIndex];\n            winnerPercentage = percentage ?? 0;\n          }\n        });\n      }\n\n      const results: PollResults = withOptional({\n        winnerVotes,\n        winnerPercentage,\n        approvalScores,\n        approvalPercentages,\n        optionVotes,\n        optionPercentages,\n        abstentions: 0,\n        abstentionPercentage: 0\n      }, {\n        winner\n      });\n\n      const resultsData: ResultsData = {\n        pollId: poll.id,\n        votingMethod: 'approval',\n        totalVotes,\n        participationRate: totalVotes > 0 ? 100 : 0, // This would be calculated based on eligible voters\n        results,\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          hasWinner: winner !== undefined,\n          isTie: winnerVotes > 0 && Object.values(approvalScores).filter(s => s === winnerVotes).length > 1,\n          averageApprovals: totalVotes > 0 ? votes.reduce((sum, vote) => sum + (vote.approvals?.length || 0), 0) / totalVotes : 0\n        }\n      };\n\n      devLog('Approval results calculated', {\n        pollId: poll.id,\n        totalVotes,\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        calculationTime: Date.now() - startTime\n      });\n\n      return resultsData;\n\n    } catch (error) {\n      devLog('Approval results calculation error:', error);\n      throw new Error(`Failed to calculate approval results: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  getConfiguration(): Record<string, unknown> {\n    return {\n      name: 'Approval Voting',\n      description: 'Voters can approve (vote for) multiple options. The option with the most approvals wins.',\n      minOptions: 2,\n      maxOptions: 100,\n      allowAbstention: true,\n      requiresRanking: false,\n      allowsMultipleSelections: true,\n      resultType: 'highest_score',\n      features: [\n        'Allows multiple selections',\n        'Simple to understand',\n        'Reduces vote splitting',\n        'Good for consensus building'\n      ],\n      limitations: [\n        'No intensity of preference',\n        'May not reflect true preferences',\n        'Can lead to strategic voting'\n      ]\n    };\n  }\n}"],"names":["ApprovalStrategy","getVotingMethod","validateVote","request","poll","voteData","approvals","Array","isArray","valid","errors","requiresAuthentication","requiresTokens","length","approval","Number","isInteger","options","uniqueApprovals","Set","size","maxApprovals","settings","maxChoices","devLog","pollId","userId","error","Error","message","processVote","privacyLevel","voteId","Date","now","Math","random","toString","substr","auditReceipt","withOptional","success","responseTime","metadata","votingMethod","approvedOptions","map","index","text","undefined","calculateResults","votes","startTime","approvalScores","approvalPercentages","optionVotes","optionPercentages","forEach","_","totalVotes","vote","key","Object","keys","optionIndex","approvalScore","optionVote","winner","winnerVotes","winnerPercentage","entries","score","percentage","results","abstentions","abstentionPercentage","resultsData","id","participationRate","calculatedAt","toISOString","calculationTime","hasWinner","isTie","values","filter","s","averageApprovals","reduce","sum","getConfiguration","name","description","minOptions","maxOptions","allowAbstention","requiresRanking","allowsMultipleSelections","resultType","features","limitations"],"mappings":"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"}