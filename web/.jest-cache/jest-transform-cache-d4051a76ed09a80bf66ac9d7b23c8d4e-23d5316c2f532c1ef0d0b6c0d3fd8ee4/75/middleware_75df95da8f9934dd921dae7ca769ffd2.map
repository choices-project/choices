{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/stores/middleware.ts"],"sourcesContent":["/**\n * Store Middleware\n * \n * Collection of middleware functions for Zustand stores\n * Provides logging, performance monitoring, error handling, and persistence\n * \n * Created: October 11, 2025\n * Status: âœ… ACTIVE\n */\n\nimport { logger } from '../utils/logger';\n\nimport type { StoreMiddleware, StoreConfig, PersistOptions } from './types';\n\n/**\n * Logging middleware for store actions\n * Logs all store actions with context and timing information\n */\nexport const loggingMiddleware: StoreMiddleware = (config: any) => (set: any, get: any, api: any) =>\n  config(\n    (...args: any[]) => {\n      const [_partial, _replace, action] = args;\n      const state = get();\n      \n      // Log action with context\n      logger.info('Store action executed', {\n        store: api.getState?.()?.name || 'unknown',\n        action: action || 'unknown',\n        timestamp: new Date().toISOString(),\n        stateSnapshot: {\n          keys: Object.keys(state),\n          size: JSON.stringify(state).length\n        }\n      });\n      \n      set(...args);\n    },\n    get,\n    api\n  );\n\n/**\n * Performance monitoring middleware\n * Tracks store performance metrics and action timing\n */\nexport const performanceMiddleware: StoreMiddleware = (config: any) => (set: any, get: any, api: any) =>\n  config(\n    (...args: any[]) => {\n      const startTime = performance.now();\n      const [_partial, _replace, action] = args;\n      \n      set(...args);\n      \n      const duration = performance.now() - startTime;\n      \n      // Log slow actions\n      if (duration > 10) {\n        logger.warn('Slow store action detected', {\n          action: action || 'unknown',\n          duration: `${duration.toFixed(2)}ms`,\n          threshold: '10ms'\n        });\n      }\n    },\n    get,\n    api\n  );\n\n/**\n * Error handling middleware\n * Catches and logs store errors with context\n */\nexport const errorHandlingMiddleware: StoreMiddleware = (config) => (set, get, api) =>\n  config(\n    (...args: any[]) => {\n      try {\n        set(...args);\n      } catch (error) {\n        logger.error('Store action failed', error instanceof Error ? error : new Error('Unknown error'), {\n          action: args[2] || 'unknown',\n          state: get()\n        });\n        throw error;\n      }\n    },\n    get,\n    api\n  );\n\n/**\n * Persistence middleware with error handling\n * Automatically persists store state to localStorage\n */\nexport const persistenceMiddleware = (options: PersistOptions): StoreMiddleware => (config) => (set, get, api) =>\n  config(\n    (...args: any[]) => {\n      set(...args);\n      \n      // Persist to localStorage with error handling\n      try {\n        const state = get();\n        localStorage.setItem(options.name, JSON.stringify(state));\n      } catch (error) {\n        logger.error('Failed to persist store state', error instanceof Error ? error : new Error('Unknown error'), {\n          storeName: options.name\n        });\n      }\n    },\n    get,\n    api\n  );\n\n/**\n * Analytics middleware\n * Tracks store actions for analytics and user behavior\n */\nexport const analyticsMiddleware: StoreMiddleware = (config) => (set, get, api) =>\n  config(\n    (...args: any[]) => {\n      const [_partial, _replace, action] = args;\n      \n      // Track store actions for analytics\n      if (typeof window !== 'undefined' && (window as any).gtag) {\n        (window as any).gtag('event', 'store_action', {\n          event_category: 'store',\n          event_label: action || 'unknown',\n          value: 1\n        });\n      }\n      \n      set(...args);\n    },\n    get,\n    api\n  );\n\n/**\n * Validation middleware\n * Validates store state against provided validators\n */\nexport const validationMiddleware = (validators: Array<(state: any) => boolean>): StoreMiddleware => (config) => (set, get, api) =>\n  config(\n    (...args: any[]) => {\n      set(...args);\n      \n      const state = get();\n      \n      // Run validators\n      for (const validator of validators) {\n        if (!validator(state)) {\n          logger.warn('Store state validation failed', {\n            state,\n            validators: validators.length\n          });\n        }\n      }\n    },\n    get,\n    api\n  );\n\n/**\n * Batch update middleware\n * Batches multiple updates into a single state change\n */\nexport const batchUpdateMiddleware: StoreMiddleware = (config) => (set, get, api) => {\n  let batchQueue: any[] = [];\n  let batchTimeout: NodeJS.Timeout | null = null;\n  \n  const flushBatch = () => {\n    if (batchQueue.length > 0) {\n      set(...batchQueue);\n      batchQueue = [];\n    }\n    if (batchTimeout) {\n      clearTimeout(batchTimeout);\n      batchTimeout = null;\n    }\n  };\n  \n  return config(\n    (...args: any[]) => {\n      batchQueue = args;\n      \n      if (batchTimeout) {\n        clearTimeout(batchTimeout);\n      }\n      \n      batchTimeout = setTimeout(flushBatch, 0);\n    },\n    get,\n    api\n  );\n};\n\n/**\n * Create middleware chain\n * Combines multiple middleware functions into a single chain\n */\nexport const createMiddlewareChain = (middlewares: StoreMiddleware[]): StoreMiddleware => (config) => {\n  let result = config;\n  \n  for (const middleware of middlewares.reverse()) {\n    result = middleware(result);\n  }\n  \n  return result;\n};\n\n/**\n * Create store middleware based on configuration\n * Automatically applies appropriate middleware based on store config\n */\nexport const createStoreMiddleware = (config: StoreConfig) => {\n  const middlewares: StoreMiddleware[] = [];\n  \n  // Add logging if enabled\n  if (config.logging !== false) {\n    middlewares.push(loggingMiddleware);\n  }\n  \n  // Add performance monitoring\n  middlewares.push(performanceMiddleware);\n  \n  // Add error handling\n  middlewares.push(errorHandlingMiddleware);\n  \n  // Add analytics\n  middlewares.push(analyticsMiddleware);\n  \n  // Add persistence if enabled\n  if (config.persist) {\n    middlewares.push(persistenceMiddleware({\n      name: config.name,\n      version: 1,\n      migrate: (state: any) => state\n    }));\n  }\n  \n  return createMiddlewareChain(middlewares);\n};\n\n/**\n * Development middleware\n * Adds development-only features like state inspection\n */\nexport const developmentMiddleware: StoreMiddleware = (config) => (set, get, api) => {\n  if (process.env.NODE_ENV === 'development') {\n    // Add state inspection to window object\n    if (typeof window !== 'undefined') {\n      (window as any).__STORE_DEBUG__ = {\n        getState: get,\n        setState: set,\n        getActions: () => api\n      };\n    }\n  }\n  \n  return config(set, get, api);\n};\n\n/**\n * Production middleware\n * Optimized for production with minimal overhead\n */\nexport const productionMiddleware: StoreMiddleware = (config) => (set, get, api) => {\n  // Minimal production middleware\n  return config(set, get, api);\n};\n\n/**\n * Store debug utilities\n */\nexport const storeDebug = {\n  logState: (storeName: string, state: any) => {\n    logger.info(`Store state for ${storeName}:`, state);\n  },\n  \n  logActions: (storeName: string, actions: any) => {\n    logger.info(`Store actions for ${storeName}:`, actions);\n  },\n  \n  validateState: (state: any, validators: Array<(state: any) => boolean>) => {\n    const results = validators.map(validator => validator(state));\n    return results.every(result => result);\n  }\n};\n\n/**\n * Store test utilities\n */\nexport const storeTest = {\n  createMockStore: (initialState: any) => ({\n    getState: () => initialState,\n    setState: (newState: any) => ({ ...initialState, ...newState }),\n    subscribe: () => () => {}\n  }),\n  \n  createTestMiddleware: (_name: string): StoreMiddleware => (config) => (set, get, api) => config(set, get, api)\n};\n\n/**\n * Store documentation utilities\n */\nexport const storeDocumentation = {\n  generateStoreDocs: (storeName: string, state: any, actions: any) => {\n    return {\n      name: storeName,\n      state: Object.keys(state),\n      actions: Object.keys(actions),\n      generatedAt: new Date().toISOString()\n    };\n  }\n};"],"names":["analyticsMiddleware","batchUpdateMiddleware","createMiddlewareChain","createStoreMiddleware","developmentMiddleware","errorHandlingMiddleware","loggingMiddleware","performanceMiddleware","persistenceMiddleware","productionMiddleware","storeDebug","storeDocumentation","storeTest","validationMiddleware","config","set","get","api","args","_partial","_replace","action","state","logger","info","store","getState","name","timestamp","Date","toISOString","stateSnapshot","keys","Object","size","JSON","stringify","length","startTime","performance","now","duration","warn","toFixed","threshold","error","Error","options","localStorage","setItem","storeName","window","gtag","event_category","event_label","value","validators","validator","batchQueue","batchTimeout","flushBatch","clearTimeout","setTimeout","middlewares","result","middleware","reverse","logging","push","persist","version","migrate","process","env","NODE_ENV","__STORE_DEBUG__","setState","getActions","logState","logActions","actions","validateState","results","map","every","createMockStore","initialState","newState","subscribe","createTestMiddleware","_name","generateStoreDocs","generatedAt"],"mappings":"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"}