{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/auth/login-route-clean.test.ts"],"sourcesContent":["/**\n * @jest-environment node\n */\n\n// Mock Supabase server client\njest.mock('@/utils/supabase/server', () => ({\n  getSupabaseServerClient: jest.fn(),\n}));\n\nimport { NextRequest } from 'next/server';\nimport { POST } from '@/app/api/auth/login/route';\nimport { getSupabaseServerClient } from '@/utils/supabase/server';\n\n// Create a proper mock chain for Supabase queries\nconst mockQueryChain = {\n  select: jest.fn().mockReturnThis(),\n  eq: jest.fn().mockReturnThis(),\n  single: jest.fn(),\n};\n\n// Mock the Supabase client\nconst mockSupabaseClient = {\n  auth: {\n    signInWithPassword: jest.fn(),\n  },\n  from: jest.fn(() => mockQueryChain),\n};\n\ndescribe('Auth Login Route - Clean Testing', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (getSupabaseServerClient as jest.Mock).mockResolvedValue(mockSupabaseClient);\n  });\n\n  describe('Authentication Tests', () => {\n    it('should handle invalid credentials gracefully', async () => {\n      // Mock authentication failure\n      mockSupabaseClient.auth.signInWithPassword.mockResolvedValue({\n        data: {\n          user: null,\n          session: null,\n        },\n        error: {\n          message: 'Invalid login credentials',\n        },\n      });\n\n      const request = new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'nonexistent@example.com',\n          password: 'wrongpassword',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n          'x-forwarded-for': '127.0.0.1',\n          'user-agent': 'test-agent',\n        },\n      });\n\n      const response = await POST(request);\n      const data = await response.json();\n\n      expect(response.status).toBe(401);\n      expect(data.message).toBe('Invalid email or password');\n    });\n\n    it('should handle successful authentication', async () => {\n      // Mock successful authentication\n      mockSupabaseClient.auth.signInWithPassword.mockResolvedValue({\n        data: {\n          user: {\n            id: 'user-123',\n            email: 'test@example.com',\n            email_confirmed_at: new Date().toISOString(),\n          },\n          session: {\n            access_token: 'access-token',\n            refresh_token: 'refresh-token',\n          },\n        },\n        error: null,\n      });\n\n      // Mock user profile query\n      mockQueryChain.single.mockResolvedValue({\n        data: {\n          id: 'user-123',\n          email: 'test@example.com',\n          name: 'Test User',\n          is_active: true,\n        },\n        error: null,\n      });\n\n      const request = new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'password123',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n          'x-forwarded-for': '127.0.0.1',\n          'user-agent': 'test-agent',\n        },\n      });\n\n      const response = await POST(request);\n      const data = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(data.success).toBe(true);\n      expect(data.user).toBeDefined();\n    });\n\n    it('should handle missing credentials', async () => {\n      const request = new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: JSON.stringify({}),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const response = await POST(request);\n      const data = await response.json();\n\n      expect(response.status).toBe(400);\n      expect(data.message).toBe('Email and password are required');\n    });\n\n    it('should handle malformed JSON', async () => {\n      const request = new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: 'invalid json',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const response = await POST(request);\n      const data = await response.json();\n\n      expect(response.status).toBe(400);\n      expect(data.message).toContain('Invalid JSON');\n    });\n  });\n\n  describe('Rate Limiting Tests', () => {\n    it('should handle rate limiting', async () => {\n      // This test would require mocking the rate limiter\n      // For now, we'll test the basic functionality\n      const request = new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'password123',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const response = await POST(request);\n      expect(response.status).toBeDefined();\n    });\n  });\n\n  describe('Performance Tests', () => {\n    it('should respond within performance budget', async () => {\n      const startTime = Date.now();\n\n      // Mock successful authentication\n      mockSupabaseClient.auth.signInWithPassword.mockResolvedValue({\n        data: {\n          user: {\n            id: 'user-123',\n            email: 'test@example.com',\n            email_confirmed_at: new Date().toISOString(),\n          },\n          session: {\n            access_token: 'access-token',\n            refresh_token: 'refresh-token',\n          },\n        },\n        error: null,\n      });\n\n      mockQueryChain.single.mockResolvedValue({\n        data: {\n          id: 'user-123',\n          email: 'test@example.com',\n          name: 'Test User',\n          is_active: true,\n        },\n        error: null,\n      });\n\n      const request = new NextRequest('http://localhost:3000/api/auth/login', {\n        method: 'POST',\n        body: JSON.stringify({\n          email: 'test@example.com',\n          password: 'password123',\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const response = await POST(request);\n      const endTime = Date.now();\n\n      expect(response.status).toBe(200);\n      expect(endTime - startTime).toBeLessThan(1000); // 1 second budget\n    });\n  });\n});\n"],"names":["jest","mock","getSupabaseServerClient","fn","mockQueryChain","select","mockReturnThis","eq","single","mockSupabaseClient","auth","signInWithPassword","from","describe","beforeEach","clearAllMocks","mockResolvedValue","it","data","user","session","error","message","request","NextRequest","method","body","JSON","stringify","email","password","headers","response","POST","json","expect","status","toBe","id","email_confirmed_at","Date","toISOString","access_token","refresh_token","name","is_active","success","toBeDefined","toContain","startTime","now","endTime","toBeLessThan"],"mappings":"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"}