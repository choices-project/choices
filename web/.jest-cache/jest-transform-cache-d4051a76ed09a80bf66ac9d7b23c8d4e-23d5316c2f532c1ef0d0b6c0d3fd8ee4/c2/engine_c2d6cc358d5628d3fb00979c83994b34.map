{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/engine.ts"],"sourcesContent":["/**\n * Core Voting Engine\n * \n * This module provides the main voting engine that orchestrates different voting strategies\n * and handles vote processing, validation, and results calculation.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\n\nimport { ApprovalStrategy } from './strategies/approval';\nimport { QuadraticStrategy } from './strategies/quadratic';\nimport { RangeStrategy } from './strategies/range';\nimport { RankedStrategy } from './strategies/ranked';\nimport { SingleChoiceStrategy } from './strategies/single-choice';\nimport type { \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  VotingStrategy,\n  PollData,\n  VoteData,\n  ResultsData,\n  VotingMethod\n} from './types';\n\nexport interface VoteEngineConfig {\n  maxVotesPerPoll: number;\n  allowMultipleVotes: boolean;\n  requireAuthentication: boolean;\n  minTrustTier: string;\n  rateLimitPerUser: number;\n  rateLimitWindowMs: number;\n}\n\nexport class VoteEngine {\n  private strategies: Map<VotingMethod, VotingStrategy>;\n  private config: VoteEngineConfig;\n  private rateLimitTracker: Map<string, { count: number; resetTime: number }>;\n\n  constructor(config: Partial<VoteEngineConfig> = {}) {\n    this.config = Object.assign({\n      maxVotesPerPoll: 10000,\n      allowMultipleVotes: false,\n      requireAuthentication: true,\n      minTrustTier: 'T0',\n      rateLimitPerUser: 10,\n      rateLimitWindowMs: 60000, // 1 minute\n    }, config);\n\n    // Initialize rate limiting tracker\n    this.rateLimitTracker = new Map();\n\n    // Initialize voting strategies\n    this.strategies = new Map([\n      ['single', new SingleChoiceStrategy()],\n      ['single-choice', new SingleChoiceStrategy()],\n      ['approval', new ApprovalStrategy()],\n      ['ranked', new RankedStrategy()],\n      ['ranked-choice', new RankedStrategy()],\n      ['quadratic', new QuadraticStrategy()],\n      ['range', new RangeStrategy()]\n    ]);\n\n    devLog('VoteEngine initialized with strategies:', Array.from(this.strategies.keys()));\n  }\n\n  /**\n   * Get the appropriate voting strategy for a poll\n   */\n  private getStrategy(method: VotingMethod): VotingStrategy {\n    const strategy = this.strategies.get(method);\n    if (!strategy) {\n      throw new Error(`Unsupported voting method: ${method}`);\n    }\n    return strategy;\n  }\n\n  /**\n   * Validate a vote request\n   */\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    const startTime = Date.now();\n    \n    try {\n      // Basic validation\n      if (!request.pollId || !request.voteData) {\n        return {\n          valid: false,\n          errors: ['Missing required vote data'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check poll ID mismatch\n      if (request.pollId !== poll.id) {\n        return {\n          valid: false,\n          errors: ['Poll ID mismatch'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check if poll exists and is active\n      if (!poll || poll.status !== 'active') {\n        return {\n          valid: false,\n          errors: ['Poll is not active'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check poll end time\n      if (poll.endTime && new Date(poll.endTime) < new Date()) {\n        return {\n          valid: false,\n          errors: ['Poll has ended'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check authentication requirements\n      if (this.config.requireAuthentication && !request.userId && !poll.settings?.anonymousVoting) {\n        return {\n          valid: false,\n          errors: ['Authentication required to vote'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Validate vote options\n      const optionValidation = this.validateVoteOptions(request.voteData, poll);\n      if (!optionValidation.valid) {\n        return optionValidation;\n      }\n\n      // Check rate limiting\n      if (request.userId) {\n        const rateLimitKey = `${request.userId}:${request.pollId}`;\n        const now = Date.now();\n        const rateLimitData = this.rateLimitTracker.get(rateLimitKey);\n        \n        if (rateLimitData) {\n          if (now < rateLimitData.resetTime) {\n            if (rateLimitData.count >= this.config.rateLimitPerUser) {\n              return {\n                valid: false,\n                errors: ['Rate limit exceeded. Please try again later.'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          } else {\n            // Reset the counter if the window has expired\n            rateLimitData.count = 0;\n            rateLimitData.resetTime = now + this.config.rateLimitWindowMs;\n          }\n        } else {\n          // Initialize rate limit tracking\n          this.rateLimitTracker.set(rateLimitKey, {\n            count: 0,\n            resetTime: now + this.config.rateLimitWindowMs\n          });\n        }\n      }\n\n      // Get the appropriate strategy and validate the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const strategyValidation = await strategy.validateVote(request, poll);\n\n      if (!strategyValidation.valid) {\n        return Object.assign({}, strategyValidation, {\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        });\n      }\n\n      devLog('Vote validation completed', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        valid: true,\n        errors: [],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Vote validation error:', error);\n      return {\n        valid: false,\n        errors: [error instanceof Error ? error.message : 'Validation failed'],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n    }\n  }\n\n  /**\n   * Process a vote\n   */\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    const startTime = Date.now();\n    \n    try {\n      // Validate the vote first\n      const validation = await this.validateVote(request, poll);\n      if (!validation.valid) {\n        return {\n            success: false,\n          error: validation.errors?.[0] || 'Vote validation failed',\n            pollId: request.pollId,\n            responseTime: Date.now() - startTime\n        };\n      }\n\n      // Get the appropriate strategy and process the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const result = await strategy.processVote(request, poll);\n\n      // Increment rate limit counter\n      if (request.userId) {\n        const rateLimitKey = `${request.userId}:${request.pollId}`;\n        const rateLimitData = this.rateLimitTracker.get(rateLimitKey);\n        if (rateLimitData) {\n          rateLimitData.count++;\n        }\n      }\n\n      devLog('Vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        voteId: result.voteId,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        ...result,\n        responseTime: Date.now() - startTime\n      };\n\n    } catch (error) {\n      devLog('Vote processing error:', error);\n      return {\n          success: false,\n        error: error instanceof Error ? error.message : 'Vote processing failed',\n          pollId: request.pollId,\n          responseTime: Date.now() - startTime\n      };\n    }\n  }\n\n  /**\n   * Calculate results for a poll\n   */\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    const startTime = Date.now();\n    \n    try {\n      const strategy = this.getStrategy(poll.votingMethod);\n      const results = await strategy.calculateResults(poll, votes);\n\n      devLog('Results calculated successfully', {\n        pollId: poll.id,\n        method: poll.votingMethod,\n        totalVotes: votes.length,\n        duration: Date.now() - startTime\n      });\n\n      return results;\n\n    } catch (error) {\n      devLog('Results calculation error:', error);\n      \n      // Return a basic results structure for unsupported methods\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: votes.length,\n        participationRate: votes.length / 100, // Mock participation rate\n        results: {\n          winner: votes.length > 0 ? poll.options[0]?.id : undefined,\n          winnerVotes: votes.length,\n          winnerPercentage: 100,\n          optionVotes: poll.options.reduce((acc, option) => {\n            acc[option.id] = votes.length;\n            return acc;\n          }, {} as Record<string, number>),\n          optionPercentages: poll.options.reduce((acc, option) => {\n            acc[option.id] = 100;\n            return acc;\n          }, {} as Record<string, number>),\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      };\n    }\n  }\n\n  /**\n   * Validate vote options against poll options\n   */\n  private validateVoteOptions(voteData: VoteRequest['voteData'], poll: PollData): VoteValidation {\n    try {\n      // Check if vote data is valid\n      if (!voteData) {\n        return {\n          valid: false,\n          errors: ['Vote data is required'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Validate based on voting method\n      switch (poll.votingMethod) {\n        case 'single':\n          if (typeof voteData.choice !== 'number' || voteData.choice < 0 || voteData.choice >= poll.options.length) {\n            return {\n              valid: false,\n              errors: ['Invalid option selected'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        case 'approval':\n          if (!Array.isArray(voteData.approvals)) {\n            return {\n              valid: false,\n              errors: ['Approval votes must be an array'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          for (const approval of voteData.approvals) {\n            if (typeof approval !== 'number' || approval < 0 || approval >= poll.options.length) {\n              return {\n                valid: false,\n                errors: ['Invalid option selected'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          }\n          break;\n        \n        case 'ranked':\n          if (!Array.isArray(voteData.rankings)) {\n            return {\n              valid: false,\n              errors: ['Rankings must be an array'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          for (const ranking of voteData.rankings) {\n            if (typeof ranking !== 'number' || ranking < 0 || ranking >= poll.options.length) {\n              return {\n                valid: false,\n                errors: ['Invalid option selected'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          }\n          break;\n        \n        case 'quadratic':\n          if (!voteData.allocations || typeof voteData.allocations !== 'object') {\n            return {\n              valid: false,\n              errors: ['Quadratic voting requires allocations'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        case 'range':\n          if (!voteData.ratings || typeof voteData.ratings !== 'object') {\n            return {\n              valid: false,\n              errors: ['Range voting requires ratings'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        default:\n          return {\n            valid: false,\n            errors: ['Unsupported voting method'],\n            requiresAuthentication: this.config.requireAuthentication,\n            requiresTokens: false\n          };\n      }\n\n      return {\n        valid: true,\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      return {\n        valid: false,\n        errors: ['Vote validation error'],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n    }\n  }\n\n  /**\n   * Get voting method configuration\n   */\n  getVotingMethodConfig(method: VotingMethod): Record<string, unknown> {\n    const strategy = this.getStrategy(method);\n    return strategy.getConfiguration();\n  }\n\n  /**\n   * Update engine configuration\n   */\n  updateConfig(newConfig: Partial<VoteEngineConfig>): void {\n    this.config = Object.assign({}, this.config, newConfig);\n    devLog('VoteEngine configuration updated:', this.config);\n  }\n\n  /**\n   * Get current configuration\n   */\n  getConfig(): VoteEngineConfig {\n    return { ...this.config };\n  }\n}\n\n// Export a default instance\nexport const voteEngine = new VoteEngine();\n"],"names":["VoteEngine","voteEngine","constructor","config","Object","assign","maxVotesPerPoll","allowMultipleVotes","requireAuthentication","minTrustTier","rateLimitPerUser","rateLimitWindowMs","rateLimitTracker","Map","strategies","SingleChoiceStrategy","ApprovalStrategy","RankedStrategy","QuadraticStrategy","RangeStrategy","devLog","Array","from","keys","getStrategy","method","strategy","get","Error","validateVote","request","poll","startTime","Date","now","pollId","voteData","valid","errors","requiresAuthentication","requiresTokens","id","status","endTime","userId","settings","anonymousVoting","optionValidation","validateVoteOptions","rateLimitKey","rateLimitData","resetTime","count","set","votingMethod","strategyValidation","duration","error","message","processVote","validation","success","responseTime","result","voteId","calculateResults","votes","results","totalVotes","length","participationRate","winner","options","undefined","winnerVotes","winnerPercentage","optionVotes","reduce","acc","option","optionPercentages","abstentions","abstentionPercentage","calculatedAt","toISOString","metadata","calculationTime","choice","isArray","approvals","approval","rankings","ranking","allocations","ratings","getVotingMethodConfig","getConfiguration","updateConfig","newConfig","getConfig"],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;;;;IA8BYA,UAAU;eAAVA;;IAqaAC,UAAU;eAAVA;;;wBAjcU;0BAGU;2BACC;uBACJ;wBACC;8BACM;AAqB9B,MAAMD;IAKXE,YAAYC,SAAoC,CAAC,CAAC,CAAE;QAClD,IAAI,CAACA,MAAM,GAAGC,OAAOC,MAAM,CAAC;YAC1BC,iBAAiB;YACjBC,oBAAoB;YACpBC,uBAAuB;YACvBC,cAAc;YACdC,kBAAkB;YAClBC,mBAAmB;QACrB,GAAGR;QAEH,mCAAmC;QACnC,IAAI,CAACS,gBAAgB,GAAG,IAAIC;QAE5B,+BAA+B;QAC/B,IAAI,CAACC,UAAU,GAAG,IAAID,IAAI;YACxB;gBAAC;gBAAU,IAAIE,kCAAoB;aAAG;YACtC;gBAAC;gBAAiB,IAAIA,kCAAoB;aAAG;YAC7C;gBAAC;gBAAY,IAAIC,0BAAgB;aAAG;YACpC;gBAAC;gBAAU,IAAIC,sBAAc;aAAG;YAChC;gBAAC;gBAAiB,IAAIA,sBAAc;aAAG;YACvC;gBAAC;gBAAa,IAAIC,4BAAiB;aAAG;YACtC;gBAAC;gBAAS,IAAIC,oBAAa;aAAG;SAC/B;QAEDC,IAAAA,cAAM,EAAC,2CAA2CC,MAAMC,IAAI,CAAC,IAAI,CAACR,UAAU,CAACS,IAAI;IACnF;IAEA;;GAEC,GACD,AAAQC,YAAYC,MAAoB,EAAkB;QACxD,MAAMC,WAAW,IAAI,CAACZ,UAAU,CAACa,GAAG,CAACF;QACrC,IAAI,CAACC,UAAU;YACb,MAAM,IAAIE,MAAM,CAAC,2BAA2B,EAAEH,OAAO,CAAC;QACxD;QACA,OAAOC;IACT;IAEA;;GAEC,GACD,MAAMG,aAAaC,OAAoB,EAAEC,IAAc,EAA2B;QAChF,MAAMC,YAAYC,KAAKC,GAAG;QAE1B,IAAI;YACF,mBAAmB;YACnB,IAAI,CAACJ,QAAQK,MAAM,IAAI,CAACL,QAAQM,QAAQ,EAAE;gBACxC,OAAO;oBACLC,OAAO;oBACPC,QAAQ;wBAAC;qBAA6B;oBACtCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;oBACzDgC,gBAAgB;gBAClB;YACF;YAEA,yBAAyB;YACzB,IAAIV,QAAQK,MAAM,KAAKJ,KAAKU,EAAE,EAAE;gBAC9B,OAAO;oBACLJ,OAAO;oBACPC,QAAQ;wBAAC;qBAAmB;oBAC5BC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;oBACzDgC,gBAAgB;gBAClB;YACF;YAEA,qCAAqC;YACrC,IAAI,CAACT,QAAQA,KAAKW,MAAM,KAAK,UAAU;gBACrC,OAAO;oBACLL,OAAO;oBACPC,QAAQ;wBAAC;qBAAqB;oBAC9BC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;oBACzDgC,gBAAgB;gBAClB;YACF;YAEA,sBAAsB;YACtB,IAAIT,KAAKY,OAAO,IAAI,IAAIV,KAAKF,KAAKY,OAAO,IAAI,IAAIV,QAAQ;gBACvD,OAAO;oBACLI,OAAO;oBACPC,QAAQ;wBAAC;qBAAiB;oBAC1BC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;oBACzDgC,gBAAgB;gBAClB;YACF;YAEA,oCAAoC;YACpC,IAAI,IAAI,CAACrC,MAAM,CAACK,qBAAqB,IAAI,CAACsB,QAAQc,MAAM,IAAI,CAACb,KAAKc,QAAQ,EAAEC,iBAAiB;gBAC3F,OAAO;oBACLT,OAAO;oBACPC,QAAQ;wBAAC;qBAAkC;oBAC3CC,wBAAwB;oBACxBC,gBAAgB;gBAClB;YACF;YAEA,wBAAwB;YACxB,MAAMO,mBAAmB,IAAI,CAACC,mBAAmB,CAAClB,QAAQM,QAAQ,EAAEL;YACpE,IAAI,CAACgB,iBAAiBV,KAAK,EAAE;gBAC3B,OAAOU;YACT;YAEA,sBAAsB;YACtB,IAAIjB,QAAQc,MAAM,EAAE;gBAClB,MAAMK,eAAe,CAAC,EAAEnB,QAAQc,MAAM,CAAC,CAAC,EAAEd,QAAQK,MAAM,CAAC,CAAC;gBAC1D,MAAMD,MAAMD,KAAKC,GAAG;gBACpB,MAAMgB,gBAAgB,IAAI,CAACtC,gBAAgB,CAACe,GAAG,CAACsB;gBAEhD,IAAIC,eAAe;oBACjB,IAAIhB,MAAMgB,cAAcC,SAAS,EAAE;wBACjC,IAAID,cAAcE,KAAK,IAAI,IAAI,CAACjD,MAAM,CAACO,gBAAgB,EAAE;4BACvD,OAAO;gCACL2B,OAAO;gCACPC,QAAQ;oCAAC;iCAA+C;gCACxDC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;gCACzDgC,gBAAgB;4BAClB;wBACF;oBACF,OAAO;wBACL,8CAA8C;wBAC9CU,cAAcE,KAAK,GAAG;wBACtBF,cAAcC,SAAS,GAAGjB,MAAM,IAAI,CAAC/B,MAAM,CAACQ,iBAAiB;oBAC/D;gBACF,OAAO;oBACL,iCAAiC;oBACjC,IAAI,CAACC,gBAAgB,CAACyC,GAAG,CAACJ,cAAc;wBACtCG,OAAO;wBACPD,WAAWjB,MAAM,IAAI,CAAC/B,MAAM,CAACQ,iBAAiB;oBAChD;gBACF;YACF;YAEA,qDAAqD;YACrD,MAAMe,WAAW,IAAI,CAACF,WAAW,CAACO,KAAKuB,YAAY;YACnD,MAAMC,qBAAqB,MAAM7B,SAASG,YAAY,CAACC,SAASC;YAEhE,IAAI,CAACwB,mBAAmBlB,KAAK,EAAE;gBAC7B,OAAOjC,OAAOC,MAAM,CAAC,CAAC,GAAGkD,oBAAoB;oBAC3ChB,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;oBACzDgC,gBAAgB;gBAClB;YACF;YAEApB,IAAAA,cAAM,EAAC,6BAA6B;gBAClCe,QAAQL,QAAQK,MAAM;gBACtBS,QAAQd,QAAQc,MAAM;gBACtBnB,QAAQM,KAAKuB,YAAY;gBACzBE,UAAUvB,KAAKC,GAAG,KAAKF;YACzB;YAEA,OAAO;gBACLK,OAAO;gBACPC,QAAQ,EAAE;gBACVC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;gBACzDgC,gBAAgB;YAClB;QAEF,EAAE,OAAOiB,OAAO;YACdrC,IAAAA,cAAM,EAAC,0BAA0BqC;YACjC,OAAO;gBACLpB,OAAO;gBACPC,QAAQ;oBAACmB,iBAAiB7B,QAAQ6B,MAAMC,OAAO,GAAG;iBAAoB;gBACtEnB,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;gBACzDgC,gBAAgB;YAClB;QACF;IACF;IAEA;;GAEC,GACD,MAAMmB,YAAY7B,OAAoB,EAAEC,IAAc,EAAyB;QAC7E,MAAMC,YAAYC,KAAKC,GAAG;QAE1B,IAAI;YACF,0BAA0B;YAC1B,MAAM0B,aAAa,MAAM,IAAI,CAAC/B,YAAY,CAACC,SAASC;YACpD,IAAI,CAAC6B,WAAWvB,KAAK,EAAE;gBACrB,OAAO;oBACHwB,SAAS;oBACXJ,OAAOG,WAAWtB,MAAM,EAAE,CAAC,EAAE,IAAI;oBAC/BH,QAAQL,QAAQK,MAAM;oBACtB2B,cAAc7B,KAAKC,GAAG,KAAKF;gBAC/B;YACF;YAEA,oDAAoD;YACpD,MAAMN,WAAW,IAAI,CAACF,WAAW,CAACO,KAAKuB,YAAY;YACnD,MAAMS,SAAS,MAAMrC,SAASiC,WAAW,CAAC7B,SAASC;YAEnD,+BAA+B;YAC/B,IAAID,QAAQc,MAAM,EAAE;gBAClB,MAAMK,eAAe,CAAC,EAAEnB,QAAQc,MAAM,CAAC,CAAC,EAAEd,QAAQK,MAAM,CAAC,CAAC;gBAC1D,MAAMe,gBAAgB,IAAI,CAACtC,gBAAgB,CAACe,GAAG,CAACsB;gBAChD,IAAIC,eAAe;oBACjBA,cAAcE,KAAK;gBACrB;YACF;YAEAhC,IAAAA,cAAM,EAAC,+BAA+B;gBACpCe,QAAQL,QAAQK,MAAM;gBACtBS,QAAQd,QAAQc,MAAM;gBACtBnB,QAAQM,KAAKuB,YAAY;gBACzBU,QAAQD,OAAOC,MAAM;gBACrBR,UAAUvB,KAAKC,GAAG,KAAKF;YACzB;YAEA,OAAO;gBACL,GAAG+B,MAAM;gBACTD,cAAc7B,KAAKC,GAAG,KAAKF;YAC7B;QAEF,EAAE,OAAOyB,OAAO;YACdrC,IAAAA,cAAM,EAAC,0BAA0BqC;YACjC,OAAO;gBACHI,SAAS;gBACXJ,OAAOA,iBAAiB7B,QAAQ6B,MAAMC,OAAO,GAAG;gBAC9CvB,QAAQL,QAAQK,MAAM;gBACtB2B,cAAc7B,KAAKC,GAAG,KAAKF;YAC/B;QACF;IACF;IAEA;;GAEC,GACD,MAAMiC,iBAAiBlC,IAAc,EAAEmC,KAAiB,EAAwB;QAC9E,MAAMlC,YAAYC,KAAKC,GAAG;QAE1B,IAAI;YACF,MAAMR,WAAW,IAAI,CAACF,WAAW,CAACO,KAAKuB,YAAY;YACnD,MAAMa,UAAU,MAAMzC,SAASuC,gBAAgB,CAAClC,MAAMmC;YAEtD9C,IAAAA,cAAM,EAAC,mCAAmC;gBACxCe,QAAQJ,KAAKU,EAAE;gBACfhB,QAAQM,KAAKuB,YAAY;gBACzBc,YAAYF,MAAMG,MAAM;gBACxBb,UAAUvB,KAAKC,GAAG,KAAKF;YACzB;YAEA,OAAOmC;QAET,EAAE,OAAOV,OAAO;YACdrC,IAAAA,cAAM,EAAC,8BAA8BqC;YAErC,2DAA2D;YAC3D,OAAO;gBACLtB,QAAQJ,KAAKU,EAAE;gBACfa,cAAcvB,KAAKuB,YAAY;gBAC/Bc,YAAYF,MAAMG,MAAM;gBACxBC,mBAAmBJ,MAAMG,MAAM,GAAG;gBAClCF,SAAS;oBACPI,QAAQL,MAAMG,MAAM,GAAG,IAAItC,KAAKyC,OAAO,CAAC,EAAE,EAAE/B,KAAKgC;oBACjDC,aAAaR,MAAMG,MAAM;oBACzBM,kBAAkB;oBAClBC,aAAa7C,KAAKyC,OAAO,CAACK,MAAM,CAAC,CAACC,KAAKC;wBACrCD,GAAG,CAACC,OAAOtC,EAAE,CAAC,GAAGyB,MAAMG,MAAM;wBAC7B,OAAOS;oBACT,GAAG,CAAC;oBACJE,mBAAmBjD,KAAKyC,OAAO,CAACK,MAAM,CAAC,CAACC,KAAKC;wBAC3CD,GAAG,CAACC,OAAOtC,EAAE,CAAC,GAAG;wBACjB,OAAOqC;oBACT,GAAG,CAAC;oBACJG,aAAa;oBACbC,sBAAsB;gBACxB;gBACAC,cAAc,IAAIlD,OAAOmD,WAAW;gBACpCC,UAAU;oBACRC,iBAAiBrD,KAAKC,GAAG,KAAKF;oBAC9ByB,OAAOA,iBAAiB7B,QAAQ6B,MAAMC,OAAO,GAAG;gBAClD;YACF;QACF;IACF;IAEA;;GAEC,GACD,AAAQV,oBAAoBZ,QAAiC,EAAEL,IAAc,EAAkB;QAC7F,IAAI;YACF,8BAA8B;YAC9B,IAAI,CAACK,UAAU;gBACb,OAAO;oBACLC,OAAO;oBACPC,QAAQ;wBAAC;qBAAwB;oBACjCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;oBACzDgC,gBAAgB;gBAClB;YACF;YAEA,kCAAkC;YAClC,OAAQT,KAAKuB,YAAY;gBACvB,KAAK;oBACH,IAAI,OAAOlB,SAASmD,MAAM,KAAK,YAAYnD,SAASmD,MAAM,GAAG,KAAKnD,SAASmD,MAAM,IAAIxD,KAAKyC,OAAO,CAACH,MAAM,EAAE;wBACxG,OAAO;4BACLhC,OAAO;4BACPC,QAAQ;gCAAC;6BAA0B;4BACnCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;4BACzDgC,gBAAgB;wBAClB;oBACF;oBACA;gBAEF,KAAK;oBACH,IAAI,CAACnB,MAAMmE,OAAO,CAACpD,SAASqD,SAAS,GAAG;wBACtC,OAAO;4BACLpD,OAAO;4BACPC,QAAQ;gCAAC;6BAAkC;4BAC3CC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;4BACzDgC,gBAAgB;wBAClB;oBACF;oBACA,KAAK,MAAMkD,YAAYtD,SAASqD,SAAS,CAAE;wBACzC,IAAI,OAAOC,aAAa,YAAYA,WAAW,KAAKA,YAAY3D,KAAKyC,OAAO,CAACH,MAAM,EAAE;4BACnF,OAAO;gCACLhC,OAAO;gCACPC,QAAQ;oCAAC;iCAA0B;gCACnCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;gCACzDgC,gBAAgB;4BAClB;wBACF;oBACF;oBACA;gBAEF,KAAK;oBACH,IAAI,CAACnB,MAAMmE,OAAO,CAACpD,SAASuD,QAAQ,GAAG;wBACrC,OAAO;4BACLtD,OAAO;4BACPC,QAAQ;gCAAC;6BAA4B;4BACrCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;4BACzDgC,gBAAgB;wBAClB;oBACF;oBACA,KAAK,MAAMoD,WAAWxD,SAASuD,QAAQ,CAAE;wBACvC,IAAI,OAAOC,YAAY,YAAYA,UAAU,KAAKA,WAAW7D,KAAKyC,OAAO,CAACH,MAAM,EAAE;4BAChF,OAAO;gCACLhC,OAAO;gCACPC,QAAQ;oCAAC;iCAA0B;gCACnCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;gCACzDgC,gBAAgB;4BAClB;wBACF;oBACF;oBACA;gBAEF,KAAK;oBACH,IAAI,CAACJ,SAASyD,WAAW,IAAI,OAAOzD,SAASyD,WAAW,KAAK,UAAU;wBACrE,OAAO;4BACLxD,OAAO;4BACPC,QAAQ;gCAAC;6BAAwC;4BACjDC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;4BACzDgC,gBAAgB;wBAClB;oBACF;oBACA;gBAEF,KAAK;oBACH,IAAI,CAACJ,SAAS0D,OAAO,IAAI,OAAO1D,SAAS0D,OAAO,KAAK,UAAU;wBAC7D,OAAO;4BACLzD,OAAO;4BACPC,QAAQ;gCAAC;6BAAgC;4BACzCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;4BACzDgC,gBAAgB;wBAClB;oBACF;oBACA;gBAEF;oBACE,OAAO;wBACLH,OAAO;wBACPC,QAAQ;4BAAC;yBAA4B;wBACrCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;wBACzDgC,gBAAgB;oBAClB;YACJ;YAEA,OAAO;gBACLH,OAAO;gBACPE,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;gBACzDgC,gBAAgB;YAClB;QAEF,EAAE,OAAOiB,OAAO;YACd,OAAO;gBACLpB,OAAO;gBACPC,QAAQ;oBAAC;iBAAwB;gBACjCC,wBAAwB,IAAI,CAACpC,MAAM,CAACK,qBAAqB;gBACzDgC,gBAAgB;YAClB;QACF;IACF;IAEA;;GAEC,GACDuD,sBAAsBtE,MAAoB,EAA2B;QACnE,MAAMC,WAAW,IAAI,CAACF,WAAW,CAACC;QAClC,OAAOC,SAASsE,gBAAgB;IAClC;IAEA;;GAEC,GACDC,aAAaC,SAAoC,EAAQ;QACvD,IAAI,CAAC/F,MAAM,GAAGC,OAAOC,MAAM,CAAC,CAAC,GAAG,IAAI,CAACF,MAAM,EAAE+F;QAC7C9E,IAAAA,cAAM,EAAC,qCAAqC,IAAI,CAACjB,MAAM;IACzD;IAEA;;GAEC,GACDgG,YAA8B;QAC5B,OAAO;YAAE,GAAG,IAAI,CAAChG,MAAM;QAAC;IAC1B;AACF;AAGO,MAAMF,aAAa,IAAID"}