{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/security/authentication-security.test.ts"],"sourcesContent":["/**\n * Authentication Security Tests - PHASE 3 COMPREHENSIVE TESTING\n * \n * Tests security aspects of the authentication system:\n * - Session management\n * - CSRF protection\n * - Rate limiting\n * - Input validation\n * - Password security\n * - WebAuthn security\n * - Data protection\n */\n\nimport { describe, it, expect, beforeEach, jest } from '@jest/globals';\nimport { render, screen, fireEvent, waitFor } from '@testing-library/react';\nimport { BrowserRouter } from 'react-router-dom';\n\n// Mock Supabase client\nconst mockSupabaseClient = {\n  auth: {\n    signInWithPassword: jest.fn(),\n    signUp: jest.fn(),\n    signOut: jest.fn(),\n    getSession: jest.fn(),\n    onAuthStateChange: jest.fn(),\n    resetPasswordForEmail: jest.fn(),\n    updateUser: jest.fn(),\n  },\n  from: jest.fn(() => ({\n    select: jest.fn(() => ({\n      eq: jest.fn(() => ({\n        single: jest.fn()\n      }))\n    })),\n    insert: jest.fn(),\n    update: jest.fn(),\n    delete: jest.fn()\n  }))\n};\n\n// Mock Next.js router\njest.mock('next/navigation', () => ({\n  useRouter: () => ({\n    push: jest.fn(),\n    replace: jest.fn(),\n    prefetch: jest.fn(),\n  }),\n  usePathname: () => '/auth',\n  useSearchParams: () => new URLSearchParams(),\n}));\n\n// Mock WebAuthn\nObject.defineProperty(navigator, 'credentials', {\n  value: {\n    create: jest.fn(),\n    get: jest.fn(),\n  },\n  writable: true,\n});\n\ndescribe('Authentication Security Tests', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n    // Reset rate limiting\n    jest.clearAllTimers();\n    jest.useFakeTimers();\n  });\n\n  afterEach(() => {\n    jest.useRealTimers();\n  });\n\n  describe('Session Management Security', () => {\n    it('should properly manage session tokens', async () => {\n      const mockSession = {\n        access_token: 'valid-token',\n        refresh_token: 'valid-refresh-token',\n        expires_at: Date.now() + 3600000, // 1 hour\n        user: {\n          id: 'user-123',\n          email: 'test@example.com'\n        }\n      };\n\n      mockSupabaseClient.auth.getSession.mockResolvedValue({\n        data: { session: mockSession },\n        error: null\n      });\n\n      // Test session validation\n      const session = await mockSupabaseClient.auth.getSession();\n      expect(session.data.session).toBeDefined();\n      expect(session.data.session.access_token).toBe('valid-token');\n      expect(session.data.session.expires_at).toBeGreaterThan(Date.now());\n    });\n\n    it('should handle expired sessions securely', async () => {\n      const expiredSession = {\n        access_token: 'expired-token',\n        refresh_token: 'expired-refresh-token',\n        expires_at: Date.now() - 3600000, // 1 hour ago\n        user: {\n          id: 'user-123',\n          email: 'test@example.com'\n        }\n      };\n\n      mockSupabaseClient.auth.getSession.mockResolvedValue({\n        data: { session: expiredSession },\n        error: null\n      });\n\n      const session = await mockSupabaseClient.auth.getSession();\n      expect(session.data.session.expires_at).toBeLessThan(Date.now());\n      \n      // Should trigger refresh or logout\n      expect(mockSupabaseClient.auth.signOut).toHaveBeenCalled();\n    });\n\n    it('should securely store session data', async () => {\n      const sessionData = {\n        access_token: 'secure-token',\n        refresh_token: 'secure-refresh-token',\n        expires_at: Date.now() + 3600000\n      };\n\n      // Test that sensitive data is not exposed\n      expect(sessionData.access_token).not.toContain('password');\n      expect(sessionData.refresh_token).not.toContain('password');\n      \n      // Test that tokens are properly formatted\n      expect(sessionData.access_token).toMatch(/^[A-Za-z0-9-_]+$/);\n      expect(sessionData.refresh_token).toMatch(/^[A-Za-z0-9-_]+$/);\n    });\n  });\n\n  describe('CSRF Protection', () => {\n    it('should include CSRF tokens in requests', async () => {\n      const csrfToken = 'csrf-token-123';\n      \n      // Mock CSRF token generation\n      const generateCSRFToken = jest.fn(() => csrfToken);\n      \n      // Actually call the function to generate token\n      const generatedToken = generateCSRFToken();\n      \n      const request = {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'X-CSRF-Token': generatedToken\n        },\n        body: JSON.stringify({ email: 'test@example.com' })\n      };\n\n      expect(request.headers['X-CSRF-Token']).toBe(csrfToken);\n      expect(generateCSRFToken).toHaveBeenCalled();\n    });\n\n    it('should validate CSRF tokens on server', async () => {\n      const validToken = 'valid-csrf-token';\n      const invalidToken = 'invalid-csrf-token';\n      \n      const validateCSRFToken = jest.fn((token) => token === validToken);\n      \n      expect(validateCSRFToken(validToken)).toBe(true);\n      expect(validateCSRFToken(invalidToken)).toBe(false);\n    });\n\n    it('should reject requests without CSRF tokens', async () => {\n      const requestWithoutCSRF = {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ email: 'test@example.com' })\n      };\n\n      expect(requestWithoutCSRF.headers['X-CSRF-Token']).toBeUndefined();\n      \n      // Should be rejected\n      const isValidRequest = requestWithoutCSRF.headers['X-CSRF-Token'] !== undefined;\n      expect(isValidRequest).toBe(false);\n    });\n  });\n\n  describe('Rate Limiting Security', () => {\n    it('should implement rate limiting for login attempts', async () => {\n      const rateLimiter = {\n        attempts: 0,\n        maxAttempts: 5,\n        windowMs: 15 * 60 * 1000, // 15 minutes\n        lastAttempt: 0\n      };\n\n      const attemptLogin = () => {\n        const now = Date.now();\n        \n        if (now - rateLimiter.lastAttempt > rateLimiter.windowMs) {\n          rateLimiter.attempts = 0;\n        }\n        \n        if (rateLimiter.attempts >= rateLimiter.maxAttempts) {\n          throw new Error('Rate limit exceeded');\n        }\n        \n        rateLimiter.attempts++;\n        rateLimiter.lastAttempt = now;\n        return true;\n      };\n\n      // Test successful attempts\n      for (let i = 0; i < 5; i++) {\n        expect(attemptLogin()).toBe(true);\n      }\n\n      // Test rate limit exceeded\n      expect(() => attemptLogin()).toThrow('Rate limit exceeded');\n    });\n\n    it('should implement rate limiting for password reset', async () => {\n      const passwordResetLimiter = {\n        attempts: 0,\n        maxAttempts: 3,\n        windowMs: 60 * 60 * 1000, // 1 hour\n        lastAttempt: 0\n      };\n\n      const attemptPasswordReset = () => {\n        const now = Date.now();\n        \n        if (now - passwordResetLimiter.lastAttempt > passwordResetLimiter.windowMs) {\n          passwordResetLimiter.attempts = 0;\n        }\n        \n        if (passwordResetLimiter.attempts >= passwordResetLimiter.maxAttempts) {\n          throw new Error('Password reset rate limit exceeded');\n        }\n        \n        passwordResetLimiter.attempts++;\n        passwordResetLimiter.lastAttempt = now;\n        return true;\n      };\n\n      // Test successful attempts\n      for (let i = 0; i < 3; i++) {\n        expect(attemptPasswordReset()).toBe(true);\n      }\n\n      // Test rate limit exceeded\n      expect(() => attemptPasswordReset()).toThrow('Password reset rate limit exceeded');\n    });\n\n    it('should implement IP-based rate limiting', async () => {\n      const ipRateLimiter = new Map();\n      const maxRequestsPerIP = 100;\n      const windowMs = 60 * 1000; // 1 minute\n\n      const checkIPRateLimit = (ip: string) => {\n        const now = Date.now();\n        const ipData = ipRateLimiter.get(ip) || { count: 0, resetTime: now + windowMs };\n        \n        if (now > ipData.resetTime) {\n          ipData.count = 0;\n          ipData.resetTime = now + windowMs;\n        }\n        \n        if (ipData.count >= maxRequestsPerIP) {\n          throw new Error('IP rate limit exceeded');\n        }\n        \n        ipData.count++;\n        ipRateLimiter.set(ip, ipData);\n        return true;\n      };\n\n      // Test IP rate limiting\n      expect(checkIPRateLimit('192.168.1.1')).toBe(true);\n      expect(checkIPRateLimit('192.168.1.2')).toBe(true);\n    });\n  });\n\n  describe('Input Validation Security', () => {\n    it('should validate email format securely', async () => {\n      const validateEmail = (email: string) => {\n        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n        return emailRegex.test(email) && email.length <= 254;\n      };\n\n      // Valid emails\n      expect(validateEmail('test@example.com')).toBe(true);\n      expect(validateEmail('user.name+tag@domain.co.uk')).toBe(true);\n      \n      // Invalid emails\n      expect(validateEmail('invalid-email')).toBe(false);\n      expect(validateEmail('test@')).toBe(false);\n      expect(validateEmail('@domain.com')).toBe(false);\n      expect(validateEmail('test@domain')).toBe(false);\n      \n      // XSS attempts\n      expect(validateEmail('<script>alert(\"xss\")</script>@domain.com')).toBe(false);\n      expect(validateEmail('test@domain.com<script>')).toBe(false);\n    });\n\n    it('should validate password strength securely', async () => {\n      const validatePassword = (password: string) => {\n        if (password.length < 8) return false;\n        if (password.length > 128) return false;\n        \n        const hasUpperCase = /[A-Z]/.test(password);\n        const hasLowerCase = /[a-z]/.test(password);\n        const hasNumbers = /\\d/.test(password);\n        const hasSpecialChar = /[!@#$%^&*(),.?\":{}|<>]/.test(password);\n        \n        return hasUpperCase && hasLowerCase && hasNumbers && hasSpecialChar;\n      };\n\n      // Strong passwords\n      expect(validatePassword('Password123!')).toBe(true);\n      expect(validatePassword('MySecure@Pass1')).toBe(true);\n      \n      // Weak passwords\n      expect(validatePassword('password')).toBe(false);\n      expect(validatePassword('12345678')).toBe(false);\n      expect(validatePassword('Password')).toBe(false);\n      expect(validatePassword('PASSWORD123!')).toBe(false);\n    });\n\n    it('should sanitize user input', async () => {\n      const sanitizeInput = (input: string) => {\n        return input\n          .replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n          .replace(/<[^>]*>/g, '')\n          .trim();\n      };\n\n      // XSS attempts\n      expect(sanitizeInput('<script>alert(\"xss\")</script>Hello')).toBe('Hello');\n      expect(sanitizeInput('<img src=\"x\" onerror=\"alert(1)\">')).toBe('');\n      expect(sanitizeInput('javascript:alert(\"xss\")')).toBe('javascript:alert(\"xss\")');\n      \n      // SQL injection attempts\n      expect(sanitizeInput(\"'; DROP TABLE users; --\")).toBe(\"'; DROP TABLE users; --\");\n    });\n  });\n\n  describe('Password Security', () => {\n    it('should hash passwords securely', async () => {\n      const hashPassword = async (password: string) => {\n        // Mock bcrypt-like hashing with proper length\n        const salt = 'random-salt-12345678901234567890';\n        const hashedPassword = `$2b$10$${salt}${password}${'x'.repeat(20)}`;\n        return hashedPassword;\n      };\n\n      const password = 'MySecurePassword123!';\n      const hashed = await hashPassword(password);\n      \n      expect(hashed).not.toBe(password);\n      expect(hashed).toContain('$2b$10$');\n      expect(hashed.length).toBeGreaterThan(50);\n    });\n\n    it('should verify passwords securely', async () => {\n      const verifyPassword = (password: string, hashedPassword: string) => {\n        // Mock bcrypt-like verification\n        return hashedPassword.includes(password);\n      };\n\n      const password = 'MySecurePassword123!';\n      const hashed = '$2b$10$random-salt-123MySecurePassword123!';\n      \n      expect(verifyPassword(password, hashed)).toBe(true);\n      expect(verifyPassword('wrong-password', hashed)).toBe(false);\n    });\n\n    it('should prevent password reuse', async () => {\n      const passwordHistory = [\n        '$2b$10$salt1$oldpassword1',\n        '$2b$10$salt2$oldpassword2',\n        '$2b$10$salt3$oldpassword3'\n      ];\n\n      const checkPasswordReuse = (newPassword: string, history: string[]) => {\n        return !history.some(hashed => hashed.includes(newPassword));\n      };\n\n      expect(checkPasswordReuse('newpassword', passwordHistory)).toBe(true);\n      expect(checkPasswordReuse('oldpassword1', passwordHistory)).toBe(false);\n    });\n  });\n\n  describe('WebAuthn Security', () => {\n    it('should validate WebAuthn credentials securely', async () => {\n      const mockCredential = {\n        id: 'credential-id-123',\n        type: 'public-key',\n        rawId: new ArrayBuffer(16),\n        response: {\n          clientDataJSON: new ArrayBuffer(32),\n          attestationObject: new ArrayBuffer(64)\n        }\n      };\n\n      const validateWebAuthnCredential = (credential: any) => {\n        const isValid = credential && \n               credential.id && \n               credential.type === 'public-key' &&\n               credential.response &&\n               credential.response.clientDataJSON &&\n               credential.response.attestationObject;\n        return isValid; // Return boolean, not array\n      };\n\n      expect(validateWebAuthnCredential(mockCredential)).toBe(true);\n    });\n\n    it('should handle WebAuthn errors securely', async () => {\n      const handleWebAuthnError = (error: any) => {\n        if (error.name === 'NotAllowedError') {\n          return 'User cancelled authentication';\n        }\n        if (error.name === 'NotSupportedError') {\n          return 'WebAuthn not supported';\n        }\n        if (error.name === 'SecurityError') {\n          return 'Security error occurred';\n        }\n        return 'Unknown error occurred';\n      };\n\n      expect(handleWebAuthnError({ name: 'NotAllowedError' })).toBe('User cancelled authentication');\n      expect(handleWebAuthnError({ name: 'NotSupportedError' })).toBe('WebAuthn not supported');\n      expect(handleWebAuthnError({ name: 'SecurityError' })).toBe('Security error occurred');\n    });\n  });\n\n  describe('Data Protection', () => {\n    it('should encrypt sensitive data', async () => {\n      const encryptData = (data: string, key: string) => {\n        // Mock encryption\n        return `encrypted_${data}_${key}`;\n      };\n\n      const sensitiveData = 'user-personal-information';\n      const encryptionKey = 'secret-key-123';\n      const encrypted = encryptData(sensitiveData, encryptionKey);\n      \n      expect(encrypted).not.toBe(sensitiveData);\n      expect(encrypted).toContain('encrypted_');\n    });\n\n    it('should implement data anonymization', async () => {\n      const anonymizeData = (data: any) => {\n        return {\n          ...data,\n          email: data.email.replace(/(.{2}).*(@.*)/, '$1***$2'),\n          phone: data.phone ? data.phone.replace(/(.{3}).*(.{4})/, '$1***$2') : null,\n          ssn: data.ssn ? '***-**-' + data.ssn.slice(-4) : null\n        };\n      };\n\n      const userData = {\n        email: 'test@example.com',\n        phone: '123-456-7890',\n        ssn: '123-45-6789'\n      };\n\n      const anonymized = anonymizeData(userData);\n      \n      expect(anonymized.email).toBe('te***@example.com');\n      expect(anonymized.phone).toBe('123***7890');\n      expect(anonymized.ssn).toBe('***-**-6789');\n    });\n\n    it('should implement GDPR compliance', async () => {\n      const gdprCompliance = {\n        dataRetention: 365, // days\n        consentRequired: true,\n        rightToErasure: true,\n        dataPortability: true\n      };\n\n      const checkGDPRCompliance = (userData: any) => {\n        return {\n          hasConsent: userData.consentGiven,\n          canDelete: gdprCompliance.rightToErasure,\n          canExport: gdprCompliance.dataPortability,\n          retentionPeriod: gdprCompliance.dataRetention\n        };\n      };\n\n      const userData = { consentGiven: true };\n      const compliance = checkGDPRCompliance(userData);\n      \n      expect(compliance.hasConsent).toBe(true);\n      expect(compliance.canDelete).toBe(true);\n      expect(compliance.canExport).toBe(true);\n    });\n  });\n\n  describe('Security Headers', () => {\n    it('should implement proper security headers', async () => {\n      const securityHeaders = {\n        'X-Content-Type-Options': 'nosniff',\n        'X-Frame-Options': 'DENY',\n        'X-XSS-Protection': '1; mode=block',\n        'Strict-Transport-Security': 'max-age=31536000; includeSubDomains',\n        'Content-Security-Policy': \"default-src 'self'; script-src 'self' 'unsafe-inline'\"\n      };\n\n      Object.entries(securityHeaders).forEach(([header, value]) => {\n        expect(value).toBeTruthy();\n        expect(typeof value).toBe('string');\n      });\n    });\n\n    it('should implement CORS security', async () => {\n      const corsConfig = {\n        origin: ['https://choices.app', 'https://www.choices.app'],\n        methods: ['GET', 'POST', 'PUT', 'DELETE'],\n        allowedHeaders: ['Content-Type', 'Authorization', 'X-CSRF-Token'],\n        credentials: true\n      };\n\n      expect(corsConfig.origin).toContain('https://choices.app');\n      expect(corsConfig.methods).toContain('GET');\n      expect(corsConfig.credentials).toBe(true);\n    });\n  });\n});\n\n\n\n"],"names":["mockSupabaseClient","auth","signInWithPassword","jest","fn","signUp","signOut","getSession","onAuthStateChange","resetPasswordForEmail","updateUser","from","select","eq","single","insert","update","delete","mock","useRouter","push","replace","prefetch","usePathname","useSearchParams","URLSearchParams","Object","defineProperty","navigator","value","create","get","writable","describe","beforeEach","clearAllMocks","clearAllTimers","useFakeTimers","afterEach","useRealTimers","it","mockSession","access_token","refresh_token","expires_at","Date","now","user","id","email","mockResolvedValue","data","session","error","expect","toBeDefined","toBe","toBeGreaterThan","expiredSession","toBeLessThan","toHaveBeenCalled","sessionData","not","toContain","toMatch","csrfToken","generateCSRFToken","generatedToken","request","method","headers","body","JSON","stringify","validToken","invalidToken","validateCSRFToken","token","requestWithoutCSRF","toBeUndefined","isValidRequest","undefined","rateLimiter","attempts","maxAttempts","windowMs","lastAttempt","attemptLogin","Error","i","toThrow","passwordResetLimiter","attemptPasswordReset","ipRateLimiter","Map","maxRequestsPerIP","checkIPRateLimit","ip","ipData","count","resetTime","set","validateEmail","emailRegex","test","length","validatePassword","password","hasUpperCase","hasLowerCase","hasNumbers","hasSpecialChar","sanitizeInput","input","trim","hashPassword","salt","hashedPassword","repeat","hashed","verifyPassword","includes","passwordHistory","checkPasswordReuse","newPassword","history","some","mockCredential","type","rawId","ArrayBuffer","response","clientDataJSON","attestationObject","validateWebAuthnCredential","credential","isValid","handleWebAuthnError","name","encryptData","key","sensitiveData","encryptionKey","encrypted","anonymizeData","phone","ssn","slice","userData","anonymized","gdprCompliance","dataRetention","consentRequired","rightToErasure","dataPortability","checkGDPRCompliance","hasConsent","consentGiven","canDelete","canExport","retentionPeriod","compliance","securityHeaders","entries","forEach","header","toBeTruthy","corsConfig","origin","methods","allowedHeaders","credentials"],"mappings":"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"}