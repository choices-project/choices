{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/pwa/installation.ts"],"sourcesContent":["/**\n * PWA Installation Manager\n * \n * Handles PWA installation prompts, detection, and user experience.\n */\n\nimport { logger } from '@/lib/utils/logger';\n\nexport type BeforeInstallPromptEvent = {\n  readonly platforms: string[];\n  readonly userChoice: Promise<{\n    outcome: 'accepted' | 'dismissed';\n    platform: string;\n  }>;\n  prompt(): Promise<void>;\n} & Event;\n\nexport interface InstallationStatus {\n  isInstallable: boolean;\n  isInstalled: boolean;\n  canPrompt: boolean;\n  platform: string | null;\n  deferredPrompt: BeforeInstallPromptEvent | null;\n}\n\nexport interface InstallationResult {\n  success: boolean;\n  outcome: 'accepted' | 'dismissed' | 'error';\n  platform?: string;\n  error?: string;\n}\n\nclass PWAInstallationManager {\n  private deferredPrompt: BeforeInstallPromptEvent | null = null;\n  private isInstalled = false;\n  private listeners: Array<(status: InstallationStatus) => void> = [];\n\n  constructor() {\n    this.initialize();\n  }\n\n  /**\n   * Initialize installation manager\n   */\n  private initialize(): void {\n    // Only initialize on client side\n    if (typeof window === 'undefined') {\n      return;\n    }\n    \n    // Check if already installed\n    this.checkInstallationStatus();\n\n    // Listen for beforeinstallprompt event\n    window.addEventListener('beforeinstallprompt', this.handleBeforeInstallPrompt.bind(this));\n\n    // Listen for appinstalled event\n    window.addEventListener('appinstalled', this.handleAppInstalled.bind(this));\n\n    // Listen for display mode changes\n    window.matchMedia('(display-mode: standalone)').addEventListener('change', this.handleDisplayModeChange.bind(this));\n  }\n\n  /**\n   * Check if PWA is already installed\n   */\n  private checkInstallationStatus(): void {\n    // Only check on client side\n    if (typeof window === 'undefined') {\n      this.isInstalled = false;\n      this.notifyListeners();\n      return;\n    }\n    \n    const isStandalone = window.matchMedia('(display-mode: standalone)').matches;\n    const isIOSStandalone = (window.navigator as Navigator & { standalone?: boolean }).standalone === true;\n    \n    this.isInstalled = isStandalone || isIOSStandalone;\n    this.notifyListeners();\n  }\n\n  /**\n   * Handle beforeinstallprompt event\n   */\n  private handleBeforeInstallPrompt(event: Event): void {\n    logger.info('PWA: Before install prompt event received');\n    \n    // Prevent the default install prompt\n    event.preventDefault();\n    \n    // Store the event for later use\n    this.deferredPrompt = event as BeforeInstallPromptEvent;\n    \n    this.notifyListeners();\n  }\n\n  /**\n   * Handle appinstalled event\n   */\n  private handleAppInstalled(): void {\n    logger.info('PWA: App installed successfully');\n    \n    this.isInstalled = true;\n    this.deferredPrompt = null;\n    \n    this.notifyListeners();\n    \n    // Dispatch custom event (only on client side)\n    if (typeof window !== 'undefined') {\n      window.dispatchEvent(new CustomEvent('pwa-installed', {\n        detail: { timestamp: new Date().toISOString() }\n      }));\n    }\n  }\n\n  /**\n   * Handle display mode changes\n   */\n  private handleDisplayModeChange(event: MediaQueryListEvent): void {\n    this.isInstalled = event.matches;\n    this.notifyListeners();\n  }\n\n  /**\n   * Get current installation status\n   */\n  getStatus(): InstallationStatus {\n    return {\n      isInstallable: !!this.deferredPrompt,\n      isInstalled: this.isInstalled,\n      canPrompt: !!this.deferredPrompt && !this.isInstalled,\n      platform: this.deferredPrompt?.platforms?.[0] || null,\n      deferredPrompt: this.deferredPrompt\n    };\n  }\n\n  /**\n   * Show installation prompt\n   */\n  async promptInstallation(): Promise<InstallationResult> {\n    if (!this.deferredPrompt) {\n      return {\n        success: false,\n        outcome: 'error',\n        error: 'Installation prompt not available'\n      };\n    }\n\n    try {\n      logger.info('PWA: Showing installation prompt');\n      \n      // Show the install prompt\n      await this.deferredPrompt.prompt();\n      \n      // Wait for the user to respond\n      const choiceResult = await this.deferredPrompt.userChoice;\n      \n      logger.info('PWA: Installation choice:', { outcome: choiceResult.outcome });\n      \n      // Clear the deferred prompt\n      this.deferredPrompt = null;\n      this.notifyListeners();\n      \n      return {\n        success: true,\n        outcome: choiceResult.outcome,\n        platform: choiceResult.platform\n      };\n\n    } catch (error) {\n      logger.error('PWA: Installation prompt failed:', error instanceof Error ? error : undefined, { error: error instanceof Error ? error.message : String(error) });\n      \n      return {\n        success: false,\n        outcome: 'error',\n        error: error instanceof Error ? error.message : 'Unknown error'\n      };\n    }\n  }\n\n  /**\n   * Check if PWA is installable\n   */\n  isInstallable(): boolean {\n    return !!this.deferredPrompt;\n  }\n\n  /**\n   * Check if PWA is installed\n   */\n  isPWAInstalled(): boolean {\n    return this.isInstalled;\n  }\n\n  /**\n   * Get installation criteria\n   */\n  getInstallationCriteria(): {\n    hasServiceWorker: boolean;\n    hasManifest: boolean;\n    isHTTPS: boolean;\n    isEngaging: boolean;\n  } {\n    return {\n      hasServiceWorker: 'serviceWorker' in navigator,\n      hasManifest: !!document.querySelector('link[rel=\"manifest\"]'),\n      isHTTPS: location.protocol === 'https:' || location.hostname === 'localhost',\n      isEngaging: this.isEngaging()\n    };\n  }\n\n  /**\n   * Check if user has been engaging with the app\n   */\n  private isEngaging(): boolean {\n    // Simple engagement check - can be enhanced\n    const sessionStart = sessionStorage.getItem('sessionStart');\n    if (!sessionStart) {\n      sessionStorage.setItem('sessionStart', Date.now().toString());\n      return false;\n    }\n    \n    const sessionDuration = Date.now() - parseInt(sessionStart);\n    return sessionDuration > 30000; // 30 seconds\n  }\n\n  /**\n   * Subscribe to installation status changes\n   */\n  subscribe(listener: (status: InstallationStatus) => void): () => void {\n    this.listeners.push(listener);\n    \n    // Return unsubscribe function\n    return () => {\n      const index = this.listeners.indexOf(listener);\n      if (index > -1) {\n        this.listeners.splice(index, 1);\n      }\n    };\n  }\n\n  /**\n   * Notify listeners of status changes\n   */\n  private notifyListeners(): void {\n    const status = this.getStatus();\n    this.listeners.forEach(listener => {\n      try {\n        listener(status);\n      } catch (error) {\n        logger.error('PWA: Error in installation status listener:', error instanceof Error ? error : undefined, { error: error instanceof Error ? error.message : String(error) });\n      }\n    });\n  }\n\n  /**\n   * Get installation benefits for display\n   */\n  getInstallationBenefits(): string[] {\n    return [\n      'Access Choices directly from your home screen',\n      'Faster loading and better performance',\n      'Works offline - vote even without internet',\n      'Get notifications for new polls and results',\n      'Native app-like experience'\n    ];\n  }\n\n  /**\n   * Get installation instructions for different platforms\n   */\n  getInstallationInstructions(): Record<string, string[]> {\n    return {\n      chrome: [\n        'Click the install button in the address bar',\n        'Or click the three dots menu and select \"Install Choices\"',\n        'Follow the installation prompts'\n      ],\n      firefox: [\n        'Click the install button in the address bar',\n        'Or click the three dots menu and select \"Install\"',\n        'Follow the installation prompts'\n      ],\n      safari: [\n        'Tap the share button in Safari',\n        'Scroll down and tap \"Add to Home Screen\"',\n        'Tap \"Add\" to install'\n      ],\n      edge: [\n        'Click the install button in the address bar',\n        'Or click the three dots menu and select \"Apps\" > \"Install this site as an app\"',\n        'Follow the installation prompts'\n      ]\n    };\n  }\n}\n\n// Create singleton instance\nexport const pwaInstallationManager = new PWAInstallationManager();\n\n/**\n * Get PWA installation status\n */\nexport function getInstallationStatus(): InstallationStatus {\n  return pwaInstallationManager.getStatus();\n}\n\n/**\n * Prompt PWA installation\n */\nexport async function promptPWAInstallation(): Promise<InstallationResult> {\n  return await pwaInstallationManager.promptInstallation();\n}\n\n/**\n * Check if PWA is installable\n */\nexport function isPWAInstallable(): boolean {\n  return pwaInstallationManager.isInstallable();\n}\n\n/**\n * Check if PWA is installed\n */\nexport function isPWAInstalled(): boolean {\n  return pwaInstallationManager.isPWAInstalled();\n}\n\n/**\n * Subscribe to installation status changes\n */\nexport function subscribeToInstallationStatus(\n  listener: (status: InstallationStatus) => void\n): () => void {\n  return pwaInstallationManager.subscribe(listener);\n}\n\n/**\n * Get installation benefits\n */\nexport function getInstallationBenefits(): string[] {\n  return pwaInstallationManager.getInstallationBenefits();\n}\n\n/**\n * Get installation instructions\n */\nexport function getInstallationInstructions(): Record<string, string[]> {\n  return pwaInstallationManager.getInstallationInstructions();\n}\n"],"names":["getInstallationBenefits","getInstallationInstructions","getInstallationStatus","isPWAInstallable","isPWAInstalled","promptPWAInstallation","pwaInstallationManager","subscribeToInstallationStatus","PWAInstallationManager","constructor","deferredPrompt","isInstalled","listeners","initialize","window","checkInstallationStatus","addEventListener","handleBeforeInstallPrompt","bind","handleAppInstalled","matchMedia","handleDisplayModeChange","notifyListeners","isStandalone","matches","isIOSStandalone","navigator","standalone","event","logger","info","preventDefault","dispatchEvent","CustomEvent","detail","timestamp","Date","toISOString","getStatus","isInstallable","canPrompt","platform","platforms","promptInstallation","success","outcome","error","prompt","choiceResult","userChoice","Error","undefined","message","String","getInstallationCriteria","hasServiceWorker","hasManifest","document","querySelector","isHTTPS","location","protocol","hostname","isEngaging","sessionStart","sessionStorage","getItem","setItem","now","toString","sessionDuration","parseInt","subscribe","listener","push","index","indexOf","splice","status","forEach","chrome","firefox","safari","edge"],"mappings":"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"}