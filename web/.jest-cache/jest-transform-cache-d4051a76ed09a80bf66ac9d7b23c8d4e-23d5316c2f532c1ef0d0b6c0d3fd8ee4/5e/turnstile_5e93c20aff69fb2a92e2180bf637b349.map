{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/security/turnstile.ts"],"sourcesContent":["/**\n * Cloudflare Turnstile Integration\n * \n * Implements Cloudflare Turnstile CAPTCHA verification for enhanced security.\n * Protects against automated attacks and bot submissions.\n */\n\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\n\nexport interface TurnstileConfig {\n  secretKey: string;\n  siteKey: string;\n  enabled: boolean;\n  strictMode: boolean;\n  timeout: number;\n}\n\nexport interface TurnstileResponse {\n  success: boolean;\n  challenge_ts?: string;\n  hostname?: string;\n  action?: string;\n  cdata?: string;\n  error_codes?: string[];\n}\n\nexport interface TurnstileVerificationResult {\n  success: boolean;\n  error?: string;\n  errorCodes?: string[];\n  hostname?: string;\n  action?: string;\n  timestamp?: string;\n}\n\n/**\n * Default Turnstile configuration\n */\nconst DEFAULT_TURNSTILE_CONFIG: TurnstileConfig = {\n  secretKey: process.env.TURNSTILE_SECRET_KEY || '',\n  siteKey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || '',\n  enabled: process.env.NODE_ENV === 'production' && !!process.env.TURNSTILE_SECRET_KEY,\n  strictMode: process.env.NODE_ENV === 'production',\n  timeout: 10000, // 10 seconds\n};\n\n/**\n * Verify Turnstile token with Cloudflare\n */\nexport async function verifyTurnstileToken(\n  token: string,\n  config: Partial<TurnstileConfig> = {}\n): Promise<TurnstileVerificationResult> {\n  const finalConfig = Object.assign({}, DEFAULT_TURNSTILE_CONFIG, config);\n\n  // Skip verification if disabled\n  if (!finalConfig.enabled) {\n    devLog('Turnstile verification skipped (disabled)');\n    return { success: true };\n  }\n\n  // Validate required configuration\n  if (!finalConfig.secretKey) {\n    devLog('Turnstile verification failed: Missing secret key');\n    return { \n      success: false, \n      error: 'Turnstile configuration missing' \n    };\n  }\n\n  if (!token) {\n    devLog('Turnstile verification failed: Missing token');\n    return { \n      success: false, \n      error: 'Turnstile token required' \n    };\n  }\n\n  try {\n    // Prepare form data for Cloudflare API\n    const formData = new FormData();\n    formData.append('secret', finalConfig.secretKey);\n    formData.append('response', token);\n    formData.append('remoteip', 'unknown'); // We don't have IP in this context\n\n    // Make request to Cloudflare Turnstile API\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), finalConfig.timeout);\n\n    const response = await fetch('https://challenges.cloudflare.com/turnstile/v0/siteverify', {\n      method: 'POST',\n      body: formData,\n      signal: controller.signal,\n    });\n\n    clearTimeout(timeoutId);\n\n    if (!response.ok) {\n      throw new Error(`Turnstile API error: ${response.status} ${response.statusText}`);\n    }\n\n    const result: TurnstileResponse = await response.json();\n\n    // Log verification attempt\n    devLog('Turnstile verification result:', {\n      success: result.success,\n      errorCodes: result.error_codes,\n      hostname: result.hostname,\n      action: result.action,\n    });\n\n    if (!result.success) {\n      return withOptional(\n        { success: false },\n        { \n          error: 'Turnstile verification failed',\n          errorCodes: result.error_codes\n        }\n      );\n    }\n\n    // Additional validation in strict mode\n    if (finalConfig.strictMode) {\n      const validationResult = validateTurnstileResponse(result, finalConfig);\n      if (!validationResult.success) {\n        return validationResult;\n      }\n    }\n\n    return withOptional(\n      { success: true },\n      { \n        hostname: result.hostname,\n        action: result.action,\n        timestamp: result.challenge_ts\n      }\n    );\n\n  } catch (error) {\n    devLog('Turnstile verification error:', error);\n    \n    if (error instanceof Error && error.name === 'AbortError') {\n      return {\n        success: false,\n        error: 'Turnstile verification timeout',\n      };\n    }\n\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Unknown error',\n    };\n  }\n}\n\n/**\n * Validate Turnstile response in strict mode\n */\nfunction validateTurnstileResponse(\n  response: TurnstileResponse,\n  config: TurnstileConfig\n): TurnstileVerificationResult {\n  // Use config for validation settings\n  if (config.strictMode) {\n    // Validate hostname if provided\n    if (response.hostname) {\n      const allowedHostnames = [\n        'choices-platform.vercel.app',\n        'choices.app',\n        'www.choices.app',\n      ];\n\n      if (process.env.NODE_ENV === 'development') {\n        allowedHostnames.push('localhost', '127.0.0.1');\n      }\n\n      if (!allowedHostnames.includes(response.hostname)) {\n        return {\n          success: false,\n          error: `Invalid hostname: ${response.hostname}`,\n          hostname: response.hostname,\n        };\n      }\n    }\n  }\n\n  // Validate action if provided\n  if (response.action) {\n    const allowedActions = [\n      'login',\n      'register',\n      'vote',\n      'create_poll',\n      'contact',\n    ];\n\n    if (!allowedActions.includes(response.action)) {\n      return {\n        success: false,\n        error: `Invalid action: ${response.action}`,\n        action: response.action,\n      };\n    }\n  }\n\n  return { success: true };\n}\n\n/**\n * Middleware function to verify Turnstile token in API routes\n */\nexport async function requireTurnstileVerification(\n  request: Request,\n  expectedAction?: string,\n  config?: Partial<TurnstileConfig>\n): Promise<void> {\n  const finalConfig = Object.assign({}, DEFAULT_TURNSTILE_CONFIG, config);\n\n  // Skip if disabled\n  if (!finalConfig.enabled) {\n    return;\n  }\n\n  // Extract token from request\n  const token = extractTurnstileToken(request);\n  if (!token) {\n    throw new Error('Turnstile token required');\n  }\n\n  // Verify token\n  const result = await verifyTurnstileToken(token, finalConfig);\n  if (!result.success) {\n    throw new Error(result.error || 'Turnstile verification failed');\n  }\n\n  // Validate action if specified\n  if (expectedAction && result.action && result.action !== expectedAction) {\n    throw new Error(`Invalid Turnstile action: expected ${expectedAction}, got ${result.action}`);\n  }\n}\n\n/**\n * Extract Turnstile token from request\n */\nfunction extractTurnstileToken(request: Request): string | null {\n  // Try to get from request body first\n  if (request.headers.get('content-type')?.includes('application/json')) {\n    // Note: This is a simplified approach. In practice, you'd need to parse the body\n    // For now, we'll rely on the client to send it in headers\n  }\n\n  // Try to get from headers\n  const headerToken = request.headers.get('x-turnstile-token');\n  if (headerToken) {\n    return headerToken;\n  }\n\n  // Try to get from form data (for form submissions)\n  const formToken = request.headers.get('cf-turnstile-response');\n  if (formToken) {\n    return formToken;\n  }\n\n  return null;\n}\n\n/**\n * Generate Turnstile widget configuration for client-side\n */\nexport function getTurnstileWidgetConfig(action?: string): {\n  sitekey: string;\n  action?: string;\n  theme?: 'light' | 'dark' | 'auto';\n  size?: 'normal' | 'compact';\n  tabindex?: number;\n} {\n  return withOptional(\n    {\n      sitekey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || '',\n      theme: 'auto' as const,\n      size: 'normal' as const,\n    },\n    { action }\n  );\n}\n\n/**\n * Check if Turnstile is enabled and configured\n */\nexport function isTurnstileEnabled(): boolean {\n  return DEFAULT_TURNSTILE_CONFIG.enabled && !!DEFAULT_TURNSTILE_CONFIG.secretKey;\n}\n\n/**\n * Get Turnstile site key for client-side\n */\nexport function getTurnstileSiteKey(): string {\n  return process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || '';\n}\n"],"names":["getTurnstileSiteKey","getTurnstileWidgetConfig","isTurnstileEnabled","requireTurnstileVerification","verifyTurnstileToken","DEFAULT_TURNSTILE_CONFIG","secretKey","process","env","TURNSTILE_SECRET_KEY","siteKey","NEXT_PUBLIC_TURNSTILE_SITE_KEY","enabled","NODE_ENV","strictMode","timeout","token","config","finalConfig","Object","assign","devLog","success","error","formData","FormData","append","controller","AbortController","timeoutId","setTimeout","abort","response","fetch","method","body","signal","clearTimeout","ok","Error","status","statusText","result","json","errorCodes","error_codes","hostname","action","withOptional","validationResult","validateTurnstileResponse","timestamp","challenge_ts","name","message","allowedHostnames","push","includes","allowedActions","request","expectedAction","extractTurnstileToken","headers","get","headerToken","formToken","sitekey","theme","size"],"mappings":"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"}