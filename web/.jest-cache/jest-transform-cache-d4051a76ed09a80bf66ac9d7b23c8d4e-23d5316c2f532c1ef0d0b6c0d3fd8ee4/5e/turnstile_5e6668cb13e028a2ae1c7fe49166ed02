7bf10cacabf35e695cfc34b34d4c60a0
/**
 * Cloudflare Turnstile Integration
 * 
 * Implements Cloudflare Turnstile CAPTCHA verification for enhanced security.
 * Protects against automated attacks and bot submissions.
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    getTurnstileSiteKey: function() {
        return getTurnstileSiteKey;
    },
    getTurnstileWidgetConfig: function() {
        return getTurnstileWidgetConfig;
    },
    isTurnstileEnabled: function() {
        return isTurnstileEnabled;
    },
    requireTurnstileVerification: function() {
        return requireTurnstileVerification;
    },
    verifyTurnstileToken: function() {
        return verifyTurnstileToken;
    }
});
const _logger = require("../utils/logger");
/**
 * Default Turnstile configuration
 */ const DEFAULT_TURNSTILE_CONFIG = {
    secretKey: process.env.TURNSTILE_SECRET_KEY || "",
    siteKey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "",
    enabled: process.env.NODE_ENV === "production" && !!process.env.TURNSTILE_SECRET_KEY,
    strictMode: process.env.NODE_ENV === "production",
    timeout: 10000
};
async function verifyTurnstileToken(token, config = {}) {
    const finalConfig = Object.assign({}, DEFAULT_TURNSTILE_CONFIG, config);
    // Skip verification if disabled
    if (!finalConfig.enabled) {
        (0, _logger.devLog)("Turnstile verification skipped (disabled)");
        return {
            success: true
        };
    }
    // Validate required configuration
    if (!finalConfig.secretKey) {
        (0, _logger.devLog)("Turnstile verification failed: Missing secret key");
        return {
            success: false,
            error: "Turnstile configuration missing"
        };
    }
    if (!token) {
        (0, _logger.devLog)("Turnstile verification failed: Missing token");
        return {
            success: false,
            error: "Turnstile token required"
        };
    }
    try {
        // Prepare form data for Cloudflare API
        const formData = new FormData();
        formData.append("secret", finalConfig.secretKey);
        formData.append("response", token);
        formData.append("remoteip", "unknown"); // We don't have IP in this context
        // Make request to Cloudflare Turnstile API
        const controller = new AbortController();
        const timeoutId = setTimeout(()=>controller.abort(), finalConfig.timeout);
        const response = await fetch("https://challenges.cloudflare.com/turnstile/v0/siteverify", {
            method: "POST",
            body: formData,
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`Turnstile API error: ${response.status} ${response.statusText}`);
        }
        const result = await response.json();
        // Log verification attempt
        (0, _logger.devLog)("Turnstile verification result:", {
            success: result.success,
            errorCodes: result.error_codes,
            hostname: result.hostname,
            action: result.action
        });
        if (!result.success) {
            return {
                success: false,
                error: "Turnstile verification failed",
                ...result.error_codes && {
                    errorCodes: result.error_codes
                }
            };
        }
        // Additional validation in strict mode
        if (finalConfig.strictMode) {
            const validationResult = validateTurnstileResponse(result, finalConfig);
            if (!validationResult.success) {
                return validationResult;
            }
        }
        return {
            success: true,
            ...result.hostname && {
                hostname: result.hostname
            },
            ...result.action && {
                action: result.action
            },
            ...result.challenge_ts && {
                timestamp: result.challenge_ts
            }
        };
    } catch (error) {
        (0, _logger.devLog)("Turnstile verification error:", {
            error
        });
        if (error instanceof Error && error.name === "AbortError") {
            return {
                success: false,
                error: "Turnstile verification timeout"
            };
        }
        return {
            success: false,
            error: error instanceof Error ? error.message : "Unknown error"
        };
    }
}
/**
 * Validate Turnstile response in strict mode
 */ function validateTurnstileResponse(response, config) {
    // Use config for validation settings
    if (config.strictMode) {
        // Validate hostname if provided
        if (response.hostname) {
            const allowedHostnames = [
                "choices-platform.vercel.app",
                "choices.app",
                "www.choices.app"
            ];
            if (process.env.NODE_ENV === "development") {
                allowedHostnames.push("localhost", "127.0.0.1");
            }
            if (!allowedHostnames.includes(response.hostname)) {
                return {
                    success: false,
                    error: `Invalid hostname: ${response.hostname}`,
                    hostname: response.hostname
                };
            }
        }
    }
    // Validate action if provided
    if (response.action) {
        const allowedActions = [
            "login",
            "register",
            "vote",
            "create_poll",
            "contact"
        ];
        if (!allowedActions.includes(response.action)) {
            return {
                success: false,
                error: `Invalid action: ${response.action}`,
                action: response.action
            };
        }
    }
    return {
        success: true
    };
}
async function requireTurnstileVerification(request, expectedAction, config) {
    const finalConfig = Object.assign({}, DEFAULT_TURNSTILE_CONFIG, config);
    // Skip if disabled
    if (!finalConfig.enabled) {
        return;
    }
    // Extract token from request
    const token = extractTurnstileToken(request);
    if (!token) {
        throw new Error("Turnstile token required");
    }
    // Verify token
    const result = await verifyTurnstileToken(token, finalConfig);
    if (!result.success) {
        throw new Error(result.error || "Turnstile verification failed");
    }
    // Validate action if specified
    if (expectedAction && result.action && result.action !== expectedAction) {
        throw new Error(`Invalid Turnstile action: expected ${expectedAction}, got ${result.action}`);
    }
}
/**
 * Extract Turnstile token from request
 */ function extractTurnstileToken(request) {
    // Try to get from request body first
    if (request.headers.get("content-type")?.includes("application/json")) {
    // Note: This is a simplified approach. In practice, you'd need to parse the body
    // For now, we'll rely on the client to send it in headers
    }
    // Try to get from headers
    const headerToken = request.headers.get("x-turnstile-token");
    if (headerToken) {
        return headerToken;
    }
    // Try to get from form data (for form submissions)
    const formToken = request.headers.get("cf-turnstile-response");
    if (formToken) {
        return formToken;
    }
    return null;
}
function getTurnstileWidgetConfig(action) {
    return {
        sitekey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "",
        theme: "auto",
        size: "normal",
        ...action && {
            action
        }
    };
}
function isTurnstileEnabled() {
    return DEFAULT_TURNSTILE_CONFIG.enabled && !!DEFAULT_TURNSTILE_CONFIG.secretKey;
}
function getTurnstileSiteKey() {
    return process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "";
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9saWIvc2VjdXJpdHkvdHVybnN0aWxlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ2xvdWRmbGFyZSBUdXJuc3RpbGUgSW50ZWdyYXRpb25cbiAqIFxuICogSW1wbGVtZW50cyBDbG91ZGZsYXJlIFR1cm5zdGlsZSBDQVBUQ0hBIHZlcmlmaWNhdGlvbiBmb3IgZW5oYW5jZWQgc2VjdXJpdHkuXG4gKiBQcm90ZWN0cyBhZ2FpbnN0IGF1dG9tYXRlZCBhdHRhY2tzIGFuZCBib3Qgc3VibWlzc2lvbnMuXG4gKi9cblxuaW1wb3J0IHsgZGV2TG9nIH0gZnJvbSAnQC9saWIvdXRpbHMvbG9nZ2VyJztcblxuZXhwb3J0IGludGVyZmFjZSBUdXJuc3RpbGVDb25maWcge1xuICBzZWNyZXRLZXk6IHN0cmluZztcbiAgc2l0ZUtleTogc3RyaW5nO1xuICBlbmFibGVkOiBib29sZWFuO1xuICBzdHJpY3RNb2RlOiBib29sZWFuO1xuICB0aW1lb3V0OiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHVybnN0aWxlUmVzcG9uc2Uge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICBjaGFsbGVuZ2VfdHM/OiBzdHJpbmc7XG4gIGhvc3RuYW1lPzogc3RyaW5nO1xuICBhY3Rpb24/OiBzdHJpbmc7XG4gIGNkYXRhPzogc3RyaW5nO1xuICBlcnJvcl9jb2Rlcz86IHN0cmluZ1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFR1cm5zdGlsZVZlcmlmaWNhdGlvblJlc3VsdCB7XG4gIHN1Y2Nlc3M6IGJvb2xlYW47XG4gIGVycm9yPzogc3RyaW5nO1xuICBlcnJvckNvZGVzPzogc3RyaW5nW107XG4gIGhvc3RuYW1lPzogc3RyaW5nO1xuICBhY3Rpb24/OiBzdHJpbmc7XG4gIHRpbWVzdGFtcD86IHN0cmluZztcbn1cblxuLyoqXG4gKiBEZWZhdWx0IFR1cm5zdGlsZSBjb25maWd1cmF0aW9uXG4gKi9cbmNvbnN0IERFRkFVTFRfVFVSTlNUSUxFX0NPTkZJRzogVHVybnN0aWxlQ29uZmlnID0ge1xuICBzZWNyZXRLZXk6IHByb2Nlc3MuZW52LlRVUk5TVElMRV9TRUNSRVRfS0VZIHx8ICcnLFxuICBzaXRlS2V5OiBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19UVVJOU1RJTEVfU0lURV9LRVkgfHwgJycsXG4gIGVuYWJsZWQ6IHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAncHJvZHVjdGlvbicgJiYgISFwcm9jZXNzLmVudi5UVVJOU1RJTEVfU0VDUkVUX0tFWSxcbiAgc3RyaWN0TW9kZTogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJyxcbiAgdGltZW91dDogMTAwMDAsIC8vIDEwIHNlY29uZHNcbn07XG5cbi8qKlxuICogVmVyaWZ5IFR1cm5zdGlsZSB0b2tlbiB3aXRoIENsb3VkZmxhcmVcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHZlcmlmeVR1cm5zdGlsZVRva2VuKFxuICB0b2tlbjogc3RyaW5nLFxuICBjb25maWc6IFBhcnRpYWw8VHVybnN0aWxlQ29uZmlnPiA9IHt9XG4pOiBQcm9taXNlPFR1cm5zdGlsZVZlcmlmaWNhdGlvblJlc3VsdD4ge1xuICBjb25zdCBmaW5hbENvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfVFVSTlNUSUxFX0NPTkZJRywgY29uZmlnKTtcblxuICAvLyBTa2lwIHZlcmlmaWNhdGlvbiBpZiBkaXNhYmxlZFxuICBpZiAoIWZpbmFsQ29uZmlnLmVuYWJsZWQpIHtcbiAgICBkZXZMb2coJ1R1cm5zdGlsZSB2ZXJpZmljYXRpb24gc2tpcHBlZCAoZGlzYWJsZWQpJyk7XG4gICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSB9O1xuICB9XG5cbiAgLy8gVmFsaWRhdGUgcmVxdWlyZWQgY29uZmlndXJhdGlvblxuICBpZiAoIWZpbmFsQ29uZmlnLnNlY3JldEtleSkge1xuICAgIGRldkxvZygnVHVybnN0aWxlIHZlcmlmaWNhdGlvbiBmYWlsZWQ6IE1pc3Npbmcgc2VjcmV0IGtleScpO1xuICAgIHJldHVybiB7IFxuICAgICAgc3VjY2VzczogZmFsc2UsIFxuICAgICAgZXJyb3I6ICdUdXJuc3RpbGUgY29uZmlndXJhdGlvbiBtaXNzaW5nJyBcbiAgICB9O1xuICB9XG5cbiAgaWYgKCF0b2tlbikge1xuICAgIGRldkxvZygnVHVybnN0aWxlIHZlcmlmaWNhdGlvbiBmYWlsZWQ6IE1pc3NpbmcgdG9rZW4nKTtcbiAgICByZXR1cm4geyBcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLCBcbiAgICAgIGVycm9yOiAnVHVybnN0aWxlIHRva2VuIHJlcXVpcmVkJyBcbiAgICB9O1xuICB9XG5cbiAgdHJ5IHtcbiAgICAvLyBQcmVwYXJlIGZvcm0gZGF0YSBmb3IgQ2xvdWRmbGFyZSBBUElcbiAgICBjb25zdCBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgIGZvcm1EYXRhLmFwcGVuZCgnc2VjcmV0JywgZmluYWxDb25maWcuc2VjcmV0S2V5KTtcbiAgICBmb3JtRGF0YS5hcHBlbmQoJ3Jlc3BvbnNlJywgdG9rZW4pO1xuICAgIGZvcm1EYXRhLmFwcGVuZCgncmVtb3RlaXAnLCAndW5rbm93bicpOyAvLyBXZSBkb24ndCBoYXZlIElQIGluIHRoaXMgY29udGV4dFxuXG4gICAgLy8gTWFrZSByZXF1ZXN0IHRvIENsb3VkZmxhcmUgVHVybnN0aWxlIEFQSVxuICAgIGNvbnN0IGNvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgY29uc3QgdGltZW91dElkID0gc2V0VGltZW91dCgoKSA9PiBjb250cm9sbGVyLmFib3J0KCksIGZpbmFsQ29uZmlnLnRpbWVvdXQpO1xuXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCgnaHR0cHM6Ly9jaGFsbGVuZ2VzLmNsb3VkZmxhcmUuY29tL3R1cm5zdGlsZS92MC9zaXRldmVyaWZ5Jywge1xuICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICBib2R5OiBmb3JtRGF0YSxcbiAgICAgIHNpZ25hbDogY29udHJvbGxlci5zaWduYWwsXG4gICAgfSk7XG5cbiAgICBjbGVhclRpbWVvdXQodGltZW91dElkKTtcblxuICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVHVybnN0aWxlIEFQSSBlcnJvcjogJHtyZXNwb25zZS5zdGF0dXN9ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXN1bHQ6IFR1cm5zdGlsZVJlc3BvbnNlID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuXG4gICAgLy8gTG9nIHZlcmlmaWNhdGlvbiBhdHRlbXB0XG4gICAgZGV2TG9nKCdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIHJlc3VsdDonLCB7XG4gICAgICBzdWNjZXNzOiByZXN1bHQuc3VjY2VzcyxcbiAgICAgIGVycm9yQ29kZXM6IHJlc3VsdC5lcnJvcl9jb2RlcyxcbiAgICAgIGhvc3RuYW1lOiByZXN1bHQuaG9zdG5hbWUsXG4gICAgICBhY3Rpb246IHJlc3VsdC5hY3Rpb24sXG4gICAgfSk7XG5cbiAgICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIGZhaWxlZCcsXG4gICAgICAgIC4uLihyZXN1bHQuZXJyb3JfY29kZXMgJiYgeyBlcnJvckNvZGVzOiByZXN1bHQuZXJyb3JfY29kZXMgfSlcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gQWRkaXRpb25hbCB2YWxpZGF0aW9uIGluIHN0cmljdCBtb2RlXG4gICAgaWYgKGZpbmFsQ29uZmlnLnN0cmljdE1vZGUpIHtcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSB2YWxpZGF0ZVR1cm5zdGlsZVJlc3BvbnNlKHJlc3VsdCwgZmluYWxDb25maWcpO1xuICAgICAgaWYgKCF2YWxpZGF0aW9uUmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIHZhbGlkYXRpb25SZXN1bHQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAuLi4ocmVzdWx0Lmhvc3RuYW1lICYmIHsgaG9zdG5hbWU6IHJlc3VsdC5ob3N0bmFtZSB9KSxcbiAgICAgIC4uLihyZXN1bHQuYWN0aW9uICYmIHsgYWN0aW9uOiByZXN1bHQuYWN0aW9uIH0pLFxuICAgICAgLi4uKHJlc3VsdC5jaGFsbGVuZ2VfdHMgJiYgeyB0aW1lc3RhbXA6IHJlc3VsdC5jaGFsbGVuZ2VfdHMgfSlcbiAgICB9O1xuXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgZGV2TG9nKCdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIGVycm9yOicsIHsgZXJyb3IgfSk7XG4gICAgXG4gICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IgJiYgZXJyb3IubmFtZSA9PT0gJ0Fib3J0RXJyb3InKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6ICdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIHRpbWVvdXQnLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgfTtcbiAgfVxufVxuXG4vKipcbiAqIFZhbGlkYXRlIFR1cm5zdGlsZSByZXNwb25zZSBpbiBzdHJpY3QgbW9kZVxuICovXG5mdW5jdGlvbiB2YWxpZGF0ZVR1cm5zdGlsZVJlc3BvbnNlKFxuICByZXNwb25zZTogVHVybnN0aWxlUmVzcG9uc2UsXG4gIGNvbmZpZzogVHVybnN0aWxlQ29uZmlnXG4pOiBUdXJuc3RpbGVWZXJpZmljYXRpb25SZXN1bHQge1xuICAvLyBVc2UgY29uZmlnIGZvciB2YWxpZGF0aW9uIHNldHRpbmdzXG4gIGlmIChjb25maWcuc3RyaWN0TW9kZSkge1xuICAgIC8vIFZhbGlkYXRlIGhvc3RuYW1lIGlmIHByb3ZpZGVkXG4gICAgaWYgKHJlc3BvbnNlLmhvc3RuYW1lKSB7XG4gICAgICBjb25zdCBhbGxvd2VkSG9zdG5hbWVzID0gW1xuICAgICAgICAnY2hvaWNlcy1wbGF0Zm9ybS52ZXJjZWwuYXBwJyxcbiAgICAgICAgJ2Nob2ljZXMuYXBwJyxcbiAgICAgICAgJ3d3dy5jaG9pY2VzLmFwcCcsXG4gICAgICBdO1xuXG4gICAgICBpZiAocHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcpIHtcbiAgICAgICAgYWxsb3dlZEhvc3RuYW1lcy5wdXNoKCdsb2NhbGhvc3QnLCAnMTI3LjAuMC4xJyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghYWxsb3dlZEhvc3RuYW1lcy5pbmNsdWRlcyhyZXNwb25zZS5ob3N0bmFtZSkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogYEludmFsaWQgaG9zdG5hbWU6ICR7cmVzcG9uc2UuaG9zdG5hbWV9YCxcbiAgICAgICAgICBob3N0bmFtZTogcmVzcG9uc2UuaG9zdG5hbWUsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gVmFsaWRhdGUgYWN0aW9uIGlmIHByb3ZpZGVkXG4gIGlmIChyZXNwb25zZS5hY3Rpb24pIHtcbiAgICBjb25zdCBhbGxvd2VkQWN0aW9ucyA9IFtcbiAgICAgICdsb2dpbicsXG4gICAgICAncmVnaXN0ZXInLFxuICAgICAgJ3ZvdGUnLFxuICAgICAgJ2NyZWF0ZV9wb2xsJyxcbiAgICAgICdjb250YWN0JyxcbiAgICBdO1xuXG4gICAgaWYgKCFhbGxvd2VkQWN0aW9ucy5pbmNsdWRlcyhyZXNwb25zZS5hY3Rpb24pKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IGBJbnZhbGlkIGFjdGlvbjogJHtyZXNwb25zZS5hY3Rpb259YCxcbiAgICAgICAgYWN0aW9uOiByZXNwb25zZS5hY3Rpb24sXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUgfTtcbn1cblxuLyoqXG4gKiBNaWRkbGV3YXJlIGZ1bmN0aW9uIHRvIHZlcmlmeSBUdXJuc3RpbGUgdG9rZW4gaW4gQVBJIHJvdXRlc1xuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVxdWlyZVR1cm5zdGlsZVZlcmlmaWNhdGlvbihcbiAgcmVxdWVzdDogUmVxdWVzdCxcbiAgZXhwZWN0ZWRBY3Rpb24/OiBzdHJpbmcsXG4gIGNvbmZpZz86IFBhcnRpYWw8VHVybnN0aWxlQ29uZmlnPlxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGZpbmFsQ29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9UVVJOU1RJTEVfQ09ORklHLCBjb25maWcpO1xuXG4gIC8vIFNraXAgaWYgZGlzYWJsZWRcbiAgaWYgKCFmaW5hbENvbmZpZy5lbmFibGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgLy8gRXh0cmFjdCB0b2tlbiBmcm9tIHJlcXVlc3RcbiAgY29uc3QgdG9rZW4gPSBleHRyYWN0VHVybnN0aWxlVG9rZW4ocmVxdWVzdCk7XG4gIGlmICghdG9rZW4pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1R1cm5zdGlsZSB0b2tlbiByZXF1aXJlZCcpO1xuICB9XG5cbiAgLy8gVmVyaWZ5IHRva2VuXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHZlcmlmeVR1cm5zdGlsZVRva2VuKHRva2VuLCBmaW5hbENvbmZpZyk7XG4gIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IocmVzdWx0LmVycm9yIHx8ICdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIGZhaWxlZCcpO1xuICB9XG5cbiAgLy8gVmFsaWRhdGUgYWN0aW9uIGlmIHNwZWNpZmllZFxuICBpZiAoZXhwZWN0ZWRBY3Rpb24gJiYgcmVzdWx0LmFjdGlvbiAmJiByZXN1bHQuYWN0aW9uICE9PSBleHBlY3RlZEFjdGlvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBUdXJuc3RpbGUgYWN0aW9uOiBleHBlY3RlZCAke2V4cGVjdGVkQWN0aW9ufSwgZ290ICR7cmVzdWx0LmFjdGlvbn1gKTtcbiAgfVxufVxuXG4vKipcbiAqIEV4dHJhY3QgVHVybnN0aWxlIHRva2VuIGZyb20gcmVxdWVzdFxuICovXG5mdW5jdGlvbiBleHRyYWN0VHVybnN0aWxlVG9rZW4ocmVxdWVzdDogUmVxdWVzdCk6IHN0cmluZyB8IG51bGwge1xuICAvLyBUcnkgdG8gZ2V0IGZyb20gcmVxdWVzdCBib2R5IGZpcnN0XG4gIGlmIChyZXF1ZXN0LmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKT8uaW5jbHVkZXMoJ2FwcGxpY2F0aW9uL2pzb24nKSkge1xuICAgIC8vIE5vdGU6IFRoaXMgaXMgYSBzaW1wbGlmaWVkIGFwcHJvYWNoLiBJbiBwcmFjdGljZSwgeW91J2QgbmVlZCB0byBwYXJzZSB0aGUgYm9keVxuICAgIC8vIEZvciBub3csIHdlJ2xsIHJlbHkgb24gdGhlIGNsaWVudCB0byBzZW5kIGl0IGluIGhlYWRlcnNcbiAgfVxuXG4gIC8vIFRyeSB0byBnZXQgZnJvbSBoZWFkZXJzXG4gIGNvbnN0IGhlYWRlclRva2VuID0gcmVxdWVzdC5oZWFkZXJzLmdldCgneC10dXJuc3RpbGUtdG9rZW4nKTtcbiAgaWYgKGhlYWRlclRva2VuKSB7XG4gICAgcmV0dXJuIGhlYWRlclRva2VuO1xuICB9XG5cbiAgLy8gVHJ5IHRvIGdldCBmcm9tIGZvcm0gZGF0YSAoZm9yIGZvcm0gc3VibWlzc2lvbnMpXG4gIGNvbnN0IGZvcm1Ub2tlbiA9IHJlcXVlc3QuaGVhZGVycy5nZXQoJ2NmLXR1cm5zdGlsZS1yZXNwb25zZScpO1xuICBpZiAoZm9ybVRva2VuKSB7XG4gICAgcmV0dXJuIGZvcm1Ub2tlbjtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG4vKipcbiAqIEdlbmVyYXRlIFR1cm5zdGlsZSB3aWRnZXQgY29uZmlndXJhdGlvbiBmb3IgY2xpZW50LXNpZGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFR1cm5zdGlsZVdpZGdldENvbmZpZyhhY3Rpb24/OiBzdHJpbmcpOiB7XG4gIHNpdGVrZXk6IHN0cmluZztcbiAgYWN0aW9uPzogc3RyaW5nO1xuICB0aGVtZT86ICdsaWdodCcgfCAnZGFyaycgfCAnYXV0byc7XG4gIHNpemU/OiAnbm9ybWFsJyB8ICdjb21wYWN0JztcbiAgdGFiaW5kZXg/OiBudW1iZXI7XG59IHtcbiAgcmV0dXJuIHtcbiAgICBzaXRla2V5OiBwcm9jZXNzLmVudi5ORVhUX1BVQkxJQ19UVVJOU1RJTEVfU0lURV9LRVkgfHwgJycsXG4gICAgdGhlbWU6ICdhdXRvJyBhcyBjb25zdCxcbiAgICBzaXplOiAnbm9ybWFsJyBhcyBjb25zdCxcbiAgICAuLi4oYWN0aW9uICYmIHsgYWN0aW9uIH0pXG4gIH07XG59XG5cbi8qKlxuICogQ2hlY2sgaWYgVHVybnN0aWxlIGlzIGVuYWJsZWQgYW5kIGNvbmZpZ3VyZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzVHVybnN0aWxlRW5hYmxlZCgpOiBib29sZWFuIHtcbiAgcmV0dXJuIERFRkFVTFRfVFVSTlNUSUxFX0NPTkZJRy5lbmFibGVkICYmICEhREVGQVVMVF9UVVJOU1RJTEVfQ09ORklHLnNlY3JldEtleTtcbn1cblxuLyoqXG4gKiBHZXQgVHVybnN0aWxlIHNpdGUga2V5IGZvciBjbGllbnQtc2lkZVxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0VHVybnN0aWxlU2l0ZUtleSgpOiBzdHJpbmcge1xuICByZXR1cm4gcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfVFVSTlNUSUxFX1NJVEVfS0VZIHx8ICcnO1xufVxuIl0sIm5hbWVzIjpbImdldFR1cm5zdGlsZVNpdGVLZXkiLCJnZXRUdXJuc3RpbGVXaWRnZXRDb25maWciLCJpc1R1cm5zdGlsZUVuYWJsZWQiLCJyZXF1aXJlVHVybnN0aWxlVmVyaWZpY2F0aW9uIiwidmVyaWZ5VHVybnN0aWxlVG9rZW4iLCJERUZBVUxUX1RVUk5TVElMRV9DT05GSUciLCJzZWNyZXRLZXkiLCJwcm9jZXNzIiwiZW52IiwiVFVSTlNUSUxFX1NFQ1JFVF9LRVkiLCJzaXRlS2V5IiwiTkVYVF9QVUJMSUNfVFVSTlNUSUxFX1NJVEVfS0VZIiwiZW5hYmxlZCIsIk5PREVfRU5WIiwic3RyaWN0TW9kZSIsInRpbWVvdXQiLCJ0b2tlbiIsImNvbmZpZyIsImZpbmFsQ29uZmlnIiwiT2JqZWN0IiwiYXNzaWduIiwiZGV2TG9nIiwic3VjY2VzcyIsImVycm9yIiwiZm9ybURhdGEiLCJGb3JtRGF0YSIsImFwcGVuZCIsImNvbnRyb2xsZXIiLCJBYm9ydENvbnRyb2xsZXIiLCJ0aW1lb3V0SWQiLCJzZXRUaW1lb3V0IiwiYWJvcnQiLCJyZXNwb25zZSIsImZldGNoIiwibWV0aG9kIiwiYm9keSIsInNpZ25hbCIsImNsZWFyVGltZW91dCIsIm9rIiwiRXJyb3IiLCJzdGF0dXMiLCJzdGF0dXNUZXh0IiwicmVzdWx0IiwianNvbiIsImVycm9yQ29kZXMiLCJlcnJvcl9jb2RlcyIsImhvc3RuYW1lIiwiYWN0aW9uIiwidmFsaWRhdGlvblJlc3VsdCIsInZhbGlkYXRlVHVybnN0aWxlUmVzcG9uc2UiLCJjaGFsbGVuZ2VfdHMiLCJ0aW1lc3RhbXAiLCJuYW1lIiwibWVzc2FnZSIsImFsbG93ZWRIb3N0bmFtZXMiLCJwdXNoIiwiaW5jbHVkZXMiLCJhbGxvd2VkQWN0aW9ucyIsInJlcXVlc3QiLCJleHBlY3RlZEFjdGlvbiIsImV4dHJhY3RUdXJuc3RpbGVUb2tlbiIsImhlYWRlcnMiLCJnZXQiLCJoZWFkZXJUb2tlbiIsImZvcm1Ub2tlbiIsInNpdGVrZXkiLCJ0aGVtZSIsInNpemUiXSwibWFwcGluZ3MiOiJBQUFBOzs7OztDQUtDOzs7Ozs7Ozs7OztJQTZSZUEsbUJBQW1CO2VBQW5CQTs7SUF6QkFDLHdCQUF3Qjtl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