{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/engine.ts"],"sourcesContent":["/**\n * Core Voting Engine\n * \n * This module provides the main voting engine that orchestrates different voting strategies\n * and handles vote processing, validation, and results calculation.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\n\nimport { ApprovalStrategy } from './strategies/approval';\nimport { QuadraticStrategy } from './strategies/quadratic';\nimport { RangeStrategy } from './strategies/range';\nimport { RankedStrategy } from './strategies/ranked';\nimport { SingleChoiceStrategy } from './strategies/single-choice';\nimport type { \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  VotingStrategy,\n  PollData,\n  VoteData,\n  ResultsData,\n  VotingMethod\n} from './types';\n\nexport interface VoteEngineConfig {\n  maxVotesPerPoll: number;\n  allowMultipleVotes: boolean;\n  requireAuthentication: boolean;\n  minTrustTier: string;\n  rateLimitPerUser: number;\n  rateLimitWindowMs: number;\n}\n\nexport class VoteEngine {\n  private strategies: Map<VotingMethod, VotingStrategy>;\n  private config: VoteEngineConfig;\n  private rateLimitTracker: Map<string, { count: number; resetTime: number }>;\n\n  constructor(config: Partial<VoteEngineConfig> = {}) {\n    this.config = Object.assign({\n      maxVotesPerPoll: 10000,\n      allowMultipleVotes: false,\n      requireAuthentication: true,\n      minTrustTier: 'T0',\n      rateLimitPerUser: 10,\n      rateLimitWindowMs: 60000, // 1 minute\n    }, config);\n\n    // Initialize rate limiting tracker\n    this.rateLimitTracker = new Map();\n\n    // Initialize voting strategies\n    this.strategies = new Map([\n      ['single', new SingleChoiceStrategy()],\n      ['single-choice', new SingleChoiceStrategy()],\n      ['approval', new ApprovalStrategy()],\n      ['ranked', new RankedStrategy()],\n      ['ranked-choice', new RankedStrategy()],\n      ['quadratic', new QuadraticStrategy()],\n      ['range', new RangeStrategy()]\n    ]);\n\n    devLog('VoteEngine initialized with strategies:', Array.from(this.strategies.keys()));\n  }\n\n  /**\n   * Get the appropriate voting strategy for a poll\n   */\n  private getStrategy(method: VotingMethod): VotingStrategy {\n    const strategy = this.strategies.get(method);\n    if (!strategy) {\n      throw new Error(`Unsupported voting method: ${method}`);\n    }\n    return strategy;\n  }\n\n  /**\n   * Get voting strategy (public method for testing)\n   */\n  getVotingStrategy(method: VotingMethod): VotingStrategy {\n    return this.getStrategy(method);\n  }\n\n  /**\n   * Save vote to database (for testing)\n   */\n  async saveVote(voteData: VoteData, pollId: string): Promise<string> {\n    // Mock implementation for testing\n    const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    devLog('Vote saved to database', { voteId, pollId });\n    return voteId;\n  }\n\n  /**\n   * Validate a vote request\n   */\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    const startTime = Date.now();\n    \n    try {\n      // Basic validation\n      if (!request.pollId || !request.voteData) {\n        return {\n          valid: false,\n          errors: ['Missing required vote data'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check poll ID mismatch\n      if (request.pollId !== poll.id) {\n        return {\n          valid: false,\n          errors: ['Poll ID mismatch'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check if poll exists and is active\n      if (!poll || poll.status !== 'active') {\n        return {\n          valid: false,\n          errors: ['Poll is not active'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check poll end time\n      if (poll.endTime && new Date(poll.endTime) < new Date()) {\n        return {\n          valid: false,\n          errors: ['Poll has ended'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Check authentication requirements\n      if (this.config.requireAuthentication && !request.userId && !poll.settings?.anonymousVoting) {\n        return {\n          valid: false,\n          errors: ['Authentication required to vote'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Validate vote options\n      const optionValidation = this.validateVoteOptions(request.voteData, poll);\n      if (!optionValidation.valid) {\n        return optionValidation;\n      }\n\n      // Check rate limiting\n      if (request.userId) {\n        const rateLimitKey = `${request.userId}:${request.pollId}`;\n        const now = Date.now();\n        const rateLimitData = this.rateLimitTracker.get(rateLimitKey);\n        \n        if (rateLimitData) {\n          if (now < rateLimitData.resetTime) {\n            // Still within the rate limit window\n            if (rateLimitData.count >= this.config.rateLimitPerUser) {\n              return {\n                valid: false,\n                errors: ['Rate limit exceeded. Please try again later.'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          } else {\n            // Window has expired, reset the counter\n            rateLimitData.count = 0;\n            rateLimitData.resetTime = now + this.config.rateLimitWindowMs;\n          }\n        } else {\n          // Initialize rate limit tracking\n          this.rateLimitTracker.set(rateLimitKey, {\n            count: 0,\n            resetTime: now + this.config.rateLimitWindowMs\n          });\n        }\n        \n        // Increment the counter immediately after checking\n        const currentData = this.rateLimitTracker.get(rateLimitKey);\n        if (currentData) {\n          currentData.count++;\n        }\n      }\n\n      // Get the appropriate strategy and validate the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const strategyValidation = await strategy.validateVote(request, poll);\n\n      if (!strategyValidation.valid) {\n        return Object.assign({}, strategyValidation, {\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        });\n      }\n\n      devLog('Vote validation completed', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        valid: true,\n        errors: [],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Vote validation error:', error);\n      return {\n        valid: false,\n        errors: [error instanceof Error ? error.message : 'Validation failed'],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n    }\n  }\n\n  /**\n   * Process a vote\n   */\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    const startTime = Date.now();\n    \n    try {\n      // Validate the vote first\n      const validation = await this.validateVote(request, poll);\n      if (!validation.valid) {\n        return {\n            success: false,\n          error: validation.errors?.[0] || 'Vote validation failed',\n            pollId: request.pollId,\n            responseTime: Date.now() - startTime\n        };\n      }\n\n\n      // Get the appropriate strategy and process the vote\n      const strategy = this.getStrategy(poll.votingMethod);\n      const result = await strategy.processVote(request, poll);\n\n      devLog('Vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        method: poll.votingMethod,\n        voteId: result.voteId,\n        duration: Date.now() - startTime\n      });\n\n      return {\n        ...result,\n        responseTime: Date.now() - startTime\n      };\n\n    } catch (error) {\n      devLog('Vote processing error:', error);\n      return {\n          success: false,\n        error: error instanceof Error ? error.message : 'Vote processing failed',\n          pollId: request.pollId,\n          responseTime: Date.now() - startTime\n      };\n    }\n  }\n\n  /**\n   * Calculate results for a poll\n   */\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    const startTime = Date.now();\n    \n    try {\n      // Handle empty vote sets\n      if (votes.length === 0) {\n        return {\n          pollId: poll.id,\n          votingMethod: poll.votingMethod,\n          totalVotes: 0,\n          participationRate: 0,\n          results: {\n            winner: null,\n            winnerVotes: 0,\n            winnerPercentage: 0,\n            optionVotes: poll.options.reduce((acc, option) => {\n              acc[option.id] = 0;\n              return acc;\n            }, {} as Record<string, number>),\n            optionPercentages: poll.options.reduce((acc, option) => {\n              acc[option.id] = 0;\n              return acc;\n            }, {} as Record<string, number>),\n            abstentions: 0,\n            abstentionPercentage: 0\n          },\n          calculatedAt: new Date().toISOString(),\n          metadata: {\n            calculationTime: Date.now() - startTime,\n            isEmpty: true\n          }\n        };\n      }\n\n      const strategy = this.getStrategy(poll.votingMethod);\n      const results = await strategy.calculateResults(poll, votes);\n\n      devLog('Results calculated successfully', {\n        pollId: poll.id,\n        method: poll.votingMethod,\n        totalVotes: votes.length,\n        duration: Date.now() - startTime\n      });\n\n      return results;\n\n    } catch (error) {\n      devLog('Results calculation error:', error);\n      \n      // Return a basic results structure for unsupported methods\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: votes.length,\n        participationRate: votes.length / 100, // Mock participation rate\n        results: {\n          winner: votes.length > 0 ? poll.options[0]?.id : undefined,\n          winnerVotes: votes.length,\n          winnerPercentage: 100,\n          optionVotes: poll.options.reduce((acc, option) => {\n            acc[option.id] = votes.length;\n            return acc;\n          }, {} as Record<string, number>),\n          optionPercentages: poll.options.reduce((acc, option) => {\n            acc[option.id] = 100;\n            return acc;\n          }, {} as Record<string, number>),\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      };\n    }\n  }\n\n  /**\n   * Validate vote options against poll options\n   */\n  private validateVoteOptions(voteData: VoteRequest['voteData'], poll: PollData): VoteValidation {\n    try {\n      // Check if vote data is valid\n      if (!voteData) {\n        return {\n          valid: false,\n          errors: ['Vote data is required'],\n          requiresAuthentication: this.config.requireAuthentication,\n          requiresTokens: false\n        };\n      }\n\n      // Validate based on voting method\n      switch (poll.votingMethod) {\n        case 'single':\n          if (typeof voteData.choice !== 'number' || voteData.choice < 0 || voteData.choice >= poll.options.length) {\n            return {\n              valid: false,\n              errors: ['Invalid option selected'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        case 'approval':\n          if (!Array.isArray(voteData.approvals)) {\n            return {\n              valid: false,\n              errors: ['Approval votes must be an array'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          for (const approval of voteData.approvals) {\n            if (typeof approval !== 'number' || approval < 0 || approval >= poll.options.length) {\n              return {\n                valid: false,\n                errors: ['Invalid option selected'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          }\n          break;\n        \n        case 'ranked':\n        case 'ranked-choice':\n          if (!Array.isArray(voteData.rankings)) {\n            return {\n              valid: false,\n              errors: ['Rankings must be an array'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          for (const ranking of voteData.rankings) {\n            if (typeof ranking !== 'number' || ranking < 0 || ranking >= poll.options.length) {\n              return {\n                valid: false,\n                errors: ['Invalid option selected'],\n                requiresAuthentication: this.config.requireAuthentication,\n                requiresTokens: false\n              };\n            }\n          }\n          break;\n        \n        case 'quadratic':\n          if (!voteData.allocations || typeof voteData.allocations !== 'object') {\n            return {\n              valid: false,\n              errors: ['Quadratic voting requires allocations'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        case 'range':\n          if (!voteData.ratings || typeof voteData.ratings !== 'object') {\n            return {\n              valid: false,\n              errors: ['Range voting requires ratings'],\n              requiresAuthentication: this.config.requireAuthentication,\n              requiresTokens: false\n            };\n          }\n          break;\n        \n        default:\n          return {\n            valid: false,\n            errors: ['Unsupported voting method'],\n            requiresAuthentication: this.config.requireAuthentication,\n            requiresTokens: false\n          };\n      }\n\n      return {\n        valid: true,\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      return {\n        valid: false,\n        errors: ['Vote validation error'],\n        requiresAuthentication: this.config.requireAuthentication,\n        requiresTokens: false\n      };\n    }\n  }\n\n  /**\n   * Get voting method configuration\n   */\n  getVotingMethodConfig(method: VotingMethod): Record<string, unknown> {\n    const strategy = this.getStrategy(method);\n    return strategy.getConfiguration();\n  }\n\n  /**\n   * Update engine configuration\n   */\n  updateConfig(newConfig: Partial<VoteEngineConfig>): void {\n    this.config = Object.assign({}, this.config, newConfig);\n    devLog('VoteEngine configuration updated:', this.config);\n  }\n\n  /**\n   * Get current configuration\n   */\n  getConfig(): VoteEngineConfig {\n    return { ...this.config };\n  }\n}\n\n// Export a default instance\nexport const voteEngine = new VoteEngine();\n"],"names":["VoteEngine","voteEngine","constructor","config","Object","assign","maxVotesPerPoll","allowMultipleVotes","requireAuthentication","minTrustTier","rateLimitPerUser","rateLimitWindowMs","rateLimitTracker","Map","strategies","SingleChoiceStrategy","ApprovalStrategy","RankedStrategy","QuadraticStrategy","RangeStrategy","devLog","Array","from","keys","getStrategy","method","strategy","get","Error","getVotingStrategy","saveVote","voteData","pollId","voteId","Date","now","Math","random","toString","substr","validateVote","request","poll","startTime","valid","errors","requiresAuthentication","requiresTokens","id","status","endTime","userId","settings","anonymousVoting","optionValidation","validateVoteOptions","rateLimitKey","rateLimitData","resetTime","count","set","currentData","votingMethod","strategyValidation","duration","error","message","processVote","validation","success","responseTime","result","calculateResults","votes","length","totalVotes","participationRate","results","winner","winnerVotes","winnerPercentage","optionVotes","options","reduce","acc","option","optionPercentages","abstentions","abstentionPercentage","calculatedAt","toISOString","metadata","calculationTime","isEmpty","undefined","choice","isArray","approvals","approval","rankings","ranking","allocations","ratings","getVotingMethodConfig","getConfiguration","updateConfig","newConfig","getConfig"],"mappings":"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"}