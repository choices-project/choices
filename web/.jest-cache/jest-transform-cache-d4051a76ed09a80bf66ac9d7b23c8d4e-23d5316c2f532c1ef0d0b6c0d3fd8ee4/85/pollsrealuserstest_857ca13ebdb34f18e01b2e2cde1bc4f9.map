{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/polls-real-users.test.ts"],"sourcesContent":["/**\n * Polls API Tests - Real Users\n * \n * This test uses REAL test users from the database.\n * No mocks, no polyfills, just real authentication and real data.\n */\n\nimport { describe, it, expect, beforeAll, afterAll, beforeEach, afterEach } from '@jest/globals';\nimport { createClient } from '@supabase/supabase-js';\nimport { NextRequest } from 'next/server';\nimport { GET, POST } from '@/app/api/polls/route';\n\n// Use real Supabase client with real credentials\n// This will fail if real credentials are not set up\nlet supabase: any;\n\ntry {\n  supabase = createClient(\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n  );\n} catch (error) {\n  console.warn('Real Supabase credentials not set up. This test requires real credentials.');\n  console.warn('Please set NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY environment variables.');\n}\n\ndescribe('Polls API - Real Users', () => {\n  let testUser: any;\n  let testPollId: string | null = null;\n\n  beforeAll(async () => {\n    if (!supabase) {\n      console.warn('Skipping tests - Real Supabase credentials not set up');\n      return;\n    }\n\n    // Login with real test user\n    console.log('Logging in with real test user...');\n    const { data, error } = await supabase.auth.signInWithPassword({\n      email: 'test@example.com',\n      password: 'testpassword'\n    });\n\n    if (error) {\n      console.error('Failed to login with test user:', error);\n      throw new Error(`Failed to login with test user: ${error.message}`);\n    }\n\n    testUser = data.user;\n    console.log('Successfully logged in with test user:', testUser.email);\n  });\n\n  afterAll(async () => {\n    if (!supabase) return;\n\n    // Clean up test data\n    if (testPollId) {\n      console.log('Cleaning up test poll:', testPollId);\n      await supabase.from('polls').delete().eq('id', testPollId);\n    }\n\n    // Sign out\n    await supabase.auth.signOut();\n  });\n\n  beforeEach(() => {\n    // Reset test poll ID\n    testPollId = null;\n  });\n\n  afterEach(async () => {\n    if (!supabase) return;\n\n    // Clean up any test data created during the test\n    if (testPollId) {\n      await supabase.from('polls').delete().eq('id', testPollId);\n      testPollId = null;\n    }\n  });\n\n  describe('GET /api/polls - List Polls', () => {\n    it('should return list of polls from real database', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      console.log('Real database response status:', response.status);\n      console.log('Real database response data:', responseData);\n\n      // Should return 200 status\n      expect(response.status).toBe(200);\n      \n      // Should have the expected structure\n      expect(responseData).toHaveProperty('success');\n      expect(responseData).toHaveProperty('polls');\n      expect(responseData).toHaveProperty('count');\n      expect(responseData).toHaveProperty('message');\n      \n      // Should have correct data types\n      expect(typeof responseData.success).toBe('boolean');\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(typeof responseData.count).toBe('number');\n      expect(typeof responseData.message).toBe('string');\n    });\n\n    it('should handle pagination with real database', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      const request = new NextRequest('http://localhost:3000/api/polls?limit=5');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      console.log('Pagination response:', responseData);\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(responseData.polls.length).toBeLessThanOrEqual(5);\n    });\n  });\n\n  describe('POST /api/polls - Create Poll', () => {\n    it('should create a new poll with real user authentication', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      // First, we need to mock the authentication middleware\n      // Since we can't easily mock the middleware in this test,\n      // we'll test the database operation directly\n      \n      const pollData = {\n        title: 'Real Test Poll',\n        options: [\n          { text: 'Real Option 1' },\n          { text: 'Real Option 2' }\n        ],\n        created_by: testUser.id\n      };\n\n      // Test direct database operation\n      const { data, error } = await supabase\n        .from('polls')\n        .insert(pollData)\n        .select()\n        .single();\n\n      console.log('Direct database insert result:', { data, error });\n\n      expect(error).toBeNull();\n      expect(data).toBeDefined();\n      expect(data.title).toBe('Real Test Poll');\n      expect(data.created_by).toBe(testUser.id);\n\n      // Store for cleanup\n      testPollId = data.id;\n    });\n\n    it('should handle poll creation with real user data', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      const pollData = {\n        title: 'Another Real Test Poll',\n        options: [\n          { text: 'Option A' },\n          { text: 'Option B' },\n          { text: 'Option C' }\n        ],\n        created_by: testUser.id\n      };\n\n      const { data, error } = await supabase\n        .from('polls')\n        .insert(pollData)\n        .select()\n        .single();\n\n      expect(error).toBeNull();\n      expect(data).toBeDefined();\n      expect(data.title).toBe('Another Real Test Poll');\n      expect(data.options).toHaveLength(3);\n\n      // Store for cleanup\n      testPollId = data.id;\n    });\n  });\n\n  describe('Real Database Integration', () => {\n    it('should connect to real database successfully', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      // Test basic database connection\n      const { data, error } = await supabase\n        .from('polls')\n        .select('id, title, status')\n        .limit(1);\n\n      console.log('Database connection test - Data:', data);\n      console.log('Database connection test - Error:', error);\n\n      // Should not have an error\n      expect(error).toBeNull();\n      expect(Array.isArray(data)).toBe(true);\n    });\n\n    it('should handle database errors gracefully', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      // Test error handling with invalid table\n      const { data, error } = await supabase\n        .from('nonexistent_table')\n        .select('*')\n        .limit(1);\n\n      console.log('Error handling test - Data:', data);\n      console.log('Error handling test - Error:', error);\n\n      // Should have an error for nonexistent table\n      expect(error).not.toBeNull();\n      expect(error.message).toContain('relation \"nonexistent_table\" does not exist');\n    });\n  });\n\n  describe('Real User Authentication', () => {\n    it('should authenticate real user successfully', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      expect(testUser).toBeDefined();\n      expect(testUser.email).toBe('test@example.com');\n      expect(testUser.id).toBeDefined();\n    });\n\n    it('should have access to user profile', async () => {\n      if (!supabase) {\n        console.warn('Skipping test - Real Supabase credentials not set up');\n        return;\n      }\n\n      const { data, error } = await supabase\n        .from('user_profiles')\n        .select('*')\n        .eq('user_id', testUser.id)\n        .single();\n\n      console.log('User profile data:', data);\n      console.log('User profile error:', error);\n\n      // Should have user profile or be able to create one\n      if (error && error.code === 'PGRST116') {\n        // No profile exists, which is fine for testing\n        expect(error.message).toContain('No rows returned');\n      } else {\n        expect(error).toBeNull();\n        expect(data).toBeDefined();\n      }\n    });\n  });\n});\n"],"names":["supabase","createClient","process","env","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","error","console","warn","describe","testUser","testPollId","beforeAll","log","data","auth","signInWithPassword","email","password","Error","message","user","afterAll","from","delete","eq","signOut","beforeEach","afterEach","it","request","NextRequest","response","GET","responseData","json","status","expect","toBe","toHaveProperty","success","Array","isArray","polls","count","length","toBeLessThanOrEqual","pollData","title","options","text","created_by","id","insert","select","single","toBeNull","toBeDefined","toHaveLength","limit","not","toContain","code"],"mappings":"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"}