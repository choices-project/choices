{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/polls-real-database.test.ts"],"sourcesContent":["/**\n * Polls API Tests - REAL DATABASE\n * \n * This test uses REAL database connections and tests the actual API endpoints.\n * This provides much more realistic and valuable testing than mocks.\n */\n\nimport { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\nimport { NextRequest } from 'next/server';\nimport { GET, POST } from '@/app/api/polls/route';\n\ndescribe('Polls API - REAL DATABASE', () => {\n  beforeEach(() => {\n    // No complex setup needed for real database tests\n  });\n\n  afterEach(() => {\n    // No cleanup needed for real database tests\n  });\n\n  describe('GET /api/polls - List Polls', () => {\n    it('should return list of polls from real database', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      console.log('Real database response status:', response.status);\n      console.log('Real database response data:', responseData);\n\n      // Should return 200 status\n      expect(response.status).toBe(200);\n      \n      // Should have the expected structure\n      expect(responseData).toHaveProperty('success');\n      expect(responseData).toHaveProperty('polls');\n      expect(responseData).toHaveProperty('count');\n      expect(responseData).toHaveProperty('message');\n      \n      // Should have correct data types\n      expect(typeof responseData.success).toBe('boolean');\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(typeof responseData.count).toBe('number');\n      expect(typeof responseData.message).toBe('string');\n    });\n\n    it('should handle pagination with real database', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls?limit=5');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      console.log('Pagination response:', responseData);\n\n      expect(response.status).toBe(200);\n      expect(responseData.success).toBe(true);\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(responseData.polls.length).toBeLessThanOrEqual(5);\n    });\n\n    it('should return proper response structure', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      // Check the response structure matches what the endpoint actually returns\n      expect(response.status).toBe(200);\n      expect(responseData).toHaveProperty('success');\n      expect(responseData).toHaveProperty('polls');\n      expect(responseData).toHaveProperty('count');\n      expect(responseData).toHaveProperty('message');\n      expect(typeof responseData.success).toBe('boolean');\n      expect(Array.isArray(responseData.polls)).toBe(true);\n      expect(typeof responseData.count).toBe('number');\n      expect(typeof responseData.message).toBe('string');\n    });\n  });\n\n  describe('POST /api/polls - Create Poll', () => {\n    it('should reject poll creation without authentication', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          // No authorization header\n        },\n        body: JSON.stringify({\n          title: 'Unauthorized Poll',\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      console.log('Unauthorized response:', responseData);\n\n      expect(response.status).toBe(401);\n      expect(responseData.error).toBe('Authentication required to create polls');\n    });\n\n    it('should handle malformed JSON gracefully', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: 'invalid json',\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      console.log('Malformed JSON response:', responseData);\n\n      expect(response.status).toBe(500);\n      expect(responseData.error).toBe('Invalid JSON');\n    });\n\n    it('should handle missing request body', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      console.log('Missing body response:', responseData);\n\n      expect(response.status).toBe(500);\n      expect(responseData.error).toBe('Invalid JSON');\n    });\n  });\n\n  describe('Real Database Integration', () => {\n    it('should connect to real database successfully', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      // If we get a 200 response, the database connection is working\n      expect(response.status).toBe(200);\n      expect(responseData).toHaveProperty('success');\n      \n      // The response should have the expected structure\n      expect(responseData).toHaveProperty('polls');\n      expect(responseData).toHaveProperty('count');\n      expect(responseData).toHaveProperty('message');\n    });\n\n    it('should handle database errors gracefully', async () => {\n      // This test verifies that the endpoint handles database errors properly\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      // Should handle database errors gracefully\n      expect(response.status).toBe(200);\n      expect(responseData).toHaveProperty('success');\n      \n      // If there's an error, it should be handled gracefully\n      if (responseData.error) {\n        expect(typeof responseData.error).toBe('string');\n      }\n    });\n  });\n});\n"],"names":["describe","beforeEach","afterEach","it","request","NextRequest","response","GET","responseData","json","console","log","status","expect","toBe","toHaveProperty","success","Array","isArray","polls","count","message","length","toBeLessThanOrEqual","method","headers","body","JSON","stringify","title","options","text","POST","error"],"mappings":"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"}