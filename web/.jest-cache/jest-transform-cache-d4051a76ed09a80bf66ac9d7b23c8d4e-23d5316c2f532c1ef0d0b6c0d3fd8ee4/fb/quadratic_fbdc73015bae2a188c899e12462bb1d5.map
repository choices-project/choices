{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/strategies/quadratic.ts"],"sourcesContent":["/**\n * Quadratic Voting Strategy\n * \n * Implements quadratic voting where voters allocate credits across options.\n * The cost of votes increases quadratically with the number of votes for an option.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '@/lib/utils/logger';\nimport { withOptional } from '@/lib/utils/objects';\n\nimport type { \n  VotingStrategy, \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  PollData, \n  VoteData, \n  ResultsData,\n  VotingMethod,\n  PollResults\n} from '../types';\n\nexport class QuadraticStrategy implements VotingStrategy {\n  \n  getVotingMethod(): VotingMethod {\n    return 'quadratic';\n  }\n\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    try {\n      const { voteData } = request;\n      \n      // Check if allocations object is provided\n      if (!voteData.allocations || typeof voteData.allocations !== 'object') {\n        return {\n          valid: false,\n          errors: ['Allocations object is required for quadratic voting'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      const allocations = voteData.allocations;\n      const totalCredits = poll.votingConfig.quadraticCredits || 100;\n      \n      // Validate all allocations are valid numbers\n      let totalSpent = 0;\n      for (const [optionIndex, credits] of Object.entries(allocations)) {\n        if (typeof credits !== 'number' || !Number.isInteger(credits) || credits < 0) {\n          return {\n            valid: false,\n            errors: ['All allocations must be non-negative integers'],\n            requiresAuthentication: true,\n            requiresTokens: false\n          };\n        }\n\n        // Validate option index is valid\n        const optionIdx = parseInt(optionIndex);\n        if (optionIdx < 0 || optionIdx >= poll.options.length) {\n          return {\n            valid: false,\n            errors: ['Invalid option selected'],\n            requiresAuthentication: true,\n            requiresTokens: false\n          };\n        }\n\n        // Calculate quadratic cost\n        const cost = credits * credits;\n        totalSpent += cost;\n      }\n\n      // Validate total spending doesn't exceed credits\n      if (totalSpent > totalCredits) {\n        return {\n          valid: false,\n          errors: [`Total spending (${totalSpent}) exceeds available credits (${totalCredits})`],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      // Check if at least one option has votes\n      const hasVotes = Object.values(allocations).some(credits => (credits) > 0);\n      if (!hasVotes) {\n        return {\n          valid: false,\n          errors: ['At least one option must receive votes'],\n          requiresAuthentication: true,\n          requiresTokens: false\n        };\n      }\n\n      devLog('Quadratic vote validated successfully', {\n        pollId: request.pollId,\n        allocations,\n        totalSpent,\n        totalCredits,\n        userId: request.userId\n      });\n\n      return {\n        valid: true,\n        requiresAuthentication: true,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Quadratic vote validation error:', error);\n      return {\n        valid: false,\n        errors: [error instanceof Error ? error.message : 'Validation failed'],\n        requiresAuthentication: true,\n        requiresTokens: false\n      };\n    }\n  }\n\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    try {\n      const { voteData, userId, pollId, privacyLevel } = request;\n      \n      // Generate vote ID\n      const voteId = `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n      \n      // Create audit receipt\n      const auditReceipt = `receipt_${voteId}_${Date.now()}`;\n\n      // Calculate total spending for audit\n      const allocations = voteData.allocations || {};\n      const totalSpent = Object.values(allocations).reduce((sum: number, credits) => {\n        return sum + (credits) * (credits);\n      }, 0);\n\n      // In a real implementation, this would:\n      // 1. Store the vote in the database\n      // 2. Update poll vote counts\n      // 3. Trigger any necessary notifications\n      // 4. Log the vote for audit purposes\n\n      devLog('Quadratic vote processed successfully', {\n        pollId,\n        voteId,\n        allocations,\n        totalSpent,\n        userId,\n        auditReceipt\n      });\n\n      return withOptional({\n        success: true,\n        message: 'Vote submitted successfully',\n        pollId,\n        voteId,\n        auditReceipt,\n        responseTime: 0, // Will be set by the engine\n        metadata: {\n          votingMethod: 'quadratic',\n          allocations,\n          totalSpent,\n          totalCredits: poll.votingConfig.quadraticCredits || 100,\n          remainingCredits: (poll.votingConfig.quadraticCredits || 100) - (totalSpent)\n        }\n      }, {\n        privacyLevel\n      });\n\n    } catch (error) {\n      devLog('Quadratic vote processing error:', error);\n      return withOptional({\n        success: false,\n        message: error instanceof Error ? error.message : 'Vote processing failed',\n        pollId: request.pollId,\n        responseTime: 0,\n        metadata: {\n          votingMethod: 'quadratic',\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      }, {\n        voteId: undefined,\n        auditReceipt: undefined,\n        privacyLevel: request.privacyLevel\n      });\n    }\n  }\n\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    try {\n      const startTime = Date.now();\n      \n      // Calculate quadratic scores for each option\n      const quadraticScores: Record<string, number> = {};\n      const quadraticSpending: Record<string, number> = {};\n      const optionVotes: Record<string, number> = {};\n      const optionPercentages: Record<string, number> = {};\n      \n      // Initialize scores\n      poll.options.forEach((_, index) => {\n        quadraticScores[index.toString()] = 0;\n        quadraticSpending[index.toString()] = 0;\n        optionVotes[index.toString()] = 0;\n        optionPercentages[index.toString()] = 0;\n      });\n\n      // Calculate scores from votes\n      let totalVotes = 0;\n      votes.forEach(vote => {\n        if (vote.allocations && typeof vote.allocations === 'object') {\n          totalVotes++;\n          Object.entries(vote.allocations).forEach(([optionIndex, credits]) => {\n            const creditsNum = credits;\n            if (creditsNum > 0) {\n              const optionIdx = optionIndex.toString();\n              // Ensure the option exists in our tracking objects\n              if (quadraticScores[optionIdx] !== undefined && \n                  quadraticSpending[optionIdx] !== undefined && \n                  optionVotes[optionIdx] !== undefined) {\n                quadraticScores[optionIdx] += creditsNum;\n                quadraticSpending[optionIdx] += creditsNum * creditsNum;\n                optionVotes[optionIdx]++;\n              }\n            }\n          });\n        }\n      });\n\n      // Calculate percentages\n      if (totalVotes > 0) {\n        Object.keys(quadraticScores).forEach(optionIndex => {\n          const votes = optionVotes[optionIndex];\n          if (votes !== undefined) {\n            optionPercentages[optionIndex] = (votes / totalVotes) * 100;\n          }\n        });\n      }\n\n      // Find winner (highest quadratic score)\n      let winner: string | undefined;\n      let winnerVotes = 0;\n      let winnerPercentage = 0;\n\n      if (totalVotes > 0) {\n        Object.entries(quadraticScores).forEach(([optionIndex, score]) => {\n          if (score > winnerVotes) {\n            winner = optionIndex;\n            winnerVotes = score;\n            winnerPercentage = optionPercentages[optionIndex] ?? 0;\n          }\n        });\n      }\n\n      const results: PollResults = withOptional(\n        {\n          winnerVotes,\n          winnerPercentage,\n          quadraticScores,\n          quadraticSpending,\n          optionVotes,\n          optionPercentages,\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        {\n          winner\n        }\n      );\n\n      const resultsData: ResultsData = {\n        pollId: poll.id,\n        votingMethod: 'quadratic',\n        totalVotes,\n        participationRate: totalVotes > 0 ? 100 : 0, // This would be calculated based on eligible voters\n        results,\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          hasWinner: winner !== undefined,\n          isTie: winnerVotes > 0 && Object.values(quadraticScores).filter(s => s === winnerVotes).length > 1,\n          totalCreditsAllocated: Object.values(quadraticScores).reduce((sum, score) => sum + score, 0),\n          totalCreditsSpent: Object.values(quadraticSpending).reduce((sum, spent) => sum + spent, 0),\n          averageCreditsPerVote: totalVotes > 0 ? Object.values(quadraticScores).reduce((sum, score) => sum + score, 0) / totalVotes : 0\n        }\n      };\n\n      devLog('Quadratic results calculated', {\n        pollId: poll.id,\n        totalVotes,\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        calculationTime: Date.now() - startTime\n      });\n\n      return resultsData;\n\n    } catch (error) {\n      devLog('Quadratic results calculation error:', error);\n      throw new Error(`Failed to calculate quadratic results: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  getConfiguration(): Record<string, unknown> {\n    return {\n      name: 'Quadratic Voting',\n      description: 'Voters allocate credits across options. Cost increases quadratically with votes.',\n      minOptions: 2,\n      maxOptions: 20,\n      allowAbstention: true,\n      requiresRanking: false,\n      allowsMultipleSelections: true,\n      resultType: 'highest_score',\n      features: [\n        'Allows intensity of preference',\n        'Prevents vote buying',\n        'Encourages diverse participation',\n        'Good for budget allocation'\n      ],\n      limitations: [\n        'More complex to understand',\n        'Requires credit management',\n        'Can be gamed with coordination',\n        'May favor wealthy participants'\n      ],\n      defaultCredits: 100,\n      maxCreditsPerOption: 10\n    };\n  }\n}"],"names":["QuadraticStrategy","getVotingMethod","validateVote","request","poll","voteData","allocations","valid","errors","requiresAuthentication","requiresTokens","totalCredits","votingConfig","quadraticCredits","totalSpent","optionIndex","credits","Object","entries","Number","isInteger","optionIdx","parseInt","options","length","cost","hasVotes","values","some","devLog","pollId","userId","error","Error","message","processVote","privacyLevel","voteId","Date","now","Math","random","toString","substr","auditReceipt","reduce","sum","withOptional","success","responseTime","metadata","votingMethod","remainingCredits","undefined","calculateResults","votes","startTime","quadraticScores","quadraticSpending","optionVotes","optionPercentages","forEach","_","index","totalVotes","vote","creditsNum","keys","winner","winnerVotes","winnerPercentage","score","results","abstentions","abstentionPercentage","resultsData","id","participationRate","calculatedAt","toISOString","calculationTime","hasWinner","isTie","filter","s","totalCreditsAllocated","totalCreditsSpent","spent","averageCreditsPerVote","getConfiguration","name","description","minOptions","maxOptions","allowAbstention","requiresRanking","allowsMultipleSelections","resultType","features","limitations","defaultCredits","maxCreditsPerOption"],"mappings":"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"}