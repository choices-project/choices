2bd3790595daf31a804d5bb369629830
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    GET: function() {
        return GET;
    },
    POST: function() {
        return POST;
    },
    dynamic: function() {
        return dynamic;
    }
});
const _server = require("next/server");
const _middleware = require("../../../lib/core/auth/middleware");
const _logger = require("../../../lib/utils/logger");
const _server1 = require("../../../utils/supabase/server");
const dynamic = "force-dynamic";
async function GET(request) {
    try {
        const supabaseClient = await (0, _server1.getSupabaseServerClient)();
        if (!supabaseClient) {
            return _server.NextResponse.json({
                error: "Supabase client not available"
            }, {
                status: 500
            });
        }
        const { searchParams } = new URL(request.url);
        const limit = parseInt(searchParams.get("limit") || "20");
        const _status = searchParams.get("status") || "active";
        // Fetch active polls from polls table
        let polls;
        try {
            (0, _logger.devLog)("Fetching active polls from polls table...");
            const { data: directPolls, error: directError } = await supabaseClient.from("polls").select("id, title, total_votes, options, status").eq("status", "active").limit(limit);
            if (directError) {
                throw directError;
            }
            (0, _logger.devLog)("Found polls:", directPolls.length || 0);
            // Manually aggregate results (temporary solution)
            polls = (directPolls ?? []).map((poll)=>({
                    id: poll.id,
                    title: poll.title,
                    total_votes: poll.total_votes || 0,
                    aggregated_results: Array.isArray(poll.options) ? poll.options.reduce((acc, option, index)=>{
                        acc[`option_${index + 1}`] = option.votes || 0;
                        return acc;
                    }, {}) : {},
                    status: poll.status
                }));
        } catch (fallbackError) {
            (0, _logger.devLog)("Error fetching polls:", fallbackError);
            return _server.NextResponse.json({
                error: "Failed to fetch polls"
            }, {
                status: 500
            });
        }
        // Additional security: ensure no sensitive data is returned
        const sanitizedPolls = polls.map((poll)=>({
                poll_id: poll.id,
                title: poll.title,
                total_votes: poll.total_votes,
                // Only include safe fields
                status: "active",
                created_at: new Date().toISOString()
            })) || [];
        return _server.NextResponse.json({
            success: true,
            polls: sanitizedPolls,
            count: sanitizedPolls.length,
            message: "Aggregated poll results only - no individual vote data"
        });
    } catch (error) {
        (0, _logger.devLog)("Error in polls API:", error);
        return _server.NextResponse.json({
            error: "Internal server error",
            details: error instanceof Error ? error.message : String(error),
            stack: error instanceof Error ? error.stack : undefined
        }, {
            status: 500
        });
    }
}
async function POST(request) {
    try {
        // Always require authentication - no E2E bypasses
        const supabase = await (0, _server1.getSupabaseServerClient)();
        if (!supabase) {
            return _server.NextResponse.json({
                error: "Supabase client not available"
            }, {
                status: 500
            });
        }
        // Always require authentication
        let user;
        try {
            user = await (0, _middleware.getUser)();
        } catch (error) {
            (0, _logger.devLog)("Authentication error during poll creation:", error);
            return _server.NextResponse.json({
                error: "Authentication required to create polls"
            }, {
                status: 401
            });
        }
        // Check if user is authenticated
        if (!user) {
            return _server.NextResponse.json({
                error: "Authentication required to create polls"
            }, {
                status: 401
            });
        }
        // Verify user is active
        if (user) {
            const { data: userProfile } = await supabase.from("user_profiles").select("is_active").eq("user_id", user.id).single();
            if (!userProfile || !("is_active" in userProfile) || !userProfile.is_active) {
                return _server.NextResponse.json({
                    error: "Active account required to create polls"
                }, {
                    status: 403
                });
            }
        }
        const body = await request.json();
        const { title, options, votingMethod = "single", description, category = "general", privacyLevel = "public", allowMultipleVotes = false, showResults = true, allowComments = true, endTime, hashtags = [], primaryHashtag } = body;
        // Validate required fields
        if (!title || !options || !Array.isArray(options) || options.length < 2) {
            return _server.NextResponse.json({
                error: "Title and at least 2 options are required"
            }, {
                status: 400
            });
        }
        // Sanitize and validate options
        const sanitizedOptions = options.filter((option)=>typeof option === "string" && option.trim().length > 0).map((option)=>option.trim()).slice(0, 10); // Limit to 10 options max
        if (sanitizedOptions.length < 2) {
            return _server.NextResponse.json({
                error: "At least 2 valid options are required"
            }, {
                status: 400
            });
        }
        // Create poll with user as creator
        const { data: poll, error: pollError } = await supabase.from("polls").insert({
            title: title.trim(),
            description: description?.trim() || null,
            options: sanitizedOptions,
            voting_method: votingMethod,
            privacy_level: privacyLevel,
            category,
            status: "active",
            created_by: user?.id || "",
            total_votes: 0,
            participation: 0,
            end_time: endTime || null,
            hashtags: hashtags || [],
            primary_hashtag: primaryHashtag || null,
            poll_settings: {
                allowMultipleVotes,
                showResults,
                allowComments
            }
        }).select().single();
        if (pollError) {
            (0, _logger.devLog)("Error creating poll:", pollError);
            return _server.NextResponse.json({
                error: "Failed to create poll",
                details: pollError
            }, {
                status: 500
            });
        }
        // Return sanitized poll data (no sensitive information)
        const sanitizedPoll = poll && !("error" in poll) ? {
            id: poll.id,
            title: poll.title,
            description: poll.description,
            options: poll.options,
            voting_method: poll.voting_method,
            privacy_level: poll.privacy_level,
            category: poll.category,
            status: poll.status,
            total_votes: poll.total_votes,
            participation: poll.participation,
            end_time: poll.end_time,
            hashtags: poll.hashtags || [],
            primary_hashtag: poll.primary_hashtag,
            poll_settings: poll.poll_settings,
            created_at: poll.created_at
        } : null;
        return _server.NextResponse.json(sanitizedPoll);
    } catch (error) {
        (0, _logger.devLog)("Error in polls API:", error);
        return _server.NextResponse.json({
            error: "Internal server error"
        }, {
            status: 500
        });
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9hcHAvYXBpL3BvbGxzL3JvdXRlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgTmV4dFJlcXVlc3R9IGZyb20gJ25leHQvc2VydmVyJztcbmltcG9ydCB7IE5leHRSZXNwb25zZSB9IGZyb20gJ25leHQvc2VydmVyJztcblxuaW1wb3J0IHsgZ2V0VXNlciB9IGZyb20gJ0AvbGliL2NvcmUvYXV0aC9taWRkbGV3YXJlJztcbmltcG9ydCB7IGRldkxvZyB9IGZyb20gJ0AvbGliL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyBnZXRTdXBhYmFzZVNlcnZlckNsaWVudCB9IGZyb20gJ0AvdXRpbHMvc3VwYWJhc2Uvc2VydmVyJztcblxuZXhwb3J0IGNvbnN0IGR5bmFtaWMgPSAnZm9yY2UtZHluYW1pYyc7XG5cbi8vIFR5cGUgZGVmaW5pdGlvbnMgZm9yIHBvbGwgZGF0YVxuaW50ZXJmYWNlIFBvbGxPcHRpb24ge1xuICBpZDogc3RyaW5nO1xuICB0ZXh0OiBzdHJpbmc7XG4gIHZvdGVzPzogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgX1BvbGxEYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgdGl0bGU6IHN0cmluZztcbiAgdG90YWxfdm90ZXM6IG51bWJlcjtcbiAgb3B0aW9uczogUG9sbE9wdGlvbltdO1xuICBzdGF0dXM6IHN0cmluZztcbn1cblxuLy8gR0VUIC9hcGkvcG9sbHMgLSBHZXQgYWN0aXZlIHBvbGxzIHdpdGggYWdncmVnYXRlZCByZXN1bHRzIG9ubHlcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBHRVQocmVxdWVzdDogTmV4dFJlcXVlc3QpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzdXBhYmFzZUNsaWVudCA9IGF3YWl0IGdldFN1cGFiYXNlU2VydmVyQ2xpZW50KCk7XG4gICAgXG4gICAgaWYgKCFzdXBhYmFzZUNsaWVudCkge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnU3VwYWJhc2UgY2xpZW50IG5vdCBhdmFpbGFibGUnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHNlYXJjaFBhcmFtcyB9ID0gbmV3IFVSTChyZXF1ZXN0LnVybCk7XG4gICAgY29uc3QgbGltaXQgPSBwYXJzZUludChzZWFyY2hQYXJhbXMuZ2V0KCdsaW1pdCcpIHx8ICcyMCcpO1xuICAgIGNvbnN0IF9zdGF0dXMgPSBzZWFyY2hQYXJhbXMuZ2V0KCdzdGF0dXMnKSB8fCAnYWN0aXZlJztcblxuICAgIC8vIEZldGNoIGFjdGl2ZSBwb2xscyBmcm9tIHBvbGxzIHRhYmxlXG4gICAgbGV0IHBvbGxzO1xuXG4gICAgdHJ5IHtcbiAgICAgIGRldkxvZygnRmV0Y2hpbmcgYWN0aXZlIHBvbGxzIGZyb20gcG9sbHMgdGFibGUuLi4nKTtcbiAgICAgIGNvbnN0IHsgZGF0YTogZGlyZWN0UG9sbHMsIGVycm9yOiBkaXJlY3RFcnJvciB9ID0gYXdhaXQgc3VwYWJhc2VDbGllbnRcbiAgICAgICAgLmZyb20oJ3BvbGxzJylcbiAgICAgICAgLnNlbGVjdCgnaWQsIHRpdGxlLCB0b3RhbF92b3Rlcywgb3B0aW9ucywgc3RhdHVzJylcbiAgICAgICAgLmVxKCdzdGF0dXMnLCAnYWN0aXZlJylcbiAgICAgICAgLmxpbWl0KGxpbWl0KTtcblxuICAgICAgaWYgKGRpcmVjdEVycm9yKSB7XG4gICAgICAgIHRocm93IGRpcmVjdEVycm9yO1xuICAgICAgfVxuXG4gICAgICBkZXZMb2coJ0ZvdW5kIHBvbGxzOicsIGRpcmVjdFBvbGxzLmxlbmd0aCB8fCAwKTtcblxuICAgICAgLy8gTWFudWFsbHkgYWdncmVnYXRlIHJlc3VsdHMgKHRlbXBvcmFyeSBzb2x1dGlvbilcbiAgICAgIHBvbGxzID0gKGRpcmVjdFBvbGxzID8/IFtdKS5tYXAocG9sbCA9PiAoe1xuICAgICAgICBpZDogcG9sbC5pZCxcbiAgICAgICAgdGl0bGU6IHBvbGwudGl0bGUsXG4gICAgICAgIHRvdGFsX3ZvdGVzOiBwb2xsLnRvdGFsX3ZvdGVzIHx8IDAsXG4gICAgICAgIGFnZ3JlZ2F0ZWRfcmVzdWx0czogQXJyYXkuaXNBcnJheShwb2xsLm9wdGlvbnMpID8gXG4gICAgICAgICAgcG9sbC5vcHRpb25zLnJlZHVjZSgoYWNjOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+LCBvcHRpb246IFBvbGxPcHRpb24sIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgICAgICAgIGFjY1tgb3B0aW9uXyR7aW5kZXggKyAxfWBdID0gb3B0aW9uLnZvdGVzIHx8IDA7XG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgIH0sIHt9KSA6IHt9LFxuICAgICAgICBzdGF0dXM6IHBvbGwuc3RhdHVzXG4gICAgICB9KSk7XG4gICAgfSBjYXRjaCAoZmFsbGJhY2tFcnJvcikge1xuICAgICAgZGV2TG9nKCdFcnJvciBmZXRjaGluZyBwb2xsczonLCBmYWxsYmFja0Vycm9yKTtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0ZhaWxlZCB0byBmZXRjaCBwb2xscycgfSxcbiAgICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEFkZGl0aW9uYWwgc2VjdXJpdHk6IGVuc3VyZSBubyBzZW5zaXRpdmUgZGF0YSBpcyByZXR1cm5lZFxuICAgIGNvbnN0IHNhbml0aXplZFBvbGxzID0gcG9sbHMubWFwKHBvbGwgPT4gKHtcbiAgICAgIHBvbGxfaWQ6IHBvbGwuaWQsXG4gICAgICB0aXRsZTogcG9sbC50aXRsZSxcbiAgICAgIHRvdGFsX3ZvdGVzOiBwb2xsLnRvdGFsX3ZvdGVzLFxuICAgICAgLy8gT25seSBpbmNsdWRlIHNhZmUgZmllbGRzXG4gICAgICBzdGF0dXM6ICdhY3RpdmUnLCAvLyBBbHdheXMgc2hvdyBhcyBhY3RpdmUgZm9yIHB1YmxpYyB2aWV3XG4gICAgICBjcmVhdGVkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIC8vIEdlbmVyaWMgdGltZXN0YW1wXG4gICAgfSkpIHx8IFtdO1xuXG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKHtcbiAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICBwb2xsczogc2FuaXRpemVkUG9sbHMsXG4gICAgICBjb3VudDogc2FuaXRpemVkUG9sbHMubGVuZ3RoLFxuICAgICAgbWVzc2FnZTogJ0FnZ3JlZ2F0ZWQgcG9sbCByZXN1bHRzIG9ubHkgLSBubyBpbmRpdmlkdWFsIHZvdGUgZGF0YSdcbiAgICB9KTtcblxuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGRldkxvZygnRXJyb3IgaW4gcG9sbHMgQVBJOicsIGVycm9yKTtcbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICB7IFxuICAgICAgICBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicsXG4gICAgICAgIGRldGFpbHM6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSxcbiAgICAgICAgc3RhY2s6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5zdGFjayA6IHVuZGVmaW5lZFxuICAgICAgfSxcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICk7XG4gIH1cbn1cblxuLy8gUE9TVCAvYXBpL3BvbGxzIC0gQ3JlYXRlIG5ldyBwb2xsIChhdXRoZW50aWNhdGVkIHVzZXJzIG9ubHkpXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gUE9TVChyZXF1ZXN0OiBOZXh0UmVxdWVzdCkge1xuICB0cnkge1xuICAgIC8vIEFsd2F5cyByZXF1aXJlIGF1dGhlbnRpY2F0aW9uIC0gbm8gRTJFIGJ5cGFzc2VzXG4gICAgY29uc3Qgc3VwYWJhc2UgPSBhd2FpdCBnZXRTdXBhYmFzZVNlcnZlckNsaWVudCgpO1xuICAgIFxuICAgIGlmICghc3VwYWJhc2UpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ1N1cGFiYXNlIGNsaWVudCBub3QgYXZhaWxhYmxlJyB9LFxuICAgICAgICB7IHN0YXR1czogNTAwIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gQWx3YXlzIHJlcXVpcmUgYXV0aGVudGljYXRpb25cbiAgICBsZXQgdXNlcjtcbiAgICB0cnkge1xuICAgICAgdXNlciA9IGF3YWl0IGdldFVzZXIoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZGV2TG9nKCdBdXRoZW50aWNhdGlvbiBlcnJvciBkdXJpbmcgcG9sbCBjcmVhdGlvbjonLCBlcnJvcik7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCB0byBjcmVhdGUgcG9sbHMnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgKTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgdXNlciBpcyBhdXRoZW50aWNhdGVkXG4gICAgaWYgKCF1c2VyKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCB0byBjcmVhdGUgcG9sbHMnIH0sXG4gICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgKTtcbiAgICB9XG4gICAgXG4gICAgLy8gVmVyaWZ5IHVzZXIgaXMgYWN0aXZlXG4gICAgaWYgKHVzZXIpIHtcbiAgICAgIGNvbnN0IHsgZGF0YTogdXNlclByb2ZpbGUgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKCd1c2VyX3Byb2ZpbGVzJylcbiAgICAgICAgLnNlbGVjdCgnaXNfYWN0aXZlJylcbiAgICAgICAgLmVxKCd1c2VyX2lkJywgdXNlci5pZClcbiAgICAgICAgLnNpbmdsZSgpO1xuXG4gICAgICBpZiAoIXVzZXJQcm9maWxlIHx8ICEoJ2lzX2FjdGl2ZScgaW4gdXNlclByb2ZpbGUpIHx8ICF1c2VyUHJvZmlsZS5pc19hY3RpdmUpIHtcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgIHsgZXJyb3I6ICdBY3RpdmUgYWNjb3VudCByZXF1aXJlZCB0byBjcmVhdGUgcG9sbHMnIH0sXG4gICAgICAgICAgeyBzdGF0dXM6IDQwMyB9XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgYm9keSA9IGF3YWl0IHJlcXVlc3QuanNvbigpO1xuICAgIGNvbnN0IHsgXG4gICAgICB0aXRsZSwgXG4gICAgICBvcHRpb25zLCBcbiAgICAgIHZvdGluZ01ldGhvZCA9ICdzaW5nbGUnLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICBjYXRlZ29yeSA9ICdnZW5lcmFsJyxcbiAgICAgIHByaXZhY3lMZXZlbCA9ICdwdWJsaWMnLFxuICAgICAgYWxsb3dNdWx0aXBsZVZvdGVzID0gZmFsc2UsXG4gICAgICBzaG93UmVzdWx0cyA9IHRydWUsXG4gICAgICBhbGxvd0NvbW1lbnRzID0gdHJ1ZSxcbiAgICAgIGVuZFRpbWUsXG4gICAgICBoYXNodGFncyA9IFtdLFxuICAgICAgcHJpbWFyeUhhc2h0YWdcbiAgICB9ID0gYm9keTtcblxuICAgIC8vIFZhbGlkYXRlIHJlcXVpcmVkIGZpZWxkc1xuICAgIGlmICghdGl0bGUgfHwgIW9wdGlvbnMgfHwgIUFycmF5LmlzQXJyYXkob3B0aW9ucykgfHwgb3B0aW9ucy5sZW5ndGggPCAyKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgZXJyb3I6ICdUaXRsZSBhbmQgYXQgbGVhc3QgMiBvcHRpb25zIGFyZSByZXF1aXJlZCcgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFNhbml0aXplIGFuZCB2YWxpZGF0ZSBvcHRpb25zXG4gICAgY29uc3Qgc2FuaXRpemVkT3B0aW9ucyA9IG9wdGlvbnNcbiAgICAgIC5maWx0ZXIob3B0aW9uID0+IHR5cGVvZiBvcHRpb24gPT09ICdzdHJpbmcnICYmIG9wdGlvbi50cmltKCkubGVuZ3RoID4gMClcbiAgICAgIC5tYXAob3B0aW9uID0+IG9wdGlvbi50cmltKCkpXG4gICAgICAuc2xpY2UoMCwgMTApOyAvLyBMaW1pdCB0byAxMCBvcHRpb25zIG1heFxuXG4gICAgaWYgKHNhbml0aXplZE9wdGlvbnMubGVuZ3RoIDwgMikge1xuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IGVycm9yOiAnQXQgbGVhc3QgMiB2YWxpZCBvcHRpb25zIGFyZSByZXF1aXJlZCcgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQwMCB9XG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBwb2xsIHdpdGggdXNlciBhcyBjcmVhdG9yXG4gICAgY29uc3QgeyBkYXRhOiBwb2xsLCBlcnJvcjogcG9sbEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ3BvbGxzJylcbiAgICAgIC5pbnNlcnQoe1xuICAgICAgICB0aXRsZTogdGl0bGUudHJpbSgpLFxuICAgICAgICBkZXNjcmlwdGlvbjogZGVzY3JpcHRpb24/LnRyaW0oKSB8fCBudWxsLFxuICAgICAgICBvcHRpb25zOiBzYW5pdGl6ZWRPcHRpb25zLFxuICAgICAgICB2b3RpbmdfbWV0aG9kOiB2b3RpbmdNZXRob2QsXG4gICAgICAgIHByaXZhY3lfbGV2ZWw6IHByaXZhY3lMZXZlbCxcbiAgICAgICAgY2F0ZWdvcnksXG4gICAgICAgIHN0YXR1czogJ2FjdGl2ZScsXG4gICAgICAgIGNyZWF0ZWRfYnk6IHVzZXI/LmlkIHx8ICcnLFxuICAgICAgICB0b3RhbF92b3RlczogMCxcbiAgICAgICAgcGFydGljaXBhdGlvbjogMCxcbiAgICAgICAgZW5kX3RpbWU6IGVuZFRpbWUgfHwgbnVsbCxcbiAgICAgICAgaGFzaHRhZ3M6IGhhc2h0YWdzIHx8IFtdLFxuICAgICAgICBwcmltYXJ5X2hhc2h0YWc6IHByaW1hcnlIYXNodGFnIHx8IG51bGwsXG4gICAgICAgIHBvbGxfc2V0dGluZ3M6IHtcbiAgICAgICAgICBhbGxvd011bHRpcGxlVm90ZXMsXG4gICAgICAgICAgc2hvd1Jlc3VsdHMsXG4gICAgICAgICAgYWxsb3dDb21tZW50c1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLnNlbGVjdCgpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAocG9sbEVycm9yKSB7XG4gICAgICBkZXZMb2coJ0Vycm9yIGNyZWF0aW5nIHBvbGw6JywgcG9sbEVycm9yKTtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBlcnJvcjogJ0ZhaWxlZCB0byBjcmVhdGUgcG9sbCcsIGRldGFpbHM6IHBvbGxFcnJvciB9LFxuICAgICAgICB7IHN0YXR1czogNTAwIH1cbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gUmV0dXJuIHNhbml0aXplZCBwb2xsIGRhdGEgKG5vIHNlbnNpdGl2ZSBpbmZvcm1hdGlvbilcbiAgICBjb25zdCBzYW5pdGl6ZWRQb2xsID0gcG9sbCAmJiAhKCdlcnJvcicgaW4gcG9sbCkgPyB7XG4gICAgICBpZDogcG9sbC5pZCxcbiAgICAgIHRpdGxlOiBwb2xsLnRpdGxlLFxuICAgICAgZGVzY3JpcHRpb246IHBvbGwuZGVzY3JpcHRpb24sXG4gICAgICBvcHRpb25zOiBwb2xsLm9wdGlvbnMsXG4gICAgICB2b3RpbmdfbWV0aG9kOiBwb2xsLnZvdGluZ19tZXRob2QsXG4gICAgICBwcml2YWN5X2xldmVsOiBwb2xsLnByaXZhY3lfbGV2ZWwsXG4gICAgICBjYXRlZ29yeTogcG9sbC5jYXRlZ29yeSxcbiAgICAgIHN0YXR1czogcG9sbC5zdGF0dXMsXG4gICAgICB0b3RhbF92b3RlczogcG9sbC50b3RhbF92b3RlcyxcbiAgICAgIHBhcnRpY2lwYXRpb246IHBvbGwucGFydGljaXBhdGlvbixcbiAgICAgIGVuZF90aW1lOiBwb2xsLmVuZF90aW1lLFxuICAgICAgaGFzaHRhZ3M6IHBvbGwuaGFzaHRhZ3MgfHwgW10sXG4gICAgICBwcmltYXJ5X2hhc2h0YWc6IHBvbGwucHJpbWFyeV9oYXNodGFnLFxuICAgICAgcG9sbF9zZXR0aW5nczogcG9sbC5wb2xsX3NldHRpbmdzLFxuICAgICAgY3JlYXRlZF9hdDogcG9sbC5jcmVhdGVkX2F0XG4gICAgfSA6IG51bGw7XG5cbiAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oc2FuaXRpemVkUG9sbCk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBkZXZMb2coJ0Vycm9yIGluIHBvbGxzIEFQSTonLCBlcnJvcik7XG4gICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgeyBlcnJvcjogJ0ludGVybmFsIHNlcnZlciBlcnJvcicgfSxcbiAgICAgIHsgc3RhdHVzOiA1MDAgfVxuICAgICk7XG4gIH1cbn1cbiJdLCJuYW1lcyI6WyJHRVQiLCJQT1NUIiwiZHluYW1pYyIsInJlcXVlc3QiLCJzdXBhYmFzZUNsaWVudCIsImdldFN1cGFiYXNlU2VydmVyQ2xpZW50IiwiTmV4dFJlc3BvbnNlIiwianNvbiIsImVycm9yIiwic3RhdHVzIiwic2VhcmNoUGFyYW1zIiwiVVJMIiwidXJsIiwibGltaXQiLCJwYXJzZUludCIsImdldCIsIl9zdGF0dXMiLCJwb2xscyIsImRldkxvZyIsImRhdGEiLCJkaXJlY3RQb2xscyIsImRpcmVjdEVycm9yIiwiZnJvbSIsInNlbGVjdCIsImVxIiwibGVuZ3RoIiwibWFwIiwicG9sbCIsImlkIiwidGl0bGUiLCJ0b3RhbF92b3RlcyIsImFnZ3JlZ2F0ZWRfcmVzdWx0cyIsIkFycmF5IiwiaXNBcnJheSIsIm9wdGlvbnMiLCJyZWR1Y2UiLCJhY2MiLCJvcHRpb24iLCJpbmRleCIsInZvdGVzIiwiZmFsbGJhY2tFcnJvciIsInNhbml0aXplZFBvbGxzIiwicG9sbF9pZCIsImNyZWF0ZWRfYXQiLCJEYXRlIiwidG9JU09TdHJpbmciLCJzdWNjZXNzIiwiY291bnQiLCJtZXNzYWdlIiwiZGV0YWlscyIsIkVycm9yIiwiU3RyaW5nIiwic3RhY2siLCJ1bmRlZmluZWQiLCJzdXBhYmFzZSIsInVzZXIiLCJnZXRVc2VyIiwidXNlclByb2ZpbGUiLCJzaW5nbGUiLCJpc19hY3RpdmUiLCJib2R5Iiwidm90aW5nTWV0aG9kIiwiZGVzY3JpcHRpb24iLCJjYXRlZ29yeSIsInByaXZhY3lMZXZlbCIsImFsbG93TXVsdGlwbGVWb3RlcyIsInNob3dSZXN1bHRzIiwiYWxsb3dDb21tZW50cyIsImVuZFRpbWUiLCJoYXNodGFncyIsInByaW1hcnlIYXNodGFnIiwic2FuaXRpemVkT3B0aW9ucyIsImZpbHRlciIsInRyaW0iLCJzbGljZSIsInBvbGxFcnJvciIsImluc2VydCIsInZvdGluZ19tZXRob2QiLCJwcml2YWN5X2xldmVsIiwiY3JlYXRlZF9ieSIsInBhcnRpY2lwYXRpb24iLCJlbmRfdGltZSIsInByaW1hcnlfaGFzaHRhZyIsInBvbGxfc2V0dGluZ3MiLCJzYW5pdGl6ZWRQb2xsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztJQXlCc0JBLEdBQUc7ZUFBSEE7O0lBbUZBQyxJQUFJO2VBQUpBOztJQXJHVEMsT0FBTztlQUFQQTs7O3dCQU5nQjs0QkFFTDt3QkFDRDt5QkFDaUI7QUFFakMsTUFBTUEsVUFBVTtBQWtCaEIsZUFBZUYsSUFBSUcsT0FBb0I7SUFDNUMsSUFBSTtRQUNGLE1BQU1DLGlCQUFpQixNQUFNQyxJQUFBQSxnQ0FBdUI7UUFFcEQsSUFBSSxDQUFDRCxnQkFBZ0I7WUFDbkIsT0FBT0Usb0JBQVksQ0FBQ0MsSUFBSSxDQUN0QjtnQkFBRUMsT0FBTztZQUFnQyxHQUN6QztnQkFBRUMsUUFBUTtZQUFJO1FBRWxCO1FBRUEsTUFBTSxFQUFFQyxZQUFZLEVBQUUsR0FBRyxJQUFJQyxJQUFJUixRQUFRUyxHQUFHO1FBQzVDLE1BQU1DLFFBQVFDLFNBQVNKLGFBQWFLLEdBQUcsQ0FBQyxZQUFZO1FBQ3BELE1BQU1DLFVBQVVOLGFBQWFLLEdBQUcs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