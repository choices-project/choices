{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/helpers/database-test-utils.ts"],"sourcesContent":["/**\n * Database Test Utilities\n * \n * Provides real database operations for integration testing.\n * Follows integration testing best practices:\n * - Uses real database connections\n * - Implements proper test isolation\n * - Provides cleanup utilities\n * - Supports both local and CI environments\n */\n\nimport { createClient, SupabaseClient } from '@supabase/supabase-js';\nimport { jest } from '@jest/globals';\n\n// Test database configuration\nconst TEST_DB_URL = process.env.TEST_SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst TEST_DB_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n// Test data tracking for cleanup\nlet testDataIds: {\n  polls: string[];\n  votes: string[];\n  users: string[];\n} = {\n  polls: [],\n  votes: [],\n  users: []\n};\n\n// Create real Supabase client for testing\nexport const createTestSupabaseClient = (): SupabaseClient | null => {\n  if (!TEST_DB_URL || !TEST_DB_KEY) {\n    console.warn('Test database credentials not found. Integration tests will be skipped.');\n    console.warn('TEST_DB_URL:', TEST_DB_URL);\n    console.warn('TEST_DB_KEY:', TEST_DB_KEY ? 'Present' : 'Missing');\n    return null;\n  }\n  \n  try {\n    const client = createClient(TEST_DB_URL, TEST_DB_KEY);\n    console.log('Supabase client created successfully');\n    return client;\n  } catch (error) {\n    console.error('Failed to create Supabase client:', error);\n    return null;\n  }\n};\n\n// Setup test database with real connection\nexport const setupTestDatabase = async (): Promise<SupabaseClient | null> => {\n  const client = createTestSupabaseClient();\n  \n  if (!client) {\n    console.warn('No test database available. Using mock client for CI/CD.');\n    return createMockSupabaseClient();\n  }\n  \n  // Reset test data tracking\n  testDataIds = { polls: [], votes: [], users: [] };\n  \n  console.log('Integration: Real test database connected');\n  return client;\n};\n\n// Create test user with real database\nexport const createTestUser = async (supabase: SupabaseClient | null) => {\n  if (!supabase) {\n    return {\n      id: 'test-user-id',\n      email: 'test@example.com',\n      name: 'Test User'\n    };\n  }\n  \n  try {\n    // Use an existing user ID from the database\n    const testUser = {\n      id: '6f12e40c-fd46-4ace-9470-2016dc0e2e8b', // Existing user ID from database\n      email: 'test@example.com',\n      name: 'Test User'\n    };\n    \n    // Track for cleanup\n    testDataIds.users.push(testUser.id);\n    \n    return testUser;\n  } catch (error) {\n    console.warn('Failed to create test user:', error);\n    return {\n      id: '6f12e40c-fd46-4ace-9470-2016dc0e2e8b', // Existing user ID from database\n      email: 'test@example.com',\n      name: 'Test User'\n    };\n  }\n};\n\n// Track test data for cleanup\nexport const trackTestData = (type: 'polls' | 'votes' | 'users', id: string) => {\n  testDataIds[type].push(id);\n};\n\n// Cleanup test database - removes all test data\nexport const cleanupTestDatabase = async (supabase: SupabaseClient | null) => {\n  if (!supabase) {\n    console.log('Integration: Mock database cleanup completed');\n    return;\n  }\n  \n  try {\n    // Clean up in reverse order to respect foreign key constraints\n    if (testDataIds.votes.length > 0) {\n      await supabase.from('votes').delete().in('id', testDataIds.votes);\n      console.log(`Integration: Cleaned up ${testDataIds.votes.length} test votes`);\n    }\n    \n    if (testDataIds.polls.length > 0) {\n      await supabase.from('polls').delete().in('id', testDataIds.polls);\n      console.log(`Integration: Cleaned up ${testDataIds.polls.length} test polls`);\n    }\n    \n    // Note: Users are managed by Supabase Auth, not a custom users table\n    if (testDataIds.users.length > 0) {\n      console.log(`Integration: Note - ${testDataIds.users.length} test users tracked (managed by Supabase Auth)`);\n    }\n    \n    // Reset tracking\n    testDataIds = { polls: [], votes: [], users: [] };\n    \n    console.log('Integration: Test database cleanup completed');\n  } catch (error) {\n    console.error('Integration: Failed to cleanup test database:', error);\n  }\n};\n\n// Mock client fallback for CI/CD environments\nconst createMockSupabaseClient = () => {\n  return {\n    from: jest.fn().mockReturnValue({\n      insert: jest.fn().mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: {\n              id: 'test-poll-id',\n              title: 'Test Poll',\n              description: 'A test poll',\n              votingMethod: 'single',\n              options: [\n                { id: 'option-1', text: 'Option 1' },\n                { id: 'option-2', text: 'Option 2' }\n              ],\n              status: 'active',\n              createdAt: new Date().toISOString(),\n              closeAt: new Date(Date.now() + 86400000).toISOString(),\n              createdBy: 'test-user-id'\n            },\n            error: null\n          })\n        })\n      }),\n      select: jest.fn().mockReturnValue({\n        eq: jest.fn().mockReturnValue({\n          single: jest.fn().mockResolvedValue({\n            data: {\n              id: 'test-poll-id',\n              title: 'Test Poll',\n              description: 'A test poll',\n              votingMethod: 'single',\n              options: [\n                { id: 'option-1', text: 'Option 1' },\n                { id: 'option-2', text: 'Option 2' }\n              ],\n              status: 'active',\n              createdAt: new Date().toISOString(),\n              closeAt: new Date(Date.now() + 86400000).toISOString(),\n              createdBy: 'test-user-id'\n            },\n            error: null\n          })\n        })\n      })\n    }),\n    auth: {\n      signInWithPassword: jest.fn().mockResolvedValue({\n        data: { user: { id: 'test-user-id', email: 'test@example.com' } },\n        error: null\n      })\n    }\n  } as any;\n};\n"],"names":["cleanupTestDatabase","createTestSupabaseClient","createTestUser","setupTestDatabase","trackTestData","TEST_DB_URL","process","env","TEST_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_URL","TEST_DB_KEY","SUPABASE_SERVICE_ROLE_KEY","NEXT_PUBLIC_SUPABASE_ANON_KEY","testDataIds","polls","votes","users","console","warn","client","createClient","log","error","createMockSupabaseClient","supabase","id","email","name","testUser","push","type","length","from","delete","in","jest","fn","mockReturnValue","insert","select","single","mockResolvedValue","data","title","description","votingMethod","options","text","status","createdAt","Date","toISOString","closeAt","now","createdBy","eq","auth","signInWithPassword","user"],"mappings":"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"}