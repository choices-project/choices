{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/vote/engine.test.ts"],"sourcesContent":["/**\n * Vote Engine Unit Tests\n * \n * Comprehensive tests for the voting engine and all voting strategies\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { describe, it, expect, beforeEach, jest } from '@jest/globals';\nimport { VoteEngine, type VoteEngineConfig } from '@/lib/vote/engine';\nimport type { VoteRequest, PollData, VoteData, VotingMethod } from '@/lib/vote/types';\n\n// Import V2 test setup\nimport { when, expectQueryState } from '../../helpers/supabase-when';\n\n// Mock the logger\njest.mock('@/lib/utils/logger', () => ({\n  devLog: jest.fn()\n}));\n\ndescribe('VoteEngine', () => {\n  let engine: VoteEngine;\n  let mockPoll: PollData;\n  let mockVoteRequest: VoteRequest;\n\n  beforeEach(() => {\n    engine = new VoteEngine();\n    \n    mockPoll = {\n      id: 'poll-123',\n      title: 'Test Poll',\n      description: 'A test poll for unit testing',\n      votingMethod: 'single',\n      options: [\n        { id: 'option-1', text: 'Option 1' },\n        { id: 'option-2', text: 'Option 2' },\n        { id: 'option-3', text: 'Option 3' }\n      ],\n      status: 'active',\n      startTime: new Date('2025-01-01T00:00:00Z'),\n      endTime: new Date('2025-12-31T23:59:59Z'),\n      createdBy: 'user-123',\n      createdAt: new Date('2025-01-01T00:00:00Z'),\n      updatedAt: new Date('2025-01-01T00:00:00Z'),\n      votingConfig: {\n        allowMultipleVotes: false,\n        maxChoices: 1,\n        quadraticCredits: 100,\n        rangeMin: 0,\n        rangeMax: 10\n      }\n    };\n\n    mockVoteRequest = {\n      pollId: 'poll-123',\n      userId: 'user-456',\n      voteData: { choice: 0 },\n      privacyLevel: 'public'\n    };\n  });\n\n  describe('Configuration', () => {\n    it('should initialize with default configuration', () => {\n      const config = engine.getConfig();\n      expect(config.maxVotesPerPoll).toBe(10000);\n      expect(config.allowMultipleVotes).toBe(false);\n      expect(config.requireAuthentication).toBe(true);\n      expect(config.minTrustTier).toBe('T0');\n      expect(config.rateLimitPerUser).toBe(10);\n      expect(config.rateLimitWindowMs).toBe(60000);\n    });\n\n    it('should accept custom configuration', () => {\n      const customConfig: Partial<VoteEngineConfig> = {\n        maxVotesPerPoll: 5000,\n        allowMultipleVotes: true,\n        requireAuthentication: false\n      };\n      \n      const customEngine = new VoteEngine(customConfig);\n      const config = customEngine.getConfig();\n      \n      expect(config.maxVotesPerPoll).toBe(5000);\n      expect(config.allowMultipleVotes).toBe(true);\n      expect(config.requireAuthentication).toBe(false);\n    });\n\n    it('should update configuration', () => {\n      engine.updateConfig({ maxVotesPerPoll: 2000 });\n      const config = engine.getConfig();\n      expect(config.maxVotesPerPoll).toBe(2000);\n    });\n  });\n\n  describe('Vote Validation', () => {\n    it('should validate a valid single-choice vote', async () => {\n      const validation = await engine.validateVote(mockVoteRequest, mockPoll);\n      expect(validation.isValid).toBe(true);\n      expect(validation.requiresAuthentication).toBe(true);\n      expect(validation.requiresTokens).toBe(false);\n    });\n\n    it('should reject vote with missing poll ID', async () => {\n      const invalidRequest = Object.assign({}, mockVoteRequest, { pollId: '' });\n      const validation = await engine.validateVote(invalidRequest, mockPoll);\n      expect(validation.isValid).toBe(false);\n      expect(validation.error).toBe('Missing required vote data');\n    });\n\n    it('should reject vote with missing vote data', async () => {\n      const invalidRequest = Object.assign({}, mockVoteRequest, { voteData: {} });\n      const validation = await engine.validateVote(invalidRequest, mockPoll);\n      expect(validation.isValid).toBe(false);\n      expect(validation.error).toBe('Choice is required for single-choice voting');\n    });\n\n    it('should reject vote for inactive poll', async () => {\n      const inactivePoll = Object.assign({}, mockPoll, { status: 'closed' as const });\n      const validation = await engine.validateVote(mockVoteRequest, inactivePoll);\n      expect(validation.isValid).toBe(false);\n      expect(validation.error).toBe('Poll not found or not active');\n    });\n\n    it('should reject vote for ended poll', async () => {\n      const endedPoll = Object.assign({}, mockPoll, { \n        endTime: new Date('2024-12-31T23:59:59Z') \n      });\n      const validation = await engine.validateVote(mockVoteRequest, endedPoll);\n      expect(validation.isValid).toBe(false);\n      expect(validation.error).toBe('Poll has ended');\n    });\n\n    it('should reject vote without authentication when required', async () => {\n      const unauthenticatedRequest = Object.assign({}, mockVoteRequest);\n      delete unauthenticatedRequest.userId;\n      const validation = await engine.validateVote(unauthenticatedRequest, mockPoll);\n      expect(validation.isValid).toBe(false);\n      expect(validation.error).toBe('Authentication required to vote');\n      expect(validation.requiresAuthentication).toBe(true);\n    });\n\n    it('should allow vote without authentication when not required', async () => {\n      engine.updateConfig({ requireAuthentication: false });\n      const unauthenticatedRequest = Object.assign({}, mockVoteRequest);\n      delete unauthenticatedRequest.userId;\n      const validation = await engine.validateVote(unauthenticatedRequest, mockPoll);\n      expect(validation.isValid).toBe(true);\n    });\n\n    it('should reject vote with invalid option', async () => {\n      const invalidRequest = Object.assign({}, mockVoteRequest, { \n        voteData: { choice: 999 } \n      });\n      const validation = await engine.validateVote(invalidRequest, mockPoll);\n      expect(validation.isValid).toBe(false);\n      expect(validation.error).toBe('Choice must be between 0 and 2');\n    });\n  });\n\n  describe('Vote Processing', () => {\n    it('should process a valid vote successfully', async () => {\n      const response = await engine.processVote(mockVoteRequest, mockPoll);\n      expect(response.success).toBe(true);\n      expect(response.pollId).toBe('poll-123');\n      expect(response.voteId).toBeDefined();\n      expect(response.auditReceipt).toBeDefined();\n      expect(response.privacyLevel).toBe('public');\n      expect(response.responseTime).toBeGreaterThanOrEqual(0);\n    });\n\n    it('should reject invalid vote during processing', async () => {\n      const invalidRequest = Object.assign({}, mockVoteRequest, { voteData: {} });\n      const response = await engine.processVote(invalidRequest, mockPoll);\n      expect(response.success).toBe(false);\n      expect(response.message).toBe('Choice is required for single-choice voting');\n      expect(response.voteId).toBeUndefined();\n    });\n\n    it('should handle processing errors gracefully', async () => {\n      // Test error handling with invalid data\n      const invalidRequest = Object.assign({}, mockVoteRequest, { voteData: {} });\n      const response = await engine.processVote(invalidRequest, mockPoll);\n      expect(response.success).toBe(false);\n      expect(response.message).toBeDefined();\n    });\n  });\n\n  describe('Results Calculation', () => {\n    it('should calculate results for single-choice voting', async () => {\n      const mockVotes: VoteData[] = [\n        {\n          id: 'vote-1',\n          pollId: 'poll-123',\n          userId: 'user-1',\n          choice: 0,\n          privacyLevel: 'public',\n          timestamp: new Date(),\n          auditReceipt: 'receipt-1'\n        },\n        {\n          id: 'vote-2',\n          pollId: 'poll-123',\n          userId: 'user-2',\n          choice: 0,\n          privacyLevel: 'public',\n          timestamp: new Date(),\n          auditReceipt: 'receipt-2'\n        },\n        {\n          id: 'vote-3',\n          pollId: 'poll-123',\n          userId: 'user-3',\n          choice: 1,\n          privacyLevel: 'public',\n          timestamp: new Date(),\n          auditReceipt: 'receipt-3'\n        }\n      ];\n\n      const results = await engine.calculateResults(mockPoll, mockVotes);\n      expect(results.pollId).toBe('poll-123');\n      expect(results.totalVotes).toBe(3);\n      expect(results.votingMethod).toBe('single');\n      expect(results.results).toBeDefined();\n      expect(typeof results.results).toBe('object');\n      \n      // Check option votes using the correct structure\n      expect(results.results.optionVotes['0']).toBe(2); // Option 1 (index 0)\n      expect(results.results.optionVotes['1']).toBe(1); // Option 2 (index 1)\n      expect(results.results.optionVotes['2']).toBe(0); // Option 3 (index 2)\n      \n      expect(results.results.optionPercentages['0']).toBeCloseTo(66.67, 1);\n      expect(results.results.optionPercentages['1']).toBeCloseTo(33.33, 1);\n      expect(results.results.optionPercentages['2']).toBe(0);\n    });\n\n    it('should handle empty votes array', async () => {\n      const results = await engine.calculateResults(mockPoll, []);\n      expect(results.totalVotes).toBe(0);\n      expect(Object.keys(results.results.optionVotes)).toHaveLength(3);\n      Object.values(results.results.optionVotes).forEach(votes => {\n        expect(votes).toBe(0);\n      });\n      Object.values(results.results.optionPercentages).forEach(percentage => {\n        expect(percentage).toBe(0);\n      });\n    });\n  });\n\n  describe('Voting Method Configuration', () => {\n    it('should get configuration for single-choice voting', () => {\n      const config = engine.getVotingMethodConfig('single');\n      expect(config.name).toBe('Single Choice Voting');\n      expect(config.allowsMultipleSelections).toBe(false);\n      expect(config.minOptions).toBe(2);\n    });\n\n    it('should get configuration for approval voting', () => {\n      const config = engine.getVotingMethodConfig('approval');\n      expect(config.name).toBe('Approval Voting');\n      expect(config.allowsMultipleSelections).toBe(true);\n      expect(config.minOptions).toBe(2);\n    });\n\n    it('should get configuration for ranked voting', () => {\n      const config = engine.getVotingMethodConfig('ranked');\n      expect(config.name).toBe('Ranked Choice Voting');\n      expect(config.resultType).toBe('instant_runoff');\n    });\n\n    it('should get configuration for quadratic voting', () => {\n      const config = engine.getVotingMethodConfig('quadratic');\n      expect(config.name).toBe('Quadratic Voting');\n      expect(config.allowsMultipleSelections).toBe(true);\n      expect(config.resultType).toBe('highest_score');\n    });\n\n    it('should get configuration for range voting', () => {\n      const config = engine.getVotingMethodConfig('range');\n      expect(config.name).toBe('Range Voting');\n      expect(config.allowsMultipleSelections).toBe(true);\n      expect(config.resultType).toBe('highest_average');\n    });\n\n    it('should throw error for unsupported voting method', () => {\n      expect(() => {\n        engine.getVotingMethodConfig('unsupported' as VotingMethod);\n      }).toThrow('Unsupported voting method: unsupported');\n    });\n  });\n\n  describe('Error Handling', () => {\n    it('should handle validation errors gracefully', async () => {\n      const invalidRequest = Object.assign({}, mockVoteRequest, { pollId: '' });\n      const validation = await engine.validateVote(invalidRequest, mockPoll);\n      expect(validation.isValid).toBe(false);\n      expect(validation.error).toBeDefined();\n    });\n\n    it('should handle processing errors gracefully', async () => {\n      const invalidRequest = Object.assign({}, mockVoteRequest, { voteData: {} });\n      const response = await engine.processVote(invalidRequest, mockPoll);\n      expect(response.success).toBe(false);\n      expect(response.message).toBeDefined();\n    });\n\n    it('should handle results calculation errors gracefully', async () => {\n      // Test with malformed vote data\n      const malformedVotes: VoteData[] = [\n        {\n          id: 'vote-1',\n          pollId: 'poll-123',\n          userId: 'user-1',\n          choice: 999,\n          privacyLevel: 'public',\n          timestamp: new Date(),\n          auditReceipt: 'receipt-1'\n        }\n      ];\n\n      const results = await engine.calculateResults(mockPoll, malformedVotes);\n      expect(results.totalVotes).toBe(0);\n      expect(results.results).toBeDefined();\n      expect(typeof results.results).toBe('object');\n    });\n  });\n});\n"],"names":["jest","mock","devLog","fn","describe","engine","mockPoll","mockVoteRequest","beforeEach","VoteEngine","id","title","description","votingMethod","options","text","status","startTime","Date","endTime","createdBy","createdAt","updatedAt","votingConfig","allowMultipleVotes","maxChoices","quadraticCredits","rangeMin","rangeMax","pollId","userId","voteData","choice","privacyLevel","it","config","getConfig","expect","maxVotesPerPoll","toBe","requireAuthentication","minTrustTier","rateLimitPerUser","rateLimitWindowMs","customConfig","customEngine","updateConfig","validation","validateVote","isValid","requiresAuthentication","requiresTokens","invalidRequest","Object","assign","error","inactivePoll","endedPoll","unauthenticatedRequest","response","processVote","success","voteId","toBeDefined","auditReceipt","responseTime","toBeGreaterThanOrEqual","message","toBeUndefined","mockVotes","timestamp","results","calculateResults","totalVotes","optionVotes","optionPercentages","toBeCloseTo","keys","toHaveLength","values","forEach","votes","percentage","getVotingMethodConfig","name","allowsMultipleSelections","minOptions","resultType","toThrow","malformedVotes"],"mappings":"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"}