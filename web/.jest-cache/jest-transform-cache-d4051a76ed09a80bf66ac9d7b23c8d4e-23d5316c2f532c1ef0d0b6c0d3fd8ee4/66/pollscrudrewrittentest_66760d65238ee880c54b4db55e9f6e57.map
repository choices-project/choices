{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/api/core/polls-crud-rewritten.test.ts"],"sourcesContent":["/**\n * Polls CRUD API Tests - REWRITTEN\n * \n * Tests the polls API endpoints with proper mocking to match current implementation:\n * - GET /api/polls (list polls)\n * - POST /api/polls (create poll)\n * \n * This test is rewritten to match the actual codebase implementation\n * and then will be evolved to challenge the code functionality.\n */\n\nimport { describe, it, expect, beforeEach, afterEach } from '@jest/globals';\nimport { NextRequest } from 'next/server';\nimport { GET, POST } from '@/app/api/polls/route';\n\n// Mock Supabase client with proper structure\nconst mockSupabaseClient = {\n  from: jest.fn(() => ({\n    select: jest.fn(() => ({\n      eq: jest.fn(() => ({\n        limit: jest.fn().mockResolvedValue({\n          data: [\n            {\n              id: 'poll-1',\n              title: 'Test Poll 1',\n              total_votes: 10,\n              options: [\n                { id: 'opt-1', text: 'Option 1', votes: 6 },\n                { id: 'opt-2', text: 'Option 2', votes: 4 }\n              ],\n              status: 'active'\n            },\n            {\n              id: 'poll-2', \n              title: 'Test Poll 2',\n              total_votes: 15,\n              options: [\n                { id: 'opt-3', text: 'Option A', votes: 8 },\n                { id: 'opt-4', text: 'Option B', votes: 7 }\n              ],\n              status: 'active'\n            }\n          ],\n          error: null,\n        }),\n      })),\n    })),\n    insert: jest.fn(() => ({\n      select: jest.fn().mockResolvedValue({\n        data: [{ \n          id: 'poll-123', \n          title: 'New Test Poll',\n          total_votes: 0,\n          options: [\n            { id: 'opt-new-1', text: 'New Option 1', votes: 0 },\n            { id: 'opt-new-2', text: 'New Option 2', votes: 0 }\n          ],\n          status: 'active'\n        }],\n        error: null,\n      }),\n    })),\n  })),\n  auth: {\n    getUser: jest.fn(),\n  },\n};\n\n// Mock the Supabase server client\njest.mock('@/utils/supabase/server', () => ({\n  getSupabaseServerClient: jest.fn(() => Promise.resolve(mockSupabaseClient)),\n}));\n\n// Mock authentication middleware\njest.mock('@/lib/core/auth/middleware', () => ({\n  getUser: jest.fn(() => Promise.resolve({\n    id: 'user-123',\n    email: 'test@example.com',\n    role: 'user'\n  })),\n}));\n\n// Mock logger\njest.mock('@/lib/utils/logger', () => ({\n  devLog: jest.fn(),\n}));\n\ndescribe('Polls CRUD API - REWRITTEN', () => {\n  beforeEach(() => {\n    jest.clearAllMocks();\n  });\n\n  afterEach(() => {\n    jest.restoreAllMocks();\n  });\n\n  describe('GET /api/polls - List Polls', () => {\n    it('should return list of polls with pagination', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls?limit=2');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.polls).toHaveLength(2);\n      expect(responseData.polls[0].title).toBe('Test Poll 1');\n      expect(responseData.polls[1].title).toBe('Test Poll 2');\n    });\n\n    it('should handle empty poll list', async () => {\n      // Mock empty response\n      mockSupabaseClient.from().select().eq().limit.mockResolvedValueOnce({\n        data: [],\n        error: null,\n      });\n\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(200);\n      expect(responseData.polls).toHaveLength(0);\n    });\n\n    it('should handle database errors gracefully', async () => {\n      // Mock database error\n      mockSupabaseClient.from().select().eq().limit.mockResolvedValueOnce({\n        data: null,\n        error: { message: 'Database connection failed' },\n      });\n\n      const request = new NextRequest('http://localhost:3000/api/polls');\n      \n      const response = await GET(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(500);\n      expect(responseData.error).toBe('Database connection failed');\n    });\n  });\n\n  describe('POST /api/polls - Create Poll', () => {\n    it('should create a new poll with valid data', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'New Test Poll',\n          options: [\n            { text: 'New Option 1' },\n            { text: 'New Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(201);\n      expect(responseData.poll.title).toBe('New Test Poll');\n      expect(responseData.poll.id).toBe('poll-123');\n    });\n\n    it('should reject poll creation without authentication', async () => {\n      // Mock no authentication\n      const { getUser } = require('@/lib/core/auth/middleware');\n      getUser.mockResolvedValueOnce(null);\n\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'Unauthorized Poll',\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(401);\n      expect(responseData.error).toBe('Authentication required');\n    });\n\n    it('should reject poll creation with missing title', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(400);\n      expect(responseData.error).toBe('Title and at least 2 options are required');\n    });\n\n    it('should reject poll creation with insufficient options', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'Insufficient Options Poll',\n          options: [\n            { text: 'Only One Option' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(400);\n      expect(responseData.error).toBe('Title and at least 2 options are required');\n    });\n\n    it('should handle database errors during creation', async () => {\n      // Mock database error during insert\n      mockSupabaseClient.from().insert().select.mockResolvedValueOnce({\n        data: null,\n        error: { message: 'Insert failed' },\n      });\n\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          title: 'Database Error Poll',\n          options: [\n            { text: 'Option 1' },\n            { text: 'Option 2' }\n          ]\n        }),\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(500);\n      expect(responseData.error).toBe('Insert failed');\n    });\n  });\n\n  describe('Error Handling', () => {\n    it('should handle malformed JSON gracefully', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: 'invalid json',\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(500);\n      expect(responseData.error).toBe('Invalid JSON');\n    });\n\n    it('should handle missing request body', async () => {\n      const request = new NextRequest('http://localhost:3000/api/polls', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const response = await POST(request);\n      const responseData = await response.json();\n\n      expect(response.status).toBe(400);\n      expect(responseData.error).toBe('Request body is required');\n    });\n  });\n});\n"],"names":["jest","mock","getSupabaseServerClient","fn","Promise","resolve","mockSupabaseClient","getUser","id","email","role","devLog","from","select","eq","limit","mockResolvedValue","data","title","total_votes","options","text","votes","status","error","insert","auth","describe","beforeEach","clearAllMocks","afterEach","restoreAllMocks","it","request","NextRequest","response","GET","responseData","json","expect","toBe","polls","toHaveLength","mockResolvedValueOnce","message","method","headers","body","JSON","stringify","POST","poll","require"],"mappings":"AAAA;;;;;;;;;CASC;AA2DD,kCAAkC;AAClCA,KAAKC,IAAI,CAAC,2BAA2B,IAAO,CAAA;QAC1CC,yBAAyBF,KAAKG,EAAE,CAAC,IAAMC,QAAQC,OAAO,CAACC;IACzD,CAAA;AAEA,iCAAiC;AACjCN,KAAKC,IAAI,CAAC,8BAA8B,IAAO,CAAA;QAC7CM,SAASP,KAAKG,EAAE,CAAC,IAAMC,QAAQC,OAAO,CAAC;gBACrCG,IAAI;gBACJC,OAAO;gBACPC,MAAM;YACR;IACF,CAAA;AAEA,cAAc;AACdV,KAAKC,IAAI,CAAC,sBAAsB,IAAO,CAAA;QACrCU,QAAQX,KAAKG,EAAE;IACjB,CAAA;;;;yBA1E4D;wBAChC;uBACF;AAE1B,6CAA6C;AAC7C,MAAMG,qBAAqB;IACzBM,MAAMZ,KAAKG,EAAE,CAAC,IAAO,CAAA;YACnBU,QAAQb,KAAKG,EAAE,CAAC,IAAO,CAAA;oBACrBW,IAAId,KAAKG,EAAE,CAAC,IAAO,CAAA;4BACjBY,OAAOf,KAAKG,EAAE,GAAGa,iBAAiB,CAAC;gCACjCC,MAAM;oCACJ;wCACET,IAAI;wCACJU,OAAO;wCACPC,aAAa;wCACbC,SAAS;4CACP;gDAAEZ,IAAI;gDAASa,MAAM;gDAAYC,OAAO;4CAAE;4CAC1C;gDAAEd,IAAI;gDAASa,MAAM;gDAAYC,OAAO;4CAAE;yCAC3C;wCACDC,QAAQ;oCACV;oCACA;wCACEf,IAAI;wCACJU,OAAO;wCACPC,aAAa;wCACbC,SAAS;4CACP;gDAAEZ,IAAI;gDAASa,MAAM;gDAAYC,OAAO;4CAAE;4CAC1C;gDAAEd,IAAI;gDAASa,MAAM;gDAAYC,OAAO;4CAAE;yCAC3C;wCACDC,QAAQ;oCACV;iCACD;gCACDC,OAAO;4BACT;wBACF,CAAA;gBACF,CAAA;YACAC,QAAQzB,KAAKG,EAAE,CAAC,IAAO,CAAA;oBACrBU,QAAQb,KAAKG,EAAE,GAAGa,iBAAiB,CAAC;wBAClCC,MAAM;4BAAC;gCACLT,IAAI;gCACJU,OAAO;gCACPC,aAAa;gCACbC,SAAS;oCACP;wCAAEZ,IAAI;wCAAaa,MAAM;wCAAgBC,OAAO;oCAAE;oCAClD;wCAAEd,IAAI;wCAAaa,MAAM;wCAAgBC,OAAO;oCAAE;iCACnD;gCACDC,QAAQ;4BACV;yBAAE;wBACFC,OAAO;oBACT;gBACF,CAAA;QACF,CAAA;IACAE,MAAM;QACJnB,SAASP,KAAKG,EAAE;IAClB;AACF;AAqBAwB,IAAAA,iBAAQ,EAAC,8BAA8B;IACrCC,IAAAA,mBAAU,EAAC;QACT5B,KAAK6B,aAAa;IACpB;IAEAC,IAAAA,kBAAS,EAAC;QACR9B,KAAK+B,eAAe;IACtB;IAEAJ,IAAAA,iBAAQ,EAAC,+BAA+B;QACtCK,IAAAA,WAAE,EAAC,+CAA+C;YAChD,MAAMC,UAAU,IAAIC,mBAAW,CAAC;YAEhC,MAAMC,WAAW,MAAMC,IAAAA,UAAG,EAACH;YAC3B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAaI,KAAK,EAAEC,YAAY,CAAC;YACxCH,IAAAA,eAAM,EAACF,aAAaI,KAAK,CAAC,EAAE,CAACvB,KAAK,EAAEsB,IAAI,CAAC;YACzCD,IAAAA,eAAM,EAACF,aAAaI,KAAK,CAAC,EAAE,CAACvB,KAAK,EAAEsB,IAAI,CAAC;QAC3C;QAEAR,IAAAA,WAAE,EAAC,iCAAiC;YAClC,sBAAsB;YACtB1B,mBAAmBM,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,KAAK,CAAC4B,qBAAqB,CAAC;gBAClE1B,MAAM,EAAE;gBACRO,OAAO;YACT;YAEA,MAAMS,UAAU,IAAIC,mBAAW,CAAC;YAEhC,MAAMC,WAAW,MAAMC,IAAAA,UAAG,EAACH;YAC3B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAaI,KAAK,EAAEC,YAAY,CAAC;QAC1C;QAEAV,IAAAA,WAAE,EAAC,4CAA4C;YAC7C,sBAAsB;YACtB1B,mBAAmBM,IAAI,GAAGC,MAAM,GAAGC,EAAE,GAAGC,KAAK,CAAC4B,qBAAqB,CAAC;gBAClE1B,MAAM;gBACNO,OAAO;oBAAEoB,SAAS;gBAA6B;YACjD;YAEA,MAAMX,UAAU,IAAIC,mBAAW,CAAC;YAEhC,MAAMC,WAAW,MAAMC,IAAAA,UAAG,EAACH;YAC3B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAab,KAAK,EAAEgB,IAAI,CAAC;QAClC;IACF;IAEAb,IAAAA,iBAAQ,EAAC,iCAAiC;QACxCK,IAAAA,WAAE,EAAC,4CAA4C;YAC7C,MAAMC,UAAU,IAAIC,mBAAW,CAAC,mCAAmC;gBACjEW,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;gBACAC,MAAMC,KAAKC,SAAS,CAAC;oBACnB/B,OAAO;oBACPE,SAAS;wBACP;4BAAEC,MAAM;wBAAe;wBACvB;4BAAEA,MAAM;wBAAe;qBACxB;gBACH;YACF;YAEA,MAAMc,WAAW,MAAMe,IAAAA,WAAI,EAACjB;YAC5B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAac,IAAI,CAACjC,KAAK,EAAEsB,IAAI,CAAC;YACrCD,IAAAA,eAAM,EAACF,aAAac,IAAI,CAAC3C,EAAE,EAAEgC,IAAI,CAAC;QACpC;QAEAR,IAAAA,WAAE,EAAC,sDAAsD;YACvD,yBAAyB;YACzB,MAAM,EAAEzB,OAAO,EAAE,GAAG6C,QAAQ;YAC5B7C,QAAQoC,qBAAqB,CAAC;YAE9B,MAAMV,UAAU,IAAIC,mBAAW,CAAC,mCAAmC;gBACjEW,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;gBACAC,MAAMC,KAAKC,SAAS,CAAC;oBACnB/B,OAAO;oBACPE,SAAS;wBACP;4BAAEC,MAAM;wBAAW;wBACnB;4BAAEA,MAAM;wBAAW;qBACpB;gBACH;YACF;YAEA,MAAMc,WAAW,MAAMe,IAAAA,WAAI,EAACjB;YAC5B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAab,KAAK,EAAEgB,IAAI,CAAC;QAClC;QAEAR,IAAAA,WAAE,EAAC,kDAAkD;YACnD,MAAMC,UAAU,IAAIC,mBAAW,CAAC,mCAAmC;gBACjEW,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;gBACAC,MAAMC,KAAKC,SAAS,CAAC;oBACnB7B,SAAS;wBACP;4BAAEC,MAAM;wBAAW;wBACnB;4BAAEA,MAAM;wBAAW;qBACpB;gBACH;YACF;YAEA,MAAMc,WAAW,MAAMe,IAAAA,WAAI,EAACjB;YAC5B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAab,KAAK,EAAEgB,IAAI,CAAC;QAClC;QAEAR,IAAAA,WAAE,EAAC,yDAAyD;YAC1D,MAAMC,UAAU,IAAIC,mBAAW,CAAC,mCAAmC;gBACjEW,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;gBACAC,MAAMC,KAAKC,SAAS,CAAC;oBACnB/B,OAAO;oBACPE,SAAS;wBACP;4BAAEC,MAAM;wBAAkB;qBAC3B;gBACH;YACF;YAEA,MAAMc,WAAW,MAAMe,IAAAA,WAAI,EAACjB;YAC5B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAab,KAAK,EAAEgB,IAAI,CAAC;QAClC;QAEAR,IAAAA,WAAE,EAAC,iDAAiD;YAClD,oCAAoC;YACpC1B,mBAAmBM,IAAI,GAAGa,MAAM,GAAGZ,MAAM,CAAC8B,qBAAqB,CAAC;gBAC9D1B,MAAM;gBACNO,OAAO;oBAAEoB,SAAS;gBAAgB;YACpC;YAEA,MAAMX,UAAU,IAAIC,mBAAW,CAAC,mCAAmC;gBACjEW,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;gBACAC,MAAMC,KAAKC,SAAS,CAAC;oBACnB/B,OAAO;oBACPE,SAAS;wBACP;4BAAEC,MAAM;wBAAW;wBACnB;4BAAEA,MAAM;wBAAW;qBACpB;gBACH;YACF;YAEA,MAAMc,WAAW,MAAMe,IAAAA,WAAI,EAACjB;YAC5B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAab,KAAK,EAAEgB,IAAI,CAAC;QAClC;IACF;IAEAb,IAAAA,iBAAQ,EAAC,kBAAkB;QACzBK,IAAAA,WAAE,EAAC,2CAA2C;YAC5C,MAAMC,UAAU,IAAIC,mBAAW,CAAC,mCAAmC;gBACjEW,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;gBACAC,MAAM;YACR;YAEA,MAAMZ,WAAW,MAAMe,IAAAA,WAAI,EAACjB;YAC5B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAab,KAAK,EAAEgB,IAAI,CAAC;QAClC;QAEAR,IAAAA,WAAE,EAAC,sCAAsC;YACvC,MAAMC,UAAU,IAAIC,mBAAW,CAAC,mCAAmC;gBACjEW,QAAQ;gBACRC,SAAS;oBACP,gBAAgB;gBAClB;YACF;YAEA,MAAMX,WAAW,MAAMe,IAAAA,WAAI,EAACjB;YAC5B,MAAMI,eAAe,MAAMF,SAASG,IAAI;YAExCC,IAAAA,eAAM,EAACJ,SAASZ,MAAM,EAAEiB,IAAI,CAAC;YAC7BD,IAAAA,eAAM,EAACF,aAAab,KAAK,EAAEgB,IAAI,CAAC;QAClC;IACF;AACF"}