{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/lib/vote/voting-system-integration.test.ts"],"sourcesContent":["/**\n * Voting System Integration Tests\n * \n * Tests the complete voting system with real business logic\n * Focuses on actual functionality rather than heavy mocking\n */\n\nimport { describe, it, expect, beforeEach, jest } from '@jest/globals'\nimport { VoteEngine } from '@/lib/vote/engine'\nimport { IRVCalculator } from '@/lib/vote/irv-calculator'\nimport type { VoteRequest, PollData, VotingMethod, Candidate } from '@/lib/vote/types'\n\n// Mock only the logger - everything else should be real\njest.mock('@/lib/utils/logger', () => ({\n  devLog: jest.fn()\n}))\n\ndescribe('Voting System Integration', () => {\n  let engine: VoteEngine\n  let poll: PollData\n  let candidates: Candidate[]\n\n  beforeEach(() => {\n    engine = new VoteEngine({\n      maxVotesPerPoll: 1,\n      allowMultipleVotes: false,\n      requireAuthentication: true,\n      minTrustTier: 'basic',\n      rateLimitPerUser: 10,\n      rateLimitWindowMs: 60000\n    })\n\n    candidates = [\n      { id: 'candidate-1', name: 'Alice', description: 'Alice for Mayor' },\n      { id: 'candidate-2', name: 'Bob', description: 'Bob for Mayor' },\n      { id: 'candidate-3', name: 'Charlie', description: 'Charlie for Mayor' }\n    ]\n\n    poll = {\n      id: 'test-poll-id',\n      title: 'Mayor Election',\n      description: 'Choose your next mayor',\n      votingMethod: 'single-choice' as VotingMethod,\n      options: candidates,\n      status: 'active',\n      createdAt: new Date(),\n      closeAt: new Date(Date.now() + 86400000), // 24 hours from now\n      createdBy: 'user-1',\n      votingConfig: {\n        allowMultipleVotes: false,\n        requireAuthentication: true,\n        anonymousVoting: false\n      }\n    }\n  })\n\n  describe('Single Choice Voting', () => {\n    it('should process single choice votes correctly', async () => {\n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          choice: 0, // First candidate\n          selectedOptions: ['candidate-1'],\n          ranking: null,\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      // Test validation\n      const validation = await engine.validateVote(voteRequest, poll)\n      expect(validation.valid).toBe(true)\n\n      // Test processing\n      const response = await engine.processVote(voteRequest, poll)\n      expect(response.success).toBe(true)\n      expect(response.voteId).toBeDefined()\n    })\n\n    it('should reject votes for closed polls', async () => {\n      const closedPoll = { ...poll, status: 'closed' as const }\n      \n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          selectedOptions: ['candidate-1'],\n          ranking: null,\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      const validation = await engine.validateVote(voteRequest, closedPoll)\n      expect(validation.valid).toBe(false)\n      expect(validation.errors).toContain('Poll is not active')\n    })\n\n    it('should reject votes with invalid options', async () => {\n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          choice: 999, // Invalid choice\n          selectedOptions: ['invalid-candidate'],\n          ranking: null,\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      const validation = await engine.validateVote(voteRequest, poll)\n      expect(validation.valid).toBe(false)\n      expect(validation.errors).toContain('Invalid option selected')\n    })\n  })\n\n  describe('Ranked Choice Voting', () => {\n    it('should process ranked choice votes correctly', async () => {\n      const rankedPoll = { ...poll, votingMethod: 'ranked-choice' as VotingMethod }\n      \n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          selectedOptions: [],\n          rankings: [0, 1, 2], // Indices of candidates in order of preference\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      const validation = await engine.validateVote(voteRequest, rankedPoll)\n      expect(validation.valid).toBe(true)\n\n      const response = await engine.processVote(voteRequest, rankedPoll)\n      expect(response.success).toBe(true)\n    })\n\n    it('should calculate IRV results correctly', () => {\n      const calculator = new IRVCalculator('test-poll', candidates)\n      \n      const userRankings = [\n        { userId: 'user-1', ranking: ['candidate-1', 'candidate-2', 'candidate-3'] },\n        { userId: 'user-2', ranking: ['candidate-1', 'candidate-2', 'candidate-3'] },\n        { userId: 'user-3', ranking: ['candidate-2', 'candidate-1', 'candidate-3'] },\n        { userId: 'user-4', ranking: ['candidate-2', 'candidate-1', 'candidate-3'] }\n      ]\n\n      const results = calculator.calculateResults(userRankings)\n      \n      expect(results.totalVotes).toBe(4)\n      expect(results.winner).toBe('candidate-1')\n      expect(results.rounds).toHaveLength(2) // IRV correctly takes 2 rounds to determine winner\n    })\n\n    it('should handle tie scenarios in IRV', () => {\n      const calculator = new IRVCalculator('test-poll', candidates)\n      \n      const userRankings = [\n        { userId: 'user-1', ranking: ['candidate-1', 'candidate-2', 'candidate-3'] },\n        { userId: 'user-2', ranking: ['candidate-2', 'candidate-1', 'candidate-3'] }\n      ]\n\n      const results = calculator.calculateResults(userRankings)\n      \n      expect(results.totalVotes).toBe(2)\n      expect(results.rounds.length).toBeGreaterThan(1)\n    })\n  })\n\n  describe('Approval Voting', () => {\n    it('should process approval votes correctly', async () => {\n      const approvalPoll = { ...poll, votingMethod: 'approval' as VotingMethod }\n      \n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          selectedOptions: ['candidate-1', 'candidate-2'],\n          approvals: [0, 1], // Approve first two candidates\n          ranking: null,\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      const validation = await engine.validateVote(voteRequest, approvalPoll)\n      expect(validation.valid).toBe(true)\n\n      const response = await engine.processVote(voteRequest, approvalPoll)\n      expect(response.success).toBe(true)\n    })\n  })\n\n  describe('Quadratic Voting', () => {\n    it('should process quadratic votes correctly', async () => {\n      const quadraticPoll = { ...poll, votingMethod: 'quadratic' as VotingMethod }\n      \n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          selectedOptions: [],\n          ranking: null,\n          allocations: { '0': 2, '1': 1 } // Allocate credits to first two candidates\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      const validation = await engine.validateVote(voteRequest, quadraticPoll)\n      if (!validation.valid) {\n        console.log('Quadratic validation failed:', validation.errors)\n      }\n      expect(validation.valid).toBe(true)\n\n      const response = await engine.processVote(voteRequest, quadraticPoll)\n      expect(response.success).toBe(true)\n    })\n  })\n\n  describe('Rate Limiting', () => {\n    it('should enforce rate limits', async () => {\n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          choice: 0, // First candidate\n          selectedOptions: ['candidate-1'],\n          ranking: null,\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      // Make multiple requests to test rate limiting\n      const responses = []\n      for (let i = 0; i < 15; i++) {\n        const response = await engine.processVote(voteRequest, poll)\n        responses.push(response)\n      }\n\n      // Some requests should be rate limited\n      const rateLimitedResponses = responses.filter(r => !r.success && r.error?.includes('Rate limit exceeded'))\n      expect(rateLimitedResponses.length).toBeGreaterThan(0)\n    })\n  })\n\n  describe('Results Calculation', () => {\n    it('should calculate results for single choice votes', async () => {\n      const votes = [\n        {\n          id: 'vote-1',\n          pollId: 'test-poll-id',\n          userId: 'user-1',\n          choice: 0, // First candidate\n          privacyLevel: 'public',\n          timestamp: new Date(),\n          auditReceipt: 'receipt-1'\n        },\n        {\n          id: 'vote-2',\n          pollId: 'test-poll-id',\n          userId: 'user-2',\n          choice: 0, // First candidate\n          privacyLevel: 'public',\n          timestamp: new Date(),\n          auditReceipt: 'receipt-2'\n        },\n        {\n          id: 'vote-3',\n          pollId: 'test-poll-id',\n          userId: 'user-3',\n          choice: 1, // Second candidate\n          privacyLevel: 'public',\n          timestamp: new Date(),\n          auditReceipt: 'receipt-3'\n        }\n      ]\n\n      const results = await engine.calculateResults(poll, votes)\n      \n      expect(results.totalVotes).toBe(3)\n      expect(results.results.winner).toBe('candidate-1') // Winner is the candidate ID\n    })\n\n    it('should handle empty vote sets', async () => {\n      const results = await engine.calculateResults(poll, [])\n      \n      expect(results.totalVotes).toBe(0)\n      expect(results.results.winner).toBeNull()\n    })\n  })\n\n  describe('Error Handling', () => {\n    it('should handle malformed vote data', async () => {\n      const malformedRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: null,\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      } as any\n\n      const response = await engine.processVote(malformedRequest, poll)\n      \n      expect(response.success).toBe(false)\n      expect(response.error).toBeDefined()\n    })\n\n    it('should handle missing poll data', async () => {\n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          selectedOptions: ['candidate-1'],\n          ranking: null,\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      const response = await engine.processVote(voteRequest, null as any)\n      \n      expect(response.success).toBe(false)\n      expect(response.error).toBeDefined()\n    })\n  })\n\n  describe('Performance', () => {\n    it('should process votes within reasonable time', async () => {\n      const voteRequest: VoteRequest = {\n        pollId: 'test-poll-id',\n        userId: 'user-1',\n        voteData: {\n          selectedOptions: ['candidate-1'],\n          ranking: null,\n          weights: null\n        },\n        metadata: {\n          ipAddress: '192.168.1.1',\n          userAgent: 'Mozilla/5.0',\n          timestamp: new Date()\n        }\n      }\n\n      const startTime = performance.now()\n      await engine.processVote(voteRequest, poll)\n      const endTime = performance.now()\n      \n      const processingTime = endTime - startTime\n      expect(processingTime).toBeLessThan(100) // Should process within 100ms\n    })\n\n    it('should handle large vote sets efficiently', async () => {\n      const largeVoteSet = Array.from({ length: 1000 }, (_, i) => ({\n        id: `vote-${i}`,\n        pollId: 'test-poll-id',\n        userId: `user-${i}`,\n        choice: 0, // First candidate\n        privacyLevel: 'public',\n        timestamp: new Date(),\n        auditReceipt: `receipt-${i}`\n      }))\n\n      const startTime = performance.now()\n      const results = await engine.calculateResults(poll, largeVoteSet)\n      const endTime = performance.now()\n      \n      expect(results).toBeDefined()\n      expect(results.totalVotes).toBe(1000)\n      expect(endTime - startTime).toBeLessThan(1000) // Should process within 1 second\n    })\n  })\n})\n\n\n\n\n\n"],"names":["jest","mock","devLog","fn","describe","engine","poll","candidates","beforeEach","VoteEngine","maxVotesPerPoll","allowMultipleVotes","requireAuthentication","minTrustTier","rateLimitPerUser","rateLimitWindowMs","id","name","description","title","votingMethod","options","status","createdAt","Date","closeAt","now","createdBy","votingConfig","anonymousVoting","it","voteRequest","pollId","userId","voteData","choice","selectedOptions","ranking","weights","metadata","ipAddress","userAgent","timestamp","validation","validateVote","expect","valid","toBe","response","processVote","success","voteId","toBeDefined","closedPoll","errors","toContain","rankedPoll","rankings","calculator","IRVCalculator","userRankings","results","calculateResults","totalVotes","winner","rounds","toHaveLength","length","toBeGreaterThan","approvalPoll","approvals","quadraticPoll","allocations","console","log","responses","i","push","rateLimitedResponses","filter","r","error","includes","votes","privacyLevel","auditReceipt","toBeNull","malformedRequest","startTime","performance","endTime","processingTime","toBeLessThan","largeVoteSet","Array","from","_"],"mappings":"AAAA;;;;;CAKC;;;;yBAEsD;wBAC5B;+BACG;AAG9B,wDAAwD;AACxDA,aAAI,CAACC,IAAI,CAAC,sBAAsB,IAAO,CAAA;QACrCC,QAAQF,aAAI,CAACG,EAAE;IACjB,CAAA;AAEAC,IAAAA,iBAAQ,EAAC,6BAA6B;IACpC,IAAIC;IACJ,IAAIC;IACJ,IAAIC;IAEJC,IAAAA,mBAAU,EAAC;QACTH,SAAS,IAAII,kBAAU,CAAC;YACtBC,iBAAiB;YACjBC,oBAAoB;YACpBC,uBAAuB;YACvBC,cAAc;YACdC,kBAAkB;YAClBC,mBAAmB;QACrB;QAEAR,aAAa;YACX;gBAAES,IAAI;gBAAeC,MAAM;gBAASC,aAAa;YAAkB;YACnE;gBAAEF,IAAI;gBAAeC,MAAM;gBAAOC,aAAa;YAAgB;YAC/D;gBAAEF,IAAI;gBAAeC,MAAM;gBAAWC,aAAa;YAAoB;SACxE;QAEDZ,OAAO;YACLU,IAAI;YACJG,OAAO;YACPD,aAAa;YACbE,cAAc;YACdC,SAASd;YACTe,QAAQ;YACRC,WAAW,IAAIC;YACfC,SAAS,IAAID,KAAKA,KAAKE,GAAG,KAAK;YAC/BC,WAAW;YACXC,cAAc;gBACZjB,oBAAoB;gBACpBC,uBAAuB;gBACvBiB,iBAAiB;YACnB;QACF;IACF;IAEAzB,IAAAA,iBAAQ,EAAC,wBAAwB;QAC/B0B,IAAAA,WAAE,EAAC,gDAAgD;YACjD,MAAMC,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRC,QAAQ;oBACRC,iBAAiB;wBAAC;qBAAc;oBAChCC,SAAS;oBACTC,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,kBAAkB;YAClB,MAAMmB,aAAa,MAAMtC,OAAOuC,YAAY,CAACb,aAAazB;YAC1DuC,IAAAA,eAAM,EAACF,WAAWG,KAAK,EAAEC,IAAI,CAAC;YAE9B,kBAAkB;YAClB,MAAMC,WAAW,MAAM3C,OAAO4C,WAAW,CAAClB,aAAazB;YACvDuC,IAAAA,eAAM,EAACG,SAASE,OAAO,EAAEH,IAAI,CAAC;YAC9BF,IAAAA,eAAM,EAACG,SAASG,MAAM,EAAEC,WAAW;QACrC;QAEAtB,IAAAA,WAAE,EAAC,wCAAwC;YACzC,MAAMuB,aAAa;gBAAE,GAAG/C,IAAI;gBAAEgB,QAAQ;YAAkB;YAExD,MAAMS,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRE,iBAAiB;wBAAC;qBAAc;oBAChCC,SAAS;oBACTC,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMmB,aAAa,MAAMtC,OAAOuC,YAAY,CAACb,aAAasB;YAC1DR,IAAAA,eAAM,EAACF,WAAWG,KAAK,EAAEC,IAAI,CAAC;YAC9BF,IAAAA,eAAM,EAACF,WAAWW,MAAM,EAAEC,SAAS,CAAC;QACtC;QAEAzB,IAAAA,WAAE,EAAC,4CAA4C;YAC7C,MAAMC,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRC,QAAQ;oBACRC,iBAAiB;wBAAC;qBAAoB;oBACtCC,SAAS;oBACTC,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMmB,aAAa,MAAMtC,OAAOuC,YAAY,CAACb,aAAazB;YAC1DuC,IAAAA,eAAM,EAACF,WAAWG,KAAK,EAAEC,IAAI,CAAC;YAC9BF,IAAAA,eAAM,EAACF,WAAWW,MAAM,EAAEC,SAAS,CAAC;QACtC;IACF;IAEAnD,IAAAA,iBAAQ,EAAC,wBAAwB;QAC/B0B,IAAAA,WAAE,EAAC,gDAAgD;YACjD,MAAM0B,aAAa;gBAAE,GAAGlD,IAAI;gBAAEc,cAAc;YAAgC;YAE5E,MAAMW,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRE,iBAAiB,EAAE;oBACnBqB,UAAU;wBAAC;wBAAG;wBAAG;qBAAE;oBACnBnB,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMmB,aAAa,MAAMtC,OAAOuC,YAAY,CAACb,aAAayB;YAC1DX,IAAAA,eAAM,EAACF,WAAWG,KAAK,EAAEC,IAAI,CAAC;YAE9B,MAAMC,WAAW,MAAM3C,OAAO4C,WAAW,CAAClB,aAAayB;YACvDX,IAAAA,eAAM,EAACG,SAASE,OAAO,EAAEH,IAAI,CAAC;QAChC;QAEAjB,IAAAA,WAAE,EAAC,0CAA0C;YAC3C,MAAM4B,aAAa,IAAIC,4BAAa,CAAC,aAAapD;YAElD,MAAMqD,eAAe;gBACnB;oBAAE3B,QAAQ;oBAAUI,SAAS;wBAAC;wBAAe;wBAAe;qBAAc;gBAAC;gBAC3E;oBAAEJ,QAAQ;oBAAUI,SAAS;wBAAC;wBAAe;wBAAe;qBAAc;gBAAC;gBAC3E;oBAAEJ,QAAQ;oBAAUI,SAAS;wBAAC;wBAAe;wBAAe;qBAAc;gBAAC;gBAC3E;oBAAEJ,QAAQ;oBAAUI,SAAS;wBAAC;wBAAe;wBAAe;qBAAc;gBAAC;aAC5E;YAED,MAAMwB,UAAUH,WAAWI,gBAAgB,CAACF;YAE5Cf,IAAAA,eAAM,EAACgB,QAAQE,UAAU,EAAEhB,IAAI,CAAC;YAChCF,IAAAA,eAAM,EAACgB,QAAQG,MAAM,EAAEjB,IAAI,CAAC;YAC5BF,IAAAA,eAAM,EAACgB,QAAQI,MAAM,EAAEC,YAAY,CAAC,GAAG,mDAAmD;;QAC5F;QAEApC,IAAAA,WAAE,EAAC,sCAAsC;YACvC,MAAM4B,aAAa,IAAIC,4BAAa,CAAC,aAAapD;YAElD,MAAMqD,eAAe;gBACnB;oBAAE3B,QAAQ;oBAAUI,SAAS;wBAAC;wBAAe;wBAAe;qBAAc;gBAAC;gBAC3E;oBAAEJ,QAAQ;oBAAUI,SAAS;wBAAC;wBAAe;wBAAe;qBAAc;gBAAC;aAC5E;YAED,MAAMwB,UAAUH,WAAWI,gBAAgB,CAACF;YAE5Cf,IAAAA,eAAM,EAACgB,QAAQE,UAAU,EAAEhB,IAAI,CAAC;YAChCF,IAAAA,eAAM,EAACgB,QAAQI,MAAM,CAACE,MAAM,EAAEC,eAAe,CAAC;QAChD;IACF;IAEAhE,IAAAA,iBAAQ,EAAC,mBAAmB;QAC1B0B,IAAAA,WAAE,EAAC,2CAA2C;YAC5C,MAAMuC,eAAe;gBAAE,GAAG/D,IAAI;gBAAEc,cAAc;YAA2B;YAEzE,MAAMW,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRE,iBAAiB;wBAAC;wBAAe;qBAAc;oBAC/CkC,WAAW;wBAAC;wBAAG;qBAAE;oBACjBjC,SAAS;oBACTC,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMmB,aAAa,MAAMtC,OAAOuC,YAAY,CAACb,aAAasC;YAC1DxB,IAAAA,eAAM,EAACF,WAAWG,KAAK,EAAEC,IAAI,CAAC;YAE9B,MAAMC,WAAW,MAAM3C,OAAO4C,WAAW,CAAClB,aAAasC;YACvDxB,IAAAA,eAAM,EAACG,SAASE,OAAO,EAAEH,IAAI,CAAC;QAChC;IACF;IAEA3C,IAAAA,iBAAQ,EAAC,oBAAoB;QAC3B0B,IAAAA,WAAE,EAAC,4CAA4C;YAC7C,MAAMyC,gBAAgB;gBAAE,GAAGjE,IAAI;gBAAEc,cAAc;YAA4B;YAE3E,MAAMW,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRE,iBAAiB,EAAE;oBACnBC,SAAS;oBACTmC,aAAa;wBAAE,KAAK;wBAAG,KAAK;oBAAE,EAAE,2CAA2C;gBAC7E;gBACAjC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMmB,aAAa,MAAMtC,OAAOuC,YAAY,CAACb,aAAawC;YAC1D,IAAI,CAAC5B,WAAWG,KAAK,EAAE;gBACrB2B,QAAQC,GAAG,CAAC,gCAAgC/B,WAAWW,MAAM;YAC/D;YACAT,IAAAA,eAAM,EAACF,WAAWG,KAAK,EAAEC,IAAI,CAAC;YAE9B,MAAMC,WAAW,MAAM3C,OAAO4C,WAAW,CAAClB,aAAawC;YACvD1B,IAAAA,eAAM,EAACG,SAASE,OAAO,EAAEH,IAAI,CAAC;QAChC;IACF;IAEA3C,IAAAA,iBAAQ,EAAC,iBAAiB;QACxB0B,IAAAA,WAAE,EAAC,8BAA8B;YAC/B,MAAMC,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRC,QAAQ;oBACRC,iBAAiB;wBAAC;qBAAc;oBAChCC,SAAS;oBACTC,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,+CAA+C;YAC/C,MAAMmD,YAAY,EAAE;YACpB,IAAK,IAAIC,IAAI,GAAGA,IAAI,IAAIA,IAAK;gBAC3B,MAAM5B,WAAW,MAAM3C,OAAO4C,WAAW,CAAClB,aAAazB;gBACvDqE,UAAUE,IAAI,CAAC7B;YACjB;YAEA,uCAAuC;YACvC,MAAM8B,uBAAuBH,UAAUI,MAAM,CAACC,CAAAA,IAAK,CAACA,EAAE9B,OAAO,IAAI8B,EAAEC,KAAK,EAAEC,SAAS;YACnFrC,IAAAA,eAAM,EAACiC,qBAAqBX,MAAM,EAAEC,eAAe,CAAC;QACtD;IACF;IAEAhE,IAAAA,iBAAQ,EAAC,uBAAuB;QAC9B0B,IAAAA,WAAE,EAAC,oDAAoD;YACrD,MAAMqD,QAAQ;gBACZ;oBACEnE,IAAI;oBACJgB,QAAQ;oBACRC,QAAQ;oBACRE,QAAQ;oBACRiD,cAAc;oBACd1C,WAAW,IAAIlB;oBACf6D,cAAc;gBAChB;gBACA;oBACErE,IAAI;oBACJgB,QAAQ;oBACRC,QAAQ;oBACRE,QAAQ;oBACRiD,cAAc;oBACd1C,WAAW,IAAIlB;oBACf6D,cAAc;gBAChB;gBACA;oBACErE,IAAI;oBACJgB,QAAQ;oBACRC,QAAQ;oBACRE,QAAQ;oBACRiD,cAAc;oBACd1C,WAAW,IAAIlB;oBACf6D,cAAc;gBAChB;aACD;YAED,MAAMxB,UAAU,MAAMxD,OAAOyD,gBAAgB,CAACxD,MAAM6E;YAEpDtC,IAAAA,eAAM,EAACgB,QAAQE,UAAU,EAAEhB,IAAI,CAAC;YAChCF,IAAAA,eAAM,EAACgB,QAAQA,OAAO,CAACG,MAAM,EAAEjB,IAAI,CAAC,eAAe,6BAA6B;;QAClF;QAEAjB,IAAAA,WAAE,EAAC,iCAAiC;YAClC,MAAM+B,UAAU,MAAMxD,OAAOyD,gBAAgB,CAACxD,MAAM,EAAE;YAEtDuC,IAAAA,eAAM,EAACgB,QAAQE,UAAU,EAAEhB,IAAI,CAAC;YAChCF,IAAAA,eAAM,EAACgB,QAAQA,OAAO,CAACG,MAAM,EAAEsB,QAAQ;QACzC;IACF;IAEAlF,IAAAA,iBAAQ,EAAC,kBAAkB;QACzB0B,IAAAA,WAAE,EAAC,qCAAqC;YACtC,MAAMyD,mBAAmB;gBACvBvD,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;gBACVK,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMwB,WAAW,MAAM3C,OAAO4C,WAAW,CAACsC,kBAAkBjF;YAE5DuC,IAAAA,eAAM,EAACG,SAASE,OAAO,EAAEH,IAAI,CAAC;YAC9BF,IAAAA,eAAM,EAACG,SAASiC,KAAK,EAAE7B,WAAW;QACpC;QAEAtB,IAAAA,WAAE,EAAC,mCAAmC;YACpC,MAAMC,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRE,iBAAiB;wBAAC;qBAAc;oBAChCC,SAAS;oBACTC,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMwB,WAAW,MAAM3C,OAAO4C,WAAW,CAAClB,aAAa;YAEvDc,IAAAA,eAAM,EAACG,SAASE,OAAO,EAAEH,IAAI,CAAC;YAC9BF,IAAAA,eAAM,EAACG,SAASiC,KAAK,EAAE7B,WAAW;QACpC;IACF;IAEAhD,IAAAA,iBAAQ,EAAC,eAAe;QACtB0B,IAAAA,WAAE,EAAC,+CAA+C;YAChD,MAAMC,cAA2B;gBAC/BC,QAAQ;gBACRC,QAAQ;gBACRC,UAAU;oBACRE,iBAAiB;wBAAC;qBAAc;oBAChCC,SAAS;oBACTC,SAAS;gBACX;gBACAC,UAAU;oBACRC,WAAW;oBACXC,WAAW;oBACXC,WAAW,IAAIlB;gBACjB;YACF;YAEA,MAAMgE,YAAYC,YAAY/D,GAAG;YACjC,MAAMrB,OAAO4C,WAAW,CAAClB,aAAazB;YACtC,MAAMoF,UAAUD,YAAY/D,GAAG;YAE/B,MAAMiE,iBAAiBD,UAAUF;YACjC3C,IAAAA,eAAM,EAAC8C,gBAAgBC,YAAY,CAAC,KAAK,8BAA8B;;QACzE;QAEA9D,IAAAA,WAAE,EAAC,6CAA6C;YAC9C,MAAM+D,eAAeC,MAAMC,IAAI,CAAC;gBAAE5B,QAAQ;YAAK,GAAG,CAAC6B,GAAGpB,IAAO,CAAA;oBAC3D5D,IAAI,CAAC,KAAK,EAAE4D,EAAE,CAAC;oBACf5C,QAAQ;oBACRC,QAAQ,CAAC,KAAK,EAAE2C,EAAE,CAAC;oBACnBzC,QAAQ;oBACRiD,cAAc;oBACd1C,WAAW,IAAIlB;oBACf6D,cAAc,CAAC,QAAQ,EAAET,EAAE,CAAC;gBAC9B,CAAA;YAEA,MAAMY,YAAYC,YAAY/D,GAAG;YACjC,MAAMmC,UAAU,MAAMxD,OAAOyD,gBAAgB,CAACxD,MAAMuF;YACpD,MAAMH,UAAUD,YAAY/D,GAAG;YAE/BmB,IAAAA,eAAM,EAACgB,SAAST,WAAW;YAC3BP,IAAAA,eAAM,EAACgB,QAAQE,UAAU,EAAEhB,IAAI,CAAC;YAChCF,IAAAA,eAAM,EAAC6C,UAAUF,WAAWI,YAAY,CAAC,MAAM,iCAAiC;;QAClF;IACF;AACF"}