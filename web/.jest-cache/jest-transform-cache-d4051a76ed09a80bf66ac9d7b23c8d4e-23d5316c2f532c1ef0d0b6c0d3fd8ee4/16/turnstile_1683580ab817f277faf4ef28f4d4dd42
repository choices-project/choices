11cfec99560717f8c11f2fbcd827d3a8
/**
 * Cloudflare Turnstile Integration
 * 
 * Implements Cloudflare Turnstile CAPTCHA verification for enhanced security.
 * Protects against automated attacks and bot submissions.
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: all[name]
    });
}
_export(exports, {
    getTurnstileSiteKey: function() {
        return getTurnstileSiteKey;
    },
    getTurnstileWidgetConfig: function() {
        return getTurnstileWidgetConfig;
    },
    isTurnstileEnabled: function() {
        return isTurnstileEnabled;
    },
    requireTurnstileVerification: function() {
        return requireTurnstileVerification;
    },
    verifyTurnstileToken: function() {
        return verifyTurnstileToken;
    }
});
const _logger = require("../utils/logger");
const _objects = require("../utils/objects");
/**
 * Default Turnstile configuration
 */ const DEFAULT_TURNSTILE_CONFIG = {
    secretKey: process.env.TURNSTILE_SECRET_KEY || "",
    siteKey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "",
    enabled: process.env.NODE_ENV === "production" && !!process.env.TURNSTILE_SECRET_KEY,
    strictMode: process.env.NODE_ENV === "production",
    timeout: 10000
};
async function verifyTurnstileToken(token, config = {}) {
    const finalConfig = Object.assign({}, DEFAULT_TURNSTILE_CONFIG, config);
    // Skip verification if disabled
    if (!finalConfig.enabled) {
        (0, _logger.devLog)("Turnstile verification skipped (disabled)");
        return {
            success: true
        };
    }
    // Validate required configuration
    if (!finalConfig.secretKey) {
        (0, _logger.devLog)("Turnstile verification failed: Missing secret key");
        return {
            success: false,
            error: "Turnstile configuration missing"
        };
    }
    if (!token) {
        (0, _logger.devLog)("Turnstile verification failed: Missing token");
        return {
            success: false,
            error: "Turnstile token required"
        };
    }
    try {
        // Prepare form data for Cloudflare API
        const formData = new FormData();
        formData.append("secret", finalConfig.secretKey);
        formData.append("response", token);
        formData.append("remoteip", "unknown"); // We don't have IP in this context
        // Make request to Cloudflare Turnstile API
        const controller = new AbortController();
        const timeoutId = setTimeout(()=>controller.abort(), finalConfig.timeout);
        const response = await fetch("https://challenges.cloudflare.com/turnstile/v0/siteverify", {
            method: "POST",
            body: formData,
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) {
            throw new Error(`Turnstile API error: ${response.status} ${response.statusText}`);
        }
        const result = await response.json();
        // Log verification attempt
        (0, _logger.devLog)("Turnstile verification result:", {
            success: result.success,
            errorCodes: result.error_codes,
            hostname: result.hostname,
            action: result.action
        });
        if (!result.success) {
            return (0, _objects.withOptional)({
                success: false
            }, {
                error: "Turnstile verification failed",
                errorCodes: result.error_codes
            });
        }
        // Additional validation in strict mode
        if (finalConfig.strictMode) {
            const validationResult = validateTurnstileResponse(result, finalConfig);
            if (!validationResult.success) {
                return validationResult;
            }
        }
        return (0, _objects.withOptional)({
            success: true
        }, {
            hostname: result.hostname,
            action: result.action,
            timestamp: result.challenge_ts
        });
    } catch (error) {
        (0, _logger.devLog)("Turnstile verification error:", error);
        if (error instanceof Error && error.name === "AbortError") {
            return {
                success: false,
                error: "Turnstile verification timeout"
            };
        }
        return {
            success: false,
            error: error instanceof Error ? error.message : "Unknown error"
        };
    }
}
/**
 * Validate Turnstile response in strict mode
 */ function validateTurnstileResponse(response, config) {
    // Use config for validation settings
    if (config.strictMode) {
        // Validate hostname if provided
        if (response.hostname) {
            const allowedHostnames = [
                "choices-platform.vercel.app",
                "choices.app",
                "www.choices.app"
            ];
            if (process.env.NODE_ENV === "development") {
                allowedHostnames.push("localhost", "127.0.0.1");
            }
            if (!allowedHostnames.includes(response.hostname)) {
                return {
                    success: false,
                    error: `Invalid hostname: ${response.hostname}`,
                    hostname: response.hostname
                };
            }
        }
    }
    // Validate action if provided
    if (response.action) {
        const allowedActions = [
            "login",
            "register",
            "vote",
            "create_poll",
            "contact"
        ];
        if (!allowedActions.includes(response.action)) {
            return {
                success: false,
                error: `Invalid action: ${response.action}`,
                action: response.action
            };
        }
    }
    return {
        success: true
    };
}
async function requireTurnstileVerification(request, expectedAction, config) {
    const finalConfig = Object.assign({}, DEFAULT_TURNSTILE_CONFIG, config);
    // Skip if disabled
    if (!finalConfig.enabled) {
        return;
    }
    // Extract token from request
    const token = extractTurnstileToken(request);
    if (!token) {
        throw new Error("Turnstile token required");
    }
    // Verify token
    const result = await verifyTurnstileToken(token, finalConfig);
    if (!result.success) {
        throw new Error(result.error || "Turnstile verification failed");
    }
    // Validate action if specified
    if (expectedAction && result.action && result.action !== expectedAction) {
        throw new Error(`Invalid Turnstile action: expected ${expectedAction}, got ${result.action}`);
    }
}
/**
 * Extract Turnstile token from request
 */ function extractTurnstileToken(request) {
    // Try to get from request body first
    if (request.headers.get("content-type")?.includes("application/json")) {
    // Note: This is a simplified approach. In practice, you'd need to parse the body
    // For now, we'll rely on the client to send it in headers
    }
    // Try to get from headers
    const headerToken = request.headers.get("x-turnstile-token");
    if (headerToken) {
        return headerToken;
    }
    // Try to get from form data (for form submissions)
    const formToken = request.headers.get("cf-turnstile-response");
    if (formToken) {
        return formToken;
    }
    return null;
}
function getTurnstileWidgetConfig(action) {
    return (0, _objects.withOptional)({
        sitekey: process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "",
        theme: "auto",
        size: "normal"
    }, {
        action
    });
}
function isTurnstileEnabled() {
    return DEFAULT_TURNSTILE_CONFIG.enabled && !!DEFAULT_TURNSTILE_CONFIG.secretKey;
}
function getTurnstileSiteKey() {
    return process.env.NEXT_PUBLIC_TURNSTILE_SITE_KEY || "";
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9saWIvc2VjdXJpdHkvdHVybnN0aWxlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ2xvdWRmbGFyZSBUdXJuc3RpbGUgSW50ZWdyYXRpb25cbiAqIFxuICogSW1wbGVtZW50cyBDbG91ZGZsYXJlIFR1cm5zdGlsZSBDQVBUQ0hBIHZlcmlmaWNhdGlvbiBmb3IgZW5oYW5jZWQgc2VjdXJpdHkuXG4gKiBQcm90ZWN0cyBhZ2FpbnN0IGF1dG9tYXRlZCBhdHRhY2tzIGFuZCBib3Qgc3VibWlzc2lvbnMuXG4gKi9cblxuaW1wb3J0IHsgZGV2TG9nIH0gZnJvbSAnQC9saWIvdXRpbHMvbG9nZ2VyJztcbmltcG9ydCB7IHdpdGhPcHRpb25hbCB9IGZyb20gJ0AvbGliL3V0aWxzL29iamVjdHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFR1cm5zdGlsZUNvbmZpZyB7XG4gIHNlY3JldEtleTogc3RyaW5nO1xuICBzaXRlS2V5OiBzdHJpbmc7XG4gIGVuYWJsZWQ6IGJvb2xlYW47XG4gIHN0cmljdE1vZGU6IGJvb2xlYW47XG4gIHRpbWVvdXQ6IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUdXJuc3RpbGVSZXNwb25zZSB7XG4gIHN1Y2Nlc3M6IGJvb2xlYW47XG4gIGNoYWxsZW5nZV90cz86IHN0cmluZztcbiAgaG9zdG5hbWU/OiBzdHJpbmc7XG4gIGFjdGlvbj86IHN0cmluZztcbiAgY2RhdGE/OiBzdHJpbmc7XG4gIGVycm9yX2NvZGVzPzogc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHVybnN0aWxlVmVyaWZpY2F0aW9uUmVzdWx0IHtcbiAgc3VjY2VzczogYm9vbGVhbjtcbiAgZXJyb3I/OiBzdHJpbmc7XG4gIGVycm9yQ29kZXM/OiBzdHJpbmdbXTtcbiAgaG9zdG5hbWU/OiBzdHJpbmc7XG4gIGFjdGlvbj86IHN0cmluZztcbiAgdGltZXN0YW1wPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIERlZmF1bHQgVHVybnN0aWxlIGNvbmZpZ3VyYXRpb25cbiAqL1xuY29uc3QgREVGQVVMVF9UVVJOU1RJTEVfQ09ORklHOiBUdXJuc3RpbGVDb25maWcgPSB7XG4gIHNlY3JldEtleTogcHJvY2Vzcy5lbnYuVFVSTlNUSUxFX1NFQ1JFVF9LRVkgfHwgJycsXG4gIHNpdGVLZXk6IHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1RVUk5TVElMRV9TSVRFX0tFWSB8fCAnJyxcbiAgZW5hYmxlZDogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJyAmJiAhIXByb2Nlc3MuZW52LlRVUk5TVElMRV9TRUNSRVRfS0VZLFxuICBzdHJpY3RNb2RlOiBwcm9jZXNzLmVudi5OT0RFX0VOViA9PT0gJ3Byb2R1Y3Rpb24nLFxuICB0aW1lb3V0OiAxMDAwMCwgLy8gMTAgc2Vjb25kc1xufTtcblxuLyoqXG4gKiBWZXJpZnkgVHVybnN0aWxlIHRva2VuIHdpdGggQ2xvdWRmbGFyZVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdmVyaWZ5VHVybnN0aWxlVG9rZW4oXG4gIHRva2VuOiBzdHJpbmcsXG4gIGNvbmZpZzogUGFydGlhbDxUdXJuc3RpbGVDb25maWc+ID0ge31cbik6IFByb21pc2U8VHVybnN0aWxlVmVyaWZpY2F0aW9uUmVzdWx0PiB7XG4gIGNvbnN0IGZpbmFsQ29uZmlnID0gT2JqZWN0LmFzc2lnbih7fSwgREVGQVVMVF9UVVJOU1RJTEVfQ09ORklHLCBjb25maWcpO1xuXG4gIC8vIFNraXAgdmVyaWZpY2F0aW9uIGlmIGRpc2FibGVkXG4gIGlmICghZmluYWxDb25maWcuZW5hYmxlZCkge1xuICAgIGRldkxvZygnVHVybnN0aWxlIHZlcmlmaWNhdGlvbiBza2lwcGVkIChkaXNhYmxlZCknKTtcbiAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG4gIH1cblxuICAvLyBWYWxpZGF0ZSByZXF1aXJlZCBjb25maWd1cmF0aW9uXG4gIGlmICghZmluYWxDb25maWcuc2VjcmV0S2V5KSB7XG4gICAgZGV2TG9nKCdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIGZhaWxlZDogTWlzc2luZyBzZWNyZXQga2V5Jyk7XG4gICAgcmV0dXJuIHsgXG4gICAgICBzdWNjZXNzOiBmYWxzZSwgXG4gICAgICBlcnJvcjogJ1R1cm5zdGlsZSBjb25maWd1cmF0aW9uIG1pc3NpbmcnIFxuICAgIH07XG4gIH1cblxuICBpZiAoIXRva2VuKSB7XG4gICAgZGV2TG9nKCdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIGZhaWxlZDogTWlzc2luZyB0b2tlbicpO1xuICAgIHJldHVybiB7IFxuICAgICAgc3VjY2VzczogZmFsc2UsIFxuICAgICAgZXJyb3I6ICdUdXJuc3RpbGUgdG9rZW4gcmVxdWlyZWQnIFxuICAgIH07XG4gIH1cblxuICB0cnkge1xuICAgIC8vIFByZXBhcmUgZm9ybSBkYXRhIGZvciBDbG91ZGZsYXJlIEFQSVxuICAgIGNvbnN0IGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKCdzZWNyZXQnLCBmaW5hbENvbmZpZy5zZWNyZXRLZXkpO1xuICAgIGZvcm1EYXRhLmFwcGVuZCgncmVzcG9uc2UnLCB0b2tlbik7XG4gICAgZm9ybURhdGEuYXBwZW5kKCdyZW1vdGVpcCcsICd1bmtub3duJyk7IC8vIFdlIGRvbid0IGhhdmUgSVAgaW4gdGhpcyBjb250ZXh0XG5cbiAgICAvLyBNYWtlIHJlcXVlc3QgdG8gQ2xvdWRmbGFyZSBUdXJuc3RpbGUgQVBJXG4gICAgY29uc3QgY29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTtcbiAgICBjb25zdCB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KCgpID0+IGNvbnRyb2xsZXIuYWJvcnQoKSwgZmluYWxDb25maWcudGltZW91dCk7XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCdodHRwczovL2NoYWxsZW5nZXMuY2xvdWRmbGFyZS5jb20vdHVybnN0aWxlL3YwL3NpdGV2ZXJpZnknLCB7XG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGJvZHk6IGZvcm1EYXRhLFxuICAgICAgc2lnbmFsOiBjb250cm9sbGVyLnNpZ25hbCxcbiAgICB9KTtcblxuICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xuXG4gICAgaWYgKCFyZXNwb25zZS5vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUdXJuc3RpbGUgQVBJIGVycm9yOiAke3Jlc3BvbnNlLnN0YXR1c30gJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgIH1cblxuICAgIGNvbnN0IHJlc3VsdDogVHVybnN0aWxlUmVzcG9uc2UgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG5cbiAgICAvLyBMb2cgdmVyaWZpY2F0aW9uIGF0dGVtcHRcbiAgICBkZXZMb2coJ1R1cm5zdGlsZSB2ZXJpZmljYXRpb24gcmVzdWx0OicsIHtcbiAgICAgIHN1Y2Nlc3M6IHJlc3VsdC5zdWNjZXNzLFxuICAgICAgZXJyb3JDb2RlczogcmVzdWx0LmVycm9yX2NvZGVzLFxuICAgICAgaG9zdG5hbWU6IHJlc3VsdC5ob3N0bmFtZSxcbiAgICAgIGFjdGlvbjogcmVzdWx0LmFjdGlvbixcbiAgICB9KTtcblxuICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgIHJldHVybiB3aXRoT3B0aW9uYWwoXG4gICAgICAgIHsgc3VjY2VzczogZmFsc2UgfSxcbiAgICAgICAgeyBcbiAgICAgICAgICBlcnJvcjogJ1R1cm5zdGlsZSB2ZXJpZmljYXRpb24gZmFpbGVkJyxcbiAgICAgICAgICBlcnJvckNvZGVzOiByZXN1bHQuZXJyb3JfY29kZXNcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBBZGRpdGlvbmFsIHZhbGlkYXRpb24gaW4gc3RyaWN0IG1vZGVcbiAgICBpZiAoZmluYWxDb25maWcuc3RyaWN0TW9kZSkge1xuICAgICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IHZhbGlkYXRlVHVybnN0aWxlUmVzcG9uc2UocmVzdWx0LCBmaW5hbENvbmZpZyk7XG4gICAgICBpZiAoIXZhbGlkYXRpb25SZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gdmFsaWRhdGlvblJlc3VsdDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gd2l0aE9wdGlvbmFsKFxuICAgICAgeyBzdWNjZXNzOiB0cnVlIH0sXG4gICAgICB7IFxuICAgICAgICBob3N0bmFtZTogcmVzdWx0Lmhvc3RuYW1lLFxuICAgICAgICBhY3Rpb246IHJlc3VsdC5hY3Rpb24sXG4gICAgICAgIHRpbWVzdGFtcDogcmVzdWx0LmNoYWxsZW5nZV90c1xuICAgICAgfVxuICAgICk7XG5cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBkZXZMb2coJ1R1cm5zdGlsZSB2ZXJpZmljYXRpb24gZXJyb3I6JywgZXJyb3IpO1xuICAgIFxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIGVycm9yLm5hbWUgPT09ICdBYm9ydEVycm9yJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiAnVHVybnN0aWxlIHZlcmlmaWNhdGlvbiB0aW1lb3V0JyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgIH07XG4gIH1cbn1cblxuLyoqXG4gKiBWYWxpZGF0ZSBUdXJuc3RpbGUgcmVzcG9uc2UgaW4gc3RyaWN0IG1vZGVcbiAqL1xuZnVuY3Rpb24gdmFsaWRhdGVUdXJuc3RpbGVSZXNwb25zZShcbiAgcmVzcG9uc2U6IFR1cm5zdGlsZVJlc3BvbnNlLFxuICBjb25maWc6IFR1cm5zdGlsZUNvbmZpZ1xuKTogVHVybnN0aWxlVmVyaWZpY2F0aW9uUmVzdWx0IHtcbiAgLy8gVXNlIGNvbmZpZyBmb3IgdmFsaWRhdGlvbiBzZXR0aW5nc1xuICBpZiAoY29uZmlnLnN0cmljdE1vZGUpIHtcbiAgICAvLyBWYWxpZGF0ZSBob3N0bmFtZSBpZiBwcm92aWRlZFxuICAgIGlmIChyZXNwb25zZS5ob3N0bmFtZSkge1xuICAgICAgY29uc3QgYWxsb3dlZEhvc3RuYW1lcyA9IFtcbiAgICAgICAgJ2Nob2ljZXMtcGxhdGZvcm0udmVyY2VsLmFwcCcsXG4gICAgICAgICdjaG9pY2VzLmFwcCcsXG4gICAgICAgICd3d3cuY2hvaWNlcy5hcHAnLFxuICAgICAgXTtcblxuICAgICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WID09PSAnZGV2ZWxvcG1lbnQnKSB7XG4gICAgICAgIGFsbG93ZWRIb3N0bmFtZXMucHVzaCgnbG9jYWxob3N0JywgJzEyNy4wLjAuMScpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWFsbG93ZWRIb3N0bmFtZXMuaW5jbHVkZXMocmVzcG9uc2UuaG9zdG5hbWUpKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IGBJbnZhbGlkIGhvc3RuYW1lOiAke3Jlc3BvbnNlLmhvc3RuYW1lfWAsXG4gICAgICAgICAgaG9zdG5hbWU6IHJlc3BvbnNlLmhvc3RuYW1lLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIFZhbGlkYXRlIGFjdGlvbiBpZiBwcm92aWRlZFxuICBpZiAocmVzcG9uc2UuYWN0aW9uKSB7XG4gICAgY29uc3QgYWxsb3dlZEFjdGlvbnMgPSBbXG4gICAgICAnbG9naW4nLFxuICAgICAgJ3JlZ2lzdGVyJyxcbiAgICAgICd2b3RlJyxcbiAgICAgICdjcmVhdGVfcG9sbCcsXG4gICAgICAnY29udGFjdCcsXG4gICAgXTtcblxuICAgIGlmICghYWxsb3dlZEFjdGlvbnMuaW5jbHVkZXMocmVzcG9uc2UuYWN0aW9uKSkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGVycm9yOiBgSW52YWxpZCBhY3Rpb246ICR7cmVzcG9uc2UuYWN0aW9ufWAsXG4gICAgICAgIGFjdGlvbjogcmVzcG9uc2UuYWN0aW9uLFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4geyBzdWNjZXNzOiB0cnVlIH07XG59XG5cbi8qKlxuICogTWlkZGxld2FyZSBmdW5jdGlvbiB0byB2ZXJpZnkgVHVybnN0aWxlIHRva2VuIGluIEFQSSByb3V0ZXNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVUdXJuc3RpbGVWZXJpZmljYXRpb24oXG4gIHJlcXVlc3Q6IFJlcXVlc3QsXG4gIGV4cGVjdGVkQWN0aW9uPzogc3RyaW5nLFxuICBjb25maWc/OiBQYXJ0aWFsPFR1cm5zdGlsZUNvbmZpZz5cbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBmaW5hbENvbmZpZyA9IE9iamVjdC5hc3NpZ24oe30sIERFRkFVTFRfVFVSTlNUSUxFX0NPTkZJRywgY29uZmlnKTtcblxuICAvLyBTa2lwIGlmIGRpc2FibGVkXG4gIGlmICghZmluYWxDb25maWcuZW5hYmxlZCkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIC8vIEV4dHJhY3QgdG9rZW4gZnJvbSByZXF1ZXN0XG4gIGNvbnN0IHRva2VuID0gZXh0cmFjdFR1cm5zdGlsZVRva2VuKHJlcXVlc3QpO1xuICBpZiAoIXRva2VuKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdUdXJuc3RpbGUgdG9rZW4gcmVxdWlyZWQnKTtcbiAgfVxuXG4gIC8vIFZlcmlmeSB0b2tlblxuICBjb25zdCByZXN1bHQgPSBhd2FpdCB2ZXJpZnlUdXJuc3RpbGVUb2tlbih0b2tlbiwgZmluYWxDb25maWcpO1xuICBpZiAoIXJlc3VsdC5zdWNjZXNzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKHJlc3VsdC5lcnJvciB8fCAnVHVybnN0aWxlIHZlcmlmaWNhdGlvbiBmYWlsZWQnKTtcbiAgfVxuXG4gIC8vIFZhbGlkYXRlIGFjdGlvbiBpZiBzcGVjaWZpZWRcbiAgaWYgKGV4cGVjdGVkQWN0aW9uICYmIHJlc3VsdC5hY3Rpb24gJiYgcmVzdWx0LmFjdGlvbiAhPT0gZXhwZWN0ZWRBY3Rpb24pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgVHVybnN0aWxlIGFjdGlvbjogZXhwZWN0ZWQgJHtleHBlY3RlZEFjdGlvbn0sIGdvdCAke3Jlc3VsdC5hY3Rpb259YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBFeHRyYWN0IFR1cm5zdGlsZSB0b2tlbiBmcm9tIHJlcXVlc3RcbiAqL1xuZnVuY3Rpb24gZXh0cmFjdFR1cm5zdGlsZVRva2VuKHJlcXVlc3Q6IFJlcXVlc3QpOiBzdHJpbmcgfCBudWxsIHtcbiAgLy8gVHJ5IHRvIGdldCBmcm9tIHJlcXVlc3QgYm9keSBmaXJzdFxuICBpZiAocmVxdWVzdC5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyk/LmluY2x1ZGVzKCdhcHBsaWNhdGlvbi9qc29uJykpIHtcbiAgICAvLyBOb3RlOiBUaGlzIGlzIGEgc2ltcGxpZmllZCBhcHByb2FjaC4gSW4gcHJhY3RpY2UsIHlvdSdkIG5lZWQgdG8gcGFyc2UgdGhlIGJvZHlcbiAgICAvLyBGb3Igbm93LCB3ZSdsbCByZWx5IG9uIHRoZSBjbGllbnQgdG8gc2VuZCBpdCBpbiBoZWFkZXJzXG4gIH1cblxuICAvLyBUcnkgdG8gZ2V0IGZyb20gaGVhZGVyc1xuICBjb25zdCBoZWFkZXJUb2tlbiA9IHJlcXVlc3QuaGVhZGVycy5nZXQoJ3gtdHVybnN0aWxlLXRva2VuJyk7XG4gIGlmIChoZWFkZXJUb2tlbikge1xuICAgIHJldHVybiBoZWFkZXJUb2tlbjtcbiAgfVxuXG4gIC8vIFRyeSB0byBnZXQgZnJvbSBmb3JtIGRhdGEgKGZvciBmb3JtIHN1Ym1pc3Npb25zKVxuICBjb25zdCBmb3JtVG9rZW4gPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KCdjZi10dXJuc3RpbGUtcmVzcG9uc2UnKTtcbiAgaWYgKGZvcm1Ub2tlbikge1xuICAgIHJldHVybiBmb3JtVG9rZW47XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBUdXJuc3RpbGUgd2lkZ2V0IGNvbmZpZ3VyYXRpb24gZm9yIGNsaWVudC1zaWRlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRUdXJuc3RpbGVXaWRnZXRDb25maWcoYWN0aW9uPzogc3RyaW5nKToge1xuICBzaXRla2V5OiBzdHJpbmc7XG4gIGFjdGlvbj86IHN0cmluZztcbiAgdGhlbWU/OiAnbGlnaHQnIHwgJ2RhcmsnIHwgJ2F1dG8nO1xuICBzaXplPzogJ25vcm1hbCcgfCAnY29tcGFjdCc7XG4gIHRhYmluZGV4PzogbnVtYmVyO1xufSB7XG4gIHJldHVybiB3aXRoT3B0aW9uYWwoXG4gICAge1xuICAgICAgc2l0ZWtleTogcHJvY2Vzcy5lbnYuTkVYVF9QVUJMSUNfVFVSTlNUSUxFX1NJVEVfS0VZIHx8ICcnLFxuICAgICAgdGhlbWU6ICdhdXRvJyBhcyBjb25zdCxcbiAgICAgIHNpemU6ICdub3JtYWwnIGFzIGNvbnN0LFxuICAgIH0sXG4gICAgeyBhY3Rpb24gfVxuICApO1xufVxuXG4vKipcbiAqIENoZWNrIGlmIFR1cm5zdGlsZSBpcyBlbmFibGVkIGFuZCBjb25maWd1cmVkXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpc1R1cm5zdGlsZUVuYWJsZWQoKTogYm9vbGVhbiB7XG4gIHJldHVybiBERUZBVUxUX1RVUk5TVElMRV9DT05GSUcuZW5hYmxlZCAmJiAhIURFRkFVTFRfVFVSTlNUSUxFX0NPTkZJRy5zZWNyZXRLZXk7XG59XG5cbi8qKlxuICogR2V0IFR1cm5zdGlsZSBzaXRlIGtleSBmb3IgY2xpZW50LXNpZGVcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFR1cm5zdGlsZVNpdGVLZXkoKTogc3RyaW5nIHtcbiAgcmV0dXJuIHByb2Nlc3MuZW52Lk5FWFRfUFVCTElDX1RVUk5TVElMRV9TSVRFX0tFWSB8fCAnJztcbn1cbiJdLCJuYW1lcyI6WyJnZXRUdXJuc3RpbGVTaXRlS2V5IiwiZ2V0VHVybnN0aWxlV2lkZ2V0Q29uZmlnIiwiaXNUdXJuc3RpbGVFbmFibGVkIiwicmVxdWlyZVR1cm5zdGlsZVZlcmlmaWNhdGlvbiIsInZlcmlmeVR1cm5zdGlsZVRva2VuIiwiREVGQVVMVF9UVVJOU1RJTEVfQ09ORklHIiwic2VjcmV0S2V5IiwicHJvY2VzcyIsImVudiIsIlRVUk5TVElMRV9TRUNSRVRfS0VZIiwic2l0ZUtleSIsIk5FWFRfUFVCTElDX1RVUk5TVElMRV9TSVRFX0tFWSIsImVuYWJsZWQiLCJOT0RFX0VOViIsInN0cmljdE1vZGUiLCJ0aW1lb3V0IiwidG9rZW4iLCJjb25maWciLCJmaW5hbENvbmZpZyIsIk9iamVjdCIsImFzc2lnbiIsImRldkxvZyIsInN1Y2Nlc3MiLCJlcnJvciIsImZvcm1EYXRhIiwiRm9ybURhdGEiLCJhcHBlbmQiLCJjb250cm9sbGVyIiwiQWJvcnRDb250cm9sbGVyIiwidGltZW91dElkIiwic2V0VGltZW91dCIsImFib3J0IiwicmVzcG9uc2UiLCJmZXRjaCIsIm1ldGhvZCIsImJvZHkiLCJzaWduYWwiLCJjbGVhclRpbWVvdXQiLCJvayIsIkVycm9yIiwic3RhdHVzIiwic3RhdHVzVGV4dCIsInJlc3VsdCIsImpzb24iLCJlcnJvckNvZGVzIiwiZXJyb3JfY29kZXMiLCJob3N0bmFtZSIsImFjdGlvbiIsIndpdGhPcHRpb25hbCIsInZhbGlkYXRpb25SZXN1bHQiLCJ2YWxpZGF0ZVR1cm5zdGlsZVJlc3BvbnNlIiwidGltZXN0YW1wIiwiY2hhbGxlbmdlX3RzIiwibmFtZSIsIm1lc3NhZ2UiLCJhbGxvd2VkSG9zdG5hbWVzIiwicHVzaCIsImluY2x1ZGVzIiwiYWxsb3dlZEFjdGlvbnMiLCJyZXF1ZXN0IiwiZXhwZWN0ZWRBY3Rpb24iLCJleHRyYWN0VHVybnN0aWxlVG9rZW4iLCJoZWFkZXJzIiwiZ2V0IiwiaGVhZGVyVG9rZW4iLCJmb3JtVG9rZW4iLCJzaXRla2V5IiwidGhlbWUiLCJzaXplIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Q0FL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