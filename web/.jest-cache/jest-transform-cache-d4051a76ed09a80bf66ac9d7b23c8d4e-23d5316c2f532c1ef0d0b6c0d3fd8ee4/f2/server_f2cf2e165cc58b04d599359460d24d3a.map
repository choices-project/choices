{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/utils/supabase/server.ts"],"sourcesContent":["import 'server-only';                  // build-time guard\nimport type { SupabaseClient } from '@supabase/supabase-js'\nimport { cookies } from 'next/headers'\n\n// Database schema types for type safety\nexport interface Database {\n  public: {\n    Tables: {\n      user_profiles: {\n        Row: {\n          id: string\n          user_id: string\n          username: string\n          email: string\n          trust_tier: 'T0' | 'T1' | 'T2' | 'T3'\n          created_at: string\n          updated_at: string\n          avatar_url?: string\n          bio?: string\n          is_active: boolean\n        }\n        Insert: {\n          id?: string\n          user_id: string\n          username: string\n          email: string\n          trust_tier?: 'T0' | 'T1' | 'T2' | 'T3'\n          created_at?: string\n          updated_at?: string\n          avatar_url?: string\n          bio?: string\n          is_active?: boolean\n        }\n        Update: {\n          id?: string\n          user_id?: string\n          username?: string\n          email?: string\n          trust_tier?: 'T0' | 'T1' | 'T2' | 'T3'\n          created_at?: string\n          updated_at?: string\n          avatar_url?: string\n          bio?: string\n          is_active?: boolean\n        }\n      }\n      polls: {\n        Row: {\n          id: string\n          title: string\n          description: string\n          options: string[]\n          voting_method: 'single' | 'approval' | 'ranked' | 'quadratic' | 'range'\n          created_by: string\n          created_at: string\n          updated_at: string\n          start_time: string\n          end_time: string\n          status: 'draft' | 'active' | 'closed' | 'archived'\n          privacy_level: 'public' | 'private' | 'high-privacy'\n          total_votes: number\n          category?: string\n          tags?: string[]\n        }\n        Insert: {\n          id?: string\n          title: string\n          description: string\n          options: string[]\n          voting_method: 'single' | 'approval' | 'ranked' | 'quadratic' | 'range'\n          created_by: string\n          created_at?: string\n          updated_at?: string\n          start_time: string\n          end_time: string\n          status?: 'draft' | 'active' | 'closed' | 'archived'\n          privacy_level?: 'public' | 'private' | 'high-privacy'\n          total_votes?: number\n          category?: string\n          tags?: string[]\n        }\n        Update: {\n          id?: string\n          title?: string\n          description?: string\n          options?: string[]\n          voting_method?: 'single' | 'approval' | 'ranked' | 'quadratic' | 'range'\n          created_by?: string\n          created_at?: string\n          updated_at?: string\n          start_time?: string\n          end_time?: string\n          status?: 'draft' | 'active' | 'closed' | 'archived'\n          privacy_level?: 'public' | 'private' | 'high-privacy'\n          total_votes?: number\n          category?: string\n          tags?: string[]\n        }\n      }\n      votes: {\n        Row: {\n          id: string\n          poll_id: string\n          user_id: string\n          choice: number\n          created_at: string\n          updated_at: string\n          verification_token?: string\n          is_verified: boolean\n          voting_method: 'single' | 'approval' | 'ranked' | 'quadratic' | 'range'\n          vote_data: Record<string, unknown> // JSON data for complex voting methods\n        }\n        Insert: {\n          id?: string\n          poll_id: string\n          user_id: string\n          choice: number\n          created_at?: string\n          updated_at?: string\n          verification_token?: string\n          is_verified?: boolean\n          voting_method: 'single' | 'approval' | 'ranked' | 'quadratic' | 'range'\n          vote_data?: Record<string, unknown>\n        }\n        Update: {\n          id?: string\n          poll_id?: string\n          user_id?: string\n          choice?: number\n          created_at?: string\n          updated_at?: string\n          verification_token?: string\n          is_verified?: boolean\n          voting_method?: 'single' | 'approval' | 'ranked' | 'quadratic' | 'range'\n          vote_data?: Record<string, unknown>\n        }\n      }\n      // Privacy-first tables\n      user_consent: {\n        Row: {\n          id: string\n          user_id: string\n          consent_type: 'analytics' | 'demographics' | 'behavioral' | 'contact' | 'research' | 'marketing'\n          granted: boolean\n          granted_at: string\n          revoked_at?: string\n          consent_version: number\n          purpose: string\n          data_types: string[]\n        }\n        Insert: {\n          id?: string\n          user_id: string\n          consent_type: 'analytics' | 'demographics' | 'behavioral' | 'contact' | 'research' | 'marketing'\n          granted: boolean\n          granted_at?: string\n          revoked_at?: string\n          consent_version?: number\n          purpose: string\n          data_types?: string[]\n        }\n        Update: {\n          id?: string\n          user_id?: string\n          consent_type?: 'analytics' | 'demographics' | 'behavioral' | 'contact' | 'research' | 'marketing'\n          granted?: boolean\n          granted_at?: string\n          revoked_at?: string\n          consent_version?: number\n          purpose?: string\n          data_types?: string[]\n        }\n      }\n      privacy_logs: {\n        Row: {\n          id: string\n          action: string\n          user_id_hash: string\n          created_at: string\n          metadata: Record<string, unknown>\n        }\n        Insert: {\n          id?: string\n          action: string\n          user_id_hash: string\n          created_at?: string\n          metadata?: Record<string, unknown>\n        }\n        Update: {\n          id?: string\n          action?: string\n          user_id_hash?: string\n          created_at?: string\n          metadata?: Record<string, unknown>\n        }\n      }\n      user_profiles_encrypted: {\n        Row: {\n          id: string\n          user_id: string\n          username?: string\n          public_bio?: string\n          created_at: string\n          updated_at: string\n          encrypted_demographics?: string\n          encrypted_preferences?: string\n          encrypted_contact_info?: string\n          encryption_version: number\n          key_derivation_salt?: string\n          key_hash?: string\n        }\n        Insert: {\n          id?: string\n          user_id: string\n          username?: string\n          public_bio?: string\n          created_at?: string\n          updated_at?: string\n          encrypted_demographics?: string\n          encrypted_preferences?: string\n          encrypted_contact_info?: string\n          encryption_version?: number\n          key_derivation_salt?: string\n          key_hash?: string\n        }\n        Update: {\n          id?: string\n          user_id?: string\n          username?: string\n          public_bio?: string\n          created_at?: string\n          updated_at?: string\n          encrypted_demographics?: string\n          encrypted_preferences?: string\n          encrypted_contact_info?: string\n          encryption_version?: number\n          key_derivation_salt?: string\n          key_hash?: string\n        }\n      }\n      private_user_data: {\n        Row: {\n          id: string\n          user_id: string\n          encrypted_personal_info?: string\n          encrypted_behavioral_data?: string\n          encrypted_analytics_data?: string\n          encryption_key_hash?: string\n          last_encrypted_at: string\n        }\n        Insert: {\n          id?: string\n          user_id: string\n          encrypted_personal_info?: string\n          encrypted_behavioral_data?: string\n          encrypted_analytics_data?: string\n          encryption_key_hash?: string\n          last_encrypted_at?: string\n        }\n        Update: {\n          id?: string\n          user_id?: string\n          encrypted_personal_info?: string\n          encrypted_behavioral_data?: string\n          encrypted_analytics_data?: string\n          encryption_key_hash?: string\n          last_encrypted_at?: string\n        }\n      }\n      analytics_contributions: {\n        Row: {\n          id: string\n          poll_id: string\n          user_id: string\n          age_bucket?: string\n          region_bucket?: string\n          education_bucket?: string\n          vote_choice?: number\n          participation_time?: string\n          consent_granted: boolean\n          created_at: string\n        }\n        Insert: {\n          id?: string\n          poll_id: string\n          user_id: string\n          age_bucket?: string\n          region_bucket?: string\n          education_bucket?: string\n          vote_choice?: number\n          participation_time?: string\n          consent_granted?: boolean\n          created_at?: string\n        }\n        Update: {\n          id?: string\n          poll_id?: string\n          user_id?: string\n          age_bucket?: string\n          region_bucket?: string\n          education_bucket?: string\n          vote_choice?: number\n          participation_time?: string\n          consent_granted?: boolean\n          created_at?: string\n        }\n      }\n      error_logs: {\n        Row: {\n          id: string\n          user_id?: string\n          error_type: string\n          error_message: string\n          stack_trace?: string\n          context?: Record<string, unknown>\n          created_at: string\n          severity: 'low' | 'medium' | 'high' | 'critical'\n        }\n        Insert: {\n          id?: string\n          user_id?: string\n          error_type: string\n          error_message: string\n          stack_trace?: string\n          context?: Record<string, unknown>\n          created_at?: string\n          severity?: 'low' | 'medium' | 'high' | 'critical'\n        }\n        Update: {\n          id?: string\n          user_id?: string\n          error_type?: string\n          error_message?: string\n          stack_trace?: string\n          context?: Record<string, unknown>\n          created_at?: string\n          severity?: 'low' | 'medium' | 'high' | 'critical'\n        }\n      }\n    }\n    Views: {\n      demographic_analytics: {\n        Row: {\n          poll_id: string\n          age_bucket: string\n          region_bucket: string\n          education_bucket: string\n          participant_count: number\n          average_choice: number\n          choice_variance: number\n          first_contribution: string\n          last_contribution: string\n        }\n      }\n    }\n    Functions: {\n      anonymize_user_data: {\n        Args: {\n          target_user_id: string\n        }\n        Returns: void\n      }\n      export_user_data: {\n        Args: {\n          target_user_id: string\n        }\n        Returns: Record<string, unknown>\n      }\n      contribute_to_analytics: {\n        Args: {\n          target_poll_id: string\n          target_age_bucket: string\n          target_region_bucket: string\n          target_education_bucket: string\n          target_vote_choice: number\n          target_participation_time: string\n        }\n        Returns: boolean\n      }\n    }\n    Enums: {\n      [_ in never]: never\n    }\n  }\n}\n\n// Environment validation\nconst validateEnvironment = () => {\n  const requiredVars = {\n    NEXT_PUBLIC_SUPABASE_URL: process.env.NEXT_PUBLIC_SUPABASE_URL,\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\n    SUPABASE_SECRET_KEY: process.env.SUPABASE_SECRET_KEY\n  }\n\n  const missing = Object.entries(requiredVars)\n    .filter(([_, value]) => !value)\n    .map(([key]) => key)\n\n  if (missing.length > 0) {\n    throw new Error(`Missing required environment variables: ${missing.join(', ')}`)\n  }\n\n  return requiredVars\n}\n\n/**\n * SSR-safe factory. No top-level import of supabase-js or ssr.\n * We dynamically import only at call time in Node.\n */\nexport async function getSupabaseServerClient(): Promise<SupabaseClient<Database>> {\n  const env = validateEnvironment()\n  \n  let cookieStore\n  try {\n    cookieStore = cookies()\n  } catch {\n    // During build time, cookies() might not be available\n    // Throw an error to prevent build-time usage\n    throw new Error('getSupabaseServerClient() cannot be called during build time. Use it only in API routes and server components.')\n  }\n  \n  const { createServerClient } = await import('@supabase/ssr') // dynamic!\n  \n  return createServerClient<Database>(\n    env.NEXT_PUBLIC_SUPABASE_URL!,\n    env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n    {\n      cookies: {\n        get: (name: string) => cookieStore.get(name)?.value,\n        set: (name: string, value: string, options: Record<string, unknown>) => {\n          try {\n            cookieStore.set(name, value, options)\n          } catch {\n            // Ignore errors in RSC context\n          }\n        },\n        remove: (name: string, _options: Record<string, unknown>) => {\n          try {\n            cookieStore.delete(name)\n          } catch {\n            // Ignore errors in RSC context\n          }\n        },\n      },\n    },\n  )\n}\n\n/**\n * Service role client for admin operations\n * Uses the service role key for operations that require elevated permissions\n */\nexport async function getSupabaseServiceRoleClient(): Promise<SupabaseClient<Database>> {\n  const env = validateEnvironment()\n  \n  const { createClient } = await import('@supabase/supabase-js') // dynamic!\n  \n  return createClient<Database>(\n    env.NEXT_PUBLIC_SUPABASE_URL!,\n    env.SUPABASE_SECRET_KEY!,\n    {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false\n      }\n    }\n  )\n}\n\n// Export types for use in other modules\nexport type DatabaseTypes = Database\nexport type UserProfile = Database['public']['Tables']['user_profiles']['Row']\nexport type Poll = Database['public']['Tables']['polls']['Row']\nexport type Vote = Database['public']['Tables']['votes']['Row']\nexport type UserConsent = Database['public']['Tables']['user_consent']['Row']\nexport type PrivacyLog = Database['public']['Tables']['privacy_logs']['Row']\nexport type UserProfileEncrypted = Database['public']['Tables']['user_profiles_encrypted']['Row']\nexport type PrivateUserData = Database['public']['Tables']['private_user_data']['Row']\nexport type AnalyticsContribution = Database['public']['Tables']['analytics_contributions']['Row']\nexport type DemographicAnalytics = Database['public']['Views']['demographic_analytics']['Row']\n"],"names":["getSupabaseServerClient","getSupabaseServiceRoleClient","validateEnvironment","requiredVars","NEXT_PUBLIC_SUPABASE_URL","process","env","NEXT_PUBLIC_SUPABASE_ANON_KEY","SUPABASE_SECRET_KEY","missing","Object","entries","filter","_","value","map","key","length","Error","join","cookieStore","cookies","createServerClient","get","name","set","options","remove","_options","delete","createClient","auth","autoRefreshToken","persistSession"],"mappings":";;;;;;;;;;;IAyZsBA,uBAAuB;eAAvBA;;IA2CAC,4BAA4B;eAA5BA;;;QApcf;yBAEiB;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgYxB,yBAAyB;AACzB,MAAMC,sBAAsB;IAC1B,MAAMC,eAAe;QACnBC,0BAA0BC,QAAQC,GAAG,CAACF,wBAAwB;QAC9DG,+BAA+BF,QAAQC,GAAG,CAACC,6BAA6B;QACxEC,qBAAqBH,QAAQC,GAAG,CAACE,mBAAmB;IACtD;IAEA,MAAMC,UAAUC,OAAOC,OAAO,CAACR,cAC5BS,MAAM,CAAC,CAAC,CAACC,GAAGC,MAAM,GAAK,CAACA,OACxBC,GAAG,CAAC,CAAC,CAACC,IAAI,GAAKA;IAElB,IAAIP,QAAQQ,MAAM,GAAG,GAAG;QACtB,MAAM,IAAIC,MAAM,CAAC,wCAAwC,EAAET,QAAQU,IAAI,CAAC,MAAM,CAAC;IACjF;IAEA,OAAOhB;AACT;AAMO,eAAeH;IACpB,MAAMM,MAAMJ;IAEZ,IAAIkB;IACJ,IAAI;QACFA,cAAcC,IAAAA,gBAAO;IACvB,EAAE,OAAM;QACN,sDAAsD;QACtD,6CAA6C;QAC7C,MAAM,IAAIH,MAAM;IAClB;IAEA,MAAM,EAAEI,kBAAkB,EAAE,GAAG,MAAM,mEAAA,QAAO,mBAAiB,WAAW;;IAExE,OAAOA,mBACLhB,IAAIF,wBAAwB,EAC5BE,IAAIC,6BAA6B,EACjC;QACEc,SAAS;YACPE,KAAK,CAACC,OAAiBJ,YAAYG,GAAG,CAACC,OAAOV;YAC9CW,KAAK,CAACD,MAAcV,OAAeY;gBACjC,IAAI;oBACFN,YAAYK,GAAG,CAACD,MAAMV,OAAOY;gBAC/B,EAAE,OAAM;gBACN,+BAA+B;gBACjC;YACF;YACAC,QAAQ,CAACH,MAAcI;gBACrB,IAAI;oBACFR,YAAYS,MAAM,CAACL;gBACrB,EAAE,OAAM;gBACN,+BAA+B;gBACjC;YACF;QACF;IACF;AAEJ;AAMO,eAAevB;IACpB,MAAMK,MAAMJ;IAEZ,MAAM,EAAE4B,YAAY,EAAE,GAAG,MAAM,mEAAA,QAAO,2BAAyB,WAAW;;IAE1E,OAAOA,aACLxB,IAAIF,wBAAwB,EAC5BE,IAAIE,mBAAmB,EACvB;QACEuB,MAAM;YACJC,kBAAkB;YAClBC,gBAAgB;QAClB;IACF;AAEJ"}