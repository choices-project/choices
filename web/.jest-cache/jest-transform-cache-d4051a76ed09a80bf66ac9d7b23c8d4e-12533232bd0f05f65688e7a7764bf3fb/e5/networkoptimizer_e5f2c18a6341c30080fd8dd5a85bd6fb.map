{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/utils/network-optimizer.ts"],"sourcesContent":["/**\n * Network Optimization Utilities\n * \n * Provides utilities for optimizing network requests, caching,\n * and reducing API calls for better performance.\n * \n * Created: January 27, 2025\n * Status: âœ… ACTIVE\n */\n\nexport interface CacheConfig {\n  ttl: number; // Time to live in milliseconds\n  maxSize: number; // Maximum cache size\n  strategy: 'memory' | 'localStorage' | 'sessionStorage';\n}\n\nexport interface RequestConfig {\n  url: string;\n  method: 'GET' | 'POST' | 'PUT' | 'DELETE';\n  headers?: Record<string, string>;\n  body?: any;\n  cache?: CacheConfig;\n  retries?: number;\n  timeout?: number;\n}\n\nexport interface NetworkMetrics {\n  totalRequests: number;\n  cachedRequests: number;\n  failedRequests: number;\n  averageResponseTime: number;\n  totalDataTransferred: number;\n}\n\n/**\n * Network Optimizer Class\n */\nexport class NetworkOptimizer {\n  private cache = new Map<string, { data: any; timestamp: number; ttl: number }>();\n  private requestQueue = new Map<string, Promise<any>>();\n  private metrics: NetworkMetrics = {\n    totalRequests: 0,\n    cachedRequests: 0,\n    failedRequests: 0,\n    averageResponseTime: 0,\n    totalDataTransferred: 0,\n  };\n\n  constructor(private defaultConfig: Partial<RequestConfig> = {}) {}\n\n  /**\n   * Make an optimized network request\n   */\n  async request<T>(config: RequestConfig): Promise<T> {\n    const startTime = Date.now();\n    const cacheKey = this.generateCacheKey(config);\n\n    // Check cache first\n    if (config.method === 'GET' && config.cache) {\n      const cached = this.getFromCache(cacheKey);\n      if (cached) {\n        this.metrics.cachedRequests++;\n        return cached;\n      }\n    }\n\n    // Check if request is already in progress\n    if (this.requestQueue.has(cacheKey)) {\n      return this.requestQueue.get(cacheKey)!;\n    }\n\n    // Make the request\n    const requestPromise = this.makeRequest<T>(config, startTime);\n    this.requestQueue.set(cacheKey, requestPromise);\n\n    try {\n      const result = await requestPromise;\n      \n      // Cache the result if configured\n      if (config.method === 'GET' && config.cache && result) {\n        this.setCache(cacheKey, result, config.cache);\n      }\n\n      return result;\n    } finally {\n      this.requestQueue.delete(cacheKey);\n    }\n  }\n\n  /**\n   * Make the actual network request\n   */\n  private async makeRequest<T>(config: RequestConfig, startTime: number): Promise<T> {\n    const { url, method, headers = {}, body, retries = 3, timeout = 10000 } = config;\n\n    for (let attempt = 0; attempt <= retries; attempt++) {\n      try {\n        const controller = new AbortController();\n        const timeoutId = setTimeout(() => controller.abort(), timeout);\n\n        const response = await fetch(url, {\n          method,\n          headers: {\n            'Content-Type': 'application/json',\n            ...headers,\n          },\n          body: body ? JSON.stringify(body) : undefined,\n          signal: controller.signal,\n        });\n\n        clearTimeout(timeoutId);\n\n        if (!response.ok) {\n          throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        }\n\n        const data = await response.json();\n        const responseTime = Date.now() - startTime;\n\n        // Update metrics\n        this.metrics.totalRequests++;\n        this.metrics.averageResponseTime = \n          (this.metrics.averageResponseTime * (this.metrics.totalRequests - 1) + responseTime) / \n          this.metrics.totalRequests;\n        this.metrics.totalDataTransferred += JSON.stringify(data).length;\n\n        return data;\n      } catch (error) {\n        if (attempt === retries) {\n          this.metrics.failedRequests++;\n          throw error;\n        }\n        \n        // Exponential backoff\n        await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));\n      }\n    }\n\n    throw new Error('Max retries exceeded');\n  }\n\n  /**\n   * Generate cache key for request\n   */\n  private generateCacheKey(config: RequestConfig): string {\n    return `${config.method}:${config.url}:${JSON.stringify(config.body || {})}`;\n  }\n\n  /**\n   * Get data from cache\n   */\n  private getFromCache(key: string): any {\n    const cached = this.cache.get(key);\n    if (!cached) return null;\n\n    const now = Date.now();\n    if (now - cached.timestamp > cached.ttl) {\n      this.cache.delete(key);\n      return null;\n    }\n\n    return cached.data;\n  }\n\n  /**\n   * Set data in cache\n   */\n  private setCache(key: string, data: any, config: CacheConfig): void {\n    // Check cache size limit\n    if (this.cache.size >= config.maxSize) {\n      // Remove oldest entry\n      const oldestKey = this.cache.keys().next().value;\n      this.cache.delete(oldestKey!);\n    }\n\n    this.cache.set(key, {\n      data,\n      timestamp: Date.now(),\n      ttl: config.ttl,\n    });\n  }\n\n  /**\n   * Batch multiple requests\n   */\n  async batch<T>(requests: RequestConfig[]): Promise<T[]> {\n    const promises = requests.map(config => this.request<T>(config));\n    return Promise.all(promises);\n  }\n\n  /**\n   * Debounce requests to prevent excessive API calls\n   */\n  debounce<T>(\n    key: string,\n    config: RequestConfig,\n    delay = 300\n  ): Promise<T> {\n    return new Promise((resolve, reject) => {\n      const timeoutId = setTimeout(async () => {\n        try {\n          const result = await this.request<T>(config);\n          resolve(result);\n        } catch (error) {\n          reject(error);\n        }\n      }, delay);\n\n      // Store timeout ID for potential cancellation\n      (config as any).timeoutId = timeoutId;\n    });\n  }\n\n  /**\n   * Clear cache\n   */\n  clearCache(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * Get network metrics\n   */\n  getMetrics(): NetworkMetrics {\n    return { ...this.metrics };\n  }\n\n  /**\n   * Reset metrics\n   */\n  resetMetrics(): void {\n    this.metrics = {\n      totalRequests: 0,\n      cachedRequests: 0,\n      failedRequests: 0,\n      averageResponseTime: 0,\n      totalDataTransferred: 0,\n    };\n  }\n}\n\n/**\n * Global network optimizer instance\n */\nexport const networkOptimizer = new NetworkOptimizer({\n  cache: {\n    ttl: 5 * 60 * 1000, // 5 minutes\n    maxSize: 100,\n    strategy: 'memory',\n  },\n  retries: 2,\n  timeout: 10000,\n});\n\n/**\n * Optimized API client for common operations\n */\nexport class OptimizedAPIClient {\n  constructor(private baseURL: string, private optimizer: NetworkOptimizer = networkOptimizer) {}\n\n  /**\n   * Get data with caching\n   */\n  async get<T>(endpoint: string, options: Partial<RequestConfig> = {}): Promise<T> {\n    return this.optimizer.request<T>({\n      url: `${this.baseURL}${endpoint}`,\n      method: 'GET',\n      cache: {\n        ttl: 5 * 60 * 1000, // 5 minutes\n        maxSize: 100,\n        strategy: 'memory',\n      },\n      ...options,\n    });\n  }\n\n  /**\n   * Post data without caching\n   */\n  async post<T>(endpoint: string, data: any, options: Partial<RequestConfig> = {}): Promise<T> {\n    return this.optimizer.request<T>({\n      url: `${this.baseURL}${endpoint}`,\n      method: 'POST',\n      body: data,\n      ...options,\n    });\n  }\n\n  /**\n   * Batch get requests\n   */\n  async batchGet<T>(endpoints: string[], options: Partial<RequestConfig> = {}): Promise<T[]> {\n    const requests = endpoints.map(endpoint => ({\n      url: `${this.baseURL}${endpoint}`,\n      method: 'GET' as const,\n      cache: {\n        ttl: 5 * 60 * 1000,\n        maxSize: 100,\n        strategy: 'memory' as const,\n      },\n      ...options,\n    }));\n\n    return this.optimizer.batch<T>(requests);\n  }\n}\n\n/**\n * Hook for using network optimization in React components\n */\nexport function useNetworkOptimization() {\n  const [metrics, setMetrics] = React.useState<NetworkMetrics>(networkOptimizer.getMetrics());\n  const [isLoading, setIsLoading] = React.useState(false);\n\n  const makeRequest = React.useCallback(async <T>(config: RequestConfig): Promise<T> => {\n    setIsLoading(true);\n    try {\n      const result = await networkOptimizer.request<T>(config);\n      setMetrics(networkOptimizer.getMetrics());\n      return result;\n    } finally {\n      setIsLoading(false);\n    }\n  }, []);\n\n  const clearCache = React.useCallback(() => {\n    networkOptimizer.clearCache();\n    setMetrics(networkOptimizer.getMetrics());\n  }, []);\n\n  const resetMetrics = React.useCallback(() => {\n    networkOptimizer.resetMetrics();\n    setMetrics(networkOptimizer.getMetrics());\n  }, []);\n\n  return {\n    metrics,\n    isLoading,\n    makeRequest,\n    clearCache,\n    resetMetrics,\n  };\n}\n\n// Import React for the hook\nimport React from 'react';\n\n"],"names":["NetworkOptimizer","OptimizedAPIClient","networkOptimizer","useNetworkOptimization","defaultConfig","cache","Map","requestQueue","metrics","totalRequests","cachedRequests","failedRequests","averageResponseTime","totalDataTransferred","request","config","startTime","Date","now","cacheKey","generateCacheKey","method","cached","getFromCache","has","get","requestPromise","makeRequest","set","result","setCache","delete","url","headers","body","retries","timeout","attempt","controller","AbortController","timeoutId","setTimeout","abort","response","fetch","JSON","stringify","undefined","signal","clearTimeout","ok","Error","status","statusText","data","json","responseTime","length","error","Promise","resolve","Math","pow","key","timestamp","ttl","size","maxSize","oldestKey","keys","next","value","batch","requests","promises","map","all","debounce","delay","reject","clearCache","clear","getMetrics","resetMetrics","strategy","baseURL","optimizer","endpoint","options","post","batchGet","endpoints","setMetrics","React","useState","isLoading","setIsLoading","useCallback"],"mappings":"AAAA;;;;;;;;CAQC;;;;;;;;;;;QA6BYA;eAAAA;;QA4NAC;eAAAA;;QAbAC;eAAAA;;QAkEGC;eAAAA;;;8DAmCE;;;;;;AApTX,MAAMH;IAWX,YAAY,AAAQI,gBAAwC,CAAC,CAAC,CAAE;aAA5CA,gBAAAA;aAVZC,QAAQ,IAAIC;aACZC,eAAe,IAAID;aACnBE,UAA0B;YAChCC,eAAe;YACfC,gBAAgB;YAChBC,gBAAgB;YAChBC,qBAAqB;YACrBC,sBAAsB;QACxB;IAEiE;IAEjE;;GAEC,GACD,MAAMC,QAAWC,MAAqB,EAAc;QAClD,MAAMC,YAAYC,KAAKC,GAAG;QAC1B,MAAMC,WAAW,IAAI,CAACC,gBAAgB,CAACL;QAEvC,oBAAoB;QACpB,IAAIA,OAAOM,MAAM,KAAK,SAASN,OAAOV,KAAK,EAAE;YAC3C,MAAMiB,SAAS,IAAI,CAACC,YAAY,CAACJ;YACjC,IAAIG,QAAQ;gBACV,IAAI,CAACd,OAAO,CAACE,cAAc;gBAC3B,OAAOY;YACT;QACF;QAEA,0CAA0C;QAC1C,IAAI,IAAI,CAACf,YAAY,CAACiB,GAAG,CAACL,WAAW;YACnC,OAAO,IAAI,CAACZ,YAAY,CAACkB,GAAG,CAACN;QAC/B;QAEA,mBAAmB;QACnB,MAAMO,iBAAiB,IAAI,CAACC,WAAW,CAAIZ,QAAQC;QACnD,IAAI,CAACT,YAAY,CAACqB,GAAG,CAACT,UAAUO;QAEhC,IAAI;YACF,MAAMG,SAAS,MAAMH;YAErB,iCAAiC;YACjC,IAAIX,OAAOM,MAAM,KAAK,SAASN,OAAOV,KAAK,IAAIwB,QAAQ;gBACrD,IAAI,CAACC,QAAQ,CAACX,UAAUU,QAAQd,OAAOV,KAAK;YAC9C;YAEA,OAAOwB;QACT,SAAU;YACR,IAAI,CAACtB,YAAY,CAACwB,MAAM,CAACZ;QAC3B;IACF;IAEA;;GAEC,GACD,MAAcQ,YAAeZ,MAAqB,EAAEC,SAAiB,EAAc;QACjF,MAAM,EAAEgB,GAAG,EAAEX,MAAM,EAAEY,UAAU,CAAC,CAAC,EAAEC,IAAI,EAAEC,UAAU,CAAC,EAAEC,UAAU,KAAK,EAAE,GAAGrB;QAE1E,IAAK,IAAIsB,UAAU,GAAGA,WAAWF,SAASE,UAAW;YACnD,IAAI;gBACF,MAAMC,aAAa,IAAIC;gBACvB,MAAMC,YAAYC,WAAW,IAAMH,WAAWI,KAAK,IAAIN;gBAEvD,MAAMO,WAAW,MAAMC,MAAMZ,KAAK;oBAChCX;oBACAY,SAAS;wBACP,gBAAgB;wBAChB,GAAGA,OAAO;oBACZ;oBACAC,MAAMA,OAAOW,KAAKC,SAAS,CAACZ,QAAQa;oBACpCC,QAAQV,WAAWU,MAAM;gBAC3B;gBAEAC,aAAaT;gBAEb,IAAI,CAACG,SAASO,EAAE,EAAE;oBAChB,MAAM,IAAIC,MAAM,CAAC,KAAK,EAAER,SAASS,MAAM,CAAC,EAAE,EAAET,SAASU,UAAU,EAAE;gBACnE;gBAEA,MAAMC,OAAO,MAAMX,SAASY,IAAI;gBAChC,MAAMC,eAAevC,KAAKC,GAAG,KAAKF;gBAElC,iBAAiB;gBACjB,IAAI,CAACR,OAAO,CAACC,aAAa;gBAC1B,IAAI,CAACD,OAAO,CAACI,mBAAmB,GAC9B,AAAC,CAAA,IAAI,CAACJ,OAAO,CAACI,mBAAmB,GAAI,CAAA,IAAI,CAACJ,OAAO,CAACC,aAAa,GAAG,CAAA,IAAK+C,YAAW,IAClF,IAAI,CAAChD,OAAO,CAACC,aAAa;gBAC5B,IAAI,CAACD,OAAO,CAACK,oBAAoB,IAAIgC,KAAKC,SAAS,CAACQ,MAAMG,MAAM;gBAEhE,OAAOH;YACT,EAAE,OAAOI,OAAO;gBACd,IAAIrB,YAAYF,SAAS;oBACvB,IAAI,CAAC3B,OAAO,CAACG,cAAc;oBAC3B,MAAM+C;gBACR;gBAEA,sBAAsB;gBACtB,MAAM,IAAIC,QAAQC,CAAAA,UAAWnB,WAAWmB,SAASC,KAAKC,GAAG,CAAC,GAAGzB,WAAW;YAC1E;QACF;QAEA,MAAM,IAAIc,MAAM;IAClB;IAEA;;GAEC,GACD,AAAQ/B,iBAAiBL,MAAqB,EAAU;QACtD,OAAO,GAAGA,OAAOM,MAAM,CAAC,CAAC,EAAEN,OAAOiB,GAAG,CAAC,CAAC,EAAEa,KAAKC,SAAS,CAAC/B,OAAOmB,IAAI,IAAI,CAAC,IAAI;IAC9E;IAEA;;GAEC,GACD,AAAQX,aAAawC,GAAW,EAAO;QACrC,MAAMzC,SAAS,IAAI,CAACjB,KAAK,CAACoB,GAAG,CAACsC;QAC9B,IAAI,CAACzC,QAAQ,OAAO;QAEpB,MAAMJ,MAAMD,KAAKC,GAAG;QACpB,IAAIA,MAAMI,OAAO0C,SAAS,GAAG1C,OAAO2C,GAAG,EAAE;YACvC,IAAI,CAAC5D,KAAK,CAAC0B,MAAM,CAACgC;YAClB,OAAO;QACT;QAEA,OAAOzC,OAAOgC,IAAI;IACpB;IAEA;;GAEC,GACD,AAAQxB,SAASiC,GAAW,EAAET,IAAS,EAAEvC,MAAmB,EAAQ;QAClE,yBAAyB;QACzB,IAAI,IAAI,CAACV,KAAK,CAAC6D,IAAI,IAAInD,OAAOoD,OAAO,EAAE;YACrC,sBAAsB;YACtB,MAAMC,YAAY,IAAI,CAAC/D,KAAK,CAACgE,IAAI,GAAGC,IAAI,GAAGC,KAAK;YAChD,IAAI,CAAClE,KAAK,CAAC0B,MAAM,CAACqC;QACpB;QAEA,IAAI,CAAC/D,KAAK,CAACuB,GAAG,CAACmC,KAAK;YAClBT;YACAU,WAAW/C,KAAKC,GAAG;YACnB+C,KAAKlD,OAAOkD,GAAG;QACjB;IACF;IAEA;;GAEC,GACD,MAAMO,MAASC,QAAyB,EAAgB;QACtD,MAAMC,WAAWD,SAASE,GAAG,CAAC5D,CAAAA,SAAU,IAAI,CAACD,OAAO,CAAIC;QACxD,OAAO4C,QAAQiB,GAAG,CAACF;IACrB;IAEA;;GAEC,GACDG,SACEd,GAAW,EACXhD,MAAqB,EACrB+D,QAAQ,GAAG,EACC;QACZ,OAAO,IAAInB,QAAQ,CAACC,SAASmB;YAC3B,MAAMvC,YAAYC,WAAW;gBAC3B,IAAI;oBACF,MAAMZ,SAAS,MAAM,IAAI,CAACf,OAAO,CAAIC;oBACrC6C,QAAQ/B;gBACV,EAAE,OAAO6B,OAAO;oBACdqB,OAAOrB;gBACT;YACF,GAAGoB;YAEH,8CAA8C;YAC7C/D,OAAeyB,SAAS,GAAGA;QAC9B;IACF;IAEA;;GAEC,GACDwC,aAAmB;QACjB,IAAI,CAAC3E,KAAK,CAAC4E,KAAK;IAClB;IAEA;;GAEC,GACDC,aAA6B;QAC3B,OAAO;YAAE,GAAG,IAAI,CAAC1E,OAAO;QAAC;IAC3B;IAEA;;GAEC,GACD2E,eAAqB;QACnB,IAAI,CAAC3E,OAAO,GAAG;YACbC,eAAe;YACfC,gBAAgB;YAChBC,gBAAgB;YAChBC,qBAAqB;YACrBC,sBAAsB;QACxB;IACF;AACF;AAKO,MAAMX,mBAAmB,IAAIF,iBAAiB;IACnDK,OAAO;QACL4D,KAAK,IAAI,KAAK;QACdE,SAAS;QACTiB,UAAU;IACZ;IACAjD,SAAS;IACTC,SAAS;AACX;AAKO,MAAMnC;IACX,YAAY,AAAQoF,OAAe,EAAE,AAAQC,YAA8BpF,gBAAgB,CAAE;aAAzEmF,UAAAA;aAAyBC,YAAAA;IAAiD;IAE9F;;GAEC,GACD,MAAM7D,IAAO8D,QAAgB,EAAEC,UAAkC,CAAC,CAAC,EAAc;QAC/E,OAAO,IAAI,CAACF,SAAS,CAACxE,OAAO,CAAI;YAC/BkB,KAAK,GAAG,IAAI,CAACqD,OAAO,GAAGE,UAAU;YACjClE,QAAQ;YACRhB,OAAO;gBACL4D,KAAK,IAAI,KAAK;gBACdE,SAAS;gBACTiB,UAAU;YACZ;YACA,GAAGI,OAAO;QACZ;IACF;IAEA;;GAEC,GACD,MAAMC,KAAQF,QAAgB,EAAEjC,IAAS,EAAEkC,UAAkC,CAAC,CAAC,EAAc;QAC3F,OAAO,IAAI,CAACF,SAAS,CAACxE,OAAO,CAAI;YAC/BkB,KAAK,GAAG,IAAI,CAACqD,OAAO,GAAGE,UAAU;YACjClE,QAAQ;YACRa,MAAMoB;YACN,GAAGkC,OAAO;QACZ;IACF;IAEA;;GAEC,GACD,MAAME,SAAYC,SAAmB,EAAEH,UAAkC,CAAC,CAAC,EAAgB;QACzF,MAAMf,WAAWkB,UAAUhB,GAAG,CAACY,CAAAA,WAAa,CAAA;gBAC1CvD,KAAK,GAAG,IAAI,CAACqD,OAAO,GAAGE,UAAU;gBACjClE,QAAQ;gBACRhB,OAAO;oBACL4D,KAAK,IAAI,KAAK;oBACdE,SAAS;oBACTiB,UAAU;gBACZ;gBACA,GAAGI,OAAO;YACZ,CAAA;QAEA,OAAO,IAAI,CAACF,SAAS,CAACd,KAAK,CAAIC;IACjC;AACF;AAKO,SAAStE;IACd,MAAM,CAACK,SAASoF,WAAW,GAAGC,cAAK,CAACC,QAAQ,CAAiB5F,iBAAiBgF,UAAU;IACxF,MAAM,CAACa,WAAWC,aAAa,GAAGH,cAAK,CAACC,QAAQ,CAAC;IAEjD,MAAMnE,cAAckE,cAAK,CAACI,WAAW,CAAC,OAAUlF;QAC9CiF,aAAa;QACb,IAAI;YACF,MAAMnE,SAAS,MAAM3B,iBAAiBY,OAAO,CAAIC;YACjD6E,WAAW1F,iBAAiBgF,UAAU;YACtC,OAAOrD;QACT,SAAU;YACRmE,aAAa;QACf;IACF,GAAG,EAAE;IAEL,MAAMhB,aAAaa,cAAK,CAACI,WAAW,CAAC;QACnC/F,iBAAiB8E,UAAU;QAC3BY,WAAW1F,iBAAiBgF,UAAU;IACxC,GAAG,EAAE;IAEL,MAAMC,eAAeU,cAAK,CAACI,WAAW,CAAC;QACrC/F,iBAAiBiF,YAAY;QAC7BS,WAAW1F,iBAAiBgF,UAAU;IACxC,GAAG,EAAE;IAEL,OAAO;QACL1E;QACAuF;QACApE;QACAqD;QACAG;IACF;AACF"}