{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/strategies/ranked.ts"],"sourcesContent":["/**\n * Ranked Choice Voting Strategy\n * \n * Implements ranked choice voting where voters rank options in order of preference.\n * Uses instant runoff voting (IRV) to determine the winner.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '../../logger';\n\nimport type { \n  VotingStrategy, \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  PollData, \n  VoteData, \n  ResultsData,\n  VotingMethod,\n  PollResults\n} from '../types';\n\nexport class RankedStrategy implements VotingStrategy {\n  \n  getVotingMethod(): VotingMethod {\n    return 'ranked';\n  }\n\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const voteData = request.voteData;\n\n      // Validate rankings array exists\n      if (!voteData.rankings || !Array.isArray(voteData.rankings)) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Rankings must be an array',\n          errors: ['Rankings must be an array'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      // Validate rankings array is not empty\n      if (voteData.rankings.length === 0) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'At least one ranking is required',\n          errors: ['At least one ranking is required'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      // Validate all rankings are valid integers\n      for (const ranking of voteData.rankings) {\n        if (typeof ranking !== 'number' || !Number.isInteger(ranking)) {\n          return {\n            valid: false,\n            isValid: false,\n            error: 'Rankings must be integers',\n            errors: ['Rankings must be integers'],\n            requiresAuthentication: false,\n            requiresTokens: false\n          };\n        }\n\n        if (ranking < 0 || ranking >= poll.options.length) {\n          return {\n            valid: false,\n            isValid: false,\n            error: 'Invalid option selected',\n            errors: ['Invalid option selected'],\n            requiresAuthentication: false,\n            requiresTokens: false\n          };\n        }\n      }\n\n      // Check for duplicate rankings\n      const uniqueRankings = new Set(voteData.rankings);\n      if (uniqueRankings.size !== voteData.rankings.length) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Duplicate rankings are not allowed',\n          errors: ['Duplicate rankings are not allowed'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      // Check maximum rankings limit\n      const maxRankings = poll.votingConfig?.maxChoices || poll.options.length;\n      if (voteData.rankings.length > maxRankings) {\n        return {\n          valid: false,\n          isValid: false,\n          error: `Maximum ${maxRankings} rankings allowed`,\n          errors: [`Maximum ${maxRankings} rankings allowed`],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      devLog('Ranked vote validated successfully', {\n        pollId: request.pollId,\n        rankings: voteData.rankings,\n        userId: request.userId\n      });\n\n      return {\n        valid: true,\n        isValid: true,\n        requiresAuthentication: false,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Ranked vote validation error:', { error: error instanceof Error ? error.message : String(error) });\n      return {\n        valid: false,\n        isValid: false,\n        error: 'Ranked vote validation failed',\n        errors: ['Ranked vote validation failed'],\n        requiresAuthentication: false,\n        requiresTokens: false\n      };\n    }\n  }\n\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const voteData = request.voteData;\n      \n      // Create vote data for storage\n      const voteRecord: VoteData = {\n        id: `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        pollId: request.pollId,\n        userId: request.userId,\n        rankings: voteData.rankings,\n        privacyLevel: 'standard',\n        auditReceipt: `audit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        timestamp: new Date(),\n        ipAddress: request.ipAddress,\n        userAgent: request.userAgent\n      };\n\n      devLog('Ranked vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        rankings: voteData.rankings,\n        voteId: voteRecord.id\n      });\n\n      return {\n        success: true,\n        voteId: voteRecord.id,\n        message: 'Vote recorded successfully',\n        pollId: request.pollId\n      };\n\n    } catch (error) {\n      devLog('Ranked vote processing error:', { error: error instanceof Error ? error.message : String(error) });\n      return {\n        success: false,\n        error: 'Failed to process ranked vote',\n        message: 'Failed to process ranked vote',\n        pollId: request.pollId\n      };\n    }\n  }\n\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const startTime = Date.now();\n      \n      // Import IRV calculator for proper ranked choice implementation\n      const { IRVCalculator } = await import('../irv-calculator');\n      \n      // Convert poll options to candidates format\n      const candidates = poll.options.map(option => ({\n        id: option.id,\n        name: option.text,\n        description: option.description || ''\n      }));\n\n      // Convert votes to user rankings format\n      const userRankings = votes\n        .filter(vote => vote.voteData?.rankings && vote.voteData.rankings.length > 0 && vote.userId)\n        .map(vote => ({\n          pollId: poll.id,\n          userId: vote.userId!,\n          ranking: vote.voteData?.rankings?.map(index => {\n            const option = poll.options[index];\n            return option?.id;\n          }).filter((id): id is string => Boolean(id)) ?? [],\n          createdAt: new Date(vote.timestamp)\n        }));\n\n      // Create IRV calculator and calculate results\n      const calculator = new IRVCalculator(poll.id, candidates);\n      const irvResults = calculator.calculateResults(userRankings);\n\n      // Convert IRV results to our format\n      const optionVotes: Record<string, number> = {};\n      const optionPercentages: Record<string, number> = {};\n\n      // Initialize all options with zero scores\n      poll.options.forEach(option => {\n        optionVotes[option.id] = 0;\n        optionPercentages[option.id] = 0;\n      });\n\n      // Count votes from first round\n      if (irvResults.rounds.length > 0) {\n        const firstRound = irvResults.rounds[0];\n        if (firstRound) {\n          Object.entries(firstRound.votes).forEach(([optionId, votes]) => {\n            optionVotes[optionId] = Number(votes);\n          });\n        }\n      }\n\n      const totalVotes = irvResults.totalVotes || 0;\n\n      // Calculate percentages\n      if (totalVotes > 0) {\n        Object.keys(optionVotes).forEach(optionId => {\n          const votes = optionVotes[optionId] || 0;\n          optionPercentages[optionId] = (votes / totalVotes) * 100;\n        });\n      }\n\n      // Get winner from IRV results\n      const winner = irvResults.winner;\n      const winnerVotes = winner ? optionVotes[winner] || 0 : 0;\n      const winnerPercentage = winner ? optionPercentages[winner] || 0 : 0;\n\n      const results: PollResults = {\n        winner: winner || undefined,\n        winnerVotes,\n        winnerPercentage,\n        optionVotes,\n        optionPercentages,\n        abstentions: 0,\n        abstentionPercentage: 0\n      };\n\n      devLog('Ranked results calculated with IRV', {\n        pollId: poll.id,\n        totalVotes,\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        rounds: irvResults.rounds.length,\n        calculationTime: Date.now() - startTime\n      });\n\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes,\n        participationRate: totalVotes / 100, // Mock participation rate\n        results,\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          method: 'ranked',\n          rounds: irvResults.rounds.length,\n          eliminated: irvResults.rounds\n            .filter((round: any) => round.eliminated)\n            .map((round: any) => round.eliminated)\n        }\n      };\n\n    } catch (error) {\n      devLog('Ranked results calculation error:', { error: error instanceof Error ? error.message : String(error) });\n      \n      // Return empty results on error\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: 0,\n        participationRate: 0,\n        results: {\n          winner: undefined,\n          winnerVotes: 0,\n          winnerPercentage: 0,\n          optionVotes: {},\n          optionPercentages: {},\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: 0,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      };\n    }\n  }\n\n  getConfiguration(): Record<string, unknown> {\n    return {\n      method: 'ranked',\n      description: 'Voters rank options in order of preference',\n      allowsMultipleSelections: true,\n      requiresRanking: true,\n      maxSelections: 'configurable',\n      algorithm: 'instant runoff voting'\n    };\n  }\n}"],"names":["RankedStrategy","getVotingMethod","validateVote","request","poll","Promise","resolve","voteData","rankings","Array","isArray","valid","isValid","error","errors","requiresAuthentication","requiresTokens","length","ranking","Number","isInteger","options","uniqueRankings","Set","size","maxRankings","votingConfig","maxChoices","devLog","pollId","userId","Error","message","String","processVote","voteRecord","id","Date","now","Math","random","toString","substr","privacyLevel","auditReceipt","timestamp","ipAddress","userAgent","voteId","success","calculateResults","votes","startTime","IRVCalculator","candidates","map","option","name","text","description","userRankings","filter","vote","index","Boolean","createdAt","calculator","irvResults","optionVotes","optionPercentages","forEach","rounds","firstRound","Object","entries","optionId","totalVotes","keys","winner","winnerVotes","winnerPercentage","results","undefined","abstentions","abstentionPercentage","calculationTime","votingMethod","participationRate","calculatedAt","toISOString","metadata","method","eliminated","round","getConfiguration","allowsMultipleSelections","requiresRanking","maxSelections","algorithm"],"mappings":"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"}