{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/app/api/contact/threads/route.ts"],"sourcesContent":["/**\n * Contact Threads API Endpoint\n * \n * Handles CRUD operations for message threads between users and representatives.\n * Provides thread management, filtering, and real-time updates.\n * \n * Created: January 23, 2025\n * Status: âœ… IMPLEMENTATION READY\n */\n\nimport { type NextRequest, NextResponse } from 'next/server';\nimport { getSupabaseServerClient } from '@/lib/supabase/server';\nimport { logger } from '@/lib/utils/logger';\n\nexport const dynamic = 'force-dynamic';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface CreateThreadRequest {\n  representativeId: string;\n  subject: string;\n  priority?: 'low' | 'normal' | 'high' | 'urgent';\n  initialMessage?: string;\n}\n\ninterface ThreadResponse {\n  id: string;\n  userId: string;\n  representativeId: string;\n  subject: string;\n  status: string;\n  priority: string;\n  createdAt: string;\n  updatedAt: string;\n  lastMessageAt: string;\n  messageCount: number;\n  representative: {\n    id: string;\n    name: string;\n    office: string;\n    party: string;\n  };\n}\n\n// ============================================================================\n// GET - Retrieve User Threads\n// ============================================================================\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Get Supabase client\n    const supabase = await getSupabaseServerClient();\n    if (!supabase) {\n      return NextResponse.json(\n        { success: false, error: 'Database connection not available' },\n        { status: 500 }\n      );\n    }\n\n    // Authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    if (authError || !user) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    // Parse query parameters\n    const { searchParams } = new URL(request.url);\n    const status = searchParams.get('status');\n    const priority = searchParams.get('priority');\n    const representativeId = searchParams.get('representativeId');\n    const limit = parseInt(searchParams.get('limit') || '20');\n    const offset = parseInt(searchParams.get('offset') || '0');\n    const sortBy = searchParams.get('sortBy') || 'last_message_at';\n    const sortOrder = searchParams.get('sortOrder') || 'desc';\n\n    // Build query - contact_threads is just a mapping table\n    let query = supabase\n      .from('contact_threads')\n      .select(`\n        id,\n        message_id,\n        thread_id,\n        created_at\n      `)\n      .order('created_at', { ascending: false })\n      .range(offset, offset + limit - 1);\n\n    // Note: contact_threads is just a mapping table, so filtering is limited\n\n    const { data: threads, error: threadsError } = await query;\n\n    if (threadsError) {\n      logger.error('Failed to fetch threads', new Error(threadsError?.message || 'Unknown error'), { error: threadsError });\n      return NextResponse.json(\n        { success: false, error: 'Failed to fetch threads' },\n        { status: 500 }\n      );\n    }\n\n    // Get total count for pagination - contact_threads is just a mapping table\n    const { count: totalCount } = await supabase\n      .from('contact_threads')\n      .select('*', { count: 'exact', head: true });\n\n    // Transform response data - contact_threads is just a mapping table\n    const transformedThreads = (threads || []).map(thread => ({\n      id: thread.id,\n      messageId: thread.message_id,\n      threadId: thread.thread_id,\n      createdAt: thread.created_at\n    }));\n\n    return NextResponse.json({\n      success: true,\n      threads: transformedThreads,\n      pagination: {\n        total: totalCount || 0,\n        limit,\n        offset,\n        hasMore: (totalCount || 0) > offset + limit\n      }\n    });\n\n  } catch (error) {\n    const err = error instanceof Error ? error : new Error(String(error));\n    logger.error('Error fetching threads:', err);\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// ============================================================================\n// POST - Create New Thread\n// ============================================================================\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Get Supabase client\n    const supabase = await getSupabaseServerClient();\n    if (!supabase) {\n      return NextResponse.json(\n        { success: false, error: 'Database connection not available' },\n        { status: 500 }\n      );\n    }\n\n    // Authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    if (authError || !user) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    // Parse request body\n    const body: CreateThreadRequest = await request.json();\n    const {\n      representativeId,\n      subject,\n      priority = 'normal',\n      initialMessage\n    } = body;\n\n    // Validate required fields\n    if (!representativeId || !subject) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Representative ID and subject are required' \n        },\n        { status: 400 }\n      );\n    }\n\n    // Validate subject length\n    if (subject.length > 255) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Subject is too long (max 255 characters)' \n        },\n        { status: 400 }\n      );\n    }\n\n    // Check if representative exists (representativeId is database primary key)\n    const { data: representative, error: repError } = await supabase\n      .from('representatives_core')\n      .select('id, name, office, party')\n      .eq('id', parseInt(representativeId))\n      .single();\n\n    if (repError || !representative) {\n      logger.warn('Invalid representative ID', { representativeId, error: repError });\n      return NextResponse.json(\n        { success: false, error: 'Representative not found' },\n        { status: 404 }\n      );\n    }\n\n    // Check for existing active thread with same representative\n    const { data: existingThread } = await supabase\n      .from('contact_threads')\n      .select('id, status')\n      .eq('user_id', user.id)\n      .eq('representative_id', parseInt(representativeId))\n      .eq('status', 'active')\n      .single();\n\n    if (existingThread) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Active thread already exists with this representative',\n          existingThreadId: existingThread.id\n        },\n        { status: 409 }\n      );\n    }\n\n    // Create new thread\n    const { data: thread, error: threadError } = await supabase\n      .from('contact_threads')\n      .insert({\n        user_id: user.id,\n        representative_id: parseInt(representativeId),\n        subject,\n        priority,\n        status: 'active'\n      })\n      .select(`\n        id,\n        user_id,\n        representative_id,\n        subject,\n        status,\n        priority,\n        created_at,\n        updated_at,\n        last_message_at,\n        message_count\n      `)\n      .single();\n\n    if (threadError || !thread) {\n      logger.error('Failed to create thread', new Error(threadError?.message || 'Unknown error'), { error: threadError });\n      return NextResponse.json(\n        { success: false, error: 'Failed to create thread' },\n        { status: 500 }\n      );\n    }\n\n    // Create initial message if provided\n    if (initialMessage?.trim()) {\n      const { error: messageError } = await supabase\n        .from('contact_messages')\n        .insert({\n          thread_id: thread.id,\n          sender_id: user.id,\n          recipient_id: parseInt(representativeId),\n          content: initialMessage.trim(),\n          subject,\n          priority,\n          message_type: 'text',\n          status: 'sent'\n        });\n\n      if (messageError) {\n        logger.error('Failed to create initial message', new Error(messageError?.message || 'Unknown error'), { error: messageError });\n        // Don't fail thread creation if initial message fails\n      }\n    }\n\n    logger.info('Thread created successfully', {\n      threadId: thread.id,\n      userId: user.id,\n      representativeId,\n      subject\n    });\n\n    return NextResponse.json({\n      success: true,\n      thread: {\n        id: thread.id,\n        userId: thread.user_id,\n        representativeId: thread.representative_id,\n        subject: thread.subject,\n        status: thread.status,\n        priority: thread.priority,\n        createdAt: thread.created_at,\n        updatedAt: thread.updated_at,\n        lastMessageAt: thread.last_message_at,\n        messageCount: thread.message_count,\n        representative: {\n          id: representative.id,\n          name: representative.name,\n          office: representative.office,\n          party: representative.party\n        }\n      }\n    });\n\n  } catch (error) {\n    const err = error instanceof Error ? error : new Error(String(error));\n    logger.error('Error creating thread:', err);\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// ============================================================================\n// PUT - Update Thread Status\n// ============================================================================\n\nexport async function PUT(request: NextRequest) {\n  try {\n    // Get Supabase client\n    const supabase = await getSupabaseServerClient();\n    if (!supabase) {\n      return NextResponse.json(\n        { success: false, error: 'Database connection not available' },\n        { status: 500 }\n      );\n    }\n\n    // Authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    if (authError || !user) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    // Parse request body\n    const body = await request.json();\n    const { threadId, status, priority } = body;\n\n    if (!threadId) {\n      return NextResponse.json(\n        { success: false, error: 'Thread ID is required' },\n        { status: 400 }\n      );\n    }\n\n    // Verify thread ownership\n    const { data: thread, error: threadError } = await supabase\n      .from('contact_threads')\n      .select('id, user_id, status')\n      .eq('id', threadId)\n      .eq('user_id', user.id)\n      .single();\n\n    if (threadError || !thread) {\n      return NextResponse.json(\n        { success: false, error: 'Thread not found or access denied' },\n        { status: 404 }\n      );\n    }\n\n    // Build update object\n    const updateData: any = {};\n    if (status) updateData.status = status;\n    if (priority) updateData.priority = priority;\n\n    if (Object.keys(updateData).length === 0) {\n      return NextResponse.json(\n        { success: false, error: 'No valid updates provided' },\n        { status: 400 }\n      );\n    }\n\n    // Update thread\n    const { data: updatedThread, error: updateError } = await supabase\n      .from('contact_threads')\n      .update(updateData)\n      .eq('id', threadId)\n      .select(`\n        id,\n        user_id,\n        representative_id,\n        subject,\n        status,\n        priority,\n        updated_at\n      `)\n      .single();\n\n    if (updateError || !updatedThread) {\n      logger.error('Failed to update thread', new Error(updateError?.message || 'Unknown error'), { error: updateError });\n      return NextResponse.json(\n        { success: false, error: 'Failed to update thread' },\n        { status: 500 }\n      );\n    }\n\n    logger.info('Thread updated successfully', {\n      threadId,\n      userId: user.id,\n      updates: updateData\n    });\n\n    return NextResponse.json({\n      success: true,\n      thread: updatedThread\n    });\n\n  } catch (error) {\n    const err = error instanceof Error ? error : new Error(String(error));\n    logger.error('Error updating thread:', err);\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":["GET","POST","PUT","dynamic","request","supabase","getSupabaseServerClient","NextResponse","json","success","error","status","data","user","authError","auth","getUser","searchParams","URL","url","get","priority","representativeId","limit","parseInt","offset","sortBy","sortOrder","query","from","select","order","ascending","range","threads","threadsError","logger","Error","message","count","totalCount","head","transformedThreads","map","thread","id","messageId","message_id","threadId","thread_id","createdAt","created_at","pagination","total","hasMore","err","String","body","subject","initialMessage","length","representative","repError","eq","single","warn","existingThread","existingThreadId","threadError","insert","user_id","representative_id","trim","messageError","sender_id","recipient_id","content","message_type","info","userId","updatedAt","updated_at","lastMessageAt","last_message_at","messageCount","message_count","name","office","party","updateData","Object","keys","updatedThread","updateError","update","updates"],"mappings":"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"}