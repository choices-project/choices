{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/strategies/single-choice.ts"],"sourcesContent":["/**\n * Single Choice Voting Strategy\n * \n * Implements single choice voting where voters select exactly one option.\n * Results show vote counts for each option, with the highest voted option winning.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '../../logger';\n\nimport type { \n  VotingStrategy, \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  PollData, \n  VoteData, \n  ResultsData,\n  VotingMethod,\n  PollResults\n} from '../types';\n\nexport class SingleChoiceStrategy implements VotingStrategy {\n  \n  getVotingMethod(): VotingMethod {\n    return 'single';\n  }\n\n  validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    try {\n      const voteData = request.voteData;\n\n      // Validate choice exists and is a number\n      if (typeof voteData.choice !== 'number') {\n        return Promise.resolve({\n          valid: false,\n          isValid: false,\n          error: 'Choice is required for single-choice voting',\n          errors: ['Choice is required for single-choice voting'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        });\n      }\n\n      // Validate choice is a valid integer\n      if (!Number.isInteger(voteData.choice)) {\n        return Promise.resolve({\n          valid: false,\n          isValid: false,\n          error: 'Choice must be an integer',\n          errors: ['Choice must be an integer'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        });\n      }\n\n      // Validate choice is within valid range\n      if (voteData.choice < 0 || voteData.choice >= poll.options.length) {\n        return Promise.resolve({\n          valid: false,\n          isValid: false,\n          error: `Choice must be between 0 and ${poll.options.length - 1}`,\n          errors: ['Invalid option selected'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        });\n      }\n\n      devLog('Single choice vote validated successfully', {\n        pollId: request.pollId,\n        choice: voteData.choice,\n        userId: request.userId\n      });\n\n      return Promise.resolve({\n        valid: true,\n        isValid: true,\n        requiresAuthentication: false,\n        requiresTokens: false\n      });\n\n    } catch (error) {\n      devLog('Single choice vote validation error:', { error: error instanceof Error ? error.message : String(error) });\n      return Promise.resolve({\n        valid: false,\n        isValid: false,\n        error: 'Single choice vote validation failed',\n        errors: ['Single choice vote validation failed'],\n        requiresAuthentication: false,\n        requiresTokens: false\n      });\n    }\n  }\n\n  processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    try {\n      const voteData = request.voteData;\n      \n      // Validate choice against poll options\n      if (typeof voteData.choice !== 'number' || voteData.choice < 0 || voteData.choice >= poll.options.length) {\n        return Promise.resolve({\n          success: false,\n          error: 'Invalid choice selection',\n          message: 'Selected choice is not valid for this poll',\n          pollId: request.pollId\n        });\n      }\n      \n      // Create vote data for storage\n      const voteRecord: VoteData = {\n        id: `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        pollId: request.pollId,\n        userId: request.userId,\n        choice: voteData.choice,\n        privacyLevel: 'standard',\n        auditReceipt: `audit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        timestamp: new Date(),\n        ipAddress: request.ipAddress,\n        userAgent: request.userAgent\n      };\n\n      devLog('Single choice vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        choice: voteData.choice,\n        voteId: voteRecord.id\n      });\n\n      return Promise.resolve({\n        success: true,\n        voteId: voteRecord.id,\n        message: 'Vote recorded successfully',\n        pollId: request.pollId\n      });\n\n    } catch (error) {\n      devLog('Single choice vote processing error:', { error: error instanceof Error ? error.message : String(error) });\n      return Promise.resolve({\n        success: false,\n        error: 'Failed to process single choice vote',\n        message: 'Failed to process single choice vote',\n        pollId: request.pollId\n      });\n    }\n  }\n\n  calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    try {\n      const startTime = Date.now();\n      \n      // Initialize tracking objects\n      const optionVotes: Record<string, number> = {};\n      const optionPercentages: Record<string, number> = {};\n\n      // Initialize all options with zero scores\n      poll.options.forEach(option => {\n        optionVotes[option.id] = 0;\n        optionPercentages[option.id] = 0;\n      });\n\n      // Process each vote and count only valid votes\n      let validVoteCount = 0;\n      votes.forEach(vote => {\n        // Handle both voteData.choice and direct choice property\n        const choice = vote.voteData?.choice ?? vote.choice;\n        if (typeof choice === 'number') {\n          const option = poll.options[choice];\n          if (option?.id) {\n            optionVotes[option.id] = (optionVotes[option.id] || 0) + 1;\n            validVoteCount++;\n          }\n        }\n      });\n\n      const totalVotes = validVoteCount || 0;\n\n      // Calculate percentages\n      if (totalVotes > 0) {\n        Object.keys(optionVotes).forEach(optionId => {\n          const votes = optionVotes[optionId] || 0;\n          optionPercentages[optionId] = (votes / totalVotes) * 100;\n        });\n      }\n\n      // Find winner (highest vote count)\n      let winner: string | undefined;\n      let winnerVotes = 0;\n      let winnerPercentage = 0;\n\n      if (totalVotes > 0) {\n        Object.entries(optionVotes).forEach(([optionId, votes]) => {\n          if (votes > winnerVotes) {\n            winner = optionId;\n            winnerVotes = votes;\n            winnerPercentage = optionPercentages[optionId] || 0;\n          }\n        });\n      }\n\n      const results: PollResults = {\n        winner: totalVotes > 0 ? winner : undefined,\n        winnerVotes,\n        winnerPercentage,\n        optionVotes,\n        optionPercentages,\n        abstentions: 0,\n        abstentionPercentage: 0\n      };\n\n      devLog('Single choice results calculated', {\n        pollId: poll.id,\n        totalVotes,\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        calculationTime: Date.now() - startTime\n      });\n\n      return Promise.resolve({\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes,\n        participationRate: totalVotes / 100, // Mock participation rate\n        results,\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          method: 'single'\n        }\n      });\n\n    } catch (error) {\n      devLog('Single choice results calculation error:', { error: error instanceof Error ? error.message : String(error) });\n      \n      // Return empty results on error\n      return Promise.resolve({\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: 0,\n        participationRate: 0,\n        results: {\n          winner: undefined,\n          winnerVotes: 0,\n          winnerPercentage: 0,\n          optionVotes: {},\n          optionPercentages: {},\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: 0,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      });\n    }\n  }\n\n  getConfiguration(): Record<string, unknown> {\n    return {\n      method: 'single',\n      description: 'Voters select exactly one option',\n      allowsMultipleSelections: false,\n      requiresRanking: false,\n      maxSelections: 1,\n      algorithm: 'plurality'\n    };\n  }\n}"],"names":["SingleChoiceStrategy","getVotingMethod","validateVote","request","poll","voteData","choice","Promise","resolve","valid","isValid","error","errors","requiresAuthentication","requiresTokens","Number","isInteger","options","length","devLog","pollId","userId","Error","message","String","processVote","success","voteRecord","id","Date","now","Math","random","toString","substr","privacyLevel","auditReceipt","timestamp","ipAddress","userAgent","voteId","calculateResults","votes","startTime","optionVotes","optionPercentages","forEach","option","validVoteCount","vote","totalVotes","Object","keys","optionId","winner","winnerVotes","winnerPercentage","entries","results","undefined","abstentions","abstentionPercentage","calculationTime","votingMethod","participationRate","calculatedAt","toISOString","metadata","method","getConfiguration","description","allowsMultipleSelections","requiresRanking","maxSelections","algorithm"],"mappings":"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"}