{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/utils/civics-cache.ts"],"sourcesContent":["/**\n * Civics API Caching Utility\n * \n * Provides intelligent caching for civics endpoints to improve performance\n * and reduce database load. Implements multi-layer caching strategy.\n * Updated to use normalized tables instead of JSONB columns.\n * \n * @fileoverview Civics caching and query optimization with normalized data\n * @version 2.0.0\n * @since 2024-10-09\n * @updated 2025-10-25 - Updated to use normalized tables instead of JSONB\n * @feature CIVICS_CACHING\n * \n * Created: October 10, 2025\n * Status: âœ… ACTIVE\n */\n\n\n// Cache configuration\nconst CACHE_CONFIG = {\n  // Representative data cache (longer TTL for stable data)\n  representative: {\n    ttl: 15 * 60 * 1000, // 15 minutes\n    maxSize: 1000,\n    keyPrefix: 'civics:rep:'\n  },\n  \n  // Address lookup cache (medium TTL for electoral data)\n  address: {\n    ttl: 5 * 60 * 1000, // 5 minutes\n    maxSize: 500,\n    keyPrefix: 'civics:addr:'\n  },\n  \n  // State lookup cache (longer TTL for stable state data)\n  state: {\n    ttl: 30 * 60 * 1000, // 30 minutes\n    maxSize: 100,\n    keyPrefix: 'civics:state:'\n  }\n};\n\n// In-memory cache store\nconst cacheStore = new Map<string, { data: unknown; timestamp: number; ttl: number }>();\n\nexport class CivicsCache {\n  /**\n   * Generate cache key for representative data\n   */\n  static getRepresentativeKey(id: string): string {\n    return `${CACHE_CONFIG.representative.keyPrefix}${id}`;\n  }\n\n  /**\n   * Generate cache key for address lookup\n   */\n  static getAddressKey(address: string): string {\n    const normalizedAddress = address.toLowerCase().trim();\n    return `${CACHE_CONFIG.address.keyPrefix}${Buffer.from(normalizedAddress).toString('base64')}`;\n  }\n\n  /**\n   * Generate cache key for state lookup\n   */\n  static getStateKey(state: string, level?: string, chamber?: string): string {\n    const params = [state, level || 'all', chamber || 'all'].join(':');\n    return `${CACHE_CONFIG.state.keyPrefix}${params}`;\n  }\n\n  /**\n   * Get cached data if available and not expired\n   */\n  static get<T>(key: string): T | null {\n    const cached = cacheStore.get(key);\n    \n    if (!cached) {\n      return null;\n    }\n\n    // Check if cache is expired\n    const now = Date.now();\n    if (now - cached.timestamp > cached.ttl) {\n      cacheStore.delete(key);\n      return null;\n    }\n\n    return cached.data as T;\n  }\n\n  /**\n   * Set cached data with TTL\n   */\n  static set<T>(key: string, data: T, ttl: number): void {\n    // Implement LRU eviction if cache is full\n    if (cacheStore.size >= 1000) {\n      const firstKey = cacheStore.keys().next().value;\n      if (firstKey) {\n        cacheStore.delete(firstKey);\n      }\n    }\n\n    cacheStore.set(key, {\n      data,\n      timestamp: Date.now(),\n      ttl\n    });\n  }\n\n  /**\n   * Cache representative data\n   */\n  static cacheRepresentative(id: string, data: unknown): void {\n    const key = this.getRepresentativeKey(id);\n    this.set(key, data, CACHE_CONFIG.representative.ttl);\n  }\n\n  /**\n   * Get cached representative data\n   */\n  static getCachedRepresentative(id: string): unknown {\n    const key = this.getRepresentativeKey(id);\n    return this.get(key);\n  }\n\n  /**\n   * Cache address lookup data\n   */\n  static cacheAddressLookup(address: string, data: unknown): void {\n    const key = this.getAddressKey(address);\n    this.set(key, data, CACHE_CONFIG.address.ttl);\n  }\n\n  /**\n   * Get cached address lookup data\n   */\n  static getCachedAddressLookup(address: string): unknown {\n    const key = this.getAddressKey(address);\n    return this.get(key);\n  }\n\n  /**\n   * Cache state lookup data\n   */\n  static cacheStateLookup(state: string, level: string | undefined, chamber: string | undefined, data: unknown): void {\n    const key = this.getStateKey(state, level, chamber);\n    this.set(key, data, CACHE_CONFIG.state.ttl);\n  }\n\n  /**\n   * Get cached state lookup data\n   */\n  static getCachedStateLookup(state: string, level?: string, chamber?: string): unknown {\n    const key = this.getStateKey(state, level, chamber);\n    return this.get(key);\n  }\n\n  /**\n   * Clear cache for specific representative\n   */\n  static clearRepresentative(id: string): void {\n    const key = this.getRepresentativeKey(id);\n    cacheStore.delete(key);\n  }\n\n  /**\n   * Clear all cache\n   */\n  static clearAll(): void {\n    cacheStore.clear();\n  }\n\n  /**\n   * Get cache statistics\n   */\n  static getStats(): {\n    totalEntries: number;\n    representativeEntries: number;\n    addressEntries: number;\n    stateEntries: number;\n    memoryUsage: string;\n  } {\n    const totalEntries = cacheStore.size;\n    let representativeEntries = 0;\n    let addressEntries = 0;\n    let stateEntries = 0;\n\n    for (const key of cacheStore.keys()) {\n      if (key.startsWith(CACHE_CONFIG.representative.keyPrefix)) {\n        representativeEntries++;\n      } else if (key.startsWith(CACHE_CONFIG.address.keyPrefix)) {\n        addressEntries++;\n      } else if (key.startsWith(CACHE_CONFIG.state.keyPrefix)) {\n        stateEntries++;\n      }\n    }\n\n    return {\n      totalEntries,\n      representativeEntries,\n      addressEntries,\n      stateEntries,\n      memoryUsage: `${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB`\n    };\n  }\n}\n\n\n/**\n * Database query optimization utilities\n */\nexport class CivicsQueryOptimizer {\n  /**\n   * Optimized representative query with normalized table joins\n   */\n  static getRepresentativeQuery(supabase: any, id: string) {\n    return supabase\n      .from('representatives_core')\n      .select(`\n        id,\n        name,\n        party,\n        office,\n        level,\n        state,\n        district,\n        openstates_id,\n        bioguide_id,\n        fec_id,\n        google_civic_id,\n        legiscan_id,\n        congress_gov_id,\n        govinfo_id,\n        primary_email,\n        primary_phone,\n        primary_website,\n        primary_photo_url,\n        data_quality_score,\n        data_sources,\n        verification_status,\n        last_verified,\n        created_at,\n        last_updated,\n        representative_contacts(contact_type, value, is_verified, source),\n        representative_photos(url, is_primary, source),\n        representative_social_media(platform, handle, url, is_verified),\n        representative_activity(type, title, description, date, source)\n      `)\n      .eq('id', id)\n      .single();\n  }\n\n  /**\n   * Optimized state query with filtering\n   */\n  static getStateQuery(supabase: any, state: string, level?: string, chamber?: string, limit = 200) {\n    let query = supabase\n      .from('representatives_core')\n      .select(`\n        id,\n        name,\n        party,\n        office,\n        level,\n        state,\n        district,\n        bioguide_id,\n        openstates_id,\n        fec_id,\n        google_civic_id,\n        legiscan_id,\n        congress_gov_id,\n        govinfo_id,\n        wikipedia_url,\n        ballotpedia_url,\n        twitter_handle,\n        facebook_url,\n        instagram_handle,\n        linkedin_url,\n        youtube_channel,\n        primary_email,\n        primary_phone,\n        primary_website,\n        primary_photo_url,\n        data_quality_score,\n        data_sources,\n        last_verified,\n        verification_status,\n        created_at,\n        last_updated,\n        representative_contacts(contact_type, value, is_verified, source),\n        representative_photos(url, is_primary, source),\n        representative_social_media(platform, handle, url, is_verified),\n        representative_activity(type, title, description, date, source)\n      `)\n      .eq('state', state)\n      .limit(limit);\n\n    if (level) {\n      query = query.eq('level', level);\n    }\n\n    if (chamber) {\n      query = query.eq('office', chamber);\n    }\n\n    return query;\n  }\n\n  /**\n   * Optimized address query with electoral info\n   */\n  static getAddressQuery(supabase: any, state: string, districts: string[]) {\n    return supabase\n      .from('representatives_core')\n      .select(`\n        id,\n        name,\n        party,\n        office,\n        level,\n        state,\n        district,\n        bioguide_id,\n        openstates_id,\n        fec_id,\n        google_civic_id,\n        legiscan_id,\n        congress_gov_id,\n        govinfo_id,\n        wikipedia_url,\n        ballotpedia_url,\n        twitter_handle,\n        facebook_url,\n        instagram_handle,\n        linkedin_url,\n        youtube_channel,\n        primary_email,\n        primary_phone,\n        primary_website,\n        primary_photo_url,\n        data_quality_score,\n        data_sources,\n        last_verified,\n        verification_status,\n        created_at,\n        last_updated,\n        enhanced_contacts,\n        enhanced_photos,\n        enhanced_activity,\n        enhanced_social_media\n      `)\n      .eq('state', state)\n      .in('district', districts);\n  }\n}\n\n/**\n * Cache warming utilities\n */\nexport class CivicsCacheWarmer {\n  /**\n   * Warm cache for popular representatives\n   */\n  static async warmPopularRepresentatives(supabase: any): Promise<void> {\n    try {\n      // Get most accessed representatives from analytics\n      const { data: popularReps } = await supabase\n        .from('civics_representatives')\n        .select('id, name, level, state')\n        .order('data_quality_score', { ascending: false })\n        .limit(50);\n\n      if (popularReps) {\n        for (const rep of popularReps) {\n          // Pre-cache representative data\n          const { data: repData } = await CivicsQueryOptimizer.getRepresentativeQuery(supabase, rep.id);\n          if (repData) {\n            CivicsCache.cacheRepresentative(rep.id, repData);\n          }\n        }\n      }\n    } catch (error) {\n      console.error('Cache warming failed:', error);\n    }\n  }\n\n  /**\n   * Warm cache for state data\n   */\n  static async warmStateData(supabase: any): Promise<void> {\n    try {\n      const states = ['CA', 'TX', 'FL', 'NY', 'IL', 'PA', 'OH', 'GA', 'NC', 'MI'];\n      \n      for (const state of states) {\n        const { data: stateData } = await CivicsQueryOptimizer.getStateQuery(supabase, state);\n        if (stateData) {\n          CivicsCache.cacheStateLookup(state, undefined, undefined, stateData);\n        }\n      }\n    } catch (error) {\n      console.error('State cache warming failed:', error);\n    }\n  }\n}\n"],"names":["CivicsCache","CivicsCacheWarmer","CivicsQueryOptimizer","CACHE_CONFIG","representative","ttl","maxSize","keyPrefix","address","state","cacheStore","Map","getRepresentativeKey","id","getAddressKey","normalizedAddress","toLowerCase","trim","Buffer","from","toString","getStateKey","level","chamber","params","join","get","key","cached","now","Date","timestamp","delete","data","set","size","firstKey","keys","next","value","cacheRepresentative","getCachedRepresentative","cacheAddressLookup","getCachedAddressLookup","cacheStateLookup","getCachedStateLookup","clearRepresentative","clearAll","clear","getStats","totalEntries","representativeEntries","addressEntries","stateEntries","startsWith","memoryUsage","Math","round","process","heapUsed","getRepresentativeQuery","supabase","select","eq","single","getStateQuery","limit","query","getAddressQuery","districts","in","warmPopularRepresentatives","popularReps","order","ascending","rep","repData","error","console","warmStateData","states","stateData","undefined"],"mappings":"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"}