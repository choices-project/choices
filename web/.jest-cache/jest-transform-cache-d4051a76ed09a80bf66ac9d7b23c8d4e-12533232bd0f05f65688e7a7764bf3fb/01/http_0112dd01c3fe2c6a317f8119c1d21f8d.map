{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/utils/http.ts"],"sourcesContent":["/**\n * HTTP Security Helpers\n * \n * Provides origin validation and CSRF protection for state-changing routes.\n */\n\nexport function requireTrustedOrigin(req: Request) {\n  // Only enforce on state-changing verbs; allow preview/branch URLs\n  if (!['POST', 'PUT', 'PATCH', 'DELETE'].includes(req.method)) return;\n  \n  const originHeader = req.headers.get('origin');\n  const referer = req.headers.get('referer');\n  let origin = '';\n  \n  try {\n    origin = originHeader || (referer ? new URL(referer).origin : '');\n  } catch {\n    origin = '';\n  }\n\n  const envOrigin = process.env.APP_ORIGIN;\n  const allowed = [\n    envOrigin,\n    ...(process.env.NODE_ENV === 'development' ? ['http://localhost:3000'] : []),\n    ...(process.env.VERCEL ? ['https://*.vercel.app'] : []),\n  ].filter((v): v is string => typeof v === 'string' && v.length > 0);\n\n  const isAllowed = origin && allowed.some(p => {\n    if (p === origin) return true;\n    if (p.endsWith('*.vercel.app')) {\n      try {\n        const url = new URL(origin);\n        return url.hostname.endsWith('.vercel.app');\n      } catch {\n        return false;\n      }\n    }\n    return false;\n  });\n\n  if (!isAllowed) {\n    throw new Error('Untrusted origin');\n  }\n}\n\n// Helper for getting client IP\nexport function getClientIP(req: Request): string {\n  const forwarded = req.headers.get('x-forwarded-for');\n  const realIP = req.headers.get('x-real-ip');\n  \n  if (forwarded) {\n    const firstForwarded = forwarded.split(',')[0];\n    return firstForwarded?.trim() ?? '';\n  }\n  \n  if (realIP) {\n    return realIP;\n  }\n  \n  return 'unknown';\n}\n\n// Helper for getting user agent\nexport function getUserAgent(req: Request): string {\n  return req.headers.get('user-agent') || 'unknown';\n}\n"],"names":["getClientIP","getUserAgent","requireTrustedOrigin","req","includes","method","originHeader","headers","get","referer","origin","URL","envOrigin","process","env","APP_ORIGIN","allowed","NODE_ENV","VERCEL","filter","v","length","isAllowed","some","p","endsWith","url","hostname","Error","forwarded","realIP","firstForwarded","split","trim"],"mappings":"AAAA;;;;CAIC;;;;;;;;;;;QA0CeA;eAAAA;;QAiBAC;eAAAA;;QAzDAC;eAAAA;;;AAAT,SAASA,qBAAqBC,GAAY;IAC/C,kEAAkE;IAClE,IAAI,CAAC;QAAC;QAAQ;QAAO;QAAS;KAAS,CAACC,QAAQ,CAACD,IAAIE,MAAM,GAAG;IAE9D,MAAMC,eAAeH,IAAII,OAAO,CAACC,GAAG,CAAC;IACrC,MAAMC,UAAUN,IAAII,OAAO,CAACC,GAAG,CAAC;IAChC,IAAIE,SAAS;IAEb,IAAI;QACFA,SAASJ,gBAAiBG,CAAAA,UAAU,IAAIE,IAAIF,SAASC,MAAM,GAAG,EAAC;IACjE,EAAE,OAAM;QACNA,SAAS;IACX;IAEA,MAAME,YAAYC,QAAQC,GAAG,CAACC,UAAU;IACxC,MAAMC,UAAU;QACdJ;WACIC,QAAQC,GAAG,CAACG,QAAQ,KAAK,gBAAgB;YAAC;SAAwB,GAAG,EAAE;WACvEJ,QAAQC,GAAG,CAACI,MAAM,GAAG;YAAC;SAAuB,GAAG,EAAE;KACvD,CAACC,MAAM,CAAC,CAACC,IAAmB,OAAOA,MAAM,YAAYA,EAAEC,MAAM,GAAG;IAEjE,MAAMC,YAAYZ,UAAUM,QAAQO,IAAI,CAACC,CAAAA;QACvC,IAAIA,MAAMd,QAAQ,OAAO;QACzB,IAAIc,EAAEC,QAAQ,CAAC,iBAAiB;YAC9B,IAAI;gBACF,MAAMC,MAAM,IAAIf,IAAID;gBACpB,OAAOgB,IAAIC,QAAQ,CAACF,QAAQ,CAAC;YAC/B,EAAE,OAAM;gBACN,OAAO;YACT;QACF;QACA,OAAO;IACT;IAEA,IAAI,CAACH,WAAW;QACd,MAAM,IAAIM,MAAM;IAClB;AACF;AAGO,SAAS5B,YAAYG,GAAY;IACtC,MAAM0B,YAAY1B,IAAII,OAAO,CAACC,GAAG,CAAC;IAClC,MAAMsB,SAAS3B,IAAII,OAAO,CAACC,GAAG,CAAC;IAE/B,IAAIqB,WAAW;QACb,MAAME,iBAAiBF,UAAUG,KAAK,CAAC,IAAI,CAAC,EAAE;QAC9C,OAAOD,gBAAgBE,UAAU;IACnC;IAEA,IAAIH,QAAQ;QACV,OAAOA;IACT;IAEA,OAAO;AACT;AAGO,SAAS7B,aAAaE,GAAY;IACvC,OAAOA,IAAII,OAAO,CAACC,GAAG,CAAC,iBAAiB;AAC1C"}