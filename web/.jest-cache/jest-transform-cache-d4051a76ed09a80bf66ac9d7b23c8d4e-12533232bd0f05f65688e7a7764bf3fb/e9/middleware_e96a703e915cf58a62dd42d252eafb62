d3e5e3d5eebfcf2a0e385925b2ca18cd
/**
 * Core Authentication Middleware
 * 
 * Enhanced authentication middleware with security features:
 * - Origin validation
 * - Rate limiting integration
 * - Turnstile verification
 * - Comprehensive error handling
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get combineMiddleware () {
        return combineMiddleware;
    },
    get createApiMiddleware () {
        return createApiMiddleware;
    },
    get createAuthMiddleware () {
        return createAuthMiddleware;
    },
    get createRateLimitMiddleware () {
        return createRateLimitMiddleware;
    },
    get createSecurityHeadersMiddleware () {
        return createSecurityHeadersMiddleware;
    },
    get getUser () {
        return getUser;
    },
    get requireUser () {
        return requireUser;
    },
    get withAuth () {
        return withAuth;
    }
});
const _server = require("next/server");
const _ratelimit = require("../security/rate-limit");
const _origin = require("../../http/origin");
const _turnstile = require("../../security/turnstile");
const _logger = require("../../utils/logger");
const _server1 = require("../../../utils/supabase/server");
function createAuthMiddleware(options = {}) {
    const { requireAuth = true, requireTrustTier, requireAdmin = false, allowPublic = false, requireOrigin = true, requireTurnstile = false, turnstileAction, rateLimit = 'auth' } = options;
    return async (request, context)=>{
        try {
            // Origin validation
            if (requireOrigin) {
                try {
                    (0, _origin.requireTrustedOrigin)(request);
                } catch (error) {
                    (0, _logger.devLog)('Origin validation failed:', {
                        error: error instanceof Error ? error.message : String(error)
                    });
                    return _server.NextResponse.json({
                        message: 'Invalid origin'
                    }, {
                        status: 403
                    });
                }
            }
            // Use context if provided for enhanced authentication
            if (context?.user && !allowPublic) {
                (0, _logger.devLog)('Using provided authentication context', {
                    userId: context.user.id,
                    trustTier: context.user.trust_tier
                });
            }
            // Rate limiting
            if (rateLimit) {
                const rateLimitResult = await _ratelimit.rateLimiters[rateLimit].check(request);
                if (!rateLimitResult.allowed) {
                    return _server.NextResponse.json({
                        message: 'Too many requests. Please try again later.',
                        retryAfter: rateLimitResult.retryAfter
                    }, {
                        status: 429
                    });
                }
            }
            // Turnstile verification
            if (requireTurnstile) {
                try {
                    await (0, _turnstile.requireTurnstileVerification)(request, turnstileAction);
                } catch (error) {
                    (0, _logger.devLog)('Turnstile verification failed:', {
                        error: error instanceof Error ? error.message : String(error)
                    });
                    return _server.NextResponse.json({
                        message: 'Security verification failed'
                    }, {
                        status: 403
                    });
                }
            }
            // Create Supabase client at runtime
            const supabase = await (0, _server1.getSupabaseServerClient)();
            if (!supabase) {
                return _server.NextResponse.json({
                    message: 'Authentication service not available'
                }, {
                    status: 500
                });
            }
            // Get current user session
            const { data: { user }, error: authError } = await supabase.auth.getUser();
            // Handle unauthenticated requests
            if (authError || !user) {
                if (requireAuth) {
                    return _server.NextResponse.json({
                        message: 'Authentication required'
                    }, {
                        status: 401
                    });
                }
                if (allowPublic) {
                    // Allow public access but return null user
                    return null;
                }
                return _server.NextResponse.json({
                    message: 'Authentication required'
                }, {
                    status: 401
                });
            }
            // Get user profile
            const { data: profile, error: profileError } = await supabase.from('user_profiles').select('trust_tier, username').eq('user_id', String(user.id)).single();
            if (profileError) {
                (0, _logger.devLog)('Profile lookup error', {
                    error: profileError.message,
                    userId: user.id
                });
                return _server.NextResponse.json({
                    message: 'User profile not found'
                }, {
                    status: 404
                });
            }
            const authUser = {
                id: user.id,
                email: user.email || '',
                trust_tier: profile && !('error' in profile) ? profile.trust_tier || 'T1' : 'T1',
                username: profile && !('error' in profile) ? profile.username : null
            };
            // Check admin requirement - rely on RLS policies for security
            if (requireAdmin) {
                const { data: adminCheck, error: adminError } = await supabase.rpc('is_admin', {
                    user_id: user.id
                });
                if (adminError || !adminCheck) {
                    return _server.NextResponse.json({
                        message: 'Admin access required - insufficient privileges'
                    }, {
                        status: 403
                    });
                }
            }
            // Check trust tier requirement
            if (requireTrustTier) {
                const tierHierarchy = {
                    'T1': 1,
                    'T2': 2,
                    'T3': 3
                };
                const userTier = tierHierarchy[authUser.trust_tier] || 0;
                const requiredTier = tierHierarchy[requireTrustTier];
                if (userTier < requiredTier) {
                    return _server.NextResponse.json({
                        message: `Trust tier ${requireTrustTier} required`
                    }, {
                        status: 403
                    });
                }
            }
            // Return null to continue processing (authentication successful)
            return null;
        } catch (error) {
            (0, _logger.devLog)('Auth middleware error', {
                error: error instanceof Error ? error.message : String(error)
            });
            return _server.NextResponse.json({
                message: 'Authentication error'
            }, {
                status: 500
            });
        }
    };
}
function withAuth(handler, options = {}) {
    return async (request)=>{
        const authMiddleware = createAuthMiddleware(options);
        const authResult = await authMiddleware(request);
        if (authResult) {
            return authResult;
        }
        // Get user context for the handler at runtime
        const supabase = await (0, _server1.getSupabaseServerClient)();
        if (!supabase) {
            return _server.NextResponse.json({
                message: 'Authentication service not available'
            }, {
                status: 500
            });
        }
        const { data: { user } } = await supabase.auth.getUser();
        // Use RLS function to check admin status
        const { data: isAdmin } = await supabase.rpc('is_admin', {
            user_id: user.id
        });
        const { data: profile } = await supabase.from('user_profiles').select('username').eq('user_id', String(user.id)).single();
        const context = {
            user: {
                id: user.id,
                email: user.email || '',
                trust_tier: isAdmin ? 'T3' : 'T1',
                username: profile && !('error' in profile) ? profile.username : null
            },
            supabase
        };
        // Log successful authentication
        (0, _logger.devLog)('Auth middleware: Processing request for user:', {
            userId: context.user.id,
            trustTier: context.user.trust_tier,
            method: request.method,
            path: request.nextUrl.pathname
        });
        return handler(request, context);
    };
}
function createRateLimitMiddleware(options) {
    const { maxRequests, windowMs, keyGenerator } = options;
    return async (request)=>{
        const key = keyGenerator ? keyGenerator(request) : 'default';
        // Use the enhanced rate limiter with custom parameters
        const rateLimitResult = await _ratelimit.rateLimiters.auth.check(request);
        // Log rate limit configuration for debugging
        (0, _logger.devLog)('Rate limit check', {
            key: `${key.substring(0, 8)}...`,
            maxRequests,
            windowMs,
            allowed: rateLimitResult.allowed
        });
        if (!rateLimitResult.allowed) {
            return _server.NextResponse.json({
                message: 'Too many requests. Please try again later.',
                retryAfter: rateLimitResult.retryAfter,
                limit: maxRequests,
                window: windowMs
            }, {
                status: 429
            });
        }
        return null;
    };
}
function createSecurityHeadersMiddleware() {
    return (response)=>{
        // Add security headers
        response.headers.set('X-Content-Type-Options', 'nosniff');
        response.headers.set('X-Frame-Options', 'DENY');
        response.headers.set('X-XSS-Protection', '1; mode=block');
        response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
        response.headers.set('Cache-Control', 'no-store, no-cache, must-revalidate');
        response.headers.set('Vary', 'Cookie, Authorization');
        return response;
    };
}
function createApiMiddleware(options = {}) {
    return async (request)=>{
        // Apply authentication middleware
        const authMiddleware = createAuthMiddleware(options);
        const authResult = await authMiddleware(request);
        if (authResult) {
            return authResult;
        }
        // Apply security headers
        const response = new _server.NextResponse();
        return createSecurityHeadersMiddleware()(response);
    };
}
function combineMiddleware(...middlewares) {
    return async (request)=>{
        for (const middleware of middlewares){
            const result = await middleware(request);
            if (result) {
                return result;
            }
        }
        return null;
    };
}
async function getUser() {
    try {
        const supabase = await (0, _server1.getSupabaseServerClient)();
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) {
            (0, _logger.devLog)('getUser error:', {
                error: error.message
            });
            return null;
        }
        return user;
    } catch (error) {
        (0, _logger.devLog)('getUser error:', {
            error: error instanceof Error ? error.message : String(error)
        });
        return null;
    }
}
async function requireUser(_req) {
    const user = await getUser();
    if (!user) {
        throw new Error('Authentication required');
    }
    return user;
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbGF1Z2hpbmdraXRzdW5lL3NyYy9DaG9pY2VzL3dlYi9saWIvY29yZS9hdXRoL21pZGRsZXdhcmUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3JlIEF1dGhlbnRpY2F0aW9uIE1pZGRsZXdhcmVcbiAqIFxuICogRW5oYW5jZWQgYXV0aGVudGljYXRpb24gbWlkZGxld2FyZSB3aXRoIHNlY3VyaXR5IGZlYXR1cmVzOlxuICogLSBPcmlnaW4gdmFsaWRhdGlvblxuICogLSBSYXRlIGxpbWl0aW5nIGludGVncmF0aW9uXG4gKiAtIFR1cm5zdGlsZSB2ZXJpZmljYXRpb25cbiAqIC0gQ29tcHJlaGVuc2l2ZSBlcnJvciBoYW5kbGluZ1xuICovXG5cbmltcG9ydCB0eXBlIHsgU3VwYWJhc2VDbGllbnQsIFVzZXIgfSBmcm9tICdAc3VwYWJhc2Uvc3VwYWJhc2UtanMnO1xuaW1wb3J0IHsgdHlwZSBOZXh0UmVxdWVzdCwgTmV4dFJlc3BvbnNlIH0gZnJvbSAnbmV4dC9zZXJ2ZXInO1xuXG5pbXBvcnQgeyByYXRlTGltaXRlcnMgfSBmcm9tICdAL2xpYi9jb3JlL3NlY3VyaXR5L3JhdGUtbGltaXQnO1xuaW1wb3J0IHsgcmVxdWlyZVRydXN0ZWRPcmlnaW4gfSBmcm9tICdAL2xpYi9odHRwL29yaWdpbic7XG5pbXBvcnQgeyByZXF1aXJlVHVybnN0aWxlVmVyaWZpY2F0aW9uIH0gZnJvbSAnQC9saWIvc2VjdXJpdHkvdHVybnN0aWxlJztcbmltcG9ydCB7IGRldkxvZyB9IGZyb20gJ0AvbGliL3V0aWxzL2xvZ2dlcic7XG5pbXBvcnQgeyB3aXRoT3B0aW9uYWwgfSBmcm9tICdAL2xpYi91dGlscy9vYmplY3RzJztcbmltcG9ydCB7IGdldFN1cGFiYXNlU2VydmVyQ2xpZW50IH0gZnJvbSAnQC91dGlscy9zdXBhYmFzZS9zZXJ2ZXInO1xuXG5leHBvcnQgdHlwZSBUcnVzdFRpZXIgPSAnVDEnIHwgJ1QyJyB8ICdUMyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXV0aFVzZXIge1xuICBpZDogc3RyaW5nO1xuICBlbWFpbDogc3RyaW5nO1xuICB0cnVzdF90aWVyOiBUcnVzdFRpZXI7XG4gIHVzZXJuYW1lPzogc3RyaW5nIHwgbnVsbDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBdXRoQ29udGV4dCB7XG4gIHVzZXI6IEF1dGhVc2VyO1xuICBzdXBhYmFzZTogU3VwYWJhc2VDbGllbnQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVXNlclByb2ZpbGUge1xuICB0cnVzdF90aWVyOiBUcnVzdFRpZXI7XG4gIHVzZXJuYW1lPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEF1dGhNaWRkbGV3YXJlT3B0aW9ucyB7XG4gIHJlcXVpcmVBdXRoPzogYm9vbGVhbjtcbiAgcmVxdWlyZVRydXN0VGllcj86IFRydXN0VGllcjtcbiAgcmVxdWlyZUFkbWluPzogYm9vbGVhbjtcbiAgYWxsb3dQdWJsaWM/OiBib29sZWFuO1xuICByZXF1aXJlT3JpZ2luPzogYm9vbGVhbjtcbiAgcmVxdWlyZVR1cm5zdGlsZT86IGJvb2xlYW47XG4gIHR1cm5zdGlsZUFjdGlvbj86IHN0cmluZztcbiAgcmF0ZUxpbWl0PzogJ2F1dGgnIHwgJ3JlZ2lzdHJhdGlvbicgfCAnZGV2aWNlRmxvdycgfCAnYmlvbWV0cmljJztcbn1cblxuLyoqXG4gKiBFbmhhbmNlZCBhdXRoZW50aWNhdGlvbiBtaWRkbGV3YXJlIGZhY3RvcnlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUF1dGhNaWRkbGV3YXJlKG9wdGlvbnM6IEF1dGhNaWRkbGV3YXJlT3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICByZXF1aXJlQXV0aCA9IHRydWUsXG4gICAgcmVxdWlyZVRydXN0VGllcixcbiAgICByZXF1aXJlQWRtaW4gPSBmYWxzZSxcbiAgICBhbGxvd1B1YmxpYyA9IGZhbHNlLFxuICAgIHJlcXVpcmVPcmlnaW4gPSB0cnVlLFxuICAgIHJlcXVpcmVUdXJuc3RpbGUgPSBmYWxzZSxcbiAgICB0dXJuc3RpbGVBY3Rpb24sXG4gICAgcmF0ZUxpbWl0ID0gJ2F1dGgnXG4gIH0gPSBvcHRpb25zO1xuXG4gIHJldHVybiBhc3luYyAocmVxdWVzdDogTmV4dFJlcXVlc3QsIGNvbnRleHQ/OiBBdXRoQ29udGV4dCk6IFByb21pc2U8TmV4dFJlc3BvbnNlIHwgbnVsbD4gPT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBPcmlnaW4gdmFsaWRhdGlvblxuICAgICAgaWYgKHJlcXVpcmVPcmlnaW4pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICByZXF1aXJlVHJ1c3RlZE9yaWdpbihyZXF1ZXN0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBkZXZMb2coJ09yaWdpbiB2YWxpZGF0aW9uIGZhaWxlZDonLCB7IGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcikgfSk7XG4gICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgICAgeyBtZXNzYWdlOiAnSW52YWxpZCBvcmlnaW4nIH0sXG4gICAgICAgICAgICB7IHN0YXR1czogNDAzIH1cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBjb250ZXh0IGlmIHByb3ZpZGVkIGZvciBlbmhhbmNlZCBhdXRoZW50aWNhdGlvblxuICAgICAgaWYgKGNvbnRleHQ/LnVzZXIgJiYgIWFsbG93UHVibGljKSB7XG4gICAgICAgIGRldkxvZygnVXNpbmcgcHJvdmlkZWQgYXV0aGVudGljYXRpb24gY29udGV4dCcsIHtcbiAgICAgICAgICB1c2VySWQ6IGNvbnRleHQudXNlci5pZCxcbiAgICAgICAgICB0cnVzdFRpZXI6IGNvbnRleHQudXNlci50cnVzdF90aWVyXG4gICAgICAgIH0pO1xuICAgICAgfVxuXG4gICAgICAvLyBSYXRlIGxpbWl0aW5nXG4gICAgICBpZiAocmF0ZUxpbWl0KSB7XG4gICAgICAgIGNvbnN0IHJhdGVMaW1pdFJlc3VsdCA9IGF3YWl0IHJhdGVMaW1pdGVyc1tyYXRlTGltaXRdLmNoZWNrKHJlcXVlc3QpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFyYXRlTGltaXRSZXN1bHQuYWxsb3dlZCkge1xuICAgICAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgICAgIHsgXG4gICAgICAgICAgICAgIG1lc3NhZ2U6ICdUb28gbWFueSByZXF1ZXN0cy4gUGxlYXNlIHRyeSBhZ2FpbiBsYXRlci4nLFxuICAgICAgICAgICAgICByZXRyeUFmdGVyOiByYXRlTGltaXRSZXN1bHQucmV0cnlBZnRlclxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHsgc3RhdHVzOiA0MjkgfVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gVHVybnN0aWxlIHZlcmlmaWNhdGlvblxuICAgICAgaWYgKHJlcXVpcmVUdXJuc3RpbGUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCByZXF1aXJlVHVybnN0aWxlVmVyaWZpY2F0aW9uKHJlcXVlc3QsIHR1cm5zdGlsZUFjdGlvbik7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgZGV2TG9nKCdUdXJuc3RpbGUgdmVyaWZpY2F0aW9uIGZhaWxlZDonLCB7IGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcikgfSk7XG4gICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgICAgeyBtZXNzYWdlOiAnU2VjdXJpdHkgdmVyaWZpY2F0aW9uIGZhaWxlZCcgfSxcbiAgICAgICAgICAgIHsgc3RhdHVzOiA0MDMgfVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gQ3JlYXRlIFN1cGFiYXNlIGNsaWVudCBhdCBydW50aW1lXG4gICAgICBjb25zdCBzdXBhYmFzZSA9IGF3YWl0IGdldFN1cGFiYXNlU2VydmVyQ2xpZW50KCk7XG5cbiAgICAgIGlmICghc3VwYWJhc2UpIHtcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgIHsgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHNlcnZpY2Ugbm90IGF2YWlsYWJsZScgfSxcbiAgICAgICAgICB7IHN0YXR1czogNTAwIH1cbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IGN1cnJlbnQgdXNlciBzZXNzaW9uXG4gICAgICBjb25zdCB7IGRhdGE6IHsgdXNlciB9LCBlcnJvcjogYXV0aEVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZS5hdXRoLmdldFVzZXIoKTtcblxuICAgICAgLy8gSGFuZGxlIHVuYXV0aGVudGljYXRlZCByZXF1ZXN0c1xuICAgICAgaWYgKGF1dGhFcnJvciB8fCAhdXNlcikge1xuICAgICAgICBpZiAocmVxdWlyZUF1dGgpIHtcbiAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgICAgICB7IG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiByZXF1aXJlZCcgfSxcbiAgICAgICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChhbGxvd1B1YmxpYykge1xuICAgICAgICAgIC8vIEFsbG93IHB1YmxpYyBhY2Nlc3MgYnV0IHJldHVybiBudWxsIHVzZXJcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgIHsgbWVzc2FnZTogJ0F1dGhlbnRpY2F0aW9uIHJlcXVpcmVkJyB9LFxuICAgICAgICAgIHsgc3RhdHVzOiA0MDEgfVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBHZXQgdXNlciBwcm9maWxlXG4gICAgICBjb25zdCB7IGRhdGE6IHByb2ZpbGUsIGVycm9yOiBwcm9maWxlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAgIC5mcm9tKCd1c2VyX3Byb2ZpbGVzJylcbiAgICAgICAgLnNlbGVjdCgndHJ1c3RfdGllciwgdXNlcm5hbWUnKVxuICAgICAgICAuZXEoJ3VzZXJfaWQnLCBTdHJpbmcodXNlci5pZCkpXG4gICAgICAgIC5zaW5nbGUoKTtcblxuICAgICAgaWYgKHByb2ZpbGVFcnJvcikge1xuICAgICAgICBkZXZMb2coJ1Byb2ZpbGUgbG9va3VwIGVycm9yJywgeyBlcnJvcjogcHJvZmlsZUVycm9yLm1lc3NhZ2UsIHVzZXJJZDogdXNlci5pZCB9KTtcbiAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgIHsgbWVzc2FnZTogJ1VzZXIgcHJvZmlsZSBub3QgZm91bmQnIH0sXG4gICAgICAgICAgeyBzdGF0dXM6IDQwNCB9XG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGF1dGhVc2VyOiBBdXRoVXNlciA9IHtcbiAgICAgICAgaWQ6IHVzZXIuaWQsXG4gICAgICAgIGVtYWlsOiB1c2VyLmVtYWlsIHx8ICcnLFxuICAgICAgICB0cnVzdF90aWVyOiBwcm9maWxlICYmICEoJ2Vycm9yJyBpbiBwcm9maWxlKSA/IChwcm9maWxlIGFzIFVzZXJQcm9maWxlKS50cnVzdF90aWVyIHx8ICdUMScgOiAnVDEnLFxuICAgICAgICB1c2VybmFtZTogcHJvZmlsZSAmJiAhKCdlcnJvcicgaW4gcHJvZmlsZSkgPyAocHJvZmlsZSBhcyBVc2VyUHJvZmlsZSkudXNlcm5hbWUgOiBudWxsXG4gICAgICB9O1xuXG4gICAgICAvLyBDaGVjayBhZG1pbiByZXF1aXJlbWVudCAtIHJlbHkgb24gUkxTIHBvbGljaWVzIGZvciBzZWN1cml0eVxuICAgICAgaWYgKHJlcXVpcmVBZG1pbikge1xuICAgICAgICBjb25zdCB7IGRhdGE6IGFkbWluQ2hlY2ssIGVycm9yOiBhZG1pbkVycm9yIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgICAgIC5ycGMoJ2lzX2FkbWluJywgeyB1c2VyX2lkOiB1c2VyLmlkIH0pO1xuXG4gICAgICAgIGlmIChhZG1pbkVycm9yIHx8ICFhZG1pbkNoZWNrKSB7XG4gICAgICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICAgICAgeyBtZXNzYWdlOiAnQWRtaW4gYWNjZXNzIHJlcXVpcmVkIC0gaW5zdWZmaWNpZW50IHByaXZpbGVnZXMnIH0sXG4gICAgICAgICAgICB7IHN0YXR1czogNDAzIH1cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIHRydXN0IHRpZXIgcmVxdWlyZW1lbnRcbiAgICAgIGlmIChyZXF1aXJlVHJ1c3RUaWVyKSB7XG4gICAgICAgIGNvbnN0IHRpZXJIaWVyYXJjaHk6IFJlY29yZDxUcnVzdFRpZXIsIG51bWJlcj4gPSB7XG4gICAgICAgICAgJ1QxJzogMSxcbiAgICAgICAgICAnVDInOiAyLFxuICAgICAgICAgICdUMyc6IDNcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCB1c2VyVGllciA9IHRpZXJIaWVyYXJjaHlbYXV0aFVzZXIudHJ1c3RfdGllcl0gfHwgMDtcbiAgICAgICAgY29uc3QgcmVxdWlyZWRUaWVyID0gdGllckhpZXJhcmNoeVtyZXF1aXJlVHJ1c3RUaWVyXTtcblxuICAgICAgICBpZiAodXNlclRpZXIgPCByZXF1aXJlZFRpZXIpIHtcbiAgICAgICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgICAgICB7IG1lc3NhZ2U6IGBUcnVzdCB0aWVyICR7cmVxdWlyZVRydXN0VGllcn0gcmVxdWlyZWRgIH0sXG4gICAgICAgICAgICB7IHN0YXR1czogNDAzIH1cbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFJldHVybiBudWxsIHRvIGNvbnRpbnVlIHByb2Nlc3NpbmcgKGF1dGhlbnRpY2F0aW9uIHN1Y2Nlc3NmdWwpXG4gICAgICByZXR1cm4gbnVsbDtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBkZXZMb2coJ0F1dGggbWlkZGxld2FyZSBlcnJvcicsIHsgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSB9KTtcblxuICAgICAgcmV0dXJuIE5leHRSZXNwb25zZS5qc29uKFxuICAgICAgICB7IG1lc3NhZ2U6ICdBdXRoZW50aWNhdGlvbiBlcnJvcicgfSxcbiAgICAgICAgeyBzdGF0dXM6IDUwMCB9XG4gICAgICApO1xuICAgIH1cbiAgfTtcbn1cblxuLyoqXG4gKiBIaWdoZXItb3JkZXIgZnVuY3Rpb24gdG8gd3JhcCBBUEkgaGFuZGxlcnMgd2l0aCBhdXRoZW50aWNhdGlvblxuICovXG5leHBvcnQgZnVuY3Rpb24gd2l0aEF1dGgoXG4gIGhhbmRsZXI6IChyZXF1ZXN0OiBOZXh0UmVxdWVzdCwgY29udGV4dDogQXV0aENvbnRleHQpID0+IFByb21pc2U8TmV4dFJlc3BvbnNlPixcbiAgb3B0aW9uczogQXV0aE1pZGRsZXdhcmVPcHRpb25zID0ge31cbikge1xuICByZXR1cm4gYXN5bmMgKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KTogUHJvbWlzZTxOZXh0UmVzcG9uc2U+ID0+IHtcbiAgICBjb25zdCBhdXRoTWlkZGxld2FyZSA9IGNyZWF0ZUF1dGhNaWRkbGV3YXJlKG9wdGlvbnMpO1xuICAgIGNvbnN0IGF1dGhSZXN1bHQgPSBhd2FpdCBhdXRoTWlkZGxld2FyZShyZXF1ZXN0KTtcblxuICAgIGlmIChhdXRoUmVzdWx0KSB7XG4gICAgICByZXR1cm4gYXV0aFJlc3VsdDtcbiAgICB9XG5cbiAgICAvLyBHZXQgdXNlciBjb250ZXh0IGZvciB0aGUgaGFuZGxlciBhdCBydW50aW1lXG4gICAgY29uc3Qgc3VwYWJhc2UgPSBhd2FpdCBnZXRTdXBhYmFzZVNlcnZlckNsaWVudCgpO1xuICAgIFxuICAgIGlmICghc3VwYWJhc2UpIHtcbiAgICAgIHJldHVybiBOZXh0UmVzcG9uc2UuanNvbihcbiAgICAgICAgeyBtZXNzYWdlOiAnQXV0aGVudGljYXRpb24gc2VydmljZSBub3QgYXZhaWxhYmxlJyB9LFxuICAgICAgICB7IHN0YXR1czogNTAwIH1cbiAgICAgICk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IHsgZGF0YTogeyB1c2VyIH0gfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguZ2V0VXNlcigpO1xuICAgIFxuICAgIC8vIFVzZSBSTFMgZnVuY3Rpb24gdG8gY2hlY2sgYWRtaW4gc3RhdHVzXG4gICAgY29uc3QgeyBkYXRhOiBpc0FkbWluIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLnJwYygnaXNfYWRtaW4nLCB7IHVzZXJfaWQ6IHVzZXIhLmlkIH0pO1xuXG4gICAgY29uc3QgeyBkYXRhOiBwcm9maWxlIH0gPSBhd2FpdCBzdXBhYmFzZVxuICAgICAgLmZyb20oJ3VzZXJfcHJvZmlsZXMnKVxuICAgICAgLnNlbGVjdCgndXNlcm5hbWUnKVxuICAgICAgLmVxKCd1c2VyX2lkJywgU3RyaW5nKHVzZXIhLmlkKSlcbiAgICAgIC5zaW5nbGUoKTtcblxuICAgIGNvbnN0IGNvbnRleHQ6IEF1dGhDb250ZXh0ID0ge1xuICAgICAgdXNlcjoge1xuICAgICAgICBpZDogdXNlciEuaWQsXG4gICAgICAgIGVtYWlsOiB1c2VyIS5lbWFpbCB8fCAnJyxcbiAgICAgICAgdHJ1c3RfdGllcjogaXNBZG1pbiA/ICdUMycgOiAnVDEnLFxuICAgICAgICB1c2VybmFtZTogcHJvZmlsZSAmJiAhKCdlcnJvcicgaW4gcHJvZmlsZSkgPyAocHJvZmlsZSBhcyBVc2VyUHJvZmlsZSkudXNlcm5hbWUgOiBudWxsXG4gICAgICB9LFxuICAgICAgc3VwYWJhc2VcbiAgICB9O1xuXG4gICAgLy8gTG9nIHN1Y2Nlc3NmdWwgYXV0aGVudGljYXRpb25cbiAgICBkZXZMb2coJ0F1dGggbWlkZGxld2FyZTogUHJvY2Vzc2luZyByZXF1ZXN0IGZvciB1c2VyOicsIHtcbiAgICAgIHVzZXJJZDogY29udGV4dC51c2VyLmlkLFxuICAgICAgdHJ1c3RUaWVyOiBjb250ZXh0LnVzZXIudHJ1c3RfdGllcixcbiAgICAgIG1ldGhvZDogcmVxdWVzdC5tZXRob2QsXG4gICAgICBwYXRoOiByZXF1ZXN0Lm5leHRVcmwucGF0aG5hbWVcbiAgICB9KTtcbiAgICBcbiAgICByZXR1cm4gaGFuZGxlcihyZXF1ZXN0LCBjb250ZXh0KTtcbiAgfTtcbn1cblxuLyoqXG4gKiBSYXRlIGxpbWl0aW5nIG1pZGRsZXdhcmUgZmFjdG9yeVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmF0ZUxpbWl0TWlkZGxld2FyZShvcHRpb25zOiB7XG4gIG1heFJlcXVlc3RzOiBudW1iZXI7XG4gIHdpbmRvd01zOiBudW1iZXI7XG4gIGtleUdlbmVyYXRvcj86IChyZXF1ZXN0OiBOZXh0UmVxdWVzdCkgPT4gc3RyaW5nO1xufSkge1xuICBjb25zdCB7IG1heFJlcXVlc3RzLCB3aW5kb3dNcywga2V5R2VuZXJhdG9yIH0gPSBvcHRpb25zO1xuXG4gIHJldHVybiBhc3luYyAocmVxdWVzdDogTmV4dFJlcXVlc3QpOiBQcm9taXNlPE5leHRSZXNwb25zZSB8IG51bGw+ID0+IHtcbiAgICBjb25zdCBrZXkgPSBrZXlHZW5lcmF0b3IgPyBrZXlHZW5lcmF0b3IocmVxdWVzdCkgOiAnZGVmYXVsdCc7XG4gICAgXG4gICAgLy8gVXNlIHRoZSBlbmhhbmNlZCByYXRlIGxpbWl0ZXIgd2l0aCBjdXN0b20gcGFyYW1ldGVyc1xuICAgIGNvbnN0IHJhdGVMaW1pdFJlc3VsdCA9IGF3YWl0IHJhdGVMaW1pdGVycy5hdXRoLmNoZWNrKHJlcXVlc3QpO1xuICAgIFxuICAgIC8vIExvZyByYXRlIGxpbWl0IGNvbmZpZ3VyYXRpb24gZm9yIGRlYnVnZ2luZ1xuICAgIGRldkxvZygnUmF0ZSBsaW1pdCBjaGVjaycsIHtcbiAgICAgIGtleTogYCR7a2V5LnN1YnN0cmluZygwLCA4KSAgfS4uLmAsXG4gICAgICBtYXhSZXF1ZXN0cyxcbiAgICAgIHdpbmRvd01zLFxuICAgICAgYWxsb3dlZDogcmF0ZUxpbWl0UmVzdWx0LmFsbG93ZWRcbiAgICB9KTtcbiAgICBcbiAgICBpZiAoIXJhdGVMaW1pdFJlc3VsdC5hbGxvd2VkKSB7XG4gICAgICByZXR1cm4gTmV4dFJlc3BvbnNlLmpzb24oXG4gICAgICAgIHsgXG4gICAgICAgICAgbWVzc2FnZTogJ1RvbyBtYW55IHJlcXVlc3RzLiBQbGVhc2UgdHJ5IGFnYWluIGxhdGVyLicsXG4gICAgICAgICAgcmV0cnlBZnRlcjogcmF0ZUxpbWl0UmVzdWx0LnJldHJ5QWZ0ZXIsXG4gICAgICAgICAgbGltaXQ6IG1heFJlcXVlc3RzLFxuICAgICAgICAgIHdpbmRvdzogd2luZG93TXNcbiAgICAgICAgfSxcbiAgICAgICAgeyBzdGF0dXM6IDQyOSB9XG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9O1xufVxuXG4vKipcbiAqIFNlY3VyaXR5IGhlYWRlcnMgbWlkZGxld2FyZVxuICovXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlU2VjdXJpdHlIZWFkZXJzTWlkZGxld2FyZSgpIHtcbiAgcmV0dXJuIChyZXNwb25zZTogTmV4dFJlc3BvbnNlKTogTmV4dFJlc3BvbnNlID0+IHtcbiAgICAvLyBBZGQgc2VjdXJpdHkgaGVhZGVyc1xuICAgIHJlc3BvbnNlLmhlYWRlcnMuc2V0KCdYLUNvbnRlbnQtVHlwZS1PcHRpb25zJywgJ25vc25pZmYnKTtcbiAgICByZXNwb25zZS5oZWFkZXJzLnNldCgnWC1GcmFtZS1PcHRpb25zJywgJ0RFTlknKTtcbiAgICByZXNwb25zZS5oZWFkZXJzLnNldCgnWC1YU1MtUHJvdGVjdGlvbicsICcxOyBtb2RlPWJsb2NrJyk7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoJ1JlZmVycmVyLVBvbGljeScsICdzdHJpY3Qtb3JpZ2luLXdoZW4tY3Jvc3Mtb3JpZ2luJyk7XG4gICAgcmVzcG9uc2UuaGVhZGVycy5zZXQoJ0NhY2hlLUNvbnRyb2wnLCAnbm8tc3RvcmUsIG5vLWNhY2hlLCBtdXN0LXJldmFsaWRhdGUnKTtcbiAgICByZXNwb25zZS5oZWFkZXJzLnNldCgnVmFyeScsICdDb29raWUsIEF1dGhvcml6YXRpb24nKTtcblxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfTtcbn1cblxuLyoqXG4gKiBDb21iaW5lZCBtaWRkbGV3YXJlIGZvciBBUEkgcm91dGVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVBcGlNaWRkbGV3YXJlKG9wdGlvbnM6IEF1dGhNaWRkbGV3YXJlT3B0aW9ucyA9IHt9KSB7XG4gIHJldHVybiBhc3luYyAocmVxdWVzdDogTmV4dFJlcXVlc3QpOiBQcm9taXNlPE5leHRSZXNwb25zZSB8IG51bGw+ID0+IHtcbiAgICAvLyBBcHBseSBhdXRoZW50aWNhdGlvbiBtaWRkbGV3YXJlXG4gICAgY29uc3QgYXV0aE1pZGRsZXdhcmUgPSBjcmVhdGVBdXRoTWlkZGxld2FyZShvcHRpb25zKTtcbiAgICBjb25zdCBhdXRoUmVzdWx0ID0gYXdhaXQgYXV0aE1pZGRsZXdhcmUocmVxdWVzdCk7XG5cbiAgICBpZiAoYXV0aFJlc3VsdCkge1xuICAgICAgcmV0dXJuIGF1dGhSZXN1bHQ7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgc2VjdXJpdHkgaGVhZGVyc1xuICAgIGNvbnN0IHJlc3BvbnNlID0gbmV3IE5leHRSZXNwb25zZSgpO1xuICAgIHJldHVybiBjcmVhdGVTZWN1cml0eUhlYWRlcnNNaWRkbGV3YXJlKCkocmVzcG9uc2UpO1xuICB9O1xufVxuXG4vKipcbiAqIENvbWJpbmUgbXVsdGlwbGUgbWlkZGxld2FyZSBmdW5jdGlvbnMgaW50byBhIHNpbmdsZSBtaWRkbGV3YXJlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjb21iaW5lTWlkZGxld2FyZSguLi5taWRkbGV3YXJlczogQXJyYXk8KHJlcXVlc3Q6IE5leHRSZXF1ZXN0KSA9PiBQcm9taXNlPE5leHRSZXNwb25zZSB8IG51bGw+Pikge1xuICByZXR1cm4gYXN5bmMgKHJlcXVlc3Q6IE5leHRSZXF1ZXN0KTogUHJvbWlzZTxOZXh0UmVzcG9uc2UgfCBudWxsPiA9PiB7XG4gICAgZm9yIChjb25zdCBtaWRkbGV3YXJlIG9mIG1pZGRsZXdhcmVzKSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBtaWRkbGV3YXJlKHJlcXVlc3QpO1xuICAgICAgaWYgKHJlc3VsdCkge1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfTtcbn1cblxuLyoqXG4gKiBTaW1wbGUgZ2V0VXNlciBmdW5jdGlvbiBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuICogVXNlcyBjYW5vbmljYWwgU3VwYWJhc2UgY2xpZW50XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRVc2VyKCk6IFByb21pc2U8VXNlciB8IG51bGw+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBzdXBhYmFzZSA9IGF3YWl0IGdldFN1cGFiYXNlU2VydmVyQ2xpZW50KCk7XG4gICAgY29uc3QgeyBkYXRhOiB7IHVzZXIgfSwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguZ2V0VXNlcigpO1xuICAgIFxuICAgIGlmIChlcnJvcikge1xuICAgICAgZGV2TG9nKCdnZXRVc2VyIGVycm9yOicsIHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHVzZXI7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgZGV2TG9nKCdnZXRVc2VyIGVycm9yOicsIHsgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSB9KTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4vKipcbiAqIHJlcXVpcmVVc2VyIGZ1bmN0aW9uIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gKiBVc2VzIGNhbm9uaWNhbCBTdXBhYmFzZSBjbGllbnRcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcXVpcmVVc2VyKF9yZXE6IFJlcXVlc3QpOiBQcm9taXNlPFVzZXI+IHtcbiAgY29uc3QgdXNlciA9IGF3YWl0IGdldFVzZXIoKTtcbiAgXG4gIGlmICghdXNlcikge1xuICAgIHRocm93IG5ldyBFcnJvcignQXV0aGVudGljYXRpb24gcmVxdWlyZWQnKTtcbiAgfVxuICBcbiAgcmV0dXJuIHVzZXI7XG59Il0sIm5hbWVzIjpbImNvbWJpbmVNaWRkbGV3YXJlIiwiY3JlYXRlQXBpTWlkZGxld2FyZSIsImNyZWF0ZUF1dGhNaWRkbGV3YXJlIiwiY3JlYXRlUmF0ZUxpbWl0TWlkZGxld2FyZSIsImNyZWF0ZVNlY3VyaXR5SGVhZGVyc01pZGRsZXdhcmUiLCJnZXRVc2VyIiwicmVxdWlyZVVzZXIiLCJ3aXRoQXV0aCIsIm9wdGlvbnMiLCJyZXF1aXJlQXV0aCIsInJlcXVpcmVUcnVzdFRpZXIiLCJyZXF1aXJlQWRtaW4iLCJhbGxvd1B1YmxpYyIsInJlcXVpcmVPcmlnaW4iLCJyZXF1aXJlVHVybnN0aWxlIiwidHVybnN0aWxlQWN0aW9uIiwicmF0ZUxpbWl0IiwicmVxdWVzdCIsImNvbnRleHQiLCJyZXF1aXJlVHJ1c3RlZE9yaWdpbiIsImVycm9yIiwiZGV2TG9nIiwiRXJyb3IiLCJtZXNzYWdlIiwiU3RyaW5nIiwiTmV4dFJlc3BvbnNlIiwianNvbiIsInN0YXR1cyIsInVzZXIiLCJ1c2VySWQiLCJpZCIsInRydXN0VGllciIsInRydXN0X3RpZXIiLCJyYXRlTGltaXRSZXN1bHQiLCJyYXRlTGltaXRlcnMiLCJjaGVjayIsImFsbG93ZWQiLCJyZXRyeUFmdGVyIiwicmVxdWlyZVR1cm5zdGlsZVZlcmlmaWNhdGlvbiIsInN1cGFiYXNlIiwiZ2V0U3VwYWJhc2VTZXJ2ZXJDbGllbnQiLCJkYXRhIiwiYXV0aEVycm9yIiwiYXV0aCIsInByb2ZpbGUiLCJwcm9maWxlRXJyb3IiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiLCJhdXRoVXNlciIsImVtYWlsIiwidXNlcm5hbWUiLCJhZG1pbkNoZWNrIiwiYWRtaW5FcnJvciIsInJwYyIsInVzZXJfaWQiLCJ0aWVySGllcmFyY2h5IiwidXNlclRpZXIiLCJyZXF1aXJlZFRpZXIiLCJoYW5kbGVyIiwiYXV0aE1pZGRsZXdhcmUiLCJhdXRoUmVzdWx0IiwiaXNBZG1pbiIsIm1ldGhvZCIsInBhdGgiLCJuZXh0VXJsIiwicGF0aG5hbWUiLCJtYXhSZXF1ZXN0cyIsIndpbmRvd01zIiwia2V5R2VuZXJhdG9yIiwia2V5Iiwic3Vic3RyaW5nIiwibGltaXQiLCJ3aW5kb3ciLCJyZXNwb25zZSIsImhlYWRlcnMiLCJzZXQiLCJtaWRkbGV3YXJlcyIsIm1pZGRsZXdhcmUiLCJyZXN1bHQiLCJfcmVxIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Q0FRQzs7Ozs7Ozs7Ozs7UUEyVmVBO2VBQUFBOztRQW5CQUM7ZUFBQUE7O1FBM1JBQztlQUFBQTs7UUFrT0FDO2VBQUFBOztRQXdDQUM7ZUFBQUE7O1FBb0RNQztlQUFBQTs7UUFxQkFDO2VBQUFBOztRQTVLTkM7ZUFBQUE7Ozt3QkFqTitCOzJCQUVsQjt3QkFDUTsyQkFDUTt3QkFDdEI7eUJBRWlCO0FBbUNqQyxTQUFTTCxxQkFBcUJNLFVBQWlDLENBQUMsQ0FBQztJQUN0RSxNQUFNLEVBQ0pDLGNBQWMsSUFBSSxFQUNsQkMsZ0JBQWdCLEVBQ2hCQyxlQUFlLEtBQUssRUFDcEJDLGNBQWMsS0FBSyxFQUNuQkMsZ0JBQWdCLElBQUksRUFDcEJDLG1CQUFtQixLQUFLLEVBQ3hCQyxlQUFlLEVBQ2ZDLFlBQVksTUFBTSxFQUNuQixHQUFHUjtJQUVKLE9BQU8sT0FBT1MsU0FBc0JDO1FBQ2xDLElBQUk7WUFDRixvQkFBb0I7WUFDcEIsSUFBSUwsZUFBZTtnQkFDakIsSUFBSTtvQkFDRk0sSUFBQUEsNEJBQW9CLEVBQUNGO2dCQUN2QixFQUFFLE9BQU9HLE9BQU87b0JBQ2RDLElBQUFBLGNBQU0sRUFBQyw2QkFBNkI7d0JBQUVE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