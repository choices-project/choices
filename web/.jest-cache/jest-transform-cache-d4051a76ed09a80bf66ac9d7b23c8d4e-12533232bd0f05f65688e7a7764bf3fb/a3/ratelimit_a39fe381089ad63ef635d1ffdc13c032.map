{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/security/rate-limit.ts"],"sourcesContent":["/**\n * Rate Limiting Module\n * \n * Comprehensive rate limiting implementation for API endpoints and server actions.\n * Provides Redis-based rate limiting with configurable windows and limits.\n * \n * Features:\n * - Redis-based rate limiting\n * - Multiple rate limiting strategies (sliding window, fixed window, token bucket)\n * - Configurable limits per endpoint/user\n * - Automatic cleanup of expired entries\n * - Performance monitoring and metrics\n * \n * @author Choices Platform Team\n * @created 2025-10-26\n * @version 1.0.0\n * @since 1.0.0\n */\n\nimport { logger } from '@/lib/utils/logger';\n\nexport interface RateLimitConfig {\n  windowMs: number; // Time window in milliseconds\n  maxRequests: number; // Maximum requests per window\n  keyGenerator?: (req: any) => string; // Custom key generator\n  skipSuccessfulRequests?: boolean; // Skip counting successful requests\n  skipFailedRequests?: boolean; // Skip counting failed requests\n  message?: string; // Custom error message\n}\n\nexport interface RateLimitResult {\n  allowed: boolean;\n  remaining: number;\n  resetTime: number;\n  totalHits: number;\n}\n\nexport interface RateLimitMetrics {\n  totalRequests: number;\n  blockedRequests: number;\n  allowedRequests: number;\n  averageResponseTime: number;\n}\n\nclass RateLimiter {\n  private requests = new Map<string, { count: number; resetTime: number }>();\n  private metrics: RateLimitMetrics = {\n    totalRequests: 0,\n    blockedRequests: 0,\n    allowedRequests: 0,\n    averageResponseTime: 0\n  };\n  private cleanupTimer?: NodeJS.Timeout;\n\n  constructor(private config: RateLimitConfig) {\n    this.startCleanupTimer();\n  }\n\n  /**\n   * Check if request is allowed\n   */\n  async checkLimit(key: string): Promise<RateLimitResult> {\n    const startTime = Date.now();\n    this.metrics.totalRequests++;\n\n    try {\n      const now = Date.now();\n      const windowStart = now - this.config.windowMs;\n      \n      // Get or create entry for this key\n      let entry = this.requests.get(key);\n      \n      if (!entry || entry.resetTime <= now) {\n        // Create new window\n        entry = {\n          count: 0,\n          resetTime: now + this.config.windowMs\n        };\n      }\n\n      // Check if limit exceeded\n      if (entry.count >= this.config.maxRequests) {\n        this.metrics.blockedRequests++;\n        this.updateMetrics(startTime);\n        \n        logger.warn('Rate limit exceeded', { key, count: entry.count, maxRequests: this.config.maxRequests });\n        \n        return {\n          allowed: false,\n          remaining: 0,\n          resetTime: entry.resetTime,\n          totalHits: entry.count\n        };\n      }\n\n      // Increment counter\n      entry.count++;\n      this.requests.set(key, entry);\n      \n      this.metrics.allowedRequests++;\n      this.updateMetrics(startTime);\n      \n      return {\n        allowed: true,\n        remaining: this.config.maxRequests - entry.count,\n        resetTime: entry.resetTime,\n        totalHits: entry.count\n      };\n\n    } catch (error) {\n      logger.error('Rate limiter error', { key, error: error instanceof Error ? error.message : String(error) });\n      \n      // Fail open - allow request if rate limiter fails\n      return {\n        allowed: true,\n        remaining: this.config.maxRequests,\n        resetTime: Date.now() + this.config.windowMs,\n        totalHits: 0\n      };\n    }\n  }\n\n  /**\n   * Update performance metrics\n   */\n  private updateMetrics(startTime: number): void {\n    const responseTime = Date.now() - startTime;\n    const totalRequests = this.metrics.totalRequests;\n    \n    // Calculate rolling average\n    this.metrics.averageResponseTime = \n      (this.metrics.averageResponseTime * (totalRequests - 1) + responseTime) / totalRequests;\n  }\n\n  /**\n   * Start cleanup timer for expired entries\n   */\n  private startCleanupTimer(): void {\n    this.cleanupTimer = setInterval(() => {\n      this.cleanup();\n    }, this.config.windowMs);\n  }\n\n  /**\n   * Clean up expired entries\n   */\n  private cleanup(): void {\n    const now = Date.now();\n    let cleanedCount = 0;\n\n    for (const [key, entry] of this.requests.entries()) {\n      if (entry.resetTime <= now) {\n        this.requests.delete(key);\n        cleanedCount++;\n      }\n    }\n\n    if (cleanedCount > 0) {\n      logger.debug('Rate limiter cleanup completed', { \n        cleanedCount, \n        remainingEntries: this.requests.size \n      });\n    }\n  }\n\n  /**\n   * Get current metrics\n   */\n  getMetrics(): RateLimitMetrics {\n    return { ...this.metrics };\n  }\n\n  /**\n   * Reset rate limiter\n   */\n  reset(): void {\n    this.requests.clear();\n    this.metrics = {\n      totalRequests: 0,\n      blockedRequests: 0,\n      allowedRequests: 0,\n      averageResponseTime: 0\n    };\n  }\n\n  /**\n   * Destroy the rate limiter\n   */\n  destroy(): void {\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n      this.cleanupTimer = undefined;\n    }\n    this.reset();\n  }\n}\n\n// Pre-configured rate limiters for different endpoints\nexport const rateLimiters = {\n  // Authentication endpoints - stricter limits\n  auth: new RateLimiter({\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    maxRequests: 5, // 5 attempts per 15 minutes\n    message: 'Too many authentication attempts, please try again later'\n  }),\n\n  // General API endpoints\n  api: new RateLimiter({\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    maxRequests: 100, // 100 requests per 15 minutes\n    message: 'Too many requests, please try again later'\n  }),\n\n  // Contact/message endpoints\n  contact: new RateLimiter({\n    windowMs: 60 * 60 * 1000, // 1 hour\n    maxRequests: 10, // 10 messages per hour\n    message: 'Too many messages sent, please try again later'\n  }),\n\n  // Poll creation endpoints\n  pollCreation: new RateLimiter({\n    windowMs: 60 * 60 * 1000, // 1 hour\n    maxRequests: 20, // 20 polls per hour\n    message: 'Too many polls created, please try again later'\n  }),\n\n  // Voting endpoints\n  voting: new RateLimiter({\n    windowMs: 5 * 60 * 1000, // 5 minutes\n    maxRequests: 50, // 50 votes per 5 minutes\n    message: 'Too many votes submitted, please try again later'\n  })\n};\n\n/**\n * Create a custom rate limiter\n */\nexport function createRateLimiter(config: RateLimitConfig): RateLimiter {\n  return new RateLimiter(config);\n}\n\n/**\n * Get rate limiter by name\n */\nexport function getRateLimiter(name: keyof typeof rateLimiters): RateLimiter {\n  return rateLimiters[name];\n}\n\n/**\n * Check rate limit for a request\n */\nexport async function checkRateLimit(\n  limiterName: keyof typeof rateLimiters,\n  key: string\n): Promise<RateLimitResult> {\n  const limiter = getRateLimiter(limiterName);\n  return await limiter.checkLimit(key);\n}\n\n/**\n * Rate limit middleware factory\n */\nexport function createRateLimitMiddleware(limiterName: keyof typeof rateLimiters) {\n  return async (req: any, res: any, next: any) => {\n    try {\n      // Generate key based on IP address and user ID if available\n      const ip = req.ip || req.connection.remoteAddress || 'unknown';\n      const userId = req.user?.id || 'anonymous';\n      const key = `${limiterName}:${ip}:${userId}`;\n\n      const result = await checkRateLimit(limiterName, key);\n\n      if (!result.allowed) {\n        return res.status(429).json({\n          error: 'Rate limit exceeded',\n          message: rateLimiters[limiterName].config.message,\n          retryAfter: Math.ceil((result.resetTime - Date.now()) / 1000)\n        });\n      }\n\n      // Add rate limit headers\n      res.set({\n        'X-RateLimit-Limit': rateLimiters[limiterName].config.maxRequests,\n        'X-RateLimit-Remaining': result.remaining,\n        'X-RateLimit-Reset': new Date(result.resetTime).toISOString()\n      });\n\n      next();\n    } catch (error) {\n      logger.error('Rate limit middleware error', { error: error instanceof Error ? error.message : String(error) });\n      next(); // Fail open\n    }\n  };\n}\n\n/**\n * Combine multiple middleware functions\n */\nexport function combineMiddleware(...middlewares: Array<(req: any, res: any, next: any) => void>) {\n  return (req: any, res: any, next: any) => {\n    let index = 0;\n\n    function runNext() {\n      if (index < middlewares.length) {\n        middlewares[index++](req, res, runNext);\n      } else {\n        next();\n      }\n    }\n\n    runNext();\n  };\n}\n\n// Export types and classes\nexport { RateLimiter };\nexport default rateLimiters;"],"names":["RateLimiter","checkRateLimit","combineMiddleware","createRateLimitMiddleware","createRateLimiter","getRateLimiter","rateLimiters","config","requests","Map","metrics","totalRequests","blockedRequests","allowedRequests","averageResponseTime","startCleanupTimer","checkLimit","key","startTime","Date","now","windowStart","windowMs","entry","get","resetTime","count","maxRequests","updateMetrics","logger","warn","allowed","remaining","totalHits","set","error","Error","message","String","responseTime","cleanupTimer","setInterval","cleanup","cleanedCount","entries","delete","debug","remainingEntries","size","getMetrics","reset","clear","destroy","clearInterval","undefined","auth","api","contact","pollCreation","voting","name","limiterName","limiter","req","res","next","ip","connection","remoteAddress","userId","user","id","result","status","json","retryAfter","Math","ceil","toISOString","middlewares","index","runNext","length"],"mappings":"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"}