{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/http/origin.ts"],"sourcesContent":["/**\n * Origin Validation Utilities\n * \n * Enhanced origin validation for security and CSRF protection.\n * Validates request origins against trusted domains and handles\n * development, staging, and production environments.\n */\n\nimport { devLog } from '@/lib/utils/logger';\n\nexport interface OriginConfig {\n  allowedOrigins: string[];\n  allowLocalhost: boolean;\n  allowVercelPreview: boolean;\n  strictMode: boolean;\n}\n\n/**\n * Default origin configuration\n */\nconst DEFAULT_ORIGIN_CONFIG: OriginConfig = {\n  allowedOrigins: [\n    'https://choices-platform.vercel.app',\n    'https://choices.app',\n    'https://www.choices.app',\n  ],\n  allowLocalhost: process.env.NODE_ENV === 'development',\n  allowVercelPreview: true,\n  strictMode: process.env.NODE_ENV === 'production',\n};\n\n/**\n * Enhanced origin validation with environment awareness\n */\nexport function validateOrigin(\n  request: Request,\n  config: Partial<OriginConfig> = {}\n): { valid: boolean; reason?: string; origin?: string } {\n  const finalConfig = Object.assign({}, DEFAULT_ORIGIN_CONFIG, config);\n  const origin = request.headers.get('origin');\n  const host = request.headers.get('host');\n  const referer = request.headers.get('referer');\n\n  // Extract origin from referer if origin header is missing\n  const effectiveOrigin = origin || (referer ? new URL(referer).origin : null);\n  \n  // Log host for debugging purposes\n  if (host) {\n    devLog('Request host header:', { host });\n  }\n\n  if (!effectiveOrigin) {\n    // Allow requests without origin (e.g., direct API calls, mobile apps)\n    if (!finalConfig.strictMode) {\n      return { valid: true, reason: 'No origin header (non-strict mode)' };\n    }\n    return { valid: false, reason: 'Missing origin header' };\n  }\n\n  // Parse the origin URL\n  let originUrl: URL;\n  try {\n    originUrl = new URL(effectiveOrigin);\n  } catch {\n    return { valid: false, reason: 'Invalid origin URL format' };\n  }\n\n  const originHostname = originUrl.hostname;\n\n  // Check localhost allowance\n  if (finalConfig.allowLocalhost && isLocalhost(originHostname)) {\n    return { valid: true, reason: 'Localhost allowed in development' };\n  }\n\n  // Check Vercel preview URLs\n  if (finalConfig.allowVercelPreview && isVercelPreview(originHostname)) {\n    return { valid: true, reason: 'Vercel preview URL allowed' };\n  }\n\n  // Check against allowed origins\n  const isAllowed = finalConfig.allowedOrigins.some(allowedOrigin => {\n    try {\n      const allowedUrl = new URL(allowedOrigin);\n      return allowedUrl.hostname === originHostname;\n    } catch {\n      return false;\n    }\n  });\n\n  if (isAllowed) {\n    return { valid: true, reason: 'Origin in allowed list' };\n  }\n\n  return { \n    valid: false, \n    reason: `Origin not allowed: ${effectiveOrigin}`,\n    origin: effectiveOrigin\n  };\n}\n\n/**\n * Require trusted origin - throws error if invalid\n */\nexport function requireTrustedOrigin(\n  request: Request,\n  config?: Partial<OriginConfig>\n): void {\n  const validation = validateOrigin(request, config);\n  \n  if (!validation.valid) {\n    devLog('Origin validation failed:', {\n      reason: validation.reason,\n      origin: validation.origin,\n      host: request.headers.get('host'),\n      userAgent: request.headers.get('user-agent'),\n      method: request.method,\n      path: new URL(request.url).pathname\n    });\n    \n    throw new Error(`Origin validation failed: ${validation.reason}`);\n  }\n}\n\n/**\n * Check if hostname is localhost\n */\nexport function isLocalhost(hostname: string): boolean {\n  return (\n    hostname === 'localhost' ||\n    hostname === '127.0.0.1' ||\n    hostname === '::1' ||\n    hostname.startsWith('192.168.') ||\n    hostname.startsWith('10.') ||\n    hostname.startsWith('172.')\n  );\n}\n\n/**\n * Check if hostname is a Vercel preview URL\n */\nexport function isVercelPreview(hostname: string): boolean {\n  return (\n    hostname.endsWith('.vercel.app') ||\n    hostname.endsWith('.vercel.live') ||\n    hostname.includes('vercel-preview')\n  );\n}\n\n/**\n * Get origin from request with fallback to referer\n */\nexport function getRequestOrigin(request: Request): string | null {\n  const origin = request.headers.get('origin');\n  if (origin) return origin;\n\n  const referer = request.headers.get('referer');\n  if (referer) {\n    try {\n      return new URL(referer).origin;\n    } catch {\n      return null;\n    }\n  }\n\n  return null;\n}\n\n/**\n * Extract hostname from origin or referer\n */\nexport function getRequestHostname(request: Request): string | null {\n  const origin = getRequestOrigin(request);\n  if (!origin) return null;\n\n  try {\n    return new URL(origin).hostname;\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Check if request is from same origin\n */\nexport function isSameOrigin(request: Request): boolean {\n  const origin = getRequestOrigin(request);\n  const host = request.headers.get('host');\n  \n  if (!origin || !host) return false;\n\n  try {\n    const originUrl = new URL(origin);\n    return originUrl.hostname === host;\n  } catch {\n    return false;\n  }\n}\n\n/**\n * Get client IP address with proxy support\n */\nexport function getClientIP(request: Request): string {\n  // Check for forwarded headers (common in proxy setups)\n  const forwarded = request.headers.get('x-forwarded-for');\n  if (forwarded) {\n    const firstIP = forwarded.split(',')[0];\n    if (firstIP) {\n      return firstIP.trim();\n    }\n  }\n\n  const realIP = request.headers.get('x-real-ip');\n  if (realIP) {\n    return realIP;\n  }\n\n  const cfConnectingIP = request.headers.get('cf-connecting-ip');\n  if (cfConnectingIP) {\n    return cfConnectingIP;\n  }\n\n  // Fallback\n  return 'unknown';\n}\n\n/**\n * Check if request is from a bot/crawler\n */\nexport function isBotRequest(request: Request): boolean {\n  const userAgent = request.headers.get('user-agent') || '';\n  const botPatterns = [\n    /bot/i,\n    /crawler/i,\n    /spider/i,\n    /scraper/i,\n    /curl/i,\n    /wget/i,\n    /python/i,\n    /java/i,\n    /go-http/i,\n    /httpie/i,\n    /postman/i,\n  ];\n\n  return botPatterns.some(pattern => pattern.test(userAgent));\n}\n\n/**\n * Get request fingerprint for rate limiting\n */\nexport function getRequestFingerprint(request: Request): string {\n  const ip = getClientIP(request);\n  const userAgent = request.headers.get('user-agent') || '';\n  const acceptLanguage = request.headers.get('accept-language') || '';\n  \n  // Create a simple fingerprint\n  const fingerprint = `${ip}|${userAgent}|${acceptLanguage}`;\n  \n  // Simple hash function\n  let hash = 0;\n  for (let i = 0; i < fingerprint.length; i++) {\n    const char = fingerprint.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash; // Convert to 32-bit integer\n  }\n  \n  return Math.abs(hash).toString(36);\n}\n"],"names":["getClientIP","getRequestFingerprint","getRequestHostname","getRequestOrigin","isBotRequest","isLocalhost","isSameOrigin","isVercelPreview","requireTrustedOrigin","validateOrigin","DEFAULT_ORIGIN_CONFIG","allowedOrigins","allowLocalhost","process","env","NODE_ENV","allowVercelPreview","strictMode","request","config","finalConfig","Object","assign","origin","headers","get","host","referer","effectiveOrigin","URL","devLog","valid","reason","originUrl","originHostname","hostname","isAllowed","some","allowedOrigin","allowedUrl","validation","userAgent","method","path","url","pathname","Error","startsWith","endsWith","includes","forwarded","firstIP","split","trim","realIP","cfConnectingIP","botPatterns","pattern","test","ip","acceptLanguage","fingerprint","hash","i","length","char","charCodeAt","Math","abs","toString"],"mappings":"AAAA;;;;;;CAMC;;;;;;;;;;;QAmMeA;eAAAA;;QAiDAC;eAAAA;;QAhFAC;eAAAA;;QAnBAC;eAAAA;;QA6EAC;eAAAA;;QAtGAC;eAAAA;;QA0DAC;eAAAA;;QA5CAC;eAAAA;;QArCAC;eAAAA;;QArEAC;eAAAA;;;wBA1BO;AASvB;;CAEC,GACD,MAAMC,wBAAsC;IAC1CC,gBAAgB;QACd;QACA;QACA;KACD;IACDC,gBAAgBC,QAAQC,GAAG,CAACC,QAAQ,KAAK;IACzCC,oBAAoB;IACpBC,YAAYJ,QAAQC,GAAG,CAACC,QAAQ,KAAK;AACvC;AAKO,SAASN,eACdS,OAAgB,EAChBC,SAAgC,CAAC,CAAC;IAElC,MAAMC,cAAcC,OAAOC,MAAM,CAAC,CAAC,GAAGZ,uBAAuBS;IAC7D,MAAMI,SAASL,QAAQM,OAAO,CAACC,GAAG,CAAC;IACnC,MAAMC,OAAOR,QAAQM,OAAO,CAACC,GAAG,CAAC;IACjC,MAAME,UAAUT,QAAQM,OAAO,CAACC,GAAG,CAAC;IAEpC,0DAA0D;IAC1D,MAAMG,kBAAkBL,UAAWI,CAAAA,UAAU,IAAIE,IAAIF,SAASJ,MAAM,GAAG,IAAG;IAE1E,kCAAkC;IAClC,IAAIG,MAAM;QACRI,IAAAA,cAAM,EAAC,wBAAwB;YAAEJ;QAAK;IACxC;IAEA,IAAI,CAACE,iBAAiB;QACpB,sEAAsE;QACtE,IAAI,CAACR,YAAYH,UAAU,EAAE;YAC3B,OAAO;gBAAEc,OAAO;gBAAMC,QAAQ;YAAqC;QACrE;QACA,OAAO;YAAED,OAAO;YAAOC,QAAQ;QAAwB;IACzD;IAEA,uBAAuB;IACvB,IAAIC;IACJ,IAAI;QACFA,YAAY,IAAIJ,IAAID;IACtB,EAAE,OAAM;QACN,OAAO;YAAEG,OAAO;YAAOC,QAAQ;QAA4B;IAC7D;IAEA,MAAME,iBAAiBD,UAAUE,QAAQ;IAEzC,4BAA4B;IAC5B,IAAIf,YAAYR,cAAc,IAAIP,YAAY6B,iBAAiB;QAC7D,OAAO;YAAEH,OAAO;YAAMC,QAAQ;QAAmC;IACnE;IAEA,4BAA4B;IAC5B,IAAIZ,YAAYJ,kBAAkB,IAAIT,gBAAgB2B,iBAAiB;QACrE,OAAO;YAAEH,OAAO;YAAMC,QAAQ;QAA6B;IAC7D;IAEA,gCAAgC;IAChC,MAAMI,YAAYhB,YAAYT,cAAc,CAAC0B,IAAI,CAACC,CAAAA;QAChD,IAAI;YACF,MAAMC,aAAa,IAAIV,IAAIS;YAC3B,OAAOC,WAAWJ,QAAQ,KAAKD;QACjC,EAAE,OAAM;YACN,OAAO;QACT;IACF;IAEA,IAAIE,WAAW;QACb,OAAO;YAAEL,OAAO;YAAMC,QAAQ;QAAyB;IACzD;IAEA,OAAO;QACLD,OAAO;QACPC,QAAQ,CAAC,oBAAoB,EAAEJ,iBAAiB;QAChDL,QAAQK;IACV;AACF;AAKO,SAASpB,qBACdU,OAAgB,EAChBC,MAA8B;IAE9B,MAAMqB,aAAa/B,eAAeS,SAASC;IAE3C,IAAI,CAACqB,WAAWT,KAAK,EAAE;QACrBD,IAAAA,cAAM,EAAC,6BAA6B;YAClCE,QAAQQ,WAAWR,MAAM;YACzBT,QAAQiB,WAAWjB,MAAM;YACzBG,MAAMR,QAAQM,OAAO,CAACC,GAAG,CAAC;YAC1BgB,WAAWvB,QAAQM,OAAO,CAACC,GAAG,CAAC;YAC/BiB,QAAQxB,QAAQwB,MAAM;YACtBC,MAAM,IAAId,IAAIX,QAAQ0B,GAAG,EAAEC,QAAQ;QACrC;QAEA,MAAM,IAAIC,MAAM,CAAC,0BAA0B,EAAEN,WAAWR,MAAM,EAAE;IAClE;AACF;AAKO,SAAS3B,YAAY8B,QAAgB;IAC1C,OACEA,aAAa,eACbA,aAAa,eACbA,aAAa,SACbA,SAASY,UAAU,CAAC,eACpBZ,SAASY,UAAU,CAAC,UACpBZ,SAASY,UAAU,CAAC;AAExB;AAKO,SAASxC,gBAAgB4B,QAAgB;IAC9C,OACEA,SAASa,QAAQ,CAAC,kBAClBb,SAASa,QAAQ,CAAC,mBAClBb,SAASc,QAAQ,CAAC;AAEtB;AAKO,SAAS9C,iBAAiBe,OAAgB;IAC/C,MAAMK,SAASL,QAAQM,OAAO,CAACC,GAAG,CAAC;IACnC,IAAIF,QAAQ,OAAOA;IAEnB,MAAMI,UAAUT,QAAQM,OAAO,CAACC,GAAG,CAAC;IACpC,IAAIE,SAAS;QACX,IAAI;YACF,OAAO,IAAIE,IAAIF,SAASJ,MAAM;QAChC,EAAE,OAAM;YACN,OAAO;QACT;IACF;IAEA,OAAO;AACT;AAKO,SAASrB,mBAAmBgB,OAAgB;IACjD,MAAMK,SAASpB,iBAAiBe;IAChC,IAAI,CAACK,QAAQ,OAAO;IAEpB,IAAI;QACF,OAAO,IAAIM,IAAIN,QAAQY,QAAQ;IACjC,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAKO,SAAS7B,aAAaY,OAAgB;IAC3C,MAAMK,SAASpB,iBAAiBe;IAChC,MAAMQ,OAAOR,QAAQM,OAAO,CAACC,GAAG,CAAC;IAEjC,IAAI,CAACF,UAAU,CAACG,MAAM,OAAO;IAE7B,IAAI;QACF,MAAMO,YAAY,IAAIJ,IAAIN;QAC1B,OAAOU,UAAUE,QAAQ,KAAKT;IAChC,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAKO,SAAS1B,YAAYkB,OAAgB;IAC1C,uDAAuD;IACvD,MAAMgC,YAAYhC,QAAQM,OAAO,CAACC,GAAG,CAAC;IACtC,IAAIyB,WAAW;QACb,MAAMC,UAAUD,UAAUE,KAAK,CAAC,IAAI,CAAC,EAAE;QACvC,IAAID,SAAS;YACX,OAAOA,QAAQE,IAAI;QACrB;IACF;IAEA,MAAMC,SAASpC,QAAQM,OAAO,CAACC,GAAG,CAAC;IACnC,IAAI6B,QAAQ;QACV,OAAOA;IACT;IAEA,MAAMC,iBAAiBrC,QAAQM,OAAO,CAACC,GAAG,CAAC;IAC3C,IAAI8B,gBAAgB;QAClB,OAAOA;IACT;IAEA,WAAW;IACX,OAAO;AACT;AAKO,SAASnD,aAAac,OAAgB;IAC3C,MAAMuB,YAAYvB,QAAQM,OAAO,CAACC,GAAG,CAAC,iBAAiB;IACvD,MAAM+B,cAAc;QAClB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,OAAOA,YAAYnB,IAAI,CAACoB,CAAAA,UAAWA,QAAQC,IAAI,CAACjB;AAClD;AAKO,SAASxC,sBAAsBiB,OAAgB;IACpD,MAAMyC,KAAK3D,YAAYkB;IACvB,MAAMuB,YAAYvB,QAAQM,OAAO,CAACC,GAAG,CAAC,iBAAiB;IACvD,MAAMmC,iBAAiB1C,QAAQM,OAAO,CAACC,GAAG,CAAC,sBAAsB;IAEjE,8BAA8B;IAC9B,MAAMoC,cAAc,GAAGF,GAAG,CAAC,EAAElB,UAAU,CAAC,EAAEmB,gBAAgB;IAE1D,uBAAuB;IACvB,IAAIE,OAAO;IACX,IAAK,IAAIC,IAAI,GAAGA,IAAIF,YAAYG,MAAM,EAAED,IAAK;QAC3C,MAAME,OAAOJ,YAAYK,UAAU,CAACH;QACpCD,OAAO,AAAEA,CAAAA,QAAQ,CAAA,IAAKA,OAAQG;QAC9BH,OAAOA,OAAOA,MAAM,4BAA4B;IAClD;IAEA,OAAOK,KAAKC,GAAG,CAACN,MAAMO,QAAQ,CAAC;AACjC"}