{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/utils/error-handler.ts"],"sourcesContent":["/**\n * Error Handler Module\n * \n * Comprehensive error handling for API routes and server actions.\n * Provides standardized error types, handling, and user-friendly messages.\n * \n * Features:\n * - Custom error classes\n * - Error logging and monitoring\n * - User-friendly error messages\n * - HTTP status code mapping\n * - Error recovery strategies\n * \n * @author Choices Platform Team\n * @created 2025-10-26\n * @version 1.0.0\n * @since 1.0.0\n */\n\nimport { logger } from '@/lib/utils/logger';\n\nexport interface ErrorDetails {\n  code: string;\n  message: string;\n  details?: Record<string, any>;\n  timestamp: string;\n  stack?: string;\n}\n\nexport interface UserErrorResponse {\n  error: string;\n  message: string;\n  code?: string;\n  timestamp: string;\n}\n\n/**\n * Base error class for application errors\n */\nexport class AppError extends Error {\n  public readonly code: string;\n  public readonly statusCode: number;\n  public readonly isOperational: boolean;\n  public readonly details?: Record<string, any>;\n\n  constructor(\n    message: string,\n    code: string = 'INTERNAL_ERROR',\n    statusCode: number = 500,\n    isOperational: boolean = true,\n    details?: Record<string, any>\n  ) {\n    super(message);\n    this.name = this.constructor.name;\n    this.code = code;\n    this.statusCode = statusCode;\n    this.isOperational = isOperational;\n    this.details = details;\n\n    Error.captureStackTrace(this, this.constructor);\n  }\n}\n\n/**\n * Validation error class\n */\nexport class ValidationError extends AppError {\n  constructor(message: string, details?: Record<string, any>) {\n    super(message, 'VALIDATION_ERROR', 400, true, details);\n  }\n}\n\n/**\n * Authentication error class\n */\nexport class AuthenticationError extends AppError {\n  constructor(message: string = 'Authentication required', details?: Record<string, any>) {\n    super(message, 'AUTHENTICATION_ERROR', 401, true, details);\n  }\n}\n\n/**\n * Authorization error class\n */\nexport class AuthorizationError extends AppError {\n  constructor(message: string = 'Access denied', details?: Record<string, any>) {\n    super(message, 'AUTHORIZATION_ERROR', 403, true, details);\n  }\n}\n\n/**\n * Not found error class\n */\nexport class NotFoundError extends AppError {\n  constructor(message: string = 'Resource not found', details?: Record<string, any>) {\n    super(message, 'NOT_FOUND_ERROR', 404, true, details);\n  }\n}\n\n/**\n * Conflict error class\n */\nexport class ConflictError extends AppError {\n  constructor(message: string = 'Resource conflict', details?: Record<string, any>) {\n    super(message, 'CONFLICT_ERROR', 409, true, details);\n  }\n}\n\n/**\n * Rate limit error class\n */\nexport class RateLimitError extends AppError {\n  constructor(message: string = 'Rate limit exceeded', details?: Record<string, any>) {\n    super(message, 'RATE_LIMIT_ERROR', 429, true, details);\n  }\n}\n\n/**\n * Database error class\n */\nexport class DatabaseError extends AppError {\n  constructor(message: string = 'Database operation failed', details?: Record<string, any>) {\n    super(message, 'DATABASE_ERROR', 500, true, details);\n  }\n}\n\n/**\n * External service error class\n */\nexport class ExternalServiceError extends AppError {\n  constructor(message: string = 'External service error', details?: Record<string, any>) {\n    super(message, 'EXTERNAL_SERVICE_ERROR', 502, true, details);\n  }\n}\n\n/**\n * Handle error and return appropriate response\n */\nexport function handleError(error: unknown): {\n  statusCode: number;\n  response: UserErrorResponse;\n  logLevel: 'error' | 'warn' | 'info';\n} {\n  let appError: AppError;\n  let logLevel: 'error' | 'warn' | 'info' = 'error';\n\n  if (error instanceof AppError) {\n    appError = error;\n    logLevel = appError.isOperational ? 'warn' : 'error';\n  } else if (error instanceof Error) {\n    appError = new AppError(\n      'An unexpected error occurred',\n      'UNEXPECTED_ERROR',\n      500,\n      false,\n      { originalError: error.message }\n    );\n  } else {\n    appError = new AppError(\n      'An unknown error occurred',\n      'UNKNOWN_ERROR',\n      500,\n      false,\n      { originalError: String(error) }\n    );\n  }\n\n  const response: UserErrorResponse = {\n    error: appError.message,\n    message: getUserMessage(appError),\n    code: appError.code,\n    timestamp: new Date().toISOString()\n  };\n\n  // Log the error\n  const logData = {\n    code: appError.code,\n    message: appError.message,\n    statusCode: appError.statusCode,\n    isOperational: appError.isOperational,\n    details: appError.details,\n    stack: appError.stack\n  };\n\n  if (logLevel === 'error') {\n    logger.error('Application error occurred', logData);\n  } else if (logLevel === 'warn') {\n    logger.warn('Operational error occurred', logData);\n  } else {\n    logger.info('Error handled', logData);\n  }\n\n  return {\n    statusCode: appError.statusCode,\n    response,\n    logLevel\n  };\n}\n\n/**\n * Get user-friendly error message\n */\nexport function getUserMessage(error: AppError): string {\n  const userMessages: Record<string, string> = {\n    VALIDATION_ERROR: 'Please check your input and try again',\n    AUTHENTICATION_ERROR: 'Please log in to continue',\n    AUTHORIZATION_ERROR: 'You do not have permission to perform this action',\n    NOT_FOUND_ERROR: 'The requested resource was not found',\n    CONFLICT_ERROR: 'This action conflicts with existing data',\n    RATE_LIMIT_ERROR: 'Too many requests. Please try again later',\n    DATABASE_ERROR: 'A temporary error occurred. Please try again',\n    EXTERNAL_SERVICE_ERROR: 'A service is temporarily unavailable',\n    INTERNAL_ERROR: 'An unexpected error occurred. Please try again',\n    UNEXPECTED_ERROR: 'An unexpected error occurred. Please try again',\n    UNKNOWN_ERROR: 'An unknown error occurred. Please try again'\n  };\n\n  return userMessages[error.code] || 'An error occurred. Please try again';\n}\n\n/**\n * Get HTTP status code for error\n */\nexport function getHttpStatus(error: AppError): number {\n  return error.statusCode;\n}\n\n/**\n * Check if error is operational (expected) or programming error\n */\nexport function isOperationalError(error: unknown): boolean {\n  return error instanceof AppError && error.isOperational;\n}\n\n/**\n * Create error response for API routes\n */\nexport function createErrorResponse(error: unknown): Response {\n  const { statusCode, response } = handleError(error);\n  \n  return new Response(\n    JSON.stringify(response),\n    {\n      status: statusCode,\n      headers: {\n        'Content-Type': 'application/json',\n        'Cache-Control': 'no-cache'\n      }\n    }\n  );\n}\n\n/**\n * Create error response for server actions\n */\nexport function createServerActionError(error: unknown): {\n  success: false;\n  error: string;\n  message: string;\n  code?: string;\n  timestamp: string;\n} {\n  const { response } = handleError(error);\n  \n  return {\n    success: false,\n    error: response.error,\n    message: response.message,\n    code: response.code,\n    timestamp: response.timestamp\n  };\n}\n\n/**\n * Error recovery strategies\n */\nexport const errorRecovery = {\n  /**\n   * Retry operation with exponential backoff\n   */\n  async retryWithBackoff<T>(\n    operation: () => Promise<T>,\n    maxRetries: number = 3,\n    baseDelay: number = 1000\n  ): Promise<T> {\n    let lastError: unknown;\n    \n    for (let attempt = 0; attempt <= maxRetries; attempt++) {\n      try {\n        return await operation();\n      } catch (error) {\n        lastError = error;\n        \n        if (attempt === maxRetries) {\n          break;\n        }\n        \n        const delay = baseDelay * Math.pow(2, attempt);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        \n        logger.warn(`Operation failed, retrying in ${delay}ms`, {\n          attempt: attempt + 1,\n          maxRetries,\n          error: error instanceof Error ? error.message : String(error)\n        });\n      }\n    }\n    \n    throw lastError;\n  },\n\n  /**\n   * Fallback to default value on error\n   */\n  async withFallback<T>(\n    operation: () => Promise<T>,\n    fallback: T\n  ): Promise<T> {\n    try {\n      return await operation();\n    } catch (error) {\n      logger.warn('Operation failed, using fallback', {\n        error: error instanceof Error ? error.message : String(error)\n      });\n      return fallback;\n    }\n  },\n\n  /**\n   * Circuit breaker pattern\n   */\n  createCircuitBreaker(\n    failureThreshold: number = 5,\n    timeout: number = 60000\n  ) {\n    let failures = 0;\n    let lastFailureTime = 0;\n    let state: 'CLOSED' | 'OPEN' | 'HALF_OPEN' = 'CLOSED';\n\n    return async <T>(operation: () => Promise<T>): Promise<T> => {\n      if (state === 'OPEN') {\n        if (Date.now() - lastFailureTime > timeout) {\n          state = 'HALF_OPEN';\n        } else {\n          throw new AppError('Circuit breaker is open', 'CIRCUIT_BREAKER_OPEN', 503);\n        }\n      }\n\n      try {\n        const result = await operation();\n        \n        if (state === 'HALF_OPEN') {\n          state = 'CLOSED';\n          failures = 0;\n        }\n        \n        return result;\n      } catch (error) {\n        failures++;\n        lastFailureTime = Date.now();\n        \n        if (failures >= failureThreshold) {\n          state = 'OPEN';\n        }\n        \n        throw error;\n      }\n    };\n  }\n};\n\nexport default {\n  handleError,\n  getUserMessage,\n  getHttpStatus,\n  isOperationalError,\n  createErrorResponse,\n  createServerActionError,\n  errorRecovery\n};"],"names":["AppError","AuthenticationError","AuthorizationError","ConflictError","DatabaseError","ExternalServiceError","NotFoundError","RateLimitError","ValidationError","createErrorResponse","createServerActionError","errorRecovery","getHttpStatus","getUserMessage","handleError","isOperationalError","Error","message","code","statusCode","isOperational","details","name","captureStackTrace","error","appError","logLevel","originalError","String","response","timestamp","Date","toISOString","logData","stack","logger","warn","info","userMessages","VALIDATION_ERROR","AUTHENTICATION_ERROR","AUTHORIZATION_ERROR","NOT_FOUND_ERROR","CONFLICT_ERROR","RATE_LIMIT_ERROR","DATABASE_ERROR","EXTERNAL_SERVICE_ERROR","INTERNAL_ERROR","UNEXPECTED_ERROR","UNKNOWN_ERROR","Response","JSON","stringify","status","headers","success","retryWithBackoff","operation","maxRetries","baseDelay","lastError","attempt","delay","Math","pow","Promise","resolve","setTimeout","withFallback","fallback","createCircuitBreaker","failureThreshold","timeout","failures","lastFailureTime","state","now","result"],"mappings":"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"}