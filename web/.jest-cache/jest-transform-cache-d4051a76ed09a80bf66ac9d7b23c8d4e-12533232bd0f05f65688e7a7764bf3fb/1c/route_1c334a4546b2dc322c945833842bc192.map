{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/app/api/contact/messages/route.ts"],"sourcesContent":["/**\n * Contact Messages API Endpoint\n * \n * Handles CRUD operations for contact messages between users and representatives.\n * Supports real-time messaging, message status updates, and delivery tracking.\n * \n * Created: January 23, 2025\n * Status: âœ… IMPLEMENTATION READY\n */\n\nimport { type NextRequest, NextResponse } from 'next/server';\nimport { getSupabaseServerClient } from '@/lib/supabase/server';\nimport { logger } from '@/lib/utils/logger';\nimport { rateLimiters } from '@/lib/security/rate-limit';\n\nexport const dynamic = 'force-dynamic';\n\n// ============================================================================\n// TYPES\n// ============================================================================\n\ninterface CreateMessageRequest {\n  threadId?: string;\n  representativeId: string;\n  subject: string;\n  content: string;\n  priority?: 'low' | 'normal' | 'high' | 'urgent';\n  messageType?: 'text' | 'email' | 'attachment';\n  attachments?: Array<{\n    name: string;\n    size: number;\n    type: string;\n    url?: string;\n  }>;\n}\n\ninterface MessageResponse {\n  id: string;\n  threadId: string;\n  senderId: string;\n  recipientId: string;\n  content: string;\n  subject: string;\n  status: string;\n  priority: string;\n  createdAt: string;\n  attachments: any[];\n  metadata: any;\n}\n\n// ============================================================================\n// POST - Create New Message\n// ============================================================================\n\nexport async function POST(request: NextRequest) {\n  const startTime = Date.now();\n  \n  try {\n    // Rate limiting: 10 messages per minute per user\n    const ip = request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown';\n    const rateLimitResult = await rateLimiters.contact.checkLimit(`contact:${ip}`);\n    if (!rateLimitResult.allowed) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Too many messages. Please wait before sending another message.',\n          retryAfter: Math.ceil((rateLimitResult.resetTime - Date.now()) / 1000)\n        },\n        { status: 429 }\n      );\n    }\n\n    // Get Supabase client\n    const supabase = await getSupabaseServerClient();\n    if (!supabase) {\n      logger.error('Supabase client not available');\n      return NextResponse.json(\n        { success: false, error: 'Database connection not available' },\n        { status: 500 }\n      );\n    }\n\n    // Authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    if (authError || !user) {\n      logger.warn('Unauthenticated message creation attempt');\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    // Parse request body\n    const body: CreateMessageRequest = await request.json();\n    const {\n      threadId,\n      representativeId,\n      subject,\n      content,\n      priority = 'normal',\n      messageType = 'text',\n      attachments = []\n    } = body;\n\n    // Validate required fields\n    if (!representativeId || !subject || !content) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Representative ID, subject, and content are required' \n        },\n        { status: 400 }\n      );\n    }\n\n    // Validate content length\n    if (content.length > 10000) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Message content is too long (max 10,000 characters)' \n        },\n        { status: 400 }\n      );\n    }\n\n    // Check if representative exists (representativeId is database primary key)\n    const { data: representative, error: repError } = await supabase\n      .from('representatives_core')\n      .select('id, name, office')\n      .eq('id', parseInt(representativeId))\n      .single();\n\n    if (repError || !representative) {\n      logger.warn('Invalid representative ID', { representativeId, error: repError });\n      return NextResponse.json(\n        { success: false, error: 'Representative not found' },\n        { status: 404 }\n      );\n    }\n\n    // Generate a thread ID for grouping related messages\n    const finalThreadId = threadId || crypto.randomUUID();\n\n    // Create message\n    const { data: message, error: messageError } = await supabase\n      .from('contact_messages')\n      .insert({\n        id: crypto.randomUUID(),\n        user_id: user.id,\n        representative_id: parseInt(representativeId),\n        message: content,\n        subject: subject || 'Contact Message',\n        priority: priority || 'normal',\n        status: 'sent',\n        metadata: {\n          user_agent: request.headers.get('user-agent'),\n          ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip'),\n          created_via: 'api'\n        }\n      })\n      .select(`\n        id,\n        user_id,\n        representative_id,\n        message,\n        subject,\n        status,\n        priority,\n        created_at,\n        updated_at\n      `)\n      .single();\n\n    if (messageError || !message) {\n      logger.error('Failed to create message', new Error(messageError?.message || 'Unknown error'), { error: messageError });\n      return NextResponse.json(\n        { success: false, error: 'Failed to send message' },\n        { status: 500 }\n      );\n    }\n\n    // Log delivery attempt\n    await supabase\n      .from('message_delivery_logs')\n      .insert({\n        message_id: message.id,\n        delivery_status: 'sent',\n        delivery_timestamp: new Date().toISOString(),\n        retry_count: 1\n      });\n\n    // Send notification to representative (if they have notifications enabled)\n    await sendRepresentativeNotification(supabase, message, representative);\n\n    const responseTime = Date.now() - startTime;\n    logger.info('Message created successfully', {\n      messageId: message.id,\n      threadId: finalThreadId,\n      userId: user.id,\n      representativeId,\n      responseTime\n    });\n\n    return NextResponse.json({\n      success: true,\n      message: {\n        id: message.id,\n        userId: message.user_id,\n        representativeId: message.representative_id,\n        message: message.message,\n        subject: message.subject,\n        status: message.status,\n        priority: message.priority,\n        createdAt: message.created_at,\n        updatedAt: message.updated_at\n      },\n      threadId: finalThreadId,\n      responseTime\n    });\n\n  } catch (error) {\n    const err = error instanceof Error ? error : new Error(String(error));\n    logger.error('Error creating message:', new Error(err?.message || 'Unknown error'), { error: err });\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// ============================================================================\n// GET - Retrieve User Messages\n// ============================================================================\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Get Supabase client\n    const supabase = await getSupabaseServerClient();\n    if (!supabase) {\n      return NextResponse.json(\n        { success: false, error: 'Database connection not available' },\n        { status: 500 }\n      );\n    }\n\n    // Authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    if (authError || !user) {\n      return NextResponse.json(\n        { success: false, error: 'Authentication required' },\n        { status: 401 }\n      );\n    }\n\n    // Parse query parameters\n    const { searchParams } = new URL(request.url);\n    const threadId = searchParams.get('threadId');\n    const status = searchParams.get('status');\n    const priority = searchParams.get('priority');\n    const limit = parseInt(searchParams.get('limit') || '50');\n    const offset = parseInt(searchParams.get('offset') || '0');\n\n    // Build query\n    let query = supabase\n      .from('contact_messages')\n      .select(`\n        id,\n        thread_id,\n        sender_id,\n        recipient_id,\n        content,\n        subject,\n        status,\n        priority,\n        message_type,\n        attachments,\n        created_at,\n        read_at,\n        replied_at,\n        metadata,\n        contact_threads!inner(\n          id,\n          subject,\n          status,\n          priority,\n          representatives_core!inner(\n            id,\n            name,\n            office,\n            party\n          )\n        )\n      `)\n      .or(`sender_id.eq.${user.id},recipient_id.in.(select id from representatives_core where user_id = ${user.id})`)\n      .order('created_at', { ascending: false })\n      .range(offset, offset + limit - 1);\n\n    // Apply filters\n    if (threadId) {\n      query = query.eq('thread_id', threadId);\n    }\n    if (status) {\n      query = query.eq('status', status);\n    }\n    if (priority) {\n      query = query.eq('priority', priority);\n    }\n\n    const { data: messages, error: messagesError } = await query;\n\n    if (messagesError) {\n      logger.error('Failed to fetch messages', new Error(messagesError?.message || 'Unknown error'), { error: messagesError });\n      return NextResponse.json(\n        { success: false, error: 'Failed to fetch messages' },\n        { status: 500 }\n      );\n    }\n\n    // Get total count for pagination\n    const { count: totalCount } = await supabase\n      .from('contact_messages')\n      .select('*', { count: 'exact', head: true })\n      .or(`sender_id.eq.${user.id},recipient_id.in.(select id from representatives_core where user_id = ${user.id})`);\n\n    return NextResponse.json({\n      success: true,\n      messages: messages || [],\n      pagination: {\n        total: totalCount || 0,\n        limit,\n        offset,\n        hasMore: (totalCount || 0) > offset + limit\n      }\n    });\n\n  } catch (error) {\n    const err = error instanceof Error ? error : new Error(String(error));\n    logger.error('Error fetching messages:', new Error(err?.message || 'Unknown error'), { error: err });\n    return NextResponse.json(\n      { success: false, error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\nasync function sendRepresentativeNotification(\n  supabase: any,\n  message: any,\n  representative: any\n) {\n  try {\n    // Check if representative has notifications enabled using new schema\n    const { data: userProfile } = await supabase\n      .from('user_profiles')\n      .select('privacy_settings')\n      .eq('user_id', representative.user_id)\n      .single();\n\n    const contactMessagesEnabled = userProfile?.privacy_settings?.contact_messages !== false;\n\n    if (contactMessagesEnabled) {\n      // Create notification\n      await supabase\n        .from('admin_notifications')\n        .insert({\n          type: 'new_message',\n          title: 'New Message from Constituent',\n          message: `You have received a new message from a constituent regarding: ${message.subject}`,\n          data: {\n            messageId: message.id,\n            threadId: message.thread_id,\n            senderId: message.sender_id,\n            priority: message.priority\n          },\n          user_id: representative.user_id,\n          status: 'unread'\n        });\n\n      logger.info('Representative notification sent', {\n        representativeId: representative.id,\n        messageId: message.id\n      });\n    }\n  } catch (error) {\n    logger.error('Failed to send representative notification', new Error((error as Error)?.message || 'Unknown error'), { error });\n    // Don't fail the message creation if notification fails\n  }\n}\n"],"names":["GET","POST","dynamic","request","startTime","Date","now","ip","headers","get","rateLimitResult","rateLimiters","contact","checkLimit","allowed","NextResponse","json","success","error","retryAfter","Math","ceil","resetTime","status","supabase","getSupabaseServerClient","logger","data","user","authError","auth","getUser","warn","body","threadId","representativeId","subject","content","priority","messageType","attachments","length","representative","repError","from","select","eq","parseInt","single","finalThreadId","crypto","randomUUID","message","messageError","insert","id","user_id","representative_id","metadata","user_agent","ip_address","created_via","Error","message_id","delivery_status","delivery_timestamp","toISOString","retry_count","sendRepresentativeNotification","responseTime","info","messageId","userId","createdAt","created_at","updatedAt","updated_at","err","String","searchParams","URL","url","limit","offset","query","or","order","ascending","range","messages","messagesError","count","totalCount","head","pagination","total","hasMore","userProfile","contactMessagesEnabled","privacy_settings","contact_messages","type","title","thread_id","senderId","sender_id"],"mappings":"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"}