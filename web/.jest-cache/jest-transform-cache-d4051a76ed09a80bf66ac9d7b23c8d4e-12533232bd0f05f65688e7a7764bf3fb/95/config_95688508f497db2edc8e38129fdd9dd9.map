{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/security/config.ts"],"sourcesContent":["/**\n * Security Configuration\n * Centralized security settings and policies\n * \n * Features:\n * - CSP (Content Security Policy) configuration\n * - Security headers configuration\n * - Rate limiting settings\n * - Request validation rules\n * - Privacy and data protection settings\n * \n * Created: 2025-08-27\n * Status: Critical security enhancement\n */\n\n// E2E Test Detection\nexport const IS_E2E =\n  process.env.NODE_ENV === 'test' ||\n  process.env.E2E === '1' ||\n  process.env.PLAYWRIGHT === '1';\n\nexport interface SecurityConfig {\n  csp: CSPConfig\n  headers: SecurityHeaders\n  rateLimit: RateLimitConfig\n  validation: ValidationConfig\n  privacy: PrivacyConfig\n}\n\nexport interface CSPConfig {\n  'default-src': string[]\n  'script-src': string[]\n  'style-src': string[]\n  'font-src': string[]\n  'img-src': string[]\n  'connect-src': string[]\n  'frame-src': string[]\n  'object-src': string[]\n  'base-uri': string[]\n  'form-action': string[]\n  'frame-ancestors': string[]\n  'upgrade-insecure-requests'?: string[]\n}\n\nexport interface SecurityHeaders {\n  'X-Frame-Options': string\n  'X-Content-Type-Options': string\n  'X-XSS-Protection': string\n  'Referrer-Policy': string\n  'Permissions-Policy': string\n  'Cross-Origin-Embedder-Policy': string\n  'Cross-Origin-Opener-Policy': string\n  'Cross-Origin-Resource-Policy': string\n}\n\nexport interface RateLimitConfig {\n  enabled: boolean\n  windowMs: number\n  maxRequests: number\n  sensitiveEndpoints: Record<string, number>\n  e2eBypassHeader: string\n}\n\nexport interface ValidationConfig {\n  maxContentLength: number\n  allowedContentTypes: string[]\n  suspiciousPatterns: RegExp[]\n  blockedUserAgents: string[]\n}\n\nexport interface PrivacyConfig {\n  dataRetentionDays: number\n  anonymizeIPs: boolean\n  logSensitiveData: boolean\n  enableDifferentialPrivacy: boolean\n}\n\n/**\n * Production security configuration\n */\nexport const PRODUCTION_SECURITY_CONFIG: SecurityConfig = {\n  csp: {\n    'default-src': [\"'self'\"],\n    'script-src': [\n      \"'self'\",\n      \"'unsafe-inline'\", // Required for Next.js\n      'https://cdn.jsdelivr.net',\n    ],\n    'style-src': [\n      \"'self'\",\n      \"'unsafe-inline'\", // Required for Next.js\n      'https://fonts.googleapis.com',\n    ],\n    'font-src': [\n      \"'self'\",\n      'https://fonts.gstatic.com',\n      'data:',\n    ],\n    'img-src': [\n      \"'self'\",\n      'data:',\n      'https:',\n      'blob:',\n    ],\n    'connect-src': [\n      \"'self'\",\n      'https://*.supabase.co',\n      'https://api.choices.app',\n      'wss://*.supabase.co',\n    ],\n    'frame-src': [\"'none'\"],\n    'object-src': [\"'none'\"],\n    'base-uri': [\"'self'\"],\n    'form-action': [\"'self'\"],\n    'frame-ancestors': [\"'none'\"],\n    'upgrade-insecure-requests': [],\n  },\n  \n  headers: {\n    'X-Frame-Options': 'DENY',\n    'X-Content-Type-Options': 'nosniff',\n    'X-XSS-Protection': '1; mode=block',\n    'Referrer-Policy': 'strict-origin-when-cross-origin',\n    'Permissions-Policy': 'camera=(), microphone=(), geolocation=()',\n    'Cross-Origin-Embedder-Policy': 'require-corp',\n    'Cross-Origin-Opener-Policy': 'same-origin',\n    'Cross-Origin-Resource-Policy': 'same-origin',\n  },\n  \n  rateLimit: {\n    enabled: !IS_E2E, // Disabled in E2E tests\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    maxRequests: 100,\n    sensitiveEndpoints: IS_E2E ? {} : {\n      '/api/auth': 10,\n      '/register': 5,\n      '/login': 10,\n      '/api/admin': 20,\n    },\n    e2eBypassHeader: 'x-e2e-bypass'\n  },\n  \n  validation: {\n    maxContentLength: 1024 * 1024, // 1MB\n    allowedContentTypes: [\n      'application/json',\n      'application/x-www-form-urlencoded',\n      'multipart/form-data',\n    ],\n    suspiciousPatterns: [\n      /<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, // Script tags\n      /javascript:/gi, // JavaScript protocol\n      /on\\w+\\s*=/gi, // Event handlers\n      /<iframe\\b[^<]*(?:(?!<\\/iframe>)<[^<]*)*<\\/iframe>/gi, // Iframe tags\n    ],\n    blockedUserAgents: [\n      'sqlmap',\n      'nikto',\n      'nmap',\n      'scanner',\n      'bot',\n      'crawler',\n    ],\n  },\n  \n  privacy: {\n    dataRetentionDays: 90,\n    anonymizeIPs: true,\n    logSensitiveData: false,\n    enableDifferentialPrivacy: true,\n  },\n}\n\n/**\n * Development security configuration (more permissive)\n */\nexport const DEVELOPMENT_SECURITY_CONFIG: SecurityConfig = Object.assign({}, PRODUCTION_SECURITY_CONFIG, {\n  csp: {\n    ...PRODUCTION_SECURITY_CONFIG.csp,\n    'script-src': [\n      ...PRODUCTION_SECURITY_CONFIG.csp['script-src'],\n      \"'unsafe-eval'\", // Required for Next.js development\n    ],\n  },\n  rateLimit: {\n    ...PRODUCTION_SECURITY_CONFIG.rateLimit,\n    maxRequests: 1000, // More permissive in development\n  },\n  privacy: {\n    ...PRODUCTION_SECURITY_CONFIG.privacy,\n    logSensitiveData: true, // More logging in development\n  },\n})\n\n/**\n * Get security configuration based on environment\n */\nexport function getSecurityConfig(): SecurityConfig {\n  return process.env.NODE_ENV === 'production' \n    ? PRODUCTION_SECURITY_CONFIG \n    : DEVELOPMENT_SECURITY_CONFIG\n}\n\n/**\n * Build CSP header string from configuration\n */\nexport function buildCSPHeader(config: CSPConfig): string {\n  const directives = Object.entries(config)\n    .map(([directive, sources]) => {\n      if (Array.isArray(sources) && sources.length > 0) {\n        return `${directive} ${sources.join(' ')}`\n      } else if (sources.length === 0) {\n        return directive\n      }\n      return ''\n    })\n    .filter(Boolean)\n    .join('; ')\n  \n  return directives\n}\n\n/**\n * Validate content against security patterns\n */\nexport function validateContent(\n  content: string, \n  config: ValidationConfig\n): { valid: boolean; reason?: string } {\n  // Check content length\n  if (content.length > config.maxContentLength) {\n    return { valid: false, reason: 'Content too long' }\n  }\n  \n  // Check for suspicious patterns\n  for (const pattern of config.suspiciousPatterns) {\n    if (pattern.test(content)) {\n      return { valid: false, reason: 'Suspicious content detected' }\n    }\n  }\n  \n  return { valid: true }\n}\n\n/**\n * Check if user agent is blocked\n */\nexport function isBlockedUserAgent(\n  userAgent: string, \n  config: ValidationConfig\n): boolean {\n  const lowerUA = userAgent.toLowerCase()\n  return config.blockedUserAgents.some(blocked => \n    lowerUA.includes(blocked.toLowerCase())\n  )\n}\n\n/**\n * Anonymize IP address for privacy\n */\nexport function anonymizeIP(ip: string): string {\n  if (!ip || ip === 'unknown') return 'unknown'\n  \n  // IPv4: 192.168.1.1 -> 192.168.1.0\n  if (ip.includes('.')) {\n    const parts = ip.split('.')\n    if (parts.length === 4) {\n      return `${parts[0]}.${parts[1]}.${parts[2]}.0`\n    }\n  }\n  \n  // IPv6: 2001:db8::1 -> 2001:db8::\n  if (ip.includes(':')) {\n    const parts = ip.split(':')\n    if (parts.length >= 4) {\n      return `${parts[0]}:${parts[1]}:${parts[2]}::`\n    }\n  }\n  \n  return ip\n}\n"],"names":["DEVELOPMENT_SECURITY_CONFIG","IS_E2E","PRODUCTION_SECURITY_CONFIG","anonymizeIP","buildCSPHeader","getSecurityConfig","isBlockedUserAgent","validateContent","process","env","NODE_ENV","E2E","PLAYWRIGHT","csp","headers","rateLimit","enabled","windowMs","maxRequests","sensitiveEndpoints","e2eBypassHeader","validation","maxContentLength","allowedContentTypes","suspiciousPatterns","blockedUserAgents","privacy","dataRetentionDays","anonymizeIPs","logSensitiveData","enableDifferentialPrivacy","Object","assign","config","directives","entries","map","directive","sources","Array","isArray","length","join","filter","Boolean","content","valid","reason","pattern","test","userAgent","lowerUA","toLowerCase","some","blocked","includes","ip","parts","split"],"mappings":"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"}