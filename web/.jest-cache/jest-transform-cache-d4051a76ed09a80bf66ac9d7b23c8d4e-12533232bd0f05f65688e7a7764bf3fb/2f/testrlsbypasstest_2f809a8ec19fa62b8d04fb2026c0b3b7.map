{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/integration/test-rls-bypass.test.ts"],"sourcesContent":["import { describe, it, expect } from '@jest/globals';\n\n/**\n * Test RLS Bypass\n * \n * Tests different approaches to bypass RLS for service role\n * \n * Created: January 27, 2025\n * Status: ‚úÖ PRODUCTION READY\n */\n\ndescribe('Test RLS Bypass', () => {\n  it('should test RLS bypass with different client configurations', async () => {\n    const { createClient } = await import('@supabase/supabase-js');\n    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n    \n    if (!supabaseUrl || !serviceKey) {\n      throw new Error('Supabase credentials not found');\n    }\n    \n    console.log('üîç Testing RLS bypass approaches...');\n    \n    // Test 1: Standard service role client\n    console.log('üîç Test 1: Standard service role client');\n    const standardClient = createClient(supabaseUrl, serviceKey);\n    \n    const { data: standardData, error: standardError } = await standardClient\n      .from('polls')\n      .select('id, title')\n      .limit(1);\n    \n    console.log('Standard client result:', { standardData, standardError });\n    \n    // Test 2: Service role with explicit RLS bypass\n    console.log('üîç Test 2: Service role with explicit RLS bypass');\n    const bypassClient = createClient(supabaseUrl, serviceKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n        detectSessionInUrl: false\n      },\n      db: {\n        schema: 'public'\n      }\n    });\n    \n    const { data: bypassData, error: bypassError } = await bypassClient\n      .from('polls')\n      .select('id, title')\n      .limit(1);\n    \n    console.log('Bypass client result:', { bypassData, bypassError });\n    \n    // Test 3: Try with different schema\n    console.log('üîç Test 3: Different schema approach');\n    const schemaClient = createClient(supabaseUrl, serviceKey, {\n      db: {\n        schema: 'public'\n      }\n    });\n    \n    const { data: schemaData, error: schemaError } = await schemaClient\n      .from('polls')\n      .select('id, title')\n      .limit(1);\n    \n    console.log('Schema client result:', { schemaData, schemaError });\n    \n    // Test 4: Try with raw SQL\n    console.log('üîç Test 4: Raw SQL approach');\n    const { data: sqlData, error: sqlError } = await standardClient\n      .rpc('get_polls_count');\n    \n    console.log('SQL client result:', { sqlData, sqlError });\n    \n    // Test 5: Try to get table info\n    console.log('üîç Test 5: Table info approach');\n    const { data: tableData, error: tableError } = await standardClient\n      .from('information_schema.tables')\n      .select('table_name')\n      .eq('table_schema', 'public')\n      .eq('table_name', 'polls');\n    \n    console.log('Table info result:', { tableData, tableError });\n    \n    // Test 6: Try to get column info\n    console.log('üîç Test 6: Column info approach');\n    const { data: columnData, error: columnError } = await standardClient\n      .from('information_schema.columns')\n      .select('column_name, data_type')\n      .eq('table_schema', 'public')\n      .eq('table_name', 'polls')\n      .limit(5);\n    \n    console.log('Column info result:', { columnData, columnError });\n    \n    // Test 7: Try to get RLS info\n    console.log('üîç Test 7: RLS info approach');\n    const { data: rlsData, error: rlsError } = await standardClient\n      .from('pg_policies')\n      .select('*')\n      .eq('tablename', 'polls');\n    \n    console.log('RLS info result:', { rlsData, rlsError });\n    \n    // Test 8: Try to get current user\n    console.log('üîç Test 8: Current user approach');\n    const { data: userData, error: userError } = await standardClient\n      .rpc('current_user');\n    \n    console.log('Current user result:', { userData, userError });\n    \n    // Test 9: Try to get current role\n    console.log('üîç Test 9: Current role approach');\n    const { data: roleData, error: roleError } = await standardClient\n      .rpc('current_role');\n    \n    console.log('Current role result:', { roleData, roleError });\n    \n    // Test 10: Try to get session info\n    console.log('üîç Test 10: Session info approach');\n    const { data: sessionData, error: sessionError } = await standardClient\n      .rpc('session_user');\n    \n    console.log('Session info result:', { sessionData, sessionError });\n    \n    // The test should pass if we can at least connect\n    expect(standardError).toBeNull();\n    expect(bypassError).toBeNull();\n    expect(schemaError).toBeNull();\n    expect(sqlError).toBeNull();\n    expect(tableError).toBeNull();\n    expect(columnError).toBeNull();\n    expect(rlsError).toBeNull();\n    expect(userError).toBeNull();\n    expect(roleError).toBeNull();\n    expect(sessionError).toBeNull();\n  });\n});\n"],"names":["describe","it","createClient","supabaseUrl","process","env","SUPABASE_URL","NEXT_PUBLIC_SUPABASE_URL","serviceKey","SUPABASE_SERVICE_ROLE_KEY","Error","console","log","standardClient","data","standardData","error","standardError","from","select","limit","bypassClient","auth","autoRefreshToken","persistSession","detectSessionInUrl","db","schema","bypassData","bypassError","schemaClient","schemaData","schemaError","sqlData","sqlError","rpc","tableData","tableError","eq","columnData","columnError","rlsData","rlsError","userData","userError","roleData","roleError","sessionData","sessionError","expect","toBeNull"],"mappings":"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"}