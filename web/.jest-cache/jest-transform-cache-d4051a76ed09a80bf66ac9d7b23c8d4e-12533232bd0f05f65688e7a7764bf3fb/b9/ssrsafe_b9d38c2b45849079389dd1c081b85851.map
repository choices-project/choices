{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/utils/ssr-safe.ts"],"sourcesContent":["/**\n * SSR-Safe Utilities\n * \n * This file provides utilities to safely handle browser-only code in Next.js SSR environments.\n * It ensures that browser globals are only accessed on the client side.\n * \n * IMPORTANT: This is the ONLY approved way to access browser APIs in this codebase.\n * Direct access to window, document, navigator, etc. is forbidden in server-side code.\n * \n * This file is safe to import from both server and client code.\n * It doesn't export DOM types in signatures, making it compatible with server-only TypeScript configs.\n */\n\n// Shared, importable from server and client. No DOM types in signatures.\nexport const isBrowser = (): boolean => typeof window !== \"undefined\";\nexport const isServer  = (): boolean => !isBrowser();\n\nexport function browserOnly<T>(fn: () => T, fallback?: T): T | undefined {\n  if (!isBrowser()) return fallback;\n  try { return fn(); } catch (e) { \n    // Use console.warn for shared utility - logger not available in all contexts\n    console.warn(\"browserOnly failed:\", e); \n    return fallback; \n  }\n}\n\nexport function serverOnly<T>(fn: () => T, fallback?: T): T | undefined {\n  if (!isServer()) return fallback;\n  try { return fn(); } catch (e) { \n    // Use console.warn for shared utility - logger not available in all contexts\n    console.warn(\"serverOnly failed:\", e); \n    return fallback; \n  }\n}\n\n// Type-safe browser API access with proper type guards\ninterface BrowserWindow {\n  localStorage?: Storage;\n  sessionStorage?: Storage;\n  screen?: { width: number; height: number };\n  innerWidth?: number;\n  innerHeight?: number;\n  location?: { href: string; reload(): void; origin?: string };\n  URL?: {\n    createObjectURL?: (blob: Blob) => string;\n    revokeObjectURL?: (url: string) => void;\n  };\n  gtag?: (command: string, eventName: string, parameters?: Record<string, any>) => void;\n}\n\ninterface BrowserDocument {\n  createElement?: (tagName: string) => HTMLElement;\n  body?: {\n    appendChild?: (child: HTMLElement) => void;\n    removeChild?: (child: HTMLElement) => void;\n  };\n}\n\ninterface BrowserNavigator {\n  userAgent?: string;\n  clipboard?: {\n    writeText?: (text: string) => Promise<void>;\n  };\n}\n\n// Type guards for browser objects\nfunction isBrowserWindow(obj: unknown): obj is BrowserWindow {\n  return typeof obj === 'object' && obj !== null && 'localStorage' in obj;\n}\n\nfunction isBrowserDocument(obj: unknown): obj is BrowserDocument {\n  return typeof obj === 'object' && obj !== null;\n}\n\nfunction isBrowserNavigator(obj: unknown): obj is BrowserNavigator {\n  return typeof obj === 'object' && obj !== null && 'userAgent' in obj;\n}\n\nexport function safeWindow<T>(fn: (w: BrowserWindow) => T, fallback?: T): T | undefined {\n  return browserOnly(() => {\n    if (isBrowserWindow(window)) {\n      return fn(window);\n    }\n    throw new Error('window is not available or has unexpected shape');\n  }, fallback);\n}\n\nexport function safeDocument<T>(fn: (d: BrowserDocument) => T, fallback?: T): T | undefined {\n  return browserOnly(() => {\n    if (isBrowserDocument(document)) {\n      return fn(document);\n    }\n    throw new Error('document is not available or has unexpected shape');\n  }, fallback);\n}\n\nexport function safeNavigator<T>(fn: (n: BrowserNavigator) => T, fallback?: T): T | undefined {\n  return browserOnly(() => {\n    if (isBrowserNavigator(navigator)) {\n      return fn(navigator);\n    }\n    throw new Error('navigator is not available or has unexpected shape');\n  }, fallback);\n}\n\n// Storage (single, consistent API)\nfunction storage(kind: \"localStorage\" | \"sessionStorage\") {\n  return {\n    get: (key: string): string | null =>\n      safeWindow(w => {\n        const storage = w[kind];\n        return storage?.getItem?.(key) ?? null;\n      }, null) ?? null,\n    set: (key: string, value: string): boolean =>\n      safeWindow(w => { \n        const storage = w[kind];\n        storage?.setItem?.(key, value); \n        return true; \n      }, false) ?? false,\n    remove: (key: string): boolean =>\n      safeWindow(w => { \n        const storage = w[kind];\n        storage?.removeItem?.(key); \n        return true; \n      }, false) ?? false,\n    clear: (): boolean =>\n      safeWindow(w => { \n        const storage = w[kind];\n        storage?.clear?.(); \n        return true; \n      }, false) ?? false,\n  };\n}\nexport const safeLocalStorage   = storage(\"localStorage\");\nexport const safeSessionStorage = storage(\"sessionStorage\");\n\nexport const getUserAgent = (): string =>\n  safeNavigator(n => n.userAgent ?? \"unknown\", \"unknown\") ?? \"unknown\";\n\nexport const isMobileDevice = (): boolean =>\n  /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(getUserAgent());\n\nexport const getScreenDimensions = (): { width: number; height: number } | null =>\n  safeWindow(w => {\n    if (w.screen) {\n      return { width: w.screen.width, height: w.screen.height };\n    }\n    return null;\n  }, null) ?? null;\n\nexport const getViewportDimensions = (): { width: number; height: number } | null =>\n  safeWindow(w => {\n    if (w.innerWidth && w.innerHeight) {\n      return { width: w.innerWidth, height: w.innerHeight };\n    }\n    return null;\n  }, null) ?? null;\n\nexport const safeNavigate = (url: string): boolean =>\n  safeWindow(w => { \n    if (w.location) {\n      w.location.href = url; \n      return true; \n    }\n    return false;\n  }, false) ?? false;\n\nexport const safeReload = (): boolean =>\n  safeWindow(w => { \n    if (w.location) {\n      w.location.reload(); \n      return true; \n    }\n    return false;\n  }, false) ?? false;\n\n// Event listeners without DOM types in signature\ninterface EventTargetLike {\n  addEventListener(event: string, handler: unknown, options?: boolean | Record<string, unknown>): void;\n  removeEventListener(event: string, handler: unknown, options?: boolean | Record<string, unknown>): void;\n}\n\nfunction isEventTargetLike(obj: unknown): obj is EventTargetLike {\n  return typeof obj === 'object' && \n         obj !== null && \n         typeof (obj as EventTargetLike).addEventListener === 'function' &&\n         typeof (obj as EventTargetLike).removeEventListener === 'function';\n}\n\nexport function safeAddEventListener(\n  target: unknown,\n  event: string,\n  handler: unknown,\n  options?: boolean | Record<string, unknown>\n): boolean {\n  return browserOnly(() => {\n    if (isEventTargetLike(target)) {\n      target.addEventListener(event, handler, options);\n      return true;\n    }\n    return false;\n  }, false) ?? false;\n}\n\nexport function safeRemoveEventListener(\n  target: unknown,\n  event: string,\n  handler: unknown,\n  options?: boolean | Record<string, unknown>\n): boolean {\n  return browserOnly(() => {\n    if (isEventTargetLike(target)) {\n      target.removeEventListener(event, handler, options);\n      return true;\n    }\n    return false;\n  }, false) ?? false;\n}"],"names":["browserOnly","getScreenDimensions","getUserAgent","getViewportDimensions","isBrowser","isMobileDevice","isServer","safeAddEventListener","safeDocument","safeLocalStorage","safeNavigate","safeNavigator","safeReload","safeRemoveEventListener","safeSessionStorage","safeWindow","serverOnly","window","fn","fallback","e","console","warn","isBrowserWindow","obj","isBrowserDocument","isBrowserNavigator","Error","document","navigator","storage","kind","get","key","w","getItem","set","value","setItem","remove","removeItem","clear","n","userAgent","test","screen","width","height","innerWidth","innerHeight","url","location","href","reload","isEventTargetLike","addEventListener","removeEventListener","target","event","handler","options"],"mappings":"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"}