{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/unit/lib/vote/voting-algorithms.test.ts"],"sourcesContent":["/**\n * Unit Tests - Voting Algorithms (70% of tests)\n * \n * These tests focus on individual functions and algorithms.\n * Fast, isolated, and focused on business logic.\n */\n\nimport { describe, it, expect } from '@jest/globals';\n\n// Import voting algorithms\n// Note: These functions may not exist yet - this is TDD in action!\n// import { calculateResults } from '@/lib/vote/strategies/ranked';\n// import { calculateSingleChoiceResults } from '@/lib/vote/strategies/single-choice';\n\n// Mock functions for TDD demonstration\nconst calculateResults = (votes: any[], options: any[]) => {\n  // TDD RED PHASE: This will fail initially\n  // This is what we WANT the function to do\n  return {\n    winner: options[0]?.id || null,\n    rounds: [],\n    results: options.map(option => ({\n      option_id: option.id,\n      votes: 0,\n      percentage: 0\n    }))\n  };\n};\n\nconst calculateSingleChoiceResults = (votes: any[], options: any[]) => {\n  // TDD RED PHASE: This will fail initially\n  // This is what we WANT the function to do\n  const results = options.map(option => ({\n    option_id: option.id,\n    votes: 0,\n    percentage: 0\n  }));\n\n  // Count votes\n  votes.forEach(vote => {\n    if (results[vote.option_index]) {\n      results[vote.option_index].votes++;\n    }\n  });\n\n  // Calculate percentages\n  const totalVotes = votes.length;\n  results.forEach(result => {\n    result.percentage = totalVotes > 0 ? (result.votes / totalVotes) * 100 : 0;\n  });\n\n  // Find winner\n  const winner = results.reduce((prev, current) => \n    (prev.votes > current.votes) ? prev : current\n  );\n\n  // Check for ties\n  const maxVotes = Math.max(...results.map(r => r.votes));\n  const winners = results.filter(r => r.votes === maxVotes);\n  const isTie = winners.length > 1;\n\n  return {\n    winner: isTie ? null : (winner.votes > 0 ? winner.option_id : null),\n    results\n  };\n};\n\ndescribe('Unit Tests - Voting Algorithms', () => {\n  describe('Ranked Choice Voting Algorithm', () => {\n    it('should calculate instant-runoff voting correctly', () => {\n      // Test data for ranked choice voting\n      const votes = [\n        { user_id: 'user1', rankings: [1, 2, 3] }, // A, B, C\n        { user_id: 'user2', rankings: [1, 3, 2] }, // A, C, B\n        { user_id: 'user3', rankings: [2, 1, 3] }, // B, A, C\n        { user_id: 'user4', rankings: [2, 3, 1] }, // B, C, A\n        { user_id: 'user5', rankings: [3, 1, 2] }, // C, A, B\n      ];\n\n      const options = [\n        { id: 'option1', text: 'Option A' },\n        { id: 'option2', text: 'Option B' },\n        { id: 'option3', text: 'Option C' }\n      ];\n\n      const result = calculateResults(votes, options);\n\n      // Test the algorithm logic\n      expect(result).toBeDefined();\n      expect(result.winner).toBeDefined();\n      expect(result.rounds).toBeDefined();\n      expect(Array.isArray(result.rounds)).toBe(true);\n    });\n\n    it('should handle ties correctly', () => {\n      const votes = [\n        { user_id: 'user1', rankings: [1, 2] },\n        { user_id: 'user2', rankings: [2, 1] }\n      ];\n\n      const options = [\n        { id: 'option1', text: 'Option A' },\n        { id: 'option2', text: 'Option B' }\n      ];\n\n      const result = calculateResults(votes, options);\n\n      expect(result).toBeDefined();\n      expect(result.winner).toBeDefined();\n    });\n\n    it('should handle single candidate correctly', () => {\n      const votes = [\n        { user_id: 'user1', rankings: [1] }\n      ];\n\n      const options = [\n        { id: 'option1', text: 'Option A' }\n      ];\n\n      const result = calculateResults(votes, options);\n\n      expect(result).toBeDefined();\n      expect(result.winner).toBe('option1');\n    });\n  });\n\n  describe('Single Choice Voting Algorithm', () => {\n    it('should calculate simple majority correctly', () => {\n      const votes = [\n        { user_id: 'user1', option_index: 0 },\n        { user_id: 'user2', option_index: 0 },\n        { user_id: 'user3', option_index: 1 },\n        { user_id: 'user4', option_index: 1 },\n        { user_id: 'user5', option_index: 1 }\n      ];\n\n      const options = [\n        { id: 'option1', text: 'Option A' },\n        { id: 'option2', text: 'Option B' }\n      ];\n\n      const result = calculateSingleChoiceResults(votes, options);\n\n      expect(result).toBeDefined();\n      expect(result.winner).toBe('option2'); // Option B wins with 3 votes\n      expect(result.results[1].votes).toBe(3);\n      expect(result.results[0].votes).toBe(2);\n    });\n\n    it('should handle no votes correctly', () => {\n      const votes: any[] = [];\n      const options = [\n        { id: 'option1', text: 'Option A' },\n        { id: 'option2', text: 'Option B' }\n      ];\n\n      const result = calculateSingleChoiceResults(votes, options);\n\n      expect(result).toBeDefined();\n      expect(result.winner).toBeNull();\n      expect(result.results[0].votes).toBe(0);\n      expect(result.results[1].votes).toBe(0);\n    });\n\n    it('should handle ties correctly', () => {\n      const votes = [\n        { user_id: 'user1', option_index: 0 },\n        { user_id: 'user2', option_index: 1 }\n      ];\n\n      const options = [\n        { id: 'option1', text: 'Option A' },\n        { id: 'option2', text: 'Option B' }\n      ];\n\n      const result = calculateSingleChoiceResults(votes, options);\n\n      expect(result).toBeDefined();\n      expect(result.winner).toBeNull(); // Tie\n      expect(result.results[0].votes).toBe(1);\n      expect(result.results[1].votes).toBe(1);\n    });\n  });\n\n  describe('Vote Validation', () => {\n    it('should validate vote data structure', () => {\n      const validVote = {\n        user_id: 'user1',\n        option_index: 0,\n        created_at: new Date().toISOString()\n      };\n\n      // Test validation logic\n      expect(validVote.user_id).toBeDefined();\n      expect(validVote.option_index).toBeDefined();\n      expect(validVote.created_at).toBeDefined();\n      expect(typeof validVote.user_id).toBe('string');\n      expect(typeof validVote.option_index).toBe('number');\n      expect(typeof validVote.created_at).toBe('string');\n    });\n\n    it('should reject invalid vote data', () => {\n      const invalidVote = {\n        user_id: '',\n        option_index: -1,\n        created_at: 'invalid-date'\n      };\n\n      // Test validation logic\n      expect(invalidVote.user_id).toBe('');\n      expect(invalidVote.option_index).toBe(-1);\n      expect(invalidVote.created_at).toBe('invalid-date');\n    });\n  });\n\n  describe('Result Calculations', () => {\n    it('should calculate percentages correctly', () => {\n      const totalVotes = 100;\n      const optionVotes = 25;\n      const expectedPercentage = 25;\n\n      const percentage = (optionVotes / totalVotes) * 100;\n\n      expect(percentage).toBe(expectedPercentage);\n    });\n\n    it('should handle zero total votes', () => {\n      const totalVotes = 0;\n      const optionVotes = 0;\n\n      const percentage = totalVotes > 0 ? (optionVotes / totalVotes) * 100 : 0;\n\n      expect(percentage).toBe(0);\n    });\n\n    it('should round percentages correctly', () => {\n      const totalVotes = 3;\n      const optionVotes = 1;\n      const expectedPercentage = 33.33;\n\n      const percentage = Math.round((optionVotes / totalVotes) * 100 * 100) / 100;\n\n      expect(percentage).toBe(expectedPercentage);\n    });\n  });\n});\n"],"names":["calculateResults","votes","options","winner","id","rounds","results","map","option","option_id","percentage","calculateSingleChoiceResults","forEach","vote","option_index","totalVotes","length","result","reduce","prev","current","maxVotes","Math","max","r","winners","filter","isTie","describe","it","user_id","rankings","text","expect","toBeDefined","Array","isArray","toBe","toBeNull","validVote","created_at","Date","toISOString","invalidVote","optionVotes","expectedPercentage","round"],"mappings":"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"}