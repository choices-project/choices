{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/integration/comprehensive-db-debug.test.ts"],"sourcesContent":["import { describe, it, expect } from '@jest/globals';\n\n/**\n * Comprehensive Database Debug Test\n * \n * Tests to understand the exact database issue\n * \n * Created: January 27, 2025\n * Status: âœ… PRODUCTION READY\n */\n\ndescribe('Comprehensive Database Debug', () => {\n  it('should debug the database connection comprehensively', async () => {\n    const { createClient } = await import('@supabase/supabase-js');\n    const supabaseUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n    const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.SUPABASE_SECRET_KEY;\n    \n    if (!supabaseUrl || !serviceKey) {\n      throw new Error('Supabase credentials not found');\n    }\n    \n    console.log('ðŸ” Step 1: Testing basic connection...');\n    const supabase = createClient(supabaseUrl, serviceKey);\n    \n    // Test 1: Try to get database version\n    const { data: versionData, error: versionError } = await supabase\n      .rpc('version');\n    \n    console.log('Database version:', { versionData, versionError });\n    \n    // Test 2: Try to list all tables\n    const { data: tablesData, error: tablesError } = await supabase\n      .from('information_schema.tables')\n      .select('table_name')\n      .eq('table_schema', 'public');\n    \n    console.log('Tables in public schema:', { tablesData, tablesError });\n    \n    // Test 3: Try to get polls table structure\n    const { data: pollsStructure, error: pollsStructureError } = await supabase\n      .from('information_schema.columns')\n      .select('column_name, data_type, is_nullable')\n      .eq('table_name', 'polls')\n      .eq('table_schema', 'public');\n    \n    console.log('Polls table structure:', { pollsStructure, pollsStructureError });\n    \n    // Test 4: Try to get a count of polls\n    const { count: pollsCount, error: countError } = await supabase\n      .from('polls')\n      .select('*', { count: 'exact', head: true });\n    \n    console.log('Polls count:', { pollsCount, countError });\n    \n    // Test 5: Try to get first few polls\n    const { data: pollsData, error: pollsError } = await supabase\n      .from('polls')\n      .select('*')\n      .limit(3);\n    \n    console.log('First 3 polls:', { pollsData, pollsError });\n    \n    // Test 6: Try to get specific columns\n    const { data: pollsColumns, error: pollsColumnsError } = await supabase\n      .from('polls')\n      .select('id, title, description')\n      .limit(3);\n    \n    console.log('Polls with specific columns:', { pollsColumns, pollsColumnsError });\n    \n    // Test 7: Try to insert a test record\n    const testRecord = {\n      title: 'Comprehensive Test Poll',\n      description: 'Testing comprehensive database access',\n      question: 'Does this work?',\n      options: ['Yes', 'No'],\n      voting_method: 'single_choice',\n      status: 'active',\n      created_by: 'comprehensive-test',\n      privacy_level: 'public'\n    };\n    \n    const { data: insertData, error: insertError } = await supabase\n      .from('polls')\n      .insert(testRecord)\n      .select();\n    \n    console.log('Insert test result:', { insertData, insertError });\n    \n    // Test 8: If insert worked, try to query it back\n    if (!insertError && insertData && insertData.length > 0) {\n      const { data: queryBack, error: queryBackError } = await supabase\n        .from('polls')\n        .select('*')\n        .eq('id', insertData[0].id);\n      \n      console.log('Query back result:', { queryBack, queryBackError });\n      \n      // Clean up\n      const { error: deleteError } = await supabase\n        .from('polls')\n        .delete()\n        .eq('id', insertData[0].id);\n      \n      console.log('Cleanup result:', { deleteError });\n    }\n    \n    // Test 9: Try to get RLS policies\n    const { data: rlsPolicies, error: rlsError } = await supabase\n      .from('pg_policies')\n      .select('*')\n      .eq('tablename', 'polls');\n    \n    console.log('RLS policies for polls table:', { rlsPolicies, rlsError });\n    \n    // Test 10: Try to get table permissions\n    const { data: permissions, error: permissionsError } = await supabase\n      .from('information_schema.table_privileges')\n      .select('*')\n      .eq('table_name', 'polls')\n      .eq('table_schema', 'public');\n    \n    console.log('Table permissions:', { permissions, permissionsError });\n    \n    // The test should pass if we can at least connect\n    expect(versionError).toBeNull();\n    expect(tablesError).toBeNull();\n    expect(pollsStructureError).toBeNull();\n  });\n});\n"],"names":["describe","it","createClient","supabaseUrl","process","env","SUPABASE_URL","NEXT_PUBLIC_SUPABASE_URL","serviceKey","SUPABASE_SERVICE_ROLE_KEY","SUPABASE_SECRET_KEY","Error","console","log","supabase","data","versionData","error","versionError","rpc","tablesData","tablesError","from","select","eq","pollsStructure","pollsStructureError","count","pollsCount","countError","head","pollsData","pollsError","limit","pollsColumns","pollsColumnsError","testRecord","title","description","question","options","voting_method","status","created_by","privacy_level","insertData","insertError","insert","length","queryBack","queryBackError","id","deleteError","delete","rlsPolicies","rlsError","permissions","permissionsError","expect","toBeNull"],"mappings":"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"}