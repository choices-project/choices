{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/strategies/approval.ts"],"sourcesContent":["/**\n * Approval Voting Strategy\n * \n * Implements approval voting where voters can approve (vote for) multiple options.\n * Results show approval scores for each option, with the highest scoring option winning.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '../../logger';\n\nimport type { \n  VotingStrategy, \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  PollData, \n  VoteData, \n  ResultsData,\n  VotingMethod,\n  PollResults\n} from '../types';\n\nexport class ApprovalStrategy implements VotingStrategy {\n  \n  getVotingMethod(): VotingMethod {\n    return 'approval';\n  }\n\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const voteData = request.voteData;\n\n      // Validate approvals array exists and is not empty\n      if (!voteData.approvals || !Array.isArray(voteData.approvals)) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Approval votes must be an array',\n          errors: ['Approval votes must be an array'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      // Validate approvals array is not empty\n      if (voteData.approvals.length === 0) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'At least one approval is required',\n          errors: ['At least one approval is required'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      // Validate all approvals are valid integers\n      for (const approval of voteData.approvals) {\n        if (typeof approval !== 'number' || !Number.isInteger(approval)) {\n          return {\n            valid: false,\n            isValid: false,\n            error: 'Approval votes must be integers',\n            errors: ['Approval votes must be integers'],\n            requiresAuthentication: false,\n            requiresTokens: false\n          };\n        }\n\n        if (approval < 0 || approval >= poll.options.length) {\n          return {\n            valid: false,\n            isValid: false,\n            error: 'Invalid option selected',\n            errors: ['Invalid option selected'],\n            requiresAuthentication: false,\n            requiresTokens: false\n          };\n        }\n      }\n\n      // Check for duplicate approvals\n      const uniqueApprovals = new Set(voteData.approvals);\n      if (uniqueApprovals.size !== voteData.approvals.length) {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Duplicate approvals are not allowed',\n          errors: ['Duplicate approvals are not allowed'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      // Check maximum approvals limit\n      const maxApprovals = poll.votingConfig?.maxChoices || poll.options.length;\n      if (voteData.approvals.length > maxApprovals) {\n        return {\n          valid: false,\n          isValid: false,\n          error: `Maximum ${maxApprovals} approvals allowed`,\n          errors: [`Maximum ${maxApprovals} approvals allowed`],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      devLog('Approval vote validated successfully', {\n        pollId: request.pollId,\n        approvals: voteData.approvals,\n        userId: request.userId\n      });\n\n      return {\n        valid: true,\n        isValid: true,\n        requiresAuthentication: false,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Approval vote validation error:', { error: error instanceof Error ? error.message : String(error) });\n      return {\n        valid: false,\n        isValid: false,\n        error: 'Approval vote validation failed',\n        errors: ['Approval vote validation failed'],\n        requiresAuthentication: false,\n        requiresTokens: false\n      };\n    }\n  }\n\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const voteData = request.voteData;\n      \n      // Create vote data for storage\n      const voteRecord: VoteData = {\n        id: `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        pollId: request.pollId,\n        userId: request.userId,\n        approvals: voteData.approvals,\n        privacyLevel: 'standard',\n        auditReceipt: `audit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        timestamp: new Date(),\n        ipAddress: request.ipAddress,\n        userAgent: request.userAgent\n      };\n\n      devLog('Approval vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        approvals: voteData.approvals,\n        voteId: voteRecord.id\n      });\n\n      return {\n        success: true,\n        voteId: voteRecord.id,\n        message: 'Vote recorded successfully',\n        pollId: request.pollId\n      };\n\n    } catch (error) {\n      devLog('Approval vote processing error:', { error: error instanceof Error ? error.message : String(error) });\n      return {\n        success: false,\n        error: 'Failed to process approval vote',\n        message: 'Failed to process approval vote',\n        pollId: request.pollId\n      };\n    }\n  }\n\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const startTime = Date.now();\n      \n      // Initialize tracking objects\n      const approvalScores: Record<string, number> = {};\n      const optionVotes: Record<string, number> = {};\n      const approvalPercentages: Record<string, number> = {};\n      const optionPercentages: Record<string, number> = {};\n\n      // Initialize all options with zero scores\n      poll.options.forEach(option => {\n        approvalScores[option.id] = 0;\n        optionVotes[option.id] = 0;\n        approvalPercentages[option.id] = 0;\n        optionPercentages[option.id] = 0;\n      });\n\n      // Process each vote\n      votes.forEach(vote => {\n        if (vote.voteData?.approvals) {\n          vote.voteData.approvals.forEach(approval => {\n            const option = poll.options[approval];\n            if (option?.id) {\n              approvalScores[option.id] = (approvalScores[option.id] || 0) + 1;\n              optionVotes[option.id] = (optionVotes[option.id] || 0) + 1;\n            }\n          });\n        }\n      });\n\n      const totalVotes = votes.length;\n\n      // Calculate percentages\n      if (totalVotes > 0) {\n        Object.keys(approvalScores).forEach(optionId => {\n          const approvalScore = approvalScores[optionId];\n          const optionVote = optionVotes[optionId];\n          if (approvalScore !== undefined) {\n            approvalPercentages[optionId] = (approvalScore / totalVotes) * 100;\n          }\n          if (optionVote !== undefined) {\n            optionPercentages[optionId] = (optionVote / totalVotes) * 100;\n          }\n        });\n      }\n\n      // Find winner (highest approval score)\n      let winner: string | undefined;\n      let winnerVotes = 0;\n      let winnerPercentage = 0;\n\n      if (totalVotes > 0) {\n        Object.entries(approvalScores).forEach(([optionId, score]) => {\n          if (score > winnerVotes) {\n            winner = optionId;\n            winnerVotes = score;\n            winnerPercentage = approvalPercentages[optionId] || 0;\n          }\n        });\n      }\n\n      const results: PollResults = {\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        optionVotes,\n        optionPercentages,\n        abstentions: 0,\n        abstentionPercentage: 0\n      };\n\n      devLog('Approval results calculated', {\n        pollId: poll.id,\n        totalVotes,\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        calculationTime: Date.now() - startTime\n      });\n\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes,\n        participationRate: totalVotes / 100, // Mock participation rate\n        results,\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          method: 'approval'\n        }\n      };\n\n    } catch (error) {\n      devLog('Approval results calculation error:', { error: error instanceof Error ? error.message : String(error) });\n      \n      // Return empty results on error\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: 0,\n        participationRate: 0,\n        results: {\n          winner: undefined,\n          winnerVotes: 0,\n          winnerPercentage: 0,\n          optionVotes: {},\n          optionPercentages: {},\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: 0,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      };\n    }\n  }\n\n  getConfiguration(): Record<string, unknown> {\n    return {\n      method: 'approval',\n      description: 'Voters can approve multiple options',\n      allowsMultipleSelections: true,\n      requiresRanking: false,\n      maxSelections: 'unlimited'\n    };\n  }\n}"],"names":["ApprovalStrategy","getVotingMethod","validateVote","request","poll","Promise","resolve","voteData","approvals","Array","isArray","valid","isValid","error","errors","requiresAuthentication","requiresTokens","length","approval","Number","isInteger","options","uniqueApprovals","Set","size","maxApprovals","votingConfig","maxChoices","devLog","pollId","userId","Error","message","String","processVote","voteRecord","id","Date","now","Math","random","toString","substr","privacyLevel","auditReceipt","timestamp","ipAddress","userAgent","voteId","success","calculateResults","votes","startTime","approvalScores","optionVotes","approvalPercentages","optionPercentages","forEach","option","vote","totalVotes","Object","keys","optionId","approvalScore","optionVote","undefined","winner","winnerVotes","winnerPercentage","entries","score","results","abstentions","abstentionPercentage","calculationTime","votingMethod","participationRate","calculatedAt","toISOString","metadata","method","getConfiguration","description","allowsMultipleSelections","requiresRanking","maxSelections"],"mappings":"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"}