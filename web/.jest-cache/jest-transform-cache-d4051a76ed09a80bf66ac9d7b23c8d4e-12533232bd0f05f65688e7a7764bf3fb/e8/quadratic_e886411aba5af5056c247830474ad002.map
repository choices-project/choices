{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/strategies/quadratic.ts"],"sourcesContent":["/**\n * Quadratic Voting Strategy\n * \n * Implements quadratic voting where voters allocate tokens across options.\n * The cost of votes increases quadratically with the number of votes allocated to an option.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport { devLog } from '@/lib/utils/logger';\n\nimport type { \n  VotingStrategy, \n  VoteRequest, \n  VoteResponse, \n  VoteValidation, \n  PollData, \n  VoteData, \n  ResultsData,\n  VotingMethod,\n  PollResults\n} from '../types';\n\nexport class QuadraticStrategy implements VotingStrategy {\n  \n  getVotingMethod(): VotingMethod {\n    return 'quadratic';\n  }\n\n  async validateVote(request: VoteRequest, poll: PollData): Promise<VoteValidation> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const voteData = request.voteData;\n\n      // Validate allocations object exists\n      if (!voteData.allocations || typeof voteData.allocations !== 'object') {\n        return {\n          valid: false,\n          isValid: false,\n          error: 'Quadratic voting requires allocations',\n          errors: ['Quadratic voting requires allocations'],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      // Validate allocations are numbers\n      const allocations = voteData.allocations;\n      let totalTokens = 0;\n      \n      for (const [optionId, tokens] of Object.entries(allocations)) {\n        if (typeof tokens !== 'number' || tokens < 0) {\n          return {\n            valid: false,\n            isValid: false,\n            error: 'Allocations must be non-negative numbers',\n            errors: ['Allocations must be non-negative numbers'],\n            requiresAuthentication: false,\n            requiresTokens: false\n          };\n        }\n        \n        // Check if option exists (handle both option IDs and indices)\n        const optionIndex = parseInt(optionId, 10);\n        const optionExists = !isNaN(optionIndex) && optionIndex >= 0 && optionIndex < poll.options.length;\n        const optionExistsById = poll.options.some(option => option.id === optionId);\n        \n        if (!optionExists && !optionExistsById) {\n          return {\n            valid: false,\n            isValid: false,\n            error: 'Invalid option selected',\n            errors: ['Invalid option selected'],\n            requiresAuthentication: false,\n            requiresTokens: false\n          };\n        }\n        \n        totalTokens += tokens;\n      }\n\n      // Check token budget\n      const maxTokens = poll.votingConfig?.quadraticCredits || 100;\n      if (totalTokens > maxTokens) {\n        return {\n          valid: false,\n          isValid: false,\n          error: `Exceeds maximum token budget of ${maxTokens}`,\n          errors: [`Exceeds maximum token budget of ${maxTokens}`],\n          requiresAuthentication: false,\n          requiresTokens: false\n        };\n      }\n\n      devLog('Quadratic vote validated successfully', {\n        pollId: request.pollId,\n        allocations: voteData.allocations,\n        totalTokens,\n        userId: request.userId\n      });\n\n      return {\n        valid: true,\n        isValid: true,\n        requiresAuthentication: false,\n        requiresTokens: false\n      };\n\n    } catch (error) {\n      devLog('Quadratic vote validation error:', { error: error instanceof Error ? error.message : String(error) });\n      return {\n        valid: false,\n        isValid: false,\n        error: 'Quadratic vote validation failed',\n        errors: ['Quadratic vote validation failed'],\n        requiresAuthentication: false,\n        requiresTokens: false\n      };\n    }\n  }\n\n  async processVote(request: VoteRequest, poll: PollData): Promise<VoteResponse> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const voteData = request.voteData;\n      \n      // Create vote data for storage\n      const voteRecord: VoteData = {\n        id: `vote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        pollId: request.pollId,\n        userId: request.userId,\n        allocations: voteData.allocations,\n        privacyLevel: 'standard',\n        auditReceipt: `audit_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,\n        timestamp: new Date(),\n        ipAddress: request.ipAddress,\n        userAgent: request.userAgent\n      };\n\n      devLog('Quadratic vote processed successfully', {\n        pollId: request.pollId,\n        userId: request.userId,\n        allocations: voteData.allocations,\n        voteId: voteRecord.id\n      });\n\n      return {\n        success: true,\n        voteId: voteRecord.id,\n        message: 'Vote recorded successfully',\n        pollId: request.pollId\n      };\n\n    } catch (error) {\n      devLog('Quadratic vote processing error:', { error: error instanceof Error ? error.message : String(error) });\n      return {\n        success: false,\n        error: 'Failed to process quadratic vote',\n        message: 'Failed to process quadratic vote',\n        pollId: request.pollId\n      };\n    }\n  }\n\n  async calculateResults(poll: PollData, votes: VoteData[]): Promise<ResultsData> {\n    await Promise.resolve(); // Satisfy require-await rule\n    try {\n      const startTime = Date.now();\n      \n      // Initialize tracking objects\n      const totalScores: Record<string, number> = {};\n      const optionVotes: Record<string, number> = {};\n      const optionPercentages: Record<string, number> = {};\n\n      // Initialize all options with zero scores\n      poll.options.forEach(option => {\n        totalScores[option.id] = 0;\n        optionVotes[option.id] = 0;\n        optionPercentages[option.id] = 0;\n      });\n\n      // Process each vote\n      votes.forEach(vote => {\n        if (vote.voteData?.allocations) {\n          Object.entries(vote.voteData.allocations).forEach(([optionId, tokens]) => {\n            if (typeof tokens === 'number' && tokens > 0) {\n              totalScores[optionId] = (totalScores[optionId] || 0) + tokens;\n              optionVotes[optionId] = (optionVotes[optionId] || 0) + 1;\n            }\n          });\n        }\n      });\n\n      const totalVotes = votes?.length || 0;\n\n      // Calculate percentages\n      if (totalVotes > 0) {\n        Object.keys(optionVotes).forEach(optionId => {\n          const votes = optionVotes[optionId] || 0;\n          optionPercentages[optionId] = (votes / totalVotes) * 100;\n        });\n      }\n\n      // Find winner (highest total score)\n      let winner: string | undefined;\n      let winnerVotes = 0;\n      let winnerPercentage = 0;\n\n      if (totalVotes > 0) {\n        Object.entries(totalScores).forEach(([optionId, score]) => {\n          if (score > winnerVotes) {\n            winner = optionId;\n            winnerVotes = score;\n            winnerPercentage = optionPercentages[optionId] || 0;\n          }\n        });\n      }\n\n      const results: PollResults = {\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        optionVotes,\n        optionPercentages,\n        abstentions: 0,\n        abstentionPercentage: 0\n      };\n\n      devLog('Quadratic results calculated', {\n        pollId: poll.id,\n        totalVotes,\n        winner,\n        winnerVotes,\n        winnerPercentage,\n        calculationTime: Date.now() - startTime\n      });\n\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes,\n        participationRate: totalVotes / 100, // Mock participation rate\n        results,\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: Date.now() - startTime,\n          method: 'quadratic'\n        }\n      };\n\n    } catch (error) {\n      devLog('Quadratic results calculation error:', { error: error instanceof Error ? error.message : String(error) });\n      \n      // Return empty results on error\n      return {\n        pollId: poll.id,\n        votingMethod: poll.votingMethod,\n        totalVotes: 0,\n        participationRate: 0,\n        results: {\n          winner: undefined,\n          winnerVotes: 0,\n          winnerPercentage: 0,\n          optionVotes: {},\n          optionPercentages: {},\n          abstentions: 0,\n          abstentionPercentage: 0\n        },\n        calculatedAt: new Date().toISOString(),\n        metadata: {\n          calculationTime: 0,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        }\n      };\n    }\n  }\n\n  getConfiguration(): Record<string, unknown> {\n    return {\n      method: 'quadratic',\n      description: 'Voters allocate tokens across options with quadratic cost',\n      allowsMultipleSelections: true,\n      requiresRanking: false,\n      maxSelections: 'token budget',\n      costFunction: 'quadratic'\n    };\n  }\n}"],"names":["QuadraticStrategy","getVotingMethod","validateVote","request","poll","Promise","resolve","voteData","allocations","valid","isValid","error","errors","requiresAuthentication","requiresTokens","totalTokens","optionId","tokens","Object","entries","optionIndex","parseInt","optionExists","isNaN","options","length","optionExistsById","some","option","id","maxTokens","votingConfig","quadraticCredits","devLog","pollId","userId","Error","message","String","processVote","voteRecord","Date","now","Math","random","toString","substr","privacyLevel","auditReceipt","timestamp","ipAddress","userAgent","voteId","success","calculateResults","votes","startTime","totalScores","optionVotes","optionPercentages","forEach","vote","totalVotes","keys","winner","winnerVotes","winnerPercentage","score","results","abstentions","abstentionPercentage","calculationTime","votingMethod","participationRate","calculatedAt","toISOString","metadata","method","undefined","getConfiguration","description","allowsMultipleSelections","requiresRanking","maxSelections","costFunction"],"mappings":"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"}