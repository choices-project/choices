{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/vote/processor.ts"],"sourcesContent":["/**\n * Vote Processor\n * \n * Handles the processing and storage of votes, including validation,\n * rate limiting, and database operations.\n * \n * Created: September 15, 2025\n * Updated: September 15, 2025\n */\n\nimport type { SupabaseClient } from '@supabase/supabase-js';\n\nimport { devLog } from '@/lib/utils/logger';\n\nimport { getSupabaseServerClient } from '../../utils/supabase/server';\n\nimport type { \n  VoteData, \n  PollData, \n  VoteProcessor as IVoteProcessor,\n  VoteSubmissionResult\n} from './types';\n\ntype ClientFactory = () => SupabaseClient | Promise<SupabaseClient>;\n\nexport class VoteProcessor implements IVoteProcessor {\n  private _db?: SupabaseClient;\n  private readonly clientFactory: ClientFactory;\n  private rateLimitCache: Map<string, { count: number; resetTime: number }> = new Map();\n\n  constructor(factory: ClientFactory = getSupabaseServerClient) {\n    this.clientFactory = factory;\n  }\n\n  private async db(): Promise<SupabaseClient> {\n    if (!this._db) {\n      const c = this.clientFactory();\n      this._db = (c instanceof Promise) ? await c : c;\n    }\n    return this._db;\n  }\n\n  /**\n   * Process and store a vote\n   */\n  async processVote(vote: VoteData): Promise<VoteSubmissionResult> {\n    const startTime = Date.now();\n    \n    try {\n      // Get poll data from database\n      const supabaseClient = await this.db();\n\n      const { data: pollData, error: pollError } = await supabaseClient\n        .from('polls')\n        .select('*')\n        .eq('id', vote.pollId)\n        .single();\n\n      if (pollError || !pollData) {\n        return {\n          success: false,\n          error: 'Poll not found'\n        };\n      }\n\n      // Validate vote data\n      const isValid = await this.validateVoteData(vote, pollData);\n      if (!isValid) {\n        return {\n          success: false,\n          error: 'Invalid vote data'\n        };\n      }\n\n      // Check if user can vote\n      const canVote = await this.canUserVote(vote.pollId, vote.userId);\n      if (!canVote) {\n        return {\n          success: false,\n          error: 'User cannot vote on this poll'\n        };\n      }\n\n      // Create vote record\n      const voteRecord = {\n        id: vote.id,\n        poll_id: vote.pollId,\n        user_id: vote.userId || null,\n        voting_method: pollData.votingMethod,\n        vote_data: vote,\n        created_at: vote.timestamp.toISOString(),\n        updated_at: vote.timestamp.toISOString(),\n        verification_token: vote.verificationToken || null,\n        is_verified: false,\n        ip_address: vote.ipAddress || null,\n        user_agent: vote.userAgent || null\n      };\n\n      // Insert vote into database\n      const { error: voteError } = await supabaseClient\n        .from('votes')\n        .insert(voteRecord);\n\n      if (voteError) {\n        devLog('Error inserting vote:', { error: voteError.message });\n        return {\n          success: false,\n          error: 'Failed to store vote'\n        };\n      }\n\n      // Update poll vote count\n      await this.updatePollVoteCount(vote.pollId, await supabaseClient);\n\n      // Update rate limit cache\n      if (vote.userId) {\n        this.updateRateLimit(vote.userId);\n      }\n\n      devLog('Vote processed successfully', {\n        voteId: vote.id,\n        pollId: vote.pollId,\n        userId: vote.userId,\n        votingMethod: pollData.votingMethod,\n        processingTime: Date.now() - startTime\n      });\n\n      return {\n        success: true,\n        voteId: vote.id\n      };\n\n    } catch (error) {\n      devLog('Vote processing error:', { error: error instanceof Error ? error.message : String(error) });\n      return {\n        success: false,\n        error: `Failed to process vote: ${error instanceof Error ? error.message : 'Unknown error'}`\n      };\n    }\n  }\n\n  /**\n   * Validate vote data\n   */\n  async validateVoteData(vote: VoteData, poll: PollData): Promise<boolean> {\n    try {\n      // Basic validation\n      if (!vote || typeof vote !== 'object') {\n        return false;\n      }\n\n      // Check if poll is active\n      if (poll.status !== 'active') {\n        return false;\n      }\n\n      // Check poll end time\n      if (poll.endTime && new Date(poll.endTime) < new Date()) {\n        return false;\n      }\n\n      // Method-specific validation\n      switch (poll.votingMethod) {\n        case 'single':\n          return this.validateSingleChoiceVote(vote, poll);\n        case 'approval':\n          return this.validateApprovalVote(vote, poll);\n        case 'ranked':\n          return this.validateRankedVote(vote, poll);\n        case 'quadratic':\n          return this.validateQuadraticVote(vote, poll);\n        case 'range':\n          return this.validateRangeVote(vote, poll);\n        default:\n          return false;\n      }\n\n    } catch (error) {\n      devLog('Vote validation error:', { error: error instanceof Error ? error.message : String(error) });\n      return false;\n    }\n  }\n\n  /**\n   * Check if user can vote (rate limiting, existing votes, etc.)\n   */\n  async canUserVote(pollId: string, userId?: string): Promise<boolean> {\n    try {\n      // Check rate limiting\n      if (userId && this.isRateLimited(userId)) {\n        return false;\n      }\n\n      // Check if user has already voted (if not allowing multiple votes)\n      if (userId) {\n        const supabaseClient = await this.db();\n        if (supabaseClient) {\n          const { data: existingVote } = await supabaseClient\n            .from('votes')\n            .select('id')\n            .eq('poll_id', pollId)\n            .eq('user_id', userId)\n            .single();\n\n          if (existingVote) {\n            return false;\n          }\n        }\n      }\n\n      return true;\n\n    } catch (error) {\n      devLog('Can user vote check error:', { error: error instanceof Error ? error.message : String(error) });\n      return false;\n    }\n  }\n\n  /**\n   * Update poll vote count\n   */\n  private async updatePollVoteCount(pollId: string, supabaseClient: Awaited<ReturnType<typeof getSupabaseServerClient>>): Promise<void> {\n    try {\n      // Get current vote count\n      const { count } = await supabaseClient\n        .from('votes')\n        .select('*', { count: 'exact', head: true })\n        .eq('poll_id', pollId);\n\n      // Update poll with new count\n      await supabaseClient\n        .from('polls')\n        .update({ \n          total_votes: count || 0,\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', pollId);\n\n    } catch (error) {\n      devLog('Error updating poll vote count:', { error: error instanceof Error ? error.message : String(error) });\n      // Don't throw here as the vote was already recorded\n    }\n  }\n\n  /**\n   * Check if user is rate limited\n   */\n  private isRateLimited(userId: string): boolean {\n    const now = Date.now();\n    const userLimit = this.rateLimitCache.get(userId);\n\n    if (!userLimit) {\n      return false;\n    }\n\n    // Reset if window has passed\n    if (now > userLimit.resetTime) {\n      this.rateLimitCache.delete(userId);\n      return false;\n    }\n\n    // Check if over limit (10 votes per minute)\n    return userLimit.count >= 10;\n  }\n\n  /**\n   * Update rate limit for user\n   */\n  private updateRateLimit(userId: string): void {\n    const now = Date.now();\n    const windowMs = 60 * 1000; // 1 minute\n    const userLimit = this.rateLimitCache.get(userId);\n\n    if (!userLimit || now > userLimit.resetTime) {\n      this.rateLimitCache.set(userId, {\n        count: 1,\n        resetTime: now + windowMs\n      });\n    } else {\n      userLimit.count++;\n    }\n  }\n\n  /**\n   * Validate single choice vote\n   */\n  private validateSingleChoiceVote(vote: VoteData, poll: PollData): boolean {\n    return vote.choice !== undefined && \n           typeof vote.choice === 'number' && \n           vote.choice >= 0 && \n           vote.choice < poll.options.length;\n  }\n\n  /**\n   * Validate approval vote\n   */\n  private validateApprovalVote(vote: VoteData, poll: PollData): boolean {\n    if (!vote.approvals || !Array.isArray(vote.approvals)) {\n      return false;\n    }\n\n    return vote.approvals.length > 0 && \n           vote.approvals.every(approval => \n             typeof approval === 'number' && \n             approval >= 0 && \n             approval < poll.options.length\n           );\n  }\n\n  /**\n   * Validate ranked vote\n   */\n  private validateRankedVote(vote: VoteData, poll: PollData): boolean {\n    if (!vote.rankings || !Array.isArray(vote.rankings)) {\n      return false;\n    }\n\n    return vote.rankings.length === poll.options.length &&\n           vote.rankings.every(ranking => \n             typeof ranking === 'number' && \n             ranking >= 0 && \n             ranking < poll.options.length\n           ) &&\n           new Set(vote.rankings).size === vote.rankings.length; // No duplicates\n  }\n\n  /**\n   * Validate quadratic vote\n   */\n  private validateQuadraticVote(vote: VoteData, poll: PollData): boolean {\n    if (!vote.allocations || typeof vote.allocations !== 'object') {\n      return false;\n    }\n\n    const totalCredits = poll.votingConfig.quadraticCredits || 100;\n    let totalSpent = 0;\n\n    for (const [optionIndex, credits] of Object.entries(vote.allocations)) {\n      if (typeof credits !== 'number' || credits < 0) {\n        return false;\n      }\n\n      const optionIdx = parseInt(optionIndex);\n      if (optionIdx < 0 || optionIdx >= poll.options.length) {\n        return false;\n      }\n\n      totalSpent += credits * credits;\n    }\n\n    return totalSpent <= totalCredits;\n  }\n\n  /**\n   * Validate range vote\n   */\n  private validateRangeVote(vote: VoteData, poll: PollData): boolean {\n    if (!vote.ratings || typeof vote.ratings !== 'object') {\n      return false;\n    }\n\n    const rangeMin = poll.votingConfig.rangeMin || 0;\n    const rangeMax = poll.votingConfig.rangeMax || 10;\n\n    for (const [optionIndex, rating] of Object.entries(vote.ratings)) {\n      if (typeof rating !== 'number' || rating < rangeMin || rating > rangeMax) {\n        return false;\n      }\n\n      const optionIdx = parseInt(optionIndex);\n      if (optionIdx < 0 || optionIdx >= poll.options.length) {\n        return false;\n      }\n    }\n\n    return Object.keys(vote.ratings).length === poll.options.length;\n  }\n}\n"],"names":["VoteProcessor","factory","getSupabaseServerClient","rateLimitCache","Map","clientFactory","db","_db","c","Promise","processVote","vote","startTime","Date","now","supabaseClient","data","pollData","error","pollError","from","select","eq","pollId","single","success","isValid","validateVoteData","canVote","canUserVote","userId","voteRecord","id","poll_id","user_id","voting_method","votingMethod","vote_data","created_at","timestamp","toISOString","updated_at","verification_token","verificationToken","is_verified","ip_address","ipAddress","user_agent","userAgent","voteError","insert","devLog","message","updatePollVoteCount","updateRateLimit","voteId","processingTime","Error","String","poll","status","endTime","validateSingleChoiceVote","validateApprovalVote","validateRankedVote","validateQuadraticVote","validateRangeVote","isRateLimited","existingVote","count","head","update","total_votes","userLimit","get","resetTime","delete","windowMs","set","choice","undefined","options","length","approvals","Array","isArray","every","approval","rankings","ranking","Set","size","allocations","totalCredits","votingConfig","quadraticCredits","totalSpent","optionIndex","credits","Object","entries","optionIdx","parseInt","ratings","rangeMin","rangeMax","rating","keys"],"mappings":"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"}