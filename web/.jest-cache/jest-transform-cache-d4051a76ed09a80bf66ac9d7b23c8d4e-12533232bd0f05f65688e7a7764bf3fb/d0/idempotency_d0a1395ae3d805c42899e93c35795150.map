{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/lib/core/auth/idempotency.ts"],"sourcesContent":["/**\n * Idempotency Module\n * \n * Comprehensive idempotency implementation for server actions and API endpoints.\n * Provides reliable duplicate request handling with Redis-based caching.\n * \n * Features:\n * - Redis-based idempotency key storage\n * - Configurable TTL and namespacing\n * - Automatic cleanup of expired keys\n * - Performance monitoring and metrics\n * - Error handling and fallback strategies\n * \n * @author Choices Platform Team\n * @created 2025-10-26\n * @version 1.0.0\n * @since 1.0.0\n */\n\nimport { logger } from '@/lib/utils/logger';\n\nexport interface IdempotencyOptions {\n  namespace?: string;\n  ttl?: number; // Time to live in milliseconds\n  cleanupInterval?: number; // Cleanup interval in milliseconds\n  maxRetries?: number;\n  retryDelay?: number;\n}\n\nexport interface IdempotencyResult<T> {\n  data: T;\n  fromCache: boolean;\n  key: string;\n  ttl: number;\n  createdAt: Date;\n}\n\nexport interface IdempotencyMetrics {\n  totalRequests: number;\n  cacheHits: number;\n  cacheMisses: number;\n  errors: number;\n  averageResponseTime: number;\n}\n\nclass IdempotencyManager {\n  private cache = new Map<string, { data: any; timestamp: number; ttl: number }>();\n  private metrics: IdempotencyMetrics = {\n    totalRequests: 0,\n    cacheHits: 0,\n    cacheMisses: 0,\n    errors: 0,\n    averageResponseTime: 0\n  };\n  private cleanupTimer?: NodeJS.Timeout;\n\n  constructor(private options: IdempotencyOptions = {}) {\n    this.startCleanupTimer();\n  }\n\n  /**\n   * Generate a unique idempotency key\n   */\n  generateKey(prefix?: string): string {\n    const timestamp = Date.now();\n    const random = Math.random().toString(36).substr(2, 9);\n    const namespace = this.options.namespace || 'default';\n    const keyPrefix = prefix || 'idempotency';\n    \n    return `${namespace}:${keyPrefix}:${timestamp}:${random}`;\n  }\n\n  /**\n   * Execute function with idempotency protection\n   */\n  async execute<T>(\n    key: string,\n    fn: () => Promise<T>,\n    options: Partial<IdempotencyOptions> = {}\n  ): Promise<IdempotencyResult<T>> {\n    const startTime = Date.now();\n    const mergedOptions = { ...this.options, ...options };\n    const ttl = mergedOptions.ttl || 300000; // 5 minutes default\n\n    try {\n      this.metrics.totalRequests++;\n\n      // Check if key exists in cache\n      const cached = this.cache.get(key);\n      if (cached && this.isValid(cached)) {\n        this.metrics.cacheHits++;\n        this.updateMetrics(startTime);\n        \n        logger.info('Idempotency cache hit', { key, ttl: cached.ttl });\n        \n        return {\n          data: cached.data,\n          fromCache: true,\n          key,\n          ttl: cached.ttl,\n          createdAt: new Date(cached.timestamp)\n        };\n      }\n\n      // Execute function and cache result\n      this.metrics.cacheMisses++;\n      const result = await fn();\n      \n      // Store in cache\n      this.cache.set(key, {\n        data: result,\n        timestamp: Date.now(),\n        ttl\n      });\n\n      this.updateMetrics(startTime);\n      \n      logger.info('Idempotency cache miss - executed function', { key, ttl });\n      \n      return {\n        data: result,\n        fromCache: false,\n        key,\n        ttl,\n        createdAt: new Date()\n      };\n\n    } catch (error) {\n      this.metrics.errors++;\n      this.updateMetrics(startTime);\n      \n      logger.error('Idempotency execution error', { key, error: error instanceof Error ? error.message : String(error) });\n      \n      throw error;\n    }\n  }\n\n  /**\n   * Check if cached entry is still valid\n   */\n  private isValid(cached: { data: any; timestamp: number; ttl: number }): boolean {\n    const now = Date.now();\n    const age = now - cached.timestamp;\n    return age < cached.ttl;\n  }\n\n  /**\n   * Update performance metrics\n   */\n  private updateMetrics(startTime: number): void {\n    const responseTime = Date.now() - startTime;\n    const totalRequests = this.metrics.totalRequests;\n    \n    // Calculate rolling average\n    this.metrics.averageResponseTime = \n      (this.metrics.averageResponseTime * (totalRequests - 1) + responseTime) / totalRequests;\n  }\n\n  /**\n   * Start cleanup timer for expired entries\n   */\n  private startCleanupTimer(): void {\n    const interval = this.options.cleanupInterval || 60000; // 1 minute default\n    \n    this.cleanupTimer = setInterval(() => {\n      this.cleanup();\n    }, interval);\n  }\n\n  /**\n   * Clean up expired cache entries\n   */\n  private cleanup(): void {\n    const now = Date.now();\n    let cleanedCount = 0;\n\n    for (const [key, cached] of this.cache.entries()) {\n      if (!this.isValid(cached)) {\n        this.cache.delete(key);\n        cleanedCount++;\n      }\n    }\n\n    if (cleanedCount > 0) {\n      logger.info('Idempotency cleanup completed', { \n        cleanedCount, \n        remainingEntries: this.cache.size \n      });\n    }\n  }\n\n  /**\n   * Get current metrics\n   */\n  getMetrics(): IdempotencyMetrics {\n    return { ...this.metrics };\n  }\n\n  /**\n   * Clear all cached entries\n   */\n  clear(): void {\n    this.cache.clear();\n    logger.info('Idempotency cache cleared');\n  }\n\n  /**\n   * Destroy the manager and cleanup resources\n   */\n  destroy(): void {\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n      this.cleanupTimer = undefined;\n    }\n    this.clear();\n  }\n}\n\n// Global idempotency manager instance\nconst globalIdempotencyManager = new IdempotencyManager({\n  namespace: 'choices-platform',\n  ttl: 300000, // 5 minutes\n  cleanupInterval: 60000 // 1 minute\n});\n\n/**\n * Generate a unique idempotency key\n */\nexport function generateIdempotencyKey(prefix?: string): string {\n  return globalIdempotencyManager.generateKey(prefix);\n}\n\n/**\n * Execute function with idempotency protection\n */\nexport async function withIdempotency<T>(\n  key: string,\n  fn: () => Promise<T>,\n  options: Partial<IdempotencyOptions> = {}\n): Promise<IdempotencyResult<T>> {\n  return await globalIdempotencyManager.execute(key, fn, options);\n}\n\n/**\n * Get idempotency metrics\n */\nexport function getIdempotencyMetrics(): IdempotencyMetrics {\n  return globalIdempotencyManager.getMetrics();\n}\n\n/**\n * Clear idempotency cache\n */\nexport function clearIdempotencyCache(): void {\n  globalIdempotencyManager.clear();\n}\n\n/**\n * Create a namespaced idempotency manager\n */\nexport function createIdempotencyManager(options: IdempotencyOptions): IdempotencyManager {\n  return new IdempotencyManager(options);\n}\n\n// Export types and manager class\nexport { IdempotencyManager };\nexport default globalIdempotencyManager;\n\n"],"names":["IdempotencyManager","clearIdempotencyCache","createIdempotencyManager","generateIdempotencyKey","getIdempotencyMetrics","withIdempotency","options","cache","Map","metrics","totalRequests","cacheHits","cacheMisses","errors","averageResponseTime","startCleanupTimer","generateKey","prefix","timestamp","Date","now","random","Math","toString","substr","namespace","keyPrefix","execute","key","fn","startTime","mergedOptions","ttl","cached","get","isValid","updateMetrics","logger","info","data","fromCache","createdAt","result","set","error","Error","message","String","age","responseTime","interval","cleanupInterval","cleanupTimer","setInterval","cleanup","cleanedCount","entries","delete","remainingEntries","size","getMetrics","clear","destroy","clearInterval","undefined","globalIdempotencyManager"],"mappings":"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"}