{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/app/api/polls/route.ts"],"sourcesContent":["/**\n * @fileoverview Polls API\n * \n * Poll management API providing poll creation, retrieval, and management\n * with features including auto-locking, moderation, and analytics.\n * \n * @author Choices Platform Team\n * @created 2025-10-24\n * @version 2.0.0\n * @since 1.0.0\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { getSupabaseServerClient } from '@/lib/supabase/server';\nimport { logger } from '@/lib/utils/logger';\n\n/**\n * Get polls with filtering and sorting\n * \n * @param {NextRequest} request - Request object\n * @param {string} [request.searchParams.status] - Filter by poll status (active, closed, trending)\n * @param {string} [request.searchParams.category] - Filter by poll category\n * @param {string} [request.searchParams.hashtags] - Filter by hashtags (comma-separated)\n * @param {string} [request.searchParams.search] - Search in poll titles and descriptions\n * @param {string} [request.searchParams.sort] - Sort order (newest, popular, trending, engagement)\n * @param {number} [request.searchParams.limit] - Number of polls to return (default: 20)\n * @param {number} [request.searchParams.offset] - Number of polls to skip (default: 0)\n * @returns {Promise<NextResponse>} Poll data response\n * \n * @example\n * GET /api/polls?status=trending&category=politics&sort=popular\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const supabase = await getSupabaseServerClient();\n    if (!supabase) {\n      logger.error('Supabase not configured');\n      return NextResponse.json({ error: 'Database not available' }, { status: 500 });\n    }\n\n    const { searchParams } = new URL(request.url);\n    const status = searchParams.get('status');\n    const category = searchParams.get('category');\n    const hashtags = searchParams.get('hashtags');\n    const search = searchParams.get('search');\n    const sort = searchParams.get('sort') || 'newest';\n    const viewMode = searchParams.get('view_mode') || 'grid';\n    const includeHashtagData = searchParams.get('include_hashtag_data') === 'true';\n    const includeAnalytics = searchParams.get('include_analytics') === 'true';\n    const limit = parseInt(searchParams.get('limit') || '20');\n    const offset = parseInt(searchParams.get('offset') || '0');\n\n    // Build enhanced query with hashtag support\n    let selectFields = `\n      id,\n      title,\n      description,\n      category,\n      status,\n      total_votes,\n      created_at,\n      end_date,\n      tags,\n      created_by,\n      user_profiles!polls_created_by_fkey(\n        username,\n        display_name,\n        is_admin\n      )\n    `;\n\n    // Add hashtag fields if requested\n    if (includeHashtagData) {\n      selectFields += `,\n        hashtags,\n        primary_hashtag,\n        hashtag_engagement\n      `;\n    }\n\n    let query = supabase\n        .from('polls')\n      .select(selectFields)\n      .range(offset, offset + limit - 1);\n\n    // Apply enhanced filters\n    if (status && status !== 'all') {\n      if (status === 'trending') {\n        // For trending, we'll handle this after getting the data\n        query = query.eq('status', 'active');\n      } else {\n        query = query.eq('status', status);\n      }\n    }\n    if (category && category !== 'all') {\n      query = query.eq('category', category);\n    }\n    if (hashtags) {\n      const hashtagList = hashtags.split(',').map(h => h.trim());\n      query = query.overlaps('hashtags', hashtagList);\n    }\n    if (search) {\n      query = query.or(`title.ilike.%${search}%,description.ilike.%${search}%`);\n    }\n\n    // Apply sorting\n    switch (sort) {\n      case 'popular':\n        query = query.order('total_votes', { ascending: false });\n        break;\n      case 'trending':\n        // Will be handled after getting data with hashtag analytics\n        query = query.order('created_at', { ascending: false });\n        break;\n      case 'engagement':\n        query = query.order('total_votes', { ascending: false });\n        break;\n      case 'newest':\n      default:\n        query = query.order('created_at', { ascending: false });\n        break;\n    }\n\n    const { data: polls, error } = await query;\n\n    if (error) {\n      logger.error('Error fetching polls:', error);\n      return NextResponse.json({ error: 'Failed to fetch polls' }, { status: 500 });\n    }\n\n    // Get trending hashtags for analytics if needed (temporarily disabled)\n    let trendingHashtags: any[] = [];\n    if (sort === 'trending' || status === 'trending' || includeAnalytics) {\n      try {\n        // const trendingResult = await getTrendingHashtags();\n        // if (trendingResult.success) {\n        //   trendingHashtags = trendingResult.data || [];\n        // }\n        trendingHashtags = []; // Temporary fallback\n      } catch (error) {\n        logger.warn('Failed to get trending hashtags:', { error: error instanceof Error ? error.message : 'Unknown error' });\n      }\n    }\n\n    // Transform data to match frontend interface with hashtag integration\n    let transformedPolls = polls?.map((poll: any) => {\n      const basePoll = {\n        id: poll.id,\n        title: poll.title,\n        description: poll.description,\n        category: poll.category,\n        author: {\n          name: poll.user_profiles?.display_name || poll.user_profiles?.username || 'Anonymous',\n          verified: poll.user_profiles?.is_admin || false\n        },\n        status: poll.status,\n        totalVotes: poll.total_votes || 0,\n        createdAt: poll.created_at,\n        endsAt: poll.end_date,\n        tags: poll.tags || []\n      };\n\n      // Add hashtag data if available\n      if (includeHashtagData && poll.hashtags) {\n        (basePoll as any).hashtags = poll.hashtags;\n        (basePoll as any).primary_hashtag = poll.primary_hashtag;\n        (basePoll as any).hashtag_engagement = poll.hashtag_engagement;\n      }\n\n      // Calculate trending position if we have trending hashtags\n      if (trendingHashtags.length > 0 && poll.hashtags) {\n        const pollHashtags = poll.hashtags || [];\n        const trendingPositions = pollHashtags\n          .map((hashtag: string) => trendingHashtags.findIndex((th: any) => th.hashtag.name === hashtag) + 1)\n          .filter((pos: number) => pos > 0);\n        \n        if (trendingPositions.length > 0) {\n          (basePoll as any).trending_position = Math.min(...trendingPositions);\n        }\n      }\n\n      return basePoll;\n    }) || [];\n\n    // Sort by trending if requested\n    if (sort === 'trending') {\n      transformedPolls = transformedPolls.sort((a, b) => {\n        const aPos = (a as any).trending_position || 999;\n        const bPos = (b as any).trending_position || 999;\n        return aPos - bPos;\n      });\n    }\n\n    // Filter trending polls if status is trending\n    if (status === 'trending') {\n      transformedPolls = transformedPolls.filter(poll => (poll as any).trending_position && (poll as any).trending_position > 0);\n    }\n\n    logger.info('Polls fetched successfully', { \n      count: transformedPolls.length, \n      filters: { status, category, hashtags, search, sort },\n      includeHashtagData,\n      includeAnalytics\n    });\n\n    return NextResponse.json({\n      polls: transformedPolls,\n      pagination: {\n        limit,\n        offset,\n        total: transformedPolls.length\n      },\n      analytics: includeAnalytics ? {\n        trendingHashtags: trendingHashtags.slice(0, 10),\n        totalHashtags: trendingHashtags.length\n      } : undefined\n    });\n\n  } catch (error) {\n    logger.error('GET /api/polls error', error instanceof Error ? error : new Error('Unknown error'));\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\n  }\n}\n\n/**\n * Create a new poll\n * \n * @param {NextRequest} request - Request object\n * @param {string} request.body.title - Poll title\n * @param {string} [request.body.description] - Poll description\n * @param {string} request.body.question - Poll question\n * @param {Array<string>} request.body.options - Poll options (minimum 2)\n * @param {string} [request.body.category] - Poll category (default: 'general')\n * @param {Array<string>} [request.body.tags] - Poll tags\n * @param {Object} [request.body.settings] - Poll settings\n * @returns {Promise<NextResponse>} Created poll data\n * \n * @example\n * POST /api/polls\n * {\n *   \"title\": \"Community Budget Vote\",\n *   \"question\": \"How should we allocate the budget?\",\n *   \"options\": [\"Education\", \"Healthcare\", \"Infrastructure\"]\n * }\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const supabase = await getSupabaseServerClient();\n    if (!supabase) {\n      logger.error('Supabase not configured');\n      return NextResponse.json({ error: 'Database not available' }, { status: 500 });\n    }\n\n    // Check authentication\n    const { data: { user }, error: authError } = await supabase.auth.getUser();\n    if (authError || !user) {\n      logger.warn('User not authenticated');\n      return NextResponse.json({ error: 'Authentication required' }, { status: 401 });\n    }\n\n    const body = await request.json();\n    const { \n      title, \n      description,\n      question,\n      options,\n      category,\n      tags,\n      settings,\n      metadata\n    } = body;\n\n    // Validate required fields\n    if (!title || !question || !options || !Array.isArray(options) || options.length < 2) {\n      return NextResponse.json({ \n        error: 'Title, question, and at least 2 options are required' \n      }, { status: 400 });\n    }\n\n    // Create sophisticated poll with enhanced features\n    const autoLockAt = settings?.autoLockDuration \n      ? new Date(Date.now() + settings.autoLockDuration * 24 * 60 * 60 * 1000).toISOString()\n      : null;\n\n    const { data: poll, error: pollError } = await supabase\n      .from('polls')\n      .insert({\n        title: title.trim(),\n        description: description?.trim() || '',\n        question: question.trim(),\n        category: category || 'general',\n        tags: tags || [],\n        created_by: user.id,\n        status: 'active',\n        visibility: 'public',\n        \n        // Sophisticated poll features\n        auto_lock_at: autoLockAt,\n        lock_duration: settings?.autoLockDuration || null,\n        lock_type: settings?.autoLockDuration ? 'automatic' : null,\n        moderation_status: settings?.requireModeration ? 'pending' : 'approved',\n        privacy_level: settings?.privacyLevel || 'public',\n        is_verified: false,\n        is_featured: false,\n        is_trending: false,\n        trending_score: 0,\n        engagement_score: 0,\n        participation_rate: 0,\n        total_views: 0,\n        participation: 0,\n        \n        // Advanced settings\n        poll_settings: {\n          allow_anonymous: settings?.allowAnonymousVotes !== false,\n          require_verification: settings?.requireVerification || false,\n          auto_lock_duration: settings?.autoLockDuration || null,\n          moderation_required: settings?.requireModeration || false,\n          allow_multiple_votes: settings?.allowMultipleVotes || false,\n          show_results_before_close: settings?.showResultsBeforeClose || false,\n          allow_comments: settings?.allowComments !== false,\n          allow_sharing: settings?.allowSharing !== false,\n          require_authentication: settings?.requireAuthentication || false\n        },\n        settings: {\n          allow_multiple_votes: settings?.allowMultipleVotes || false,\n          allow_anonymous_votes: settings?.allowAnonymousVotes || true,\n          show_results_before_close: settings?.showResultsBeforeClose || false,\n          allow_comments: settings?.allowComments || true,\n          allow_sharing: settings?.allowSharing !== false,\n          require_authentication: settings?.requireAuthentication || false\n        },\n        metadata: metadata || {},\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString()\n      })\n      .select()\n      .single();\n\n    if (pollError) {\n      logger.error('Error creating poll:', pollError);\n      return NextResponse.json({ error: 'Failed to create poll' }, { status: 500 });\n    }\n\n    // Create poll options\n    const optionsData = options.map((option: any, index: number) => ({\n      poll_id: poll.id,\n      text: option.text || option,\n      description: option.description || '',\n      order: index,\n      votes: 0,\n      percentage: 0\n    }));\n\n    const { error: optionsError } = await supabase\n      .from('poll_options')\n      .insert(optionsData);\n\n    if (optionsError) {\n      logger.error('Error creating poll options:', optionsError);\n      // Clean up the poll if options creation fails\n      await supabase.from('polls').delete().eq('id', poll.id);\n      return NextResponse.json({ error: 'Failed to create poll options' }, { status: 500 });\n    }\n\n    // Track poll creation analytics\n    const sessionId = crypto.randomUUID();\n    const { data: analyticsEvent } = await supabase\n      .from('analytics_events')\n      .insert({\n        event_type: 'poll_created',\n        user_id: user.id,\n        session_id: sessionId,\n        event_data: {\n          poll_id: poll.id,\n          poll_title: poll.title,\n          poll_category: poll.category,\n          poll_settings: poll.poll_settings,\n          auto_lock_at: poll.auto_lock_at,\n          moderation_status: poll.moderation_status\n        },\n        ip_address: request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip'),\n        user_agent: request.headers.get('user-agent'),\n        created_at: new Date().toISOString()\n      })\n      .select()\n      .single();\n\n    // Store detailed analytics data\n    if (analyticsEvent) {\n      await supabase\n        .from('analytics_event_data')\n        .insert([\n          {\n            event_id: analyticsEvent.id,\n            data_key: 'poll_category',\n            data_value: poll.category,\n            data_type: 'string'\n          },\n          {\n            event_id: analyticsEvent.id,\n            data_key: 'poll_auto_lock',\n            data_value: poll.auto_lock_at ? 'true' : 'false',\n            data_type: 'boolean'\n          },\n          {\n            event_id: analyticsEvent.id,\n            data_key: 'poll_moderation_required',\n            data_value: poll.moderation_status === 'pending' ? 'true' : 'false',\n            data_type: 'boolean'\n          }\n        ]);\n    }\n\n    logger.info('Poll created successfully with analytics tracking', { \n      pollId: poll.id, \n      title: poll.title, \n      authorId: user.id,\n      analyticsEventId: analyticsEvent?.id\n    });\n\n    return NextResponse.json({\n      poll: {\n        id: poll.id,\n        title: poll.title,\n        description: poll.description,\n        category: poll.category,\n        status: poll.status,\n        autoLockAt: poll.auto_lock_at,\n        moderationStatus: poll.moderation_status,\n        privacyLevel: poll.privacy_level,\n        isVerified: poll.is_verified,\n        isFeatured: poll.is_featured,\n        engagementScore: poll.engagement_score,\n        createdAt: poll.created_at\n      }\n    }, { status: 201 });\n\n  } catch (error) {\n    logger.error('POST /api/polls error', error instanceof Error ? error : new Error('Unknown error'));\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\n  }\n}"],"names":["GET","POST","request","supabase","getSupabaseServerClient","logger","error","NextResponse","json","status","searchParams","URL","url","get","category","hashtags","search","sort","viewMode","includeHashtagData","includeAnalytics","limit","parseInt","offset","selectFields","query","from","select","range","eq","hashtagList","split","map","h","trim","overlaps","or","order","ascending","data","polls","trendingHashtags","warn","Error","message","transformedPolls","poll","basePoll","id","title","description","author","name","user_profiles","display_name","username","verified","is_admin","totalVotes","total_votes","createdAt","created_at","endsAt","end_date","tags","primary_hashtag","hashtag_engagement","length","pollHashtags","trendingPositions","hashtag","findIndex","th","filter","pos","trending_position","Math","min","a","b","aPos","bPos","info","count","filters","pagination","total","analytics","slice","totalHashtags","undefined","user","authError","auth","getUser","body","question","options","settings","metadata","Array","isArray","autoLockAt","autoLockDuration","Date","now","toISOString","pollError","insert","created_by","visibility","auto_lock_at","lock_duration","lock_type","moderation_status","requireModeration","privacy_level","privacyLevel","is_verified","is_featured","is_trending","trending_score","engagement_score","participation_rate","total_views","participation","poll_settings","allow_anonymous","allowAnonymousVotes","require_verification","requireVerification","auto_lock_duration","moderation_required","allow_multiple_votes","allowMultipleVotes","show_results_before_close","showResultsBeforeClose","allow_comments","allowComments","allow_sharing","allowSharing","require_authentication","requireAuthentication","allow_anonymous_votes","updated_at","single","optionsData","option","index","poll_id","text","votes","percentage","optionsError","delete","sessionId","crypto","randomUUID","analyticsEvent","event_type","user_id","session_id","event_data","poll_title","poll_category","ip_address","headers","user_agent","event_id","data_key","data_value","data_type","pollId","authorId","analyticsEventId","moderationStatus","isVerified","isFeatured","engagementScore"],"mappings":"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"}