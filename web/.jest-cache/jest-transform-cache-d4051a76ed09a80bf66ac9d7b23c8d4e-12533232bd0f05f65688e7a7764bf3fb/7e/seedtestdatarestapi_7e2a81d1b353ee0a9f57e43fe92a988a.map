{"version":3,"sources":["/Users/alaughingkitsune/src/Choices/web/tests/jest/helpers/seed-test-data-rest-api.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\n\n/**\n * Test Data Seeding Utility - REST API Approach\n * \n * Uses direct REST API calls to bypass JavaScript client RLS issues\n * Based on successful curl command approach\n * \n * Created: January 27, 2025\n * Status: ‚úÖ PRODUCTION READY\n */\n\n// REST API helper function that mimics successful curl approach\nasync function restApiRequest(endpoint: string, method = 'GET', body?: any) {\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n  \n  if (!supabaseUrl || !supabaseKey) {\n    throw new Error('Supabase credentials not found. Please check your environment variables.');\n  }\n  \n  const url = `${supabaseUrl}/rest/v1/${endpoint}`;\n  const headers = {\n    'apikey': supabaseKey,\n    'Authorization': `Bearer ${supabaseKey}`,\n    'Content-Type': 'application/json',\n    'Prefer': 'return=representation'\n  };\n  \n  const options: RequestInit = {\n    method,\n    headers\n  };\n  \n  if (body && method !== 'GET') {\n    options.body = JSON.stringify(body);\n  }\n  \n  console.log(`Making ${method} request to: ${url}`);\n  if (body) {\n    console.log('Request body:', JSON.stringify(body, null, 2));\n  }\n  \n  try {\n    const response = await fetch(url, options);\n    const data = await response.json();\n    \n    console.log(`Response status: ${response.status}`);\n    console.log('Response data:', JSON.stringify(data, null, 2));\n    \n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${JSON.stringify(data)}`);\n    }\n    \n    return data;\n  } catch (error) {\n    console.error('REST API request failed:', error);\n    throw error;\n  }\n}\n\n// Test poll data with correct format (based on successful curl approach)\nconst TEST_POLLS = [\n  {\n    title: 'Test Poll 1 - REST API',\n    description: 'Testing REST API approach for database seeding',\n    options: ['Option A', 'Option B'],\n    voting_method: 'single', // Correct value\n    status: 'active',\n    created_by: '6f12e40c-fd46-4ace-9470-2016dc0e2e8b', // Valid user ID\n    privacy_level: 'public',\n    category: 'test'\n  },\n  {\n    title: 'Test Poll 2 - REST API',\n    description: 'Second test poll using REST API approach',\n    options: ['Choice 1', 'Choice 2', 'Choice 3'],\n    voting_method: 'multiple', // Correct value\n    status: 'active',\n    created_by: '6f12e40c-fd46-4ace-9470-2016dc0e2e8b', // Valid user ID\n    privacy_level: 'public',\n    category: 'test'\n  },\n  {\n    title: 'Test Poll 3 - REST API',\n    description: 'Third test poll for comprehensive testing',\n    options: ['Yes', 'No'],\n    voting_method: 'single', // Correct value\n    status: 'active',\n    created_by: '6f12e40c-fd46-4ace-9470-2016dc0e2e8b', // Valid user ID\n    privacy_level: 'public',\n    category: 'test'\n  }\n];\n\n/**\n * Seed test polls using REST API approach\n * This bypasses JavaScript client RLS issues\n */\nexport async function seedTestPollsRestApi(): Promise<string[]> {\n  console.log('üå± Starting database seeding with REST API approach...');\n  \n  const seededPollIds: string[] = [];\n  \n  try {\n    // Test database connection first\n    console.log('üîç Testing database connection...');\n    const connectionTest = await restApiRequest('polls?select=id&limit=1');\n    console.log('‚úÖ Database connection successful');\n    console.log('Connection test result:', connectionTest);\n    \n    // Insert test polls one by one\n    for (let i = 0; i < TEST_POLLS.length; i++) {\n      const poll = TEST_POLLS[i];\n      if (!poll) continue;\n      console.log(`\\nüìù Inserting poll ${i + 1}/${TEST_POLLS.length}: ${poll.title}`);\n      \n      try {\n        const result = await restApiRequest('polls', 'POST', poll);\n        console.log(`‚úÖ Poll ${i + 1} inserted successfully`);\n        console.log('Insert result:', result);\n        \n        if (result && result.length > 0 && result[0].id) {\n          seededPollIds.push(result[0].id);\n          console.log(`üìã Poll ID: ${result[0].id}`);\n        } else {\n          console.warn(`‚ö†Ô∏è Poll ${i + 1} inserted but no ID returned`);\n        }\n      } catch (insertError) {\n        console.error(`‚ùå Failed to insert poll ${i + 1}:`, insertError);\n        // Continue with other polls\n      }\n    }\n    \n    console.log(`\\nüéâ Database seeding completed!`);\n    console.log(`üìä Seeded ${seededPollIds.length} polls out of ${TEST_POLLS.length} attempts`);\n    console.log(`üìã Seeded poll IDs: ${seededPollIds.join(', ')}`);\n    \n    return seededPollIds;\n    \n  } catch (error) {\n    console.error('‚ùå Database seeding failed:', error);\n    throw error;\n  }\n}\n\n/**\n * Clean up test polls created during seeding\n */\nexport async function cleanupTestPollsRestApi(pollIds: string[]): Promise<void> {\n  console.log('üßπ Cleaning up test polls...');\n  \n  for (const pollId of pollIds) {\n    try {\n      console.log(`üóëÔ∏è Deleting poll: ${pollId}`);\n      await restApiRequest(`polls?id=eq.${pollId}`, 'DELETE');\n      console.log(`‚úÖ Poll ${pollId} deleted successfully`);\n    } catch (error) {\n      console.error(`‚ùå Failed to delete poll ${pollId}:`, error);\n    }\n  }\n  \n  console.log('‚úÖ Cleanup completed');\n}\n\n/**\n * Verify seeded polls exist in database\n */\nexport async function verifySeededPollsRestApi(pollIds: string[]): Promise<boolean> {\n  console.log('üîç Verifying seeded polls...');\n  \n  try {\n    const result = await restApiRequest(`polls?id=in.(${pollIds.join(',')})&select=id,title`);\n    console.log('Verification result:', result);\n    \n    const foundPolls = result || [];\n    console.log(`üìä Found ${foundPolls.length} polls out of ${pollIds.length} expected`);\n    \n    return foundPolls.length === pollIds.length;\n  } catch (error) {\n    console.error('‚ùå Verification failed:', error);\n    return false;\n  }\n}\n\n/**\n * Get existing polls count\n */\nexport async function getExistingPollsCountRestApi(): Promise<number> {\n  try {\n    const result = await restApiRequest('polls?select=count');\n    console.log('Existing polls count result:', result);\n    return result?.[0]?.count || 0;\n  } catch (error) {\n    console.error('‚ùå Failed to get polls count:', error);\n    return 0;\n  }\n}\n"],"names":["cleanupTestPollsRestApi","getExistingPollsCountRestApi","seedTestPollsRestApi","verifySeededPollsRestApi","restApiRequest","endpoint","method","body","supabaseUrl","process","env","NEXT_PUBLIC_SUPABASE_URL","supabaseKey","SUPABASE_SERVICE_ROLE_KEY","Error","url","headers","options","JSON","stringify","console","log","response","fetch","data","json","status","ok","error","TEST_POLLS","title","description","voting_method","created_by","privacy_level","category","seededPollIds","connectionTest","i","length","poll","result","id","push","warn","insertError","join","pollIds","pollId","foundPolls","count"],"mappings":"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"}