# OpenStates API enrichment: committees, activity, events.
# Runs on schedule and on demand. Each run uses --resume so progress is saved;
# repeated runs fill gaps over time within API rate limits (~2 req/sec).
name: OpenStates Scheduled Sync

on:
  schedule:
    # 6:00 UTC daily
    - cron: '0 6 * * *'
  workflow_dispatch:

defaults:
  run:
    working-directory: services/civics-backend

jobs:
  openstates-sync:
    name: Committees → Activity → Events
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Git safe directory (avoid Post Checkout exit 128)
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.11.0'
          cache: 'npm'
          cache-dependency-path: services/civics-backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --silent

      - name: Pre-flight check
        run: npm run ingest:check
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: OpenStates scheduled sync
        run: npm run reingest:scheduled
        env:
          SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENSTATES_API_KEY: ${{ secrets.OPEN_STATES_API_KEY }}
