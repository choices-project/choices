name: Choices Security Audit

on:
  schedule:
    # Run weekly on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      full_audit:
        description: 'Run full security audit including dependency scan'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  security-events: write

jobs:
  security-audit:
    name: Choices Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: npm
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: |
          cd web
          npm ci

      - name: Check for hardcoded secrets
        run: |
          echo "ğŸ” Checking for hardcoded secrets..."
          
          # Check for Supabase keys
          if grep -r "sk_" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Found potential Supabase secret key"
            exit 1
          fi
          
          # Check for API keys
          if grep -r "pk_" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Found potential API key"
            exit 1
          fi
          
          # Check for JWT secrets
          if grep -r "jwt.*secret" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Found potential JWT secret"
            exit 1
          fi
          
          # Check for database URLs
          if grep -r "postgres://" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Found potential database URL"
            exit 1
          fi
          
          echo "âœ… No hardcoded secrets found"

      - name: Check environment variable usage
        run: |
          echo "ğŸ” Checking environment variable usage..."
          
          # Check for proper environment variable usage
          if grep -r "process\.env\." web/ --exclude-dir=node_modules; then
            echo "âœ… Environment variables properly used"
          else
            echo "âš ï¸ No environment variables found - check if this is expected"
          fi

      - name: Check authentication implementation
        run: |
          echo "ğŸ”’ Checking authentication implementation..."
          
          # Check for WebAuthn implementation
          if grep -r "webauthn\|passkey" web/ --exclude-dir=node_modules; then
            echo "âœ… WebAuthn implementation found"
          else
            echo "âš ï¸ WebAuthn implementation not found"
          fi
          
          # Check for RLS policies
          if find . -name "*.sql" -exec grep -l "ROW LEVEL SECURITY\|RLS" {} \; | grep -q .; then
            echo "âœ… RLS policies found"
          else
            echo "âš ï¸ RLS policies not found"
          fi

      - name: Check data protection
        run: |
          echo "ğŸ›¡ï¸ Checking data protection..."
          
          # Check for encryption usage
          if grep -r "encrypt\|crypto\|bcrypt" web/ --exclude-dir=node_modules; then
            echo "âœ… Encryption implementation found"
          else
            echo "âš ï¸ Encryption implementation not found"
          fi
          
          # Check for input validation
          if grep -r "zod\|joi\|validator" web/ --exclude-dir=node_modules; then
            echo "âœ… Input validation found"
          else
            echo "âš ï¸ Input validation not found"
          fi

      - name: Check API security
        run: |
          echo "ğŸŒ Checking API security..."
          
          # Check for rate limiting
          if grep -r "rate.*limit\|throttle" web/ --exclude-dir=node_modules; then
            echo "âœ… Rate limiting found"
          else
            echo "âš ï¸ Rate limiting not found"
          fi
          
          # Check for CORS configuration
          if grep -r "cors\|Access-Control" web/ --exclude-dir=node_modules; then
            echo "âœ… CORS configuration found"
          else
            echo "âš ï¸ CORS configuration not found"
          fi

      - name: Run dependency audit
        if: github.event.inputs.full_audit == 'true'
        run: |
          echo "ğŸ“¦ Running dependency audit..."
          cd web
          npm audit --audit-level=moderate

      - name: Check for security headers
        run: |
          echo "ğŸ”’ Checking security headers..."
          
          # Check for security headers in Next.js config
          if grep -r "security.*headers\|helmet" web/ --exclude-dir=node_modules; then
            echo "âœ… Security headers found"
          else
            echo "âš ï¸ Security headers not found"
          fi

      - name: Check for sensitive data exposure
        run: |
          echo "ğŸ‘ï¸ Checking for sensitive data exposure..."
          
          # Check for console.log statements
          if grep -r "console\.log" web/ --exclude-dir=node_modules --exclude-dir=.next; then
            echo "âš ï¸ Console.log statements found - review for sensitive data"
          else
            echo "âœ… No console.log statements found"
          fi
          
          # Check for error messages that might expose sensitive data
          if grep -r "throw.*Error\|throw.*new" web/ --exclude-dir=node_modules; then
            echo "âš ï¸ Error throwing found - review for sensitive data exposure"
          else
            echo "âœ… No error throwing found"
          fi

      - name: Check Choices-specific security
        run: |
          echo "ğŸ—³ï¸ Checking Choices-specific security..."
          
          # Check for anonymous access controls
          if grep -r "anonymous\|public.*access" web/ --exclude-dir=node_modules; then
            echo "âœ… Anonymous access controls found"
          else
            echo "âš ï¸ Anonymous access controls not found"
          fi
          
          # Check for trust tier implementation
          if grep -r "trust.*tier\|verification" web/ --exclude-dir=node_modules; then
            echo "âœ… Trust tier implementation found"
          else
            echo "âš ï¸ Trust tier implementation not found"
          fi
          
          # Check for vote privacy protection
          if grep -r "privacy.*vote\|differential.*privacy" web/ --exclude-dir=node_modules; then
            echo "âœ… Vote privacy protection found"
          else
            echo "âš ï¸ Vote privacy protection not found"
          fi

      - name: Generate security report
        run: |
          echo "ğŸ“Š Security Audit Report" > security-report.md
          echo "Generated: $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "## Summary" >> security-report.md
          echo "- Repository: Choices Platform" >> security-report.md
          echo "- Audit Type: Automated Security Check" >> security-report.md
          echo "- Status: Completed" >> security-report.md
          echo "" >> security-report.md
          echo "## Recommendations" >> security-report.md
          echo "1. Review any warnings above" >> security-report.md
          echo "2. Ensure all secrets are properly managed" >> security-report.md
          echo "3. Verify authentication and authorization" >> security-report.md
          echo "4. Check data protection measures" >> security-report.md

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Security Audit Failed!"
          echo "Please review the security issues found above."
          echo "Common issues:"
          echo "- Hardcoded secrets"
          echo "- Missing authentication"
          echo "- Inadequate data protection"
          echo "- API security issues"

      - name: Success notification
        if: success()
        run: |
          echo "âœ… Security Audit Passed!"
          echo "ğŸ”’ No critical security issues found"
          echo "ğŸ›¡ï¸ Data protection measures in place"
          echo "ğŸŒ API security implemented"
          echo "ğŸ—³ï¸ Choices-specific security validated"
