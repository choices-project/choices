name: Civics Backend Health Check

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      check_all_endpoints:
        description: 'Check all civics endpoints'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  civics-health-check:
    name: Civics Backend Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Check civics backend health
        run: |
          echo "ğŸ›ï¸ Checking Civics Backend Health..."
          
          # Basic health check
          echo "ğŸ“Š Basic Health Check:"
          curl -f https://choices-platform.vercel.app/api/civics/health || echo "âŒ Basic health check failed"
          
          # Test representative lookup
          echo "ğŸ‘¥ Representative Lookup Test:"
          curl -f "https://choices-platform.vercel.app/api/civics/representatives?address=1600+Pennsylvania+Avenue+NW+Washington+DC+20500" || echo "âŒ Representative lookup failed"
          
          # Test geographic services
          echo "ğŸ—ºï¸ Geographic Services Test:"
          curl -f "https://choices-platform.vercel.app/api/civics/geographic/test" || echo "âŒ Geographic services failed"
          
          # Test data ingestion pipeline
          echo "ğŸ“¥ Data Ingestion Pipeline Test:"
          curl -f "https://choices-platform.vercel.app/api/civics/ingestion/status" || echo "âŒ Data ingestion pipeline failed"

      - name: Check all endpoints (if requested)
        if: github.event.inputs.check_all_endpoints == 'true'
        run: |
          echo "ğŸ” Comprehensive Endpoint Check:"
          
          # OpenStates integration
          echo "ğŸ“Š OpenStates Integration:"
          curl -f "https://choices-platform.vercel.app/api/civics/openstates/test" || echo "âŒ OpenStates integration failed"
          
          # Google Civic API
          echo "ğŸ—³ï¸ Google Civic API:"
          curl -f "https://choices-platform.vercel.app/api/civics/google-civic/test" || echo "âŒ Google Civic API failed"
          
          # Congress.gov integration
          echo "ğŸ›ï¸ Congress.gov Integration:"
          curl -f "https://choices-platform.vercel.app/api/civics/congress/test" || echo "âŒ Congress.gov integration failed"
          
          # FEC integration
          echo "ğŸ’° FEC Integration:"
          curl -f "https://choices-platform.vercel.app/api/civics/fec/test" || echo "âŒ FEC integration failed"

      - name: Performance check
        run: |
          echo "âš¡ Performance Check:"
          
          # Check response times
          echo "ğŸ“Š Response Time Analysis:"
          curl -w "Health endpoint: %{time_total}s\n" -o /dev/null -s https://choices-platform.vercel.app/api/civics/health
          curl -w "Representatives endpoint: %{time_total}s\n" -o /dev/null -s "https://choices-platform.vercel.app/api/civics/representatives?address=1600+Pennsylvania+Avenue+NW+Washington+DC+20500"

      - name: Data quality check
        run: |
          echo "ğŸ“ˆ Data Quality Check:"
          
          # Check data freshness
          echo "ğŸ•’ Data Freshness:"
          curl -s "https://choices-platform.vercel.app/api/civics/data/freshness" || echo "âŒ Data freshness check failed"
          
          # Check data completeness
          echo "ğŸ“Š Data Completeness:"
          curl -s "https://choices-platform.vercel.app/api/civics/data/completeness" || echo "âŒ Data completeness check failed"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Civics Backend Health Check Failed!"
          echo "Please check the civics backend service and data ingestion pipeline."
          echo "Common issues:"
          echo "- OpenStates API rate limits"
          echo "- Google Civic API quota exceeded"
          echo "- Database connectivity issues"
          echo "- Data ingestion pipeline errors"

      - name: Success notification
        if: success()
        run: |
          echo "âœ… Civics Backend Health Check Passed!"
          echo "ğŸ›ï¸ All civics services are operational"
          echo "ğŸ“Š Data ingestion pipeline is healthy"
          echo "ğŸ—ºï¸ Geographic services are working"
          echo "ğŸ‘¥ Representative lookup is functional"
